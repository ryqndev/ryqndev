/*! For license information please see 797.30de8461.chunk.js.LICENSE.txt */
(self.webpackChunkryqndev_github_io=self.webpackChunkryqndev_github_io||[]).push([[797],{5712:function(g,I,C){"use strict";C.d(I,{wI:function(){return GI},EJ:function(){return dI},xK:function(){return bI}});var A=C(4942),l=C(4925),o=C(3433),e=C(136),i=C(9388),c=C(5671),a=C(3144),n=C(1413),b=C(9439),d=C(2791),G=C(4641),Z=C(323),s=C(184),t=["onCollide","onCollideBegin","onCollideEnd"];function B(g,I,C){var A=void 0===I?null:I,l=function(g,I){var C=atob(g);if(I){for(var A=new Uint8Array(C.length),l=0,o=C.length;l<o;++l)A[l]=C.charCodeAt(l);return String.fromCharCode.apply(null,new Uint16Array(A.buffer))}return C}(g,void 0!==C&&C),o=l.indexOf("\n",10)+1,e=l.substring(o)+(A?"//# sourceMappingURL="+A:""),i=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(i)}var u=function(g,I,C){var A;return function(l){return A=A||B(g,I,C),new Worker(A,l)}}("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogUmVjb3JkcyB3aGF0IG9iamVjdHMgYXJlIGNvbGxpZGluZyB3aXRoIGVhY2ggb3RoZXIKICAgKi8KICAvKioKICAgKiBBIDN4MyBtYXRyaXguCiAgICogQXV0aG9yZWQgYnkge0BsaW5rIGh0dHA6Ly9naXRodWIuY29tL3NjaHRlcHBlLyBzY2h0ZXBwZX0KICAgKi8KCgogIGNsYXNzIE1hdDMgewogICAgLyoqCiAgICAgKiBBIHZlY3RvciBvZiBsZW5ndGggOSwgY29udGFpbmluZyBhbGwgbWF0cml4IGVsZW1lbnRzLgogICAgICovCgogICAgLyoqCiAgICAgKiBAcGFyYW0gZWxlbWVudHMgQSB2ZWN0b3Igb2YgbGVuZ3RoIDksIGNvbnRhaW5pbmcgYWxsIG1hdHJpeCBlbGVtZW50cy4KICAgICAqLwogICAgY29uc3RydWN0b3IoZWxlbWVudHMpIHsKICAgICAgaWYgKGVsZW1lbnRzID09PSB2b2lkIDApIHsKICAgICAgICBlbGVtZW50cyA9IFswLCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAwXTsKICAgICAgfQoKICAgICAgdGhpcy5lbGVtZW50cyA9IHZvaWQgMDsKICAgICAgdGhpcy5lbGVtZW50cyA9IGVsZW1lbnRzOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBtYXRyaXggdG8gaWRlbnRpdHkKICAgICAqIEB0b2RvIFNob3VsZCBwZXJoYXBzIGJlIHJlbmFtZWQgdG8gYHNldElkZW50aXR5KClgIHRvIGJlIG1vcmUgY2xlYXIuCiAgICAgKiBAdG9kbyBDcmVhdGUgYW5vdGhlciBmdW5jdGlvbiB0aGF0IGltbWVkaWF0ZWx5IGNyZWF0ZXMgYW4gaWRlbnRpdHkgbWF0cml4IGVnLiBgZXllKClgCiAgICAgKi8KCgogICAgaWRlbnRpdHkoKSB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgICBlWzBdID0gMTsKICAgICAgZVsxXSA9IDA7CiAgICAgIGVbMl0gPSAwOwogICAgICBlWzNdID0gMDsKICAgICAgZVs0XSA9IDE7CiAgICAgIGVbNV0gPSAwOwogICAgICBlWzZdID0gMDsKICAgICAgZVs3XSA9IDA7CiAgICAgIGVbOF0gPSAxOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgYWxsIGVsZW1lbnRzIHRvIHplcm8KICAgICAqLwoKCiAgICBzZXRaZXJvKCkgewogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgZVswXSA9IDA7CiAgICAgIGVbMV0gPSAwOwogICAgICBlWzJdID0gMDsKICAgICAgZVszXSA9IDA7CiAgICAgIGVbNF0gPSAwOwogICAgICBlWzVdID0gMDsKICAgICAgZVs2XSA9IDA7CiAgICAgIGVbN10gPSAwOwogICAgICBlWzhdID0gMDsKICAgIH0KICAgIC8qKgogICAgICogU2V0cyB0aGUgbWF0cml4IGRpYWdvbmFsIGVsZW1lbnRzIGZyb20gYSBWZWMzCiAgICAgKi8KCgogICAgc2V0VHJhY2UodmVjdG9yKSB7CiAgICAgIGNvbnN0IGUgPSB0aGlzLmVsZW1lbnRzOwogICAgICBlWzBdID0gdmVjdG9yLng7CiAgICAgIGVbNF0gPSB2ZWN0b3IueTsKICAgICAgZVs4XSA9IHZlY3Rvci56OwogICAgfQogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBtYXRyaXggZGlhZ29uYWwgZWxlbWVudHMKICAgICAqLwoKCiAgICBnZXRUcmFjZSh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIHRhcmdldC54ID0gZVswXTsKICAgICAgdGFyZ2V0LnkgPSBlWzRdOwogICAgICB0YXJnZXQueiA9IGVbOF07CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIE1hdHJpeC1WZWN0b3IgbXVsdGlwbGljYXRpb24KICAgICAqIEBwYXJhbSB2IFRoZSB2ZWN0b3IgdG8gbXVsdGlwbHkgd2l0aAogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbCwgdGFyZ2V0IHRvIHNhdmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICB2bXVsdCh2LCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgY29uc3QgZSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGNvbnN0IHggPSB2Lng7CiAgICAgIGNvbnN0IHkgPSB2Lnk7CiAgICAgIGNvbnN0IHogPSB2Lno7CiAgICAgIHRhcmdldC54ID0gZVswXSAqIHggKyBlWzFdICogeSArIGVbMl0gKiB6OwogICAgICB0YXJnZXQueSA9IGVbM10gKiB4ICsgZVs0XSAqIHkgKyBlWzVdICogejsKICAgICAgdGFyZ2V0LnogPSBlWzZdICogeCArIGVbN10gKiB5ICsgZVs4XSAqIHo7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIE1hdHJpeC1zY2FsYXIgbXVsdGlwbGljYXRpb24KICAgICAqLwoKCiAgICBzbXVsdChzKSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5lbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuZWxlbWVudHNbaV0gKj0gczsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBNYXRyaXggbXVsdGlwbGljYXRpb24KICAgICAqIEBwYXJhbSBtYXRyaXggTWF0cml4IHRvIG11bHRpcGx5IHdpdGggZnJvbSBsZWZ0IHNpZGUuCiAgICAgKi8KCgogICAgbW11bHQobWF0cml4LCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IE1hdDMoKTsKICAgICAgfQoKICAgICAgY29uc3QgQSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGNvbnN0IEIgPSBtYXRyaXguZWxlbWVudHM7CiAgICAgIGNvbnN0IFQgPSB0YXJnZXQuZWxlbWVudHM7CiAgICAgIGNvbnN0IGExMSA9IEFbMF0sCiAgICAgICAgICAgIGExMiA9IEFbMV0sCiAgICAgICAgICAgIGExMyA9IEFbMl0sCiAgICAgICAgICAgIGEyMSA9IEFbM10sCiAgICAgICAgICAgIGEyMiA9IEFbNF0sCiAgICAgICAgICAgIGEyMyA9IEFbNV0sCiAgICAgICAgICAgIGEzMSA9IEFbNl0sCiAgICAgICAgICAgIGEzMiA9IEFbN10sCiAgICAgICAgICAgIGEzMyA9IEFbOF07CiAgICAgIGNvbnN0IGIxMSA9IEJbMF0sCiAgICAgICAgICAgIGIxMiA9IEJbMV0sCiAgICAgICAgICAgIGIxMyA9IEJbMl0sCiAgICAgICAgICAgIGIyMSA9IEJbM10sCiAgICAgICAgICAgIGIyMiA9IEJbNF0sCiAgICAgICAgICAgIGIyMyA9IEJbNV0sCiAgICAgICAgICAgIGIzMSA9IEJbNl0sCiAgICAgICAgICAgIGIzMiA9IEJbN10sCiAgICAgICAgICAgIGIzMyA9IEJbOF07CiAgICAgIFRbMF0gPSBhMTEgKiBiMTEgKyBhMTIgKiBiMjEgKyBhMTMgKiBiMzE7CiAgICAgIFRbMV0gPSBhMTEgKiBiMTIgKyBhMTIgKiBiMjIgKyBhMTMgKiBiMzI7CiAgICAgIFRbMl0gPSBhMTEgKiBiMTMgKyBhMTIgKiBiMjMgKyBhMTMgKiBiMzM7CiAgICAgIFRbM10gPSBhMjEgKiBiMTEgKyBhMjIgKiBiMjEgKyBhMjMgKiBiMzE7CiAgICAgIFRbNF0gPSBhMjEgKiBiMTIgKyBhMjIgKiBiMjIgKyBhMjMgKiBiMzI7CiAgICAgIFRbNV0gPSBhMjEgKiBiMTMgKyBhMjIgKiBiMjMgKyBhMjMgKiBiMzM7CiAgICAgIFRbNl0gPSBhMzEgKiBiMTEgKyBhMzIgKiBiMjEgKyBhMzMgKiBiMzE7CiAgICAgIFRbN10gPSBhMzEgKiBiMTIgKyBhMzIgKiBiMjIgKyBhMzMgKiBiMzI7CiAgICAgIFRbOF0gPSBhMzEgKiBiMTMgKyBhMzIgKiBiMjMgKyBhMzMgKiBiMzM7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIFNjYWxlIGVhY2ggY29sdW1uIG9mIHRoZSBtYXRyaXgKICAgICAqLwoKCiAgICBzY2FsZSh2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgTWF0MygpOwogICAgICB9CgogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgY29uc3QgdCA9IHRhcmdldC5lbGVtZW50czsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSAzOyBpKyspIHsKICAgICAgICB0WzMgKiBpICsgMF0gPSB2ZWN0b3IueCAqIGVbMyAqIGkgKyAwXTsKICAgICAgICB0WzMgKiBpICsgMV0gPSB2ZWN0b3IueSAqIGVbMyAqIGkgKyAxXTsKICAgICAgICB0WzMgKiBpICsgMl0gPSB2ZWN0b3IueiAqIGVbMyAqIGkgKyAyXTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogU29sdmUgQXg9YgogICAgICogQHBhcmFtIGIgVGhlIHJpZ2h0IGhhbmQgc2lkZQogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbC4gVGFyZ2V0IHZlY3RvciB0byBzYXZlIGluLgogICAgICogQHJldHVybiBUaGUgc29sdXRpb24geAogICAgICogQHRvZG8gc2hvdWxkIHJldXNlIGFycmF5cwogICAgICovCgoKICAgIHNvbHZlKGIsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICAvLyBDb25zdHJ1Y3QgZXF1YXRpb25zCiAgICAgIGNvbnN0IG5yID0gMzsgLy8gbnVtIHJvd3MKCiAgICAgIGNvbnN0IG5jID0gNDsgLy8gbnVtIGNvbHMKCiAgICAgIGNvbnN0IGVxbnMgPSBbXTsKICAgICAgbGV0IGk7CiAgICAgIGxldCBqOwoKICAgICAgZm9yIChpID0gMDsgaSA8IG5yICogbmM7IGkrKykgewogICAgICAgIGVxbnMucHVzaCgwKTsKICAgICAgfQoKICAgICAgZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgIGZvciAoaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgIGVxbnNbaSArIG5jICogal0gPSB0aGlzLmVsZW1lbnRzW2kgKyAzICogal07CiAgICAgICAgfQogICAgICB9CgogICAgICBlcW5zWzMgKyA0ICogMF0gPSBiLng7CiAgICAgIGVxbnNbMyArIDQgKiAxXSA9IGIueTsKICAgICAgZXFuc1szICsgNCAqIDJdID0gYi56OyAvLyBDb21wdXRlIHJpZ2h0IHVwcGVyIHRyaWFuZ3VsYXIgdmVyc2lvbiBvZiB0aGUgbWF0cml4IC0gR2F1c3MgZWxpbWluYXRpb24KCiAgICAgIGxldCBuID0gMzsKICAgICAgY29uc3QgayA9IG47CiAgICAgIGxldCBucDsKICAgICAgY29uc3Qga3AgPSA0OyAvLyBudW0gcm93cwoKICAgICAgbGV0IHA7CgogICAgICBkbyB7CiAgICAgICAgaSA9IGsgLSBuOwoKICAgICAgICBpZiAoZXFuc1tpICsgbmMgKiBpXSA9PT0gMCkgewogICAgICAgICAgLy8gdGhlIHBpdm90IGlzIG51bGwsIHN3YXAgbGluZXMKICAgICAgICAgIGZvciAoaiA9IGkgKyAxOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgIGlmIChlcW5zW2kgKyBuYyAqIGpdICE9PSAwKSB7CiAgICAgICAgICAgICAgbnAgPSBrcDsKCiAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgLy8gZG8gbGlnbmUoIGkgKSA9IGxpZ25lKCBpICkgKyBsaWduZSggayApCiAgICAgICAgICAgICAgICBwID0ga3AgLSBucDsKICAgICAgICAgICAgICAgIGVxbnNbcCArIG5jICogaV0gKz0gZXFuc1twICsgbmMgKiBqXTsKICAgICAgICAgICAgICB9IHdoaWxlICgtLW5wKTsKCiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChlcW5zW2kgKyBuYyAqIGldICE9PSAwKSB7CiAgICAgICAgICBmb3IgKGogPSBpICsgMTsgaiA8IGs7IGorKykgewogICAgICAgICAgICBjb25zdCBtdWx0aXBsaWVyID0gZXFuc1tpICsgbmMgKiBqXSAvIGVxbnNbaSArIG5jICogaV07CiAgICAgICAgICAgIG5wID0ga3A7CgogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgLy8gZG8gbGlnbmUoIGsgKSA9IGxpZ25lKCBrICkgLSBtdWx0aXBsaWVyICogbGlnbmUoIGkgKQogICAgICAgICAgICAgIHAgPSBrcCAtIG5wOwogICAgICAgICAgICAgIGVxbnNbcCArIG5jICogal0gPSBwIDw9IGkgPyAwIDogZXFuc1twICsgbmMgKiBqXSAtIGVxbnNbcCArIG5jICogaV0gKiBtdWx0aXBsaWVyOwogICAgICAgICAgICB9IHdoaWxlICgtLW5wKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gd2hpbGUgKC0tbik7IC8vIEdldCB0aGUgc29sdXRpb24KCgogICAgICB0YXJnZXQueiA9IGVxbnNbMiAqIG5jICsgM10gLyBlcW5zWzIgKiBuYyArIDJdOwogICAgICB0YXJnZXQueSA9IChlcW5zWzEgKiBuYyArIDNdIC0gZXFuc1sxICogbmMgKyAyXSAqIHRhcmdldC56KSAvIGVxbnNbMSAqIG5jICsgMV07CiAgICAgIHRhcmdldC54ID0gKGVxbnNbMCAqIG5jICsgM10gLSBlcW5zWzAgKiBuYyArIDJdICogdGFyZ2V0LnogLSBlcW5zWzAgKiBuYyArIDFdICogdGFyZ2V0LnkpIC8gZXFuc1swICogbmMgKyAwXTsKCiAgICAgIGlmIChpc05hTih0YXJnZXQueCkgfHwgaXNOYU4odGFyZ2V0LnkpIHx8IGlzTmFOKHRhcmdldC56KSB8fCB0YXJnZXQueCA9PT0gSW5maW5pdHkgfHwgdGFyZ2V0LnkgPT09IEluZmluaXR5IHx8IHRhcmdldC56ID09PSBJbmZpbml0eSkgewogICAgICAgIHRocm93ICJDb3VsZCBub3Qgc29sdmUgZXF1YXRpb24hIEdvdCB4PVsiICsgdGFyZ2V0LnRvU3RyaW5nKCkgKyAiXSwgYj1bIiArIGIudG9TdHJpbmcoKSArICJdLCBBPVsiICsgdGhpcy50b1N0cmluZygpICsgIl0iOwogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYW4gZWxlbWVudCBpbiB0aGUgbWF0cml4IGJ5IGluZGV4LiBJbmRleCBzdGFydHMgYXQgMCwgbm90IDEhISEKICAgICAqIEBwYXJhbSB2YWx1ZSBJZiBwcm92aWRlZCwgdGhlIG1hdHJpeCBlbGVtZW50IHdpbGwgYmUgc2V0IHRvIHRoaXMgdmFsdWUuCiAgICAgKi8KCgogICAgZShyb3csIGNvbHVtbiwgdmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50c1tjb2x1bW4gKyAzICogcm93XTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTZXQgdmFsdWUKICAgICAgICB0aGlzLmVsZW1lbnRzW2NvbHVtbiArIDMgKiByb3ddID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ29weSBhbm90aGVyIG1hdHJpeCBpbnRvIHRoaXMgbWF0cml4IG9iamVjdC4KICAgICAqLwoKCiAgICBjb3B5KG1hdHJpeCkgewogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1hdHJpeC5lbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuZWxlbWVudHNbaV0gPSBtYXRyaXguZWxlbWVudHNbaV07CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBtYXRyaXguCiAgICAgKi8KCgogICAgdG9TdHJpbmcoKSB7CiAgICAgIGxldCByID0gJyc7CiAgICAgIGNvbnN0IHNlcCA9ICcsJzsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgOTsgaSsrKSB7CiAgICAgICAgciArPSB0aGlzLmVsZW1lbnRzW2ldICsgc2VwOwogICAgICB9CgogICAgICByZXR1cm4gcjsKICAgIH0KICAgIC8qKgogICAgICogcmV2ZXJzZSB0aGUgbWF0cml4CiAgICAgKiBAcGFyYW0gdGFyZ2V0IFRhcmdldCBtYXRyaXggdG8gc2F2ZSBpbi4KICAgICAqIEByZXR1cm4gVGhlIHNvbHV0aW9uIHgKICAgICAqLwoKCiAgICByZXZlcnNlKHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgTWF0MygpOwogICAgICB9CgogICAgICAvLyBDb25zdHJ1Y3QgZXF1YXRpb25zCiAgICAgIGNvbnN0IG5yID0gMzsgLy8gbnVtIHJvd3MKCiAgICAgIGNvbnN0IG5jID0gNjsgLy8gbnVtIGNvbHMKCiAgICAgIGNvbnN0IGVxbnMgPSByZXZlcnNlX2VxbnM7CiAgICAgIGxldCBpOwogICAgICBsZXQgajsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgICBmb3IgKGogPSAwOyBqIDwgMzsgaisrKSB7CiAgICAgICAgICBlcW5zW2kgKyBuYyAqIGpdID0gdGhpcy5lbGVtZW50c1tpICsgMyAqIGpdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZXFuc1szICsgNiAqIDBdID0gMTsKICAgICAgZXFuc1szICsgNiAqIDFdID0gMDsKICAgICAgZXFuc1szICsgNiAqIDJdID0gMDsKICAgICAgZXFuc1s0ICsgNiAqIDBdID0gMDsKICAgICAgZXFuc1s0ICsgNiAqIDFdID0gMTsKICAgICAgZXFuc1s0ICsgNiAqIDJdID0gMDsKICAgICAgZXFuc1s1ICsgNiAqIDBdID0gMDsKICAgICAgZXFuc1s1ICsgNiAqIDFdID0gMDsKICAgICAgZXFuc1s1ICsgNiAqIDJdID0gMTsgLy8gQ29tcHV0ZSByaWdodCB1cHBlciB0cmlhbmd1bGFyIHZlcnNpb24gb2YgdGhlIG1hdHJpeCAtIEdhdXNzIGVsaW1pbmF0aW9uCgogICAgICBsZXQgbiA9IDM7CiAgICAgIGNvbnN0IGsgPSBuOwogICAgICBsZXQgbnA7CiAgICAgIGNvbnN0IGtwID0gbmM7IC8vIG51bSByb3dzCgogICAgICBsZXQgcDsKCiAgICAgIGRvIHsKICAgICAgICBpID0gayAtIG47CgogICAgICAgIGlmIChlcW5zW2kgKyBuYyAqIGldID09PSAwKSB7CiAgICAgICAgICAvLyB0aGUgcGl2b3QgaXMgbnVsbCwgc3dhcCBsaW5lcwogICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgaWYgKGVxbnNbaSArIG5jICogal0gIT09IDApIHsKICAgICAgICAgICAgICBucCA9IGtwOwoKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAvLyBkbyBsaW5lKCBpICkgPSBsaW5lKCBpICkgKyBsaW5lKCBrICkKICAgICAgICAgICAgICAgIHAgPSBrcCAtIG5wOwogICAgICAgICAgICAgICAgZXFuc1twICsgbmMgKiBpXSArPSBlcW5zW3AgKyBuYyAqIGpdOwogICAgICAgICAgICAgIH0gd2hpbGUgKC0tbnApOwoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGVxbnNbaSArIG5jICogaV0gIT09IDApIHsKICAgICAgICAgIGZvciAoaiA9IGkgKyAxOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgIGNvbnN0IG11bHRpcGxpZXIgPSBlcW5zW2kgKyBuYyAqIGpdIC8gZXFuc1tpICsgbmMgKiBpXTsKICAgICAgICAgICAgbnAgPSBrcDsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAvLyBkbyBsaW5lKCBrICkgPSBsaW5lKCBrICkgLSBtdWx0aXBsaWVyICogbGluZSggaSApCiAgICAgICAgICAgICAgcCA9IGtwIC0gbnA7CiAgICAgICAgICAgICAgZXFuc1twICsgbmMgKiBqXSA9IHAgPD0gaSA/IDAgOiBlcW5zW3AgKyBuYyAqIGpdIC0gZXFuc1twICsgbmMgKiBpXSAqIG11bHRpcGxpZXI7CiAgICAgICAgICAgIH0gd2hpbGUgKC0tbnApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSB3aGlsZSAoLS1uKTsgLy8gZWxpbWluYXRlIHRoZSB1cHBlciBsZWZ0IHRyaWFuZ2xlIG9mIHRoZSBtYXRyaXgKCgogICAgICBpID0gMjsKCiAgICAgIGRvIHsKICAgICAgICBqID0gaSAtIDE7CgogICAgICAgIGRvIHsKICAgICAgICAgIGNvbnN0IG11bHRpcGxpZXIgPSBlcW5zW2kgKyBuYyAqIGpdIC8gZXFuc1tpICsgbmMgKiBpXTsKICAgICAgICAgIG5wID0gbmM7CgogICAgICAgICAgZG8gewogICAgICAgICAgICBwID0gbmMgLSBucDsKICAgICAgICAgICAgZXFuc1twICsgbmMgKiBqXSA9IGVxbnNbcCArIG5jICogal0gLSBlcW5zW3AgKyBuYyAqIGldICogbXVsdGlwbGllcjsKICAgICAgICAgIH0gd2hpbGUgKC0tbnApOwogICAgICAgIH0gd2hpbGUgKGotLSk7CiAgICAgIH0gd2hpbGUgKC0taSk7IC8vIG9wZXJhdGlvbnMgb24gdGhlIGRpYWdvbmFsCgoKICAgICAgaSA9IDI7CgogICAgICBkbyB7CiAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IDEgLyBlcW5zW2kgKyBuYyAqIGldOwogICAgICAgIG5wID0gbmM7CgogICAgICAgIGRvIHsKICAgICAgICAgIHAgPSBuYyAtIG5wOwogICAgICAgICAgZXFuc1twICsgbmMgKiBpXSA9IGVxbnNbcCArIG5jICogaV0gKiBtdWx0aXBsaWVyOwogICAgICAgIH0gd2hpbGUgKC0tbnApOwogICAgICB9IHdoaWxlIChpLS0pOwoKICAgICAgaSA9IDI7CgogICAgICBkbyB7CiAgICAgICAgaiA9IDI7CgogICAgICAgIGRvIHsKICAgICAgICAgIHAgPSBlcW5zW25yICsgaiArIG5jICogaV07CgogICAgICAgICAgaWYgKGlzTmFOKHApIHx8IHAgPT09IEluZmluaXR5KSB7CiAgICAgICAgICAgIHRocm93ICJDb3VsZCBub3QgcmV2ZXJzZSEgQT1bIiArIHRoaXMudG9TdHJpbmcoKSArICJdIjsKICAgICAgICAgIH0KCiAgICAgICAgICB0YXJnZXQuZShpLCBqLCBwKTsKICAgICAgICB9IHdoaWxlIChqLS0pOwogICAgICB9IHdoaWxlIChpLS0pOwoKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBtYXRyaXggZnJvbSBhIHF1YXRlcmlvbgogICAgICovCgoKICAgIHNldFJvdGF0aW9uRnJvbVF1YXRlcm5pb24ocSkgewogICAgICBjb25zdCB4ID0gcS54OwogICAgICBjb25zdCB5ID0gcS55OwogICAgICBjb25zdCB6ID0gcS56OwogICAgICBjb25zdCB3ID0gcS53OwogICAgICBjb25zdCB4MiA9IHggKyB4OwogICAgICBjb25zdCB5MiA9IHkgKyB5OwogICAgICBjb25zdCB6MiA9IHogKyB6OwogICAgICBjb25zdCB4eCA9IHggKiB4MjsKICAgICAgY29uc3QgeHkgPSB4ICogeTI7CiAgICAgIGNvbnN0IHh6ID0geCAqIHoyOwogICAgICBjb25zdCB5eSA9IHkgKiB5MjsKICAgICAgY29uc3QgeXogPSB5ICogejI7CiAgICAgIGNvbnN0IHp6ID0geiAqIHoyOwogICAgICBjb25zdCB3eCA9IHcgKiB4MjsKICAgICAgY29uc3Qgd3kgPSB3ICogeTI7CiAgICAgIGNvbnN0IHd6ID0gdyAqIHoyOwogICAgICBjb25zdCBlID0gdGhpcy5lbGVtZW50czsKICAgICAgZVszICogMCArIDBdID0gMSAtICh5eSArIHp6KTsKICAgICAgZVszICogMCArIDFdID0geHkgLSB3ejsKICAgICAgZVszICogMCArIDJdID0geHogKyB3eTsKICAgICAgZVszICogMSArIDBdID0geHkgKyB3ejsKICAgICAgZVszICogMSArIDFdID0gMSAtICh4eCArIHp6KTsKICAgICAgZVszICogMSArIDJdID0geXogLSB3eDsKICAgICAgZVszICogMiArIDBdID0geHogLSB3eTsKICAgICAgZVszICogMiArIDFdID0geXogKyB3eDsKICAgICAgZVszICogMiArIDJdID0gMSAtICh4eCArIHl5KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFRyYW5zcG9zZSB0aGUgbWF0cml4CiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsLiBXaGVyZSB0byBzdG9yZSB0aGUgcmVzdWx0LgogICAgICogQHJldHVybiBUaGUgdGFyZ2V0IE1hdDMsIG9yIGEgbmV3IE1hdDMgaWYgdGFyZ2V0IHdhcyBvbWl0dGVkLgogICAgICovCgoKICAgIHRyYW5zcG9zZSh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IE1hdDMoKTsKICAgICAgfQoKICAgICAgY29uc3QgTSA9IHRoaXMuZWxlbWVudHM7CiAgICAgIGNvbnN0IFQgPSB0YXJnZXQuZWxlbWVudHM7CiAgICAgIGxldCB0bXA7IC8vU2V0IGRpYWdvbmFscwoKICAgICAgVFswXSA9IE1bMF07CiAgICAgIFRbNF0gPSBNWzRdOwogICAgICBUWzhdID0gTVs4XTsKICAgICAgdG1wID0gTVsxXTsKICAgICAgVFsxXSA9IE1bM107CiAgICAgIFRbM10gPSB0bXA7CiAgICAgIHRtcCA9IE1bMl07CiAgICAgIFRbMl0gPSBNWzZdOwogICAgICBUWzZdID0gdG1wOwogICAgICB0bXAgPSBNWzVdOwogICAgICBUWzVdID0gTVs3XTsKICAgICAgVFs3XSA9IHRtcDsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgfQoKICBjb25zdCByZXZlcnNlX2VxbnMgPSBbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMF07CiAgLyoqCiAgICogMy1kaW1lbnNpb25hbCB2ZWN0b3IKICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCB2ID0gbmV3IFZlYzMoMSwgMiwgMykKICAgKiAgICAgY29uc29sZS5sb2coJ3g9JyArIHYueCkgLy8geD0xCiAgICovCgogIGNsYXNzIFZlYzMgewogICAgY29uc3RydWN0b3IoeCwgeSwgeikgewogICAgICBpZiAoeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgeCA9IDAuMDsKICAgICAgfQoKICAgICAgaWYgKHkgPT09IHZvaWQgMCkgewogICAgICAgIHkgPSAwLjA7CiAgICAgIH0KCiAgICAgIGlmICh6ID09PSB2b2lkIDApIHsKICAgICAgICB6ID0gMC4wOwogICAgICB9CgogICAgICB0aGlzLnggPSB2b2lkIDA7CiAgICAgIHRoaXMueSA9IHZvaWQgMDsKICAgICAgdGhpcy56ID0gdm9pZCAwOwogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgfQogICAgLyoqCiAgICAgKiBWZWN0b3IgY3Jvc3MgcHJvZHVjdAogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbCB0YXJnZXQgdG8gc2F2ZSBpbi4KICAgICAqLwoKCiAgICBjcm9zcyh2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB2eCA9IHZlY3Rvci54OwogICAgICBjb25zdCB2eSA9IHZlY3Rvci55OwogICAgICBjb25zdCB2eiA9IHZlY3Rvci56OwogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICB0YXJnZXQueCA9IHkgKiB2eiAtIHogKiB2eTsKICAgICAgdGFyZ2V0LnkgPSB6ICogdnggLSB4ICogdno7CiAgICAgIHRhcmdldC56ID0geCAqIHZ5IC0geSAqIHZ4OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHZlY3RvcnMnIDMgZWxlbWVudHMKICAgICAqLwoKCiAgICBzZXQoeCwgeSwgeikgewogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogU2V0IGFsbCBjb21wb25lbnRzIG9mIHRoZSB2ZWN0b3IgdG8gemVyby4KICAgICAqLwoKCiAgICBzZXRaZXJvKCkgewogICAgICB0aGlzLnggPSB0aGlzLnkgPSB0aGlzLnogPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBWZWN0b3IgYWRkaXRpb24KICAgICAqLwoKCiAgICB2YWRkKHZlY3RvciwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICB0YXJnZXQueCA9IHZlY3Rvci54ICsgdGhpcy54OwogICAgICAgIHRhcmdldC55ID0gdmVjdG9yLnkgKyB0aGlzLnk7CiAgICAgICAgdGFyZ2V0LnogPSB2ZWN0b3IueiArIHRoaXMuejsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gbmV3IFZlYzModGhpcy54ICsgdmVjdG9yLngsIHRoaXMueSArIHZlY3Rvci55LCB0aGlzLnogKyB2ZWN0b3Iueik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVmVjdG9yIHN1YnRyYWN0aW9uCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsIHRhcmdldCB0byBzYXZlIGluLgogICAgICovCgoKICAgIHZzdWIodmVjdG9yLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCkgewogICAgICAgIHRhcmdldC54ID0gdGhpcy54IC0gdmVjdG9yLng7CiAgICAgICAgdGFyZ2V0LnkgPSB0aGlzLnkgLSB2ZWN0b3IueTsKICAgICAgICB0YXJnZXQueiA9IHRoaXMueiAtIHZlY3Rvci56OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBuZXcgVmVjMyh0aGlzLnggLSB2ZWN0b3IueCwgdGhpcy55IC0gdmVjdG9yLnksIHRoaXMueiAtIHZlY3Rvci56KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIGNyb3NzIHByb2R1Y3QgbWF0cml4IGFfY3Jvc3MgZnJvbSBhIHZlY3Rvciwgc3VjaCB0aGF0IGEgeCBiID0gYV9jcm9zcyAqIGIgPSBjCiAgICAgKgogICAgICogU2VlIHtAbGluayBodHRwczovL3d3dzguY3MudW11LnNlL2t1cnNlci9UREJEMjQvVlQwNi9sZWN0dXJlcy9MZWN0dXJlNi5wZGYgVW1lw6UgVW5pdmVyc2l0eSBMZWN0dXJlfQogICAgICovCgoKICAgIGNyb3NzbWF0KCkgewogICAgICByZXR1cm4gbmV3IE1hdDMoWzAsIC10aGlzLnosIHRoaXMueSwgdGhpcy56LCAwLCAtdGhpcy54LCAtdGhpcy55LCB0aGlzLngsIDBdKTsKICAgIH0KICAgIC8qKgogICAgICogTm9ybWFsaXplIHRoZSB2ZWN0b3IuIE5vdGUgdGhhdCB0aGlzIGNoYW5nZXMgdGhlIHZhbHVlcyBpbiB0aGUgdmVjdG9yLgogICAgICAqIEByZXR1cm4gUmV0dXJucyB0aGUgbm9ybSBvZiB0aGUgdmVjdG9yCiAgICAgKi8KCgogICAgbm9ybWFsaXplKCkgewogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCBuID0gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CgogICAgICBpZiAobiA+IDAuMCkgewogICAgICAgIGNvbnN0IGludk4gPSAxIC8gbjsKICAgICAgICB0aGlzLnggKj0gaW52TjsKICAgICAgICB0aGlzLnkgKj0gaW52TjsKICAgICAgICB0aGlzLnogKj0gaW52TjsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBNYWtlIHNvbWV0aGluZyB1cAogICAgICAgIHRoaXMueCA9IDA7CiAgICAgICAgdGhpcy55ID0gMDsKICAgICAgICB0aGlzLnogPSAwOwogICAgICB9CgogICAgICByZXR1cm4gbjsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB2ZXJzaW9uIG9mIHRoaXMgdmVjdG9yIHRoYXQgaXMgb2YgbGVuZ3RoIDEuCiAgICAgKiBAcGFyYW0gdGFyZ2V0IE9wdGlvbmFsIHRhcmdldCB0byBzYXZlIGluCiAgICAgKiBAcmV0dXJuIFJldHVybnMgdGhlIHVuaXQgdmVjdG9yCiAgICAgKi8KCgogICAgdW5pdCh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgY29uc3QgeCA9IHRoaXMueDsKICAgICAgY29uc3QgeSA9IHRoaXMueTsKICAgICAgY29uc3QgeiA9IHRoaXMuejsKICAgICAgbGV0IG5pbnYgPSBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKCiAgICAgIGlmIChuaW52ID4gMC4wKSB7CiAgICAgICAgbmludiA9IDEuMCAvIG5pbnY7CiAgICAgICAgdGFyZ2V0LnggPSB4ICogbmludjsKICAgICAgICB0YXJnZXQueSA9IHkgKiBuaW52OwogICAgICAgIHRhcmdldC56ID0geiAqIG5pbnY7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0LnggPSAxOwogICAgICAgIHRhcmdldC55ID0gMDsKICAgICAgICB0YXJnZXQueiA9IDA7CiAgICAgIH0KCiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgbGVuZ3RoIG9mIHRoZSB2ZWN0b3IKICAgICAqLwoKCiAgICBsZW5ndGgoKSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIHJldHVybiBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBzcXVhcmVkIGxlbmd0aCBvZiB0aGUgdmVjdG9yLgogICAgICovCgoKICAgIGxlbmd0aFNxdWFyZWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmRvdCh0aGlzKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGRpc3RhbmNlIGZyb20gdGhpcyBwb2ludCB0byBhbm90aGVyIHBvaW50CiAgICAgKi8KCgogICAgZGlzdGFuY2VUbyhwKSB7CiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIGNvbnN0IHB4ID0gcC54OwogICAgICBjb25zdCBweSA9IHAueTsKICAgICAgY29uc3QgcHogPSBwLno7CiAgICAgIHJldHVybiBNYXRoLnNxcnQoKHB4IC0geCkgKiAocHggLSB4KSArIChweSAtIHkpICogKHB5IC0geSkgKyAocHogLSB6KSAqIChweiAtIHopKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHNxdWFyZWQgZGlzdGFuY2UgZnJvbSB0aGlzIHBvaW50IHRvIGFub3RoZXIgcG9pbnQKICAgICAqLwoKCiAgICBkaXN0YW5jZVNxdWFyZWQocCkgewogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCBweCA9IHAueDsKICAgICAgY29uc3QgcHkgPSBwLnk7CiAgICAgIGNvbnN0IHB6ID0gcC56OwogICAgICByZXR1cm4gKHB4IC0geCkgKiAocHggLSB4KSArIChweSAtIHkpICogKHB5IC0geSkgKyAocHogLSB6KSAqIChweiAtIHopOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSBhbGwgdGhlIGNvbXBvbmVudHMgb2YgdGhlIHZlY3RvciB3aXRoIGEgc2NhbGFyLgogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdmVjdG9yIHRvIHNhdmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBzY2FsZShzY2FsYXIsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICB0YXJnZXQueCA9IHNjYWxhciAqIHg7CiAgICAgIHRhcmdldC55ID0gc2NhbGFyICogeTsKICAgICAgdGFyZ2V0LnogPSBzY2FsYXIgKiB6OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB0aGUgdmVjdG9yIHdpdGggYW4gb3RoZXIgdmVjdG9yLCBjb21wb25lbnQtd2lzZS4KICAgICAqIEBwYXJhbSB0YXJnZXQgVGhlIHZlY3RvciB0byBzYXZlIHRoZSByZXN1bHQgaW4uCiAgICAgKi8KCgogICAgdm11bCh2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IHZlY3Rvci54ICogdGhpcy54OwogICAgICB0YXJnZXQueSA9IHZlY3Rvci55ICogdGhpcy55OwogICAgICB0YXJnZXQueiA9IHZlY3Rvci56ICogdGhpcy56OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBTY2FsZSBhIHZlY3RvciBhbmQgYWRkIGl0IHRvIHRoaXMgdmVjdG9yLiBTYXZlIHRoZSByZXN1bHQgaW4gInRhcmdldCIuICh0YXJnZXQgPSB0aGlzICsgdmVjdG9yICogc2NhbGFyKQogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdmVjdG9yIHRvIHNhdmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBhZGRTY2FsZWRWZWN0b3Ioc2NhbGFyLCB2ZWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0YXJnZXQueCA9IHRoaXMueCArIHNjYWxhciAqIHZlY3Rvci54OwogICAgICB0YXJnZXQueSA9IHRoaXMueSArIHNjYWxhciAqIHZlY3Rvci55OwogICAgICB0YXJnZXQueiA9IHRoaXMueiArIHNjYWxhciAqIHZlY3Rvci56OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBDYWxjdWxhdGUgZG90IHByb2R1Y3QKICAgICAqIEBwYXJhbSB2ZWN0b3IKICAgICAqLwoKCiAgICBkb3QodmVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnggKiB2ZWN0b3IueCArIHRoaXMueSAqIHZlY3Rvci55ICsgdGhpcy56ICogdmVjdG9yLno7CiAgICB9CgogICAgaXNaZXJvKCkgewogICAgICByZXR1cm4gdGhpcy54ID09PSAwICYmIHRoaXMueSA9PT0gMCAmJiB0aGlzLnogPT09IDA7CiAgICB9CiAgICAvKioKICAgICAqIE1ha2UgdGhlIHZlY3RvciBwb2ludCBpbiB0aGUgb3Bwb3NpdGUgZGlyZWN0aW9uLgogICAgICogQHBhcmFtIHRhcmdldCBPcHRpb25hbCB0YXJnZXQgdG8gc2F2ZSBpbgogICAgICovCgoKICAgIG5lZ2F0ZSh0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnggPSAtdGhpcy54OwogICAgICB0YXJnZXQueSA9IC10aGlzLnk7CiAgICAgIHRhcmdldC56ID0gLXRoaXMuejsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0d28gYXJ0aWZpY2lhbCB0YW5nZW50cyB0byB0aGUgdmVjdG9yCiAgICAgKiBAcGFyYW0gdDEgVmVjdG9yIG9iamVjdCB0byBzYXZlIHRoZSBmaXJzdCB0YW5nZW50IGluCiAgICAgKiBAcGFyYW0gdDIgVmVjdG9yIG9iamVjdCB0byBzYXZlIHRoZSBzZWNvbmQgdGFuZ2VudCBpbgogICAgICovCgoKICAgIHRhbmdlbnRzKHQxLCB0MikgewogICAgICBjb25zdCBub3JtID0gdGhpcy5sZW5ndGgoKTsKCiAgICAgIGlmIChub3JtID4gMC4wKSB7CiAgICAgICAgY29uc3QgbiA9IFZlYzNfdGFuZ2VudHNfbjsKICAgICAgICBjb25zdCBpbm9ybSA9IDEgLyBub3JtOwogICAgICAgIG4uc2V0KHRoaXMueCAqIGlub3JtLCB0aGlzLnkgKiBpbm9ybSwgdGhpcy56ICogaW5vcm0pOwogICAgICAgIGNvbnN0IHJhbmRWZWMgPSBWZWMzX3RhbmdlbnRzX3JhbmRWZWM7CgogICAgICAgIGlmIChNYXRoLmFicyhuLngpIDwgMC45KSB7CiAgICAgICAgICByYW5kVmVjLnNldCgxLCAwLCAwKTsKICAgICAgICAgIG4uY3Jvc3MocmFuZFZlYywgdDEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByYW5kVmVjLnNldCgwLCAxLCAwKTsKICAgICAgICAgIG4uY3Jvc3MocmFuZFZlYywgdDEpOwogICAgICAgIH0KCiAgICAgICAgbi5jcm9zcyh0MSwgdDIpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRoZSBub3JtYWwgbGVuZ3RoIGlzIHplcm8sIG1ha2Ugc29tZXRoaW5nIHVwCiAgICAgICAgdDEuc2V0KDEsIDAsIDApOwogICAgICAgIHQyLnNldCgwLCAxLCAwKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0byBhIG1vcmUgcmVhZGFibGUgZm9ybWF0CiAgICAgKi8KCgogICAgdG9TdHJpbmcoKSB7CiAgICAgIHJldHVybiB0aGlzLnggKyAiLCIgKyB0aGlzLnkgKyAiLCIgKyB0aGlzLno7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnRzIHRvIGFuIGFycmF5CiAgICAgKi8KCgogICAgdG9BcnJheSgpIHsKICAgICAgcmV0dXJuIFt0aGlzLngsIHRoaXMueSwgdGhpcy56XTsKICAgIH0KICAgIC8qKgogICAgICogQ29waWVzIHZhbHVlIG9mIHNvdXJjZSB0byB0aGlzIHZlY3Rvci4KICAgICAqLwoKCiAgICBjb3B5KHZlY3RvcikgewogICAgICB0aGlzLnggPSB2ZWN0b3IueDsKICAgICAgdGhpcy55ID0gdmVjdG9yLnk7CiAgICAgIHRoaXMueiA9IHZlY3Rvci56OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogRG8gYSBsaW5lYXIgaW50ZXJwb2xhdGlvbiBiZXR3ZWVuIHR3byB2ZWN0b3JzCiAgICAgKiBAcGFyYW0gdCBBIG51bWJlciBiZXR3ZWVuIDAgYW5kIDEuIDAgd2lsbCBtYWtlIHRoaXMgZnVuY3Rpb24gcmV0dXJuIHUsIGFuZCAxIHdpbGwgbWFrZSBpdCByZXR1cm4gdi4gTnVtYmVycyBpbiBiZXR3ZWVuIHdpbGwgZ2VuZXJhdGUgYSB2ZWN0b3IgaW4gYmV0d2VlbiB0aGVtLgogICAgICovCgoKICAgIGxlcnAodmVjdG9yLCB0LCB0YXJnZXQpIHsKICAgICAgY29uc3QgeCA9IHRoaXMueDsKICAgICAgY29uc3QgeSA9IHRoaXMueTsKICAgICAgY29uc3QgeiA9IHRoaXMuejsKICAgICAgdGFyZ2V0LnggPSB4ICsgKHZlY3Rvci54IC0geCkgKiB0OwogICAgICB0YXJnZXQueSA9IHkgKyAodmVjdG9yLnkgLSB5KSAqIHQ7CiAgICAgIHRhcmdldC56ID0geiArICh2ZWN0b3IueiAtIHopICogdDsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgYSB2ZWN0b3IgZXF1YWxzIGlzIGFsbW9zdCBlcXVhbCB0byBhbm90aGVyIG9uZS4KICAgICAqLwoKCiAgICBhbG1vc3RFcXVhbHModmVjdG9yLCBwcmVjaXNpb24pIHsKICAgICAgaWYgKHByZWNpc2lvbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgcHJlY2lzaW9uID0gMWUtNjsKICAgICAgfQoKICAgICAgaWYgKE1hdGguYWJzKHRoaXMueCAtIHZlY3Rvci54KSA+IHByZWNpc2lvbiB8fCBNYXRoLmFicyh0aGlzLnkgLSB2ZWN0b3IueSkgPiBwcmVjaXNpb24gfHwgTWF0aC5hYnModGhpcy56IC0gdmVjdG9yLnopID4gcHJlY2lzaW9uKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgYSB2ZWN0b3IgaXMgYWxtb3N0IHplcm8KICAgICAqLwoKCiAgICBhbG1vc3RaZXJvKHByZWNpc2lvbikgewogICAgICBpZiAocHJlY2lzaW9uID09PSB2b2lkIDApIHsKICAgICAgICBwcmVjaXNpb24gPSAxZS02OwogICAgICB9CgogICAgICBpZiAoTWF0aC5hYnModGhpcy54KSA+IHByZWNpc2lvbiB8fCBNYXRoLmFicyh0aGlzLnkpID4gcHJlY2lzaW9uIHx8IE1hdGguYWJzKHRoaXMueikgPiBwcmVjaXNpb24pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGUgdmVjdG9yIGlzIGFudGktcGFyYWxsZWwgdG8gYW5vdGhlciB2ZWN0b3IuCiAgICAgKiBAcGFyYW0gcHJlY2lzaW9uIFNldCB0byB6ZXJvIGZvciBleGFjdCBjb21wYXJpc29ucwogICAgICovCgoKICAgIGlzQW50aXBhcmFsbGVsVG8odmVjdG9yLCBwcmVjaXNpb24pIHsKICAgICAgdGhpcy5uZWdhdGUoYW50aXBfbmVnKTsKICAgICAgcmV0dXJuIGFudGlwX25lZy5hbG1vc3RFcXVhbHModmVjdG9yLCBwcmVjaXNpb24pOwogICAgfQogICAgLyoqCiAgICAgKiBDbG9uZSB0aGUgdmVjdG9yCiAgICAgKi8KCgogICAgY2xvbmUoKSB7CiAgICAgIHJldHVybiBuZXcgVmVjMyh0aGlzLngsIHRoaXMueSwgdGhpcy56KTsKICAgIH0KCiAgfQoKICBWZWMzLlpFUk8gPSB2b2lkIDA7CiAgVmVjMy5VTklUX1ggPSB2b2lkIDA7CiAgVmVjMy5VTklUX1kgPSB2b2lkIDA7CiAgVmVjMy5VTklUX1ogPSB2b2lkIDA7CiAgVmVjMy5aRVJPID0gbmV3IFZlYzMoMCwgMCwgMCk7CiAgVmVjMy5VTklUX1ggPSBuZXcgVmVjMygxLCAwLCAwKTsKICBWZWMzLlVOSVRfWSA9IG5ldyBWZWMzKDAsIDEsIDApOwogIFZlYzMuVU5JVF9aID0gbmV3IFZlYzMoMCwgMCwgMSk7CiAgY29uc3QgVmVjM190YW5nZW50c19uID0gbmV3IFZlYzMoKTsKICBjb25zdCBWZWMzX3RhbmdlbnRzX3JhbmRWZWMgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFudGlwX25lZyA9IG5ldyBWZWMzKCk7CiAgLyoqCiAgICogQXhpcyBhbGlnbmVkIGJvdW5kaW5nIGJveCBjbGFzcy4KICAgKi8KCiAgY2xhc3MgQUFCQiB7CiAgICAvKioKICAgICAqIFRoZSBsb3dlciBib3VuZCBvZiB0aGUgYm91bmRpbmcgYm94CiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSB1cHBlciBib3VuZCBvZiB0aGUgYm91bmRpbmcgYm94CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy5sb3dlckJvdW5kID0gdm9pZCAwOwogICAgICB0aGlzLnVwcGVyQm91bmQgPSB2b2lkIDA7CiAgICAgIHRoaXMubG93ZXJCb3VuZCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMudXBwZXJCb3VuZCA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy5sb3dlckJvdW5kKSB7CiAgICAgICAgdGhpcy5sb3dlckJvdW5kLmNvcHkob3B0aW9ucy5sb3dlckJvdW5kKTsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMudXBwZXJCb3VuZCkgewogICAgICAgIHRoaXMudXBwZXJCb3VuZC5jb3B5KG9wdGlvbnMudXBwZXJCb3VuZCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBBQUJCIGJvdW5kcyBmcm9tIGEgc2V0IG9mIHBvaW50cy4KICAgICAqIEBwYXJhbSBwb2ludHMgQW4gYXJyYXkgb2YgVmVjMydzLgogICAgICogQHJldHVybiBUaGUgc2VsZiBvYmplY3QKICAgICAqLwoKCiAgICBzZXRGcm9tUG9pbnRzKHBvaW50cywgcG9zaXRpb24sIHF1YXRlcm5pb24sIHNraW5TaXplKSB7CiAgICAgIGNvbnN0IGwgPSB0aGlzLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSB0aGlzLnVwcGVyQm91bmQ7CiAgICAgIGNvbnN0IHEgPSBxdWF0ZXJuaW9uOyAvLyBTZXQgdG8gdGhlIGZpcnN0IHBvaW50CgogICAgICBsLmNvcHkocG9pbnRzWzBdKTsKCiAgICAgIGlmIChxKSB7CiAgICAgICAgcS52bXVsdChsLCBsKTsKICAgICAgfQoKICAgICAgdS5jb3B5KGwpOwoKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgcCA9IHBvaW50c1tpXTsKCiAgICAgICAgaWYgKHEpIHsKICAgICAgICAgIHEudm11bHQocCwgdG1wJDEpOwogICAgICAgICAgcCA9IHRtcCQxOwogICAgICAgIH0KCiAgICAgICAgaWYgKHAueCA+IHUueCkgewogICAgICAgICAgdS54ID0gcC54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHAueCA8IGwueCkgewogICAgICAgICAgbC54ID0gcC54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHAueSA+IHUueSkgewogICAgICAgICAgdS55ID0gcC55OwogICAgICAgIH0KCiAgICAgICAgaWYgKHAueSA8IGwueSkgewogICAgICAgICAgbC55ID0gcC55OwogICAgICAgIH0KCiAgICAgICAgaWYgKHAueiA+IHUueikgewogICAgICAgICAgdS56ID0gcC56OwogICAgICAgIH0KCiAgICAgICAgaWYgKHAueiA8IGwueikgewogICAgICAgICAgbC56ID0gcC56OwogICAgICAgIH0KICAgICAgfSAvLyBBZGQgb2Zmc2V0CgoKICAgICAgaWYgKHBvc2l0aW9uKSB7CiAgICAgICAgcG9zaXRpb24udmFkZChsLCBsKTsKICAgICAgICBwb3NpdGlvbi52YWRkKHUsIHUpOwogICAgICB9CgogICAgICBpZiAoc2tpblNpemUpIHsKICAgICAgICBsLnggLT0gc2tpblNpemU7CiAgICAgICAgbC55IC09IHNraW5TaXplOwogICAgICAgIGwueiAtPSBza2luU2l6ZTsKICAgICAgICB1LnggKz0gc2tpblNpemU7CiAgICAgICAgdS55ICs9IHNraW5TaXplOwogICAgICAgIHUueiArPSBza2luU2l6ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIENvcHkgYm91bmRzIGZyb20gYW4gQUFCQiB0byB0aGlzIEFBQkIKICAgICAqIEBwYXJhbSBhYWJiIFNvdXJjZSB0byBjb3B5IGZyb20KICAgICAqIEByZXR1cm4gVGhlIHRoaXMgb2JqZWN0LCBmb3IgY2hhaW5hYmlsaXR5CiAgICAgKi8KCgogICAgY29weShhYWJiKSB7CiAgICAgIHRoaXMubG93ZXJCb3VuZC5jb3B5KGFhYmIubG93ZXJCb3VuZCk7CiAgICAgIHRoaXMudXBwZXJCb3VuZC5jb3B5KGFhYmIudXBwZXJCb3VuZCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBDbG9uZSBhbiBBQUJCCiAgICAgKi8KCgogICAgY2xvbmUoKSB7CiAgICAgIHJldHVybiBuZXcgQUFCQigpLmNvcHkodGhpcyk7CiAgICB9CiAgICAvKioKICAgICAqIEV4dGVuZCB0aGlzIEFBQkIgc28gdGhhdCBpdCBjb3ZlcnMgdGhlIGdpdmVuIEFBQkIgdG9vLgogICAgICovCgoKICAgIGV4dGVuZChhYWJiKSB7CiAgICAgIHRoaXMubG93ZXJCb3VuZC54ID0gTWF0aC5taW4odGhpcy5sb3dlckJvdW5kLngsIGFhYmIubG93ZXJCb3VuZC54KTsKICAgICAgdGhpcy51cHBlckJvdW5kLnggPSBNYXRoLm1heCh0aGlzLnVwcGVyQm91bmQueCwgYWFiYi51cHBlckJvdW5kLngpOwogICAgICB0aGlzLmxvd2VyQm91bmQueSA9IE1hdGgubWluKHRoaXMubG93ZXJCb3VuZC55LCBhYWJiLmxvd2VyQm91bmQueSk7CiAgICAgIHRoaXMudXBwZXJCb3VuZC55ID0gTWF0aC5tYXgodGhpcy51cHBlckJvdW5kLnksIGFhYmIudXBwZXJCb3VuZC55KTsKICAgICAgdGhpcy5sb3dlckJvdW5kLnogPSBNYXRoLm1pbih0aGlzLmxvd2VyQm91bmQueiwgYWFiYi5sb3dlckJvdW5kLnopOwogICAgICB0aGlzLnVwcGVyQm91bmQueiA9IE1hdGgubWF4KHRoaXMudXBwZXJCb3VuZC56LCBhYWJiLnVwcGVyQm91bmQueik7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgZ2l2ZW4gQUFCQiBvdmVybGFwcyB0aGlzIEFBQkIuCiAgICAgKi8KCgogICAgb3ZlcmxhcHMoYWFiYikgewogICAgICBjb25zdCBsMSA9IHRoaXMubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdTEgPSB0aGlzLnVwcGVyQm91bmQ7CiAgICAgIGNvbnN0IGwyID0gYWFiYi5sb3dlckJvdW5kOwogICAgICBjb25zdCB1MiA9IGFhYmIudXBwZXJCb3VuZDsgLy8gICAgICBsMiAgICAgICAgdTIKICAgICAgLy8gICAgICB8LS0tLS0tLS0tfAogICAgICAvLyB8LS0tLS0tLS18CiAgICAgIC8vIGwxICAgICAgIHUxCgogICAgICBjb25zdCBvdmVybGFwc1ggPSBsMi54IDw9IHUxLnggJiYgdTEueCA8PSB1Mi54IHx8IGwxLnggPD0gdTIueCAmJiB1Mi54IDw9IHUxLng7CiAgICAgIGNvbnN0IG92ZXJsYXBzWSA9IGwyLnkgPD0gdTEueSAmJiB1MS55IDw9IHUyLnkgfHwgbDEueSA8PSB1Mi55ICYmIHUyLnkgPD0gdTEueTsKICAgICAgY29uc3Qgb3ZlcmxhcHNaID0gbDIueiA8PSB1MS56ICYmIHUxLnogPD0gdTIueiB8fCBsMS56IDw9IHUyLnogJiYgdTIueiA8PSB1MS56OwogICAgICByZXR1cm4gb3ZlcmxhcHNYICYmIG92ZXJsYXBzWSAmJiBvdmVybGFwc1o7CiAgICB9IC8vIE1vc3RseSBmb3IgZGVidWdnaW5nCgoKICAgIHZvbHVtZSgpIHsKICAgICAgY29uc3QgbCA9IHRoaXMubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IHRoaXMudXBwZXJCb3VuZDsKICAgICAgcmV0dXJuICh1LnggLSBsLngpICogKHUueSAtIGwueSkgKiAodS56IC0gbC56KTsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBBQUJCIGlzIGZ1bGx5IGNvbnRhaW5lZCBpbiB0aGlzIEFBQkIuCiAgICAgKi8KCgogICAgY29udGFpbnMoYWFiYikgewogICAgICBjb25zdCBsMSA9IHRoaXMubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdTEgPSB0aGlzLnVwcGVyQm91bmQ7CiAgICAgIGNvbnN0IGwyID0gYWFiYi5sb3dlckJvdW5kOwogICAgICBjb25zdCB1MiA9IGFhYmIudXBwZXJCb3VuZDsgLy8gICAgICBsMiAgICAgICAgdTIKICAgICAgLy8gICAgICB8LS0tLS0tLS0tfAogICAgICAvLyB8LS0tLS0tLS0tLS0tLS0tfAogICAgICAvLyBsMSAgICAgICAgICAgICAgdTEKCiAgICAgIHJldHVybiBsMS54IDw9IGwyLnggJiYgdTEueCA+PSB1Mi54ICYmIGwxLnkgPD0gbDIueSAmJiB1MS55ID49IHUyLnkgJiYgbDEueiA8PSBsMi56ICYmIHUxLnogPj0gdTIuejsKICAgIH0KCiAgICBnZXRDb3JuZXJzKGEsIGIsIGMsIGQsIGUsIGYsIGcsIGgpIHsKICAgICAgY29uc3QgbCA9IHRoaXMubG93ZXJCb3VuZDsKICAgICAgY29uc3QgdSA9IHRoaXMudXBwZXJCb3VuZDsKICAgICAgYS5jb3B5KGwpOwogICAgICBiLnNldCh1LngsIGwueSwgbC56KTsKICAgICAgYy5zZXQodS54LCB1LnksIGwueik7CiAgICAgIGQuc2V0KGwueCwgdS55LCB1LnopOwogICAgICBlLnNldCh1LngsIGwueSwgdS56KTsKICAgICAgZi5zZXQobC54LCB1LnksIGwueik7CiAgICAgIGcuc2V0KGwueCwgbC55LCB1LnopOwogICAgICBoLmNvcHkodSk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgcmVwcmVzZW50YXRpb24gb2YgYW4gQUFCQiBpbiBhbm90aGVyIGZyYW1lLgogICAgICogQHJldHVybiBUaGUgInRhcmdldCIgQUFCQiBvYmplY3QuCiAgICAgKi8KCgogICAgdG9Mb2NhbEZyYW1lKGZyYW1lLCB0YXJnZXQpIHsKICAgICAgY29uc3QgY29ybmVycyA9IHRyYW5zZm9ybUludG9GcmFtZV9jb3JuZXJzOwogICAgICBjb25zdCBhID0gY29ybmVyc1swXTsKICAgICAgY29uc3QgYiA9IGNvcm5lcnNbMV07CiAgICAgIGNvbnN0IGMgPSBjb3JuZXJzWzJdOwogICAgICBjb25zdCBkID0gY29ybmVyc1szXTsKICAgICAgY29uc3QgZSA9IGNvcm5lcnNbNF07CiAgICAgIGNvbnN0IGYgPSBjb3JuZXJzWzVdOwogICAgICBjb25zdCBnID0gY29ybmVyc1s2XTsKICAgICAgY29uc3QgaCA9IGNvcm5lcnNbN107IC8vIEdldCBjb3JuZXJzIGluIGN1cnJlbnQgZnJhbWUKCiAgICAgIHRoaXMuZ2V0Q29ybmVycyhhLCBiLCBjLCBkLCBlLCBmLCBnLCBoKTsgLy8gVHJhbnNmb3JtIHRoZW0gdG8gbmV3IGxvY2FsIGZyYW1lCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gODsgaSsrKSB7CiAgICAgICAgY29uc3QgY29ybmVyID0gY29ybmVyc1tpXTsKICAgICAgICBmcmFtZS5wb2ludFRvTG9jYWwoY29ybmVyLCBjb3JuZXIpOwogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0LnNldEZyb21Qb2ludHMoY29ybmVycyk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgcmVwcmVzZW50YXRpb24gb2YgYW4gQUFCQiBpbiB0aGUgZ2xvYmFsIGZyYW1lLgogICAgICogQHJldHVybiBUaGUgInRhcmdldCIgQUFCQiBvYmplY3QuCiAgICAgKi8KCgogICAgdG9Xb3JsZEZyYW1lKGZyYW1lLCB0YXJnZXQpIHsKICAgICAgY29uc3QgY29ybmVycyA9IHRyYW5zZm9ybUludG9GcmFtZV9jb3JuZXJzOwogICAgICBjb25zdCBhID0gY29ybmVyc1swXTsKICAgICAgY29uc3QgYiA9IGNvcm5lcnNbMV07CiAgICAgIGNvbnN0IGMgPSBjb3JuZXJzWzJdOwogICAgICBjb25zdCBkID0gY29ybmVyc1szXTsKICAgICAgY29uc3QgZSA9IGNvcm5lcnNbNF07CiAgICAgIGNvbnN0IGYgPSBjb3JuZXJzWzVdOwogICAgICBjb25zdCBnID0gY29ybmVyc1s2XTsKICAgICAgY29uc3QgaCA9IGNvcm5lcnNbN107IC8vIEdldCBjb3JuZXJzIGluIGN1cnJlbnQgZnJhbWUKCiAgICAgIHRoaXMuZ2V0Q29ybmVycyhhLCBiLCBjLCBkLCBlLCBmLCBnLCBoKTsgLy8gVHJhbnNmb3JtIHRoZW0gdG8gbmV3IGxvY2FsIGZyYW1lCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gODsgaSsrKSB7CiAgICAgICAgY29uc3QgY29ybmVyID0gY29ybmVyc1tpXTsKICAgICAgICBmcmFtZS5wb2ludFRvV29ybGQoY29ybmVyLCBjb3JuZXIpOwogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0LnNldEZyb21Qb2ludHMoY29ybmVycyk7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoZSBBQUJCIGlzIGhpdCBieSBhIHJheS4KICAgICAqLwoKCiAgICBvdmVybGFwc1JheShyYXkpIHsKICAgICAgY29uc3QgewogICAgICAgIGRpcmVjdGlvbiwKICAgICAgICBmcm9tCiAgICAgIH0gPSByYXk7IC8vIGNvbnN0IHQgPSAwCiAgICAgIC8vIHJheS5kaXJlY3Rpb24gaXMgdW5pdCBkaXJlY3Rpb24gdmVjdG9yIG9mIHJheQoKICAgICAgY29uc3QgZGlyRnJhY1ggPSAxIC8gZGlyZWN0aW9uLng7CiAgICAgIGNvbnN0IGRpckZyYWNZID0gMSAvIGRpcmVjdGlvbi55OwogICAgICBjb25zdCBkaXJGcmFjWiA9IDEgLyBkaXJlY3Rpb24uejsgLy8gdGhpcy5sb3dlckJvdW5kIGlzIHRoZSBjb3JuZXIgb2YgQUFCQiB3aXRoIG1pbmltYWwgY29vcmRpbmF0ZXMgLSBsZWZ0IGJvdHRvbSwgcnQgaXMgbWF4aW1hbCBjb3JuZXIKCiAgICAgIGNvbnN0IHQxID0gKHRoaXMubG93ZXJCb3VuZC54IC0gZnJvbS54KSAqIGRpckZyYWNYOwogICAgICBjb25zdCB0MiA9ICh0aGlzLnVwcGVyQm91bmQueCAtIGZyb20ueCkgKiBkaXJGcmFjWDsKICAgICAgY29uc3QgdDMgPSAodGhpcy5sb3dlckJvdW5kLnkgLSBmcm9tLnkpICogZGlyRnJhY1k7CiAgICAgIGNvbnN0IHQ0ID0gKHRoaXMudXBwZXJCb3VuZC55IC0gZnJvbS55KSAqIGRpckZyYWNZOwogICAgICBjb25zdCB0NSA9ICh0aGlzLmxvd2VyQm91bmQueiAtIGZyb20ueikgKiBkaXJGcmFjWjsKICAgICAgY29uc3QgdDYgPSAodGhpcy51cHBlckJvdW5kLnogLSBmcm9tLnopICogZGlyRnJhY1o7IC8vIGNvbnN0IHRtaW4gPSBNYXRoLm1heChNYXRoLm1heChNYXRoLm1pbih0MSwgdDIpLCBNYXRoLm1pbih0MywgdDQpKSk7CiAgICAgIC8vIGNvbnN0IHRtYXggPSBNYXRoLm1pbihNYXRoLm1pbihNYXRoLm1heCh0MSwgdDIpLCBNYXRoLm1heCh0MywgdDQpKSk7CgogICAgICBjb25zdCB0bWluID0gTWF0aC5tYXgoTWF0aC5tYXgoTWF0aC5taW4odDEsIHQyKSwgTWF0aC5taW4odDMsIHQ0KSksIE1hdGgubWluKHQ1LCB0NikpOwogICAgICBjb25zdCB0bWF4ID0gTWF0aC5taW4oTWF0aC5taW4oTWF0aC5tYXgodDEsIHQyKSwgTWF0aC5tYXgodDMsIHQ0KSksIE1hdGgubWF4KHQ1LCB0NikpOyAvLyBpZiB0bWF4IDwgMCwgcmF5IChsaW5lKSBpcyBpbnRlcnNlY3RpbmcgQUFCQiwgYnV0IHdob2xlIEFBQkIgaXMgYmVoaW5nIHVzCgogICAgICBpZiAodG1heCA8IDApIHsKICAgICAgICAvL3QgPSB0bWF4OwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSAvLyBpZiB0bWluID4gdG1heCwgcmF5IGRvZXNuJ3QgaW50ZXJzZWN0IEFBQkIKCgogICAgICBpZiAodG1pbiA+IHRtYXgpIHsKICAgICAgICAvL3QgPSB0bWF4OwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogIH0KCiAgY29uc3QgdG1wJDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRyYW5zZm9ybUludG9GcmFtZV9jb3JuZXJzID0gW25ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCldOwogIC8qKgogICAqIENvbGxpc2lvbiAibWF0cml4Ii4KICAgKiBJdCdzIGFjdHVhbGx5IGEgdHJpYW5ndWxhci1zaGFwZWQgYXJyYXkgb2Ygd2hldGhlciB0d28gYm9kaWVzIGFyZSB0b3VjaGluZyB0aGlzIHN0ZXAsIGZvciByZWZlcmVuY2UgbmV4dCBzdGVwCiAgICovCgogIGNsYXNzIEFycmF5Q29sbGlzaW9uTWF0cml4IHsKICAgIC8qKgogICAgICogVGhlIG1hdHJpeCBzdG9yYWdlLgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5tYXRyaXggPSB2b2lkIDA7CiAgICAgIHRoaXMubWF0cml4ID0gW107CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBlbGVtZW50CiAgICAgKi8KCgogICAgZ2V0KGJpLCBiaikgewogICAgICBsZXQgewogICAgICAgIGluZGV4OiBpCiAgICAgIH0gPSBiaTsKICAgICAgbGV0IHsKICAgICAgICBpbmRleDogagogICAgICB9ID0gYmo7CgogICAgICBpZiAoaiA+IGkpIHsKICAgICAgICBjb25zdCB0ZW1wID0gajsKICAgICAgICBqID0gaTsKICAgICAgICBpID0gdGVtcDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMubWF0cml4WyhpICogKGkgKyAxKSA+PiAxKSArIGogLSAxXTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IGFuIGVsZW1lbnQKICAgICAqLwoKCiAgICBzZXQoYmksIGJqLCB2YWx1ZSkgewogICAgICBsZXQgewogICAgICAgIGluZGV4OiBpCiAgICAgIH0gPSBiaTsKICAgICAgbGV0IHsKICAgICAgICBpbmRleDogagogICAgICB9ID0gYmo7CgogICAgICBpZiAoaiA+IGkpIHsKICAgICAgICBjb25zdCB0ZW1wID0gajsKICAgICAgICBqID0gaTsKICAgICAgICBpID0gdGVtcDsKICAgICAgfQoKICAgICAgdGhpcy5tYXRyaXhbKGkgKiAoaSArIDEpID4+IDEpICsgaiAtIDFdID0gdmFsdWUgPyAxIDogMDsKICAgIH0KICAgIC8qKgogICAgICogU2V0cyBhbGwgZWxlbWVudHMgdG8gemVybwogICAgICovCgoKICAgIHJlc2V0KCkgewogICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHRoaXMubWF0cml4Lmxlbmd0aDsgaSAhPT0gbDsgaSsrKSB7CiAgICAgICAgdGhpcy5tYXRyaXhbaV0gPSAwOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNldHMgdGhlIG1heCBudW1iZXIgb2Ygb2JqZWN0cwogICAgICovCgoKICAgIHNldE51bU9iamVjdHMobikgewogICAgICB0aGlzLm1hdHJpeC5sZW5ndGggPSBuICogKG4gLSAxKSA+PiAxOwogICAgfQoKICB9CiAgLyoqCiAgICogQmFzZSBjbGFzcyBmb3Igb2JqZWN0cyB0aGF0IGRpc3BhdGNoZXMgZXZlbnRzLgogICAqLwoKCiAgY2xhc3MgRXZlbnRUYXJnZXQgewogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHZvaWQgMDsKICAgIH0KICAgIC8qKgogICAgICogQWRkIGFuIGV2ZW50IGxpc3RlbmVyCiAgICAgKiBAcmV0dXJuIFRoZSBzZWxmIG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eS4KICAgICAqLwoKCiAgICBhZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CgogICAgICBpZiAobGlzdGVuZXJzW3R5cGVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICBsaXN0ZW5lcnNbdHlwZV0gPSBbXTsKICAgICAgfQoKICAgICAgaWYgKCFsaXN0ZW5lcnNbdHlwZV0uaW5jbHVkZXMobGlzdGVuZXIpKSB7CiAgICAgICAgbGlzdGVuZXJzW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgYW4gZXZlbnQgbGlzdGVuZXIgaXMgYWRkZWQKICAgICAqLwoKCiAgICBoYXNFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwoKICAgICAgaWYgKGxpc3RlbmVyc1t0eXBlXSAhPT0gdW5kZWZpbmVkICYmIGxpc3RlbmVyc1t0eXBlXS5pbmNsdWRlcyhsaXN0ZW5lcikpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBDaGVjayBpZiBhbnkgZXZlbnQgbGlzdGVuZXIgb2YgdGhlIGdpdmVuIHR5cGUgaXMgYWRkZWQKICAgICAqLwoKCiAgICBoYXNBbnlFdmVudExpc3RlbmVyKHR5cGUpIHsKICAgICAgaWYgKHRoaXMuX2xpc3RlbmVycyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CiAgICAgIHJldHVybiBsaXN0ZW5lcnNbdHlwZV0gIT09IHVuZGVmaW5lZDsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlIGFuIGV2ZW50IGxpc3RlbmVyCiAgICAgKiBAcmV0dXJuIFRoZSBzZWxmIG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eS4KICAgICAqLwoKCiAgICByZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgIGlmICh0aGlzLl9saXN0ZW5lcnMgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CgogICAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7CgogICAgICBpZiAobGlzdGVuZXJzW3R5cGVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgY29uc3QgaW5kZXggPSBsaXN0ZW5lcnNbdHlwZV0uaW5kZXhPZihsaXN0ZW5lcik7CgogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgbGlzdGVuZXJzW3R5cGVdLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBFbWl0IGFuIGV2ZW50LgogICAgICogQHJldHVybiBUaGUgc2VsZiBvYmplY3QsIGZvciBjaGFpbmFiaWxpdHkuCiAgICAgKi8KCgogICAgZGlzcGF0Y2hFdmVudChldmVudCkgewogICAgICBpZiAodGhpcy5fbGlzdGVuZXJzID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgY29uc3QgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICBjb25zdCBsaXN0ZW5lckFycmF5ID0gbGlzdGVuZXJzW2V2ZW50LnR5cGVdOwoKICAgICAgaWYgKGxpc3RlbmVyQXJyYXkgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGV2ZW50LnRhcmdldCA9IHRoaXM7CgogICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gbGlzdGVuZXJBcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIGxpc3RlbmVyQXJyYXlbaV0uY2FsbCh0aGlzLCBldmVudCk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgfQogIC8qKgogICAqIEEgUXVhdGVybmlvbiBkZXNjcmliZXMgYSByb3RhdGlvbiBpbiAzRCBzcGFjZS4gVGhlIFF1YXRlcm5pb24gaXMgbWF0aGVtYXRpY2FsbHkgZGVmaW5lZCBhcyBRID0geCppICsgeSpqICsgeiprICsgdywgd2hlcmUgKGksaixrKSBhcmUgaW1hZ2luYXJ5IGJhc2lzIHZlY3RvcnMuICh4LHkseikgY2FuIGJlIHNlZW4gYXMgYSB2ZWN0b3IgcmVsYXRlZCB0byB0aGUgYXhpcyBvZiByb3RhdGlvbiwgd2hpbGUgdGhlIHJlYWwgbXVsdGlwbGllciwgdywgaXMgcmVsYXRlZCB0byB0aGUgYW1vdW50IG9mIHJvdGF0aW9uLgogICAqIEBwYXJhbSB4IE11bHRpcGxpZXIgb2YgdGhlIGltYWdpbmFyeSBiYXNpcyB2ZWN0b3IgaS4KICAgKiBAcGFyYW0geSBNdWx0aXBsaWVyIG9mIHRoZSBpbWFnaW5hcnkgYmFzaXMgdmVjdG9yIGouCiAgICogQHBhcmFtIHogTXVsdGlwbGllciBvZiB0aGUgaW1hZ2luYXJ5IGJhc2lzIHZlY3RvciBrLgogICAqIEBwYXJhbSB3IE11bHRpcGxpZXIgb2YgdGhlIHJlYWwgcGFydC4KICAgKiBAc2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUXVhdGVybmlvbgogICAqLwoKCiAgY2xhc3MgUXVhdGVybmlvbiB7CiAgICBjb25zdHJ1Y3Rvcih4LCB5LCB6LCB3KSB7CiAgICAgIGlmICh4ID09PSB2b2lkIDApIHsKICAgICAgICB4ID0gMDsKICAgICAgfQoKICAgICAgaWYgKHkgPT09IHZvaWQgMCkgewogICAgICAgIHkgPSAwOwogICAgICB9CgogICAgICBpZiAoeiA9PT0gdm9pZCAwKSB7CiAgICAgICAgeiA9IDA7CiAgICAgIH0KCiAgICAgIGlmICh3ID09PSB2b2lkIDApIHsKICAgICAgICB3ID0gMTsKICAgICAgfQoKICAgICAgdGhpcy54ID0gdm9pZCAwOwogICAgICB0aGlzLnkgPSB2b2lkIDA7CiAgICAgIHRoaXMueiA9IHZvaWQgMDsKICAgICAgdGhpcy53ID0gdm9pZCAwOwogICAgICB0aGlzLnggPSB4OwogICAgICB0aGlzLnkgPSB5OwogICAgICB0aGlzLnogPSB6OwogICAgICB0aGlzLncgPSB3OwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHZhbHVlIG9mIHRoZSBxdWF0ZXJuaW9uLgogICAgICovCgoKICAgIHNldCh4LCB5LCB6LCB3KSB7CiAgICAgIHRoaXMueCA9IHg7CiAgICAgIHRoaXMueSA9IHk7CiAgICAgIHRoaXMueiA9IHo7CiAgICAgIHRoaXMudyA9IHc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0IHRvIGEgcmVhZGFibGUgZm9ybWF0CiAgICAgKiBAcmV0dXJuICJ4LHkseix3IgogICAgICovCgoKICAgIHRvU3RyaW5nKCkgewogICAgICByZXR1cm4gdGhpcy54ICsgIiwiICsgdGhpcy55ICsgIiwiICsgdGhpcy56ICsgIiwiICsgdGhpcy53OwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0IHRvIGFuIEFycmF5CiAgICAgKiBAcmV0dXJuIFt4LCB5LCB6LCB3XQogICAgICovCgoKICAgIHRvQXJyYXkoKSB7CiAgICAgIHJldHVybiBbdGhpcy54LCB0aGlzLnksIHRoaXMueiwgdGhpcy53XTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBxdWF0ZXJuaW9uIGNvbXBvbmVudHMgZ2l2ZW4gYW4gYXhpcyBhbmQgYW4gYW5nbGUgaW4gcmFkaWFucy4KICAgICAqLwoKCiAgICBzZXRGcm9tQXhpc0FuZ2xlKHZlY3RvciwgYW5nbGUpIHsKICAgICAgY29uc3QgcyA9IE1hdGguc2luKGFuZ2xlICogMC41KTsKICAgICAgdGhpcy54ID0gdmVjdG9yLnggKiBzOwogICAgICB0aGlzLnkgPSB2ZWN0b3IueSAqIHM7CiAgICAgIHRoaXMueiA9IHZlY3Rvci56ICogczsKICAgICAgdGhpcy53ID0gTWF0aC5jb3MoYW5nbGUgKiAwLjUpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydHMgdGhlIHF1YXRlcm5pb24gdG8gWyBheGlzLCBhbmdsZSBdIHJlcHJlc2VudGF0aW9uLgogICAgICogQHBhcmFtIHRhcmdldEF4aXMgQSB2ZWN0b3Igb2JqZWN0IHRvIHJldXNlIGZvciBzdG9yaW5nIHRoZSBheGlzLgogICAgICogQHJldHVybiBBbiBhcnJheSwgZmlyc3QgZWxlbWVudCBpcyB0aGUgYXhpcyBhbmQgdGhlIHNlY29uZCBpcyB0aGUgYW5nbGUgaW4gcmFkaWFucy4KICAgICAqLwoKCiAgICB0b0F4aXNBbmdsZSh0YXJnZXRBeGlzKSB7CiAgICAgIGlmICh0YXJnZXRBeGlzID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXRBeGlzID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgdGhpcy5ub3JtYWxpemUoKTsgLy8gaWYgdz4xIGFjb3MgYW5kIHNxcnQgd2lsbCBwcm9kdWNlIGVycm9ycywgdGhpcyBjYW50IGhhcHBlbiBpZiBxdWF0ZXJuaW9uIGlzIG5vcm1hbGlzZWQKCiAgICAgIGNvbnN0IGFuZ2xlID0gMiAqIE1hdGguYWNvcyh0aGlzLncpOwogICAgICBjb25zdCBzID0gTWF0aC5zcXJ0KDEgLSB0aGlzLncgKiB0aGlzLncpOyAvLyBhc3N1bWluZyBxdWF0ZXJuaW9uIG5vcm1hbGlzZWQgdGhlbiB3IGlzIGxlc3MgdGhhbiAxLCBzbyB0ZXJtIGFsd2F5cyBwb3NpdGl2ZS4KCiAgICAgIGlmIChzIDwgMC4wMDEpIHsKICAgICAgICAvLyB0ZXN0IHRvIGF2b2lkIGRpdmlkZSBieSB6ZXJvLCBzIGlzIGFsd2F5cyBwb3NpdGl2ZSBkdWUgdG8gc3FydAogICAgICAgIC8vIGlmIHMgY2xvc2UgdG8gemVybyB0aGVuIGRpcmVjdGlvbiBvZiBheGlzIG5vdCBpbXBvcnRhbnQKICAgICAgICB0YXJnZXRBeGlzLnggPSB0aGlzLng7IC8vIGlmIGl0IGlzIGltcG9ydGFudCB0aGF0IGF4aXMgaXMgbm9ybWFsaXNlZCB0aGVuIHJlcGxhY2Ugd2l0aCB4PTE7IHk9ej0wOwoKICAgICAgICB0YXJnZXRBeGlzLnkgPSB0aGlzLnk7CiAgICAgICAgdGFyZ2V0QXhpcy56ID0gdGhpcy56OwogICAgICB9IGVsc2UgewogICAgICAgIHRhcmdldEF4aXMueCA9IHRoaXMueCAvIHM7IC8vIG5vcm1hbGlzZSBheGlzCgogICAgICAgIHRhcmdldEF4aXMueSA9IHRoaXMueSAvIHM7CiAgICAgICAgdGFyZ2V0QXhpcy56ID0gdGhpcy56IC8gczsKICAgICAgfQoKICAgICAgcmV0dXJuIFt0YXJnZXRBeGlzLCBhbmdsZV07CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcXVhdGVybmlvbiB2YWx1ZSBnaXZlbiB0d28gdmVjdG9ycy4gVGhlIHJlc3VsdGluZyByb3RhdGlvbiB3aWxsIGJlIHRoZSBuZWVkZWQgcm90YXRpb24gdG8gcm90YXRlIHUgdG8gdi4KICAgICAqLwoKCiAgICBzZXRGcm9tVmVjdG9ycyh1LCB2KSB7CiAgICAgIGlmICh1LmlzQW50aXBhcmFsbGVsVG8odikpIHsKICAgICAgICBjb25zdCB0MSA9IHNmdl90MTsKICAgICAgICBjb25zdCB0MiA9IHNmdl90MjsKICAgICAgICB1LnRhbmdlbnRzKHQxLCB0Mik7CiAgICAgICAgdGhpcy5zZXRGcm9tQXhpc0FuZ2xlKHQxLCBNYXRoLlBJKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhID0gdS5jcm9zcyh2KTsKICAgICAgICB0aGlzLnggPSBhLng7CiAgICAgICAgdGhpcy55ID0gYS55OwogICAgICAgIHRoaXMueiA9IGEuejsKICAgICAgICB0aGlzLncgPSBNYXRoLnNxcnQodS5sZW5ndGgoKSAqKiAyICogdi5sZW5ndGgoKSAqKiAyKSArIHUuZG90KHYpOwogICAgICAgIHRoaXMubm9ybWFsaXplKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB0aGUgcXVhdGVybmlvbiB3aXRoIGFuIG90aGVyIHF1YXRlcm5pb24uCiAgICAgKi8KCgogICAgbXVsdChxdWF0LCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgfQoKICAgICAgY29uc3QgYXggPSB0aGlzLng7CiAgICAgIGNvbnN0IGF5ID0gdGhpcy55OwogICAgICBjb25zdCBheiA9IHRoaXMuejsKICAgICAgY29uc3QgYXcgPSB0aGlzLnc7CiAgICAgIGNvbnN0IGJ4ID0gcXVhdC54OwogICAgICBjb25zdCBieSA9IHF1YXQueTsKICAgICAgY29uc3QgYnogPSBxdWF0Lno7CiAgICAgIGNvbnN0IGJ3ID0gcXVhdC53OwogICAgICB0YXJnZXQueCA9IGF4ICogYncgKyBhdyAqIGJ4ICsgYXkgKiBieiAtIGF6ICogYnk7CiAgICAgIHRhcmdldC55ID0gYXkgKiBidyArIGF3ICogYnkgKyBheiAqIGJ4IC0gYXggKiBiejsKICAgICAgdGFyZ2V0LnogPSBheiAqIGJ3ICsgYXcgKiBieiArIGF4ICogYnkgLSBheSAqIGJ4OwogICAgICB0YXJnZXQudyA9IGF3ICogYncgLSBheCAqIGJ4IC0gYXkgKiBieSAtIGF6ICogYno7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgaW52ZXJzZSBxdWF0ZXJuaW9uIHJvdGF0aW9uLgogICAgICovCgoKICAgIGludmVyc2UodGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHggPSB0aGlzLng7CiAgICAgIGNvbnN0IHkgPSB0aGlzLnk7CiAgICAgIGNvbnN0IHogPSB0aGlzLno7CiAgICAgIGNvbnN0IHcgPSB0aGlzLnc7CiAgICAgIHRoaXMuY29uanVnYXRlKHRhcmdldCk7CiAgICAgIGNvbnN0IGlub3JtMiA9IDEgLyAoeCAqIHggKyB5ICogeSArIHogKiB6ICsgdyAqIHcpOwogICAgICB0YXJnZXQueCAqPSBpbm9ybTI7CiAgICAgIHRhcmdldC55ICo9IGlub3JtMjsKICAgICAgdGFyZ2V0LnogKj0gaW5vcm0yOwogICAgICB0YXJnZXQudyAqPSBpbm9ybTI7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgcXVhdGVybmlvbiBjb25qdWdhdGUKICAgICAqLwoKCiAgICBjb25qdWdhdGUodGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIH0KCiAgICAgIHRhcmdldC54ID0gLXRoaXMueDsKICAgICAgdGFyZ2V0LnkgPSAtdGhpcy55OwogICAgICB0YXJnZXQueiA9IC10aGlzLno7CiAgICAgIHRhcmdldC53ID0gdGhpcy53OwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQogICAgLyoqCiAgICAgKiBOb3JtYWxpemUgdGhlIHF1YXRlcm5pb24uIE5vdGUgdGhhdCB0aGlzIGNoYW5nZXMgdGhlIHZhbHVlcyBvZiB0aGUgcXVhdGVybmlvbi4KICAgICAqLwoKCiAgICBub3JtYWxpemUoKSB7CiAgICAgIGxldCBsID0gTWF0aC5zcXJ0KHRoaXMueCAqIHRoaXMueCArIHRoaXMueSAqIHRoaXMueSArIHRoaXMueiAqIHRoaXMueiArIHRoaXMudyAqIHRoaXMudyk7CgogICAgICBpZiAobCA9PT0gMCkgewogICAgICAgIHRoaXMueCA9IDA7CiAgICAgICAgdGhpcy55ID0gMDsKICAgICAgICB0aGlzLnogPSAwOwogICAgICAgIHRoaXMudyA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbCA9IDEgLyBsOwogICAgICAgIHRoaXMueCAqPSBsOwogICAgICAgIHRoaXMueSAqPSBsOwogICAgICAgIHRoaXMueiAqPSBsOwogICAgICAgIHRoaXMudyAqPSBsOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogQXBwcm94aW1hdGlvbiBvZiBxdWF0ZXJuaW9uIG5vcm1hbGl6YXRpb24uIFdvcmtzIGJlc3Qgd2hlbiBxdWF0IGlzIGFscmVhZHkgYWxtb3N0LW5vcm1hbGl6ZWQuCiAgICAgKiBAYXV0aG9yIHVucGhhc2VkLCBodHRwczovL2dpdGh1Yi5jb20vdW5waGFzZWQKICAgICAqLwoKCiAgICBub3JtYWxpemVGYXN0KCkgewogICAgICBjb25zdCBmID0gKDMuMCAtICh0aGlzLnggKiB0aGlzLnggKyB0aGlzLnkgKiB0aGlzLnkgKyB0aGlzLnogKiB0aGlzLnogKyB0aGlzLncgKiB0aGlzLncpKSAvIDIuMDsKCiAgICAgIGlmIChmID09PSAwKSB7CiAgICAgICAgdGhpcy54ID0gMDsKICAgICAgICB0aGlzLnkgPSAwOwogICAgICAgIHRoaXMueiA9IDA7CiAgICAgICAgdGhpcy53ID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnggKj0gZjsKICAgICAgICB0aGlzLnkgKj0gZjsKICAgICAgICB0aGlzLnogKj0gZjsKICAgICAgICB0aGlzLncgKj0gZjsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIE11bHRpcGx5IHRoZSBxdWF0ZXJuaW9uIGJ5IGEgdmVjdG9yCiAgICAgKi8KCgogICAgdm11bHQodiwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHggPSB2Lng7CiAgICAgIGNvbnN0IHkgPSB2Lnk7CiAgICAgIGNvbnN0IHogPSB2Lno7CiAgICAgIGNvbnN0IHF4ID0gdGhpcy54OwogICAgICBjb25zdCBxeSA9IHRoaXMueTsKICAgICAgY29uc3QgcXogPSB0aGlzLno7CiAgICAgIGNvbnN0IHF3ID0gdGhpcy53OyAvLyBxKnYKCiAgICAgIGNvbnN0IGl4ID0gcXcgKiB4ICsgcXkgKiB6IC0gcXogKiB5OwogICAgICBjb25zdCBpeSA9IHF3ICogeSArIHF6ICogeCAtIHF4ICogejsKICAgICAgY29uc3QgaXogPSBxdyAqIHogKyBxeCAqIHkgLSBxeSAqIHg7CiAgICAgIGNvbnN0IGl3ID0gLXF4ICogeCAtIHF5ICogeSAtIHF6ICogejsKICAgICAgdGFyZ2V0LnggPSBpeCAqIHF3ICsgaXcgKiAtcXggKyBpeSAqIC1xeiAtIGl6ICogLXF5OwogICAgICB0YXJnZXQueSA9IGl5ICogcXcgKyBpdyAqIC1xeSArIGl6ICogLXF4IC0gaXggKiAtcXo7CiAgICAgIHRhcmdldC56ID0gaXogKiBxdyArIGl3ICogLXF6ICsgaXggKiAtcXkgLSBpeSAqIC1xeDsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogQ29waWVzIHZhbHVlIG9mIHNvdXJjZSB0byB0aGlzIHF1YXRlcm5pb24uCiAgICAgKiBAcmV0dXJuIHRoaXMKICAgICAqLwoKCiAgICBjb3B5KHF1YXQpIHsKICAgICAgdGhpcy54ID0gcXVhdC54OwogICAgICB0aGlzLnkgPSBxdWF0Lnk7CiAgICAgIHRoaXMueiA9IHF1YXQuejsKICAgICAgdGhpcy53ID0gcXVhdC53OwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCB0aGUgcXVhdGVybmlvbiB0byBldWxlciBhbmdsZSByZXByZXNlbnRhdGlvbi4gT3JkZXI6IFlaWCwgYXMgdGhpcyBwYWdlIGRlc2NyaWJlczogaHR0cHM6Ly93d3cuZXVjbGlkZWFuc3BhY2UuY29tL21hdGhzL3N0YW5kYXJkcy9pbmRleC5odG0KICAgICAqIEBwYXJhbSBvcmRlciBUaHJlZS1jaGFyYWN0ZXIgc3RyaW5nLCBkZWZhdWx0cyB0byAiWVpYIgogICAgICovCgoKICAgIHRvRXVsZXIodGFyZ2V0LCBvcmRlcikgewogICAgICBpZiAob3JkZXIgPT09IHZvaWQgMCkgewogICAgICAgIG9yZGVyID0gJ1laWCc7CiAgICAgIH0KCiAgICAgIGxldCBoZWFkaW5nOwogICAgICBsZXQgYXR0aXR1ZGU7CiAgICAgIGxldCBiYW5rOwogICAgICBjb25zdCB4ID0gdGhpcy54OwogICAgICBjb25zdCB5ID0gdGhpcy55OwogICAgICBjb25zdCB6ID0gdGhpcy56OwogICAgICBjb25zdCB3ID0gdGhpcy53OwoKICAgICAgc3dpdGNoIChvcmRlcikgewogICAgICAgIGNhc2UgJ1laWCc6CiAgICAgICAgICBjb25zdCB0ZXN0ID0geCAqIHkgKyB6ICogdzsKCiAgICAgICAgICBpZiAodGVzdCA+IDAuNDk5KSB7CiAgICAgICAgICAgIC8vIHNpbmd1bGFyaXR5IGF0IG5vcnRoIHBvbGUKICAgICAgICAgICAgaGVhZGluZyA9IDIgKiBNYXRoLmF0YW4yKHgsIHcpOwogICAgICAgICAgICBhdHRpdHVkZSA9IE1hdGguUEkgLyAyOwogICAgICAgICAgICBiYW5rID0gMDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodGVzdCA8IC0wLjQ5OSkgewogICAgICAgICAgICAvLyBzaW5ndWxhcml0eSBhdCBzb3V0aCBwb2xlCiAgICAgICAgICAgIGhlYWRpbmcgPSAtMiAqIE1hdGguYXRhbjIoeCwgdyk7CiAgICAgICAgICAgIGF0dGl0dWRlID0gLU1hdGguUEkgLyAyOwogICAgICAgICAgICBiYW5rID0gMDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaGVhZGluZyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNvbnN0IHNxeCA9IHggKiB4OwogICAgICAgICAgICBjb25zdCBzcXkgPSB5ICogeTsKICAgICAgICAgICAgY29uc3Qgc3F6ID0geiAqIHo7CiAgICAgICAgICAgIGhlYWRpbmcgPSBNYXRoLmF0YW4yKDIgKiB5ICogdyAtIDIgKiB4ICogeiwgMSAtIDIgKiBzcXkgLSAyICogc3F6KTsgLy8gSGVhZGluZwoKICAgICAgICAgICAgYXR0aXR1ZGUgPSBNYXRoLmFzaW4oMiAqIHRlc3QpOyAvLyBhdHRpdHVkZQoKICAgICAgICAgICAgYmFuayA9IE1hdGguYXRhbjIoMiAqIHggKiB3IC0gMiAqIHkgKiB6LCAxIC0gMiAqIHNxeCAtIDIgKiBzcXopOyAvLyBiYW5rCiAgICAgICAgICB9CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV1bGVyIG9yZGVyICIgKyBvcmRlciArICIgbm90IHN1cHBvcnRlZCB5ZXQuIik7CiAgICAgIH0KCiAgICAgIHRhcmdldC55ID0gaGVhZGluZzsKICAgICAgdGFyZ2V0LnogPSBhdHRpdHVkZTsKICAgICAgdGFyZ2V0LnggPSBiYW5rOwogICAgfQogICAgLyoqCiAgICAgKiBAcGFyYW0gb3JkZXIgVGhlIG9yZGVyIHRvIGFwcGx5IGFuZ2xlczogJ1hZWicgb3IgJ1lYWicgb3IgYW55IG90aGVyIGNvbWJpbmF0aW9uLgogICAgICoKICAgICAqIFNlZSB7QGxpbmsgaHR0cHM6Ly93d3cubWF0aHdvcmtzLmNvbS9tYXRsYWJjZW50cmFsL2ZpbGVleGNoYW5nZS8yMDY5Ni1mdW5jdGlvbi10by1jb252ZXJ0LWJldHdlZW4tZGNtLWV1bGVyLWFuZ2xlcy1xdWF0ZXJuaW9ucy1hbmQtZXVsZXItdmVjdG9ycyBNYXRoV29ya3N9IHJlZmVyZW5jZQogICAgICovCgoKICAgIHNldEZyb21FdWxlcih4LCB5LCB6LCBvcmRlcikgewogICAgICBpZiAob3JkZXIgPT09IHZvaWQgMCkgewogICAgICAgIG9yZGVyID0gJ1hZWic7CiAgICAgIH0KCiAgICAgIGNvbnN0IGMxID0gTWF0aC5jb3MoeCAvIDIpOwogICAgICBjb25zdCBjMiA9IE1hdGguY29zKHkgLyAyKTsKICAgICAgY29uc3QgYzMgPSBNYXRoLmNvcyh6IC8gMik7CiAgICAgIGNvbnN0IHMxID0gTWF0aC5zaW4oeCAvIDIpOwogICAgICBjb25zdCBzMiA9IE1hdGguc2luKHkgLyAyKTsKICAgICAgY29uc3QgczMgPSBNYXRoLnNpbih6IC8gMik7CgogICAgICBpZiAob3JkZXIgPT09ICdYWVonKSB7CiAgICAgICAgdGhpcy54ID0gczEgKiBjMiAqIGMzICsgYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMueSA9IGMxICogczIgKiBjMyAtIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLnogPSBjMSAqIGMyICogczMgKyBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy53ID0gYzEgKiBjMiAqIGMzIC0gczEgKiBzMiAqIHMzOwogICAgICB9IGVsc2UgaWYgKG9yZGVyID09PSAnWVhaJykgewogICAgICAgIHRoaXMueCA9IHMxICogYzIgKiBjMyArIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLnkgPSBjMSAqIHMyICogYzMgLSBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy56ID0gYzEgKiBjMiAqIHMzIC0gczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMudyA9IGMxICogYzIgKiBjMyArIHMxICogczIgKiBzMzsKICAgICAgfSBlbHNlIGlmIChvcmRlciA9PT0gJ1pYWScpIHsKICAgICAgICB0aGlzLnggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy55ID0gYzEgKiBzMiAqIGMzICsgczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMueiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLncgPSBjMSAqIGMyICogYzMgLSBzMSAqIHMyICogczM7CiAgICAgIH0gZWxzZSBpZiAob3JkZXIgPT09ICdaWVgnKSB7CiAgICAgICAgdGhpcy54ID0gczEgKiBjMiAqIGMzIC0gYzEgKiBzMiAqIHMzOwogICAgICAgIHRoaXMueSA9IGMxICogczIgKiBjMyArIHMxICogYzIgKiBzMzsKICAgICAgICB0aGlzLnogPSBjMSAqIGMyICogczMgLSBzMSAqIHMyICogYzM7CiAgICAgICAgdGhpcy53ID0gYzEgKiBjMiAqIGMzICsgczEgKiBzMiAqIHMzOwogICAgICB9IGVsc2UgaWYgKG9yZGVyID09PSAnWVpYJykgewogICAgICAgIHRoaXMueCA9IHMxICogYzIgKiBjMyArIGMxICogczIgKiBzMzsKICAgICAgICB0aGlzLnkgPSBjMSAqIHMyICogYzMgKyBzMSAqIGMyICogczM7CiAgICAgICAgdGhpcy56ID0gYzEgKiBjMiAqIHMzIC0gczEgKiBzMiAqIGMzOwogICAgICAgIHRoaXMudyA9IGMxICogYzIgKiBjMyAtIHMxICogczIgKiBzMzsKICAgICAgfSBlbHNlIGlmIChvcmRlciA9PT0gJ1haWScpIHsKICAgICAgICB0aGlzLnggPSBzMSAqIGMyICogYzMgLSBjMSAqIHMyICogczM7CiAgICAgICAgdGhpcy55ID0gYzEgKiBzMiAqIGMzIC0gczEgKiBjMiAqIHMzOwogICAgICAgIHRoaXMueiA9IGMxICogYzIgKiBzMyArIHMxICogczIgKiBjMzsKICAgICAgICB0aGlzLncgPSBjMSAqIGMyICogYzMgKyBzMSAqIHMyICogczM7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIGNsb25lKCkgewogICAgICByZXR1cm4gbmV3IFF1YXRlcm5pb24odGhpcy54LCB0aGlzLnksIHRoaXMueiwgdGhpcy53KTsKICAgIH0KICAgIC8qKgogICAgICogUGVyZm9ybXMgYSBzcGhlcmljYWwgbGluZWFyIGludGVycG9sYXRpb24gYmV0d2VlbiB0d28gcXVhdAogICAgICoKICAgICAqIEBwYXJhbSB0b1F1YXQgc2Vjb25kIG9wZXJhbmQKICAgICAqIEBwYXJhbSB0IGludGVycG9sYXRpb24gYW1vdW50IGJldHdlZW4gdGhlIHNlbGYgcXVhdGVybmlvbiBhbmQgdG9RdWF0CiAgICAgKiBAcGFyYW0gdGFyZ2V0IEEgcXVhdGVybmlvbiB0byBzdG9yZSB0aGUgcmVzdWx0IGluLiBJZiBub3QgcHJvdmlkZWQsIGEgbmV3IG9uZSB3aWxsIGJlIGNyZWF0ZWQuCiAgICAgKiBAcmV0dXJucyB7UXVhdGVybmlvbn0gVGhlICJ0YXJnZXQiIG9iamVjdAogICAgICovCgoKICAgIHNsZXJwKHRvUXVhdCwgdCwgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGF4ID0gdGhpcy54OwogICAgICBjb25zdCBheSA9IHRoaXMueTsKICAgICAgY29uc3QgYXogPSB0aGlzLno7CiAgICAgIGNvbnN0IGF3ID0gdGhpcy53OwogICAgICBsZXQgYnggPSB0b1F1YXQueDsKICAgICAgbGV0IGJ5ID0gdG9RdWF0Lnk7CiAgICAgIGxldCBieiA9IHRvUXVhdC56OwogICAgICBsZXQgYncgPSB0b1F1YXQudzsKICAgICAgbGV0IG9tZWdhOwogICAgICBsZXQgY29zb207CiAgICAgIGxldCBzaW5vbTsKICAgICAgbGV0IHNjYWxlMDsKICAgICAgbGV0IHNjYWxlMTsgLy8gY2FsYyBjb3NpbmUKCiAgICAgIGNvc29tID0gYXggKiBieCArIGF5ICogYnkgKyBheiAqIGJ6ICsgYXcgKiBidzsgLy8gYWRqdXN0IHNpZ25zIChpZiBuZWNlc3NhcnkpCgogICAgICBpZiAoY29zb20gPCAwLjApIHsKICAgICAgICBjb3NvbSA9IC1jb3NvbTsKICAgICAgICBieCA9IC1ieDsKICAgICAgICBieSA9IC1ieTsKICAgICAgICBieiA9IC1iejsKICAgICAgICBidyA9IC1idzsKICAgICAgfSAvLyBjYWxjdWxhdGUgY29lZmZpY2llbnRzCgoKICAgICAgaWYgKDEuMCAtIGNvc29tID4gMC4wMDAwMDEpIHsKICAgICAgICAvLyBzdGFuZGFyZCBjYXNlIChzbGVycCkKICAgICAgICBvbWVnYSA9IE1hdGguYWNvcyhjb3NvbSk7CiAgICAgICAgc2lub20gPSBNYXRoLnNpbihvbWVnYSk7CiAgICAgICAgc2NhbGUwID0gTWF0aC5zaW4oKDEuMCAtIHQpICogb21lZ2EpIC8gc2lub207CiAgICAgICAgc2NhbGUxID0gTWF0aC5zaW4odCAqIG9tZWdhKSAvIHNpbm9tOwogICAgICB9IGVsc2UgewogICAgICAgIC8vICJmcm9tIiBhbmQgInRvIiBxdWF0ZXJuaW9ucyBhcmUgdmVyeSBjbG9zZQogICAgICAgIC8vICAuLi4gc28gd2UgY2FuIGRvIGEgbGluZWFyIGludGVycG9sYXRpb24KICAgICAgICBzY2FsZTAgPSAxLjAgLSB0OwogICAgICAgIHNjYWxlMSA9IHQ7CiAgICAgIH0gLy8gY2FsY3VsYXRlIGZpbmFsIHZhbHVlcwoKCiAgICAgIHRhcmdldC54ID0gc2NhbGUwICogYXggKyBzY2FsZTEgKiBieDsKICAgICAgdGFyZ2V0LnkgPSBzY2FsZTAgKiBheSArIHNjYWxlMSAqIGJ5OwogICAgICB0YXJnZXQueiA9IHNjYWxlMCAqIGF6ICsgc2NhbGUxICogYno7CiAgICAgIHRhcmdldC53ID0gc2NhbGUwICogYXcgKyBzY2FsZTEgKiBidzsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KICAgIC8qKgogICAgICogUm90YXRlIGFuIGFic29sdXRlIG9yaWVudGF0aW9uIHF1YXRlcm5pb24gZ2l2ZW4gYW4gYW5ndWxhciB2ZWxvY2l0eSBhbmQgYSB0aW1lIHN0ZXAuCiAgICAgKi8KCgogICAgaW50ZWdyYXRlKGFuZ3VsYXJWZWxvY2l0eSwgZHQsIGFuZ3VsYXJGYWN0b3IsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgUXVhdGVybmlvbigpOwogICAgICB9CgogICAgICBjb25zdCBheCA9IGFuZ3VsYXJWZWxvY2l0eS54ICogYW5ndWxhckZhY3Rvci54LAogICAgICAgICAgICBheSA9IGFuZ3VsYXJWZWxvY2l0eS55ICogYW5ndWxhckZhY3Rvci55LAogICAgICAgICAgICBheiA9IGFuZ3VsYXJWZWxvY2l0eS56ICogYW5ndWxhckZhY3Rvci56LAogICAgICAgICAgICBieCA9IHRoaXMueCwKICAgICAgICAgICAgYnkgPSB0aGlzLnksCiAgICAgICAgICAgIGJ6ID0gdGhpcy56LAogICAgICAgICAgICBidyA9IHRoaXMudzsKICAgICAgY29uc3QgaGFsZl9kdCA9IGR0ICogMC41OwogICAgICB0YXJnZXQueCArPSBoYWxmX2R0ICogKGF4ICogYncgKyBheSAqIGJ6IC0gYXogKiBieSk7CiAgICAgIHRhcmdldC55ICs9IGhhbGZfZHQgKiAoYXkgKiBidyArIGF6ICogYnggLSBheCAqIGJ6KTsKICAgICAgdGFyZ2V0LnogKz0gaGFsZl9kdCAqIChheiAqIGJ3ICsgYXggKiBieSAtIGF5ICogYngpOwogICAgICB0YXJnZXQudyArPSBoYWxmX2R0ICogKC1heCAqIGJ4IC0gYXkgKiBieSAtIGF6ICogYnopOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfQoKICB9CgogIGNvbnN0IHNmdl90MSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc2Z2X3QyID0gbmV3IFZlYzMoKTsKICAvKioKICAgKiBUaGUgYXZhaWxhYmxlIHNoYXBlIHR5cGVzLgogICAqLwoKICBjb25zdCBTSEFQRV9UWVBFUyA9IHsKICAgIC8qKiBTUEhFUkUgKi8KICAgIFNQSEVSRTogMSwKCiAgICAvKiogUExBTkUgKi8KICAgIFBMQU5FOiAyLAoKICAgIC8qKiBCT1ggKi8KICAgIEJPWDogNCwKCiAgICAvKiogQ09NUE9VTkQgKi8KICAgIENPTVBPVU5EOiA4LAoKICAgIC8qKiBDT05WRVhQT0xZSEVEUk9OICovCiAgICBDT05WRVhQT0xZSEVEUk9OOiAxNiwKCiAgICAvKiogSEVJR0hURklFTEQgKi8KICAgIEhFSUdIVEZJRUxEOiAzMiwKCiAgICAvKiogUEFSVElDTEUgKi8KICAgIFBBUlRJQ0xFOiA2NCwKCiAgICAvKiogQ1lMSU5ERVIgKi8KICAgIENZTElOREVSOiAxMjgsCgogICAgLyoqIFRSSU1FU0ggKi8KICAgIFRSSU1FU0g6IDI1NgogIH07CiAgLyoqCiAgICogU2hhcGVUeXBlCiAgICovCgogIC8qKgogICAqIEJhc2UgY2xhc3MgZm9yIHNoYXBlcwogICAqLwoKICBjbGFzcyBTaGFwZSB7CiAgICAvKioKICAgICAqIElkZW50aWZpZXIgb2YgdGhlIFNoYXBlLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgdHlwZSBvZiB0aGlzIHNoYXBlLiBNdXN0IGJlIHNldCB0byBhbiBpbnQgPiAwIGJ5IHN1YmNsYXNzZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBsb2NhbCBib3VuZGluZyBzcGhlcmUgcmFkaXVzIG9mIHRoaXMgc2hhcGUuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdoZXRoZXIgdG8gcHJvZHVjZSBjb250YWN0IGZvcmNlcyB3aGVuIGluIGNvbnRhY3Qgd2l0aCBvdGhlciBib2RpZXMuIE5vdGUgdGhhdCBjb250YWN0cyB3aWxsIGJlIGdlbmVyYXRlZCwgYnV0IHRoZXkgd2lsbCBiZSBkaXNhYmxlZC4KICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBAZGVmYXVsdCAtMQogICAgICovCgogICAgLyoqCiAgICAgKiBPcHRpb25hbCBtYXRlcmlhbCBvZiB0aGUgc2hhcGUgdGhhdCByZWd1bGF0ZXMgY29udGFjdCBwcm9wZXJ0aWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgYm9keSB0byB3aGljaCB0aGUgc2hhcGUgaXMgYWRkZWQgdG8uCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFsbCB0aGUgU2hhcGUgdHlwZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy5pZCA9IHZvaWQgMDsKICAgICAgdGhpcy50eXBlID0gdm9pZCAwOwogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpc2lvblJlc3BvbnNlID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlckdyb3VwID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlck1hc2sgPSB2b2lkIDA7CiAgICAgIHRoaXMubWF0ZXJpYWwgPSB2b2lkIDA7CiAgICAgIHRoaXMuYm9keSA9IHZvaWQgMDsKICAgICAgdGhpcy5pZCA9IFNoYXBlLmlkQ291bnRlcisrOwogICAgICB0aGlzLnR5cGUgPSBvcHRpb25zLnR5cGUgfHwgMDsKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IDA7CiAgICAgIHRoaXMuY29sbGlzaW9uUmVzcG9uc2UgPSBvcHRpb25zLmNvbGxpc2lvblJlc3BvbnNlID8gb3B0aW9ucy5jb2xsaXNpb25SZXNwb25zZSA6IHRydWU7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyR3JvdXAgPSBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwIDogMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrID0gb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJNYXNrICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgOiAtMTsKICAgICAgdGhpcy5tYXRlcmlhbCA9IG9wdGlvbnMubWF0ZXJpYWwgPyBvcHRpb25zLm1hdGVyaWFsIDogbnVsbDsKICAgICAgdGhpcy5ib2R5ID0gbnVsbDsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZXMgdGhlIGJvdW5kaW5nIHNwaGVyZSByYWRpdXMuCiAgICAgKiBUaGUgcmVzdWx0IGlzIHN0b3JlZCBpbiB0aGUgcHJvcGVydHkgYC5ib3VuZGluZ1NwaGVyZVJhZGl1c2AKICAgICAqLwoKCiAgICB1cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIHsKICAgICAgdGhyb3cgImNvbXB1dGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIG5vdCBpbXBsZW1lbnRlZCBmb3Igc2hhcGUgdHlwZSAiICsgdGhpcy50eXBlOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHZvbHVtZSBvZiB0aGlzIHNoYXBlCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICB0aHJvdyAidm9sdW1lKCkgbm90IGltcGxlbWVudGVkIGZvciBzaGFwZSB0eXBlICIgKyB0aGlzLnR5cGU7CiAgICB9CiAgICAvKioKICAgICAqIENhbGN1bGF0ZXMgdGhlIGluZXJ0aWEgaW4gdGhlIGxvY2FsIGZyYW1lIGZvciB0aGlzIHNoYXBlLgogICAgICogQHNlZSBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0xpc3Rfb2ZfbW9tZW50c19vZl9pbmVydGlhCiAgICAgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICB0aHJvdyAiY2FsY3VsYXRlTG9jYWxJbmVydGlhKCkgbm90IGltcGxlbWVudGVkIGZvciBzaGFwZSB0eXBlICIgKyB0aGlzLnR5cGU7CiAgICB9CiAgICAvKioKICAgICAqIEB0b2RvIHVzZSBhYnN0cmFjdCBmb3IgdGhlc2Uga2luZCBvZiBtZXRob2RzCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgdGhyb3cgImNhbGN1bGF0ZVdvcmxkQUFCQigpIG5vdCBpbXBsZW1lbnRlZCBmb3Igc2hhcGUgdHlwZSAiICsgdGhpcy50eXBlOwogICAgfQoKICB9CgogIFNoYXBlLmlkQ291bnRlciA9IDA7CiAgU2hhcGUudHlwZXMgPSBTSEFQRV9UWVBFUzsKICAvKioKICAgKiBUcmFuc2Zvcm1hdGlvbiB1dGlsaXRpZXMuCiAgICovCgogIGNsYXNzIFRyYW5zZm9ybSB7CiAgICAvKioKICAgICAqIHBvc2l0aW9uCiAgICAgKi8KCiAgICAvKioKICAgICAqIHF1YXRlcm5pb24KICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLnBvc2l0aW9uID0gdm9pZCAwOwogICAgICB0aGlzLnF1YXRlcm5pb24gPSB2b2lkIDA7CiAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwoKICAgICAgaWYgKG9wdGlvbnMucG9zaXRpb24pIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLmNvcHkob3B0aW9ucy5wb3NpdGlvbik7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnF1YXRlcm5pb24pIHsKICAgICAgICB0aGlzLnF1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIGdsb2JhbCBwb2ludCBpbiBsb2NhbCB0cmFuc2Zvcm0gY29vcmRpbmF0ZXMuCiAgICAgKi8KCgogICAgcG9pbnRUb0xvY2FsKHdvcmxkUG9pbnQsIHJlc3VsdCkgewogICAgICByZXR1cm4gVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKHRoaXMucG9zaXRpb24sIHRoaXMucXVhdGVybmlvbiwgd29ybGRQb2ludCwgcmVzdWx0KTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGEgbG9jYWwgcG9pbnQgaW4gZ2xvYmFsIHRyYW5zZm9ybSBjb29yZGluYXRlcy4KICAgICAqLwoKCiAgICBwb2ludFRvV29ybGQobG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIHJldHVybiBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5wb3NpdGlvbiwgdGhpcy5xdWF0ZXJuaW9uLCBsb2NhbFBvaW50LCByZXN1bHQpOwogICAgfQogICAgLyoqCiAgICAgKiB2ZWN0b3JUb1dvcmxkRnJhbWUKICAgICAqLwoKCiAgICB2ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICB0aGlzLnF1YXRlcm5pb24udm11bHQobG9jYWxWZWN0b3IsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHBvaW50VG9Mb2NhbEZyYW1lCiAgICAgKi8KCgogICAgc3RhdGljIHBvaW50VG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCB3b3JsZFBvaW50LCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgd29ybGRQb2ludC52c3ViKHBvc2l0aW9uLCByZXN1bHQpOwogICAgICBxdWF0ZXJuaW9uLmNvbmp1Z2F0ZSh0bXBRdWF0JDEpOwogICAgICB0bXBRdWF0JDEudm11bHQocmVzdWx0LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBwb2ludFRvV29ybGRGcmFtZQogICAgICovCgoKICAgIHN0YXRpYyBwb2ludFRvV29ybGRGcmFtZShwb3NpdGlvbiwgcXVhdGVybmlvbiwgbG9jYWxQb2ludCwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHF1YXRlcm5pb24udm11bHQobG9jYWxQb2ludCwgcmVzdWx0KTsKICAgICAgcmVzdWx0LnZhZGQocG9zaXRpb24sIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIHZlY3RvclRvV29ybGRGcmFtZQogICAgICovCgoKICAgIHN0YXRpYyB2ZWN0b3JUb1dvcmxkRnJhbWUocXVhdGVybmlvbiwgbG9jYWxWZWN0b3IsIHJlc3VsdCkgewogICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICByZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBxdWF0ZXJuaW9uLnZtdWx0KGxvY2FsVmVjdG9yLCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiB2ZWN0b3JUb0xvY2FsRnJhbWUKICAgICAqLwoKCiAgICBzdGF0aWMgdmVjdG9yVG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0ZXJuaW9uLCB3b3JsZFZlY3RvciwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHF1YXRlcm5pb24udyAqPSAtMTsKICAgICAgcXVhdGVybmlvbi52bXVsdCh3b3JsZFZlY3RvciwgcmVzdWx0KTsKICAgICAgcXVhdGVybmlvbi53ICo9IC0xOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICB9CgogIGNvbnN0IHRtcFF1YXQkMSA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgLyoqCiAgICogQSBzZXQgb2YgcG9seWdvbnMgZGVzY3JpYmluZyBhIGNvbnZleCBzaGFwZS4KICAgKgogICAqIFRoZSBzaGFwZSBNVVNUIGJlIGNvbnZleCBmb3IgdGhlIGNvZGUgdG8gd29yayBwcm9wZXJseS4gTm8gcG9seWdvbnMgbWF5IGJlIGNvcGxhbmFyIChjb250YWluZWQKICAgKiBpbiB0aGUgc2FtZSAzRCBwbGFuZSksIGluc3RlYWQgdGhlc2Ugc2hvdWxkIGJlIG1lcmdlZCBpbnRvIG9uZSBwb2x5Z29uLgogICAqCiAgICogQGF1dGhvciBxaWFvIC8gaHR0cHM6Ly9naXRodWIuY29tL3FpYW8gKG9yaWdpbmFsIGF1dGhvciwgc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9xaWFvL3RocmVlLmpzL2NvbW1pdC84NTAyNmYwYzc2OWU0MDAwMTQ4YTY3ZDQ1YTllOWI5YzUxMDg4MzZmKQogICAqIEBhdXRob3Igc2NodGVwcGUgLyBodHRwczovL2dpdGh1Yi5jb20vc2NodGVwcGUKICAgKiBAc2VlIGh0dHBzOi8vd3d3LmFsdGRldmJsb2dhZGF5LmNvbS8yMDExLzA1LzEzL2NvbnRhY3QtZ2VuZXJhdGlvbi1iZXR3ZWVuLTNkLWNvbnZleC1tZXNoZXMvCiAgICoKICAgKiBAdG9kbyBNb3ZlIHRoZSBjbGlwcGluZyBmdW5jdGlvbnMgdG8gQ29udGFjdEdlbmVyYXRvcj8KICAgKiBAdG9kbyBBdXRvbWF0aWNhbGx5IG1lcmdlIGNvcGxhbmFyIHBvbHlnb25zIGluIGNvbnN0cnVjdG9yLgogICAqIEBleGFtcGxlCiAgICogICAgIGNvbnN0IGNvbnZleFNoYXBlID0gbmV3IENBTk5PTi5Db252ZXhQb2x5aGVkcm9uKHsgdmVydGljZXMsIGZhY2VzIH0pCiAgICogICAgIGNvbnN0IGNvbnZleEJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoeyBtYXNzOiAxLCBzaGFwZTogY29udmV4U2hhcGUgfSkKICAgKiAgICAgd29ybGQuYWRkQm9keShjb252ZXhCb2R5KQogICAqLwoKICBjbGFzcyBDb252ZXhQb2x5aGVkcm9uIGV4dGVuZHMgU2hhcGUgewogICAgLyoqIHZlcnRpY2VzICovCgogICAgLyoqCiAgICAgKiBBcnJheSBvZiBpbnRlZ2VyIGFycmF5cywgaW5kaWNhdGluZyB3aGljaCB2ZXJ0aWNlcyBlYWNoIGZhY2UgY29uc2lzdHMgb2YKICAgICAqLwoKICAgIC8qKiBmYWNlTm9ybWFscyAqLwoKICAgIC8qKiB3b3JsZFZlcnRpY2VzICovCgogICAgLyoqIHdvcmxkVmVydGljZXNOZWVkc1VwZGF0ZSAqLwoKICAgIC8qKiB3b3JsZEZhY2VOb3JtYWxzICovCgogICAgLyoqIHdvcmxkRmFjZU5vcm1hbHNOZWVkc1VwZGF0ZSAqLwoKICAgIC8qKgogICAgICogSWYgZ2l2ZW4sIHRoZXNlIGxvY2FsbHkgZGVmaW5lZCwgbm9ybWFsaXplZCBheGVzIGFyZSB0aGUgb25seSBvbmVzIGJlaW5nIGNoZWNrZWQgd2hlbiBkb2luZyBzZXBhcmF0aW5nIGF4aXMgY2hlY2suCiAgICAgKi8KCiAgICAvKiogdW5pcXVlRWRnZXMgKi8KCiAgICAvKioKICAgICAqIEBwYXJhbSB2ZXJ0aWNlcyBBbiBhcnJheSBvZiBWZWMzJ3MKICAgICAqIEBwYXJhbSBmYWNlcyBBcnJheSBvZiBpbnRlZ2VyIGFycmF5cywgZGVzY3JpYmluZyB3aGljaCB2ZXJ0aWNlcyB0aGF0IGlzIGluY2x1ZGVkIGluIGVhY2ggZmFjZS4KICAgICAqLwogICAgY29uc3RydWN0b3IocHJvcHMpIHsKICAgICAgaWYgKHByb3BzID09PSB2b2lkIDApIHsKICAgICAgICBwcm9wcyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCB7CiAgICAgICAgdmVydGljZXMgPSBbXSwKICAgICAgICBmYWNlcyA9IFtdLAogICAgICAgIG5vcm1hbHMgPSBbXSwKICAgICAgICBheGVzLAogICAgICAgIGJvdW5kaW5nU3BoZXJlUmFkaXVzCiAgICAgIH0gPSBwcm9wczsKICAgICAgc3VwZXIoewogICAgICAgIHR5cGU6IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04KICAgICAgfSk7CiAgICAgIHRoaXMudmVydGljZXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuZmFjZXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuZmFjZU5vcm1hbHMgPSB2b2lkIDA7CiAgICAgIHRoaXMud29ybGRWZXJ0aWNlcyA9IHZvaWQgMDsKICAgICAgdGhpcy53b3JsZFZlcnRpY2VzTmVlZHNVcGRhdGUgPSB2b2lkIDA7CiAgICAgIHRoaXMud29ybGRGYWNlTm9ybWFscyA9IHZvaWQgMDsKICAgICAgdGhpcy53b3JsZEZhY2VOb3JtYWxzTmVlZHNVcGRhdGUgPSB2b2lkIDA7CiAgICAgIHRoaXMudW5pcXVlQXhlcyA9IHZvaWQgMDsKICAgICAgdGhpcy51bmlxdWVFZGdlcyA9IHZvaWQgMDsKICAgICAgdGhpcy52ZXJ0aWNlcyA9IHZlcnRpY2VzOwogICAgICB0aGlzLmZhY2VzID0gZmFjZXM7CiAgICAgIHRoaXMuZmFjZU5vcm1hbHMgPSBub3JtYWxzOwoKICAgICAgaWYgKHRoaXMuZmFjZU5vcm1hbHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhpcy5jb21wdXRlTm9ybWFscygpOwogICAgICB9CgogICAgICBpZiAoIWJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSBib3VuZGluZ1NwaGVyZVJhZGl1czsKICAgICAgfQoKICAgICAgdGhpcy53b3JsZFZlcnRpY2VzID0gW107IC8vIFdvcmxkIHRyYW5zZm9ybWVkIHZlcnNpb24gb2YgLnZlcnRpY2VzCgogICAgICB0aGlzLndvcmxkVmVydGljZXNOZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgIHRoaXMud29ybGRGYWNlTm9ybWFscyA9IFtdOyAvLyBXb3JsZCB0cmFuc2Zvcm1lZCB2ZXJzaW9uIG9mIC5mYWNlTm9ybWFscwoKICAgICAgdGhpcy53b3JsZEZhY2VOb3JtYWxzTmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICB0aGlzLnVuaXF1ZUF4ZXMgPSBheGVzID8gYXhlcy5zbGljZSgpIDogbnVsbDsKICAgICAgdGhpcy51bmlxdWVFZGdlcyA9IFtdOwogICAgICB0aGlzLmNvbXB1dGVFZGdlcygpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyB1bmlxdWVFZGdlcwogICAgICovCgoKICAgIGNvbXB1dGVFZGdlcygpIHsKICAgICAgY29uc3QgZmFjZXMgPSB0aGlzLmZhY2VzOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHRoaXMudmVydGljZXM7CiAgICAgIGNvbnN0IGVkZ2VzID0gdGhpcy51bmlxdWVFZGdlczsKICAgICAgZWRnZXMubGVuZ3RoID0gMDsKICAgICAgY29uc3QgZWRnZSA9IG5ldyBWZWMzKCk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBmYWNlID0gZmFjZXNbaV07CiAgICAgICAgY29uc3QgbnVtVmVydGljZXMgPSBmYWNlLmxlbmd0aDsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IG51bVZlcnRpY2VzOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGsgPSAoaiArIDEpICUgbnVtVmVydGljZXM7CiAgICAgICAgICB2ZXJ0aWNlc1tmYWNlW2pdXS52c3ViKHZlcnRpY2VzW2ZhY2Vba11dLCBlZGdlKTsKICAgICAgICAgIGVkZ2Uubm9ybWFsaXplKCk7CiAgICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKCiAgICAgICAgICBmb3IgKGxldCBwID0gMDsgcCAhPT0gZWRnZXMubGVuZ3RoOyBwKyspIHsKICAgICAgICAgICAgaWYgKGVkZ2VzW3BdLmFsbW9zdEVxdWFscyhlZGdlKSB8fCBlZGdlc1twXS5hbG1vc3RFcXVhbHMoZWRnZSkpIHsKICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICAgIGVkZ2VzLnB1c2goZWRnZS5jbG9uZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbm9ybWFscyBvZiB0aGUgZmFjZXMuCiAgICAgKiBXaWxsIHJldXNlIGV4aXN0aW5nIFZlYzMgb2JqZWN0cyBpbiB0aGUgYGZhY2VOb3JtYWxzYCBhcnJheSBpZiB0aGV5IGV4aXN0LgogICAgICovCgoKICAgIGNvbXB1dGVOb3JtYWxzKCkgewogICAgICB0aGlzLmZhY2VOb3JtYWxzLmxlbmd0aCA9IHRoaXMuZmFjZXMubGVuZ3RoOyAvLyBHZW5lcmF0ZSBub3JtYWxzCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAvLyBDaGVjayBzbyBhbGwgdmVydGljZXMgZXhpc3RzIGZvciB0aGlzIGZhY2UKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMuZmFjZXNbaV0ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICghdGhpcy52ZXJ0aWNlc1t0aGlzLmZhY2VzW2ldW2pdXSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlZlcnRleCAiICsgdGhpcy5mYWNlc1tpXVtqXSArICIgbm90IGZvdW5kISIpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY29uc3QgbiA9IHRoaXMuZmFjZU5vcm1hbHNbaV0gfHwgbmV3IFZlYzMoKTsKICAgICAgICB0aGlzLmdldEZhY2VOb3JtYWwoaSwgbik7CiAgICAgICAgbi5uZWdhdGUobik7CiAgICAgICAgdGhpcy5mYWNlTm9ybWFsc1tpXSA9IG47CiAgICAgICAgY29uc3QgdmVydGV4ID0gdGhpcy52ZXJ0aWNlc1t0aGlzLmZhY2VzW2ldWzBdXTsKCiAgICAgICAgaWYgKG4uZG90KHZlcnRleCkgPCAwKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCIuZmFjZU5vcm1hbHNbIiArIGkgKyAiXSA9IFZlYzMoIiArIG4udG9TdHJpbmcoKSArICIpIGxvb2tzIGxpa2UgaXQgcG9pbnRzIGludG8gdGhlIHNoYXBlPyBUaGUgdmVydGljZXMgZm9sbG93LiBNYWtlIHN1cmUgdGhleSBhcmUgb3JkZXJlZCBDQ1cgYXJvdW5kIHRoZSBub3JtYWwsIHVzaW5nIHRoZSByaWdodCBoYW5kIHJ1bGUuIik7CgogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB0aGlzLmZhY2VzW2ldLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiLnZlcnRpY2VzWyIgKyB0aGlzLmZhY2VzW2ldW2pdICsgIl0gPSBWZWMzKCIgKyB0aGlzLnZlcnRpY2VzW3RoaXMuZmFjZXNbaV1bal1dLnRvU3RyaW5nKCkgKyAiKSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlIHRoZSBub3JtYWwgb2YgYSBmYWNlIGZyb20gaXRzIHZlcnRpY2VzCiAgICAgKi8KCgogICAgZ2V0RmFjZU5vcm1hbChpLCB0YXJnZXQpIHsKICAgICAgY29uc3QgZiA9IHRoaXMuZmFjZXNbaV07CiAgICAgIGNvbnN0IHZhID0gdGhpcy52ZXJ0aWNlc1tmWzBdXTsKICAgICAgY29uc3QgdmIgPSB0aGlzLnZlcnRpY2VzW2ZbMV1dOwogICAgICBjb25zdCB2YyA9IHRoaXMudmVydGljZXNbZlsyXV07CiAgICAgIENvbnZleFBvbHloZWRyb24uY29tcHV0ZU5vcm1hbCh2YSwgdmIsIHZjLCB0YXJnZXQpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgZmFjZSBub3JtYWwgZ2l2ZW4gMyB2ZXJ0aWNlcwogICAgICovCgoKICAgIHN0YXRpYyBjb21wdXRlTm9ybWFsKHZhLCB2YiwgdmMsIHRhcmdldCkgewogICAgICBjb25zdCBjYiA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGFiID0gbmV3IFZlYzMoKTsKICAgICAgdmIudnN1Yih2YSwgYWIpOwogICAgICB2Yy52c3ViKHZiLCBjYik7CiAgICAgIGNiLmNyb3NzKGFiLCB0YXJnZXQpOwoKICAgICAgaWYgKCF0YXJnZXQuaXNaZXJvKCkpIHsKICAgICAgICB0YXJnZXQubm9ybWFsaXplKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQHBhcmFtIG1pbkRpc3QgQ2xhbXAgZGlzdGFuY2UKICAgICAqIEBwYXJhbSByZXN1bHQgVGhlIGFuIGFycmF5IG9mIGNvbnRhY3QgcG9pbnQgb2JqZWN0cywgc2VlIGNsaXBGYWNlQWdhaW5zdEh1bGwKICAgICAqLwoKCiAgICBjbGlwQWdhaW5zdEh1bGwocG9zQSwgcXVhdEEsIGh1bGxCLCBwb3NCLCBxdWF0Qiwgc2VwYXJhdGluZ05vcm1hbCwgbWluRGlzdCwgbWF4RGlzdCwgcmVzdWx0KSB7CiAgICAgIGNvbnN0IFdvcmxkTm9ybWFsID0gbmV3IFZlYzMoKTsKICAgICAgbGV0IGNsb3Nlc3RGYWNlQiA9IC0xOwogICAgICBsZXQgZG1heCA9IC1OdW1iZXIuTUFYX1ZBTFVFOwoKICAgICAgZm9yIChsZXQgZmFjZSA9IDA7IGZhY2UgPCBodWxsQi5mYWNlcy5sZW5ndGg7IGZhY2UrKykgewogICAgICAgIFdvcmxkTm9ybWFsLmNvcHkoaHVsbEIuZmFjZU5vcm1hbHNbZmFjZV0pOwogICAgICAgIHF1YXRCLnZtdWx0KFdvcmxkTm9ybWFsLCBXb3JsZE5vcm1hbCk7CiAgICAgICAgY29uc3QgZCA9IFdvcmxkTm9ybWFsLmRvdChzZXBhcmF0aW5nTm9ybWFsKTsKCiAgICAgICAgaWYgKGQgPiBkbWF4KSB7CiAgICAgICAgICBkbWF4ID0gZDsKICAgICAgICAgIGNsb3Nlc3RGYWNlQiA9IGZhY2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCB3b3JsZFZlcnRzQjEgPSBbXTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaHVsbEIuZmFjZXNbY2xvc2VzdEZhY2VCXS5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGIgPSBodWxsQi52ZXJ0aWNlc1todWxsQi5mYWNlc1tjbG9zZXN0RmFjZUJdW2ldXTsKICAgICAgICBjb25zdCB3b3JsZGIgPSBuZXcgVmVjMygpOwogICAgICAgIHdvcmxkYi5jb3B5KGIpOwogICAgICAgIHF1YXRCLnZtdWx0KHdvcmxkYiwgd29ybGRiKTsKICAgICAgICBwb3NCLnZhZGQod29ybGRiLCB3b3JsZGIpOwogICAgICAgIHdvcmxkVmVydHNCMS5wdXNoKHdvcmxkYik7CiAgICAgIH0KCiAgICAgIGlmIChjbG9zZXN0RmFjZUIgPj0gMCkgewogICAgICAgIHRoaXMuY2xpcEZhY2VBZ2FpbnN0SHVsbChzZXBhcmF0aW5nTm9ybWFsLCBwb3NBLCBxdWF0QSwgd29ybGRWZXJ0c0IxLCBtaW5EaXN0LCBtYXhEaXN0LCByZXN1bHQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEZpbmQgdGhlIHNlcGFyYXRpbmcgYXhpcyBiZXR3ZWVuIHRoaXMgaHVsbCBhbmQgYW5vdGhlcgogICAgICogQHBhcmFtIHRhcmdldCBUaGUgdGFyZ2V0IHZlY3RvciB0byBzYXZlIHRoZSBheGlzIGluCiAgICAgKiBAcmV0dXJuIFJldHVybnMgZmFsc2UgaWYgYSBzZXBhcmF0aW9uIGlzIGZvdW5kLCBlbHNlIHRydWUKICAgICAqLwoKCiAgICBmaW5kU2VwYXJhdGluZ0F4aXMoaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0QiwgdGFyZ2V0LCBmYWNlTGlzdEEsIGZhY2VMaXN0QikgewogICAgICBjb25zdCBmYWNlQU5vcm1hbFdTMyA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IFdvcmxkbm9ybWFsMSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGRlbHRhQyA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHdvcmxkRWRnZTAgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCB3b3JsZEVkZ2UxID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgQ3Jvc3MgPSBuZXcgVmVjMygpOwogICAgICBsZXQgZG1pbiA9IE51bWJlci5NQVhfVkFMVUU7CiAgICAgIGNvbnN0IGh1bGxBID0gdGhpczsKCiAgICAgIGlmICghaHVsbEEudW5pcXVlQXhlcykgewogICAgICAgIGNvbnN0IG51bUZhY2VzQSA9IGZhY2VMaXN0QSA/IGZhY2VMaXN0QS5sZW5ndGggOiBodWxsQS5mYWNlcy5sZW5ndGg7IC8vIFRlc3QgZmFjZSBub3JtYWxzIGZyb20gaHVsbEEKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1GYWNlc0E7IGkrKykgewogICAgICAgICAgY29uc3QgZmkgPSBmYWNlTGlzdEEgPyBmYWNlTGlzdEFbaV0gOiBpOyAvLyBHZXQgd29ybGQgZmFjZSBub3JtYWwKCiAgICAgICAgICBmYWNlQU5vcm1hbFdTMy5jb3B5KGh1bGxBLmZhY2VOb3JtYWxzW2ZpXSk7CiAgICAgICAgICBxdWF0QS52bXVsdChmYWNlQU5vcm1hbFdTMywgZmFjZUFOb3JtYWxXUzMpOwogICAgICAgICAgY29uc3QgZCA9IGh1bGxBLnRlc3RTZXBBeGlzKGZhY2VBTm9ybWFsV1MzLCBodWxsQiwgcG9zQSwgcXVhdEEsIHBvc0IsIHF1YXRCKTsKCiAgICAgICAgICBpZiAoZCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChkIDwgZG1pbikgewogICAgICAgICAgICBkbWluID0gZDsKICAgICAgICAgICAgdGFyZ2V0LmNvcHkoZmFjZUFOb3JtYWxXUzMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUZXN0IHVuaXF1ZSBheGVzCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IGh1bGxBLnVuaXF1ZUF4ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIC8vIEdldCB3b3JsZCBheGlzCiAgICAgICAgICBxdWF0QS52bXVsdChodWxsQS51bmlxdWVBeGVzW2ldLCBmYWNlQU5vcm1hbFdTMyk7CiAgICAgICAgICBjb25zdCBkID0gaHVsbEEudGVzdFNlcEF4aXMoZmFjZUFOb3JtYWxXUzMsIGh1bGxCLCBwb3NBLCBxdWF0QSwgcG9zQiwgcXVhdEIpOwoKICAgICAgICAgIGlmIChkID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGQgPCBkbWluKSB7CiAgICAgICAgICAgIGRtaW4gPSBkOwogICAgICAgICAgICB0YXJnZXQuY29weShmYWNlQU5vcm1hbFdTMyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoIWh1bGxCLnVuaXF1ZUF4ZXMpIHsKICAgICAgICAvLyBUZXN0IGZhY2Ugbm9ybWFscyBmcm9tIGh1bGxCCiAgICAgICAgY29uc3QgbnVtRmFjZXNCID0gZmFjZUxpc3RCID8gZmFjZUxpc3RCLmxlbmd0aCA6IGh1bGxCLmZhY2VzLmxlbmd0aDsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1GYWNlc0I7IGkrKykgewogICAgICAgICAgY29uc3QgZmkgPSBmYWNlTGlzdEIgPyBmYWNlTGlzdEJbaV0gOiBpOwogICAgICAgICAgV29ybGRub3JtYWwxLmNvcHkoaHVsbEIuZmFjZU5vcm1hbHNbZmldKTsKICAgICAgICAgIHF1YXRCLnZtdWx0KFdvcmxkbm9ybWFsMSwgV29ybGRub3JtYWwxKTsKICAgICAgICAgIGNvbnN0IGQgPSBodWxsQS50ZXN0U2VwQXhpcyhXb3JsZG5vcm1hbDEsIGh1bGxCLCBwb3NBLCBxdWF0QSwgcG9zQiwgcXVhdEIpOwoKICAgICAgICAgIGlmIChkID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGQgPCBkbWluKSB7CiAgICAgICAgICAgIGRtaW4gPSBkOwogICAgICAgICAgICB0YXJnZXQuY29weShXb3JsZG5vcm1hbDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUZXN0IHVuaXF1ZSBheGVzIGluIEIKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gaHVsbEIudW5pcXVlQXhlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgcXVhdEIudm11bHQoaHVsbEIudW5pcXVlQXhlc1tpXSwgV29ybGRub3JtYWwxKTsKICAgICAgICAgIGNvbnN0IGQgPSBodWxsQS50ZXN0U2VwQXhpcyhXb3JsZG5vcm1hbDEsIGh1bGxCLCBwb3NBLCBxdWF0QSwgcG9zQiwgcXVhdEIpOwoKICAgICAgICAgIGlmIChkID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGQgPCBkbWluKSB7CiAgICAgICAgICAgIGRtaW4gPSBkOwogICAgICAgICAgICB0YXJnZXQuY29weShXb3JsZG5vcm1hbDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBUZXN0IGVkZ2VzCgoKICAgICAgZm9yIChsZXQgZTAgPSAwOyBlMCAhPT0gaHVsbEEudW5pcXVlRWRnZXMubGVuZ3RoOyBlMCsrKSB7CiAgICAgICAgLy8gR2V0IHdvcmxkIGVkZ2UKICAgICAgICBxdWF0QS52bXVsdChodWxsQS51bmlxdWVFZGdlc1tlMF0sIHdvcmxkRWRnZTApOwoKICAgICAgICBmb3IgKGxldCBlMSA9IDA7IGUxICE9PSBodWxsQi51bmlxdWVFZGdlcy5sZW5ndGg7IGUxKyspIHsKICAgICAgICAgIC8vIEdldCB3b3JsZCBlZGdlIDIKICAgICAgICAgIHF1YXRCLnZtdWx0KGh1bGxCLnVuaXF1ZUVkZ2VzW2UxXSwgd29ybGRFZGdlMSk7CiAgICAgICAgICB3b3JsZEVkZ2UwLmNyb3NzKHdvcmxkRWRnZTEsIENyb3NzKTsKCiAgICAgICAgICBpZiAoIUNyb3NzLmFsbW9zdFplcm8oKSkgewogICAgICAgICAgICBDcm9zcy5ub3JtYWxpemUoKTsKICAgICAgICAgICAgY29uc3QgZGlzdCA9IGh1bGxBLnRlc3RTZXBBeGlzKENyb3NzLCBodWxsQiwgcG9zQSwgcXVhdEEsIHBvc0IsIHF1YXRCKTsKCiAgICAgICAgICAgIGlmIChkaXN0ID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpc3QgPCBkbWluKSB7CiAgICAgICAgICAgICAgZG1pbiA9IGRpc3Q7CiAgICAgICAgICAgICAgdGFyZ2V0LmNvcHkoQ3Jvc3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBwb3NCLnZzdWIocG9zQSwgZGVsdGFDKTsKCiAgICAgIGlmIChkZWx0YUMuZG90KHRhcmdldCkgPiAwLjApIHsKICAgICAgICB0YXJnZXQubmVnYXRlKHRhcmdldCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBUZXN0IHNlcGFyYXRpbmcgYXhpcyBhZ2FpbnN0IHR3byBodWxscy4gQm90aCBodWxscyBhcmUgcHJvamVjdGVkIG9udG8gdGhlIGF4aXMgYW5kIHRoZSBvdmVybGFwIHNpemUgaXMgcmV0dXJuZWQgaWYgdGhlcmUgaXMgb25lLgogICAgICogQHJldHVybiBUaGUgb3ZlcmxhcCBkZXB0aCwgb3IgRkFMU0UgaWYgbm8gcGVuZXRyYXRpb24uCiAgICAgKi8KCgogICAgdGVzdFNlcEF4aXMoYXhpcywgaHVsbEIsIHBvc0EsIHF1YXRBLCBwb3NCLCBxdWF0QikgewogICAgICBjb25zdCBodWxsQSA9IHRoaXM7CiAgICAgIENvbnZleFBvbHloZWRyb24ucHJvamVjdChodWxsQSwgYXhpcywgcG9zQSwgcXVhdEEsIG1heG1pbkEpOwogICAgICBDb252ZXhQb2x5aGVkcm9uLnByb2plY3QoaHVsbEIsIGF4aXMsIHBvc0IsIHF1YXRCLCBtYXhtaW5CKTsKICAgICAgY29uc3QgbWF4QSA9IG1heG1pbkFbMF07CiAgICAgIGNvbnN0IG1pbkEgPSBtYXhtaW5BWzFdOwogICAgICBjb25zdCBtYXhCID0gbWF4bWluQlswXTsKICAgICAgY29uc3QgbWluQiA9IG1heG1pbkJbMV07CgogICAgICBpZiAobWF4QSA8IG1pbkIgfHwgbWF4QiA8IG1pbkEpIHsKICAgICAgICByZXR1cm4gZmFsc2U7IC8vIFNlcGFyYXRlZAogICAgICB9CgogICAgICBjb25zdCBkMCA9IG1heEEgLSBtaW5COwogICAgICBjb25zdCBkMSA9IG1heEIgLSBtaW5BOwogICAgICBjb25zdCBkZXB0aCA9IGQwIDwgZDEgPyBkMCA6IGQxOwogICAgICByZXR1cm4gZGVwdGg7CiAgICB9CiAgICAvKioKICAgICAqIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYQogICAgICovCgoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgLy8gQXBwcm94aW1hdGUgd2l0aCBib3ggaW5lcnRpYQogICAgICAvLyBFeGFjdCBpbmVydGlhIGNhbGN1bGF0aW9uIGlzIG92ZXJraWxsLCBidXQgc2VlIGh0dHA6Ly9nZW9tZXRyaWN0b29scy5jb20vRG9jdW1lbnRhdGlvbi9Qb2x5aGVkcmFsTWFzc1Byb3BlcnRpZXMucGRmIGZvciB0aGUgY29ycmVjdCB3YXkgdG8gZG8gaXQKICAgICAgY29uc3QgYWFiYm1heCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGFhYmJtaW4gPSBuZXcgVmVjMygpOwogICAgICB0aGlzLmNvbXB1dGVMb2NhbEFBQkIoYWFiYm1pbiwgYWFiYm1heCk7CiAgICAgIGNvbnN0IHggPSBhYWJibWF4LnggLSBhYWJibWluLng7CiAgICAgIGNvbnN0IHkgPSBhYWJibWF4LnkgLSBhYWJibWluLnk7CiAgICAgIGNvbnN0IHogPSBhYWJibWF4LnogLSBhYWJibWluLno7CiAgICAgIHRhcmdldC54ID0gMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIHkgKiAyICogeSArIDIgKiB6ICogMiAqIHopOwogICAgICB0YXJnZXQueSA9IDEuMCAvIDEyLjAgKiBtYXNzICogKDIgKiB4ICogMiAqIHggKyAyICogeiAqIDIgKiB6KTsKICAgICAgdGFyZ2V0LnogPSAxLjAgLyAxMi4wICogbWFzcyAqICgyICogeSAqIDIgKiB5ICsgMiAqIHggKiAyICogeCk7CiAgICB9CiAgICAvKioKICAgICAqIEBwYXJhbSBmYWNlX2kgSW5kZXggb2YgdGhlIGZhY2UKICAgICAqLwoKCiAgICBnZXRQbGFuZUNvbnN0YW50T2ZGYWNlKGZhY2VfaSkgewogICAgICBjb25zdCBmID0gdGhpcy5mYWNlc1tmYWNlX2ldOwogICAgICBjb25zdCBuID0gdGhpcy5mYWNlTm9ybWFsc1tmYWNlX2ldOwogICAgICBjb25zdCB2ID0gdGhpcy52ZXJ0aWNlc1tmWzBdXTsKICAgICAgY29uc3QgYyA9IC1uLmRvdCh2KTsKICAgICAgcmV0dXJuIGM7CiAgICB9CiAgICAvKioKICAgICAqIENsaXAgYSBmYWNlIGFnYWluc3QgYSBodWxsLgogICAgICogQHBhcmFtIHdvcmxkVmVydHNCMSBBbiBhcnJheSBvZiBWZWMzIHdpdGggdmVydGljZXMgaW4gdGhlIHdvcmxkIGZyYW1lLgogICAgICogQHBhcmFtIG1pbkRpc3QgRGlzdGFuY2UgY2xhbXBpbmcKICAgICAqIEBwYXJhbSBBcnJheSByZXN1bHQgQXJyYXkgdG8gc3RvcmUgcmVzdWx0aW5nIGNvbnRhY3QgcG9pbnRzIGluLiBXaWxsIGJlIG9iamVjdHMgd2l0aCBwcm9wZXJ0aWVzOiBwb2ludCwgZGVwdGgsIG5vcm1hbC4gVGhlc2UgYXJlIHJlcHJlc2VudGVkIGluIHdvcmxkIGNvb3JkaW5hdGVzLgogICAgICovCgoKICAgIGNsaXBGYWNlQWdhaW5zdEh1bGwoc2VwYXJhdGluZ05vcm1hbCwgcG9zQSwgcXVhdEEsIHdvcmxkVmVydHNCMSwgbWluRGlzdCwgbWF4RGlzdCwgcmVzdWx0KSB7CiAgICAgIGNvbnN0IGZhY2VBTm9ybWFsV1MgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBlZGdlMCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IFdvcmxkRWRnZTAgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCB3b3JsZFBsYW5lQW5vcm1hbDEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBwbGFuZU5vcm1hbFdTMSA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHdvcmxkQTEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBsb2NhbFBsYW5lTm9ybWFsID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcGxhbmVOb3JtYWxXUyA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGh1bGxBID0gdGhpczsKICAgICAgY29uc3Qgd29ybGRWZXJ0c0IyID0gW107CiAgICAgIGNvbnN0IHBWdHhJbiA9IHdvcmxkVmVydHNCMTsKICAgICAgY29uc3QgcFZ0eE91dCA9IHdvcmxkVmVydHNCMjsKICAgICAgbGV0IGNsb3Nlc3RGYWNlQSA9IC0xOwogICAgICBsZXQgZG1pbiA9IE51bWJlci5NQVhfVkFMVUU7IC8vIEZpbmQgdGhlIGZhY2Ugd2l0aCBub3JtYWwgY2xvc2VzdCB0byB0aGUgc2VwYXJhdGluZyBheGlzCgogICAgICBmb3IgKGxldCBmYWNlID0gMDsgZmFjZSA8IGh1bGxBLmZhY2VzLmxlbmd0aDsgZmFjZSsrKSB7CiAgICAgICAgZmFjZUFOb3JtYWxXUy5jb3B5KGh1bGxBLmZhY2VOb3JtYWxzW2ZhY2VdKTsKICAgICAgICBxdWF0QS52bXVsdChmYWNlQU5vcm1hbFdTLCBmYWNlQU5vcm1hbFdTKTsKICAgICAgICBjb25zdCBkID0gZmFjZUFOb3JtYWxXUy5kb3Qoc2VwYXJhdGluZ05vcm1hbCk7CgogICAgICAgIGlmIChkIDwgZG1pbikgewogICAgICAgICAgZG1pbiA9IGQ7CiAgICAgICAgICBjbG9zZXN0RmFjZUEgPSBmYWNlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGNsb3Nlc3RGYWNlQSA8IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gR2V0IHRoZSBmYWNlIGFuZCBjb25zdHJ1Y3QgY29ubmVjdGVkIGZhY2VzCgoKICAgICAgY29uc3QgcG9seUEgPSBodWxsQS5mYWNlc1tjbG9zZXN0RmFjZUFdOwogICAgICBwb2x5QS5jb25uZWN0ZWRGYWNlcyA9IFtdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBodWxsQS5mYWNlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaHVsbEEuZmFjZXNbaV0ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICgKICAgICAgICAgIC8qIFNoYXJpbmcgYSB2ZXJ0ZXgqLwogICAgICAgICAgcG9seUEuaW5kZXhPZihodWxsQS5mYWNlc1tpXVtqXSkgIT09IC0xICYmCiAgICAgICAgICAvKiBOb3QgdGhlIG9uZSB3ZSBhcmUgbG9va2luZyBmb3IgY29ubmVjdGlvbnMgZnJvbSAqLwogICAgICAgICAgaSAhPT0gY2xvc2VzdEZhY2VBICYmCiAgICAgICAgICAvKiBOb3QgYWxyZWFkeSBhZGRlZCAqLwogICAgICAgICAgcG9seUEuY29ubmVjdGVkRmFjZXMuaW5kZXhPZihpKSA9PT0gLTEpIHsKICAgICAgICAgICAgcG9seUEuY29ubmVjdGVkRmFjZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gLy8gQ2xpcCB0aGUgcG9seWdvbiB0byB0aGUgYmFjayBvZiB0aGUgcGxhbmVzIG9mIGFsbCBmYWNlcyBvZiBodWxsIEEsCiAgICAgIC8vIHRoYXQgYXJlIGFkamFjZW50IHRvIHRoZSB3aXRuZXNzIGZhY2UKCgogICAgICBjb25zdCBudW1WZXJ0aWNlc0EgPSBwb2x5QS5sZW5ndGg7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVZlcnRpY2VzQTsgaSsrKSB7CiAgICAgICAgY29uc3QgYSA9IGh1bGxBLnZlcnRpY2VzW3BvbHlBW2ldXTsKICAgICAgICBjb25zdCBiID0gaHVsbEEudmVydGljZXNbcG9seUFbKGkgKyAxKSAlIG51bVZlcnRpY2VzQV1dOwogICAgICAgIGEudnN1YihiLCBlZGdlMCk7CiAgICAgICAgV29ybGRFZGdlMC5jb3B5KGVkZ2UwKTsKICAgICAgICBxdWF0QS52bXVsdChXb3JsZEVkZ2UwLCBXb3JsZEVkZ2UwKTsKICAgICAgICBwb3NBLnZhZGQoV29ybGRFZGdlMCwgV29ybGRFZGdlMCk7CiAgICAgICAgd29ybGRQbGFuZUFub3JtYWwxLmNvcHkodGhpcy5mYWNlTm9ybWFsc1tjbG9zZXN0RmFjZUFdKTsKICAgICAgICBxdWF0QS52bXVsdCh3b3JsZFBsYW5lQW5vcm1hbDEsIHdvcmxkUGxhbmVBbm9ybWFsMSk7CiAgICAgICAgcG9zQS52YWRkKHdvcmxkUGxhbmVBbm9ybWFsMSwgd29ybGRQbGFuZUFub3JtYWwxKTsKICAgICAgICBXb3JsZEVkZ2UwLmNyb3NzKHdvcmxkUGxhbmVBbm9ybWFsMSwgcGxhbmVOb3JtYWxXUzEpOwogICAgICAgIHBsYW5lTm9ybWFsV1MxLm5lZ2F0ZShwbGFuZU5vcm1hbFdTMSk7CiAgICAgICAgd29ybGRBMS5jb3B5KGEpOwogICAgICAgIHF1YXRBLnZtdWx0KHdvcmxkQTEsIHdvcmxkQTEpOwogICAgICAgIHBvc0EudmFkZCh3b3JsZEExLCB3b3JsZEExKTsKICAgICAgICBjb25zdCBvdGhlckZhY2UgPSBwb2x5QS5jb25uZWN0ZWRGYWNlc1tpXTsKICAgICAgICBsb2NhbFBsYW5lTm9ybWFsLmNvcHkodGhpcy5mYWNlTm9ybWFsc1tvdGhlckZhY2VdKTsKICAgICAgICBjb25zdCBsb2NhbFBsYW5lRXEgPSB0aGlzLmdldFBsYW5lQ29uc3RhbnRPZkZhY2Uob3RoZXJGYWNlKTsKICAgICAgICBwbGFuZU5vcm1hbFdTLmNvcHkobG9jYWxQbGFuZU5vcm1hbCk7CiAgICAgICAgcXVhdEEudm11bHQocGxhbmVOb3JtYWxXUywgcGxhbmVOb3JtYWxXUyk7CiAgICAgICAgY29uc3QgcGxhbmVFcVdTID0gbG9jYWxQbGFuZUVxIC0gcGxhbmVOb3JtYWxXUy5kb3QocG9zQSk7IC8vIENsaXAgZmFjZSBhZ2FpbnN0IG91ciBjb25zdHJ1Y3RlZCBwbGFuZQoKICAgICAgICB0aGlzLmNsaXBGYWNlQWdhaW5zdFBsYW5lKHBWdHhJbiwgcFZ0eE91dCwgcGxhbmVOb3JtYWxXUywgcGxhbmVFcVdTKTsgLy8gVGhyb3cgYXdheSBhbGwgY2xpcHBlZCBwb2ludHMsIGJ1dCBzYXZlIHRoZSByZW1haW5pbmcgdW50aWwgbmV4dCBjbGlwCgogICAgICAgIHdoaWxlIChwVnR4SW4ubGVuZ3RoKSB7CiAgICAgICAgICBwVnR4SW4uc2hpZnQoKTsKICAgICAgICB9CgogICAgICAgIHdoaWxlIChwVnR4T3V0Lmxlbmd0aCkgewogICAgICAgICAgcFZ0eEluLnB1c2gocFZ0eE91dC5zaGlmdCgpKTsKICAgICAgICB9CiAgICAgIH0gLy8gb25seSBrZWVwIGNvbnRhY3QgcG9pbnRzIHRoYXQgYXJlIGJlaGluZCB0aGUgd2l0bmVzcyBmYWNlCgoKICAgICAgbG9jYWxQbGFuZU5vcm1hbC5jb3B5KHRoaXMuZmFjZU5vcm1hbHNbY2xvc2VzdEZhY2VBXSk7CiAgICAgIGNvbnN0IGxvY2FsUGxhbmVFcSA9IHRoaXMuZ2V0UGxhbmVDb25zdGFudE9mRmFjZShjbG9zZXN0RmFjZUEpOwogICAgICBwbGFuZU5vcm1hbFdTLmNvcHkobG9jYWxQbGFuZU5vcm1hbCk7CiAgICAgIHF1YXRBLnZtdWx0KHBsYW5lTm9ybWFsV1MsIHBsYW5lTm9ybWFsV1MpOwogICAgICBjb25zdCBwbGFuZUVxV1MgPSBsb2NhbFBsYW5lRXEgLSBwbGFuZU5vcm1hbFdTLmRvdChwb3NBKTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcFZ0eEluLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGRlcHRoID0gcGxhbmVOb3JtYWxXUy5kb3QocFZ0eEluW2ldKSArIHBsYW5lRXFXUzsgLy8gPz8/CgogICAgICAgIGlmIChkZXB0aCA8PSBtaW5EaXN0KSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiY2xhbXBlZDogZGVwdGg9IiArIGRlcHRoICsgIiB0byBtaW5EaXN0PSIgKyBtaW5EaXN0KTsKICAgICAgICAgIGRlcHRoID0gbWluRGlzdDsKICAgICAgICB9CgogICAgICAgIGlmIChkZXB0aCA8PSBtYXhEaXN0KSB7CiAgICAgICAgICBjb25zdCBwb2ludCA9IHBWdHhJbltpXTsKCiAgICAgICAgICBpZiAoZGVwdGggPD0gMWUtNikgewogICAgICAgICAgICBjb25zdCBwID0gewogICAgICAgICAgICAgIHBvaW50LAogICAgICAgICAgICAgIG5vcm1hbDogcGxhbmVOb3JtYWxXUywKICAgICAgICAgICAgICBkZXB0aAogICAgICAgICAgICB9OwogICAgICAgICAgICByZXN1bHQucHVzaChwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2xpcCBhIGZhY2UgaW4gYSBodWxsIGFnYWluc3QgdGhlIGJhY2sgb2YgYSBwbGFuZS4KICAgICAqIEBwYXJhbSBwbGFuZUNvbnN0YW50IFRoZSBjb25zdGFudCBpbiB0aGUgbWF0aGVtYXRpY2FsIHBsYW5lIGVxdWF0aW9uCiAgICAgKi8KCgogICAgY2xpcEZhY2VBZ2FpbnN0UGxhbmUoaW5WZXJ0aWNlcywgb3V0VmVydGljZXMsIHBsYW5lTm9ybWFsLCBwbGFuZUNvbnN0YW50KSB7CiAgICAgIGxldCBuX2RvdF9maXJzdDsKICAgICAgbGV0IG5fZG90X2xhc3Q7CiAgICAgIGNvbnN0IG51bVZlcnRzID0gaW5WZXJ0aWNlcy5sZW5ndGg7CgogICAgICBpZiAobnVtVmVydHMgPCAyKSB7CiAgICAgICAgcmV0dXJuIG91dFZlcnRpY2VzOwogICAgICB9CgogICAgICBsZXQgZmlyc3RWZXJ0ZXggPSBpblZlcnRpY2VzW2luVmVydGljZXMubGVuZ3RoIC0gMV07CiAgICAgIGxldCBsYXN0VmVydGV4ID0gaW5WZXJ0aWNlc1swXTsKICAgICAgbl9kb3RfZmlyc3QgPSBwbGFuZU5vcm1hbC5kb3QoZmlyc3RWZXJ0ZXgpICsgcGxhbmVDb25zdGFudDsKCiAgICAgIGZvciAobGV0IHZpID0gMDsgdmkgPCBudW1WZXJ0czsgdmkrKykgewogICAgICAgIGxhc3RWZXJ0ZXggPSBpblZlcnRpY2VzW3ZpXTsKICAgICAgICBuX2RvdF9sYXN0ID0gcGxhbmVOb3JtYWwuZG90KGxhc3RWZXJ0ZXgpICsgcGxhbmVDb25zdGFudDsKCiAgICAgICAgaWYgKG5fZG90X2ZpcnN0IDwgMCkgewogICAgICAgICAgaWYgKG5fZG90X2xhc3QgPCAwKSB7CiAgICAgICAgICAgIC8vIFN0YXJ0IDwgMCwgZW5kIDwgMCwgc28gb3V0cHV0IGxhc3RWZXJ0ZXgKICAgICAgICAgICAgY29uc3QgbmV3diA9IG5ldyBWZWMzKCk7CiAgICAgICAgICAgIG5ld3YuY29weShsYXN0VmVydGV4KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChuZXd2KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFN0YXJ0IDwgMCwgZW5kID49IDAsIHNvIG91dHB1dCBpbnRlcnNlY3Rpb24KICAgICAgICAgICAgY29uc3QgbmV3diA9IG5ldyBWZWMzKCk7CiAgICAgICAgICAgIGZpcnN0VmVydGV4LmxlcnAobGFzdFZlcnRleCwgbl9kb3RfZmlyc3QgLyAobl9kb3RfZmlyc3QgLSBuX2RvdF9sYXN0KSwgbmV3dik7CiAgICAgICAgICAgIG91dFZlcnRpY2VzLnB1c2gobmV3dik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChuX2RvdF9sYXN0IDwgMCkgewogICAgICAgICAgICAvLyBTdGFydCA+PSAwLCBlbmQgPCAwIHNvIG91dHB1dCBpbnRlcnNlY3Rpb24gYW5kIGVuZAogICAgICAgICAgICBjb25zdCBuZXd2ID0gbmV3IFZlYzMoKTsKICAgICAgICAgICAgZmlyc3RWZXJ0ZXgubGVycChsYXN0VmVydGV4LCBuX2RvdF9maXJzdCAvIChuX2RvdF9maXJzdCAtIG5fZG90X2xhc3QpLCBuZXd2KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChuZXd2KTsKICAgICAgICAgICAgb3V0VmVydGljZXMucHVzaChsYXN0VmVydGV4KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZpcnN0VmVydGV4ID0gbGFzdFZlcnRleDsKICAgICAgICBuX2RvdF9maXJzdCA9IG5fZG90X2xhc3Q7CiAgICAgIH0KCiAgICAgIHJldHVybiBvdXRWZXJ0aWNlczsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyBgLndvcmxkVmVydGljZXNgIGFuZCBzZXRzIGAud29ybGRWZXJ0aWNlc05lZWRzVXBkYXRlYCB0byBmYWxzZS4KICAgICAqLwoKCiAgICBjb21wdXRlV29ybGRWZXJ0aWNlcyhwb3NpdGlvbiwgcXVhdCkgewogICAgICB3aGlsZSAodGhpcy53b3JsZFZlcnRpY2VzLmxlbmd0aCA8IHRoaXMudmVydGljZXMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy53b3JsZFZlcnRpY2VzLnB1c2gobmV3IFZlYzMoKSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsKICAgICAgY29uc3Qgd29ybGRWZXJ0cyA9IHRoaXMud29ybGRWZXJ0aWNlczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSB0aGlzLnZlcnRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcXVhdC52bXVsdCh2ZXJ0c1tpXSwgd29ybGRWZXJ0c1tpXSk7CiAgICAgICAgcG9zaXRpb24udmFkZCh3b3JsZFZlcnRzW2ldLCB3b3JsZFZlcnRzW2ldKTsKICAgICAgfQoKICAgICAgdGhpcy53b3JsZFZlcnRpY2VzTmVlZHNVcGRhdGUgPSBmYWxzZTsKICAgIH0KCiAgICBjb21wdXRlTG9jYWxBQUJCKGFhYmJtaW4sIGFhYmJtYXgpIHsKICAgICAgY29uc3QgdmVydGljZXMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBhYWJibWluLnNldChOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFLCBOdW1iZXIuTUFYX1ZBTFVFKTsKICAgICAgYWFiYm1heC5zZXQoLU51bWJlci5NQVhfVkFMVUUsIC1OdW1iZXIuTUFYX1ZBTFVFLCAtTnVtYmVyLk1BWF9WQUxVRSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmVydGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gdmVydGljZXNbaV07CgogICAgICAgIGlmICh2LnggPCBhYWJibWluLngpIHsKICAgICAgICAgIGFhYmJtaW4ueCA9IHYueDsKICAgICAgICB9IGVsc2UgaWYgKHYueCA+IGFhYmJtYXgueCkgewogICAgICAgICAgYWFiYm1heC54ID0gdi54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHYueSA8IGFhYmJtaW4ueSkgewogICAgICAgICAgYWFiYm1pbi55ID0gdi55OwogICAgICAgIH0gZWxzZSBpZiAodi55ID4gYWFiYm1heC55KSB7CiAgICAgICAgICBhYWJibWF4LnkgPSB2Lnk7CiAgICAgICAgfQoKICAgICAgICBpZiAodi56IDwgYWFiYm1pbi56KSB7CiAgICAgICAgICBhYWJibWluLnogPSB2Lno7CiAgICAgICAgfSBlbHNlIGlmICh2LnogPiBhYWJibWF4LnopIHsKICAgICAgICAgIGFhYmJtYXgueiA9IHYuejsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyBgd29ybGRWZXJ0aWNlc2AgYW5kIHNldHMgYHdvcmxkVmVydGljZXNOZWVkc1VwZGF0ZWAgdG8gZmFsc2UuCiAgICAgKi8KCgogICAgY29tcHV0ZVdvcmxkRmFjZU5vcm1hbHMocXVhdCkgewogICAgICBjb25zdCBOID0gdGhpcy5mYWNlTm9ybWFscy5sZW5ndGg7CgogICAgICB3aGlsZSAodGhpcy53b3JsZEZhY2VOb3JtYWxzLmxlbmd0aCA8IE4pIHsKICAgICAgICB0aGlzLndvcmxkRmFjZU5vcm1hbHMucHVzaChuZXcgVmVjMygpKTsKICAgICAgfQoKICAgICAgY29uc3Qgbm9ybWFscyA9IHRoaXMuZmFjZU5vcm1hbHM7CiAgICAgIGNvbnN0IHdvcmxkTm9ybWFscyA9IHRoaXMud29ybGRGYWNlTm9ybWFsczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBxdWF0LnZtdWx0KG5vcm1hbHNbaV0sIHdvcmxkTm9ybWFsc1tpXSk7CiAgICAgIH0KCiAgICAgIHRoaXMud29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzCiAgICAgKi8KCgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIC8vIEFzc3VtZSBwb2ludHMgYXJlIGRpc3RyaWJ1dGVkIHdpdGggbG9jYWwgKDAsMCwwKSBhcyBjZW50ZXIKICAgICAgbGV0IG1heDIgPSAwOwogICAgICBjb25zdCB2ZXJ0cyA9IHRoaXMudmVydGljZXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBub3JtMiA9IHZlcnRzW2ldLmxlbmd0aFNxdWFyZWQoKTsKCiAgICAgICAgaWYgKG5vcm0yID4gbWF4MikgewogICAgICAgICAgbWF4MiA9IG5vcm0yOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IE1hdGguc3FydChtYXgyKTsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlV29ybGRBQUJCCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgY29uc3QgdmVydHMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBsZXQgbWlueDsKICAgICAgbGV0IG1pbnk7CiAgICAgIGxldCBtaW56OwogICAgICBsZXQgbWF4eDsKICAgICAgbGV0IG1heHk7CiAgICAgIGxldCBtYXh6OwogICAgICBsZXQgdGVtcFdvcmxkVmVydGV4ID0gbmV3IFZlYzMoKTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0ZW1wV29ybGRWZXJ0ZXguY29weSh2ZXJ0c1tpXSk7CiAgICAgICAgcXVhdC52bXVsdCh0ZW1wV29ybGRWZXJ0ZXgsIHRlbXBXb3JsZFZlcnRleCk7CiAgICAgICAgcG9zLnZhZGQodGVtcFdvcmxkVmVydGV4LCB0ZW1wV29ybGRWZXJ0ZXgpOwogICAgICAgIGNvbnN0IHYgPSB0ZW1wV29ybGRWZXJ0ZXg7CgogICAgICAgIGlmIChtaW54ID09PSB1bmRlZmluZWQgfHwgdi54IDwgbWlueCkgewogICAgICAgICAgbWlueCA9IHYueDsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh4ID09PSB1bmRlZmluZWQgfHwgdi54ID4gbWF4eCkgewogICAgICAgICAgbWF4eCA9IHYueDsKICAgICAgICB9CgogICAgICAgIGlmIChtaW55ID09PSB1bmRlZmluZWQgfHwgdi55IDwgbWlueSkgewogICAgICAgICAgbWlueSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh5ID09PSB1bmRlZmluZWQgfHwgdi55ID4gbWF4eSkgewogICAgICAgICAgbWF4eSA9IHYueTsKICAgICAgICB9CgogICAgICAgIGlmIChtaW56ID09PSB1bmRlZmluZWQgfHwgdi56IDwgbWlueikgewogICAgICAgICAgbWlueiA9IHYuejsKICAgICAgICB9CgogICAgICAgIGlmIChtYXh6ID09PSB1bmRlZmluZWQgfHwgdi56ID4gbWF4eikgewogICAgICAgICAgbWF4eiA9IHYuejsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1pbi5zZXQobWlueCwgbWlueSwgbWlueik7CiAgICAgIG1heC5zZXQobWF4eCwgbWF4eSwgbWF4eik7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhcHByb3hpbWF0ZSBjb252ZXggdm9sdW1lCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICByZXR1cm4gNC4wICogTWF0aC5QSSAqIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgLyAzLjA7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbiBhdmVyYWdlIG9mIGFsbCB0aGUgdmVydGljZXMgcG9zaXRpb25zCiAgICAgKi8KCgogICAgZ2V0QXZlcmFnZVBvaW50TG9jYWwodGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0YXJnZXQudmFkZCh2ZXJ0c1tpXSwgdGFyZ2V0KTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnNjYWxlKDEgLyB2ZXJ0cy5sZW5ndGgsIHRhcmdldCk7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKioKICAgICAqIFRyYW5zZm9ybSBhbGwgbG9jYWwgcG9pbnRzLiBXaWxsIGNoYW5nZSB0aGUgLnZlcnRpY2VzCiAgICAgKi8KCgogICAgdHJhbnNmb3JtQWxsUG9pbnRzKG9mZnNldCwgcXVhdCkgewogICAgICBjb25zdCBuID0gdGhpcy52ZXJ0aWNlcy5sZW5ndGg7CiAgICAgIGNvbnN0IHZlcnRzID0gdGhpcy52ZXJ0aWNlczsgLy8gQXBwbHkgcm90YXRpb24KCiAgICAgIGlmIChxdWF0KSB7CiAgICAgICAgLy8gUm90YXRlIHZlcnRpY2VzCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHYgPSB2ZXJ0c1tpXTsKICAgICAgICAgIHF1YXQudm11bHQodiwgdik7CiAgICAgICAgfSAvLyBSb3RhdGUgZmFjZSBub3JtYWxzCgoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZmFjZU5vcm1hbHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHYgPSB0aGlzLmZhY2VOb3JtYWxzW2ldOwogICAgICAgICAgcXVhdC52bXVsdCh2LCB2KTsKICAgICAgICB9CiAgICAgICAgLyoKICAgICAgICAgICAgICAvLyBSb3RhdGUgZWRnZXMKICAgICAgICAgICAgICBmb3IobGV0IGk9MDsgaTx0aGlzLnVuaXF1ZUVkZ2VzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgY29uc3QgdiA9IHRoaXMudW5pcXVlRWRnZXNbaV07CiAgICAgICAgICAgICAgICAgIHF1YXQudm11bHQodix2KTsKICAgICAgICAgICAgICB9Ki8KCiAgICAgIH0gLy8gQXBwbHkgb2Zmc2V0CgoKICAgICAgaWYgKG9mZnNldCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICBjb25zdCB2ID0gdmVydHNbaV07CiAgICAgICAgICB2LnZhZGQob2Zmc2V0LCB2KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2tzIHdoZXRoZXIgcCBpcyBpbnNpZGUgdGhlIHBvbHloZWRyYS4gTXVzdCBiZSBpbiBsb2NhbCBjb29yZHMuCiAgICAgKiBUaGUgcG9pbnQgbGllcyBvdXRzaWRlIG9mIHRoZSBjb252ZXggaHVsbCBvZiB0aGUgb3RoZXIgcG9pbnRzIGlmIGFuZCBvbmx5IGlmIHRoZSBkaXJlY3Rpb24KICAgICAqIG9mIGFsbCB0aGUgdmVjdG9ycyBmcm9tIGl0IHRvIHRob3NlIG90aGVyIHBvaW50cyBhcmUgb24gbGVzcyB0aGFuIG9uZSBoYWxmIG9mIGEgc3BoZXJlIGFyb3VuZCBpdC4KICAgICAqIEBwYXJhbSBwIEEgcG9pbnQgZ2l2ZW4gaW4gbG9jYWwgY29vcmRpbmF0ZXMKICAgICAqLwoKCiAgICBwb2ludElzSW5zaWRlKHApIHsKICAgICAgY29uc3QgdmVydHMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBjb25zdCBmYWNlcyA9IHRoaXMuZmFjZXM7CiAgICAgIGNvbnN0IG5vcm1hbHMgPSB0aGlzLmZhY2VOb3JtYWxzOwogICAgICBjb25zdCBwb2ludEluc2lkZSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuZ2V0QXZlcmFnZVBvaW50TG9jYWwocG9pbnRJbnNpZGUpOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmZhY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IG4gPSBub3JtYWxzW2ldOwogICAgICAgIGNvbnN0IHYgPSB2ZXJ0c1tmYWNlc1tpXVswXV07IC8vIFdlIG9ubHkgbmVlZCBvbmUgcG9pbnQgaW4gdGhlIGZhY2UKICAgICAgICAvLyBUaGlzIGRvdCBwcm9kdWN0IGRldGVybWluZXMgd2hpY2ggc2lkZSBvZiB0aGUgZWRnZSB0aGUgcG9pbnQgaXMKCiAgICAgICAgY29uc3QgdlRvUCA9IG5ldyBWZWMzKCk7CiAgICAgICAgcC52c3ViKHYsIHZUb1ApOwogICAgICAgIGNvbnN0IHIxID0gbi5kb3QodlRvUCk7CiAgICAgICAgY29uc3QgdlRvUG9pbnRJbnNpZGUgPSBuZXcgVmVjMygpOwogICAgICAgIHBvaW50SW5zaWRlLnZzdWIodiwgdlRvUG9pbnRJbnNpZGUpOwogICAgICAgIGNvbnN0IHIyID0gbi5kb3QodlRvUG9pbnRJbnNpZGUpOwoKICAgICAgICBpZiAocjEgPCAwICYmIHIyID4gMCB8fCByMSA+IDAgJiYgcjIgPCAwKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIEVuY291bnRlcmVkIHNvbWUgb3RoZXIgc2lnbi4gRXhpdC4KICAgICAgICB9CiAgICAgIH0gLy8gSWYgd2UgZ290IGhlcmUsIGFsbCBkb3QgcHJvZHVjdHMgd2VyZSBvZiB0aGUgc2FtZSBzaWduLgoKCiAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IG1heCBhbmQgbWluIGRvdCBwcm9kdWN0IG9mIGEgY29udmV4IGh1bGwgYXQgcG9zaXRpb24gKHBvcyxxdWF0KSBwcm9qZWN0ZWQgb250byBhbiBheGlzLgogICAgICogUmVzdWx0cyBhcmUgc2F2ZWQgaW4gdGhlIGFycmF5IG1heG1pbi4KICAgICAqIEBwYXJhbSByZXN1bHQgcmVzdWx0WzBdIGFuZCByZXN1bHRbMV0gd2lsbCBiZSBzZXQgdG8gbWF4aW11bSBhbmQgbWluaW11bSwgcmVzcGVjdGl2ZWx5LgogICAgICovCgoKICAgIHN0YXRpYyBwcm9qZWN0KHNoYXBlLCBheGlzLCBwb3MsIHF1YXQsIHJlc3VsdCkgewogICAgICBjb25zdCBuID0gc2hhcGUudmVydGljZXMubGVuZ3RoOwogICAgICBjb25zdCBsb2NhbEF4aXMgPSBwcm9qZWN0X2xvY2FsQXhpczsKICAgICAgbGV0IG1heCA9IDA7CiAgICAgIGxldCBtaW4gPSAwOwogICAgICBjb25zdCBsb2NhbE9yaWdpbiA9IHByb2plY3RfbG9jYWxPcmlnaW47CiAgICAgIGNvbnN0IHZzID0gc2hhcGUudmVydGljZXM7CiAgICAgIGxvY2FsT3JpZ2luLnNldFplcm8oKTsgLy8gVHJhbnNmb3JtIHRoZSBheGlzIHRvIGxvY2FsCgogICAgICBUcmFuc2Zvcm0udmVjdG9yVG9Mb2NhbEZyYW1lKHBvcywgcXVhdCwgYXhpcywgbG9jYWxBeGlzKTsKICAgICAgVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKHBvcywgcXVhdCwgbG9jYWxPcmlnaW4sIGxvY2FsT3JpZ2luKTsKICAgICAgY29uc3QgYWRkID0gbG9jYWxPcmlnaW4uZG90KGxvY2FsQXhpcyk7CiAgICAgIG1pbiA9IG1heCA9IHZzWzBdLmRvdChsb2NhbEF4aXMpOwoKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBuOyBpKyspIHsKICAgICAgICBjb25zdCB2YWwgPSB2c1tpXS5kb3QobG9jYWxBeGlzKTsKCiAgICAgICAgaWYgKHZhbCA+IG1heCkgewogICAgICAgICAgbWF4ID0gdmFsOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbCA8IG1pbikgewogICAgICAgICAgbWluID0gdmFsOwogICAgICAgIH0KICAgICAgfQoKICAgICAgbWluIC09IGFkZDsKICAgICAgbWF4IC09IGFkZDsKCiAgICAgIGlmIChtaW4gPiBtYXgpIHsKICAgICAgICAvLyBJbmNvbnNpc3RlbnQgLSBzd2FwCiAgICAgICAgY29uc3QgdGVtcCA9IG1pbjsKICAgICAgICBtaW4gPSBtYXg7CiAgICAgICAgbWF4ID0gdGVtcDsKICAgICAgfSAvLyBPdXRwdXQKCgogICAgICByZXN1bHRbMF0gPSBtYXg7CiAgICAgIHJlc3VsdFsxXSA9IG1pbjsKICAgIH0KCiAgfQoKICBjb25zdCBtYXhtaW5BID0gW107CiAgY29uc3QgbWF4bWluQiA9IFtdOwogIGNvbnN0IHByb2plY3RfbG9jYWxBeGlzID0gbmV3IFZlYzMoKTsKICBjb25zdCBwcm9qZWN0X2xvY2FsT3JpZ2luID0gbmV3IFZlYzMoKTsKICAvKioKICAgKiBBIDNkIGJveCBzaGFwZS4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBzaXplID0gMQogICAqICAgICBjb25zdCBoYWxmRXh0ZW50cyA9IG5ldyBDQU5OT04uVmVjMyhzaXplLCBzaXplLCBzaXplKQogICAqICAgICBjb25zdCBib3hTaGFwZSA9IG5ldyBDQU5OT04uQm94KGhhbGZFeHRlbnRzKQogICAqICAgICBjb25zdCBib3hCb2R5ID0gbmV3IENBTk5PTi5Cb2R5KHsgbWFzczogMSwgc2hhcGU6IGJveFNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm94Qm9keSkKICAgKi8KCiAgY2xhc3MgQm94IGV4dGVuZHMgU2hhcGUgewogICAgLyoqCiAgICAgKiBUaGUgaGFsZiBleHRlbnRzIG9mIHRoZSBib3guCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZWQgYnkgdGhlIGNvbnRhY3QgZ2VuZXJhdG9yIHRvIG1ha2UgY29udGFjdHMgd2l0aCBvdGhlciBjb252ZXggcG9seWhlZHJhIGZvciBleGFtcGxlLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihoYWxmRXh0ZW50cykgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuQk9YCiAgICAgIH0pOwogICAgICB0aGlzLmhhbGZFeHRlbnRzID0gdm9pZCAwOwogICAgICB0aGlzLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5oYWxmRXh0ZW50cyA9IGhhbGZFeHRlbnRzOwogICAgICB0aGlzLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiA9IG51bGw7CiAgICAgIHRoaXMudXBkYXRlQ29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsKICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlcyB0aGUgbG9jYWwgY29udmV4IHBvbHloZWRyb24gcmVwcmVzZW50YXRpb24gdXNlZCBmb3Igc29tZSBjb2xsaXNpb25zLgogICAgICovCgoKICAgIHVwZGF0ZUNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbigpIHsKICAgICAgY29uc3Qgc3ggPSB0aGlzLmhhbGZFeHRlbnRzLng7CiAgICAgIGNvbnN0IHN5ID0gdGhpcy5oYWxmRXh0ZW50cy55OwogICAgICBjb25zdCBzeiA9IHRoaXMuaGFsZkV4dGVudHMuejsKICAgICAgY29uc3QgViA9IFZlYzM7CiAgICAgIGNvbnN0IHZlcnRpY2VzID0gW25ldyBWKC1zeCwgLXN5LCAtc3opLCBuZXcgVihzeCwgLXN5LCAtc3opLCBuZXcgVihzeCwgc3ksIC1zeiksIG5ldyBWKC1zeCwgc3ksIC1zeiksIG5ldyBWKC1zeCwgLXN5LCBzeiksIG5ldyBWKHN4LCAtc3ksIHN6KSwgbmV3IFYoc3gsIHN5LCBzeiksIG5ldyBWKC1zeCwgc3ksIHN6KV07CiAgICAgIGNvbnN0IGZhY2VzID0gW1szLCAyLCAxLCAwXSwgLy8gLXoKICAgICAgWzQsIDUsIDYsIDddLCAvLyAregogICAgICBbNSwgNCwgMCwgMV0sIC8vIC15CiAgICAgIFsyLCAzLCA3LCA2XSwgLy8gK3kKICAgICAgWzAsIDQsIDcsIDNdLCAvLyAteAogICAgICBbMSwgMiwgNiwgNV0gLy8gK3gKICAgICAgXTsKICAgICAgY29uc3QgYXhlcyA9IFtuZXcgVigwLCAwLCAxKSwgbmV3IFYoMCwgMSwgMCksIG5ldyBWKDEsIDAsIDApXTsKICAgICAgY29uc3QgaCA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKHsKICAgICAgICB2ZXJ0aWNlcywKICAgICAgICBmYWNlcywKICAgICAgICBheGVzCiAgICAgIH0pOwogICAgICB0aGlzLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiA9IGg7CiAgICAgIGgubWF0ZXJpYWwgPSB0aGlzLm1hdGVyaWFsOwogICAgfQogICAgLyoqCiAgICAgKiBDYWxjdWxhdGUgdGhlIGluZXJ0aWEgb2YgdGhlIGJveC4KICAgICAqLwoKCiAgICBjYWxjdWxhdGVMb2NhbEluZXJ0aWEobWFzcywgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIEJveC5jYWxjdWxhdGVJbmVydGlhKHRoaXMuaGFsZkV4dGVudHMsIG1hc3MsIHRhcmdldCk7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CgogICAgc3RhdGljIGNhbGN1bGF0ZUluZXJ0aWEoaGFsZkV4dGVudHMsIG1hc3MsIHRhcmdldCkgewogICAgICBjb25zdCBlID0gaGFsZkV4dGVudHM7CiAgICAgIHRhcmdldC54ID0gMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIGUueSAqIDIgKiBlLnkgKyAyICogZS56ICogMiAqIGUueik7CiAgICAgIHRhcmdldC55ID0gMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIGUueCAqIDIgKiBlLnggKyAyICogZS56ICogMiAqIGUueik7CiAgICAgIHRhcmdldC56ID0gMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIGUueSAqIDIgKiBlLnkgKyAyICogZS54ICogMiAqIGUueCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgYm94IDYgc2lkZSBub3JtYWxzCiAgICAgKiBAcGFyYW0gc2l4VGFyZ2V0VmVjdG9ycyBBbiBhcnJheSBvZiA2IHZlY3RvcnMsIHRvIHN0b3JlIHRoZSByZXN1bHRpbmcgc2lkZSBub3JtYWxzIGluLgogICAgICogQHBhcmFtIHF1YXQgT3JpZW50YXRpb24gdG8gYXBwbHkgdG8gdGhlIG5vcm1hbCB2ZWN0b3JzLiBJZiBub3QgcHJvdmlkZWQsIHRoZSB2ZWN0b3JzIHdpbGwgYmUgaW4gcmVzcGVjdCB0byB0aGUgbG9jYWwgZnJhbWUuCiAgICAgKi8KCgogICAgZ2V0U2lkZU5vcm1hbHMoc2l4VGFyZ2V0VmVjdG9ycywgcXVhdCkgewogICAgICBjb25zdCBzaWRlcyA9IHNpeFRhcmdldFZlY3RvcnM7CiAgICAgIGNvbnN0IGV4ID0gdGhpcy5oYWxmRXh0ZW50czsKICAgICAgc2lkZXNbMF0uc2V0KGV4LngsIDAsIDApOwogICAgICBzaWRlc1sxXS5zZXQoMCwgZXgueSwgMCk7CiAgICAgIHNpZGVzWzJdLnNldCgwLCAwLCBleC56KTsKICAgICAgc2lkZXNbM10uc2V0KC1leC54LCAwLCAwKTsKICAgICAgc2lkZXNbNF0uc2V0KDAsIC1leC55LCAwKTsKICAgICAgc2lkZXNbNV0uc2V0KDAsIDAsIC1leC56KTsKCiAgICAgIGlmIChxdWF0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gc2lkZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHF1YXQudm11bHQoc2lkZXNbaV0sIHNpZGVzW2ldKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBzaWRlczsKICAgIH0KICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdm9sdW1lIG9mIHRoZSBib3guCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICByZXR1cm4gOC4wICogdGhpcy5oYWxmRXh0ZW50cy54ICogdGhpcy5oYWxmRXh0ZW50cy55ICogdGhpcy5oYWxmRXh0ZW50cy56OwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cwogICAgICovCgoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gdGhpcy5oYWxmRXh0ZW50cy5sZW5ndGgoKTsKICAgIH0KICAgIC8qKgogICAgICogZm9yRWFjaFdvcmxkQ29ybmVyCiAgICAgKi8KCgogICAgZm9yRWFjaFdvcmxkQ29ybmVyKHBvcywgcXVhdCwgY2FsbGJhY2spIHsKICAgICAgY29uc3QgZSA9IHRoaXMuaGFsZkV4dGVudHM7CiAgICAgIGNvbnN0IGNvcm5lcnMgPSBbW2UueCwgZS55LCBlLnpdLCBbLWUueCwgZS55LCBlLnpdLCBbLWUueCwgLWUueSwgZS56XSwgWy1lLngsIC1lLnksIC1lLnpdLCBbZS54LCAtZS55LCAtZS56XSwgW2UueCwgZS55LCAtZS56XSwgWy1lLngsIGUueSwgLWUuel0sIFtlLngsIC1lLnksIGUuel1dOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3JuZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgd29ybGRDb3JuZXJUZW1wUG9zLnNldChjb3JuZXJzW2ldWzBdLCBjb3JuZXJzW2ldWzFdLCBjb3JuZXJzW2ldWzJdKTsKICAgICAgICBxdWF0LnZtdWx0KHdvcmxkQ29ybmVyVGVtcFBvcywgd29ybGRDb3JuZXJUZW1wUG9zKTsKICAgICAgICBwb3MudmFkZCh3b3JsZENvcm5lclRlbXBQb3MsIHdvcmxkQ29ybmVyVGVtcFBvcyk7CiAgICAgICAgY2FsbGJhY2sod29ybGRDb3JuZXJUZW1wUG9zLngsIHdvcmxkQ29ybmVyVGVtcFBvcy55LCB3b3JsZENvcm5lclRlbXBQb3Mueik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlV29ybGRBQUJCCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgY29uc3QgZSA9IHRoaXMuaGFsZkV4dGVudHM7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbMF0uc2V0KGUueCwgZS55LCBlLnopOwogICAgICB3b3JsZENvcm5lcnNUZW1wWzFdLnNldCgtZS54LCBlLnksIGUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbMl0uc2V0KC1lLngsIC1lLnksIGUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbM10uc2V0KC1lLngsIC1lLnksIC1lLnopOwogICAgICB3b3JsZENvcm5lcnNUZW1wWzRdLnNldChlLngsIC1lLnksIC1lLnopOwogICAgICB3b3JsZENvcm5lcnNUZW1wWzVdLnNldChlLngsIGUueSwgLWUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbNl0uc2V0KC1lLngsIGUueSwgLWUueik7CiAgICAgIHdvcmxkQ29ybmVyc1RlbXBbN10uc2V0KGUueCwgLWUueSwgZS56KTsKICAgICAgY29uc3Qgd2MgPSB3b3JsZENvcm5lcnNUZW1wWzBdOwogICAgICBxdWF0LnZtdWx0KHdjLCB3Yyk7CiAgICAgIHBvcy52YWRkKHdjLCB3Yyk7CiAgICAgIG1heC5jb3B5KHdjKTsKICAgICAgbWluLmNvcHkod2MpOwoKICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCA4OyBpKyspIHsKICAgICAgICBjb25zdCB3YyA9IHdvcmxkQ29ybmVyc1RlbXBbaV07CiAgICAgICAgcXVhdC52bXVsdCh3Yywgd2MpOwogICAgICAgIHBvcy52YWRkKHdjLCB3Yyk7CiAgICAgICAgY29uc3QgeCA9IHdjLng7CiAgICAgICAgY29uc3QgeSA9IHdjLnk7CiAgICAgICAgY29uc3QgeiA9IHdjLno7CgogICAgICAgIGlmICh4ID4gbWF4LngpIHsKICAgICAgICAgIG1heC54ID0geDsKICAgICAgICB9CgogICAgICAgIGlmICh5ID4gbWF4LnkpIHsKICAgICAgICAgIG1heC55ID0geTsKICAgICAgICB9CgogICAgICAgIGlmICh6ID4gbWF4LnopIHsKICAgICAgICAgIG1heC56ID0gejsKICAgICAgICB9CgogICAgICAgIGlmICh4IDwgbWluLngpIHsKICAgICAgICAgIG1pbi54ID0geDsKICAgICAgICB9CgogICAgICAgIGlmICh5IDwgbWluLnkpIHsKICAgICAgICAgIG1pbi55ID0geTsKICAgICAgICB9CgogICAgICAgIGlmICh6IDwgbWluLnopIHsKICAgICAgICAgIG1pbi56ID0gejsKICAgICAgICB9CiAgICAgIH0gLy8gR2V0IGVhY2ggYXhpcyBtYXgKICAgICAgLy8gbWluLnNldChJbmZpbml0eSxJbmZpbml0eSxJbmZpbml0eSk7CiAgICAgIC8vIG1heC5zZXQoLUluZmluaXR5LC1JbmZpbml0eSwtSW5maW5pdHkpOwogICAgICAvLyB0aGlzLmZvckVhY2hXb3JsZENvcm5lcihwb3MscXVhdCxmdW5jdGlvbih4LHkseil7CiAgICAgIC8vICAgICBpZih4ID4gbWF4LngpewogICAgICAvLyAgICAgICAgIG1heC54ID0geDsKICAgICAgLy8gICAgIH0KICAgICAgLy8gICAgIGlmKHkgPiBtYXgueSl7CiAgICAgIC8vICAgICAgICAgbWF4LnkgPSB5OwogICAgICAvLyAgICAgfQogICAgICAvLyAgICAgaWYoeiA+IG1heC56KXsKICAgICAgLy8gICAgICAgICBtYXgueiA9IHo7CiAgICAgIC8vICAgICB9CiAgICAgIC8vICAgICBpZih4IDwgbWluLngpewogICAgICAvLyAgICAgICAgIG1pbi54ID0geDsKICAgICAgLy8gICAgIH0KICAgICAgLy8gICAgIGlmKHkgPCBtaW4ueSl7CiAgICAgIC8vICAgICAgICAgbWluLnkgPSB5OwogICAgICAvLyAgICAgfQogICAgICAvLyAgICAgaWYoeiA8IG1pbi56KXsKICAgICAgLy8gICAgICAgICBtaW4ueiA9IHo7CiAgICAgIC8vICAgICB9CiAgICAgIC8vIH0pOwoKICAgIH0KCiAgfQoKICBjb25zdCB3b3JsZENvcm5lclRlbXBQb3MgPSBuZXcgVmVjMygpOwogIGNvbnN0IHdvcmxkQ29ybmVyc1RlbXAgPSBbbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKSwgbmV3IFZlYzMoKV07CiAgLyoqCiAgICogQk9EWV9UWVBFUwogICAqLwoKICBjb25zdCBCT0RZX1RZUEVTID0gewogICAgLyoqIERZTkFNSUMgKi8KICAgIERZTkFNSUM6IDEsCgogICAgLyoqIFNUQVRJQyAqLwogICAgU1RBVElDOiAyLAoKICAgIC8qKiBLSU5FTUFUSUMgKi8KICAgIEtJTkVNQVRJQzogNAogIH07CiAgLyoqCiAgICogQm9keVR5cGUKICAgKi8KCiAgLyoqCiAgICogQk9EWV9TTEVFUF9TVEFURVMKICAgKi8KCiAgY29uc3QgQk9EWV9TTEVFUF9TVEFURVMgPSB7CiAgICAvKiogQVdBS0UgKi8KICAgIEFXQUtFOiAwLAoKICAgIC8qKiBTTEVFUFkgKi8KICAgIFNMRUVQWTogMSwKCiAgICAvKiogU0xFRVBJTkcgKi8KICAgIFNMRUVQSU5HOiAyCiAgfTsKICAvKioKICAgKiBCb2R5U2xlZXBTdGF0ZQogICAqLwoKICAvKioKICAgKiBCYXNlIGNsYXNzIGZvciBhbGwgYm9keSB0eXBlcy4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBzaGFwZSA9IG5ldyBDQU5OT04uU3BoZXJlKDEpCiAgICogICAgIGNvbnN0IGJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoewogICAqICAgICAgIG1hc3M6IDEsCiAgICogICAgICAgc2hhcGUsCiAgICogICAgIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoYm9keSkKICAgKi8KCiAgY2xhc3MgQm9keSBleHRlbmRzIEV2ZW50VGFyZ2V0IHsKICAgIC8qKgogICAgICogRGlzcGF0Y2hlZCBhZnRlciB0d28gYm9kaWVzIGNvbGxpZGUuIFRoaXMgZXZlbnQgaXMgZGlzcGF0Y2hlZCBvbiBlYWNoCiAgICAgKiBvZiB0aGUgdHdvIGJvZGllcyBpbnZvbHZlZCBpbiB0aGUgY29sbGlzaW9uLgogICAgICogQGV2ZW50IGNvbGxpZGUKICAgICAqIEBwYXJhbSBib2R5IFRoZSBib2R5IHRoYXQgd2FzIGludm9sdmVkIGluIHRoZSBjb2xsaXNpb24uCiAgICAgKiBAcGFyYW0gY29udGFjdCBUaGUgZGV0YWlscyBvZiB0aGUgY29sbGlzaW9uLgogICAgICovCgogICAgLyoqCiAgICAgKiBBIGR5bmFtaWMgYm9keSBpcyBmdWxseSBzaW11bGF0ZWQuIENhbiBiZSBtb3ZlZCBtYW51YWxseSBieSB0aGUgdXNlciwgYnV0IG5vcm1hbGx5IHRoZXkgbW92ZSBhY2NvcmRpbmcgdG8gZm9yY2VzLiBBIGR5bmFtaWMgYm9keSBjYW4gY29sbGlkZSB3aXRoIGFsbCBib2R5IHR5cGVzLiBBIGR5bmFtaWMgYm9keSBhbHdheXMgaGFzIGZpbml0ZSwgbm9uLXplcm8gbWFzcy4KICAgICAqLwoKICAgIC8qKgogICAgICogQSBzdGF0aWMgYm9keSBkb2VzIG5vdCBtb3ZlIGR1cmluZyBzaW11bGF0aW9uIGFuZCBiZWhhdmVzIGFzIGlmIGl0IGhhcyBpbmZpbml0ZSBtYXNzLiBTdGF0aWMgYm9kaWVzIGNhbiBiZSBtb3ZlZCBtYW51YWxseSBieSBzZXR0aW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgYm9keS4gVGhlIHZlbG9jaXR5IG9mIGEgc3RhdGljIGJvZHkgaXMgYWx3YXlzIHplcm8uIFN0YXRpYyBib2RpZXMgZG8gbm90IGNvbGxpZGUgd2l0aCBvdGhlciBzdGF0aWMgb3Iga2luZW1hdGljIGJvZGllcy4KICAgICAqLwoKICAgIC8qKgogICAgICogQSBraW5lbWF0aWMgYm9keSBtb3ZlcyB1bmRlciBzaW11bGF0aW9uIGFjY29yZGluZyB0byBpdHMgdmVsb2NpdHkuIFRoZXkgZG8gbm90IHJlc3BvbmQgdG8gZm9yY2VzLiBUaGV5IGNhbiBiZSBtb3ZlZCBtYW51YWxseSwgYnV0IG5vcm1hbGx5IGEga2luZW1hdGljIGJvZHkgaXMgbW92ZWQgYnkgc2V0dGluZyBpdHMgdmVsb2NpdHkuIEEga2luZW1hdGljIGJvZHkgYmVoYXZlcyBhcyBpZiBpdCBoYXMgaW5maW5pdGUgbWFzcy4gS2luZW1hdGljIGJvZGllcyBkbyBub3QgY29sbGlkZSB3aXRoIG90aGVyIHN0YXRpYyBvciBraW5lbWF0aWMgYm9kaWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBBV0FLRQogICAgICovCgogICAgLyoqCiAgICAgKiBTTEVFUFkKICAgICAqLwoKICAgIC8qKgogICAgICogU0xFRVBJTkcKICAgICAqLwoKICAgIC8qKgogICAgICogRGlzcGF0Y2hlZCBhZnRlciBhIHNsZWVwaW5nIGJvZHkgaGFzIHdva2VuIHVwLgogICAgICogQGV2ZW50IHdha2V1cAogICAgICovCgogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVkIGFmdGVyIGEgYm9keSBoYXMgZ29uZSBpbiB0byB0aGUgc2xlZXB5IHN0YXRlLgogICAgICogQGV2ZW50IHNsZWVweQogICAgICovCgogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVkIGFmdGVyIGEgYm9keSBoYXMgZmFsbGVuIGFzbGVlcC4KICAgICAqIEBldmVudCBzbGVlcAogICAgICovCgogICAgLyoqCiAgICAgKiBJZGVudGlmaWVyIG9mIHRoZSBib2R5LgogICAgICovCgogICAgLyoqCiAgICAgKiBQb3NpdGlvbiBvZiBib2R5IGluIFdvcmxkLmJvZGllcy4gVXBkYXRlZCBieSBXb3JsZCBhbmQgdXNlZCBpbiBBcnJheUNvbGxpc2lvbk1hdHJpeC4KICAgICAqLwoKICAgIC8qKgogICAgICogUmVmZXJlbmNlIHRvIHRoZSB3b3JsZCB0aGUgYm9keSBpcyBsaXZpbmcgaW4uCiAgICAgKi8KCiAgICAvKioKICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgaXMgdXNlZCBCRUZPUkUgc3RlcHBpbmcgdGhlIHN5c3RlbS4gVXNlIGl0IHRvIGFwcGx5IGZvcmNlcywgZm9yIGV4YW1wbGUuIEluc2lkZSB0aGUgZnVuY3Rpb24sICJ0aGlzIiB3aWxsIHJlZmVyIHRvIHRoaXMgQm9keSBvYmplY3QuIERlcHJlY2F0ZWQgLSB1c2UgV29ybGQgZXZlbnRzIGluc3RlYWQuCiAgICAgKiBAZGVwcmVjYXRlZCBVc2UgV29ybGQgZXZlbnRzIGluc3RlYWQKICAgICAqLwoKICAgIC8qKgogICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyB1c2VkIEFGVEVSIHN0ZXBwaW5nIHRoZSBzeXN0ZW0uIEluc2lkZSB0aGUgZnVuY3Rpb24sICJ0aGlzIiB3aWxsIHJlZmVyIHRvIHRoaXMgQm9keSBvYmplY3QuIERlcHJlY2F0ZWQgLSB1c2UgV29ybGQgZXZlbnRzIGluc3RlYWQuCiAgICAgKiBAZGVwcmVjYXRlZCBVc2UgV29ybGQgZXZlbnRzIGluc3RlYWQKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGNvbGxpc2lvbiBncm91cCB0aGUgYm9keSBiZWxvbmdzIHRvLgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgY29sbGlzaW9uIGdyb3VwIHRoZSBib2R5IGNhbiBjb2xsaWRlIHdpdGguCiAgICAgKiBAZGVmYXVsdCAtMQogICAgICovCgogICAgLyoqCiAgICAgKiBXaGV0aGVyIHRvIHByb2R1Y2UgY29udGFjdCBmb3JjZXMgd2hlbiBpbiBjb250YWN0IHdpdGggb3RoZXIgYm9kaWVzLiBOb3RlIHRoYXQgY29udGFjdHMgd2lsbCBiZSBnZW5lcmF0ZWQsIGJ1dCB0aGV5IHdpbGwgYmUgZGlzYWJsZWQgLSBpLmUuICJjb2xsaWRlIiBldmVudHMgd2lsbCBiZSByYWlzZWQsIGJ1dCBmb3JjZXMgd2lsbCBub3QgYmUgYWx0ZXJlZC4KICAgICAqLwoKICAgIC8qKgogICAgICogV29ybGQgc3BhY2UgcG9zaXRpb24gb2YgdGhlIGJvZHkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEludGVycG9sYXRlZCBwb3NpdGlvbiBvZiB0aGUgYm9keS4KICAgICAqLwoKICAgIC8qKgogICAgICogSW5pdGlhbCBwb3NpdGlvbiBvZiB0aGUgYm9keS4KICAgICAqLwoKICAgIC8qKgogICAgICogV29ybGQgc3BhY2UgdmVsb2NpdHkgb2YgdGhlIGJvZHkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEluaXRpYWwgdmVsb2NpdHkgb2YgdGhlIGJvZHkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIExpbmVhciBmb3JjZSBvbiB0aGUgYm9keSBpbiB3b3JsZCBzcGFjZS4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIG1hc3Mgb2YgdGhlIGJvZHkuCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBwaHlzaWNzIG1hdGVyaWFsIG9mIHRoZSBib2R5LiBJdCBkZWZpbmVzIHRoZSBib2R5IGludGVyYWN0aW9uIHdpdGggb3RoZXIgYm9kaWVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBIb3cgbXVjaCB0byBkYW1wIHRoZSBib2R5IHZlbG9jaXR5IGVhY2ggc3RlcC4gSXQgY2FuIGdvIGZyb20gMCB0byAxLgogICAgICogQGRlZmF1bHQgMC4wMQogICAgICovCgogICAgLyoqCiAgICAgKiBPbmUgb2Y6IGBCb2R5LkRZTkFNSUNgLCBgQm9keS5TVEFUSUNgIGFuZCBgQm9keS5LSU5FTUFUSUNgLgogICAgICovCgogICAgLyoqCiAgICAgKiBJZiB0cnVlLCB0aGUgYm9keSB3aWxsIGF1dG9tYXRpY2FsbHkgZmFsbCB0byBzbGVlcC4KICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogQ3VycmVudCBzbGVlcCBzdGF0ZS4KICAgICAqLwoKICAgIC8qKgogICAgICogSWYgdGhlIHNwZWVkICh0aGUgbm9ybSBvZiB0aGUgdmVsb2NpdHkpIGlzIHNtYWxsZXIgdGhhbiB0aGlzIHZhbHVlLCB0aGUgYm9keSBpcyBjb25zaWRlcmVkIHNsZWVweS4KICAgICAqIEBkZWZhdWx0IDAuMQogICAgICovCgogICAgLyoqCiAgICAgKiBJZiB0aGUgYm9keSBoYXMgYmVlbiBzbGVlcHkgZm9yIHRoaXMgc2xlZXBUaW1lTGltaXQgc2Vjb25kcywgaXQgaXMgY29uc2lkZXJlZCBzbGVlcGluZy4KICAgICAqIEBkZWZhdWx0IDEKICAgICAqLwoKICAgIC8qKgogICAgICogV29ybGQgc3BhY2Ugcm90YXRpb25hbCBmb3JjZSBvbiB0aGUgYm9keSwgYXJvdW5kIGNlbnRlciBvZiBtYXNzLgogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZCBzcGFjZSBvcmllbnRhdGlvbiBvZiB0aGUgYm9keS4KICAgICAqLwoKICAgIC8qKgogICAgICogSW5pdGlhbCBxdWF0ZXJuaW9uIG9mIHRoZSBib2R5LgogICAgICovCgogICAgLyoqCiAgICAgKiBJbnRlcnBvbGF0ZWQgb3JpZW50YXRpb24gb2YgdGhlIGJvZHkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFuZ3VsYXIgdmVsb2NpdHkgb2YgdGhlIGJvZHksIGluIHdvcmxkIHNwYWNlLiBUaGluayBvZiB0aGUgYW5ndWxhciB2ZWxvY2l0eSBhcyBhIHZlY3Rvciwgd2hpY2ggdGhlIGJvZHkgcm90YXRlcyBhcm91bmQuIFRoZSBsZW5ndGggb2YgdGhpcyB2ZWN0b3IgZGV0ZXJtaW5lcyBob3cgZmFzdCAoaW4gcmFkaWFucyBwZXIgc2Vjb25kKSB0aGUgYm9keSByb3RhdGVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBJbml0aWFsIGFuZ3VsYXIgdmVsb2NpdHkgb2YgdGhlIGJvZHkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIExpc3Qgb2YgU2hhcGVzIHRoYXQgaGF2ZSBiZWVuIGFkZGVkIHRvIHRoZSBib2R5LgogICAgICovCgogICAgLyoqCiAgICAgKiBQb3NpdGlvbiBvZiBlYWNoIFNoYXBlIGluIHRoZSBib2R5LCBnaXZlbiBpbiBsb2NhbCBCb2R5IHNwYWNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBPcmllbnRhdGlvbiBvZiBlYWNoIFNoYXBlLCBnaXZlbiBpbiBsb2NhbCBCb2R5IHNwYWNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgaW5lcnRpYSBvZiB0aGUgYm9keS4KICAgICAqLwoKICAgIC8qKgogICAgICogU2V0IHRvIHRydWUgaWYgeW91IGRvbid0IHdhbnQgdGhlIGJvZHkgdG8gcm90YXRlLiBNYWtlIHN1cmUgdG8gcnVuIC51cGRhdGVNYXNzUHJvcGVydGllcygpIGlmIHlvdSBjaGFuZ2UgdGhpcyBhZnRlciB0aGUgYm9keSBjcmVhdGlvbi4KICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIEhvdyBtdWNoIHRvIGRhbXAgdGhlIGJvZHkgYW5ndWxhciB2ZWxvY2l0eSBlYWNoIHN0ZXAuIEl0IGNhbiBnbyBmcm9tIDAgdG8gMS4KICAgICAqIEBkZWZhdWx0IDAuMDEKICAgICAqLwoKICAgIC8qKgogICAgICogVXNlIHRoaXMgcHJvcGVydHkgdG8gbGltaXQgdGhlIG1vdGlvbiBhbG9uZyBhbnkgd29ybGQgYXhpcy4gKDEsMSwxKSB3aWxsIGFsbG93IG1vdGlvbiBhbG9uZyBhbGwgYXhlcyB3aGlsZSAoMCwwLDApIGFsbG93cyBub25lLgogICAgICovCgogICAgLyoqCiAgICAgKiBVc2UgdGhpcyBwcm9wZXJ0eSB0byBsaW1pdCB0aGUgcm90YXRpb25hbCBtb3Rpb24gYWxvbmcgYW55IHdvcmxkIGF4aXMuICgxLDEsMSkgd2lsbCBhbGxvdyByb3RhdGlvbiBhbG9uZyBhbGwgYXhlcyB3aGlsZSAoMCwwLDApIGFsbG93cyBub25lLgogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZCBzcGFjZSBib3VuZGluZyBib3ggb2YgdGhlIGJvZHkgYW5kIGl0cyBzaGFwZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEluZGljYXRlcyBpZiB0aGUgQUFCQiBuZWVkcyB0byBiZSB1cGRhdGVkIGJlZm9yZSB1c2UuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRvdGFsIGJvdW5kaW5nIHJhZGl1cyBvZiB0aGUgQm9keSBpbmNsdWRpbmcgaXRzIHNoYXBlcywgcmVsYXRpdmUgdG8gYm9keS5wb3NpdGlvbi4KICAgICAqLwoKICAgIC8qKgogICAgICogV2hlbiB0cnVlIHRoZSBib2R5IGJlaGF2ZXMgbGlrZSBhIHRyaWdnZXIuIEl0IGRvZXMgbm90IGNvbGxpZGUKICAgICAqIHdpdGggb3RoZXIgYm9kaWVzIGJ1dCBjb2xsaXNpb24gZXZlbnRzIGFyZSBzdGlsbCB0cmlnZ2VyZWQuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMuaWQgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW5kZXggPSB2b2lkIDA7CiAgICAgIHRoaXMud29ybGQgPSB2b2lkIDA7CiAgICAgIHRoaXMucHJlU3RlcCA9IHZvaWQgMDsKICAgICAgdGhpcy5wb3N0U3RlcCA9IHZvaWQgMDsKICAgICAgdGhpcy52bGFtYmRhID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlckdyb3VwID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlck1hc2sgPSB2b2lkIDA7CiAgICAgIHRoaXMuY29sbGlzaW9uUmVzcG9uc2UgPSB2b2lkIDA7CiAgICAgIHRoaXMucG9zaXRpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMucHJldmlvdXNQb3NpdGlvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5pbnRlcnBvbGF0ZWRQb3NpdGlvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5pbml0UG9zaXRpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMudmVsb2NpdHkgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW5pdFZlbG9jaXR5ID0gdm9pZCAwOwogICAgICB0aGlzLmZvcmNlID0gdm9pZCAwOwogICAgICB0aGlzLm1hc3MgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW52TWFzcyA9IHZvaWQgMDsKICAgICAgdGhpcy5tYXRlcmlhbCA9IHZvaWQgMDsKICAgICAgdGhpcy5saW5lYXJEYW1waW5nID0gdm9pZCAwOwogICAgICB0aGlzLnR5cGUgPSB2b2lkIDA7CiAgICAgIHRoaXMuYWxsb3dTbGVlcCA9IHZvaWQgMDsKICAgICAgdGhpcy5zbGVlcFN0YXRlID0gdm9pZCAwOwogICAgICB0aGlzLnNsZWVwU3BlZWRMaW1pdCA9IHZvaWQgMDsKICAgICAgdGhpcy5zbGVlcFRpbWVMaW1pdCA9IHZvaWQgMDsKICAgICAgdGhpcy50aW1lTGFzdFNsZWVweSA9IHZvaWQgMDsKICAgICAgdGhpcy53YWtlVXBBZnRlck5hcnJvd3BoYXNlID0gdm9pZCAwOwogICAgICB0aGlzLnRvcnF1ZSA9IHZvaWQgMDsKICAgICAgdGhpcy5xdWF0ZXJuaW9uID0gdm9pZCAwOwogICAgICB0aGlzLmluaXRRdWF0ZXJuaW9uID0gdm9pZCAwOwogICAgICB0aGlzLnByZXZpb3VzUXVhdGVybmlvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5pbnRlcnBvbGF0ZWRRdWF0ZXJuaW9uID0gdm9pZCAwOwogICAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IHZvaWQgMDsKICAgICAgdGhpcy5pbml0QW5ndWxhclZlbG9jaXR5ID0gdm9pZCAwOwogICAgICB0aGlzLnNoYXBlcyA9IHZvaWQgMDsKICAgICAgdGhpcy5zaGFwZU9mZnNldHMgPSB2b2lkIDA7CiAgICAgIHRoaXMuc2hhcGVPcmllbnRhdGlvbnMgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW5lcnRpYSA9IHZvaWQgMDsKICAgICAgdGhpcy5pbnZJbmVydGlhID0gdm9pZCAwOwogICAgICB0aGlzLmludkluZXJ0aWFXb3JsZCA9IHZvaWQgMDsKICAgICAgdGhpcy5pbnZNYXNzU29sdmUgPSB2b2lkIDA7CiAgICAgIHRoaXMuaW52SW5lcnRpYVNvbHZlID0gdm9pZCAwOwogICAgICB0aGlzLmludkluZXJ0aWFXb3JsZFNvbHZlID0gdm9pZCAwOwogICAgICB0aGlzLmZpeGVkUm90YXRpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMuYW5ndWxhckRhbXBpbmcgPSB2b2lkIDA7CiAgICAgIHRoaXMubGluZWFyRmFjdG9yID0gdm9pZCAwOwogICAgICB0aGlzLmFuZ3VsYXJGYWN0b3IgPSB2b2lkIDA7CiAgICAgIHRoaXMuYWFiYiA9IHZvaWQgMDsKICAgICAgdGhpcy5hYWJiTmVlZHNVcGRhdGUgPSB2b2lkIDA7CiAgICAgIHRoaXMuYm91bmRpbmdSYWRpdXMgPSB2b2lkIDA7CiAgICAgIHRoaXMud2xhbWJkYSA9IHZvaWQgMDsKICAgICAgdGhpcy5pc1RyaWdnZXIgPSB2b2lkIDA7CiAgICAgIHRoaXMuaWQgPSBCb2R5LmlkQ291bnRlcisrOwogICAgICB0aGlzLmluZGV4ID0gLTE7CiAgICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgICB0aGlzLnByZVN0ZXAgPSBudWxsOwogICAgICB0aGlzLnBvc3RTdGVwID0gbnVsbDsKICAgICAgdGhpcy52bGFtYmRhID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJHcm91cCA9IHR5cGVvZiBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwID09PSAnbnVtYmVyJyA/IG9wdGlvbnMuY29sbGlzaW9uRmlsdGVyR3JvdXAgOiAxOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlck1hc2sgPSB0eXBlb2Ygb3B0aW9ucy5jb2xsaXNpb25GaWx0ZXJNYXNrID09PSAnbnVtYmVyJyA/IG9wdGlvbnMuY29sbGlzaW9uRmlsdGVyTWFzayA6IC0xOwogICAgICB0aGlzLmNvbGxpc2lvblJlc3BvbnNlID0gdHlwZW9mIG9wdGlvbnMuY29sbGlzaW9uUmVzcG9uc2UgPT09ICdib29sZWFuJyA/IG9wdGlvbnMuY29sbGlzaW9uUmVzcG9uc2UgOiB0cnVlOwogICAgICB0aGlzLnBvc2l0aW9uID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5wcmV2aW91c1Bvc2l0aW9uID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5pbnRlcnBvbGF0ZWRQb3NpdGlvbiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaW5pdFBvc2l0aW9uID0gbmV3IFZlYzMoKTsKCiAgICAgIGlmIChvcHRpb25zLnBvc2l0aW9uKSB7CiAgICAgICAgdGhpcy5wb3NpdGlvbi5jb3B5KG9wdGlvbnMucG9zaXRpb24pOwogICAgICAgIHRoaXMucHJldmlvdXNQb3NpdGlvbi5jb3B5KG9wdGlvbnMucG9zaXRpb24pOwogICAgICAgIHRoaXMuaW50ZXJwb2xhdGVkUG9zaXRpb24uY29weShvcHRpb25zLnBvc2l0aW9uKTsKICAgICAgICB0aGlzLmluaXRQb3NpdGlvbi5jb3B5KG9wdGlvbnMucG9zaXRpb24pOwogICAgICB9CgogICAgICB0aGlzLnZlbG9jaXR5ID0gbmV3IFZlYzMoKTsKCiAgICAgIGlmIChvcHRpb25zLnZlbG9jaXR5KSB7CiAgICAgICAgdGhpcy52ZWxvY2l0eS5jb3B5KG9wdGlvbnMudmVsb2NpdHkpOwogICAgICB9CgogICAgICB0aGlzLmluaXRWZWxvY2l0eSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuZm9yY2UgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBtYXNzID0gdHlwZW9mIG9wdGlvbnMubWFzcyA9PT0gJ251bWJlcicgPyBvcHRpb25zLm1hc3MgOiAwOwogICAgICB0aGlzLm1hc3MgPSBtYXNzOwogICAgICB0aGlzLmludk1hc3MgPSBtYXNzID4gMCA/IDEuMCAvIG1hc3MgOiAwOwogICAgICB0aGlzLm1hdGVyaWFsID0gb3B0aW9ucy5tYXRlcmlhbCB8fCBudWxsOwogICAgICB0aGlzLmxpbmVhckRhbXBpbmcgPSB0eXBlb2Ygb3B0aW9ucy5saW5lYXJEYW1waW5nID09PSAnbnVtYmVyJyA/IG9wdGlvbnMubGluZWFyRGFtcGluZyA6IDAuMDE7CiAgICAgIHRoaXMudHlwZSA9IG1hc3MgPD0gMC4wID8gQm9keS5TVEFUSUMgOiBCb2R5LkRZTkFNSUM7CgogICAgICBpZiAodHlwZW9mIG9wdGlvbnMudHlwZSA9PT0gdHlwZW9mIEJvZHkuU1RBVElDKSB7CiAgICAgICAgdGhpcy50eXBlID0gb3B0aW9ucy50eXBlOwogICAgICB9CgogICAgICB0aGlzLmFsbG93U2xlZXAgPSB0eXBlb2Ygb3B0aW9ucy5hbGxvd1NsZWVwICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuYWxsb3dTbGVlcCA6IHRydWU7CiAgICAgIHRoaXMuc2xlZXBTdGF0ZSA9IEJvZHkuQVdBS0U7CiAgICAgIHRoaXMuc2xlZXBTcGVlZExpbWl0ID0gdHlwZW9mIG9wdGlvbnMuc2xlZXBTcGVlZExpbWl0ICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuc2xlZXBTcGVlZExpbWl0IDogMC4xOwogICAgICB0aGlzLnNsZWVwVGltZUxpbWl0ID0gdHlwZW9mIG9wdGlvbnMuc2xlZXBUaW1lTGltaXQgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5zbGVlcFRpbWVMaW1pdCA6IDE7CiAgICAgIHRoaXMudGltZUxhc3RTbGVlcHkgPSAwOwogICAgICB0aGlzLndha2VVcEFmdGVyTmFycm93cGhhc2UgPSBmYWxzZTsKICAgICAgdGhpcy50b3JxdWUgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICB0aGlzLmluaXRRdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgdGhpcy5wcmV2aW91c1F1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwogICAgICB0aGlzLmludGVycG9sYXRlZFF1YXRlcm5pb24gPSBuZXcgUXVhdGVybmlvbigpOwoKICAgICAgaWYgKG9wdGlvbnMucXVhdGVybmlvbikgewogICAgICAgIHRoaXMucXVhdGVybmlvbi5jb3B5KG9wdGlvbnMucXVhdGVybmlvbik7CiAgICAgICAgdGhpcy5pbml0UXVhdGVybmlvbi5jb3B5KG9wdGlvbnMucXVhdGVybmlvbik7CiAgICAgICAgdGhpcy5wcmV2aW91c1F1YXRlcm5pb24uY29weShvcHRpb25zLnF1YXRlcm5pb24pOwogICAgICAgIHRoaXMuaW50ZXJwb2xhdGVkUXVhdGVybmlvbi5jb3B5KG9wdGlvbnMucXVhdGVybmlvbik7CiAgICAgIH0KCiAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5ID0gbmV3IFZlYzMoKTsKCiAgICAgIGlmIChvcHRpb25zLmFuZ3VsYXJWZWxvY2l0eSkgewogICAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LmNvcHkob3B0aW9ucy5hbmd1bGFyVmVsb2NpdHkpOwogICAgICB9CgogICAgICB0aGlzLmluaXRBbmd1bGFyVmVsb2NpdHkgPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnNoYXBlcyA9IFtdOwogICAgICB0aGlzLnNoYXBlT2Zmc2V0cyA9IFtdOwogICAgICB0aGlzLnNoYXBlT3JpZW50YXRpb25zID0gW107CiAgICAgIHRoaXMuaW5lcnRpYSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaW52SW5lcnRpYSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaW52SW5lcnRpYVdvcmxkID0gbmV3IE1hdDMoKTsKICAgICAgdGhpcy5pbnZNYXNzU29sdmUgPSAwOwogICAgICB0aGlzLmludkluZXJ0aWFTb2x2ZSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaW52SW5lcnRpYVdvcmxkU29sdmUgPSBuZXcgTWF0MygpOwogICAgICB0aGlzLmZpeGVkUm90YXRpb24gPSB0eXBlb2Ygb3B0aW9ucy5maXhlZFJvdGF0aW9uICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuZml4ZWRSb3RhdGlvbiA6IGZhbHNlOwogICAgICB0aGlzLmFuZ3VsYXJEYW1waW5nID0gdHlwZW9mIG9wdGlvbnMuYW5ndWxhckRhbXBpbmcgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5hbmd1bGFyRGFtcGluZyA6IDAuMDE7CiAgICAgIHRoaXMubGluZWFyRmFjdG9yID0gbmV3IFZlYzMoMSwgMSwgMSk7CgogICAgICBpZiAob3B0aW9ucy5saW5lYXJGYWN0b3IpIHsKICAgICAgICB0aGlzLmxpbmVhckZhY3Rvci5jb3B5KG9wdGlvbnMubGluZWFyRmFjdG9yKTsKICAgICAgfQoKICAgICAgdGhpcy5hbmd1bGFyRmFjdG9yID0gbmV3IFZlYzMoMSwgMSwgMSk7CgogICAgICBpZiAob3B0aW9ucy5hbmd1bGFyRmFjdG9yKSB7CiAgICAgICAgdGhpcy5hbmd1bGFyRmFjdG9yLmNvcHkob3B0aW9ucy5hbmd1bGFyRmFjdG9yKTsKICAgICAgfQoKICAgICAgdGhpcy5hYWJiID0gbmV3IEFBQkIoKTsKICAgICAgdGhpcy5hYWJiTmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICB0aGlzLmJvdW5kaW5nUmFkaXVzID0gMDsKICAgICAgdGhpcy53bGFtYmRhID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5pc1RyaWdnZXIgPSBCb29sZWFuKG9wdGlvbnMuaXNUcmlnZ2VyKTsKCiAgICAgIGlmIChvcHRpb25zLnNoYXBlKSB7CiAgICAgICAgdGhpcy5hZGRTaGFwZShvcHRpb25zLnNoYXBlKTsKICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVNYXNzUHJvcGVydGllcygpOwogICAgfQogICAgLyoqCiAgICAgKiBXYWtlIHRoZSBib2R5IHVwLgogICAgICovCgoKICAgIHdha2VVcCgpIHsKICAgICAgY29uc3QgcHJldlN0YXRlID0gdGhpcy5zbGVlcFN0YXRlOwogICAgICB0aGlzLnNsZWVwU3RhdGUgPSBCb2R5LkFXQUtFOwogICAgICB0aGlzLndha2VVcEFmdGVyTmFycm93cGhhc2UgPSBmYWxzZTsKCiAgICAgIGlmIChwcmV2U3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoQm9keS53YWtldXBFdmVudCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogRm9yY2UgYm9keSBzbGVlcAogICAgICovCgoKICAgIHNsZWVwKCkgewogICAgICB0aGlzLnNsZWVwU3RhdGUgPSBCb2R5LlNMRUVQSU5HOwogICAgICB0aGlzLnZlbG9jaXR5LnNldCgwLCAwLCAwKTsKICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuc2V0KDAsIDAsIDApOwogICAgICB0aGlzLndha2VVcEFmdGVyTmFycm93cGhhc2UgPSBmYWxzZTsKICAgIH0KICAgIC8qKgogICAgICogQ2FsbGVkIGV2ZXJ5IHRpbWVzdGVwIHRvIHVwZGF0ZSBpbnRlcm5hbCBzbGVlcCB0aW1lciBhbmQgY2hhbmdlIHNsZWVwIHN0YXRlIGlmIG5lZWRlZC4KICAgICAqIEBwYXJhbSB0aW1lIFRoZSB3b3JsZCB0aW1lIGluIHNlY29uZHMKICAgICAqLwoKCiAgICBzbGVlcFRpY2sodGltZSkgewogICAgICBpZiAodGhpcy5hbGxvd1NsZWVwKSB7CiAgICAgICAgY29uc3Qgc2xlZXBTdGF0ZSA9IHRoaXMuc2xlZXBTdGF0ZTsKICAgICAgICBjb25zdCBzcGVlZFNxdWFyZWQgPSB0aGlzLnZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKSArIHRoaXMuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKTsKICAgICAgICBjb25zdCBzcGVlZExpbWl0U3F1YXJlZCA9IHRoaXMuc2xlZXBTcGVlZExpbWl0ICoqIDI7CgogICAgICAgIGlmIChzbGVlcFN0YXRlID09PSBCb2R5LkFXQUtFICYmIHNwZWVkU3F1YXJlZCA8IHNwZWVkTGltaXRTcXVhcmVkKSB7CiAgICAgICAgICB0aGlzLnNsZWVwU3RhdGUgPSBCb2R5LlNMRUVQWTsgLy8gU2xlZXB5CgogICAgICAgICAgdGhpcy50aW1lTGFzdFNsZWVweSA9IHRpbWU7CiAgICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoQm9keS5zbGVlcHlFdmVudCk7CiAgICAgICAgfSBlbHNlIGlmIChzbGVlcFN0YXRlID09PSBCb2R5LlNMRUVQWSAmJiBzcGVlZFNxdWFyZWQgPiBzcGVlZExpbWl0U3F1YXJlZCkgewogICAgICAgICAgdGhpcy53YWtlVXAoKTsgLy8gV2FrZSB1cAogICAgICAgIH0gZWxzZSBpZiAoc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUFkgJiYgdGltZSAtIHRoaXMudGltZUxhc3RTbGVlcHkgPiB0aGlzLnNsZWVwVGltZUxpbWl0KSB7CiAgICAgICAgICB0aGlzLnNsZWVwKCk7IC8vIFNsZWVwaW5nCgogICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KEJvZHkuc2xlZXBFdmVudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIElmIHRoZSBib2R5IGlzIHNsZWVwaW5nLCBpdCBzaG91bGQgYmUgaW1tb3ZhYmxlIC8gaGF2ZSBpbmZpbml0ZSBtYXNzIGR1cmluZyBzb2x2ZS4gV2Ugc29sdmUgaXQgYnkgaGF2aW5nIGEgc2VwYXJhdGUgInNvbHZlIG1hc3MiLgogICAgICovCgoKICAgIHVwZGF0ZVNvbHZlTWFzc1Byb3BlcnRpZXMoKSB7CiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcgfHwgdGhpcy50eXBlID09PSBCb2R5LktJTkVNQVRJQykgewogICAgICAgIHRoaXMuaW52TWFzc1NvbHZlID0gMDsKICAgICAgICB0aGlzLmludkluZXJ0aWFTb2x2ZS5zZXRaZXJvKCk7CiAgICAgICAgdGhpcy5pbnZJbmVydGlhV29ybGRTb2x2ZS5zZXRaZXJvKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pbnZNYXNzU29sdmUgPSB0aGlzLmludk1hc3M7CiAgICAgICAgdGhpcy5pbnZJbmVydGlhU29sdmUuY29weSh0aGlzLmludkluZXJ0aWEpOwogICAgICAgIHRoaXMuaW52SW5lcnRpYVdvcmxkU29sdmUuY29weSh0aGlzLmludkluZXJ0aWFXb3JsZCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ29udmVydCBhIHdvcmxkIHBvaW50IHRvIGxvY2FsIGJvZHkgZnJhbWUuCiAgICAgKi8KCgogICAgcG9pbnRUb0xvY2FsRnJhbWUod29ybGRQb2ludCwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHdvcmxkUG9pbnQudnN1Yih0aGlzLnBvc2l0aW9uLCByZXN1bHQpOwogICAgICB0aGlzLnF1YXRlcm5pb24uY29uanVnYXRlKCkudm11bHQocmVzdWx0LCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0IGEgd29ybGQgdmVjdG9yIHRvIGxvY2FsIGJvZHkgZnJhbWUuCiAgICAgKi8KCgogICAgdmVjdG9yVG9Mb2NhbEZyYW1lKHdvcmxkVmVjdG9yLCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgdGhpcy5xdWF0ZXJuaW9uLmNvbmp1Z2F0ZSgpLnZtdWx0KHdvcmxkVmVjdG9yLCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBDb252ZXJ0IGEgbG9jYWwgYm9keSBwb2ludCB0byB3b3JsZCBmcmFtZS4KICAgICAqLwoKCiAgICBwb2ludFRvV29ybGRGcmFtZShsb2NhbFBvaW50LCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgdGhpcy5xdWF0ZXJuaW9uLnZtdWx0KGxvY2FsUG9pbnQsIHJlc3VsdCk7CiAgICAgIHJlc3VsdC52YWRkKHRoaXMucG9zaXRpb24sIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIENvbnZlcnQgYSBsb2NhbCBib2R5IHBvaW50IHRvIHdvcmxkIGZyYW1lLgogICAgICovCgoKICAgIHZlY3RvclRvV29ybGRGcmFtZShsb2NhbFZlY3RvciwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgIHJlc3VsdCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMucXVhdGVybmlvbi52bXVsdChsb2NhbFZlY3RvciwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogQWRkIGEgc2hhcGUgdG8gdGhlIGJvZHkgd2l0aCBhIGxvY2FsIG9mZnNldCBhbmQgb3JpZW50YXRpb24uCiAgICAgKiBAcmV0dXJuIFRoZSBib2R5IG9iamVjdCwgZm9yIGNoYWluYWJpbGl0eS4KICAgICAqLwoKCiAgICBhZGRTaGFwZShzaGFwZSwgX29mZnNldCwgX29yaWVudGF0aW9uKSB7CiAgICAgIGNvbnN0IG9mZnNldCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gbmV3IFF1YXRlcm5pb24oKTsKCiAgICAgIGlmIChfb2Zmc2V0KSB7CiAgICAgICAgb2Zmc2V0LmNvcHkoX29mZnNldCk7CiAgICAgIH0KCiAgICAgIGlmIChfb3JpZW50YXRpb24pIHsKICAgICAgICBvcmllbnRhdGlvbi5jb3B5KF9vcmllbnRhdGlvbik7CiAgICAgIH0KCiAgICAgIHRoaXMuc2hhcGVzLnB1c2goc2hhcGUpOwogICAgICB0aGlzLnNoYXBlT2Zmc2V0cy5wdXNoKG9mZnNldCk7CiAgICAgIHRoaXMuc2hhcGVPcmllbnRhdGlvbnMucHVzaChvcmllbnRhdGlvbik7CiAgICAgIHRoaXMudXBkYXRlTWFzc1Byb3BlcnRpZXMoKTsKICAgICAgdGhpcy51cGRhdGVCb3VuZGluZ1JhZGl1cygpOwogICAgICB0aGlzLmFhYmJOZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgIHNoYXBlLmJvZHkgPSB0aGlzOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlIGEgc2hhcGUgZnJvbSB0aGUgYm9keS4KICAgICAqIEByZXR1cm4gVGhlIGJvZHkgb2JqZWN0LCBmb3IgY2hhaW5hYmlsaXR5LgogICAgICovCgoKICAgIHJlbW92ZVNoYXBlKHNoYXBlKSB7CiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5zaGFwZXMuaW5kZXhPZihzaGFwZSk7CgogICAgICBpZiAoaW5kZXggPT09IC0xKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdTaGFwZSBkb2VzIG5vdCBiZWxvbmcgdG8gdGhlIGJvZHknKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgdGhpcy5zaGFwZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgdGhpcy5zaGFwZU9mZnNldHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgdGhpcy5zaGFwZU9yaWVudGF0aW9ucy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB0aGlzLnVwZGF0ZU1hc3NQcm9wZXJ0aWVzKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdSYWRpdXMoKTsKICAgICAgdGhpcy5hYWJiTmVlZHNVcGRhdGUgPSB0cnVlOwogICAgICBzaGFwZS5ib2R5ID0gbnVsbDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSB0aGUgYm91bmRpbmcgcmFkaXVzIG9mIHRoZSBib2R5LiBTaG91bGQgYmUgZG9uZSBpZiBhbnkgb2YgdGhlIHNoYXBlcyBhcmUgY2hhbmdlZC4KICAgICAqLwoKCiAgICB1cGRhdGVCb3VuZGluZ1JhZGl1cygpIHsKICAgICAgY29uc3Qgc2hhcGVzID0gdGhpcy5zaGFwZXM7CiAgICAgIGNvbnN0IHNoYXBlT2Zmc2V0cyA9IHRoaXMuc2hhcGVPZmZzZXRzOwogICAgICBjb25zdCBOID0gc2hhcGVzLmxlbmd0aDsKICAgICAgbGV0IHJhZGl1cyA9IDA7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3Qgc2hhcGUgPSBzaGFwZXNbaV07CiAgICAgICAgc2hhcGUudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsKICAgICAgICBjb25zdCBvZmZzZXQgPSBzaGFwZU9mZnNldHNbaV0ubGVuZ3RoKCk7CiAgICAgICAgY29uc3QgciA9IHNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzOwoKICAgICAgICBpZiAob2Zmc2V0ICsgciA+IHJhZGl1cykgewogICAgICAgICAgcmFkaXVzID0gb2Zmc2V0ICsgcjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuYm91bmRpbmdSYWRpdXMgPSByYWRpdXM7CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZXMgdGhlIC5hYWJiCiAgICAgKi8KCgogICAgdXBkYXRlQUFCQigpIHsKICAgICAgY29uc3Qgc2hhcGVzID0gdGhpcy5zaGFwZXM7CiAgICAgIGNvbnN0IHNoYXBlT2Zmc2V0cyA9IHRoaXMuc2hhcGVPZmZzZXRzOwogICAgICBjb25zdCBzaGFwZU9yaWVudGF0aW9ucyA9IHRoaXMuc2hhcGVPcmllbnRhdGlvbnM7CiAgICAgIGNvbnN0IE4gPSBzaGFwZXMubGVuZ3RoOwogICAgICBjb25zdCBvZmZzZXQgPSB0bXBWZWM7CiAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gdG1wUXVhdDsKICAgICAgY29uc3QgYm9keVF1YXQgPSB0aGlzLnF1YXRlcm5pb247CiAgICAgIGNvbnN0IGFhYmIgPSB0aGlzLmFhYmI7CiAgICAgIGNvbnN0IHNoYXBlQUFCQiA9IHVwZGF0ZUFBQkJfc2hhcGVBQUJCOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IHNoYXBlID0gc2hhcGVzW2ldOyAvLyBHZXQgc2hhcGUgd29ybGQgcG9zaXRpb24KCiAgICAgICAgYm9keVF1YXQudm11bHQoc2hhcGVPZmZzZXRzW2ldLCBvZmZzZXQpOwogICAgICAgIG9mZnNldC52YWRkKHRoaXMucG9zaXRpb24sIG9mZnNldCk7IC8vIEdldCBzaGFwZSB3b3JsZCBxdWF0ZXJuaW9uCgogICAgICAgIGJvZHlRdWF0Lm11bHQoc2hhcGVPcmllbnRhdGlvbnNbaV0sIG9yaWVudGF0aW9uKTsgLy8gR2V0IHNoYXBlIEFBQkIKCiAgICAgICAgc2hhcGUuY2FsY3VsYXRlV29ybGRBQUJCKG9mZnNldCwgb3JpZW50YXRpb24sIHNoYXBlQUFCQi5sb3dlckJvdW5kLCBzaGFwZUFBQkIudXBwZXJCb3VuZCk7CgogICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICBhYWJiLmNvcHkoc2hhcGVBQUJCKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWFiYi5leHRlbmQoc2hhcGVBQUJCKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSBgLmluZXJ0aWFXb3JsZGAgYW5kIGAuaW52SW5lcnRpYVdvcmxkYAogICAgICovCgoKICAgIHVwZGF0ZUluZXJ0aWFXb3JsZChmb3JjZSkgewogICAgICBjb25zdCBJID0gdGhpcy5pbnZJbmVydGlhOwogICAgICBpZiAoSS54ID09PSBJLnkgJiYgSS55ID09PSBJLnogJiYgIWZvcmNlKSA7ZWxzZSB7CiAgICAgICAgY29uc3QgbTEgPSB1aXdfbTE7CiAgICAgICAgY29uc3QgbTIgPSB1aXdfbTI7CiAgICAgICAgbTEuc2V0Um90YXRpb25Gcm9tUXVhdGVybmlvbih0aGlzLnF1YXRlcm5pb24pOwogICAgICAgIG0xLnRyYW5zcG9zZShtMik7CiAgICAgICAgbTEuc2NhbGUoSSwgbTEpOwogICAgICAgIG0xLm1tdWx0KG0yLCB0aGlzLmludkluZXJ0aWFXb3JsZCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQXBwbHkgZm9yY2UgdG8gYSBwb2ludCBvZiB0aGUgYm9keS4gVGhpcyBjb3VsZCBmb3IgZXhhbXBsZSBiZSBhIHBvaW50IG9uIHRoZSBCb2R5IHN1cmZhY2UuCiAgICAgKiBBcHBseWluZyBmb3JjZSB0aGlzIHdheSB3aWxsIGFkZCB0byBCb2R5LmZvcmNlIGFuZCBCb2R5LnRvcnF1ZS4KICAgICAqIEBwYXJhbSBmb3JjZSBUaGUgYW1vdW50IG9mIGZvcmNlIHRvIGFkZC4KICAgICAqIEBwYXJhbSByZWxhdGl2ZVBvaW50IEEgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIGNlbnRlciBvZiBtYXNzIHRvIGFwcGx5IHRoZSBmb3JjZSBvbi4KICAgICAqLwoKCiAgICBhcHBseUZvcmNlKGZvcmNlLCByZWxhdGl2ZVBvaW50KSB7CiAgICAgIGlmIChyZWxhdGl2ZVBvaW50ID09PSB2b2lkIDApIHsKICAgICAgICByZWxhdGl2ZVBvaW50ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgLy8gTmVlZGVkPwogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIENvbXB1dGUgcHJvZHVjZWQgcm90YXRpb25hbCBmb3JjZQoKCiAgICAgIGNvbnN0IHJvdEZvcmNlID0gQm9keV9hcHBseUZvcmNlX3JvdEZvcmNlOwogICAgICByZWxhdGl2ZVBvaW50LmNyb3NzKGZvcmNlLCByb3RGb3JjZSk7IC8vIEFkZCBsaW5lYXIgZm9yY2UKCiAgICAgIHRoaXMuZm9yY2UudmFkZChmb3JjZSwgdGhpcy5mb3JjZSk7IC8vIEFkZCByb3RhdGlvbmFsIGZvcmNlCgogICAgICB0aGlzLnRvcnF1ZS52YWRkKHJvdEZvcmNlLCB0aGlzLnRvcnF1ZSk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IGZvcmNlIHRvIGEgbG9jYWwgcG9pbnQgaW4gdGhlIGJvZHkuCiAgICAgKiBAcGFyYW0gZm9yY2UgVGhlIGZvcmNlIHZlY3RvciB0byBhcHBseSwgZGVmaW5lZCBsb2NhbGx5IGluIHRoZSBib2R5IGZyYW1lLgogICAgICogQHBhcmFtIGxvY2FsUG9pbnQgQSBsb2NhbCBwb2ludCBpbiB0aGUgYm9keSB0byBhcHBseSB0aGUgZm9yY2Ugb24uCiAgICAgKi8KCgogICAgYXBwbHlMb2NhbEZvcmNlKGxvY2FsRm9yY2UsIGxvY2FsUG9pbnQpIHsKICAgICAgaWYgKGxvY2FsUG9pbnQgPT09IHZvaWQgMCkgewogICAgICAgIGxvY2FsUG9pbnQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHdvcmxkRm9yY2UgPSBCb2R5X2FwcGx5TG9jYWxGb3JjZV93b3JsZEZvcmNlOwogICAgICBjb25zdCByZWxhdGl2ZVBvaW50V29ybGQgPSBCb2R5X2FwcGx5TG9jYWxGb3JjZV9yZWxhdGl2ZVBvaW50V29ybGQ7IC8vIFRyYW5zZm9ybSB0aGUgZm9yY2UgdmVjdG9yIHRvIHdvcmxkIHNwYWNlCgogICAgICB0aGlzLnZlY3RvclRvV29ybGRGcmFtZShsb2NhbEZvcmNlLCB3b3JsZEZvcmNlKTsKICAgICAgdGhpcy52ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVsYXRpdmVQb2ludFdvcmxkKTsKICAgICAgdGhpcy5hcHBseUZvcmNlKHdvcmxkRm9yY2UsIHJlbGF0aXZlUG9pbnRXb3JsZCk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IHRvcnF1ZSB0byB0aGUgYm9keS4KICAgICAqIEBwYXJhbSB0b3JxdWUgVGhlIGFtb3VudCBvZiB0b3JxdWUgdG8gYWRkLgogICAgICovCgoKICAgIGFwcGx5VG9ycXVlKHRvcnF1ZSkgewogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIEFkZCByb3RhdGlvbmFsIGZvcmNlCgoKICAgICAgdGhpcy50b3JxdWUudmFkZCh0b3JxdWUsIHRoaXMudG9ycXVlKTsKICAgIH0KICAgIC8qKgogICAgICogQXBwbHkgaW1wdWxzZSB0byBhIHBvaW50IG9mIHRoZSBib2R5LiBUaGlzIGNvdWxkIGZvciBleGFtcGxlIGJlIGEgcG9pbnQgb24gdGhlIEJvZHkgc3VyZmFjZS4KICAgICAqIEFuIGltcHVsc2UgaXMgYSBmb3JjZSBhZGRlZCB0byBhIGJvZHkgZHVyaW5nIGEgc2hvcnQgcGVyaW9kIG9mIHRpbWUgKGltcHVsc2UgPSBmb3JjZSAqIHRpbWUpLgogICAgICogSW1wdWxzZXMgd2lsbCBiZSBhZGRlZCB0byBCb2R5LnZlbG9jaXR5IGFuZCBCb2R5LmFuZ3VsYXJWZWxvY2l0eS4KICAgICAqIEBwYXJhbSBpbXB1bHNlIFRoZSBhbW91bnQgb2YgaW1wdWxzZSB0byBhZGQuCiAgICAgKiBAcGFyYW0gcmVsYXRpdmVQb2ludCBBIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBjZW50ZXIgb2YgbWFzcyB0byBhcHBseSB0aGUgZm9yY2Ugb24uCiAgICAgKi8KCgogICAgYXBwbHlJbXB1bHNlKGltcHVsc2UsIHJlbGF0aXZlUG9pbnQpIHsKICAgICAgaWYgKHJlbGF0aXZlUG9pbnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbGF0aXZlUG9pbnQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBpZiAodGhpcy50eXBlICE9PSBCb2R5LkRZTkFNSUMpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsZWVwU3RhdGUgPT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICB0aGlzLndha2VVcCgpOwogICAgICB9IC8vIENvbXB1dGUgcG9pbnQgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIGJvZHkgY2VudGVyCgoKICAgICAgY29uc3QgciA9IHJlbGF0aXZlUG9pbnQ7IC8vIENvbXB1dGUgcHJvZHVjZWQgY2VudHJhbCBpbXB1bHNlIHZlbG9jaXR5CgogICAgICBjb25zdCB2ZWxvID0gQm9keV9hcHBseUltcHVsc2VfdmVsbzsKICAgICAgdmVsby5jb3B5KGltcHVsc2UpOwogICAgICB2ZWxvLnNjYWxlKHRoaXMuaW52TWFzcywgdmVsbyk7IC8vIEFkZCBsaW5lYXIgaW1wdWxzZQoKICAgICAgdGhpcy52ZWxvY2l0eS52YWRkKHZlbG8sIHRoaXMudmVsb2NpdHkpOyAvLyBDb21wdXRlIHByb2R1Y2VkIHJvdGF0aW9uYWwgaW1wdWxzZSB2ZWxvY2l0eQoKICAgICAgY29uc3Qgcm90VmVsbyA9IEJvZHlfYXBwbHlJbXB1bHNlX3JvdFZlbG87CiAgICAgIHIuY3Jvc3MoaW1wdWxzZSwgcm90VmVsbyk7CiAgICAgIC8qCiAgICAgICByb3RWZWxvLnggKj0gdGhpcy5pbnZJbmVydGlhLng7CiAgICAgICByb3RWZWxvLnkgKj0gdGhpcy5pbnZJbmVydGlhLnk7CiAgICAgICByb3RWZWxvLnogKj0gdGhpcy5pbnZJbmVydGlhLno7CiAgICAgICAqLwoKICAgICAgdGhpcy5pbnZJbmVydGlhV29ybGQudm11bHQocm90VmVsbywgcm90VmVsbyk7IC8vIEFkZCByb3RhdGlvbmFsIEltcHVsc2UKCiAgICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5LnZhZGQocm90VmVsbywgdGhpcy5hbmd1bGFyVmVsb2NpdHkpOwogICAgfQogICAgLyoqCiAgICAgKiBBcHBseSBsb2NhbGx5LWRlZmluZWQgaW1wdWxzZSB0byBhIGxvY2FsIHBvaW50IGluIHRoZSBib2R5LgogICAgICogQHBhcmFtIGZvcmNlIFRoZSBmb3JjZSB2ZWN0b3IgdG8gYXBwbHksIGRlZmluZWQgbG9jYWxseSBpbiB0aGUgYm9keSBmcmFtZS4KICAgICAqIEBwYXJhbSBsb2NhbFBvaW50IEEgbG9jYWwgcG9pbnQgaW4gdGhlIGJvZHkgdG8gYXBwbHkgdGhlIGZvcmNlIG9uLgogICAgICovCgoKICAgIGFwcGx5TG9jYWxJbXB1bHNlKGxvY2FsSW1wdWxzZSwgbG9jYWxQb2ludCkgewogICAgICBpZiAobG9jYWxQb2ludCA9PT0gdm9pZCAwKSB7CiAgICAgICAgbG9jYWxQb2ludCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnR5cGUgIT09IEJvZHkuRFlOQU1JQykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3Qgd29ybGRJbXB1bHNlID0gQm9keV9hcHBseUxvY2FsSW1wdWxzZV93b3JsZEltcHVsc2U7CiAgICAgIGNvbnN0IHJlbGF0aXZlUG9pbnRXb3JsZCA9IEJvZHlfYXBwbHlMb2NhbEltcHVsc2VfcmVsYXRpdmVQb2ludDsgLy8gVHJhbnNmb3JtIHRoZSBmb3JjZSB2ZWN0b3IgdG8gd29ybGQgc3BhY2UKCiAgICAgIHRoaXMudmVjdG9yVG9Xb3JsZEZyYW1lKGxvY2FsSW1wdWxzZSwgd29ybGRJbXB1bHNlKTsKICAgICAgdGhpcy52ZWN0b3JUb1dvcmxkRnJhbWUobG9jYWxQb2ludCwgcmVsYXRpdmVQb2ludFdvcmxkKTsKICAgICAgdGhpcy5hcHBseUltcHVsc2Uod29ybGRJbXB1bHNlLCByZWxhdGl2ZVBvaW50V29ybGQpOwogICAgfQogICAgLyoqCiAgICAgKiBTaG91bGQgYmUgY2FsbGVkIHdoZW5ldmVyIHlvdSBjaGFuZ2UgdGhlIGJvZHkgc2hhcGUgb3IgbWFzcy4KICAgICAqLwoKCiAgICB1cGRhdGVNYXNzUHJvcGVydGllcygpIHsKICAgICAgY29uc3QgaGFsZkV4dGVudHMgPSBCb2R5X3VwZGF0ZU1hc3NQcm9wZXJ0aWVzX2hhbGZFeHRlbnRzOwogICAgICB0aGlzLmludk1hc3MgPSB0aGlzLm1hc3MgPiAwID8gMS4wIC8gdGhpcy5tYXNzIDogMDsKICAgICAgY29uc3QgSSA9IHRoaXMuaW5lcnRpYTsKICAgICAgY29uc3QgZml4ZWQgPSB0aGlzLmZpeGVkUm90YXRpb247IC8vIEFwcHJveGltYXRlIHdpdGggQUFCQiBib3gKCiAgICAgIHRoaXMudXBkYXRlQUFCQigpOwogICAgICBoYWxmRXh0ZW50cy5zZXQoKHRoaXMuYWFiYi51cHBlckJvdW5kLnggLSB0aGlzLmFhYmIubG93ZXJCb3VuZC54KSAvIDIsICh0aGlzLmFhYmIudXBwZXJCb3VuZC55IC0gdGhpcy5hYWJiLmxvd2VyQm91bmQueSkgLyAyLCAodGhpcy5hYWJiLnVwcGVyQm91bmQueiAtIHRoaXMuYWFiYi5sb3dlckJvdW5kLnopIC8gMik7CiAgICAgIEJveC5jYWxjdWxhdGVJbmVydGlhKGhhbGZFeHRlbnRzLCB0aGlzLm1hc3MsIEkpOwogICAgICB0aGlzLmludkluZXJ0aWEuc2V0KEkueCA+IDAgJiYgIWZpeGVkID8gMS4wIC8gSS54IDogMCwgSS55ID4gMCAmJiAhZml4ZWQgPyAxLjAgLyBJLnkgOiAwLCBJLnogPiAwICYmICFmaXhlZCA/IDEuMCAvIEkueiA6IDApOwogICAgICB0aGlzLnVwZGF0ZUluZXJ0aWFXb3JsZCh0cnVlKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHdvcmxkIHZlbG9jaXR5IG9mIGEgcG9pbnQgaW4gdGhlIGJvZHkuCiAgICAgKiBAcGFyYW0gd29ybGRQb2ludAogICAgICogQHBhcmFtIHJlc3VsdAogICAgICogQHJldHVybiBUaGUgcmVzdWx0IHZlY3Rvci4KICAgICAqLwoKCiAgICBnZXRWZWxvY2l0eUF0V29ybGRQb2ludCh3b3JsZFBvaW50LCByZXN1bHQpIHsKICAgICAgY29uc3QgciA9IG5ldyBWZWMzKCk7CiAgICAgIHdvcmxkUG9pbnQudnN1Yih0aGlzLnBvc2l0aW9uLCByKTsKICAgICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MociwgcmVzdWx0KTsKICAgICAgdGhpcy52ZWxvY2l0eS52YWRkKHJlc3VsdCwgcmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIC8qKgogICAgICogTW92ZSB0aGUgYm9keSBmb3J3YXJkIGluIHRpbWUuCiAgICAgKiBAcGFyYW0gZHQgVGltZSBzdGVwCiAgICAgKiBAcGFyYW0gcXVhdE5vcm1hbGl6ZSBTZXQgdG8gdHJ1ZSB0byBub3JtYWxpemUgdGhlIGJvZHkgcXVhdGVybmlvbgogICAgICogQHBhcmFtIHF1YXROb3JtYWxpemVGYXN0IElmIHRoZSBxdWF0ZXJuaW9uIHNob3VsZCBiZSBub3JtYWxpemVkIHVzaW5nICJmYXN0IiBxdWF0ZXJuaW9uIG5vcm1hbGl6YXRpb24KICAgICAqLwoKCiAgICBpbnRlZ3JhdGUoZHQsIHF1YXROb3JtYWxpemUsIHF1YXROb3JtYWxpemVGYXN0KSB7CiAgICAgIC8vIFNhdmUgcHJldmlvdXMgcG9zaXRpb24KICAgICAgdGhpcy5wcmV2aW91c1Bvc2l0aW9uLmNvcHkodGhpcy5wb3NpdGlvbik7CiAgICAgIHRoaXMucHJldmlvdXNRdWF0ZXJuaW9uLmNvcHkodGhpcy5xdWF0ZXJuaW9uKTsKCiAgICAgIGlmICghKHRoaXMudHlwZSA9PT0gQm9keS5EWU5BTUlDIHx8IHRoaXMudHlwZSA9PT0gQm9keS5LSU5FTUFUSUMpIHx8IHRoaXMuc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORykgewogICAgICAgIC8vIE9ubHkgZm9yIGR5bmFtaWMKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHZlbG8gPSB0aGlzLnZlbG9jaXR5OwogICAgICBjb25zdCBhbmd1bGFyVmVsbyA9IHRoaXMuYW5ndWxhclZlbG9jaXR5OwogICAgICBjb25zdCBwb3MgPSB0aGlzLnBvc2l0aW9uOwogICAgICBjb25zdCBmb3JjZSA9IHRoaXMuZm9yY2U7CiAgICAgIGNvbnN0IHRvcnF1ZSA9IHRoaXMudG9ycXVlOwogICAgICBjb25zdCBxdWF0ID0gdGhpcy5xdWF0ZXJuaW9uOwogICAgICBjb25zdCBpbnZNYXNzID0gdGhpcy5pbnZNYXNzOwogICAgICBjb25zdCBpbnZJbmVydGlhID0gdGhpcy5pbnZJbmVydGlhV29ybGQ7CiAgICAgIGNvbnN0IGxpbmVhckZhY3RvciA9IHRoaXMubGluZWFyRmFjdG9yOwogICAgICBjb25zdCBpTWR0ID0gaW52TWFzcyAqIGR0OwogICAgICB2ZWxvLnggKz0gZm9yY2UueCAqIGlNZHQgKiBsaW5lYXJGYWN0b3IueDsKICAgICAgdmVsby55ICs9IGZvcmNlLnkgKiBpTWR0ICogbGluZWFyRmFjdG9yLnk7CiAgICAgIHZlbG8ueiArPSBmb3JjZS56ICogaU1kdCAqIGxpbmVhckZhY3Rvci56OwogICAgICBjb25zdCBlID0gaW52SW5lcnRpYS5lbGVtZW50czsKICAgICAgY29uc3QgYW5ndWxhckZhY3RvciA9IHRoaXMuYW5ndWxhckZhY3RvcjsKICAgICAgY29uc3QgdHggPSB0b3JxdWUueCAqIGFuZ3VsYXJGYWN0b3IueDsKICAgICAgY29uc3QgdHkgPSB0b3JxdWUueSAqIGFuZ3VsYXJGYWN0b3IueTsKICAgICAgY29uc3QgdHogPSB0b3JxdWUueiAqIGFuZ3VsYXJGYWN0b3IuejsKICAgICAgYW5ndWxhclZlbG8ueCArPSBkdCAqIChlWzBdICogdHggKyBlWzFdICogdHkgKyBlWzJdICogdHopOwogICAgICBhbmd1bGFyVmVsby55ICs9IGR0ICogKGVbM10gKiB0eCArIGVbNF0gKiB0eSArIGVbNV0gKiB0eik7CiAgICAgIGFuZ3VsYXJWZWxvLnogKz0gZHQgKiAoZVs2XSAqIHR4ICsgZVs3XSAqIHR5ICsgZVs4XSAqIHR6KTsgLy8gVXNlIG5ldyB2ZWxvY2l0eSAgLSBsZWFwIGZyb2cKCiAgICAgIHBvcy54ICs9IHZlbG8ueCAqIGR0OwogICAgICBwb3MueSArPSB2ZWxvLnkgKiBkdDsKICAgICAgcG9zLnogKz0gdmVsby56ICogZHQ7CiAgICAgIHF1YXQuaW50ZWdyYXRlKHRoaXMuYW5ndWxhclZlbG9jaXR5LCBkdCwgdGhpcy5hbmd1bGFyRmFjdG9yLCBxdWF0KTsKCiAgICAgIGlmIChxdWF0Tm9ybWFsaXplKSB7CiAgICAgICAgaWYgKHF1YXROb3JtYWxpemVGYXN0KSB7CiAgICAgICAgICBxdWF0Lm5vcm1hbGl6ZUZhc3QoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcXVhdC5ub3JtYWxpemUoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuYWFiYk5lZWRzVXBkYXRlID0gdHJ1ZTsgLy8gVXBkYXRlIHdvcmxkIGluZXJ0aWEKCiAgICAgIHRoaXMudXBkYXRlSW5lcnRpYVdvcmxkKCk7CiAgICB9CgogIH0KCiAgQm9keS5pZENvdW50ZXIgPSAwOwogIEJvZHkuQ09MTElERV9FVkVOVF9OQU1FID0gJ2NvbGxpZGUnOwogIEJvZHkuRFlOQU1JQyA9IEJPRFlfVFlQRVMuRFlOQU1JQzsKICBCb2R5LlNUQVRJQyA9IEJPRFlfVFlQRVMuU1RBVElDOwogIEJvZHkuS0lORU1BVElDID0gQk9EWV9UWVBFUy5LSU5FTUFUSUM7CiAgQm9keS5BV0FLRSA9IEJPRFlfU0xFRVBfU1RBVEVTLkFXQUtFOwogIEJvZHkuU0xFRVBZID0gQk9EWV9TTEVFUF9TVEFURVMuU0xFRVBZOwogIEJvZHkuU0xFRVBJTkcgPSBCT0RZX1NMRUVQX1NUQVRFUy5TTEVFUElORzsKICBCb2R5Lndha2V1cEV2ZW50ID0gewogICAgdHlwZTogJ3dha2V1cCcKICB9OwogIEJvZHkuc2xlZXB5RXZlbnQgPSB7CiAgICB0eXBlOiAnc2xlZXB5JwogIH07CiAgQm9keS5zbGVlcEV2ZW50ID0gewogICAgdHlwZTogJ3NsZWVwJwogIH07CiAgY29uc3QgdG1wVmVjID0gbmV3IFZlYzMoKTsKICBjb25zdCB0bXBRdWF0ID0gbmV3IFF1YXRlcm5pb24oKTsKICBjb25zdCB1cGRhdGVBQUJCX3NoYXBlQUFCQiA9IG5ldyBBQUJCKCk7CiAgY29uc3QgdWl3X20xID0gbmV3IE1hdDMoKTsKICBjb25zdCB1aXdfbTIgPSBuZXcgTWF0MygpOwogIGNvbnN0IEJvZHlfYXBwbHlGb3JjZV9yb3RGb3JjZSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUxvY2FsRm9yY2Vfd29ybGRGb3JjZSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUxvY2FsRm9yY2VfcmVsYXRpdmVQb2ludFdvcmxkID0gbmV3IFZlYzMoKTsKICBjb25zdCBCb2R5X2FwcGx5SW1wdWxzZV92ZWxvID0gbmV3IFZlYzMoKTsKICBjb25zdCBCb2R5X2FwcGx5SW1wdWxzZV9yb3RWZWxvID0gbmV3IFZlYzMoKTsKICBjb25zdCBCb2R5X2FwcGx5TG9jYWxJbXB1bHNlX3dvcmxkSW1wdWxzZSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQm9keV9hcHBseUxvY2FsSW1wdWxzZV9yZWxhdGl2ZVBvaW50ID0gbmV3IFZlYzMoKTsKICBjb25zdCBCb2R5X3VwZGF0ZU1hc3NQcm9wZXJ0aWVzX2hhbGZFeHRlbnRzID0gbmV3IFZlYzMoKTsKICAvKioKICAgKiBCYXNlIGNsYXNzIGZvciBicm9hZHBoYXNlIGltcGxlbWVudGF0aW9ucwogICAqIEBhdXRob3Igc2NodGVwcGUKICAgKi8KCiAgY2xhc3MgQnJvYWRwaGFzZSB7CiAgICAvKioKICAgICAqIFRoZSB3b3JsZCB0byBzZWFyY2ggZm9yIGNvbGxpc2lvbnMgaW4uCiAgICAgKi8KCiAgICAvKioKICAgICAqIElmIHNldCB0byB0cnVlLCB0aGUgYnJvYWRwaGFzZSB1c2VzIGJvdW5kaW5nIGJveGVzIGZvciBpbnRlcnNlY3Rpb24gdGVzdHMsIGVsc2UgaXQgdXNlcyBib3VuZGluZyBzcGhlcmVzLgogICAgICovCgogICAgLyoqCiAgICAgKiBTZXQgdG8gdHJ1ZSBpZiB0aGUgb2JqZWN0cyBpbiB0aGUgd29ybGQgbW92ZWQuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLndvcmxkID0gdm9pZCAwOwogICAgICB0aGlzLnVzZUJvdW5kaW5nQm94ZXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGlydHkgPSB2b2lkIDA7CiAgICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgICB0aGlzLnVzZUJvdW5kaW5nQm94ZXMgPSBmYWxzZTsKICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgY29sbGlzaW9uIHBhaXJzIGZyb20gdGhlIHdvcmxkCiAgICAgKiBAcGFyYW0gd29ybGQgVGhlIHdvcmxkIHRvIHNlYXJjaCBpbgogICAgICogQHBhcmFtIHAxIEVtcHR5IGFycmF5IHRvIGJlIGZpbGxlZCB3aXRoIGJvZHkgb2JqZWN0cwogICAgICogQHBhcmFtIHAyIEVtcHR5IGFycmF5IHRvIGJlIGZpbGxlZCB3aXRoIGJvZHkgb2JqZWN0cwogICAgICovCgoKICAgIGNvbGxpc2lvblBhaXJzKHdvcmxkLCBwMSwgcDIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb2xsaXNpb25QYWlycyBub3QgaW1wbGVtZW50ZWQgZm9yIHRoaXMgQnJvYWRQaGFzZSBjbGFzcyEnKTsKICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgYSBib2R5IHBhaXIgbmVlZHMgdG8gYmUgaW50ZXJzZWN0aW9uIHRlc3RlZCBhdCBhbGwuCiAgICAgKi8KCgogICAgbmVlZEJyb2FkcGhhc2VDb2xsaXNpb24oYm9keUEsIGJvZHlCKSB7CiAgICAgIC8vIENoZWNrIGNvbGxpc2lvbiBmaWx0ZXIgbWFza3MKICAgICAgaWYgKChib2R5QS5jb2xsaXNpb25GaWx0ZXJHcm91cCAmIGJvZHlCLmNvbGxpc2lvbkZpbHRlck1hc2spID09PSAwIHx8IChib2R5Qi5jb2xsaXNpb25GaWx0ZXJHcm91cCAmIGJvZHlBLmNvbGxpc2lvbkZpbHRlck1hc2spID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9IC8vIENoZWNrIHR5cGVzCgoKICAgICAgaWYgKCgoYm9keUEudHlwZSAmIEJvZHkuU1RBVElDKSAhPT0gMCB8fCBib2R5QS5zbGVlcFN0YXRlID09PSBCb2R5LlNMRUVQSU5HKSAmJiAoKGJvZHlCLnR5cGUgJiBCb2R5LlNUQVRJQykgIT09IDAgfHwgYm9keUIuc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORykpIHsKICAgICAgICAvLyBCb3RoIGJvZGllcyBhcmUgc3RhdGljIG9yIHNsZWVwaW5nLiBTa2lwLgogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoZSBib3VuZGluZyB2b2x1bWVzIG9mIHR3byBib2RpZXMgaW50ZXJzZWN0LgogICAgICovCgoKICAgIGludGVyc2VjdGlvblRlc3QoYm9keUEsIGJvZHlCLCBwYWlyczEsIHBhaXJzMikgewogICAgICBpZiAodGhpcy51c2VCb3VuZGluZ0JveGVzKSB7CiAgICAgICAgdGhpcy5kb0JvdW5kaW5nQm94QnJvYWRwaGFzZShib2R5QSwgYm9keUIsIHBhaXJzMSwgcGFpcnMyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmRvQm91bmRpbmdTcGhlcmVCcm9hZHBoYXNlKGJvZHlBLCBib2R5QiwgcGFpcnMxLCBwYWlyczIpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoZSBib3VuZGluZyBzcGhlcmVzIG9mIHR3byBib2RpZXMgYXJlIGludGVyc2VjdGluZy4KICAgICAqIEBwYXJhbSBwYWlyczEgYm9keUEgaXMgYXBwZW5kZWQgdG8gdGhpcyBhcnJheSBpZiBpbnRlcnNlY3Rpb24KICAgICAqIEBwYXJhbSBwYWlyczIgYm9keUIgaXMgYXBwZW5kZWQgdG8gdGhpcyBhcnJheSBpZiBpbnRlcnNlY3Rpb24KICAgICAqLwoKCiAgICBkb0JvdW5kaW5nU3BoZXJlQnJvYWRwaGFzZShib2R5QSwgYm9keUIsIHBhaXJzMSwgcGFpcnMyKSB7CiAgICAgIGNvbnN0IHIgPSBCcm9hZHBoYXNlX2NvbGxpc2lvblBhaXJzX3I7CiAgICAgIGJvZHlCLnBvc2l0aW9uLnZzdWIoYm9keUEucG9zaXRpb24sIHIpOwogICAgICBjb25zdCBib3VuZGluZ1JhZGl1c1N1bTIgPSAoYm9keUEuYm91bmRpbmdSYWRpdXMgKyBib2R5Qi5ib3VuZGluZ1JhZGl1cykgKiogMjsKICAgICAgY29uc3Qgbm9ybTIgPSByLmxlbmd0aFNxdWFyZWQoKTsKCiAgICAgIGlmIChub3JtMiA8IGJvdW5kaW5nUmFkaXVzU3VtMikgewogICAgICAgIHBhaXJzMS5wdXNoKGJvZHlBKTsKICAgICAgICBwYWlyczIucHVzaChib2R5Qik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ2hlY2sgaWYgdGhlIGJvdW5kaW5nIGJveGVzIG9mIHR3byBib2RpZXMgYXJlIGludGVyc2VjdGluZy4KICAgICAqLwoKCiAgICBkb0JvdW5kaW5nQm94QnJvYWRwaGFzZShib2R5QSwgYm9keUIsIHBhaXJzMSwgcGFpcnMyKSB7CiAgICAgIGlmIChib2R5QS5hYWJiTmVlZHNVcGRhdGUpIHsKICAgICAgICBib2R5QS51cGRhdGVBQUJCKCk7CiAgICAgIH0KCiAgICAgIGlmIChib2R5Qi5hYWJiTmVlZHNVcGRhdGUpIHsKICAgICAgICBib2R5Qi51cGRhdGVBQUJCKCk7CiAgICAgIH0gLy8gQ2hlY2sgQUFCQiAvIEFBQkIKCgogICAgICBpZiAoYm9keUEuYWFiYi5vdmVybGFwcyhib2R5Qi5hYWJiKSkgewogICAgICAgIHBhaXJzMS5wdXNoKGJvZHlBKTsKICAgICAgICBwYWlyczIucHVzaChib2R5Qik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyBkdXBsaWNhdGUgcGFpcnMgZnJvbSB0aGUgcGFpciBhcnJheXMuCiAgICAgKi8KCgogICAgbWFrZVBhaXJzVW5pcXVlKHBhaXJzMSwgcGFpcnMyKSB7CiAgICAgIGNvbnN0IHQgPSBCcm9hZHBoYXNlX21ha2VQYWlyc1VuaXF1ZV90ZW1wOwogICAgICBjb25zdCBwMSA9IEJyb2FkcGhhc2VfbWFrZVBhaXJzVW5pcXVlX3AxOwogICAgICBjb25zdCBwMiA9IEJyb2FkcGhhc2VfbWFrZVBhaXJzVW5pcXVlX3AyOwogICAgICBjb25zdCBOID0gcGFpcnMxLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBwMVtpXSA9IHBhaXJzMVtpXTsKICAgICAgICBwMltpXSA9IHBhaXJzMltpXTsKICAgICAgfQoKICAgICAgcGFpcnMxLmxlbmd0aCA9IDA7CiAgICAgIHBhaXJzMi5sZW5ndGggPSAwOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGlkMSA9IHAxW2ldLmlkOwogICAgICAgIGNvbnN0IGlkMiA9IHAyW2ldLmlkOwogICAgICAgIGNvbnN0IGtleSA9IGlkMSA8IGlkMiA/IGlkMSArICIsIiArIGlkMiA6IGlkMiArICIsIiArIGlkMTsKICAgICAgICB0W2tleV0gPSBpOwogICAgICAgIHQua2V5cy5wdXNoKGtleSk7CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSB0LmtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBrZXkgPSB0LmtleXMucG9wKCk7CiAgICAgICAgY29uc3QgcGFpckluZGV4ID0gdFtrZXldOwogICAgICAgIHBhaXJzMS5wdXNoKHAxW3BhaXJJbmRleF0pOwogICAgICAgIHBhaXJzMi5wdXNoKHAyW3BhaXJJbmRleF0pOwogICAgICAgIGRlbGV0ZSB0W2tleV07CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVG8gYmUgaW1wbGVtZW50ZWQgYnkgc3ViY2Fzc2VzCiAgICAgKi8KCgogICAgc2V0V29ybGQod29ybGQpIHt9CiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoZSBib3VuZGluZyBzcGhlcmVzIG9mIHR3byBib2RpZXMgb3ZlcmxhcC4KICAgICAqLwoKCiAgICBzdGF0aWMgYm91bmRpbmdTcGhlcmVDaGVjayhib2R5QSwgYm9keUIpIHsKICAgICAgY29uc3QgZGlzdCA9IG5ldyBWZWMzKCk7IC8vIGJzY19kaXN0OwoKICAgICAgYm9keUEucG9zaXRpb24udnN1Yihib2R5Qi5wb3NpdGlvbiwgZGlzdCk7CiAgICAgIGNvbnN0IHNhID0gYm9keUEuc2hhcGVzWzBdOwogICAgICBjb25zdCBzYiA9IGJvZHlCLnNoYXBlc1swXTsKICAgICAgcmV0dXJuIE1hdGgucG93KHNhLmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgc2IuYm91bmRpbmdTcGhlcmVSYWRpdXMsIDIpID4gZGlzdC5sZW5ndGhTcXVhcmVkKCk7CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYWxsIHRoZSBib2RpZXMgd2l0aGluIHRoZSBBQUJCLgogICAgICovCgoKICAgIGFhYmJRdWVyeSh3b3JsZCwgYWFiYiwgcmVzdWx0KSB7CiAgICAgIGNvbnNvbGUud2FybignLmFhYmJRdWVyeSBpcyBub3QgaW1wbGVtZW50ZWQgaW4gdGhpcyBCcm9hZHBoYXNlIHN1YmNsYXNzLicpOwogICAgICByZXR1cm4gW107CiAgICB9CgogIH0gLy8gVGVtcCBvYmplY3RzCgoKICBjb25zdCBCcm9hZHBoYXNlX2NvbGxpc2lvblBhaXJzX3IgPSBuZXcgVmVjMygpOwogIGNvbnN0IEJyb2FkcGhhc2VfbWFrZVBhaXJzVW5pcXVlX3RlbXAgPSB7CiAgICBrZXlzOiBbXQogIH07CiAgY29uc3QgQnJvYWRwaGFzZV9tYWtlUGFpcnNVbmlxdWVfcDEgPSBbXTsKICBjb25zdCBCcm9hZHBoYXNlX21ha2VQYWlyc1VuaXF1ZV9wMiA9IFtdOwoKICBuZXcgVmVjMygpOwogIC8qKgogICAqIE5haXZlIGJyb2FkcGhhc2UgaW1wbGVtZW50YXRpb24sIHVzZWQgaW4gbGFjayBvZiBiZXR0ZXIgb25lcy4KICAgKgogICAqIFRoZSBuYWl2ZSBicm9hZHBoYXNlIGxvb2tzIGF0IGFsbCBwb3NzaWJsZSBwYWlycyB3aXRob3V0IHJlc3RyaWN0aW9uLCB0aGVyZWZvcmUgaXQgaGFzIGNvbXBsZXhpdHkgTl4yIF8od2hpY2ggaXMgYmFkKV8KICAgKi8KCiAgY2xhc3MgTmFpdmVCcm9hZHBoYXNlIGV4dGVuZHMgQnJvYWRwaGFzZSB7CiAgICAvKioKICAgICAqIEB0b2RvIFJlbW92ZSB1c2VsZXNzIGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICBzdXBlcigpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYWxsIHRoZSBjb2xsaXNpb24gcGFpcnMgaW4gdGhlIHBoeXNpY3Mgd29ybGQKICAgICAqLwoKCiAgICBjb2xsaXNpb25QYWlycyh3b3JsZCwgcGFpcnMxLCBwYWlyczIpIHsKICAgICAgY29uc3QgYm9kaWVzID0gd29ybGQuYm9kaWVzOwogICAgICBjb25zdCBuID0gYm9kaWVzLmxlbmd0aDsKICAgICAgbGV0IGJpOwogICAgICBsZXQgYmo7IC8vIE5haXZlIE5eMiBmdHchCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbjsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IGk7IGorKykgewogICAgICAgICAgYmkgPSBib2RpZXNbaV07CiAgICAgICAgICBiaiA9IGJvZGllc1tqXTsKCiAgICAgICAgICBpZiAoIXRoaXMubmVlZEJyb2FkcGhhc2VDb2xsaXNpb24oYmksIGJqKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLmludGVyc2VjdGlvblRlc3QoYmksIGJqLCBwYWlyczEsIHBhaXJzMik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYWxsIHRoZSBib2RpZXMgd2l0aGluIGFuIEFBQkIuCiAgICAgKiBAcGFyYW0gcmVzdWx0IEFuIGFycmF5IHRvIHN0b3JlIHJlc3VsdGluZyBib2RpZXMgaW4uCiAgICAgKi8KCgogICAgYWFiYlF1ZXJ5KHdvcmxkLCBhYWJiLCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gW107CiAgICAgIH0KCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd29ybGQuYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYiA9IHdvcmxkLmJvZGllc1tpXTsKCiAgICAgICAgaWYgKGIuYWFiYk5lZWRzVXBkYXRlKSB7CiAgICAgICAgICBiLnVwZGF0ZUFBQkIoKTsKICAgICAgICB9IC8vIFVnbHkgaGFjayB1bnRpbCBCb2R5IGdldHMgYWFiYgoKCiAgICAgICAgaWYgKGIuYWFiYi5vdmVybGFwcyhhYWJiKSkgewogICAgICAgICAgcmVzdWx0LnB1c2goYik7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICB9CiAgLyoqCiAgICogU3RvcmFnZSBmb3IgUmF5IGNhc3RpbmcgZGF0YQogICAqLwoKCiAgY2xhc3MgUmF5Y2FzdFJlc3VsdCB7CiAgICAvKioKICAgICAqIHJheUZyb21Xb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiByYXlUb1dvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIGhpdE5vcm1hbFdvcmxkCiAgICAgKi8KCiAgICAvKioKICAgICAqIGhpdFBvaW50V29ybGQKICAgICAqLwoKICAgIC8qKgogICAgICogaGFzSGl0CiAgICAgKi8KCiAgICAvKioKICAgICAqIHNoYXBlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGJvZHkKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGluZGV4IG9mIHRoZSBoaXQgdHJpYW5nbGUsIGlmIHRoZSBoaXQgc2hhcGUgd2FzIGEgdHJpbWVzaAogICAgICovCgogICAgLyoqCiAgICAgKiBEaXN0YW5jZSB0byB0aGUgaGl0LiBXaWxsIGJlIHNldCB0byAtMSBpZiB0aGVyZSB3YXMgbm8gaGl0CiAgICAgKi8KCiAgICAvKioKICAgICAqIElmIHRoZSByYXkgc2hvdWxkIHN0b3AgdHJhdmVyc2luZyB0aGUgYm9kaWVzCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLnJheUZyb21Xb3JsZCA9IHZvaWQgMDsKICAgICAgdGhpcy5yYXlUb1dvcmxkID0gdm9pZCAwOwogICAgICB0aGlzLmhpdE5vcm1hbFdvcmxkID0gdm9pZCAwOwogICAgICB0aGlzLmhpdFBvaW50V29ybGQgPSB2b2lkIDA7CiAgICAgIHRoaXMuaGFzSGl0ID0gdm9pZCAwOwogICAgICB0aGlzLnNoYXBlID0gdm9pZCAwOwogICAgICB0aGlzLmJvZHkgPSB2b2lkIDA7CiAgICAgIHRoaXMuaGl0RmFjZUluZGV4ID0gdm9pZCAwOwogICAgICB0aGlzLmRpc3RhbmNlID0gdm9pZCAwOwogICAgICB0aGlzLnNob3VsZFN0b3AgPSB2b2lkIDA7CiAgICAgIHRoaXMucmF5RnJvbVdvcmxkID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5yYXlUb1dvcmxkID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5oaXROb3JtYWxXb3JsZCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaGl0UG9pbnRXb3JsZCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuaGFzSGl0ID0gZmFsc2U7CiAgICAgIHRoaXMuc2hhcGUgPSBudWxsOwogICAgICB0aGlzLmJvZHkgPSBudWxsOwogICAgICB0aGlzLmhpdEZhY2VJbmRleCA9IC0xOwogICAgICB0aGlzLmRpc3RhbmNlID0gLTE7CiAgICAgIHRoaXMuc2hvdWxkU3RvcCA9IGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBSZXNldCBhbGwgcmVzdWx0IGRhdGEuCiAgICAgKi8KCgogICAgcmVzZXQoKSB7CiAgICAgIHRoaXMucmF5RnJvbVdvcmxkLnNldFplcm8oKTsKICAgICAgdGhpcy5yYXlUb1dvcmxkLnNldFplcm8oKTsKICAgICAgdGhpcy5oaXROb3JtYWxXb3JsZC5zZXRaZXJvKCk7CiAgICAgIHRoaXMuaGl0UG9pbnRXb3JsZC5zZXRaZXJvKCk7CiAgICAgIHRoaXMuaGFzSGl0ID0gZmFsc2U7CiAgICAgIHRoaXMuc2hhcGUgPSBudWxsOwogICAgICB0aGlzLmJvZHkgPSBudWxsOwogICAgICB0aGlzLmhpdEZhY2VJbmRleCA9IC0xOwogICAgICB0aGlzLmRpc3RhbmNlID0gLTE7CiAgICAgIHRoaXMuc2hvdWxkU3RvcCA9IGZhbHNlOwogICAgfQogICAgLyoqCiAgICAgKiBhYm9ydAogICAgICovCgoKICAgIGFib3J0KCkgewogICAgICB0aGlzLnNob3VsZFN0b3AgPSB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgcmVzdWx0IGRhdGEuCiAgICAgKi8KCgogICAgc2V0KHJheUZyb21Xb3JsZCwgcmF5VG9Xb3JsZCwgaGl0Tm9ybWFsV29ybGQsIGhpdFBvaW50V29ybGQsIHNoYXBlLCBib2R5LCBkaXN0YW5jZSkgewogICAgICB0aGlzLnJheUZyb21Xb3JsZC5jb3B5KHJheUZyb21Xb3JsZCk7CiAgICAgIHRoaXMucmF5VG9Xb3JsZC5jb3B5KHJheVRvV29ybGQpOwogICAgICB0aGlzLmhpdE5vcm1hbFdvcmxkLmNvcHkoaGl0Tm9ybWFsV29ybGQpOwogICAgICB0aGlzLmhpdFBvaW50V29ybGQuY29weShoaXRQb2ludFdvcmxkKTsKICAgICAgdGhpcy5zaGFwZSA9IHNoYXBlOwogICAgICB0aGlzLmJvZHkgPSBib2R5OwogICAgICB0aGlzLmRpc3RhbmNlID0gZGlzdGFuY2U7CiAgICB9CgogIH0KCiAgbGV0IF9TaGFwZSR0eXBlcyRTUEhFUkUsIF9TaGFwZSR0eXBlcyRQTEFORSwgX1NoYXBlJHR5cGVzJEJPWCwgX1NoYXBlJHR5cGVzJENZTElOREVSLCBfU2hhcGUkdHlwZXMkQ09OVkVYUE8sIF9TaGFwZSR0eXBlcyRIRUlHSFRGSSwgX1NoYXBlJHR5cGVzJFRSSU1FU0g7CiAgLyoqCiAgICogUkFZX01PREVTCiAgICovCgoKICBjb25zdCBSQVlfTU9ERVMgPSB7CiAgICAvKiogQ0xPU0VTVCAqLwogICAgQ0xPU0VTVDogMSwKCiAgICAvKiogQU5ZICovCiAgICBBTlk6IDIsCgogICAgLyoqIEFMTCAqLwogICAgQUxMOiA0CiAgfTsKICAvKioKICAgKiBSYXlNb2RlCiAgICovCgogIF9TaGFwZSR0eXBlcyRTUEhFUkUgPSBTaGFwZS50eXBlcy5TUEhFUkU7CiAgX1NoYXBlJHR5cGVzJFBMQU5FID0gU2hhcGUudHlwZXMuUExBTkU7CiAgX1NoYXBlJHR5cGVzJEJPWCA9IFNoYXBlLnR5cGVzLkJPWDsKICBfU2hhcGUkdHlwZXMkQ1lMSU5ERVIgPSBTaGFwZS50eXBlcy5DWUxJTkRFUjsKICBfU2hhcGUkdHlwZXMkQ09OVkVYUE8gPSBTaGFwZS50eXBlcy5DT05WRVhQT0xZSEVEUk9OOwogIF9TaGFwZSR0eXBlcyRIRUlHSFRGSSA9IFNoYXBlLnR5cGVzLkhFSUdIVEZJRUxEOwogIF9TaGFwZSR0eXBlcyRUUklNRVNIID0gU2hhcGUudHlwZXMuVFJJTUVTSDsKICAvKioKICAgKiBBIGxpbmUgaW4gM0Qgc3BhY2UgdGhhdCBpbnRlcnNlY3RzIGJvZGllcyBhbmQgcmV0dXJuIHBvaW50cy4KICAgKi8KCiAgY2xhc3MgUmF5IHsKICAgIC8qKgogICAgICogZnJvbQogICAgICovCgogICAgLyoqCiAgICAgKiB0bwogICAgICovCgogICAgLyoqCiAgICAgKiBkaXJlY3Rpb24KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHByZWNpc2lvbiBvZiB0aGUgcmF5LiBVc2VkIHdoZW4gY2hlY2tpbmcgcGFyYWxsZWxpdHkgZXRjLgogICAgICogQGRlZmF1bHQgMC4wMDAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNldCB0byBgZmFsc2VgIGlmIHlvdSBkb24ndCB3YW50IHRoZSBSYXkgdG8gdGFrZSBgY29sbGlzaW9uUmVzcG9uc2VgIGZsYWdzIGludG8gYWNjb3VudCBvbiBib2RpZXMgYW5kIHNoYXBlcy4KICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogSWYgc2V0IHRvIGB0cnVlYCwgdGhlIHJheSBza2lwcyBhbnkgaGl0cyB3aXRoIG5vcm1hbC5kb3QocmF5RGlyZWN0aW9uKSA8IDAuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCgogICAgLyoqCiAgICAgKiBjb2xsaXNpb25GaWx0ZXJNYXNrCiAgICAgKiBAZGVmYXVsdCAtMQogICAgICovCgogICAgLyoqCiAgICAgKiBjb2xsaXNpb25GaWx0ZXJHcm91cAogICAgICogQGRlZmF1bHQgLTEKICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGludGVyc2VjdGlvbiBtb2RlLiBTaG91bGQgYmUgUmF5LkFOWSwgUmF5LkFMTCBvciBSYXkuQ0xPU0VTVC4KICAgICAqIEBkZWZhdWx0IFJBWS5BTlkKICAgICAqLwoKICAgIC8qKgogICAgICogQ3VycmVudCByZXN1bHQgb2JqZWN0LgogICAgICovCgogICAgLyoqCiAgICAgKiBXaWxsIGJlIHNldCB0byBgdHJ1ZWAgZHVyaW5nIGludGVyc2VjdFdvcmxkKCkgaWYgdGhlIHJheSBoaXQgYW55dGhpbmcuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFVzZXItcHJvdmlkZWQgcmVzdWx0IGNhbGxiYWNrLiBXaWxsIGJlIHVzZWQgaWYgbW9kZSBpcyBSYXkuQUxMLgogICAgICovCgogICAgLyoqCiAgICAgKiBDTE9TRVNUCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFOWQogICAgICovCgogICAgLyoqCiAgICAgKiBBTEwKICAgICAqLwogICAgZ2V0IFtfU2hhcGUkdHlwZXMkU1BIRVJFXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdFNwaGVyZTsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRQTEFORV0oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RQbGFuZTsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRCT1hdKCkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0Qm94OwogICAgfQoKICAgIGdldCBbX1NoYXBlJHR5cGVzJENZTElOREVSXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2ludGVyc2VjdENvbnZleDsKICAgIH0KCiAgICBnZXQgW19TaGFwZSR0eXBlcyRDT05WRVhQT10oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RDb252ZXg7CiAgICB9CgogICAgZ2V0IFtfU2hhcGUkdHlwZXMkSEVJR0hURkldKCkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0SGVpZ2h0ZmllbGQ7CiAgICB9CgogICAgZ2V0IFtfU2hhcGUkdHlwZXMkVFJJTUVTSF0oKSB7CiAgICAgIHJldHVybiB0aGlzLl9pbnRlcnNlY3RUcmltZXNoOwogICAgfQoKICAgIGNvbnN0cnVjdG9yKGZyb20sIHRvKSB7CiAgICAgIGlmIChmcm9tID09PSB2b2lkIDApIHsKICAgICAgICBmcm9tID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgaWYgKHRvID09PSB2b2lkIDApIHsKICAgICAgICB0byA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuZnJvbSA9IHZvaWQgMDsKICAgICAgdGhpcy50byA9IHZvaWQgMDsKICAgICAgdGhpcy5kaXJlY3Rpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMucHJlY2lzaW9uID0gdm9pZCAwOwogICAgICB0aGlzLmNoZWNrQ29sbGlzaW9uUmVzcG9uc2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuc2tpcEJhY2tmYWNlcyA9IHZvaWQgMDsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlckdyb3VwID0gdm9pZCAwOwogICAgICB0aGlzLm1vZGUgPSB2b2lkIDA7CiAgICAgIHRoaXMucmVzdWx0ID0gdm9pZCAwOwogICAgICB0aGlzLmhhc0hpdCA9IHZvaWQgMDsKICAgICAgdGhpcy5jYWxsYmFjayA9IHZvaWQgMDsKICAgICAgdGhpcy5mcm9tID0gZnJvbS5jbG9uZSgpOwogICAgICB0aGlzLnRvID0gdG8uY2xvbmUoKTsKICAgICAgdGhpcy5kaXJlY3Rpb24gPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnByZWNpc2lvbiA9IDAuMDAwMTsKICAgICAgdGhpcy5jaGVja0NvbGxpc2lvblJlc3BvbnNlID0gdHJ1ZTsKICAgICAgdGhpcy5za2lwQmFja2ZhY2VzID0gZmFsc2U7CiAgICAgIHRoaXMuY29sbGlzaW9uRmlsdGVyTWFzayA9IC0xOwogICAgICB0aGlzLmNvbGxpc2lvbkZpbHRlckdyb3VwID0gLTE7CiAgICAgIHRoaXMubW9kZSA9IFJheS5BTlk7CiAgICAgIHRoaXMucmVzdWx0ID0gbmV3IFJheWNhc3RSZXN1bHQoKTsKICAgICAgdGhpcy5oYXNIaXQgPSBmYWxzZTsKCiAgICAgIHRoaXMuY2FsbGJhY2sgPSByZXN1bHQgPT4ge307CiAgICB9CiAgICAvKioKICAgICAqIERvIGl0ZXJzZWN0aW9uIGFnYWluc3QgYWxsIGJvZGllcyBpbiB0aGUgZ2l2ZW4gV29ybGQuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgdGhlIHJheSBoaXQgYW55dGhpbmcsIG90aGVyd2lzZSBmYWxzZS4KICAgICAqLwoKCiAgICBpbnRlcnNlY3RXb3JsZCh3b3JsZCwgb3B0aW9ucykgewogICAgICB0aGlzLm1vZGUgPSBvcHRpb25zLm1vZGUgfHwgUmF5LkFOWTsKICAgICAgdGhpcy5yZXN1bHQgPSBvcHRpb25zLnJlc3VsdCB8fCBuZXcgUmF5Y2FzdFJlc3VsdCgpOwogICAgICB0aGlzLnNraXBCYWNrZmFjZXMgPSAhIW9wdGlvbnMuc2tpcEJhY2tmYWNlczsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJNYXNrID0gdHlwZW9mIG9wdGlvbnMuY29sbGlzaW9uRmlsdGVyTWFzayAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmNvbGxpc2lvbkZpbHRlck1hc2sgOiAtMTsKICAgICAgdGhpcy5jb2xsaXNpb25GaWx0ZXJHcm91cCA9IHR5cGVvZiBvcHRpb25zLmNvbGxpc2lvbkZpbHRlckdyb3VwICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuY29sbGlzaW9uRmlsdGVyR3JvdXAgOiAtMTsKICAgICAgdGhpcy5jaGVja0NvbGxpc2lvblJlc3BvbnNlID0gdHlwZW9mIG9wdGlvbnMuY2hlY2tDb2xsaXNpb25SZXNwb25zZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmNoZWNrQ29sbGlzaW9uUmVzcG9uc2UgOiB0cnVlOwoKICAgICAgaWYgKG9wdGlvbnMuZnJvbSkgewogICAgICAgIHRoaXMuZnJvbS5jb3B5KG9wdGlvbnMuZnJvbSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnRvKSB7CiAgICAgICAgdGhpcy50by5jb3B5KG9wdGlvbnMudG8pOwogICAgICB9CgogICAgICB0aGlzLmNhbGxiYWNrID0gb3B0aW9ucy5jYWxsYmFjayB8fCAoKCkgPT4ge30pOwoKICAgICAgdGhpcy5oYXNIaXQgPSBmYWxzZTsKICAgICAgdGhpcy5yZXN1bHQucmVzZXQoKTsKICAgICAgdGhpcy51cGRhdGVEaXJlY3Rpb24oKTsKICAgICAgdGhpcy5nZXRBQUJCKHRtcEFBQkIkMSk7CiAgICAgIHRtcEFycmF5Lmxlbmd0aCA9IDA7CiAgICAgIHdvcmxkLmJyb2FkcGhhc2UuYWFiYlF1ZXJ5KHdvcmxkLCB0bXBBQUJCJDEsIHRtcEFycmF5KTsKICAgICAgdGhpcy5pbnRlcnNlY3RCb2RpZXModG1wQXJyYXkpOwogICAgICByZXR1cm4gdGhpcy5oYXNIaXQ7CiAgICB9CiAgICAvKioKICAgICAqIFNob290IGEgcmF5IGF0IGEgYm9keSwgZ2V0IGJhY2sgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGhpdC4KICAgICAqIEBkZXByZWNhdGVkIEBwYXJhbSByZXN1bHQgc2V0IHRoZSByZXN1bHQgcHJvcGVydHkgb2YgdGhlIFJheSBpbnN0ZWFkLgogICAgICovCgoKICAgIGludGVyc2VjdEJvZHkoYm9keSwgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICB0aGlzLnJlc3VsdCA9IHJlc3VsdDsKICAgICAgICB0aGlzLnVwZGF0ZURpcmVjdGlvbigpOwogICAgICB9CgogICAgICBjb25zdCBjaGVja0NvbGxpc2lvblJlc3BvbnNlID0gdGhpcy5jaGVja0NvbGxpc2lvblJlc3BvbnNlOwoKICAgICAgaWYgKGNoZWNrQ29sbGlzaW9uUmVzcG9uc2UgJiYgIWJvZHkuY29sbGlzaW9uUmVzcG9uc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmICgodGhpcy5jb2xsaXNpb25GaWx0ZXJHcm91cCAmIGJvZHkuY29sbGlzaW9uRmlsdGVyTWFzaykgPT09IDAgfHwgKGJvZHkuY29sbGlzaW9uRmlsdGVyR3JvdXAgJiB0aGlzLmNvbGxpc2lvbkZpbHRlck1hc2spID09PSAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCB4aSA9IGludGVyc2VjdEJvZHlfeGk7CiAgICAgIGNvbnN0IHFpID0gaW50ZXJzZWN0Qm9keV9xaTsKCiAgICAgIGZvciAobGV0IGkgPSAwLCBOID0gYm9keS5zaGFwZXMubGVuZ3RoOyBpIDwgTjsgaSsrKSB7CiAgICAgICAgY29uc3Qgc2hhcGUgPSBib2R5LnNoYXBlc1tpXTsKCiAgICAgICAgaWYgKGNoZWNrQ29sbGlzaW9uUmVzcG9uc2UgJiYgIXNoYXBlLmNvbGxpc2lvblJlc3BvbnNlKSB7CiAgICAgICAgICBjb250aW51ZTsgLy8gU2tpcAogICAgICAgIH0KCiAgICAgICAgYm9keS5xdWF0ZXJuaW9uLm11bHQoYm9keS5zaGFwZU9yaWVudGF0aW9uc1tpXSwgcWkpOwogICAgICAgIGJvZHkucXVhdGVybmlvbi52bXVsdChib2R5LnNoYXBlT2Zmc2V0c1tpXSwgeGkpOwogICAgICAgIHhpLnZhZGQoYm9keS5wb3NpdGlvbiwgeGkpOwogICAgICAgIHRoaXMuaW50ZXJzZWN0U2hhcGUoc2hhcGUsIHFpLCB4aSwgYm9keSk7CgogICAgICAgIGlmICh0aGlzLnJlc3VsdC5zaG91bGRTdG9wKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogU2hvb3QgYSByYXkgYXQgYW4gYXJyYXkgYm9kaWVzLCBnZXQgYmFjayBpbmZvcm1hdGlvbiBhYm91dCB0aGUgaGl0LgogICAgICogQHBhcmFtIGJvZGllcyBBbiBhcnJheSBvZiBCb2R5IG9iamVjdHMuCiAgICAgKiBAZGVwcmVjYXRlZCBAcGFyYW0gcmVzdWx0IHNldCB0aGUgcmVzdWx0IHByb3BlcnR5IG9mIHRoZSBSYXkgaW5zdGVhZC4KICAgICAqCiAgICAgKi8KCgogICAgaW50ZXJzZWN0Qm9kaWVzKGJvZGllcywgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICB0aGlzLnJlc3VsdCA9IHJlc3VsdDsKICAgICAgICB0aGlzLnVwZGF0ZURpcmVjdGlvbigpOwogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGJvZGllcy5sZW5ndGg7ICF0aGlzLnJlc3VsdC5zaG91bGRTdG9wICYmIGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLmludGVyc2VjdEJvZHkoYm9kaWVzW2ldKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGVzIHRoZSBkaXJlY3Rpb24gdmVjdG9yLgogICAgICovCgoKICAgIHVwZGF0ZURpcmVjdGlvbigpIHsKICAgICAgdGhpcy50by52c3ViKHRoaXMuZnJvbSwgdGhpcy5kaXJlY3Rpb24pOwogICAgICB0aGlzLmRpcmVjdGlvbi5ub3JtYWxpemUoKTsKICAgIH0KCiAgICBpbnRlcnNlY3RTaGFwZShzaGFwZSwgcXVhdCwgcG9zaXRpb24sIGJvZHkpIHsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsgLy8gQ2hlY2tpbmcgYm91bmRpbmdTcGhlcmUKCiAgICAgIGNvbnN0IGRpc3RhbmNlID0gZGlzdGFuY2VGcm9tSW50ZXJzZWN0aW9uKGZyb20sIHRoaXMuZGlyZWN0aW9uLCBwb3NpdGlvbik7CgogICAgICBpZiAoZGlzdGFuY2UgPiBzaGFwZS5ib3VuZGluZ1NwaGVyZVJhZGl1cykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgaW50ZXJzZWN0TWV0aG9kID0gdGhpc1tzaGFwZS50eXBlXTsKCiAgICAgIGlmIChpbnRlcnNlY3RNZXRob2QpIHsKICAgICAgICBpbnRlcnNlY3RNZXRob2QuY2FsbCh0aGlzLCBzaGFwZSwgcXVhdCwgcG9zaXRpb24sIGJvZHksIHNoYXBlKTsKICAgICAgfQogICAgfQoKICAgIF9pbnRlcnNlY3RCb3goYm94LCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSkgewogICAgICByZXR1cm4gdGhpcy5faW50ZXJzZWN0Q29udmV4KGJveC5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHF1YXQsIHBvc2l0aW9uLCBib2R5LCByZXBvcnRlZFNoYXBlKTsKICAgIH0KCiAgICBfaW50ZXJzZWN0UGxhbmUoc2hhcGUsIHF1YXQsIHBvc2l0aW9uLCBib2R5LCByZXBvcnRlZFNoYXBlKSB7CiAgICAgIGNvbnN0IGZyb20gPSB0aGlzLmZyb207CiAgICAgIGNvbnN0IHRvID0gdGhpcy50bzsKICAgICAgY29uc3QgZGlyZWN0aW9uID0gdGhpcy5kaXJlY3Rpb247IC8vIEdldCBwbGFuZSBub3JtYWwKCiAgICAgIGNvbnN0IHdvcmxkTm9ybWFsID0gbmV3IFZlYzMoMCwgMCwgMSk7CiAgICAgIHF1YXQudm11bHQod29ybGROb3JtYWwsIHdvcmxkTm9ybWFsKTsKICAgICAgY29uc3QgbGVuID0gbmV3IFZlYzMoKTsKICAgICAgZnJvbS52c3ViKHBvc2l0aW9uLCBsZW4pOwogICAgICBjb25zdCBwbGFuZVRvRnJvbSA9IGxlbi5kb3Qod29ybGROb3JtYWwpOwogICAgICB0by52c3ViKHBvc2l0aW9uLCBsZW4pOwogICAgICBjb25zdCBwbGFuZVRvVG8gPSBsZW4uZG90KHdvcmxkTm9ybWFsKTsKCiAgICAgIGlmIChwbGFuZVRvRnJvbSAqIHBsYW5lVG9UbyA+IDApIHsKICAgICAgICAvLyAiZnJvbSIgYW5kICJ0byIgYXJlIG9uIHRoZSBzYW1lIHNpZGUgb2YgdGhlIHBsYW5lLi4uIGJhaWwgb3V0CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoZnJvbS5kaXN0YW5jZVRvKHRvKSA8IHBsYW5lVG9Gcm9tKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBuX2RvdF9kaXIgPSB3b3JsZE5vcm1hbC5kb3QoZGlyZWN0aW9uKTsKCiAgICAgIGlmIChNYXRoLmFicyhuX2RvdF9kaXIpIDwgdGhpcy5wcmVjaXNpb24pIHsKICAgICAgICAvLyBObyBpbnRlcnNlY3Rpb24KICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNvbnN0IHBsYW5lUG9pbnRUb0Zyb20gPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBkaXJfc2NhbGVkX3dpdGhfdCA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IGhpdFBvaW50V29ybGQgPSBuZXcgVmVjMygpOwogICAgICBmcm9tLnZzdWIocG9zaXRpb24sIHBsYW5lUG9pbnRUb0Zyb20pOwogICAgICBjb25zdCB0ID0gLXdvcmxkTm9ybWFsLmRvdChwbGFuZVBvaW50VG9Gcm9tKSAvIG5fZG90X2RpcjsKICAgICAgZGlyZWN0aW9uLnNjYWxlKHQsIGRpcl9zY2FsZWRfd2l0aF90KTsKICAgICAgZnJvbS52YWRkKGRpcl9zY2FsZWRfd2l0aF90LCBoaXRQb2ludFdvcmxkKTsKICAgICAgdGhpcy5yZXBvcnRJbnRlcnNlY3Rpb24od29ybGROb3JtYWwsIGhpdFBvaW50V29ybGQsIHJlcG9ydGVkU2hhcGUsIGJvZHksIC0xKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB3b3JsZCBBQUJCIG9mIHRoZSByYXkuCiAgICAgKi8KCgogICAgZ2V0QUFCQihhYWJiKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBsb3dlckJvdW5kLAogICAgICAgIHVwcGVyQm91bmQKICAgICAgfSA9IGFhYmI7CiAgICAgIGNvbnN0IHRvID0gdGhpcy50bzsKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgbG93ZXJCb3VuZC54ID0gTWF0aC5taW4odG8ueCwgZnJvbS54KTsKICAgICAgbG93ZXJCb3VuZC55ID0gTWF0aC5taW4odG8ueSwgZnJvbS55KTsKICAgICAgbG93ZXJCb3VuZC56ID0gTWF0aC5taW4odG8ueiwgZnJvbS56KTsKICAgICAgdXBwZXJCb3VuZC54ID0gTWF0aC5tYXgodG8ueCwgZnJvbS54KTsKICAgICAgdXBwZXJCb3VuZC55ID0gTWF0aC5tYXgodG8ueSwgZnJvbS55KTsKICAgICAgdXBwZXJCb3VuZC56ID0gTWF0aC5tYXgodG8ueiwgZnJvbS56KTsKICAgIH0KCiAgICBfaW50ZXJzZWN0SGVpZ2h0ZmllbGQoc2hhcGUsIHF1YXQsIHBvc2l0aW9uLCBib2R5LCByZXBvcnRlZFNoYXBlKSB7CiAgICAgIHNoYXBlLmRhdGE7CiAgICAgIHNoYXBlLmVsZW1lbnRTaXplOyAvLyBDb252ZXJ0IHRoZSByYXkgdG8gbG9jYWwgaGVpZ2h0ZmllbGQgY29vcmRpbmF0ZXMKCiAgICAgIGNvbnN0IGxvY2FsUmF5ID0gaW50ZXJzZWN0SGVpZ2h0ZmllbGRfbG9jYWxSYXk7IC8vbmV3IFJheSh0aGlzLmZyb20sIHRoaXMudG8pOwoKICAgICAgbG9jYWxSYXkuZnJvbS5jb3B5KHRoaXMuZnJvbSk7CiAgICAgIGxvY2FsUmF5LnRvLmNvcHkodGhpcy50byk7CiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZShwb3NpdGlvbiwgcXVhdCwgbG9jYWxSYXkuZnJvbSwgbG9jYWxSYXkuZnJvbSk7CiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZShwb3NpdGlvbiwgcXVhdCwgbG9jYWxSYXkudG8sIGxvY2FsUmF5LnRvKTsKICAgICAgbG9jYWxSYXkudXBkYXRlRGlyZWN0aW9uKCk7IC8vIEdldCB0aGUgaW5kZXggb2YgdGhlIGRhdGEgcG9pbnRzIHRvIHRlc3QgYWdhaW5zdAoKICAgICAgY29uc3QgaW5kZXggPSBpbnRlcnNlY3RIZWlnaHRmaWVsZF9pbmRleDsKICAgICAgbGV0IGlNaW5YOwogICAgICBsZXQgaU1pblk7CiAgICAgIGxldCBpTWF4WDsKICAgICAgbGV0IGlNYXhZOyAvLyBTZXQgdG8gbWF4CgogICAgICBpTWluWCA9IGlNaW5ZID0gMDsKICAgICAgaU1heFggPSBpTWF4WSA9IHNoYXBlLmRhdGEubGVuZ3RoIC0gMTsKICAgICAgY29uc3QgYWFiYiA9IG5ldyBBQUJCKCk7CiAgICAgIGxvY2FsUmF5LmdldEFBQkIoYWFiYik7CiAgICAgIHNoYXBlLmdldEluZGV4T2ZQb3NpdGlvbihhYWJiLmxvd2VyQm91bmQueCwgYWFiYi5sb3dlckJvdW5kLnksIGluZGV4LCB0cnVlKTsKICAgICAgaU1pblggPSBNYXRoLm1heChpTWluWCwgaW5kZXhbMF0pOwogICAgICBpTWluWSA9IE1hdGgubWF4KGlNaW5ZLCBpbmRleFsxXSk7CiAgICAgIHNoYXBlLmdldEluZGV4T2ZQb3NpdGlvbihhYWJiLnVwcGVyQm91bmQueCwgYWFiYi51cHBlckJvdW5kLnksIGluZGV4LCB0cnVlKTsKICAgICAgaU1heFggPSBNYXRoLm1pbihpTWF4WCwgaW5kZXhbMF0gKyAxKTsKICAgICAgaU1heFkgPSBNYXRoLm1pbihpTWF4WSwgaW5kZXhbMV0gKyAxKTsKCiAgICAgIGZvciAobGV0IGkgPSBpTWluWDsgaSA8IGlNYXhYOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gaU1pblk7IGogPCBpTWF4WTsgaisrKSB7CiAgICAgICAgICBpZiAodGhpcy5yZXN1bHQuc2hvdWxkU3RvcCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgc2hhcGUuZ2V0QWFiYkF0SW5kZXgoaSwgaiwgYWFiYik7CgogICAgICAgICAgaWYgKCFhYWJiLm92ZXJsYXBzUmF5KGxvY2FsUmF5KSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0gLy8gTG93ZXIgdHJpYW5nbGUKCgogICAgICAgICAgc2hhcGUuZ2V0Q29udmV4VHJpYW5nbGVQaWxsYXIoaSwgaiwgZmFsc2UpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHBvc2l0aW9uLCBxdWF0LCBzaGFwZS5waWxsYXJPZmZzZXQsIHdvcmxkUGlsbGFyT2Zmc2V0KTsKCiAgICAgICAgICB0aGlzLl9pbnRlcnNlY3RDb252ZXgoc2hhcGUucGlsbGFyQ29udmV4LCBxdWF0LCB3b3JsZFBpbGxhck9mZnNldCwgYm9keSwgcmVwb3J0ZWRTaGFwZSwgaW50ZXJzZWN0Q29udmV4T3B0aW9ucyk7CgogICAgICAgICAgaWYgKHRoaXMucmVzdWx0LnNob3VsZFN0b3ApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSAvLyBVcHBlciB0cmlhbmdsZQoKCiAgICAgICAgICBzaGFwZS5nZXRDb252ZXhUcmlhbmdsZVBpbGxhcihpLCBqLCB0cnVlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShwb3NpdGlvbiwgcXVhdCwgc2hhcGUucGlsbGFyT2Zmc2V0LCB3b3JsZFBpbGxhck9mZnNldCk7CgogICAgICAgICAgdGhpcy5faW50ZXJzZWN0Q29udmV4KHNoYXBlLnBpbGxhckNvbnZleCwgcXVhdCwgd29ybGRQaWxsYXJPZmZzZXQsIGJvZHksIHJlcG9ydGVkU2hhcGUsIGludGVyc2VjdENvbnZleE9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIF9pbnRlcnNlY3RTcGhlcmUoc3BoZXJlLCBxdWF0LCBwb3NpdGlvbiwgYm9keSwgcmVwb3J0ZWRTaGFwZSkgewogICAgICBjb25zdCBmcm9tID0gdGhpcy5mcm9tOwogICAgICBjb25zdCB0byA9IHRoaXMudG87CiAgICAgIGNvbnN0IHIgPSBzcGhlcmUucmFkaXVzOwogICAgICBjb25zdCBhID0gKHRvLnggLSBmcm9tLngpICoqIDIgKyAodG8ueSAtIGZyb20ueSkgKiogMiArICh0by56IC0gZnJvbS56KSAqKiAyOwogICAgICBjb25zdCBiID0gMiAqICgodG8ueCAtIGZyb20ueCkgKiAoZnJvbS54IC0gcG9zaXRpb24ueCkgKyAodG8ueSAtIGZyb20ueSkgKiAoZnJvbS55IC0gcG9zaXRpb24ueSkgKyAodG8ueiAtIGZyb20ueikgKiAoZnJvbS56IC0gcG9zaXRpb24ueikpOwogICAgICBjb25zdCBjID0gKGZyb20ueCAtIHBvc2l0aW9uLngpICoqIDIgKyAoZnJvbS55IC0gcG9zaXRpb24ueSkgKiogMiArIChmcm9tLnogLSBwb3NpdGlvbi56KSAqKiAyIC0gciAqKiAyOwogICAgICBjb25zdCBkZWx0YSA9IGIgKiogMiAtIDQgKiBhICogYzsKICAgICAgY29uc3QgaW50ZXJzZWN0aW9uUG9pbnQgPSBSYXlfaW50ZXJzZWN0U3BoZXJlX2ludGVyc2VjdGlvblBvaW50OwogICAgICBjb25zdCBub3JtYWwgPSBSYXlfaW50ZXJzZWN0U3BoZXJlX25vcm1hbDsKCiAgICAgIGlmIChkZWx0YSA8IDApIHsKICAgICAgICAvLyBObyBpbnRlcnNlY3Rpb24KICAgICAgICByZXR1cm47CiAgICAgIH0gZWxzZSBpZiAoZGVsdGEgPT09IDApIHsKICAgICAgICAvLyBzaW5nbGUgaW50ZXJzZWN0aW9uIHBvaW50CiAgICAgICAgZnJvbS5sZXJwKHRvLCBkZWx0YSwgaW50ZXJzZWN0aW9uUG9pbnQpOwogICAgICAgIGludGVyc2VjdGlvblBvaW50LnZzdWIocG9zaXRpb24sIG5vcm1hbCk7CiAgICAgICAgbm9ybWFsLm5vcm1hbGl6ZSgpOwogICAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKG5vcm1hbCwgaW50ZXJzZWN0aW9uUG9pbnQsIHJlcG9ydGVkU2hhcGUsIGJvZHksIC0xKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBkMSA9ICgtYiAtIE1hdGguc3FydChkZWx0YSkpIC8gKDIgKiBhKTsKICAgICAgICBjb25zdCBkMiA9ICgtYiArIE1hdGguc3FydChkZWx0YSkpIC8gKDIgKiBhKTsKCiAgICAgICAgaWYgKGQxID49IDAgJiYgZDEgPD0gMSkgewogICAgICAgICAgZnJvbS5sZXJwKHRvLCBkMSwgaW50ZXJzZWN0aW9uUG9pbnQpOwogICAgICAgICAgaW50ZXJzZWN0aW9uUG9pbnQudnN1Yihwb3NpdGlvbiwgbm9ybWFsKTsKICAgICAgICAgIG5vcm1hbC5ub3JtYWxpemUoKTsKICAgICAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKG5vcm1hbCwgaW50ZXJzZWN0aW9uUG9pbnQsIHJlcG9ydGVkU2hhcGUsIGJvZHksIC0xKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnJlc3VsdC5zaG91bGRTdG9wKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZDIgPj0gMCAmJiBkMiA8PSAxKSB7CiAgICAgICAgICBmcm9tLmxlcnAodG8sIGQyLCBpbnRlcnNlY3Rpb25Qb2ludCk7CiAgICAgICAgICBpbnRlcnNlY3Rpb25Qb2ludC52c3ViKHBvc2l0aW9uLCBub3JtYWwpOwogICAgICAgICAgbm9ybWFsLm5vcm1hbGl6ZSgpOwogICAgICAgICAgdGhpcy5yZXBvcnRJbnRlcnNlY3Rpb24obm9ybWFsLCBpbnRlcnNlY3Rpb25Qb2ludCwgcmVwb3J0ZWRTaGFwZSwgYm9keSwgLTEpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIF9pbnRlcnNlY3RDb252ZXgoc2hhcGUsIHF1YXQsIHBvc2l0aW9uLCBib2R5LCByZXBvcnRlZFNoYXBlLCBvcHRpb25zKSB7CiAgICAgIGNvbnN0IG5vcm1hbCA9IGludGVyc2VjdENvbnZleF9ub3JtYWw7CiAgICAgIGNvbnN0IHZlY3RvciA9IGludGVyc2VjdENvbnZleF92ZWN0b3I7CiAgICAgIGNvbnN0IGZhY2VMaXN0ID0gb3B0aW9ucyAmJiBvcHRpb25zLmZhY2VMaXN0IHx8IG51bGw7IC8vIENoZWNraW5nIGZhY2VzCgogICAgICBjb25zdCBmYWNlcyA9IHNoYXBlLmZhY2VzOwogICAgICBjb25zdCB2ZXJ0aWNlcyA9IHNoYXBlLnZlcnRpY2VzOwogICAgICBjb25zdCBub3JtYWxzID0gc2hhcGUuZmFjZU5vcm1hbHM7CiAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IHRoaXMuZGlyZWN0aW9uOwogICAgICBjb25zdCBmcm9tID0gdGhpcy5mcm9tOwogICAgICBjb25zdCB0byA9IHRoaXMudG87CiAgICAgIGNvbnN0IGZyb21Ub0Rpc3RhbmNlID0gZnJvbS5kaXN0YW5jZVRvKHRvKTsKICAgICAgY29uc3QgTmZhY2VzID0gZmFjZUxpc3QgPyBmYWNlTGlzdC5sZW5ndGggOiBmYWNlcy5sZW5ndGg7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucmVzdWx0OwoKICAgICAgZm9yIChsZXQgaiA9IDA7ICFyZXN1bHQuc2hvdWxkU3RvcCAmJiBqIDwgTmZhY2VzOyBqKyspIHsKICAgICAgICBjb25zdCBmaSA9IGZhY2VMaXN0ID8gZmFjZUxpc3Rbal0gOiBqOwogICAgICAgIGNvbnN0IGZhY2UgPSBmYWNlc1tmaV07CiAgICAgICAgY29uc3QgZmFjZU5vcm1hbCA9IG5vcm1hbHNbZmldOwogICAgICAgIGNvbnN0IHEgPSBxdWF0OwogICAgICAgIGNvbnN0IHggPSBwb3NpdGlvbjsgLy8gZGV0ZXJtaW5lIGlmIHJheSBpbnRlcnNlY3RzIHRoZSBwbGFuZSBvZiB0aGUgZmFjZQogICAgICAgIC8vIG5vdGU6IHRoaXMgd29ya3MgcmVnYXJkbGVzcyBvZiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBmYWNlIG5vcm1hbAogICAgICAgIC8vIEdldCBwbGFuZSBwb2ludCBpbiB3b3JsZCBjb29yZGluYXRlcy4uLgoKICAgICAgICB2ZWN0b3IuY29weSh2ZXJ0aWNlc1tmYWNlWzBdXSk7CiAgICAgICAgcS52bXVsdCh2ZWN0b3IsIHZlY3Rvcik7CiAgICAgICAgdmVjdG9yLnZhZGQoeCwgdmVjdG9yKTsgLy8gLi4uYnV0IG1ha2UgaXQgcmVsYXRpdmUgdG8gdGhlIHJheSBmcm9tLiBXZSdsbCBmaXggdGhpcyBsYXRlci4KCiAgICAgICAgdmVjdG9yLnZzdWIoZnJvbSwgdmVjdG9yKTsgLy8gR2V0IHBsYW5lIG5vcm1hbAoKICAgICAgICBxLnZtdWx0KGZhY2VOb3JtYWwsIG5vcm1hbCk7IC8vIElmIHRoaXMgZG90IHByb2R1Y3QgaXMgbmVnYXRpdmUsIHdlIGhhdmUgc29tZXRoaW5nIGludGVyZXN0aW5nCgogICAgICAgIGNvbnN0IGRvdCA9IGRpcmVjdGlvbi5kb3Qobm9ybWFsKTsgLy8gQmFpbCBvdXQgaWYgcmF5IGFuZCBwbGFuZSBhcmUgcGFyYWxsZWwKCiAgICAgICAgaWYgKE1hdGguYWJzKGRvdCkgPCB0aGlzLnByZWNpc2lvbikgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSAvLyBjYWxjIGRpc3RhbmNlIHRvIHBsYW5lCgoKICAgICAgICBjb25zdCBzY2FsYXIgPSBub3JtYWwuZG90KHZlY3RvcikgLyBkb3Q7IC8vIGlmIG5lZ2F0aXZlIGRpc3RhbmNlLCB0aGVuIHBsYW5lIGlzIGJlaGluZCByYXkKCiAgICAgICAgaWYgKHNjYWxhciA8IDApIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gLy8gaWYgKGRvdCA8IDApIHsKICAgICAgICAvLyBJbnRlcnNlY3Rpb24gcG9pbnQgaXMgZnJvbSArIGRpcmVjdGlvbiAqIHNjYWxhcgoKCiAgICAgICAgZGlyZWN0aW9uLnNjYWxlKHNjYWxhciwgaW50ZXJzZWN0UG9pbnQpOwogICAgICAgIGludGVyc2VjdFBvaW50LnZhZGQoZnJvbSwgaW50ZXJzZWN0UG9pbnQpOyAvLyBhIGlzIHRoZSBwb2ludCB3ZSBjb21wYXJlIHBvaW50cyBiIGFuZCBjIHdpdGguCgogICAgICAgIGEuY29weSh2ZXJ0aWNlc1tmYWNlWzBdXSk7CiAgICAgICAgcS52bXVsdChhLCBhKTsKICAgICAgICB4LnZhZGQoYSwgYSk7CgogICAgICAgIGZvciAobGV0IGkgPSAxOyAhcmVzdWx0LnNob3VsZFN0b3AgJiYgaSA8IGZhY2UubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAvLyBUcmFuc2Zvcm0gMyB2ZXJ0aWNlcyB0byB3b3JsZCBjb29yZHMKICAgICAgICAgIGIuY29weSh2ZXJ0aWNlc1tmYWNlW2ldXSk7CiAgICAgICAgICBjLmNvcHkodmVydGljZXNbZmFjZVtpICsgMV1dKTsKICAgICAgICAgIHEudm11bHQoYiwgYik7CiAgICAgICAgICBxLnZtdWx0KGMsIGMpOwogICAgICAgICAgeC52YWRkKGIsIGIpOwogICAgICAgICAgeC52YWRkKGMsIGMpOwogICAgICAgICAgY29uc3QgZGlzdGFuY2UgPSBpbnRlcnNlY3RQb2ludC5kaXN0YW5jZVRvKGZyb20pOwoKICAgICAgICAgIGlmICghKFJheS5wb2ludEluVHJpYW5nbGUoaW50ZXJzZWN0UG9pbnQsIGEsIGIsIGMpIHx8IFJheS5wb2ludEluVHJpYW5nbGUoaW50ZXJzZWN0UG9pbnQsIGIsIGEsIGMpKSB8fCBkaXN0YW5jZSA+IGZyb21Ub0Rpc3RhbmNlKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKG5vcm1hbCwgaW50ZXJzZWN0UG9pbnQsIHJlcG9ydGVkU2hhcGUsIGJvZHksIGZpKTsKICAgICAgICB9IC8vIH0KCiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQHRvZG8gT3B0aW1pemUgYnkgdHJhbnNmb3JtaW5nIHRoZSB3b3JsZCB0byBsb2NhbCBzcGFjZSBmaXJzdC4KICAgICAqIEB0b2RvIFVzZSBPY3RyZWUgbG9va3VwCiAgICAgKi8KCgogICAgX2ludGVyc2VjdFRyaW1lc2gobWVzaCwgcXVhdCwgcG9zaXRpb24sIGJvZHksIHJlcG9ydGVkU2hhcGUsIG9wdGlvbnMpIHsKICAgICAgY29uc3Qgbm9ybWFsID0gaW50ZXJzZWN0VHJpbWVzaF9ub3JtYWw7CiAgICAgIGNvbnN0IHRyaWFuZ2xlcyA9IGludGVyc2VjdFRyaW1lc2hfdHJpYW5nbGVzOwogICAgICBjb25zdCB0cmVlVHJhbnNmb3JtID0gaW50ZXJzZWN0VHJpbWVzaF90cmVlVHJhbnNmb3JtOwogICAgICBjb25zdCB2ZWN0b3IgPSBpbnRlcnNlY3RDb252ZXhfdmVjdG9yOwogICAgICBjb25zdCBsb2NhbERpcmVjdGlvbiA9IGludGVyc2VjdFRyaW1lc2hfbG9jYWxEaXJlY3Rpb247CiAgICAgIGNvbnN0IGxvY2FsRnJvbSA9IGludGVyc2VjdFRyaW1lc2hfbG9jYWxGcm9tOwogICAgICBjb25zdCBsb2NhbFRvID0gaW50ZXJzZWN0VHJpbWVzaF9sb2NhbFRvOwogICAgICBjb25zdCB3b3JsZEludGVyc2VjdFBvaW50ID0gaW50ZXJzZWN0VHJpbWVzaF93b3JsZEludGVyc2VjdFBvaW50OwogICAgICBjb25zdCB3b3JsZE5vcm1hbCA9IGludGVyc2VjdFRyaW1lc2hfd29ybGROb3JtYWw7IC8vIENoZWNraW5nIGZhY2VzCgogICAgICBjb25zdCBpbmRpY2VzID0gbWVzaC5pbmRpY2VzOwogICAgICBtZXNoLnZlcnRpY2VzOyAvLyBjb25zdCBub3JtYWxzID0gbWVzaC5mYWNlTm9ybWFscwoKICAgICAgY29uc3QgZnJvbSA9IHRoaXMuZnJvbTsKICAgICAgY29uc3QgdG8gPSB0aGlzLnRvOwogICAgICBjb25zdCBkaXJlY3Rpb24gPSB0aGlzLmRpcmVjdGlvbjsKICAgICAgdHJlZVRyYW5zZm9ybS5wb3NpdGlvbi5jb3B5KHBvc2l0aW9uKTsKICAgICAgdHJlZVRyYW5zZm9ybS5xdWF0ZXJuaW9uLmNvcHkocXVhdCk7IC8vIFRyYW5zZm9ybSByYXkgdG8gbG9jYWwgc3BhY2UhCgogICAgICBUcmFuc2Zvcm0udmVjdG9yVG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0LCBkaXJlY3Rpb24sIGxvY2FsRGlyZWN0aW9uKTsKICAgICAgVHJhbnNmb3JtLnBvaW50VG9Mb2NhbEZyYW1lKHBvc2l0aW9uLCBxdWF0LCBmcm9tLCBsb2NhbEZyb20pOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUocG9zaXRpb24sIHF1YXQsIHRvLCBsb2NhbFRvKTsKICAgICAgbG9jYWxUby54ICo9IG1lc2guc2NhbGUueDsKICAgICAgbG9jYWxUby55ICo9IG1lc2guc2NhbGUueTsKICAgICAgbG9jYWxUby56ICo9IG1lc2guc2NhbGUuejsKICAgICAgbG9jYWxGcm9tLnggKj0gbWVzaC5zY2FsZS54OwogICAgICBsb2NhbEZyb20ueSAqPSBtZXNoLnNjYWxlLnk7CiAgICAgIGxvY2FsRnJvbS56ICo9IG1lc2guc2NhbGUuejsKICAgICAgbG9jYWxUby52c3ViKGxvY2FsRnJvbSwgbG9jYWxEaXJlY3Rpb24pOwogICAgICBsb2NhbERpcmVjdGlvbi5ub3JtYWxpemUoKTsKICAgICAgY29uc3QgZnJvbVRvRGlzdGFuY2VTcXVhcmVkID0gbG9jYWxGcm9tLmRpc3RhbmNlU3F1YXJlZChsb2NhbFRvKTsKICAgICAgbWVzaC50cmVlLnJheVF1ZXJ5KHRoaXMsIHRyZWVUcmFuc2Zvcm0sIHRyaWFuZ2xlcyk7CgogICAgICBmb3IgKGxldCBpID0gMCwgTiA9IHRyaWFuZ2xlcy5sZW5ndGg7ICF0aGlzLnJlc3VsdC5zaG91bGRTdG9wICYmIGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IHRyaWFuZ2xlc0luZGV4ID0gdHJpYW5nbGVzW2ldOwogICAgICAgIG1lc2guZ2V0Tm9ybWFsKHRyaWFuZ2xlc0luZGV4LCBub3JtYWwpOyAvLyBkZXRlcm1pbmUgaWYgcmF5IGludGVyc2VjdHMgdGhlIHBsYW5lIG9mIHRoZSBmYWNlCiAgICAgICAgLy8gbm90ZTogdGhpcyB3b3JrcyByZWdhcmRsZXNzIG9mIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGZhY2Ugbm9ybWFsCiAgICAgICAgLy8gR2V0IHBsYW5lIHBvaW50IGluIHdvcmxkIGNvb3JkaW5hdGVzLi4uCgogICAgICAgIG1lc2guZ2V0VmVydGV4KGluZGljZXNbdHJpYW5nbGVzSW5kZXggKiAzXSwgYSk7IC8vIC4uLmJ1dCBtYWtlIGl0IHJlbGF0aXZlIHRvIHRoZSByYXkgZnJvbS4gV2UnbGwgZml4IHRoaXMgbGF0ZXIuCgogICAgICAgIGEudnN1Yihsb2NhbEZyb20sIHZlY3Rvcik7IC8vIElmIHRoaXMgZG90IHByb2R1Y3QgaXMgbmVnYXRpdmUsIHdlIGhhdmUgc29tZXRoaW5nIGludGVyZXN0aW5nCgogICAgICAgIGNvbnN0IGRvdCA9IGxvY2FsRGlyZWN0aW9uLmRvdChub3JtYWwpOyAvLyBCYWlsIG91dCBpZiByYXkgYW5kIHBsYW5lIGFyZSBwYXJhbGxlbAogICAgICAgIC8vIGlmIChNYXRoLmFicyggZG90ICkgPCB0aGlzLnByZWNpc2lvbil7CiAgICAgICAgLy8gICAgIGNvbnRpbnVlOwogICAgICAgIC8vIH0KICAgICAgICAvLyBjYWxjIGRpc3RhbmNlIHRvIHBsYW5lCgogICAgICAgIGNvbnN0IHNjYWxhciA9IG5vcm1hbC5kb3QodmVjdG9yKSAvIGRvdDsgLy8gaWYgbmVnYXRpdmUgZGlzdGFuY2UsIHRoZW4gcGxhbmUgaXMgYmVoaW5kIHJheQoKICAgICAgICBpZiAoc2NhbGFyIDwgMCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSAvLyBJbnRlcnNlY3Rpb24gcG9pbnQgaXMgZnJvbSArIGRpcmVjdGlvbiAqIHNjYWxhcgoKCiAgICAgICAgbG9jYWxEaXJlY3Rpb24uc2NhbGUoc2NhbGFyLCBpbnRlcnNlY3RQb2ludCk7CiAgICAgICAgaW50ZXJzZWN0UG9pbnQudmFkZChsb2NhbEZyb20sIGludGVyc2VjdFBvaW50KTsgLy8gR2V0IHRyaWFuZ2xlIHZlcnRpY2VzCgogICAgICAgIG1lc2guZ2V0VmVydGV4KGluZGljZXNbdHJpYW5nbGVzSW5kZXggKiAzICsgMV0sIGIpOwogICAgICAgIG1lc2guZ2V0VmVydGV4KGluZGljZXNbdHJpYW5nbGVzSW5kZXggKiAzICsgMl0sIGMpOwogICAgICAgIGNvbnN0IHNxdWFyZWREaXN0YW5jZSA9IGludGVyc2VjdFBvaW50LmRpc3RhbmNlU3F1YXJlZChsb2NhbEZyb20pOwoKICAgICAgICBpZiAoIShSYXkucG9pbnRJblRyaWFuZ2xlKGludGVyc2VjdFBvaW50LCBiLCBhLCBjKSB8fCBSYXkucG9pbnRJblRyaWFuZ2xlKGludGVyc2VjdFBvaW50LCBhLCBiLCBjKSkgfHwgc3F1YXJlZERpc3RhbmNlID4gZnJvbVRvRGlzdGFuY2VTcXVhcmVkKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IC8vIHRyYW5zZm9ybSBpbnRlcnNlY3Rwb2ludCBhbmQgbm9ybWFsIHRvIHdvcmxkCgoKICAgICAgICBUcmFuc2Zvcm0udmVjdG9yVG9Xb3JsZEZyYW1lKHF1YXQsIG5vcm1hbCwgd29ybGROb3JtYWwpOwogICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShwb3NpdGlvbiwgcXVhdCwgaW50ZXJzZWN0UG9pbnQsIHdvcmxkSW50ZXJzZWN0UG9pbnQpOwogICAgICAgIHRoaXMucmVwb3J0SW50ZXJzZWN0aW9uKHdvcmxkTm9ybWFsLCB3b3JsZEludGVyc2VjdFBvaW50LCByZXBvcnRlZFNoYXBlLCBib2R5LCB0cmlhbmdsZXNJbmRleCk7CiAgICAgIH0KCiAgICAgIHRyaWFuZ2xlcy5sZW5ndGggPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgdGhlIGludGVyc2VjdGlvbnMgc2hvdWxkIGNvbnRpbnVlCiAgICAgKi8KCgogICAgcmVwb3J0SW50ZXJzZWN0aW9uKG5vcm1hbCwgaGl0UG9pbnRXb3JsZCwgc2hhcGUsIGJvZHksIGhpdEZhY2VJbmRleCkgewogICAgICBjb25zdCBmcm9tID0gdGhpcy5mcm9tOwogICAgICBjb25zdCB0byA9IHRoaXMudG87CiAgICAgIGNvbnN0IGRpc3RhbmNlID0gZnJvbS5kaXN0YW5jZVRvKGhpdFBvaW50V29ybGQpOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJlc3VsdDsgLy8gU2tpcCBiYWNrIGZhY2VzPwoKICAgICAgaWYgKHRoaXMuc2tpcEJhY2tmYWNlcyAmJiBub3JtYWwuZG90KHRoaXMuZGlyZWN0aW9uKSA+IDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJlc3VsdC5oaXRGYWNlSW5kZXggPSB0eXBlb2YgaGl0RmFjZUluZGV4ICE9PSAndW5kZWZpbmVkJyA/IGhpdEZhY2VJbmRleCA6IC0xOwoKICAgICAgc3dpdGNoICh0aGlzLm1vZGUpIHsKICAgICAgICBjYXNlIFJheS5BTEw6CiAgICAgICAgICB0aGlzLmhhc0hpdCA9IHRydWU7CiAgICAgICAgICByZXN1bHQuc2V0KGZyb20sIHRvLCBub3JtYWwsIGhpdFBvaW50V29ybGQsIHNoYXBlLCBib2R5LCBkaXN0YW5jZSk7CiAgICAgICAgICByZXN1bHQuaGFzSGl0ID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuY2FsbGJhY2socmVzdWx0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIFJheS5DTE9TRVNUOgogICAgICAgICAgLy8gU3RvcmUgaWYgY2xvc2VyIHRoYW4gY3VycmVudCBjbG9zZXN0CiAgICAgICAgICBpZiAoZGlzdGFuY2UgPCByZXN1bHQuZGlzdGFuY2UgfHwgIXJlc3VsdC5oYXNIaXQpIHsKICAgICAgICAgICAgdGhpcy5oYXNIaXQgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQuaGFzSGl0ID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0LnNldChmcm9tLCB0bywgbm9ybWFsLCBoaXRQb2ludFdvcmxkLCBzaGFwZSwgYm9keSwgZGlzdGFuY2UpOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIFJheS5BTlk6CiAgICAgICAgICAvLyBSZXBvcnQgYW5kIHN0b3AuCiAgICAgICAgICB0aGlzLmhhc0hpdCA9IHRydWU7CiAgICAgICAgICByZXN1bHQuaGFzSGl0ID0gdHJ1ZTsKICAgICAgICAgIHJlc3VsdC5zZXQoZnJvbSwgdG8sIG5vcm1hbCwgaGl0UG9pbnRXb3JsZCwgc2hhcGUsIGJvZHksIGRpc3RhbmNlKTsKICAgICAgICAgIHJlc3VsdC5zaG91bGRTdG9wID0gdHJ1ZTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEFzIHBlciAiQmFyeWNlbnRyaWMgVGVjaG5pcXVlIiBhcyBuYW1lZAogICAgICoge0BsaW5rIGh0dHBzOi8vd3d3LmJsYWNrcGF3bi5jb20vdGV4dHMvcG9pbnRpbnBvbHkvZGVmYXVsdC5odG1sIGhlcmV9IGJ1dCB3aXRob3V0IHRoZSBkaXZpc2lvbgogICAgICovCgoKICAgIHN0YXRpYyBwb2ludEluVHJpYW5nbGUocCwgYSwgYiwgYykgewogICAgICBjLnZzdWIoYSwgdjApOwogICAgICBiLnZzdWIoYSwgdjEpOwogICAgICBwLnZzdWIoYSwgdjIpOwogICAgICBjb25zdCBkb3QwMCA9IHYwLmRvdCh2MCk7CiAgICAgIGNvbnN0IGRvdDAxID0gdjAuZG90KHYxKTsKICAgICAgY29uc3QgZG90MDIgPSB2MC5kb3QodjIpOwogICAgICBjb25zdCBkb3QxMSA9IHYxLmRvdCh2MSk7CiAgICAgIGNvbnN0IGRvdDEyID0gdjEuZG90KHYyKTsKICAgICAgbGV0IHU7CiAgICAgIGxldCB2OwogICAgICByZXR1cm4gKHUgPSBkb3QxMSAqIGRvdDAyIC0gZG90MDEgKiBkb3QxMikgPj0gMCAmJiAodiA9IGRvdDAwICogZG90MTIgLSBkb3QwMSAqIGRvdDAyKSA+PSAwICYmIHUgKyB2IDwgZG90MDAgKiBkb3QxMSAtIGRvdDAxICogZG90MDE7CiAgICB9CgogIH0KCiAgUmF5LkNMT1NFU1QgPSBSQVlfTU9ERVMuQ0xPU0VTVDsKICBSYXkuQU5ZID0gUkFZX01PREVTLkFOWTsKICBSYXkuQUxMID0gUkFZX01PREVTLkFMTDsKICBjb25zdCB0bXBBQUJCJDEgPSBuZXcgQUFCQigpOwogIGNvbnN0IHRtcEFycmF5ID0gW107CiAgY29uc3QgdjEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHYyID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RCb2R5X3hpID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RCb2R5X3FpID0gbmV3IFF1YXRlcm5pb24oKTsKICBjb25zdCBpbnRlcnNlY3RQb2ludCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0Q29udmV4T3B0aW9ucyA9IHsKICAgIGZhY2VMaXN0OiBbMF0KICB9OwogIGNvbnN0IHdvcmxkUGlsbGFyT2Zmc2V0ID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RIZWlnaHRmaWVsZF9sb2NhbFJheSA9IG5ldyBSYXkoKTsKICBjb25zdCBpbnRlcnNlY3RIZWlnaHRmaWVsZF9pbmRleCA9IFtdOwogIGNvbnN0IFJheV9pbnRlcnNlY3RTcGhlcmVfaW50ZXJzZWN0aW9uUG9pbnQgPSBuZXcgVmVjMygpOwogIGNvbnN0IFJheV9pbnRlcnNlY3RTcGhlcmVfbm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RDb252ZXhfbm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RDb252ZXhfdmVjdG9yID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3RUcmltZXNoX25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF9sb2NhbERpcmVjdGlvbiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF9sb2NhbEZyb20gPSBuZXcgVmVjMygpOwogIGNvbnN0IGludGVyc2VjdFRyaW1lc2hfbG9jYWxUbyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF93b3JsZE5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF93b3JsZEludGVyc2VjdFBvaW50ID0gbmV3IFZlYzMoKTsKICBuZXcgQUFCQigpOwogIGNvbnN0IGludGVyc2VjdFRyaW1lc2hfdHJpYW5nbGVzID0gW107CiAgY29uc3QgaW50ZXJzZWN0VHJpbWVzaF90cmVlVHJhbnNmb3JtID0gbmV3IFRyYW5zZm9ybSgpOwogIGNvbnN0IHYwID0gbmV3IFZlYzMoKTsKICBjb25zdCBpbnRlcnNlY3QgPSBuZXcgVmVjMygpOwoKICBmdW5jdGlvbiBkaXN0YW5jZUZyb21JbnRlcnNlY3Rpb24oZnJvbSwgZGlyZWN0aW9uLCBwb3NpdGlvbikgewogICAgLy8gdjAgaXMgdmVjdG9yIGZyb20gZnJvbSB0byBwb3NpdGlvbgogICAgcG9zaXRpb24udnN1Yihmcm9tLCB2MCk7CiAgICBjb25zdCBkb3QgPSB2MC5kb3QoZGlyZWN0aW9uKTsgLy8gaW50ZXJzZWN0ID0gZGlyZWN0aW9uKmRvdCArIGZyb20KCiAgICBkaXJlY3Rpb24uc2NhbGUoZG90LCBpbnRlcnNlY3QpOwogICAgaW50ZXJzZWN0LnZhZGQoZnJvbSwgaW50ZXJzZWN0KTsKICAgIGNvbnN0IGRpc3RhbmNlID0gcG9zaXRpb24uZGlzdGFuY2VUbyhpbnRlcnNlY3QpOwogICAgcmV0dXJuIGRpc3RhbmNlOwogIH0KICAvKioKICAgKiBTd2VlcCBhbmQgcHJ1bmUgYnJvYWRwaGFzZSBhbG9uZyBvbmUgYXhpcy4KICAgKi8KCgogIGNsYXNzIFNBUEJyb2FkcGhhc2UgZXh0ZW5kcyBCcm9hZHBoYXNlIHsKICAgIC8qKgogICAgICogTGlzdCBvZiBib2RpZXMgY3VycmVudGx5IGluIHRoZSBicm9hZHBoYXNlLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgd29ybGQgdG8gc2VhcmNoIGluLgogICAgICovCgogICAgLyoqCiAgICAgKiBBeGlzIHRvIHNvcnQgdGhlIGJvZGllcyBhbG9uZy4KICAgICAqIFNldCB0byAwIGZvciB4IGF4aXMsIGFuZCAxIGZvciB5IGF4aXMuCiAgICAgKiBGb3IgYmVzdCBwZXJmb3JtYW5jZSwgcGljayB0aGUgYXhpcyB3aGVyZSBib2RpZXMgYXJlIG1vc3QgZGlzdHJpYnV0ZWQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoZSBib3VuZHMgb2YgdHdvIGJvZGllcyBvdmVybGFwLCBhbG9uZyB0aGUgZ2l2ZW4gU0FQIGF4aXMuCiAgICAgKi8KICAgIHN0YXRpYyBjaGVja0JvdW5kcyhiaSwgYmosIGF4aXNJbmRleCkgewogICAgICBsZXQgYmlQb3M7CiAgICAgIGxldCBialBvczsKCiAgICAgIGlmIChheGlzSW5kZXggPT09IDApIHsKICAgICAgICBiaVBvcyA9IGJpLnBvc2l0aW9uLng7CiAgICAgICAgYmpQb3MgPSBiai5wb3NpdGlvbi54OwogICAgICB9IGVsc2UgaWYgKGF4aXNJbmRleCA9PT0gMSkgewogICAgICAgIGJpUG9zID0gYmkucG9zaXRpb24ueTsKICAgICAgICBialBvcyA9IGJqLnBvc2l0aW9uLnk7CiAgICAgIH0gZWxzZSBpZiAoYXhpc0luZGV4ID09PSAyKSB7CiAgICAgICAgYmlQb3MgPSBiaS5wb3NpdGlvbi56OwogICAgICAgIGJqUG9zID0gYmoucG9zaXRpb24uejsKICAgICAgfQoKICAgICAgY29uc3QgcmkgPSBiaS5ib3VuZGluZ1JhZGl1cywKICAgICAgICAgICAgcmogPSBiai5ib3VuZGluZ1JhZGl1cywKICAgICAgICAgICAgYm91bmRBMiA9IGJpUG9zICsgcmksCiAgICAgICAgICAgIGJvdW5kQjEgPSBialBvcyAtIHJqOwogICAgICByZXR1cm4gYm91bmRCMSA8IGJvdW5kQTI7CiAgICB9IC8vIE5vdGU6IHRoZXNlIGFyZSBpZGVudGljYWwsIHNhdmUgZm9yIHgveS96IGxvd2VyYm91bmQKCiAgICAvKioKICAgICAqIGluc2VydGlvblNvcnRYCiAgICAgKi8KCgogICAgc3RhdGljIGluc2VydGlvblNvcnRYKGEpIHsKICAgICAgZm9yIChsZXQgaSA9IDEsIGwgPSBhLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGNvbnN0IHYgPSBhW2ldOwogICAgICAgIGxldCBqOwoKICAgICAgICBmb3IgKGogPSBpIC0gMTsgaiA+PSAwOyBqLS0pIHsKICAgICAgICAgIGlmIChhW2pdLmFhYmIubG93ZXJCb3VuZC54IDw9IHYuYWFiYi5sb3dlckJvdW5kLngpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgYVtqICsgMV0gPSBhW2pdOwogICAgICAgIH0KCiAgICAgICAgYVtqICsgMV0gPSB2OwogICAgICB9CgogICAgICByZXR1cm4gYTsKICAgIH0KICAgIC8qKgogICAgICogaW5zZXJ0aW9uU29ydFkKICAgICAqLwoKCiAgICBzdGF0aWMgaW5zZXJ0aW9uU29ydFkoYSkgewogICAgICBmb3IgKGxldCBpID0gMSwgbCA9IGEubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgY29uc3QgdiA9IGFbaV07CiAgICAgICAgbGV0IGo7CgogICAgICAgIGZvciAoaiA9IGkgLSAxOyBqID49IDA7IGotLSkgewogICAgICAgICAgaWYgKGFbal0uYWFiYi5sb3dlckJvdW5kLnkgPD0gdi5hYWJiLmxvd2VyQm91bmQueSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBhW2ogKyAxXSA9IGFbal07CiAgICAgICAgfQoKICAgICAgICBhW2ogKyAxXSA9IHY7CiAgICAgIH0KCiAgICAgIHJldHVybiBhOwogICAgfQogICAgLyoqCiAgICAgKiBpbnNlcnRpb25Tb3J0WgogICAgICovCgoKICAgIHN0YXRpYyBpbnNlcnRpb25Tb3J0WihhKSB7CiAgICAgIGZvciAobGV0IGkgPSAxLCBsID0gYS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBjb25zdCB2ID0gYVtpXTsKICAgICAgICBsZXQgajsKCiAgICAgICAgZm9yIChqID0gaSAtIDE7IGogPj0gMDsgai0tKSB7CiAgICAgICAgICBpZiAoYVtqXS5hYWJiLmxvd2VyQm91bmQueiA8PSB2LmFhYmIubG93ZXJCb3VuZC56KSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGFbaiArIDFdID0gYVtqXTsKICAgICAgICB9CgogICAgICAgIGFbaiArIDFdID0gdjsKICAgICAgfQoKICAgICAgcmV0dXJuIGE7CiAgICB9CgogICAgY29uc3RydWN0b3Iod29ybGQpIHsKICAgICAgc3VwZXIoKTsKICAgICAgdGhpcy5heGlzTGlzdCA9IHZvaWQgMDsKICAgICAgdGhpcy53b3JsZCA9IHZvaWQgMDsKICAgICAgdGhpcy5heGlzSW5kZXggPSB2b2lkIDA7CiAgICAgIHRoaXMuX2FkZEJvZHlIYW5kbGVyID0gdm9pZCAwOwogICAgICB0aGlzLl9yZW1vdmVCb2R5SGFuZGxlciA9IHZvaWQgMDsKICAgICAgdGhpcy5heGlzTGlzdCA9IFtdOwogICAgICB0aGlzLndvcmxkID0gbnVsbDsKICAgICAgdGhpcy5heGlzSW5kZXggPSAwOwogICAgICBjb25zdCBheGlzTGlzdCA9IHRoaXMuYXhpc0xpc3Q7CgogICAgICB0aGlzLl9hZGRCb2R5SGFuZGxlciA9IGV2ZW50ID0+IHsKICAgICAgICBheGlzTGlzdC5wdXNoKGV2ZW50LmJvZHkpOwogICAgICB9OwoKICAgICAgdGhpcy5fcmVtb3ZlQm9keUhhbmRsZXIgPSBldmVudCA9PiB7CiAgICAgICAgY29uc3QgaWR4ID0gYXhpc0xpc3QuaW5kZXhPZihldmVudC5ib2R5KTsKCiAgICAgICAgaWYgKGlkeCAhPT0gLTEpIHsKICAgICAgICAgIGF4aXNMaXN0LnNwbGljZShpZHgsIDEpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmICh3b3JsZCkgewogICAgICAgIHRoaXMuc2V0V29ybGQod29ybGQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENoYW5nZSB0aGUgd29ybGQKICAgICAqLwoKCiAgICBzZXRXb3JsZCh3b3JsZCkgewogICAgICAvLyBDbGVhciB0aGUgb2xkIGF4aXMgYXJyYXkKICAgICAgdGhpcy5heGlzTGlzdC5sZW5ndGggPSAwOyAvLyBBZGQgYWxsIGJvZGllcyBmcm9tIHRoZSBuZXcgd29ybGQKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd29ybGQuYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5heGlzTGlzdC5wdXNoKHdvcmxkLmJvZGllc1tpXSk7CiAgICAgIH0gLy8gUmVtb3ZlIG9sZCBoYW5kbGVycywgaWYgYW55CgoKICAgICAgd29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcignYWRkQm9keScsIHRoaXMuX2FkZEJvZHlIYW5kbGVyKTsKICAgICAgd29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVtb3ZlQm9keScsIHRoaXMuX3JlbW92ZUJvZHlIYW5kbGVyKTsgLy8gQWRkIGhhbmRsZXJzIHRvIHVwZGF0ZSB0aGUgbGlzdCBvZiBib2RpZXMuCgogICAgICB3b3JsZC5hZGRFdmVudExpc3RlbmVyKCdhZGRCb2R5JywgdGhpcy5fYWRkQm9keUhhbmRsZXIpOwogICAgICB3b3JsZC5hZGRFdmVudExpc3RlbmVyKCdyZW1vdmVCb2R5JywgdGhpcy5fcmVtb3ZlQm9keUhhbmRsZXIpOwogICAgICB0aGlzLndvcmxkID0gd29ybGQ7CiAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDb2xsZWN0IGFsbCBjb2xsaXNpb24gcGFpcnMKICAgICAqLwoKCiAgICBjb2xsaXNpb25QYWlycyh3b3JsZCwgcDEsIHAyKSB7CiAgICAgIGNvbnN0IGJvZGllcyA9IHRoaXMuYXhpc0xpc3Q7CiAgICAgIGNvbnN0IE4gPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBheGlzSW5kZXggPSB0aGlzLmF4aXNJbmRleDsKICAgICAgbGV0IGk7CiAgICAgIGxldCBqOwoKICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICB0aGlzLnNvcnRMaXN0KCk7CiAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICB9IC8vIExvb2sgdGhyb3VnaCB0aGUgbGlzdAoKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGJpID0gYm9kaWVzW2ldOwoKICAgICAgICBmb3IgKGogPSBpICsgMTsgaiA8IE47IGorKykgewogICAgICAgICAgY29uc3QgYmogPSBib2RpZXNbal07CgogICAgICAgICAgaWYgKCF0aGlzLm5lZWRCcm9hZHBoYXNlQ29sbGlzaW9uKGJpLCBiaikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFTQVBCcm9hZHBoYXNlLmNoZWNrQm91bmRzKGJpLCBiaiwgYXhpc0luZGV4KSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLmludGVyc2VjdGlvblRlc3QoYmksIGJqLCBwMSwgcDIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHNvcnRMaXN0KCkgewogICAgICBjb25zdCBheGlzTGlzdCA9IHRoaXMuYXhpc0xpc3Q7CiAgICAgIGNvbnN0IGF4aXNJbmRleCA9IHRoaXMuYXhpc0luZGV4OwogICAgICBjb25zdCBOID0gYXhpc0xpc3QubGVuZ3RoOyAvLyBVcGRhdGUgQUFCQnMKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBiaSA9IGF4aXNMaXN0W2ldOwoKICAgICAgICBpZiAoYmkuYWFiYk5lZWRzVXBkYXRlKSB7CiAgICAgICAgICBiaS51cGRhdGVBQUJCKCk7CiAgICAgICAgfQogICAgICB9IC8vIFNvcnQgdGhlIGxpc3QKCgogICAgICBpZiAoYXhpc0luZGV4ID09PSAwKSB7CiAgICAgICAgU0FQQnJvYWRwaGFzZS5pbnNlcnRpb25Tb3J0WChheGlzTGlzdCk7CiAgICAgIH0gZWxzZSBpZiAoYXhpc0luZGV4ID09PSAxKSB7CiAgICAgICAgU0FQQnJvYWRwaGFzZS5pbnNlcnRpb25Tb3J0WShheGlzTGlzdCk7CiAgICAgIH0gZWxzZSBpZiAoYXhpc0luZGV4ID09PSAyKSB7CiAgICAgICAgU0FQQnJvYWRwaGFzZS5pbnNlcnRpb25Tb3J0WihheGlzTGlzdCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZXMgdGhlIHZhcmlhbmNlIG9mIHRoZSBib2R5IHBvc2l0aW9ucyBhbmQgZXN0aW1hdGVzIHRoZSBiZXN0IGF4aXMgdG8gdXNlLgogICAgICogV2lsbCBhdXRvbWF0aWNhbGx5IHNldCBwcm9wZXJ0eSBgYXhpc0luZGV4YC4KICAgICAqLwoKCiAgICBhdXRvRGV0ZWN0QXhpcygpIHsKICAgICAgbGV0IHN1bVggPSAwOwogICAgICBsZXQgc3VtWDIgPSAwOwogICAgICBsZXQgc3VtWSA9IDA7CiAgICAgIGxldCBzdW1ZMiA9IDA7CiAgICAgIGxldCBzdW1aID0gMDsKICAgICAgbGV0IHN1bVoyID0gMDsKICAgICAgY29uc3QgYm9kaWVzID0gdGhpcy5heGlzTGlzdDsKICAgICAgY29uc3QgTiA9IGJvZGllcy5sZW5ndGg7CiAgICAgIGNvbnN0IGludk4gPSAxIC8gTjsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBiID0gYm9kaWVzW2ldOwogICAgICAgIGNvbnN0IGNlbnRlclggPSBiLnBvc2l0aW9uLng7CiAgICAgICAgc3VtWCArPSBjZW50ZXJYOwogICAgICAgIHN1bVgyICs9IGNlbnRlclggKiBjZW50ZXJYOwogICAgICAgIGNvbnN0IGNlbnRlclkgPSBiLnBvc2l0aW9uLnk7CiAgICAgICAgc3VtWSArPSBjZW50ZXJZOwogICAgICAgIHN1bVkyICs9IGNlbnRlclkgKiBjZW50ZXJZOwogICAgICAgIGNvbnN0IGNlbnRlclogPSBiLnBvc2l0aW9uLno7CiAgICAgICAgc3VtWiArPSBjZW50ZXJaOwogICAgICAgIHN1bVoyICs9IGNlbnRlclogKiBjZW50ZXJaOwogICAgICB9CgogICAgICBjb25zdCB2YXJpYW5jZVggPSBzdW1YMiAtIHN1bVggKiBzdW1YICogaW52TjsKICAgICAgY29uc3QgdmFyaWFuY2VZID0gc3VtWTIgLSBzdW1ZICogc3VtWSAqIGludk47CiAgICAgIGNvbnN0IHZhcmlhbmNlWiA9IHN1bVoyIC0gc3VtWiAqIHN1bVogKiBpbnZOOwoKICAgICAgaWYgKHZhcmlhbmNlWCA+IHZhcmlhbmNlWSkgewogICAgICAgIGlmICh2YXJpYW5jZVggPiB2YXJpYW5jZVopIHsKICAgICAgICAgIHRoaXMuYXhpc0luZGV4ID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5heGlzSW5kZXggPSAyOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh2YXJpYW5jZVkgPiB2YXJpYW5jZVopIHsKICAgICAgICB0aGlzLmF4aXNJbmRleCA9IDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5heGlzSW5kZXggPSAyOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFJldHVybnMgYWxsIHRoZSBib2RpZXMgd2l0aGluIGFuIEFBQkIuCiAgICAgKiBAcGFyYW0gcmVzdWx0IEFuIGFycmF5IHRvIHN0b3JlIHJlc3VsdGluZyBib2RpZXMgaW4uCiAgICAgKi8KCgogICAgYWFiYlF1ZXJ5KHdvcmxkLCBhYWJiLCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gW107CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgdGhpcy5zb3J0TGlzdCgpOwogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgfQoKICAgICAgY29uc3QgYXhpc0luZGV4ID0gdGhpcy5heGlzSW5kZXg7CiAgICAgIGxldCBheGlzID0gJ3gnOwoKICAgICAgaWYgKGF4aXNJbmRleCA9PT0gMSkgewogICAgICAgIGF4aXMgPSAneSc7CiAgICAgIH0KCiAgICAgIGlmIChheGlzSW5kZXggPT09IDIpIHsKICAgICAgICBheGlzID0gJ3onOwogICAgICB9CgogICAgICBjb25zdCBheGlzTGlzdCA9IHRoaXMuYXhpc0xpc3Q7CiAgICAgIGFhYmIubG93ZXJCb3VuZFtheGlzXTsKICAgICAgYWFiYi51cHBlckJvdW5kW2F4aXNdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBheGlzTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGIgPSBheGlzTGlzdFtpXTsKCiAgICAgICAgaWYgKGIuYWFiYk5lZWRzVXBkYXRlKSB7CiAgICAgICAgICBiLnVwZGF0ZUFBQkIoKTsKICAgICAgICB9CgogICAgICAgIGlmIChiLmFhYmIub3ZlcmxhcHMoYWFiYikpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgfQoKICBjbGFzcyBVdGlscyB7CiAgICAvKioKICAgICAqIEV4dGVuZCBhbiBvcHRpb25zIG9iamVjdCB3aXRoIGRlZmF1bHQgdmFsdWVzLgogICAgICogQHBhcmFtIG9wdGlvbnMgVGhlIG9wdGlvbnMgb2JqZWN0LiBNYXkgYmUgZmFsc3k6IGluIHRoaXMgY2FzZSwgYSBuZXcgb2JqZWN0IGlzIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgICogQHBhcmFtIGRlZmF1bHRzIEFuIG9iamVjdCBjb250YWluaW5nIGRlZmF1bHQgdmFsdWVzLgogICAgICogQHJldHVybiBUaGUgbW9kaWZpZWQgb3B0aW9ucyBvYmplY3QuCiAgICAgKi8KICAgIHN0YXRpYyBkZWZhdWx0cyhvcHRpb25zLCBkZWZhdWx0cykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBmb3IgKGxldCBrZXkgaW4gZGVmYXVsdHMpIHsKICAgICAgICBpZiAoIShrZXkgaW4gb3B0aW9ucykpIHsKICAgICAgICAgIG9wdGlvbnNba2V5XSA9IGRlZmF1bHRzW2tleV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3B0aW9uczsKICAgIH0KCiAgfQogIC8qKgogICAqIENvbnN0cmFpbnQgYmFzZSBjbGFzcwogICAqLwoKCiAgY2xhc3MgQ29uc3RyYWludCB7CiAgICAvKioKICAgICAqIEVxdWF0aW9ucyB0byBiZSBzb2x2ZWQgaW4gdGhpcyBjb25zdHJhaW50LgogICAgICovCgogICAgLyoqCiAgICAgKiBCb2R5IEEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEJvZHkgQi4KICAgICAqLwoKICAgIC8qKgogICAgICogU2V0IHRvIGZhbHNlIGlmIHlvdSBkb24ndCB3YW50IHRoZSBib2RpZXMgdG8gY29sbGlkZSB3aGVuIHRoZXkgYXJlIGNvbm5lY3RlZC4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHRoaXMuZXF1YXRpb25zID0gdm9pZCAwOwogICAgICB0aGlzLmJvZHlBID0gdm9pZCAwOwogICAgICB0aGlzLmJvZHlCID0gdm9pZCAwOwogICAgICB0aGlzLmlkID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpZGVDb25uZWN0ZWQgPSB2b2lkIDA7CiAgICAgIG9wdGlvbnMgPSBVdGlscy5kZWZhdWx0cyhvcHRpb25zLCB7CiAgICAgICAgY29sbGlkZUNvbm5lY3RlZDogdHJ1ZSwKICAgICAgICB3YWtlVXBCb2RpZXM6IHRydWUKICAgICAgfSk7CiAgICAgIHRoaXMuZXF1YXRpb25zID0gW107CiAgICAgIHRoaXMuYm9keUEgPSBib2R5QTsKICAgICAgdGhpcy5ib2R5QiA9IGJvZHlCOwogICAgICB0aGlzLmlkID0gQ29uc3RyYWludC5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5jb2xsaWRlQ29ubmVjdGVkID0gb3B0aW9ucy5jb2xsaWRlQ29ubmVjdGVkOwoKICAgICAgaWYgKG9wdGlvbnMud2FrZVVwQm9kaWVzKSB7CiAgICAgICAgaWYgKGJvZHlBKSB7CiAgICAgICAgICBib2R5QS53YWtlVXAoKTsKICAgICAgICB9CgogICAgICAgIGlmIChib2R5QikgewogICAgICAgICAgYm9keUIud2FrZVVwKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSBhbGwgdGhlIGVxdWF0aW9ucyB3aXRoIGRhdGEuCiAgICAgKi8KCgogICAgdXBkYXRlKCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ21ldGhvZCB1cGRhdGUoKSBub3QgaW1wbG1lbWVudGVkIGluIHRoaXMgQ29uc3RyYWludCBzdWJjbGFzcyEnKTsKICAgIH0KICAgIC8qKgogICAgICogRW5hYmxlcyBhbGwgZXF1YXRpb25zIGluIHRoZSBjb25zdHJhaW50LgogICAgICovCgoKICAgIGVuYWJsZSgpIHsKICAgICAgY29uc3QgZXFzID0gdGhpcy5lcXVhdGlvbnM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVxcy5sZW5ndGg7IGkrKykgewogICAgICAgIGVxc1tpXS5lbmFibGVkID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBEaXNhYmxlcyBhbGwgZXF1YXRpb25zIGluIHRoZSBjb25zdHJhaW50LgogICAgICovCgoKICAgIGRpc2FibGUoKSB7CiAgICAgIGNvbnN0IGVxcyA9IHRoaXMuZXF1YXRpb25zOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlcXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBlcXNbaV0uZW5hYmxlZCA9IGZhbHNlOwogICAgICB9CiAgICB9CgogIH0KCiAgQ29uc3RyYWludC5pZENvdW50ZXIgPSAwOwogIC8qKgogICAqIEFuIGVsZW1lbnQgY29udGFpbmluZyA2IGVudHJpZXMsIDMgc3BhdGlhbCBhbmQgMyByb3RhdGlvbmFsIGRlZ3JlZXMgb2YgZnJlZWRvbS4KICAgKi8KCiAgY2xhc3MgSmFjb2JpYW5FbGVtZW50IHsKICAgIC8qKgogICAgICogc3BhdGlhbAogICAgICovCgogICAgLyoqCiAgICAgKiByb3RhdGlvbmFsCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLnNwYXRpYWwgPSB2b2lkIDA7CiAgICAgIHRoaXMucm90YXRpb25hbCA9IHZvaWQgMDsKICAgICAgdGhpcy5zcGF0aWFsID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5yb3RhdGlvbmFsID0gbmV3IFZlYzMoKTsKICAgIH0KICAgIC8qKgogICAgICogTXVsdGlwbHkgd2l0aCBvdGhlciBKYWNvYmlhbkVsZW1lbnQKICAgICAqLwoKCiAgICBtdWx0aXBseUVsZW1lbnQoZWxlbWVudCkgewogICAgICByZXR1cm4gZWxlbWVudC5zcGF0aWFsLmRvdCh0aGlzLnNwYXRpYWwpICsgZWxlbWVudC5yb3RhdGlvbmFsLmRvdCh0aGlzLnJvdGF0aW9uYWwpOwogICAgfQogICAgLyoqCiAgICAgKiBNdWx0aXBseSB3aXRoIHR3byB2ZWN0b3JzCiAgICAgKi8KCgogICAgbXVsdGlwbHlWZWN0b3JzKHNwYXRpYWwsIHJvdGF0aW9uYWwpIHsKICAgICAgcmV0dXJuIHNwYXRpYWwuZG90KHRoaXMuc3BhdGlhbCkgKyByb3RhdGlvbmFsLmRvdCh0aGlzLnJvdGF0aW9uYWwpOwogICAgfQoKICB9CiAgLyoqCiAgICogRXF1YXRpb24gYmFzZSBjbGFzcy4KICAgKgogICAqIGBhYCwgYGJgIGFuZCBgZXBzYCBhcmUge0BsaW5rIGh0dHBzOi8vd3d3OC5jcy51bXUuc2Uva3Vyc2VyLzVEVjA1OC9WVDE1L2xlY3R1cmVzL1NQT09LbGFibm90ZXMucGRmIFNQT09LfSBwYXJhbWV0ZXJzIHRoYXQgZGVmYXVsdCB0byBgMC4wYC4gU2VlIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vc2NodGVwcGUvY2Fubm9uLmpzL2lzc3Vlcy8yMzgjaXNzdWVjb21tZW50LTE0NzE3MjMyNyB0aGlzIGV4Y2hhbmdlfSBmb3IgbW9yZSBkZXRhaWxzIG9uIENhbm5vbidzIHBoeXNpY3MgaW1wbGVtZW50YXRpb24uCiAgICovCgoKICBjbGFzcyBFcXVhdGlvbiB7CiAgICAvKioKICAgICAqIE1pbmltdW0gKHJlYWQ6IG5lZ2F0aXZlIG1heCkgZm9yY2UgdG8gYmUgYXBwbGllZCBieSB0aGUgY29uc3RyYWludC4KICAgICAqLwoKICAgIC8qKgogICAgICogTWF4aW11bSAocmVhZDogcG9zaXRpdmUgbWF4KSBmb3JjZSB0byBiZSBhcHBsaWVkIGJ5IHRoZSBjb25zdHJhaW50LgogICAgICovCgogICAgLyoqCiAgICAgKiBTUE9PSyBwYXJhbWV0ZXIKICAgICAqLwoKICAgIC8qKgogICAgICogU1BPT0sgcGFyYW1ldGVyCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNQT09LIHBhcmFtZXRlcgogICAgICovCgogICAgLyoqCiAgICAgKiBBIG51bWJlciwgcHJvcG9ydGlvbmFsIHRvIHRoZSBmb3JjZSBhZGRlZCB0byB0aGUgYm9kaWVzLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihiaSwgYmosIG1pbkZvcmNlLCBtYXhGb3JjZSkgewogICAgICBpZiAobWluRm9yY2UgPT09IHZvaWQgMCkgewogICAgICAgIG1pbkZvcmNlID0gLTFlNjsKICAgICAgfQoKICAgICAgaWYgKG1heEZvcmNlID09PSB2b2lkIDApIHsKICAgICAgICBtYXhGb3JjZSA9IDFlNjsKICAgICAgfQoKICAgICAgdGhpcy5pZCA9IHZvaWQgMDsKICAgICAgdGhpcy5taW5Gb3JjZSA9IHZvaWQgMDsKICAgICAgdGhpcy5tYXhGb3JjZSA9IHZvaWQgMDsKICAgICAgdGhpcy5iaSA9IHZvaWQgMDsKICAgICAgdGhpcy5iaiA9IHZvaWQgMDsKICAgICAgdGhpcy5zaSA9IHZvaWQgMDsKICAgICAgdGhpcy5zaiA9IHZvaWQgMDsKICAgICAgdGhpcy5hID0gdm9pZCAwOwogICAgICB0aGlzLmIgPSB2b2lkIDA7CiAgICAgIHRoaXMuZXBzID0gdm9pZCAwOwogICAgICB0aGlzLmphY29iaWFuRWxlbWVudEEgPSB2b2lkIDA7CiAgICAgIHRoaXMuamFjb2JpYW5FbGVtZW50QiA9IHZvaWQgMDsKICAgICAgdGhpcy5lbmFibGVkID0gdm9pZCAwOwogICAgICB0aGlzLm11bHRpcGxpZXIgPSB2b2lkIDA7CiAgICAgIHRoaXMuaWQgPSBFcXVhdGlvbi5pZENvdW50ZXIrKzsKICAgICAgdGhpcy5taW5Gb3JjZSA9IG1pbkZvcmNlOwogICAgICB0aGlzLm1heEZvcmNlID0gbWF4Rm9yY2U7CiAgICAgIHRoaXMuYmkgPSBiaTsKICAgICAgdGhpcy5iaiA9IGJqOwogICAgICB0aGlzLmEgPSAwLjA7IC8vIFNQT09LIHBhcmFtZXRlcgoKICAgICAgdGhpcy5iID0gMC4wOyAvLyBTUE9PSyBwYXJhbWV0ZXIKCiAgICAgIHRoaXMuZXBzID0gMC4wOyAvLyBTUE9PSyBwYXJhbWV0ZXIKCiAgICAgIHRoaXMuamFjb2JpYW5FbGVtZW50QSA9IG5ldyBKYWNvYmlhbkVsZW1lbnQoKTsKICAgICAgdGhpcy5qYWNvYmlhbkVsZW1lbnRCID0gbmV3IEphY29iaWFuRWxlbWVudCgpOwogICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwogICAgICB0aGlzLm11bHRpcGxpZXIgPSAwOwogICAgICB0aGlzLnNldFNwb29rUGFyYW1zKDFlNywgNCwgMSAvIDYwKTsgLy8gU2V0IHR5cGljYWwgc3Bvb2sgcGFyYW1zCiAgICB9CiAgICAvKioKICAgICAqIFJlY2FsY3VsYXRlcyBhLCBiLCBhbmQgZXBzLgogICAgICoKICAgICAqIFRoZSBFcXVhdGlvbiBjb25zdHJ1Y3RvciBzZXRzIHR5cGljYWwgU1BPT0sgcGFyYW1ldGVycyBhcyBzdWNoOgogICAgICogKiBgc3RpZmZuZXNzYCA9IDFlNwogICAgICogKiBgcmVsYXhhdGlvbmAgPSA0CiAgICAgKiAqIGB0aW1lU3RlcGA9IDEgLyA2MCwgX25vdGUgdGhlIGhhcmRjb2RlZCByZWZyZXNoIHJhdGUuXwogICAgICovCgoKICAgIHNldFNwb29rUGFyYW1zKHN0aWZmbmVzcywgcmVsYXhhdGlvbiwgdGltZVN0ZXApIHsKICAgICAgY29uc3QgZCA9IHJlbGF4YXRpb247CiAgICAgIGNvbnN0IGsgPSBzdGlmZm5lc3M7CiAgICAgIGNvbnN0IGggPSB0aW1lU3RlcDsKICAgICAgdGhpcy5hID0gNC4wIC8gKGggKiAoMSArIDQgKiBkKSk7CiAgICAgIHRoaXMuYiA9IDQuMCAqIGQgLyAoMSArIDQgKiBkKTsKICAgICAgdGhpcy5lcHMgPSA0LjAgLyAoaCAqIGggKiBrICogKDEgKyA0ICogZCkpOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyB0aGUgcmlnaHQgaGFuZCBzaWRlIG9mIHRoZSBTUE9PSyBlcXVhdGlvbgogICAgICovCgoKICAgIGNvbXB1dGVCKGEsIGIsIGgpIHsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHcSA9IHRoaXMuY29tcHV0ZUdxKCk7CiAgICAgIGNvbnN0IEdpTWYgPSB0aGlzLmNvbXB1dGVHaU1mKCk7CiAgICAgIHJldHVybiAtR3EgKiBhIC0gR1cgKiBiIC0gR2lNZiAqIGg7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIEcqcSwgd2hlcmUgcSBhcmUgdGhlIGdlbmVyYWxpemVkIGJvZHkgY29vcmRpbmF0ZXMKICAgICAqLwoKCiAgICBjb21wdXRlR3EoKSB7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgY29uc3QgYmkgPSB0aGlzLmJpOwogICAgICBjb25zdCBiaiA9IHRoaXMuYmo7CiAgICAgIGNvbnN0IHhpID0gYmkucG9zaXRpb247CiAgICAgIGNvbnN0IHhqID0gYmoucG9zaXRpb247CiAgICAgIHJldHVybiBHQS5zcGF0aWFsLmRvdCh4aSkgKyBHQi5zcGF0aWFsLmRvdCh4aik7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGVzIEcqVywgd2hlcmUgVyBhcmUgdGhlIGJvZHkgdmVsb2NpdGllcwogICAgICovCgoKICAgIGNvbXB1dGVHVygpIHsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgdmkgPSBiaS52ZWxvY2l0eTsKICAgICAgY29uc3QgdmogPSBiai52ZWxvY2l0eTsKICAgICAgY29uc3Qgd2kgPSBiaS5hbmd1bGFyVmVsb2NpdHk7CiAgICAgIGNvbnN0IHdqID0gYmouYW5ndWxhclZlbG9jaXR5OwogICAgICByZXR1cm4gR0EubXVsdGlwbHlWZWN0b3JzKHZpLCB3aSkgKyBHQi5tdWx0aXBseVZlY3RvcnModmosIHdqKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZXMgRypXbGFtYmRhLCB3aGVyZSBXIGFyZSB0aGUgYm9keSB2ZWxvY2l0aWVzCiAgICAgKi8KCgogICAgY29tcHV0ZUdXbGFtYmRhKCkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCB2aSA9IGJpLnZsYW1iZGE7CiAgICAgIGNvbnN0IHZqID0gYmoudmxhbWJkYTsKICAgICAgY29uc3Qgd2kgPSBiaS53bGFtYmRhOwogICAgICBjb25zdCB3aiA9IGJqLndsYW1iZGE7CiAgICAgIHJldHVybiBHQS5tdWx0aXBseVZlY3RvcnModmksIHdpKSArIEdCLm11bHRpcGx5VmVjdG9ycyh2aiwgd2opOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyBHKmludihNKSpmLCB3aGVyZSBNIGlzIHRoZSBtYXNzIG1hdHJpeCB3aXRoIGRpYWdvbmFsIGJsb2NrcyBmb3IgZWFjaCBib2R5LCBhbmQgZiBhcmUgdGhlIGZvcmNlcyBvbiB0aGUgYm9kaWVzLgogICAgICovCgoKICAgIGNvbXB1dGVHaU1mKCkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCBmaSA9IGJpLmZvcmNlOwogICAgICBjb25zdCB0aSA9IGJpLnRvcnF1ZTsKICAgICAgY29uc3QgZmogPSBiai5mb3JjZTsKICAgICAgY29uc3QgdGogPSBiai50b3JxdWU7CiAgICAgIGNvbnN0IGludk1hc3NpID0gYmkuaW52TWFzc1NvbHZlOwogICAgICBjb25zdCBpbnZNYXNzaiA9IGJqLmludk1hc3NTb2x2ZTsKICAgICAgZmkuc2NhbGUoaW52TWFzc2ksIGlNZmkpOwogICAgICBmai5zY2FsZShpbnZNYXNzaiwgaU1maik7CiAgICAgIGJpLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KHRpLCBpbnZJaV92bXVsdF90YXVpKTsKICAgICAgYmouaW52SW5lcnRpYVdvcmxkU29sdmUudm11bHQodGosIGludklqX3ZtdWx0X3RhdWopOwogICAgICByZXR1cm4gR0EubXVsdGlwbHlWZWN0b3JzKGlNZmksIGludklpX3ZtdWx0X3RhdWkpICsgR0IubXVsdGlwbHlWZWN0b3JzKGlNZmosIGludklqX3ZtdWx0X3RhdWopOwogICAgfQogICAgLyoqCiAgICAgKiBDb21wdXRlcyBHKmludihNKSpHJwogICAgICovCgoKICAgIGNvbXB1dGVHaU1HdCgpIHsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOwogICAgICBjb25zdCBiaSA9IHRoaXMuYmk7CiAgICAgIGNvbnN0IGJqID0gdGhpcy5iajsKICAgICAgY29uc3QgaW52TWFzc2kgPSBiaS5pbnZNYXNzU29sdmU7CiAgICAgIGNvbnN0IGludk1hc3NqID0gYmouaW52TWFzc1NvbHZlOwogICAgICBjb25zdCBpbnZJaSA9IGJpLmludkluZXJ0aWFXb3JsZFNvbHZlOwogICAgICBjb25zdCBpbnZJaiA9IGJqLmludkluZXJ0aWFXb3JsZFNvbHZlOwogICAgICBsZXQgcmVzdWx0ID0gaW52TWFzc2kgKyBpbnZNYXNzajsKICAgICAgaW52SWkudm11bHQoR0Eucm90YXRpb25hbCwgdG1wKTsKICAgICAgcmVzdWx0ICs9IHRtcC5kb3QoR0Eucm90YXRpb25hbCk7CiAgICAgIGludklqLnZtdWx0KEdCLnJvdGF0aW9uYWwsIHRtcCk7CiAgICAgIHJlc3VsdCArPSB0bXAuZG90KEdCLnJvdGF0aW9uYWwpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgY29uc3RyYWludCB2ZWxvY2l0eSB0byB0aGUgYm9kaWVzLgogICAgICovCgoKICAgIGFkZFRvV2xhbWJkYShkZWx0YWxhbWJkYSkgewogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IGJpID0gdGhpcy5iaTsKICAgICAgY29uc3QgYmogPSB0aGlzLmJqOwogICAgICBjb25zdCB0ZW1wID0gYWRkVG9XbGFtYmRhX3RlbXA7IC8vIEFkZCB0byBsaW5lYXIgdmVsb2NpdHkKICAgICAgLy8gdl9sYW1iZGEgKz0gaW52KE0pICogZGVsdGFfbGFtYmEgKiBHCgogICAgICBiaS52bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihiaS5pbnZNYXNzU29sdmUgKiBkZWx0YWxhbWJkYSwgR0Euc3BhdGlhbCwgYmkudmxhbWJkYSk7CiAgICAgIGJqLnZsYW1iZGEuYWRkU2NhbGVkVmVjdG9yKGJqLmludk1hc3NTb2x2ZSAqIGRlbHRhbGFtYmRhLCBHQi5zcGF0aWFsLCBiai52bGFtYmRhKTsgLy8gQWRkIHRvIGFuZ3VsYXIgdmVsb2NpdHkKCiAgICAgIGJpLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KEdBLnJvdGF0aW9uYWwsIHRlbXApOwogICAgICBiaS53bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihkZWx0YWxhbWJkYSwgdGVtcCwgYmkud2xhbWJkYSk7CiAgICAgIGJqLmludkluZXJ0aWFXb3JsZFNvbHZlLnZtdWx0KEdCLnJvdGF0aW9uYWwsIHRlbXApOwogICAgICBiai53bGFtYmRhLmFkZFNjYWxlZFZlY3RvcihkZWx0YWxhbWJkYSwgdGVtcCwgYmoud2xhbWJkYSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGUgdGhlIGRlbm9taW5hdG9yIHBhcnQgb2YgdGhlIFNQT09LIGVxdWF0aW9uOiBDID0gRyppbnYoTSkqRycgKyBlcHMKICAgICAqLwoKCiAgICBjb21wdXRlQygpIHsKICAgICAgcmV0dXJuIHRoaXMuY29tcHV0ZUdpTUd0KCkgKyB0aGlzLmVwczsKICAgIH0KCiAgfQoKICBFcXVhdGlvbi5pZENvdW50ZXIgPSAwOwogIGNvbnN0IGlNZmkgPSBuZXcgVmVjMygpOwogIGNvbnN0IGlNZmogPSBuZXcgVmVjMygpOwogIGNvbnN0IGludklpX3ZtdWx0X3RhdWkgPSBuZXcgVmVjMygpOwogIGNvbnN0IGludklqX3ZtdWx0X3RhdWogPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYWRkVG9XbGFtYmRhX3RlbXAgPSBuZXcgVmVjMygpOwogIC8qKgogICAqIENvbnRhY3Qvbm9uLXBlbmV0cmF0aW9uIGNvbnN0cmFpbnQgZXF1YXRpb24KICAgKi8KCiAgY2xhc3MgQ29udGFjdEVxdWF0aW9uIGV4dGVuZHMgRXF1YXRpb24gewogICAgLyoqCiAgICAgKiAiYm91bmNpbmVzcyI6IHUxID0gLWUqdTAKICAgICAqLwoKICAgIC8qKgogICAgICogV29ybGQtb3JpZW50ZWQgdmVjdG9yIHRoYXQgZ29lcyBmcm9tIHRoZSBjZW50ZXIgb2YgYmkgdG8gdGhlIGNvbnRhY3QgcG9pbnQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdvcmxkLW9yaWVudGVkIHZlY3RvciB0aGF0IHN0YXJ0cyBpbiBib2R5IGogcG9zaXRpb24gYW5kIGdvZXMgdG8gdGhlIGNvbnRhY3QgcG9pbnQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIENvbnRhY3Qgbm9ybWFsLCBwb2ludGluZyBvdXQgb2YgYm9keSBpLgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihib2R5QSwgYm9keUIsIG1heEZvcmNlKSB7CiAgICAgIGlmIChtYXhGb3JjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4Rm9yY2UgPSAxZTY7CiAgICAgIH0KCiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgMCwgbWF4Rm9yY2UpOwogICAgICB0aGlzLnJlc3RpdHV0aW9uID0gdm9pZCAwOwogICAgICB0aGlzLnJpID0gdm9pZCAwOwogICAgICB0aGlzLnJqID0gdm9pZCAwOwogICAgICB0aGlzLm5pID0gdm9pZCAwOwogICAgICB0aGlzLnJlc3RpdHV0aW9uID0gMC4wOwogICAgICB0aGlzLnJpID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5yaiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMubmkgPSBuZXcgVmVjMygpOwogICAgfQoKICAgIGNvbXB1dGVCKGgpIHsKICAgICAgY29uc3QgYSA9IHRoaXMuYTsKICAgICAgY29uc3QgYiA9IHRoaXMuYjsKICAgICAgY29uc3QgYmkgPSB0aGlzLmJpOwogICAgICBjb25zdCBiaiA9IHRoaXMuYmo7CiAgICAgIGNvbnN0IHJpID0gdGhpcy5yaTsKICAgICAgY29uc3QgcmogPSB0aGlzLnJqOwogICAgICBjb25zdCByaXhuID0gQ29udGFjdEVxdWF0aW9uX2NvbXB1dGVCX3RlbXAxOwogICAgICBjb25zdCByanhuID0gQ29udGFjdEVxdWF0aW9uX2NvbXB1dGVCX3RlbXAyOwogICAgICBjb25zdCB2aSA9IGJpLnZlbG9jaXR5OwogICAgICBjb25zdCB3aSA9IGJpLmFuZ3VsYXJWZWxvY2l0eTsKICAgICAgYmkuZm9yY2U7CiAgICAgIGJpLnRvcnF1ZTsKICAgICAgY29uc3QgdmogPSBiai52ZWxvY2l0eTsKICAgICAgY29uc3Qgd2ogPSBiai5hbmd1bGFyVmVsb2NpdHk7CiAgICAgIGJqLmZvcmNlOwogICAgICBiai50b3JxdWU7CiAgICAgIGNvbnN0IHBlbmV0cmF0aW9uVmVjID0gQ29udGFjdEVxdWF0aW9uX2NvbXB1dGVCX3RlbXAzOwogICAgICBjb25zdCBHQSA9IHRoaXMuamFjb2JpYW5FbGVtZW50QTsKICAgICAgY29uc3QgR0IgPSB0aGlzLmphY29iaWFuRWxlbWVudEI7CiAgICAgIGNvbnN0IG4gPSB0aGlzLm5pOyAvLyBDYWx1Y2xhdGUgY3Jvc3MgcHJvZHVjdHMKCiAgICAgIHJpLmNyb3NzKG4sIHJpeG4pOwogICAgICByai5jcm9zcyhuLCByanhuKTsgLy8gZyA9IHhqK3JqIC0oeGkrcmkpCiAgICAgIC8vIEcgPSBbIC1uaSAgLXJpeG4gIG5pICByanhuIF0KCiAgICAgIG4ubmVnYXRlKEdBLnNwYXRpYWwpOwogICAgICByaXhuLm5lZ2F0ZShHQS5yb3RhdGlvbmFsKTsKICAgICAgR0Iuc3BhdGlhbC5jb3B5KG4pOwogICAgICBHQi5yb3RhdGlvbmFsLmNvcHkocmp4bik7IC8vIENhbGN1bGF0ZSB0aGUgcGVuZXRyYXRpb24gdmVjdG9yCgogICAgICBwZW5ldHJhdGlvblZlYy5jb3B5KGJqLnBvc2l0aW9uKTsKICAgICAgcGVuZXRyYXRpb25WZWMudmFkZChyaiwgcGVuZXRyYXRpb25WZWMpOwogICAgICBwZW5ldHJhdGlvblZlYy52c3ViKGJpLnBvc2l0aW9uLCBwZW5ldHJhdGlvblZlYyk7CiAgICAgIHBlbmV0cmF0aW9uVmVjLnZzdWIocmksIHBlbmV0cmF0aW9uVmVjKTsKICAgICAgY29uc3QgZyA9IG4uZG90KHBlbmV0cmF0aW9uVmVjKTsgLy8gQ29tcHV0ZSBpdGVyYXRpb24KCiAgICAgIGNvbnN0IGVQbHVzT25lID0gdGhpcy5yZXN0aXR1dGlvbiArIDE7CiAgICAgIGNvbnN0IEdXID0gZVBsdXNPbmUgKiB2ai5kb3QobikgLSBlUGx1c09uZSAqIHZpLmRvdChuKSArIHdqLmRvdChyanhuKSAtIHdpLmRvdChyaXhuKTsKICAgICAgY29uc3QgR2lNZiA9IHRoaXMuY29tcHV0ZUdpTWYoKTsKICAgICAgY29uc3QgQiA9IC1nICogYSAtIEdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjdXJyZW50IHJlbGF0aXZlIHZlbG9jaXR5IGluIHRoZSBjb250YWN0IHBvaW50LgogICAgICovCgoKICAgIGdldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWwoKSB7CiAgICAgIGNvbnN0IHZpID0gQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfdmk7CiAgICAgIGNvbnN0IHZqID0gQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfdmo7CiAgICAgIGNvbnN0IHhpID0gQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfeGk7CiAgICAgIGNvbnN0IHhqID0gQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfeGo7CiAgICAgIGNvbnN0IHJlbFZlbCA9IENvbnRhY3RFcXVhdGlvbl9nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsX3JlbFZlbDsKICAgICAgdGhpcy5iaS5wb3NpdGlvbi52YWRkKHRoaXMucmksIHhpKTsKICAgICAgdGhpcy5iai5wb3NpdGlvbi52YWRkKHRoaXMucmosIHhqKTsKICAgICAgdGhpcy5iaS5nZXRWZWxvY2l0eUF0V29ybGRQb2ludCh4aSwgdmkpOwogICAgICB0aGlzLmJqLmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHhqLCB2aik7CiAgICAgIHZpLnZzdWIodmosIHJlbFZlbCk7CiAgICAgIHJldHVybiB0aGlzLm5pLmRvdChyZWxWZWwpOwogICAgfQoKICB9CgogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9jb21wdXRlQl90ZW1wMSA9IG5ldyBWZWMzKCk7IC8vIFRlbXAgdmVjdG9ycwoKICBjb25zdCBDb250YWN0RXF1YXRpb25fY29tcHV0ZUJfdGVtcDIgPSBuZXcgVmVjMygpOwogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9jb21wdXRlQl90ZW1wMyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfdmkgPSBuZXcgVmVjMygpOwogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsX3ZqID0gbmV3IFZlYzMoKTsKICBjb25zdCBDb250YWN0RXF1YXRpb25fZ2V0SW1wYWN0VmVsb2NpdHlBbG9uZ05vcm1hbF94aSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgQ29udGFjdEVxdWF0aW9uX2dldEltcGFjdFZlbG9jaXR5QWxvbmdOb3JtYWxfeGogPSBuZXcgVmVjMygpOwogIGNvbnN0IENvbnRhY3RFcXVhdGlvbl9nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsX3JlbFZlbCA9IG5ldyBWZWMzKCk7CiAgLyoqCiAgICogQ29ubmVjdHMgdHdvIGJvZGllcyBhdCBnaXZlbiBvZmZzZXQgcG9pbnRzLgogICAqIEBleGFtcGxlCiAgICogICAgIGNvbnN0IGJvZHlBID0gbmV3IEJvZHkoeyBtYXNzOiAxIH0pCiAgICogICAgIGNvbnN0IGJvZHlCID0gbmV3IEJvZHkoeyBtYXNzOiAxIH0pCiAgICogICAgIGJvZHlBLnBvc2l0aW9uLnNldCgtMSwgMCwgMCkKICAgKiAgICAgYm9keUIucG9zaXRpb24uc2V0KDEsIDAsIDApCiAgICogICAgIGJvZHlBLmFkZFNoYXBlKHNoYXBlQSkKICAgKiAgICAgYm9keUIuYWRkU2hhcGUoc2hhcGVCKQogICAqICAgICB3b3JsZC5hZGRCb2R5KGJvZHlBKQogICAqICAgICB3b3JsZC5hZGRCb2R5KGJvZHlCKQogICAqICAgICBjb25zdCBsb2NhbFBpdm90QSA9IG5ldyBWZWMzKDEsIDAsIDApCiAgICogICAgIGNvbnN0IGxvY2FsUGl2b3RCID0gbmV3IFZlYzMoLTEsIDAsIDApCiAgICogICAgIGNvbnN0IGNvbnN0cmFpbnQgPSBuZXcgUG9pbnRUb1BvaW50Q29uc3RyYWludChib2R5QSwgbG9jYWxQaXZvdEEsIGJvZHlCLCBsb2NhbFBpdm90QikKICAgKiAgICAgd29ybGQuYWRkQ29uc3RyYWludChjb25zdHJhaW50KQogICAqLwoKICBjbGFzcyBQb2ludFRvUG9pbnRDb25zdHJhaW50IGV4dGVuZHMgQ29uc3RyYWludCB7CiAgICAvKioKICAgICAqIFBpdm90LCBkZWZpbmVkIGxvY2FsbHkgaW4gYm9keUEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFBpdm90LCBkZWZpbmVkIGxvY2FsbHkgaW4gYm9keUIuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBwYXJhbSBwaXZvdEEgVGhlIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBjZW50ZXIgb2YgbWFzcyBvZiBib2R5QSB3aGljaCBib2R5QSBpcyBjb25zdHJhaW5lZCB0by4KICAgICAqIEBwYXJhbSBib2R5QiBCb2R5IHRoYXQgd2lsbCBiZSBjb25zdHJhaW5lZCBpbiBhIHNpbWlsYXIgd2F5IHRvIHRoZSBzYW1lIHBvaW50IGFzIGJvZHlBLiBXZSB3aWxsIHRoZXJlZm9yZSBnZXQgYSBsaW5rIGJldHdlZW4gYm9keUEgYW5kIGJvZHlCLiBJZiBub3Qgc3BlY2lmaWVkLCBib2R5QSB3aWxsIGJlIGNvbnN0cmFpbmVkIHRvIGEgc3RhdGljIHBvaW50LgogICAgICogQHBhcmFtIHBpdm90QiBUaGUgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIGNlbnRlciBvZiBtYXNzIG9mIGJvZHlCIHdoaWNoIGJvZHlCIGlzIGNvbnN0cmFpbmVkIHRvLgogICAgICogQHBhcmFtIG1heEZvcmNlIFRoZSBtYXhpbXVtIGZvcmNlIHRoYXQgc2hvdWxkIGJlIGFwcGxpZWQgdG8gY29uc3RyYWluIHRoZSBib2RpZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBwaXZvdEEsIGJvZHlCLCBwaXZvdEIsIG1heEZvcmNlKSB7CiAgICAgIGlmIChwaXZvdEEgPT09IHZvaWQgMCkgewogICAgICAgIHBpdm90QSA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGlmIChwaXZvdEIgPT09IHZvaWQgMCkgewogICAgICAgIHBpdm90QiA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIGlmIChtYXhGb3JjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4Rm9yY2UgPSAxZTY7CiAgICAgIH0KCiAgICAgIHN1cGVyKGJvZHlBLCBib2R5Qik7CiAgICAgIHRoaXMucGl2b3RBID0gdm9pZCAwOwogICAgICB0aGlzLnBpdm90QiA9IHZvaWQgMDsKICAgICAgdGhpcy5lcXVhdGlvblggPSB2b2lkIDA7CiAgICAgIHRoaXMuZXF1YXRpb25ZID0gdm9pZCAwOwogICAgICB0aGlzLmVxdWF0aW9uWiA9IHZvaWQgMDsKICAgICAgdGhpcy5waXZvdEEgPSBwaXZvdEEuY2xvbmUoKTsKICAgICAgdGhpcy5waXZvdEIgPSBwaXZvdEIuY2xvbmUoKTsKICAgICAgY29uc3QgeCA9IHRoaXMuZXF1YXRpb25YID0gbmV3IENvbnRhY3RFcXVhdGlvbihib2R5QSwgYm9keUIpOwogICAgICBjb25zdCB5ID0gdGhpcy5lcXVhdGlvblkgPSBuZXcgQ29udGFjdEVxdWF0aW9uKGJvZHlBLCBib2R5Qik7CiAgICAgIGNvbnN0IHogPSB0aGlzLmVxdWF0aW9uWiA9IG5ldyBDb250YWN0RXF1YXRpb24oYm9keUEsIGJvZHlCKTsgLy8gRXF1YXRpb25zIHRvIGJlIGZlZCB0byB0aGUgc29sdmVyCgogICAgICB0aGlzLmVxdWF0aW9ucy5wdXNoKHgsIHksIHopOyAvLyBNYWtlIHRoZSBlcXVhdGlvbnMgYmlkaXJlY3Rpb25hbAoKICAgICAgeC5taW5Gb3JjZSA9IHkubWluRm9yY2UgPSB6Lm1pbkZvcmNlID0gLW1heEZvcmNlOwogICAgICB4Lm1heEZvcmNlID0geS5tYXhGb3JjZSA9IHoubWF4Rm9yY2UgPSBtYXhGb3JjZTsKICAgICAgeC5uaS5zZXQoMSwgMCwgMCk7CiAgICAgIHkubmkuc2V0KDAsIDEsIDApOwogICAgICB6Lm5pLnNldCgwLCAwLCAxKTsKICAgIH0KCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCB4ID0gdGhpcy5lcXVhdGlvblg7CiAgICAgIGNvbnN0IHkgPSB0aGlzLmVxdWF0aW9uWTsKICAgICAgY29uc3QgeiA9IHRoaXMuZXF1YXRpb25aOyAvLyBSb3RhdGUgdGhlIHBpdm90cyB0byB3b3JsZCBzcGFjZQoKICAgICAgYm9keUEucXVhdGVybmlvbi52bXVsdCh0aGlzLnBpdm90QSwgeC5yaSk7CiAgICAgIGJvZHlCLnF1YXRlcm5pb24udm11bHQodGhpcy5waXZvdEIsIHgucmopOwogICAgICB5LnJpLmNvcHkoeC5yaSk7CiAgICAgIHkucmouY29weSh4LnJqKTsKICAgICAgei5yaS5jb3B5KHgucmkpOwogICAgICB6LnJqLmNvcHkoeC5yaik7CiAgICB9CgogIH0KICAvKioKICAgKiBDb25lIGVxdWF0aW9uLiBXb3JrcyB0byBrZWVwIHRoZSBnaXZlbiBib2R5IHdvcmxkIHZlY3RvcnMgYWxpZ25lZCwgb3IgdGlsdGVkIHdpdGhpbiBhIGdpdmVuIGFuZ2xlIGZyb20gZWFjaCBvdGhlci4KICAgKi8KCgogIGNsYXNzIENvbmVFcXVhdGlvbiBleHRlbmRzIEVxdWF0aW9uIHsKICAgIC8qKgogICAgICogTG9jYWwgYXhpcyBpbiBBCiAgICAgKi8KCiAgICAvKioKICAgICAqIExvY2FsIGF4aXMgaW4gQgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgImNvbmUgYW5nbGUiIHRvIGtlZXAKICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IG1heEZvcmNlID0gdHlwZW9mIG9wdGlvbnMubWF4Rm9yY2UgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5tYXhGb3JjZSA6IDFlNjsKICAgICAgc3VwZXIoYm9keUEsIGJvZHlCLCAtbWF4Rm9yY2UsIG1heEZvcmNlKTsKICAgICAgdGhpcy5heGlzQSA9IHZvaWQgMDsKICAgICAgdGhpcy5heGlzQiA9IHZvaWQgMDsKICAgICAgdGhpcy5hbmdsZSA9IHZvaWQgMDsKICAgICAgdGhpcy5heGlzQSA9IG9wdGlvbnMuYXhpc0EgPyBvcHRpb25zLmF4aXNBLmNsb25lKCkgOiBuZXcgVmVjMygxLCAwLCAwKTsKICAgICAgdGhpcy5heGlzQiA9IG9wdGlvbnMuYXhpc0IgPyBvcHRpb25zLmF4aXNCLmNsb25lKCkgOiBuZXcgVmVjMygwLCAxLCAwKTsKICAgICAgdGhpcy5hbmdsZSA9IHR5cGVvZiBvcHRpb25zLmFuZ2xlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuYW5nbGUgOiAwOwogICAgfQoKICAgIGNvbXB1dGVCKGgpIHsKICAgICAgY29uc3QgYSA9IHRoaXMuYTsKICAgICAgY29uc3QgYiA9IHRoaXMuYjsKICAgICAgY29uc3QgbmkgPSB0aGlzLmF4aXNBOwogICAgICBjb25zdCBuaiA9IHRoaXMuYXhpc0I7CiAgICAgIGNvbnN0IG5peG5qID0gdG1wVmVjMSQyOwogICAgICBjb25zdCBuanhuaSA9IHRtcFZlYzIkMjsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOyAvLyBDYWx1Y2xhdGUgY3Jvc3MgcHJvZHVjdHMKCiAgICAgIG5pLmNyb3NzKG5qLCBuaXhuaik7CiAgICAgIG5qLmNyb3NzKG5pLCBuanhuaSk7IC8vIFRoZSBhbmdsZSBiZXR3ZWVuIHR3byB2ZWN0b3IgaXM6CiAgICAgIC8vIGNvcyh0aGV0YSkgPSBhICogYiAvIChsZW5ndGgoYSkgKiBsZW5ndGgoYikgPSB7IGxlbihhKSA9IGxlbihiKSA9IDEgfSA9IGEgKiBiCiAgICAgIC8vIGcgPSBhICogYgogICAgICAvLyBnZG90ID0gKGIgeCBhKSAqIHdpICsgKGEgeCBiKSAqIHdqCiAgICAgIC8vIEcgPSBbMCBieGEgMCBheGJdCiAgICAgIC8vIFcgPSBbdmkgd2kgdmogd2pdCgogICAgICBHQS5yb3RhdGlvbmFsLmNvcHkobmp4bmkpOwogICAgICBHQi5yb3RhdGlvbmFsLmNvcHkobml4bmopOwogICAgICBjb25zdCBnID0gTWF0aC5jb3ModGhpcy5hbmdsZSkgLSBuaS5kb3QobmopOwogICAgICBjb25zdCBHVyA9IHRoaXMuY29tcHV0ZUdXKCk7CiAgICAgIGNvbnN0IEdpTWYgPSB0aGlzLmNvbXB1dGVHaU1mKCk7CiAgICAgIGNvbnN0IEIgPSAtZyAqIGEgLSBHVyAqIGIgLSBoICogR2lNZjsKICAgICAgcmV0dXJuIEI7CiAgICB9CgogIH0KCiAgY29uc3QgdG1wVmVjMSQyID0gbmV3IFZlYzMoKTsKICBjb25zdCB0bXBWZWMyJDIgPSBuZXcgVmVjMygpOwogIC8qKgogICAqIFJvdGF0aW9uYWwgY29uc3RyYWludC4gV29ya3MgdG8ga2VlcCB0aGUgbG9jYWwgdmVjdG9ycyBvcnRob2dvbmFsIHRvIGVhY2ggb3RoZXIgaW4gd29ybGQgc3BhY2UuCiAgICovCgogIGNsYXNzIFJvdGF0aW9uYWxFcXVhdGlvbiBleHRlbmRzIEVxdWF0aW9uIHsKICAgIC8qKgogICAgICogV29ybGQgb3JpZW50ZWQgcm90YXRpb25hbCBheGlzLgogICAgICovCgogICAgLyoqCiAgICAgKiBXb3JsZCBvcmllbnRlZCByb3RhdGlvbmFsIGF4aXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIG1heEFuZ2xlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7CiAgICAgIHN1cGVyKGJvZHlBLCBib2R5QiwgLW1heEZvcmNlLCBtYXhGb3JjZSk7CiAgICAgIHRoaXMuYXhpc0EgPSB2b2lkIDA7CiAgICAgIHRoaXMuYXhpc0IgPSB2b2lkIDA7CiAgICAgIHRoaXMubWF4QW5nbGUgPSB2b2lkIDA7CiAgICAgIHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMCwgMSwgMCk7CiAgICAgIHRoaXMubWF4QW5nbGUgPSBNYXRoLlBJIC8gMjsKICAgIH0KCiAgICBjb21wdXRlQihoKSB7CiAgICAgIGNvbnN0IGEgPSB0aGlzLmE7CiAgICAgIGNvbnN0IGIgPSB0aGlzLmI7CiAgICAgIGNvbnN0IG5pID0gdGhpcy5heGlzQTsKICAgICAgY29uc3QgbmogPSB0aGlzLmF4aXNCOwogICAgICBjb25zdCBuaXhuaiA9IHRtcFZlYzEkMTsKICAgICAgY29uc3Qgbmp4bmkgPSB0bXBWZWMyJDE7CiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsgLy8gQ2FsdWNsYXRlIGNyb3NzIHByb2R1Y3RzCgogICAgICBuaS5jcm9zcyhuaiwgbml4bmopOwogICAgICBuai5jcm9zcyhuaSwgbmp4bmkpOyAvLyBnID0gbmkgKiBuagogICAgICAvLyBnZG90ID0gKG5qIHggbmkpICogd2kgKyAobmkgeCBuaikgKiB3agogICAgICAvLyBHID0gWzAgbmp4bmkgMCBuaXhual0KICAgICAgLy8gVyA9IFt2aSB3aSB2aiB3al0KCiAgICAgIEdBLnJvdGF0aW9uYWwuY29weShuanhuaSk7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShuaXhuaik7CiAgICAgIGNvbnN0IGcgPSBNYXRoLmNvcyh0aGlzLm1heEFuZ2xlKSAtIG5pLmRvdChuaik7CiAgICAgIGNvbnN0IEdXID0gdGhpcy5jb21wdXRlR1coKTsKICAgICAgY29uc3QgR2lNZiA9IHRoaXMuY29tcHV0ZUdpTWYoKTsKICAgICAgY29uc3QgQiA9IC1nICogYSAtIEdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KCiAgfQoKICBjb25zdCB0bXBWZWMxJDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzIkMSA9IG5ldyBWZWMzKCk7CiAgLyoqCiAgICogQSBDb25lIFR3aXN0IGNvbnN0cmFpbnQsIHVzZWZ1bCBmb3IgcmFnZG9sbHMuCiAgICovCgogIGNsYXNzIENvbmVUd2lzdENvbnN0cmFpbnQgZXh0ZW5kcyBQb2ludFRvUG9pbnRDb25zdHJhaW50IHsKICAgIC8qKgogICAgICogVGhlIGF4aXMgZGlyZWN0aW9uIGZvciB0aGUgY29uc3RyYWludCBvZiB0aGUgYm9keSBBLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgYXhpcyBkaXJlY3Rpb24gZm9yIHRoZSBjb25zdHJhaW50IG9mIHRoZSBib2R5IEIuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBhcGVydHVyZSBhbmdsZSBvZiB0aGUgY29uZS4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHR3aXN0IGFuZ2xlIG9mIHRoZSBqb2ludC4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IG1heEZvcmNlID0gdHlwZW9mIG9wdGlvbnMubWF4Rm9yY2UgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5tYXhGb3JjZSA6IDFlNjsgLy8gU2V0IHBpdm90IHBvaW50IGluIGJldHdlZW4KCiAgICAgIGNvbnN0IHBpdm90QSA9IG9wdGlvbnMucGl2b3RBID8gb3B0aW9ucy5waXZvdEEuY2xvbmUoKSA6IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHBpdm90QiA9IG9wdGlvbnMucGl2b3RCID8gb3B0aW9ucy5waXZvdEIuY2xvbmUoKSA6IG5ldyBWZWMzKCk7CiAgICAgIHN1cGVyKGJvZHlBLCBwaXZvdEEsIGJvZHlCLCBwaXZvdEIsIG1heEZvcmNlKTsKICAgICAgdGhpcy5heGlzQSA9IHZvaWQgMDsKICAgICAgdGhpcy5heGlzQiA9IHZvaWQgMDsKICAgICAgdGhpcy5hbmdsZSA9IHZvaWQgMDsKICAgICAgdGhpcy50d2lzdEFuZ2xlID0gdm9pZCAwOwogICAgICB0aGlzLmNvbmVFcXVhdGlvbiA9IHZvaWQgMDsKICAgICAgdGhpcy50d2lzdEVxdWF0aW9uID0gdm9pZCAwOwogICAgICB0aGlzLmF4aXNBID0gb3B0aW9ucy5heGlzQSA/IG9wdGlvbnMuYXhpc0EuY2xvbmUoKSA6IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgdGhpcy5jb2xsaWRlQ29ubmVjdGVkID0gISFvcHRpb25zLmNvbGxpZGVDb25uZWN0ZWQ7CiAgICAgIHRoaXMuYW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy5hbmdsZSAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmFuZ2xlIDogMDsKICAgICAgY29uc3QgYyA9IHRoaXMuY29uZUVxdWF0aW9uID0gbmV3IENvbmVFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICBjb25zdCB0ID0gdGhpcy50d2lzdEVxdWF0aW9uID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICB0aGlzLnR3aXN0QW5nbGUgPSB0eXBlb2Ygb3B0aW9ucy50d2lzdEFuZ2xlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMudHdpc3RBbmdsZSA6IDA7IC8vIE1ha2UgdGhlIGNvbmUgZXF1YXRpb24gcHVzaCB0aGUgYm9kaWVzIHRvd2FyZCB0aGUgY29uZSBheGlzLCBub3Qgb3V0d2FyZAoKICAgICAgYy5tYXhGb3JjZSA9IDA7CiAgICAgIGMubWluRm9yY2UgPSAtbWF4Rm9yY2U7IC8vIE1ha2UgdGhlIHR3aXN0IGVxdWF0aW9uIGFkZCB0b3JxdWUgdG93YXJkIHRoZSBpbml0aWFsIHBvc2l0aW9uCgogICAgICB0Lm1heEZvcmNlID0gMDsKICAgICAgdC5taW5Gb3JjZSA9IC1tYXhGb3JjZTsKICAgICAgdGhpcy5lcXVhdGlvbnMucHVzaChjLCB0KTsKICAgIH0KCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBjb25lID0gdGhpcy5jb25lRXF1YXRpb247CiAgICAgIGNvbnN0IHR3aXN0ID0gdGhpcy50d2lzdEVxdWF0aW9uOwogICAgICBzdXBlci51cGRhdGUoKTsgLy8gVXBkYXRlIHRoZSBheGVzIHRvIHRoZSBjb25lIGNvbnN0cmFpbnQKCiAgICAgIGJvZHlBLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLmF4aXNBLCBjb25lLmF4aXNBKTsKICAgICAgYm9keUIudmVjdG9yVG9Xb3JsZEZyYW1lKHRoaXMuYXhpc0IsIGNvbmUuYXhpc0IpOyAvLyBVcGRhdGUgdGhlIHdvcmxkIGF4ZXMgaW4gdGhlIHR3aXN0IGNvbnN0cmFpbnQKCiAgICAgIHRoaXMuYXhpc0EudGFuZ2VudHModHdpc3QuYXhpc0EsIHR3aXN0LmF4aXNBKTsKICAgICAgYm9keUEudmVjdG9yVG9Xb3JsZEZyYW1lKHR3aXN0LmF4aXNBLCB0d2lzdC5heGlzQSk7CiAgICAgIHRoaXMuYXhpc0IudGFuZ2VudHModHdpc3QuYXhpc0IsIHR3aXN0LmF4aXNCKTsKICAgICAgYm9keUIudmVjdG9yVG9Xb3JsZEZyYW1lKHR3aXN0LmF4aXNCLCB0d2lzdC5heGlzQik7CiAgICAgIGNvbmUuYW5nbGUgPSB0aGlzLmFuZ2xlOwogICAgICB0d2lzdC5tYXhBbmdsZSA9IHRoaXMudHdpc3RBbmdsZTsKICAgIH0KCiAgfQogIC8qKgogICAqIENvbnN0cmFpbnMgdHdvIGJvZGllcyB0byBiZSBhdCBhIGNvbnN0YW50IGRpc3RhbmNlIGZyb20gZWFjaCBvdGhlcnMgY2VudGVyIG9mIG1hc3MuCiAgICovCgoKICBjbGFzcyBEaXN0YW5jZUNvbnN0cmFpbnQgZXh0ZW5kcyBDb25zdHJhaW50IHsKICAgIC8qKgogICAgICogVGhlIGRpc3RhbmNlIHRvIGtlZXAuIElmIHVuZGVmaW5lZCwgaXQgd2lsbCBiZSBzZXQgdG8gdGhlIGN1cnJlbnQgZGlzdGFuY2UgYmV0d2VlbiBib2R5QSBhbmQgYm9keUIKICAgICAqLwoKICAgIC8qKgogICAgICogQHBhcmFtIGRpc3RhbmNlIFRoZSBkaXN0YW5jZSB0byBrZWVwLiBJZiB1bmRlZmluZWQsIGl0IHdpbGwgYmUgc2V0IHRvIHRoZSBjdXJyZW50IGRpc3RhbmNlIGJldHdlZW4gYm9keUEgYW5kIGJvZHlCLgogICAgICogQHBhcmFtIG1heEZvcmNlIFRoZSBtYXhpbXVtIGZvcmNlIHRoYXQgc2hvdWxkIGJlIGFwcGxpZWQgdG8gY29uc3RyYWluIHRoZSBib2RpZXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5QiwgZGlzdGFuY2UsIG1heEZvcmNlKSB7CiAgICAgIGlmIChtYXhGb3JjZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4Rm9yY2UgPSAxZTY7CiAgICAgIH0KCiAgICAgIHN1cGVyKGJvZHlBLCBib2R5Qik7CiAgICAgIHRoaXMuZGlzdGFuY2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGlzdGFuY2VFcXVhdGlvbiA9IHZvaWQgMDsKCiAgICAgIGlmICh0eXBlb2YgZGlzdGFuY2UgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgZGlzdGFuY2UgPSBib2R5QS5wb3NpdGlvbi5kaXN0YW5jZVRvKGJvZHlCLnBvc2l0aW9uKTsKICAgICAgfQoKICAgICAgdGhpcy5kaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICBjb25zdCBlcSA9IHRoaXMuZGlzdGFuY2VFcXVhdGlvbiA9IG5ldyBDb250YWN0RXF1YXRpb24oYm9keUEsIGJvZHlCKTsKICAgICAgdGhpcy5lcXVhdGlvbnMucHVzaChlcSk7IC8vIE1ha2UgaXQgYmlkaXJlY3Rpb25hbAoKICAgICAgZXEubWluRm9yY2UgPSAtbWF4Rm9yY2U7CiAgICAgIGVxLm1heEZvcmNlID0gbWF4Rm9yY2U7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZQogICAgICovCgoKICAgIHVwZGF0ZSgpIHsKICAgICAgY29uc3QgYm9keUEgPSB0aGlzLmJvZHlBOwogICAgICBjb25zdCBib2R5QiA9IHRoaXMuYm9keUI7CiAgICAgIGNvbnN0IGVxID0gdGhpcy5kaXN0YW5jZUVxdWF0aW9uOwogICAgICBjb25zdCBoYWxmRGlzdCA9IHRoaXMuZGlzdGFuY2UgKiAwLjU7CiAgICAgIGNvbnN0IG5vcm1hbCA9IGVxLm5pOwogICAgICBib2R5Qi5wb3NpdGlvbi52c3ViKGJvZHlBLnBvc2l0aW9uLCBub3JtYWwpOwogICAgICBub3JtYWwubm9ybWFsaXplKCk7CiAgICAgIG5vcm1hbC5zY2FsZShoYWxmRGlzdCwgZXEucmkpOwogICAgICBub3JtYWwuc2NhbGUoLWhhbGZEaXN0LCBlcS5yaik7CiAgICB9CgogIH0KICAvKioKICAgKiBMb2NrIGNvbnN0cmFpbnQuIFdpbGwgcmVtb3ZlIGFsbCBkZWdyZWVzIG9mIGZyZWVkb20gYmV0d2VlbiB0aGUgYm9kaWVzLgogICAqLwoKCiAgY2xhc3MgTG9ja0NvbnN0cmFpbnQgZXh0ZW5kcyBQb2ludFRvUG9pbnRDb25zdHJhaW50IHsKICAgIGNvbnN0cnVjdG9yKGJvZHlBLCBib2R5Qiwgb3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBtYXhGb3JjZSA9IHR5cGVvZiBvcHRpb25zLm1heEZvcmNlICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4Rm9yY2UgOiAxZTY7IC8vIFNldCBwaXZvdCBwb2ludCBpbiBiZXR3ZWVuCgogICAgICBjb25zdCBwaXZvdEEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBwaXZvdEIgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBoYWxmV2F5ID0gbmV3IFZlYzMoKTsKICAgICAgYm9keUEucG9zaXRpb24udmFkZChib2R5Qi5wb3NpdGlvbiwgaGFsZldheSk7CiAgICAgIGhhbGZXYXkuc2NhbGUoMC41LCBoYWxmV2F5KTsKICAgICAgYm9keUIucG9pbnRUb0xvY2FsRnJhbWUoaGFsZldheSwgcGl2b3RCKTsKICAgICAgYm9keUEucG9pbnRUb0xvY2FsRnJhbWUoaGFsZldheSwgcGl2b3RBKTsgLy8gVGhlIHBvaW50LXRvLXBvaW50IGNvbnN0cmFpbnQgd2lsbCBrZWVwIGEgcG9pbnQgc2hhcmVkIGJldHdlZW4gdGhlIGJvZGllcwoKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOyAvLyBTdG9yZSBpbml0aWFsIHJvdGF0aW9uIG9mIHRoZSBib2RpZXMgYXMgdW5pdCB2ZWN0b3JzIGluIHRoZSBsb2NhbCBib2R5IHNwYWNlcwoKICAgICAgdGhpcy54QSA9IHZvaWQgMDsKICAgICAgdGhpcy54QiA9IHZvaWQgMDsKICAgICAgdGhpcy55QSA9IHZvaWQgMDsKICAgICAgdGhpcy55QiA9IHZvaWQgMDsKICAgICAgdGhpcy56QSA9IHZvaWQgMDsKICAgICAgdGhpcy56QiA9IHZvaWQgMDsKICAgICAgdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24xID0gdm9pZCAwOwogICAgICB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjIgPSB2b2lkIDA7CiAgICAgIHRoaXMucm90YXRpb25hbEVxdWF0aW9uMyA9IHZvaWQgMDsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uID0gdm9pZCAwOwogICAgICB0aGlzLnhBID0gYm9keUEudmVjdG9yVG9Mb2NhbEZyYW1lKFZlYzMuVU5JVF9YKTsKICAgICAgdGhpcy54QiA9IGJvZHlCLnZlY3RvclRvTG9jYWxGcmFtZShWZWMzLlVOSVRfWCk7CiAgICAgIHRoaXMueUEgPSBib2R5QS52ZWN0b3JUb0xvY2FsRnJhbWUoVmVjMy5VTklUX1kpOwogICAgICB0aGlzLnlCID0gYm9keUIudmVjdG9yVG9Mb2NhbEZyYW1lKFZlYzMuVU5JVF9ZKTsKICAgICAgdGhpcy56QSA9IGJvZHlBLnZlY3RvclRvTG9jYWxGcmFtZShWZWMzLlVOSVRfWik7CiAgICAgIHRoaXMuekIgPSBib2R5Qi52ZWN0b3JUb0xvY2FsRnJhbWUoVmVjMy5VTklUX1opOyAvLyAuLi5hbmQgdGhlIGZvbGxvd2luZyByb3RhdGlvbmFsIGVxdWF0aW9ucyB3aWxsIGtlZXAgYWxsIHJvdGF0aW9uYWwgRE9GJ3MgaW4gcGxhY2UKCiAgICAgIGNvbnN0IHIxID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24xID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICBjb25zdCByMiA9IHRoaXMucm90YXRpb25hbEVxdWF0aW9uMiA9IG5ldyBSb3RhdGlvbmFsRXF1YXRpb24oYm9keUEsIGJvZHlCLCBvcHRpb25zKTsKICAgICAgY29uc3QgcjMgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjMgPSBuZXcgUm90YXRpb25hbEVxdWF0aW9uKGJvZHlBLCBib2R5Qiwgb3B0aW9ucyk7CiAgICAgIHRoaXMuZXF1YXRpb25zLnB1c2gocjEsIHIyLCByMyk7CiAgICB9CiAgICAvKioKICAgICAqIHVwZGF0ZQogICAgICovCgoKICAgIHVwZGF0ZSgpIHsKICAgICAgY29uc3QgYm9keUEgPSB0aGlzLmJvZHlBOwogICAgICBjb25zdCBib2R5QiA9IHRoaXMuYm9keUI7CiAgICAgIHRoaXMubW90b3JFcXVhdGlvbjsKICAgICAgY29uc3QgcjEgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjE7CiAgICAgIGNvbnN0IHIyID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24yOwogICAgICBjb25zdCByMyA9IHRoaXMucm90YXRpb25hbEVxdWF0aW9uMzsKICAgICAgc3VwZXIudXBkYXRlKCk7IC8vIFRoZXNlIHZlY3RvciBwYWlycyBtdXN0IGJlIG9ydGhvZ29uYWwKCiAgICAgIGJvZHlBLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLnhBLCByMS5heGlzQSk7CiAgICAgIGJvZHlCLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLnlCLCByMS5heGlzQik7CiAgICAgIGJvZHlBLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLnlBLCByMi5heGlzQSk7CiAgICAgIGJvZHlCLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLnpCLCByMi5heGlzQik7CiAgICAgIGJvZHlBLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLnpBLCByMy5heGlzQSk7CiAgICAgIGJvZHlCLnZlY3RvclRvV29ybGRGcmFtZSh0aGlzLnhCLCByMy5heGlzQik7CiAgICB9CgogIH0KICAvKioKICAgKiBSb3RhdGlvbmFsIG1vdG9yIGNvbnN0cmFpbnQuIFRyaWVzIHRvIGtlZXAgdGhlIHJlbGF0aXZlIGFuZ3VsYXIgdmVsb2NpdHkgb2YgdGhlIGJvZGllcyB0byBhIGdpdmVuIHZhbHVlLgogICAqLwoKCiAgY2xhc3MgUm90YXRpb25hbE1vdG9yRXF1YXRpb24gZXh0ZW5kcyBFcXVhdGlvbiB7CiAgICAvKioKICAgICAqIFdvcmxkIG9yaWVudGVkIHJvdGF0aW9uYWwgYXhpcy4KICAgICAqLwoKICAgIC8qKgogICAgICogV29ybGQgb3JpZW50ZWQgcm90YXRpb25hbCBheGlzLgogICAgICovCgogICAgLyoqCiAgICAgKiBNb3RvciB2ZWxvY2l0eS4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBtYXhGb3JjZSkgewogICAgICBpZiAobWF4Rm9yY2UgPT09IHZvaWQgMCkgewogICAgICAgIG1heEZvcmNlID0gMWU2OwogICAgICB9CgogICAgICBzdXBlcihib2R5QSwgYm9keUIsIC1tYXhGb3JjZSwgbWF4Rm9yY2UpOwogICAgICB0aGlzLmF4aXNBID0gdm9pZCAwOwogICAgICB0aGlzLmF4aXNCID0gdm9pZCAwOwogICAgICB0aGlzLnRhcmdldFZlbG9jaXR5ID0gdm9pZCAwOwogICAgICB0aGlzLmF4aXNBID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5heGlzQiA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMudGFyZ2V0VmVsb2NpdHkgPSAwOwogICAgfQoKICAgIGNvbXB1dGVCKGgpIHsKICAgICAgdGhpcy5hOwogICAgICBjb25zdCBiID0gdGhpcy5iOwogICAgICB0aGlzLmJpOwogICAgICB0aGlzLmJqOwogICAgICBjb25zdCBheGlzQSA9IHRoaXMuYXhpc0E7CiAgICAgIGNvbnN0IGF4aXNCID0gdGhpcy5heGlzQjsKICAgICAgY29uc3QgR0EgPSB0aGlzLmphY29iaWFuRWxlbWVudEE7CiAgICAgIGNvbnN0IEdCID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRCOyAvLyBnID0gMAogICAgICAvLyBnZG90ID0gYXhpc0EgKiB3aSAtIGF4aXNCICogd2oKICAgICAgLy8gZ2RvdCA9IEcgKiBXID0gRyAqIFt2aSB3aSB2aiB3al0KICAgICAgLy8gPT4KICAgICAgLy8gRyA9IFswIGF4aXNBIDAgLWF4aXNCXQoKICAgICAgR0Eucm90YXRpb25hbC5jb3B5KGF4aXNBKTsKICAgICAgYXhpc0IubmVnYXRlKEdCLnJvdGF0aW9uYWwpOwogICAgICBjb25zdCBHVyA9IHRoaXMuY29tcHV0ZUdXKCkgLSB0aGlzLnRhcmdldFZlbG9jaXR5OwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLUdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KCiAgfQogIC8qKgogICAqIEhpbmdlIGNvbnN0cmFpbnQuIFRoaW5rIG9mIGl0IGFzIGEgZG9vciBoaW5nZS4gSXQgdHJpZXMgdG8ga2VlcCB0aGUgZG9vciBpbiB0aGUgY29ycmVjdCBwbGFjZSBhbmQgd2l0aCB0aGUgY29ycmVjdCBvcmllbnRhdGlvbi4KICAgKi8KCgogIGNsYXNzIEhpbmdlQ29uc3RyYWludCBleHRlbmRzIFBvaW50VG9Qb2ludENvbnN0cmFpbnQgewogICAgLyoqCiAgICAgKiBSb3RhdGlvbiBheGlzLCBkZWZpbmVkIGxvY2FsbHkgaW4gYm9keUEuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFJvdGF0aW9uIGF4aXMsIGRlZmluZWQgbG9jYWxseSBpbiBib2R5Qi4KICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIGNvbnN0IG1heEZvcmNlID0gdHlwZW9mIG9wdGlvbnMubWF4Rm9yY2UgIT09ICd1bmRlZmluZWQnID8gb3B0aW9ucy5tYXhGb3JjZSA6IDFlNjsKICAgICAgY29uc3QgcGl2b3RBID0gb3B0aW9ucy5waXZvdEEgPyBvcHRpb25zLnBpdm90QS5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgY29uc3QgcGl2b3RCID0gb3B0aW9ucy5waXZvdEIgPyBvcHRpb25zLnBpdm90Qi5jbG9uZSgpIDogbmV3IFZlYzMoKTsKICAgICAgc3VwZXIoYm9keUEsIHBpdm90QSwgYm9keUIsIHBpdm90QiwgbWF4Rm9yY2UpOwogICAgICB0aGlzLmF4aXNBID0gdm9pZCAwOwogICAgICB0aGlzLmF4aXNCID0gdm9pZCAwOwogICAgICB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjEgPSB2b2lkIDA7CiAgICAgIHRoaXMucm90YXRpb25hbEVxdWF0aW9uMiA9IHZvaWQgMDsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uID0gdm9pZCAwOwogICAgICBjb25zdCBheGlzQSA9IHRoaXMuYXhpc0EgPSBvcHRpb25zLmF4aXNBID8gb3B0aW9ucy5heGlzQS5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIGF4aXNBLm5vcm1hbGl6ZSgpOwogICAgICBjb25zdCBheGlzQiA9IHRoaXMuYXhpc0IgPSBvcHRpb25zLmF4aXNCID8gb3B0aW9ucy5heGlzQi5jbG9uZSgpIDogbmV3IFZlYzMoMSwgMCwgMCk7CiAgICAgIGF4aXNCLm5vcm1hbGl6ZSgpOwogICAgICB0aGlzLmNvbGxpZGVDb25uZWN0ZWQgPSAhIW9wdGlvbnMuY29sbGlkZUNvbm5lY3RlZDsKICAgICAgY29uc3Qgcm90YXRpb25hbDEgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjEgPSBuZXcgUm90YXRpb25hbEVxdWF0aW9uKGJvZHlBLCBib2R5Qiwgb3B0aW9ucyk7CiAgICAgIGNvbnN0IHJvdGF0aW9uYWwyID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24yID0gbmV3IFJvdGF0aW9uYWxFcXVhdGlvbihib2R5QSwgYm9keUIsIG9wdGlvbnMpOwogICAgICBjb25zdCBtb3RvciA9IHRoaXMubW90b3JFcXVhdGlvbiA9IG5ldyBSb3RhdGlvbmFsTW90b3JFcXVhdGlvbihib2R5QSwgYm9keUIsIG1heEZvcmNlKTsKICAgICAgbW90b3IuZW5hYmxlZCA9IGZhbHNlOyAvLyBOb3QgZW5hYmxlZCBieSBkZWZhdWx0CiAgICAgIC8vIEVxdWF0aW9ucyB0byBiZSBmZWQgdG8gdGhlIHNvbHZlcgoKICAgICAgdGhpcy5lcXVhdGlvbnMucHVzaChyb3RhdGlvbmFsMSwgcm90YXRpb25hbDIsIG1vdG9yKTsKICAgIH0KICAgIC8qKgogICAgICogZW5hYmxlTW90b3IKICAgICAqLwoKCiAgICBlbmFibGVNb3RvcigpIHsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uLmVuYWJsZWQgPSB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBkaXNhYmxlTW90b3IKICAgICAqLwoKCiAgICBkaXNhYmxlTW90b3IoKSB7CiAgICAgIHRoaXMubW90b3JFcXVhdGlvbi5lbmFibGVkID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIHNldE1vdG9yU3BlZWQKICAgICAqLwoKCiAgICBzZXRNb3RvclNwZWVkKHNwZWVkKSB7CiAgICAgIHRoaXMubW90b3JFcXVhdGlvbi50YXJnZXRWZWxvY2l0eSA9IHNwZWVkOwogICAgfQogICAgLyoqCiAgICAgKiBzZXRNb3Rvck1heEZvcmNlCiAgICAgKi8KCgogICAgc2V0TW90b3JNYXhGb3JjZShtYXhGb3JjZSkgewogICAgICB0aGlzLm1vdG9yRXF1YXRpb24ubWF4Rm9yY2UgPSBtYXhGb3JjZTsKICAgICAgdGhpcy5tb3RvckVxdWF0aW9uLm1pbkZvcmNlID0gLW1heEZvcmNlOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGUKICAgICAqLwoKCiAgICB1cGRhdGUoKSB7CiAgICAgIGNvbnN0IGJvZHlBID0gdGhpcy5ib2R5QTsKICAgICAgY29uc3QgYm9keUIgPSB0aGlzLmJvZHlCOwogICAgICBjb25zdCBtb3RvciA9IHRoaXMubW90b3JFcXVhdGlvbjsKICAgICAgY29uc3QgcjEgPSB0aGlzLnJvdGF0aW9uYWxFcXVhdGlvbjE7CiAgICAgIGNvbnN0IHIyID0gdGhpcy5yb3RhdGlvbmFsRXF1YXRpb24yOwogICAgICBjb25zdCB3b3JsZEF4aXNBID0gSGluZ2VDb25zdHJhaW50X3VwZGF0ZV90bXBWZWMxOwogICAgICBjb25zdCB3b3JsZEF4aXNCID0gSGluZ2VDb25zdHJhaW50X3VwZGF0ZV90bXBWZWMyOwogICAgICBjb25zdCBheGlzQSA9IHRoaXMuYXhpc0E7CiAgICAgIGNvbnN0IGF4aXNCID0gdGhpcy5heGlzQjsKICAgICAgc3VwZXIudXBkYXRlKCk7IC8vIEdldCB3b3JsZCBheGVzCgogICAgICBib2R5QS5xdWF0ZXJuaW9uLnZtdWx0KGF4aXNBLCB3b3JsZEF4aXNBKTsKICAgICAgYm9keUIucXVhdGVybmlvbi52bXVsdChheGlzQiwgd29ybGRBeGlzQik7CiAgICAgIHdvcmxkQXhpc0EudGFuZ2VudHMocjEuYXhpc0EsIHIyLmF4aXNBKTsKICAgICAgcjEuYXhpc0IuY29weSh3b3JsZEF4aXNCKTsKICAgICAgcjIuYXhpc0IuY29weSh3b3JsZEF4aXNCKTsKCiAgICAgIGlmICh0aGlzLm1vdG9yRXF1YXRpb24uZW5hYmxlZCkgewogICAgICAgIGJvZHlBLnF1YXRlcm5pb24udm11bHQodGhpcy5heGlzQSwgbW90b3IuYXhpc0EpOwogICAgICAgIGJvZHlCLnF1YXRlcm5pb24udm11bHQodGhpcy5heGlzQiwgbW90b3IuYXhpc0IpOwogICAgICB9CiAgICB9CgogIH0KCiAgY29uc3QgSGluZ2VDb25zdHJhaW50X3VwZGF0ZV90bXBWZWMxID0gbmV3IFZlYzMoKTsKICBjb25zdCBIaW5nZUNvbnN0cmFpbnRfdXBkYXRlX3RtcFZlYzIgPSBuZXcgVmVjMygpOwogIC8qKgogICAqIENvbnN0cmFpbnMgdGhlIHNsaXBwaW5nIGluIGEgY29udGFjdCBhbG9uZyBhIHRhbmdlbnQKICAgKi8KCiAgY2xhc3MgRnJpY3Rpb25FcXVhdGlvbiBleHRlbmRzIEVxdWF0aW9uIHsKICAgIC8vIFRhbmdlbnQKCiAgICAvKioKICAgICAqIEBwYXJhbSBzbGlwRm9yY2Ugc2hvdWxkIGJlICstRl9mcmljdGlvbiA9ICstbXUgKiBGX25vcm1hbCA9ICstbXUgKiBtICogZwogICAgICovCiAgICBjb25zdHJ1Y3Rvcihib2R5QSwgYm9keUIsIHNsaXBGb3JjZSkgewogICAgICBzdXBlcihib2R5QSwgYm9keUIsIC1zbGlwRm9yY2UsIHNsaXBGb3JjZSk7CiAgICAgIHRoaXMucmkgPSB2b2lkIDA7CiAgICAgIHRoaXMucmogPSB2b2lkIDA7CiAgICAgIHRoaXMudCA9IHZvaWQgMDsKICAgICAgdGhpcy5yaSA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMucmogPSBuZXcgVmVjMygpOwogICAgICB0aGlzLnQgPSBuZXcgVmVjMygpOwogICAgfQoKICAgIGNvbXB1dGVCKGgpIHsKICAgICAgdGhpcy5hOwogICAgICBjb25zdCBiID0gdGhpcy5iOwogICAgICB0aGlzLmJpOwogICAgICB0aGlzLmJqOwogICAgICBjb25zdCByaSA9IHRoaXMucmk7CiAgICAgIGNvbnN0IHJqID0gdGhpcy5yajsKICAgICAgY29uc3Qgcml4dCA9IEZyaWN0aW9uRXF1YXRpb25fY29tcHV0ZUJfdGVtcDE7CiAgICAgIGNvbnN0IHJqeHQgPSBGcmljdGlvbkVxdWF0aW9uX2NvbXB1dGVCX3RlbXAyOwogICAgICBjb25zdCB0ID0gdGhpcy50OyAvLyBDYWx1Y2xhdGUgY3Jvc3MgcHJvZHVjdHMKCiAgICAgIHJpLmNyb3NzKHQsIHJpeHQpOwogICAgICByai5jcm9zcyh0LCByanh0KTsgLy8gRyA9IFstdCAtcml4dCB0IHJqeHRdCiAgICAgIC8vIEFuZCByZW1lbWJlciwgdGhpcyBpcyBhIHB1cmUgdmVsb2NpdHkgY29uc3RyYWludCwgZyBpcyBhbHdheXMgemVybyEKCiAgICAgIGNvbnN0IEdBID0gdGhpcy5qYWNvYmlhbkVsZW1lbnRBOwogICAgICBjb25zdCBHQiA9IHRoaXMuamFjb2JpYW5FbGVtZW50QjsKICAgICAgdC5uZWdhdGUoR0Euc3BhdGlhbCk7CiAgICAgIHJpeHQubmVnYXRlKEdBLnJvdGF0aW9uYWwpOwogICAgICBHQi5zcGF0aWFsLmNvcHkodCk7CiAgICAgIEdCLnJvdGF0aW9uYWwuY29weShyanh0KTsKICAgICAgY29uc3QgR1cgPSB0aGlzLmNvbXB1dGVHVygpOwogICAgICBjb25zdCBHaU1mID0gdGhpcy5jb21wdXRlR2lNZigpOwogICAgICBjb25zdCBCID0gLUdXICogYiAtIGggKiBHaU1mOwogICAgICByZXR1cm4gQjsKICAgIH0KCiAgfQoKICBjb25zdCBGcmljdGlvbkVxdWF0aW9uX2NvbXB1dGVCX3RlbXAxID0gbmV3IFZlYzMoKTsKICBjb25zdCBGcmljdGlvbkVxdWF0aW9uX2NvbXB1dGVCX3RlbXAyID0gbmV3IFZlYzMoKTsKICAvKioKICAgKiBEZWZpbmVzIHdoYXQgaGFwcGVucyB3aGVuIHR3byBtYXRlcmlhbHMgbWVldC4KICAgKiBAdG9kbyBSZWZhY3RvciBtYXRlcmlhbHMgdG8gbWF0ZXJpYWxBIGFuZCBtYXRlcmlhbEIKICAgKi8KCiAgY2xhc3MgQ29udGFjdE1hdGVyaWFsIHsKICAgIC8qKgogICAgICogSWRlbnRpZmllciBvZiB0aGlzIG1hdGVyaWFsLgogICAgICovCgogICAgLyoqCiAgICAgKiBQYXJ0aWNpcGF0aW5nIG1hdGVyaWFscy4KICAgICAqLwoKICAgIC8qKgogICAgICogRnJpY3Rpb24gY29lZmZpY2llbnQuCiAgICAgKiBAZGVmYXVsdCAwLjMKICAgICAqLwoKICAgIC8qKgogICAgICogUmVzdGl0dXRpb24gY29lZmZpY2llbnQuCiAgICAgKiBAZGVmYXVsdCAwLjMKICAgICAqLwoKICAgIC8qKgogICAgICogU3RpZmZuZXNzIG9mIHRoZSBwcm9kdWNlZCBjb250YWN0IGVxdWF0aW9ucy4KICAgICAqIEBkZWZhdWx0IDFlNwogICAgICovCgogICAgLyoqCiAgICAgKiBSZWxheGF0aW9uIHRpbWUgb2YgdGhlIHByb2R1Y2VkIGNvbnRhY3QgZXF1YXRpb25zLgogICAgICogQGRlZmF1bHQgMwogICAgICovCgogICAgLyoqCiAgICAgKiBTdGlmZm5lc3Mgb2YgdGhlIHByb2R1Y2VkIGZyaWN0aW9uIGVxdWF0aW9ucy4KICAgICAqIEBkZWZhdWx0IDFlNwogICAgICovCgogICAgLyoqCiAgICAgKiBSZWxheGF0aW9uIHRpbWUgb2YgdGhlIHByb2R1Y2VkIGZyaWN0aW9uIGVxdWF0aW9ucwogICAgICogQGRlZmF1bHQgMwogICAgICovCiAgICBjb25zdHJ1Y3RvcihtMSwgbTIsIG9wdGlvbnMpIHsKICAgICAgdGhpcy5pZCA9IHZvaWQgMDsKICAgICAgdGhpcy5tYXRlcmlhbHMgPSB2b2lkIDA7CiAgICAgIHRoaXMuZnJpY3Rpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMucmVzdGl0dXRpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMuY29udGFjdEVxdWF0aW9uU3RpZmZuZXNzID0gdm9pZCAwOwogICAgICB0aGlzLmNvbnRhY3RFcXVhdGlvblJlbGF4YXRpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcyA9IHZvaWQgMDsKICAgICAgdGhpcy5mcmljdGlvbkVxdWF0aW9uUmVsYXhhdGlvbiA9IHZvaWQgMDsKICAgICAgb3B0aW9ucyA9IFV0aWxzLmRlZmF1bHRzKG9wdGlvbnMsIHsKICAgICAgICBmcmljdGlvbjogMC4zLAogICAgICAgIHJlc3RpdHV0aW9uOiAwLjMsCiAgICAgICAgY29udGFjdEVxdWF0aW9uU3RpZmZuZXNzOiAxZTcsCiAgICAgICAgY29udGFjdEVxdWF0aW9uUmVsYXhhdGlvbjogMywKICAgICAgICBmcmljdGlvbkVxdWF0aW9uU3RpZmZuZXNzOiAxZTcsCiAgICAgICAgZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb246IDMKICAgICAgfSk7CiAgICAgIHRoaXMuaWQgPSBDb250YWN0TWF0ZXJpYWwuaWRDb3VudGVyKys7CiAgICAgIHRoaXMubWF0ZXJpYWxzID0gW20xLCBtMl07CiAgICAgIHRoaXMuZnJpY3Rpb24gPSBvcHRpb25zLmZyaWN0aW9uOwogICAgICB0aGlzLnJlc3RpdHV0aW9uID0gb3B0aW9ucy5yZXN0aXR1dGlvbjsKICAgICAgdGhpcy5jb250YWN0RXF1YXRpb25TdGlmZm5lc3MgPSBvcHRpb25zLmNvbnRhY3RFcXVhdGlvblN0aWZmbmVzczsKICAgICAgdGhpcy5jb250YWN0RXF1YXRpb25SZWxheGF0aW9uID0gb3B0aW9ucy5jb250YWN0RXF1YXRpb25SZWxheGF0aW9uOwogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25TdGlmZm5lc3MgPSBvcHRpb25zLmZyaWN0aW9uRXF1YXRpb25TdGlmZm5lc3M7CiAgICAgIHRoaXMuZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24gPSBvcHRpb25zLmZyaWN0aW9uRXF1YXRpb25SZWxheGF0aW9uOwogICAgfQoKICB9CgogIENvbnRhY3RNYXRlcmlhbC5pZENvdW50ZXIgPSAwOwogIC8qKgogICAqIERlZmluZXMgYSBwaHlzaWNzIG1hdGVyaWFsLgogICAqLwoKICBjbGFzcyBNYXRlcmlhbCB7CiAgICAvKioKICAgICAqIE1hdGVyaWFsIG5hbWUuCiAgICAgKiBJZiBvcHRpb25zIGlzIGEgc3RyaW5nLCBuYW1lIHdpbGwgYmUgc2V0IHRvIHRoYXQgc3RyaW5nLgogICAgICogQHRvZG8gRGVwcmVjYXRlIHRoaXMKICAgICAqLwoKICAgIC8qKiBNYXRlcmlhbCBpZC4gKi8KCiAgICAvKioKICAgICAqIEZyaWN0aW9uIGZvciB0aGlzIG1hdGVyaWFsLgogICAgICogSWYgbm9uLW5lZ2F0aXZlLCBpdCB3aWxsIGJlIHVzZWQgaW5zdGVhZCBvZiB0aGUgZnJpY3Rpb24gZ2l2ZW4gYnkgQ29udGFjdE1hdGVyaWFscy4gSWYgdGhlcmUncyBubyBtYXRjaGluZyBDb250YWN0TWF0ZXJpYWwsIHRoZSB2YWx1ZSBmcm9tIGBkZWZhdWx0Q29udGFjdE1hdGVyaWFsYCBpbiB0aGUgV29ybGQgd2lsbCBiZSB1c2VkLgogICAgICovCgogICAgLyoqCiAgICAgKiBSZXN0aXR1dGlvbiBmb3IgdGhpcyBtYXRlcmlhbC4KICAgICAqIElmIG5vbi1uZWdhdGl2ZSwgaXQgd2lsbCBiZSB1c2VkIGluc3RlYWQgb2YgdGhlIHJlc3RpdHV0aW9uIGdpdmVuIGJ5IENvbnRhY3RNYXRlcmlhbHMuIElmIHRoZXJlJ3Mgbm8gbWF0Y2hpbmcgQ29udGFjdE1hdGVyaWFsLCB0aGUgdmFsdWUgZnJvbSBgZGVmYXVsdENvbnRhY3RNYXRlcmlhbGAgaW4gdGhlIFdvcmxkIHdpbGwgYmUgdXNlZC4KICAgICAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLm5hbWUgPSB2b2lkIDA7CiAgICAgIHRoaXMuaWQgPSB2b2lkIDA7CiAgICAgIHRoaXMuZnJpY3Rpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMucmVzdGl0dXRpb24gPSB2b2lkIDA7CiAgICAgIGxldCBuYW1lID0gJyc7IC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGZpeAoKICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykgewogICAgICAgIC8vY29uc29sZS53YXJuKGBQYXNzaW5nIGEgc3RyaW5nIHRvIE1hdGVyaWFsT3B0aW9ucyBpcyBkZXByZWNhdGVkLCBhbmQgaGFzIG5vIGVmZmVjdGApCiAgICAgICAgbmFtZSA9IG9wdGlvbnM7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLmlkID0gTWF0ZXJpYWwuaWRDb3VudGVyKys7CiAgICAgIHRoaXMuZnJpY3Rpb24gPSB0eXBlb2Ygb3B0aW9ucy5mcmljdGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmZyaWN0aW9uIDogLTE7CiAgICAgIHRoaXMucmVzdGl0dXRpb24gPSB0eXBlb2Ygb3B0aW9ucy5yZXN0aXR1dGlvbiAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLnJlc3RpdHV0aW9uIDogLTE7CiAgICB9CgogIH0KCiAgTWF0ZXJpYWwuaWRDb3VudGVyID0gMDsKICAvKioKICAgKiBBIHNwcmluZywgY29ubmVjdGluZyB0d28gYm9kaWVzLgogICAqIEBleGFtcGxlCiAgICogICAgIGNvbnN0IHNwcmluZyA9IG5ldyBTcHJpbmcoYm94Qm9keSwgc3BoZXJlQm9keSwgewogICAqICAgICAgIHJlc3RMZW5ndGg6IDAsCiAgICogICAgICAgc3RpZmZuZXNzOiA1MCwKICAgKiAgICAgICBkYW1waW5nOiAxLAogICAqICAgICB9KQogICAqCiAgICogICAgIC8vIENvbXB1dGUgdGhlIGZvcmNlIGFmdGVyIGVhY2ggc3RlcAogICAqICAgICB3b3JsZC5hZGRFdmVudExpc3RlbmVyKCdwb3N0U3RlcCcsIChldmVudCkgPT4gewogICAqICAgICAgIHNwcmluZy5hcHBseUZvcmNlKCkKICAgKiAgICAgfSkKICAgKi8KCiAgY2xhc3MgU3ByaW5nIHsKICAgIC8qKgogICAgICogUmVzdCBsZW5ndGggb2YgdGhlIHNwcmluZy4gQSBudW1iZXIgPiAwLgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBTdGlmZm5lc3Mgb2YgdGhlIHNwcmluZy4gQSBudW1iZXIgPj0gMC4KICAgICAqIEBkZWZhdWx0IDEwMAogICAgICovCgogICAgLyoqCiAgICAgKiBEYW1waW5nIG9mIHRoZSBzcHJpbmcuIEEgbnVtYmVyID49IDAuCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIEZpcnN0IGNvbm5lY3RlZCBib2R5LgogICAgICovCgogICAgLyoqCiAgICAgKiBTZWNvbmQgY29ubmVjdGVkIGJvZHkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFuY2hvciBmb3IgYm9keUEgaW4gbG9jYWwgYm9keUEgY29vcmRpbmF0ZXMuCiAgICAgKiBXaGVyZSB0byBob29rIHRoZSBzcHJpbmcgdG8gYm9keSBBLCBpbiBsb2NhbCBib2R5IGNvb3JkaW5hdGVzLgogICAgICogQGRlZmF1bHQgbmV3IFZlYzMoKQogICAgICovCgogICAgLyoqCiAgICAgKiBBbmNob3IgZm9yIGJvZHlCIGluIGxvY2FsIGJvZHlCIGNvb3JkaW5hdGVzLgogICAgICogV2hlcmUgdG8gaG9vayB0aGUgc3ByaW5nIHRvIGJvZHkgQiwgaW4gbG9jYWwgYm9keSBjb29yZGluYXRlcy4KICAgICAqIEBkZWZhdWx0IG5ldyBWZWMzKCkKICAgICAqLwogICAgY29uc3RydWN0b3IoYm9keUEsIGJvZHlCLCBvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHRoaXMucmVzdExlbmd0aCA9IHZvaWQgMDsKICAgICAgdGhpcy5zdGlmZm5lc3MgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGFtcGluZyA9IHZvaWQgMDsKICAgICAgdGhpcy5ib2R5QSA9IHZvaWQgMDsKICAgICAgdGhpcy5ib2R5QiA9IHZvaWQgMDsKICAgICAgdGhpcy5sb2NhbEFuY2hvckEgPSB2b2lkIDA7CiAgICAgIHRoaXMubG9jYWxBbmNob3JCID0gdm9pZCAwOwogICAgICB0aGlzLnJlc3RMZW5ndGggPSB0eXBlb2Ygb3B0aW9ucy5yZXN0TGVuZ3RoID09PSAnbnVtYmVyJyA/IG9wdGlvbnMucmVzdExlbmd0aCA6IDE7CiAgICAgIHRoaXMuc3RpZmZuZXNzID0gb3B0aW9ucy5zdGlmZm5lc3MgfHwgMTAwOwogICAgICB0aGlzLmRhbXBpbmcgPSBvcHRpb25zLmRhbXBpbmcgfHwgMTsKICAgICAgdGhpcy5ib2R5QSA9IGJvZHlBOwogICAgICB0aGlzLmJvZHlCID0gYm9keUI7CiAgICAgIHRoaXMubG9jYWxBbmNob3JBID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5sb2NhbEFuY2hvckIgPSBuZXcgVmVjMygpOwoKICAgICAgaWYgKG9wdGlvbnMubG9jYWxBbmNob3JBKSB7CiAgICAgICAgdGhpcy5sb2NhbEFuY2hvckEuY29weShvcHRpb25zLmxvY2FsQW5jaG9yQSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLmxvY2FsQW5jaG9yQikgewogICAgICAgIHRoaXMubG9jYWxBbmNob3JCLmNvcHkob3B0aW9ucy5sb2NhbEFuY2hvckIpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy53b3JsZEFuY2hvckEpIHsKICAgICAgICB0aGlzLnNldFdvcmxkQW5jaG9yQShvcHRpb25zLndvcmxkQW5jaG9yQSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLndvcmxkQW5jaG9yQikgewogICAgICAgIHRoaXMuc2V0V29ybGRBbmNob3JCKG9wdGlvbnMud29ybGRBbmNob3JCKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIGFuY2hvciBwb2ludCBvbiBib2R5IEEsIHVzaW5nIHdvcmxkIGNvb3JkaW5hdGVzLgogICAgICovCgoKICAgIHNldFdvcmxkQW5jaG9yQSh3b3JsZEFuY2hvckEpIHsKICAgICAgdGhpcy5ib2R5QS5wb2ludFRvTG9jYWxGcmFtZSh3b3JsZEFuY2hvckEsIHRoaXMubG9jYWxBbmNob3JBKTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBhbmNob3IgcG9pbnQgb24gYm9keSBCLCB1c2luZyB3b3JsZCBjb29yZGluYXRlcy4KICAgICAqLwoKCiAgICBzZXRXb3JsZEFuY2hvckIod29ybGRBbmNob3JCKSB7CiAgICAgIHRoaXMuYm9keUIucG9pbnRUb0xvY2FsRnJhbWUod29ybGRBbmNob3JCLCB0aGlzLmxvY2FsQW5jaG9yQik7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgYW5jaG9yIHBvaW50IG9uIGJvZHkgQSwgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKiBAcGFyYW0gcmVzdWx0IFRoZSB2ZWN0b3IgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBnZXRXb3JsZEFuY2hvckEocmVzdWx0KSB7CiAgICAgIHRoaXMuYm9keUEucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5sb2NhbEFuY2hvckEsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgYW5jaG9yIHBvaW50IG9uIGJvZHkgQiwgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAgKiBAcGFyYW0gcmVzdWx0IFRoZSB2ZWN0b3IgdG8gc3RvcmUgdGhlIHJlc3VsdCBpbi4KICAgICAqLwoKCiAgICBnZXRXb3JsZEFuY2hvckIocmVzdWx0KSB7CiAgICAgIHRoaXMuYm9keUIucG9pbnRUb1dvcmxkRnJhbWUodGhpcy5sb2NhbEFuY2hvckIsIHJlc3VsdCk7CiAgICB9CiAgICAvKioKICAgICAqIEFwcGx5IHRoZSBzcHJpbmcgZm9yY2UgdG8gdGhlIGNvbm5lY3RlZCBib2RpZXMuCiAgICAgKi8KCgogICAgYXBwbHlGb3JjZSgpIHsKICAgICAgY29uc3QgayA9IHRoaXMuc3RpZmZuZXNzOwogICAgICBjb25zdCBkID0gdGhpcy5kYW1waW5nOwogICAgICBjb25zdCBsID0gdGhpcy5yZXN0TGVuZ3RoOwogICAgICBjb25zdCBib2R5QSA9IHRoaXMuYm9keUE7CiAgICAgIGNvbnN0IGJvZHlCID0gdGhpcy5ib2R5QjsKICAgICAgY29uc3QgciA9IGFwcGx5Rm9yY2VfcjsKICAgICAgY29uc3Qgcl91bml0ID0gYXBwbHlGb3JjZV9yX3VuaXQ7CiAgICAgIGNvbnN0IHUgPSBhcHBseUZvcmNlX3U7CiAgICAgIGNvbnN0IGYgPSBhcHBseUZvcmNlX2Y7CiAgICAgIGNvbnN0IHRtcCA9IGFwcGx5Rm9yY2VfdG1wOwogICAgICBjb25zdCB3b3JsZEFuY2hvckEgPSBhcHBseUZvcmNlX3dvcmxkQW5jaG9yQTsKICAgICAgY29uc3Qgd29ybGRBbmNob3JCID0gYXBwbHlGb3JjZV93b3JsZEFuY2hvckI7CiAgICAgIGNvbnN0IHJpID0gYXBwbHlGb3JjZV9yaTsKICAgICAgY29uc3QgcmogPSBhcHBseUZvcmNlX3JqOwogICAgICBjb25zdCByaV94X2YgPSBhcHBseUZvcmNlX3JpX3hfZjsKICAgICAgY29uc3QgcmpfeF9mID0gYXBwbHlGb3JjZV9yal94X2Y7IC8vIEdldCB3b3JsZCBhbmNob3JzCgogICAgICB0aGlzLmdldFdvcmxkQW5jaG9yQSh3b3JsZEFuY2hvckEpOwogICAgICB0aGlzLmdldFdvcmxkQW5jaG9yQih3b3JsZEFuY2hvckIpOyAvLyBHZXQgb2Zmc2V0IHBvaW50cwoKICAgICAgd29ybGRBbmNob3JBLnZzdWIoYm9keUEucG9zaXRpb24sIHJpKTsKICAgICAgd29ybGRBbmNob3JCLnZzdWIoYm9keUIucG9zaXRpb24sIHJqKTsgLy8gQ29tcHV0ZSBkaXN0YW5jZSB2ZWN0b3IgYmV0d2VlbiB3b3JsZCBhbmNob3IgcG9pbnRzCgogICAgICB3b3JsZEFuY2hvckIudnN1Yih3b3JsZEFuY2hvckEsIHIpOwogICAgICBjb25zdCBybGVuID0gci5sZW5ndGgoKTsKICAgICAgcl91bml0LmNvcHkocik7CiAgICAgIHJfdW5pdC5ub3JtYWxpemUoKTsgLy8gQ29tcHV0ZSByZWxhdGl2ZSB2ZWxvY2l0eSBvZiB0aGUgYW5jaG9yIHBvaW50cywgdQoKICAgICAgYm9keUIudmVsb2NpdHkudnN1Yihib2R5QS52ZWxvY2l0eSwgdSk7IC8vIEFkZCByb3RhdGlvbmFsIHZlbG9jaXR5CgogICAgICBib2R5Qi5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MocmosIHRtcCk7CiAgICAgIHUudmFkZCh0bXAsIHUpOwogICAgICBib2R5QS5hbmd1bGFyVmVsb2NpdHkuY3Jvc3MocmksIHRtcCk7CiAgICAgIHUudnN1Yih0bXAsIHUpOyAvLyBGID0gLSBrICogKCB4IC0gTCApIC0gRCAqICggdSApCgogICAgICByX3VuaXQuc2NhbGUoLWsgKiAocmxlbiAtIGwpIC0gZCAqIHUuZG90KHJfdW5pdCksIGYpOyAvLyBBZGQgZm9yY2VzIHRvIGJvZGllcwoKICAgICAgYm9keUEuZm9yY2UudnN1YihmLCBib2R5QS5mb3JjZSk7CiAgICAgIGJvZHlCLmZvcmNlLnZhZGQoZiwgYm9keUIuZm9yY2UpOyAvLyBBbmd1bGFyIGZvcmNlCgogICAgICByaS5jcm9zcyhmLCByaV94X2YpOwogICAgICByai5jcm9zcyhmLCByal94X2YpOwogICAgICBib2R5QS50b3JxdWUudnN1YihyaV94X2YsIGJvZHlBLnRvcnF1ZSk7CiAgICAgIGJvZHlCLnRvcnF1ZS52YWRkKHJqX3hfZiwgYm9keUIudG9ycXVlKTsKICAgIH0KCiAgfQoKICBjb25zdCBhcHBseUZvcmNlX3IgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2Vfcl91bml0ID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3UgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfZiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV93b3JsZEFuY2hvckEgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2Vfd29ybGRBbmNob3JCID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3JpID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3JqID0gbmV3IFZlYzMoKTsKICBjb25zdCBhcHBseUZvcmNlX3JpX3hfZiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXBwbHlGb3JjZV9yal94X2YgPSBuZXcgVmVjMygpOwogIGNvbnN0IGFwcGx5Rm9yY2VfdG1wID0gbmV3IFZlYzMoKTsKICAvKioKICAgKiBXaGVlbEluZm8KICAgKi8KCiAgY2xhc3MgV2hlZWxJbmZvIHsKICAgIC8qKgogICAgICogTWF4IHRyYXZlbCBkaXN0YW5jZSBvZiB0aGUgc3VzcGVuc2lvbiwgaW4gbWV0ZXJzLgogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBTcGVlZCB0byBhcHBseSB0byB0aGUgd2hlZWwgcm90YXRpb24gd2hlbiB0aGUgd2hlZWwgaXMgc2xpZGluZy4KICAgICAqIEBkZWZhdWx0IC0wLjEKICAgICAqLwoKICAgIC8qKgogICAgICogSWYgdGhlIGN1c3RvbVNsaWRpbmdSb3RhdGlvbmFsU3BlZWQgc2hvdWxkIGJlIHVzZWQuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCgogICAgLyoqCiAgICAgKiBzbGlkaW5nCiAgICAgKi8KCiAgICAvKioKICAgICAqIENvbm5lY3Rpb24gcG9pbnQsIGRlZmluZWQgbG9jYWxseSBpbiB0aGUgY2hhc3NpcyBib2R5IGZyYW1lLgogICAgICovCgogICAgLyoqCiAgICAgKiBjaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQKICAgICAqLwoKICAgIC8qKgogICAgICogZGlyZWN0aW9uTG9jYWwKICAgICAqLwoKICAgIC8qKgogICAgICogZGlyZWN0aW9uV29ybGQKICAgICAqLwoKICAgIC8qKgogICAgICogYXhsZUxvY2FsCiAgICAgKi8KCiAgICAvKioKICAgICAqIGF4bGVXb3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiBzdXNwZW5zaW9uUmVzdExlbmd0aAogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBzdXNwZW5zaW9uTWF4TGVuZ3RoCiAgICAgKiBAZGVmYXVsdCAyCiAgICAgKi8KCiAgICAvKioKICAgICAqIHJhZGl1cwogICAgICogQGRlZmF1bHQgMQogICAgICovCgogICAgLyoqCiAgICAgKiBzdXNwZW5zaW9uU3RpZmZuZXNzCiAgICAgKiBAZGVmYXVsdCAxMDAKICAgICAqLwoKICAgIC8qKgogICAgICogZGFtcGluZ0NvbXByZXNzaW9uCiAgICAgKiBAZGVmYXVsdCAxMAogICAgICovCgogICAgLyoqCiAgICAgKiBkYW1waW5nUmVsYXhhdGlvbgogICAgICogQGRlZmF1bHQgMTAKICAgICAqLwoKICAgIC8qKgogICAgICogZnJpY3Rpb25TbGlwCiAgICAgKiBAZGVmYXVsdCAxMC41CiAgICAgKi8KCiAgICAvKiogZm9yd2FyZEFjY2VsZXJhdGlvbiAqLwoKICAgIC8qKiBzaWRlQWNjZWxlcmF0aW9uICovCgogICAgLyoqCiAgICAgKiBzdGVlcmluZwogICAgICogQGRlZmF1bHQgMAogICAgICovCgogICAgLyoqCiAgICAgKiBSb3RhdGlvbiB2YWx1ZSwgaW4gcmFkaWFucy4KICAgICAqIEBkZWZhdWx0IDAKICAgICAqLwoKICAgIC8qKgogICAgICogZGVsdGFSb3RhdGlvbgogICAgICogQGRlZmF1bHQgMAogICAgICovCgogICAgLyoqCiAgICAgKiByb2xsSW5mbHVlbmNlCiAgICAgKiBAZGVmYXVsdCAwLjAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIG1heFN1c3BlbnNpb25Gb3JjZQogICAgICovCgogICAgLyoqCiAgICAgKiBlbmdpbmVGb3JjZQogICAgICovCgogICAgLyoqCiAgICAgKiBicmFrZQogICAgICovCgogICAgLyoqCiAgICAgKiBpc0Zyb250V2hlZWwKICAgICAqIEBkZWZhdWx0IHRydWUKICAgICAqLwoKICAgIC8qKgogICAgICogY2xpcHBlZEludkNvbnRhY3REb3RTdXNwZW5zaW9uCiAgICAgKiBAZGVmYXVsdCAxCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5CiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHN1c3BlbnNpb25Gb3JjZQogICAgICogQGRlZmF1bHQgMAogICAgICovCgogICAgLyoqCiAgICAgKiBzbGlwSW5mbwogICAgICovCgogICAgLyoqCiAgICAgKiBza2lkSW5mbwogICAgICogQGRlZmF1bHQgMAogICAgICovCgogICAgLyoqCiAgICAgKiBzdXNwZW5zaW9uTGVuZ3RoCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIHNpZGVJbXB1bHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIGZvcndhcmRJbXB1bHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSByZXN1bHQgZnJvbSByYXljYXN0aW5nLgogICAgICovCgogICAgLyoqCiAgICAgKiBXaGVlbCB3b3JsZCB0cmFuc2Zvcm0uCiAgICAgKi8KCiAgICAvKioKICAgICAqIGlzSW5Db250YWN0CiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy5tYXhTdXNwZW5zaW9uVHJhdmVsID0gdm9pZCAwOwogICAgICB0aGlzLmN1c3RvbVNsaWRpbmdSb3RhdGlvbmFsU3BlZWQgPSB2b2lkIDA7CiAgICAgIHRoaXMudXNlQ3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZCA9IHZvaWQgMDsKICAgICAgdGhpcy5zbGlkaW5nID0gdm9pZCAwOwogICAgICB0aGlzLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbCA9IHZvaWQgMDsKICAgICAgdGhpcy5jaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGlyZWN0aW9uTG9jYWwgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGlyZWN0aW9uV29ybGQgPSB2b2lkIDA7CiAgICAgIHRoaXMuYXhsZUxvY2FsID0gdm9pZCAwOwogICAgICB0aGlzLmF4bGVXb3JsZCA9IHZvaWQgMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uUmVzdExlbmd0aCA9IHZvaWQgMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uTWF4TGVuZ3RoID0gdm9pZCAwOwogICAgICB0aGlzLnJhZGl1cyA9IHZvaWQgMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uU3RpZmZuZXNzID0gdm9pZCAwOwogICAgICB0aGlzLmRhbXBpbmdDb21wcmVzc2lvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5kYW1waW5nUmVsYXhhdGlvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5mcmljdGlvblNsaXAgPSB2b2lkIDA7CiAgICAgIHRoaXMuZm9yd2FyZEFjY2VsZXJhdGlvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5zaWRlQWNjZWxlcmF0aW9uID0gdm9pZCAwOwogICAgICB0aGlzLnN0ZWVyaW5nID0gdm9pZCAwOwogICAgICB0aGlzLnJvdGF0aW9uID0gdm9pZCAwOwogICAgICB0aGlzLmRlbHRhUm90YXRpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMucm9sbEluZmx1ZW5jZSA9IHZvaWQgMDsKICAgICAgdGhpcy5tYXhTdXNwZW5zaW9uRm9yY2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuZW5naW5lRm9yY2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuYnJha2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuaXNGcm9udFdoZWVsID0gdm9pZCAwOwogICAgICB0aGlzLmNsaXBwZWRJbnZDb250YWN0RG90U3VzcGVuc2lvbiA9IHZvaWQgMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uUmVsYXRpdmVWZWxvY2l0eSA9IHZvaWQgMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uRm9yY2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuc2xpcEluZm8gPSB2b2lkIDA7CiAgICAgIHRoaXMuc2tpZEluZm8gPSB2b2lkIDA7CiAgICAgIHRoaXMuc3VzcGVuc2lvbkxlbmd0aCA9IHZvaWQgMDsKICAgICAgdGhpcy5zaWRlSW1wdWxzZSA9IHZvaWQgMDsKICAgICAgdGhpcy5mb3J3YXJkSW1wdWxzZSA9IHZvaWQgMDsKICAgICAgdGhpcy5yYXljYXN0UmVzdWx0ID0gdm9pZCAwOwogICAgICB0aGlzLndvcmxkVHJhbnNmb3JtID0gdm9pZCAwOwogICAgICB0aGlzLmlzSW5Db250YWN0ID0gdm9pZCAwOwogICAgICBvcHRpb25zID0gVXRpbHMuZGVmYXVsdHMob3B0aW9ucywgewogICAgICAgIGNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbDogbmV3IFZlYzMoKSwKICAgICAgICBjaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQ6IG5ldyBWZWMzKCksCiAgICAgICAgZGlyZWN0aW9uTG9jYWw6IG5ldyBWZWMzKCksCiAgICAgICAgZGlyZWN0aW9uV29ybGQ6IG5ldyBWZWMzKCksCiAgICAgICAgYXhsZUxvY2FsOiBuZXcgVmVjMygpLAogICAgICAgIGF4bGVXb3JsZDogbmV3IFZlYzMoKSwKICAgICAgICBzdXNwZW5zaW9uUmVzdExlbmd0aDogMSwKICAgICAgICBzdXNwZW5zaW9uTWF4TGVuZ3RoOiAyLAogICAgICAgIHJhZGl1czogMSwKICAgICAgICBzdXNwZW5zaW9uU3RpZmZuZXNzOiAxMDAsCiAgICAgICAgZGFtcGluZ0NvbXByZXNzaW9uOiAxMCwKICAgICAgICBkYW1waW5nUmVsYXhhdGlvbjogMTAsCiAgICAgICAgZnJpY3Rpb25TbGlwOiAxMC41LAogICAgICAgIGZvcndhcmRBY2NlbGVyYXRpb246IDEsCiAgICAgICAgc2lkZUFjY2VsZXJhdGlvbjogMSwKICAgICAgICBzdGVlcmluZzogMCwKICAgICAgICByb3RhdGlvbjogMCwKICAgICAgICBkZWx0YVJvdGF0aW9uOiAwLAogICAgICAgIHJvbGxJbmZsdWVuY2U6IDAuMDEsCiAgICAgICAgbWF4U3VzcGVuc2lvbkZvcmNlOiBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgIGlzRnJvbnRXaGVlbDogdHJ1ZSwKICAgICAgICBjbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb246IDEsCiAgICAgICAgc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHk6IDAsCiAgICAgICAgc3VzcGVuc2lvbkZvcmNlOiAwLAogICAgICAgIHNsaXBJbmZvOiAwLAogICAgICAgIHNraWRJbmZvOiAwLAogICAgICAgIHN1c3BlbnNpb25MZW5ndGg6IDAsCiAgICAgICAgbWF4U3VzcGVuc2lvblRyYXZlbDogMSwKICAgICAgICB1c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOiBmYWxzZSwKICAgICAgICBjdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOiAtMC4xCiAgICAgIH0pOwogICAgICB0aGlzLm1heFN1c3BlbnNpb25UcmF2ZWwgPSBvcHRpb25zLm1heFN1c3BlbnNpb25UcmF2ZWw7CiAgICAgIHRoaXMuY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZCA9IG9wdGlvbnMuY3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZDsKICAgICAgdGhpcy51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkID0gb3B0aW9ucy51c2VDdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkOwogICAgICB0aGlzLnNsaWRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5jaGFzc2lzQ29ubmVjdGlvblBvaW50TG9jYWwgPSBvcHRpb25zLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbC5jbG9uZSgpOwogICAgICB0aGlzLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZCA9IG9wdGlvbnMuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uTG9jYWwgPSBvcHRpb25zLmRpcmVjdGlvbkxvY2FsLmNsb25lKCk7CiAgICAgIHRoaXMuZGlyZWN0aW9uV29ybGQgPSBvcHRpb25zLmRpcmVjdGlvbldvcmxkLmNsb25lKCk7CiAgICAgIHRoaXMuYXhsZUxvY2FsID0gb3B0aW9ucy5heGxlTG9jYWwuY2xvbmUoKTsKICAgICAgdGhpcy5heGxlV29ybGQgPSBvcHRpb25zLmF4bGVXb3JsZC5jbG9uZSgpOwogICAgICB0aGlzLnN1c3BlbnNpb25SZXN0TGVuZ3RoID0gb3B0aW9ucy5zdXNwZW5zaW9uUmVzdExlbmd0aDsKICAgICAgdGhpcy5zdXNwZW5zaW9uTWF4TGVuZ3RoID0gb3B0aW9ucy5zdXNwZW5zaW9uTWF4TGVuZ3RoOwogICAgICB0aGlzLnJhZGl1cyA9IG9wdGlvbnMucmFkaXVzOwogICAgICB0aGlzLnN1c3BlbnNpb25TdGlmZm5lc3MgPSBvcHRpb25zLnN1c3BlbnNpb25TdGlmZm5lc3M7CiAgICAgIHRoaXMuZGFtcGluZ0NvbXByZXNzaW9uID0gb3B0aW9ucy5kYW1waW5nQ29tcHJlc3Npb247CiAgICAgIHRoaXMuZGFtcGluZ1JlbGF4YXRpb24gPSBvcHRpb25zLmRhbXBpbmdSZWxheGF0aW9uOwogICAgICB0aGlzLmZyaWN0aW9uU2xpcCA9IG9wdGlvbnMuZnJpY3Rpb25TbGlwOwogICAgICB0aGlzLmZvcndhcmRBY2NlbGVyYXRpb24gPSBvcHRpb25zLmZvcndhcmRBY2NlbGVyYXRpb247CiAgICAgIHRoaXMuc2lkZUFjY2VsZXJhdGlvbiA9IG9wdGlvbnMuc2lkZUFjY2VsZXJhdGlvbjsKICAgICAgdGhpcy5zdGVlcmluZyA9IDA7CiAgICAgIHRoaXMucm90YXRpb24gPSAwOwogICAgICB0aGlzLmRlbHRhUm90YXRpb24gPSAwOwogICAgICB0aGlzLnJvbGxJbmZsdWVuY2UgPSBvcHRpb25zLnJvbGxJbmZsdWVuY2U7CiAgICAgIHRoaXMubWF4U3VzcGVuc2lvbkZvcmNlID0gb3B0aW9ucy5tYXhTdXNwZW5zaW9uRm9yY2U7CiAgICAgIHRoaXMuZW5naW5lRm9yY2UgPSAwOwogICAgICB0aGlzLmJyYWtlID0gMDsKICAgICAgdGhpcy5pc0Zyb250V2hlZWwgPSBvcHRpb25zLmlzRnJvbnRXaGVlbDsKICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxOwogICAgICB0aGlzLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMDsKICAgICAgdGhpcy5zdXNwZW5zaW9uRm9yY2UgPSAwOwogICAgICB0aGlzLnNsaXBJbmZvID0gMDsKICAgICAgdGhpcy5za2lkSW5mbyA9IDA7CiAgICAgIHRoaXMuc3VzcGVuc2lvbkxlbmd0aCA9IDA7CiAgICAgIHRoaXMuc2lkZUltcHVsc2UgPSAwOwogICAgICB0aGlzLmZvcndhcmRJbXB1bHNlID0gMDsKICAgICAgdGhpcy5yYXljYXN0UmVzdWx0ID0gbmV3IFJheWNhc3RSZXN1bHQoKTsKICAgICAgdGhpcy53b3JsZFRyYW5zZm9ybSA9IG5ldyBUcmFuc2Zvcm0oKTsKICAgICAgdGhpcy5pc0luQ29udGFjdCA9IGZhbHNlOwogICAgfQoKICAgIHVwZGF0ZVdoZWVsKGNoYXNzaXMpIHsKICAgICAgY29uc3QgcmF5Y2FzdFJlc3VsdCA9IHRoaXMucmF5Y2FzdFJlc3VsdDsKCiAgICAgIGlmICh0aGlzLmlzSW5Db250YWN0KSB7CiAgICAgICAgY29uc3QgcHJvamVjdCA9IHJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQuZG90KHJheWNhc3RSZXN1bHQuZGlyZWN0aW9uV29ybGQpOwogICAgICAgIHJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGNoYXNzaXMucG9zaXRpb24sIHJlbHBvcyk7CiAgICAgICAgY2hhc3Npcy5nZXRWZWxvY2l0eUF0V29ybGRQb2ludChyZWxwb3MsIGNoYXNzaXNfdmVsb2NpdHlfYXRfY29udGFjdFBvaW50KTsKICAgICAgICBjb25zdCBwcm9qVmVsID0gcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZC5kb3QoY2hhc3Npc192ZWxvY2l0eV9hdF9jb250YWN0UG9pbnQpOwoKICAgICAgICBpZiAocHJvamVjdCA+PSAtMC4xKSB7CiAgICAgICAgICB0aGlzLnN1c3BlbnNpb25SZWxhdGl2ZVZlbG9jaXR5ID0gMC4wOwogICAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjAgLyAwLjE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGludiA9IC0xIC8gcHJvamVjdDsKICAgICAgICAgIHRoaXMuc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkgPSBwcm9qVmVsICogaW52OwogICAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSBpbnY7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIE5vdCBpbiBjb250YWN0IDogcG9zaXRpb24gd2hlZWwgaW4gYSBuaWNlIChyZXN0IGxlbmd0aCkgcG9zaXRpb24KICAgICAgICByYXljYXN0UmVzdWx0LnN1c3BlbnNpb25MZW5ndGggPSB0aGlzLnN1c3BlbnNpb25SZXN0TGVuZ3RoOwogICAgICAgIHRoaXMuc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkgPSAwLjA7CiAgICAgICAgcmF5Y2FzdFJlc3VsdC5kaXJlY3Rpb25Xb3JsZC5zY2FsZSgtMSwgcmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZCk7CiAgICAgICAgdGhpcy5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxLjA7CiAgICAgIH0KICAgIH0KCiAgfQoKICBjb25zdCBjaGFzc2lzX3ZlbG9jaXR5X2F0X2NvbnRhY3RQb2ludCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcmVscG9zID0gbmV3IFZlYzMoKTsKICAvKioKICAgKiBWZWhpY2xlIGhlbHBlciBjbGFzcyB0aGF0IGNhc3RzIHJheXMgZnJvbSB0aGUgd2hlZWwgcG9zaXRpb25zIHRvd2FyZHMgdGhlIGdyb3VuZCBhbmQgYXBwbGllcyBmb3JjZXMuCiAgICovCgogIGNsYXNzIFJheWNhc3RWZWhpY2xlIHsKICAgIC8qKiBUaGUgY2FyIGNoYXNzaXMgYm9keS4gKi8KCiAgICAvKiogVGhlIHdoZWVscy4gKi8KCiAgICAvKiogV2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiB0aGUgY2FyIGlzIHNsaWRpbmcuICovCgogICAgLyoqIEluZGV4IG9mIHRoZSByaWdodCBheGlzLiB4PTAsIHk9MSwgej0yICovCgogICAgLyoqIEluZGV4IG9mIHRoZSBmb3J3YXJkIGF4aXMuIHg9MCwgeT0xLCB6PTIgKi8KCiAgICAvKiogSW5kZXggb2YgdGhlIHVwIGF4aXMuIHg9MCwgeT0xLCB6PTIgKi8KCiAgICAvKiogVGhlIGNvbnN0cmFpbnRzLiAqLwoKICAgIC8qKiBPcHRpb25hbCBwcmUtc3RlcCBjYWxsYmFjay4gKi8KCiAgICAvKiogTnVtYmVyIG9mIHdoZWVscyBvbiB0aGUgZ3JvdW5kLiAqLwogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICB0aGlzLmNoYXNzaXNCb2R5ID0gdm9pZCAwOwogICAgICB0aGlzLndoZWVsSW5mb3MgPSB2b2lkIDA7CiAgICAgIHRoaXMuc2xpZGluZyA9IHZvaWQgMDsKICAgICAgdGhpcy53b3JsZCA9IHZvaWQgMDsKICAgICAgdGhpcy5pbmRleFJpZ2h0QXhpcyA9IHZvaWQgMDsKICAgICAgdGhpcy5pbmRleEZvcndhcmRBeGlzID0gdm9pZCAwOwogICAgICB0aGlzLmluZGV4VXBBeGlzID0gdm9pZCAwOwogICAgICB0aGlzLmNvbnN0cmFpbnRzID0gdm9pZCAwOwogICAgICB0aGlzLnByZVN0ZXBDYWxsYmFjayA9IHZvaWQgMDsKICAgICAgdGhpcy5jdXJyZW50VmVoaWNsZVNwZWVkS21Ib3VyID0gdm9pZCAwOwogICAgICB0aGlzLm51bVdoZWVsc09uR3JvdW5kID0gdm9pZCAwOwogICAgICB0aGlzLmNoYXNzaXNCb2R5ID0gb3B0aW9ucy5jaGFzc2lzQm9keTsKICAgICAgdGhpcy53aGVlbEluZm9zID0gW107CiAgICAgIHRoaXMuc2xpZGluZyA9IGZhbHNlOwogICAgICB0aGlzLndvcmxkID0gbnVsbDsKICAgICAgdGhpcy5pbmRleFJpZ2h0QXhpcyA9IHR5cGVvZiBvcHRpb25zLmluZGV4UmlnaHRBeGlzICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuaW5kZXhSaWdodEF4aXMgOiAyOwogICAgICB0aGlzLmluZGV4Rm9yd2FyZEF4aXMgPSB0eXBlb2Ygb3B0aW9ucy5pbmRleEZvcndhcmRBeGlzICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMuaW5kZXhGb3J3YXJkQXhpcyA6IDA7CiAgICAgIHRoaXMuaW5kZXhVcEF4aXMgPSB0eXBlb2Ygb3B0aW9ucy5pbmRleFVwQXhpcyAhPT0gJ3VuZGVmaW5lZCcgPyBvcHRpb25zLmluZGV4VXBBeGlzIDogMTsKICAgICAgdGhpcy5jb25zdHJhaW50cyA9IFtdOwoKICAgICAgdGhpcy5wcmVTdGVwQ2FsbGJhY2sgPSAoKSA9PiB7fTsKCiAgICAgIHRoaXMuY3VycmVudFZlaGljbGVTcGVlZEttSG91ciA9IDA7CiAgICAgIHRoaXMubnVtV2hlZWxzT25Hcm91bmQgPSAwOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSB3aGVlbC4gRm9yIGluZm9ybWF0aW9uIGFib3V0IHRoZSBvcHRpb25zLCBzZWUgYFdoZWVsSW5mb2AuCiAgICAgKi8KCgogICAgYWRkV2hlZWwob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBjb25zdCBpbmZvID0gbmV3IFdoZWVsSW5mbyhvcHRpb25zKTsKICAgICAgY29uc3QgaW5kZXggPSB0aGlzLndoZWVsSW5mb3MubGVuZ3RoOwogICAgICB0aGlzLndoZWVsSW5mb3MucHVzaChpbmZvKTsKICAgICAgcmV0dXJuIGluZGV4OwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHN0ZWVyaW5nIHZhbHVlIG9mIGEgd2hlZWwuCiAgICAgKi8KCgogICAgc2V0U3RlZXJpbmdWYWx1ZSh2YWx1ZSwgd2hlZWxJbmRleCkgewogICAgICBjb25zdCB3aGVlbCA9IHRoaXMud2hlZWxJbmZvc1t3aGVlbEluZGV4XTsKICAgICAgd2hlZWwuc3RlZXJpbmcgPSB2YWx1ZTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSB3aGVlbCBmb3JjZSB0byBhcHBseSBvbiBvbmUgb2YgdGhlIHdoZWVscyBlYWNoIHRpbWUgc3RlcAogICAgICovCgoKICAgIGFwcGx5RW5naW5lRm9yY2UodmFsdWUsIHdoZWVsSW5kZXgpIHsKICAgICAgdGhpcy53aGVlbEluZm9zW3doZWVsSW5kZXhdLmVuZ2luZUZvcmNlID0gdmFsdWU7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgYnJha2luZyBmb3JjZSBvZiBhIHdoZWVsCiAgICAgKi8KCgogICAgc2V0QnJha2UoYnJha2UsIHdoZWVsSW5kZXgpIHsKICAgICAgdGhpcy53aGVlbEluZm9zW3doZWVsSW5kZXhdLmJyYWtlID0gYnJha2U7CiAgICB9CiAgICAvKioKICAgICAqIEFkZCB0aGUgdmVoaWNsZSBpbmNsdWRpbmcgaXRzIGNvbnN0cmFpbnRzIHRvIHRoZSB3b3JsZC4KICAgICAqLwoKCiAgICBhZGRUb1dvcmxkKHdvcmxkKSB7CiAgICAgIHdvcmxkLmFkZEJvZHkodGhpcy5jaGFzc2lzQm9keSk7CiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzOwoKICAgICAgdGhpcy5wcmVTdGVwQ2FsbGJhY2sgPSAoKSA9PiB7CiAgICAgICAgdGhhdC51cGRhdGVWZWhpY2xlKHdvcmxkLmR0KTsKICAgICAgfTsKCiAgICAgIHdvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ3ByZVN0ZXAnLCB0aGlzLnByZVN0ZXBDYWxsYmFjayk7CiAgICAgIHRoaXMud29ybGQgPSB3b3JsZDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IG9uZSBvZiB0aGUgd2hlZWwgYXhsZXMsIHdvcmxkLW9yaWVudGVkLgogICAgICovCgoKICAgIGdldFZlaGljbGVBeGlzV29ybGQoYXhpc0luZGV4LCByZXN1bHQpIHsKICAgICAgcmVzdWx0LnNldChheGlzSW5kZXggPT09IDAgPyAxIDogMCwgYXhpc0luZGV4ID09PSAxID8gMSA6IDAsIGF4aXNJbmRleCA9PT0gMiA/IDEgOiAwKTsKICAgICAgdGhpcy5jaGFzc2lzQm9keS52ZWN0b3JUb1dvcmxkRnJhbWUocmVzdWx0LCByZXN1bHQpOwogICAgfQoKICAgIHVwZGF0ZVZlaGljbGUodGltZVN0ZXApIHsKICAgICAgY29uc3Qgd2hlZWxJbmZvcyA9IHRoaXMud2hlZWxJbmZvczsKICAgICAgY29uc3QgbnVtV2hlZWxzID0gd2hlZWxJbmZvcy5sZW5ndGg7CiAgICAgIGNvbnN0IGNoYXNzaXNCb2R5ID0gdGhpcy5jaGFzc2lzQm9keTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICB0aGlzLnVwZGF0ZVdoZWVsVHJhbnNmb3JtKGkpOwogICAgICB9CgogICAgICB0aGlzLmN1cnJlbnRWZWhpY2xlU3BlZWRLbUhvdXIgPSAzLjYgKiBjaGFzc2lzQm9keS52ZWxvY2l0eS5sZW5ndGgoKTsKICAgICAgY29uc3QgZm9yd2FyZFdvcmxkID0gbmV3IFZlYzMoKTsKICAgICAgdGhpcy5nZXRWZWhpY2xlQXhpc1dvcmxkKHRoaXMuaW5kZXhGb3J3YXJkQXhpcywgZm9yd2FyZFdvcmxkKTsKCiAgICAgIGlmIChmb3J3YXJkV29ybGQuZG90KGNoYXNzaXNCb2R5LnZlbG9jaXR5KSA8IDApIHsKICAgICAgICB0aGlzLmN1cnJlbnRWZWhpY2xlU3BlZWRLbUhvdXIgKj0gLTE7CiAgICAgIH0gLy8gc2ltdWxhdGUgc3VzcGVuc2lvbgoKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICB0aGlzLmNhc3RSYXkod2hlZWxJbmZvc1tpXSk7CiAgICAgIH0KCiAgICAgIHRoaXMudXBkYXRlU3VzcGVuc2lvbih0aW1lU3RlcCk7CiAgICAgIGNvbnN0IGltcHVsc2UgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCByZWxwb3MgPSBuZXcgVmVjMygpOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIC8vYXBwbHkgc3VzcGVuc2lvbiBmb3JjZQogICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsKICAgICAgICBsZXQgc3VzcGVuc2lvbkZvcmNlID0gd2hlZWwuc3VzcGVuc2lvbkZvcmNlOwoKICAgICAgICBpZiAoc3VzcGVuc2lvbkZvcmNlID4gd2hlZWwubWF4U3VzcGVuc2lvbkZvcmNlKSB7CiAgICAgICAgICBzdXNwZW5zaW9uRm9yY2UgPSB3aGVlbC5tYXhTdXNwZW5zaW9uRm9yY2U7CiAgICAgICAgfQoKICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkLnNjYWxlKHN1c3BlbnNpb25Gb3JjZSAqIHRpbWVTdGVwLCBpbXB1bHNlKTsKICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdFBvaW50V29ybGQudnN1YihjaGFzc2lzQm9keS5wb3NpdGlvbiwgcmVscG9zKTsKICAgICAgICBjaGFzc2lzQm9keS5hcHBseUltcHVsc2UoaW1wdWxzZSwgcmVscG9zKTsKICAgICAgfQoKICAgICAgdGhpcy51cGRhdGVGcmljdGlvbih0aW1lU3RlcCk7CiAgICAgIGNvbnN0IGhpdE5vcm1hbFdvcmxkU2NhbGVkV2l0aFByb2ogPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBmd2QgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCB2ZWwgPSBuZXcgVmVjMygpOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1XaGVlbHM7IGkrKykgewogICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1tpXTsgLy9jb25zdCByZWxwb3MgPSBuZXcgVmVjMygpOwogICAgICAgIC8vd2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkLnZzdWIoY2hhc3Npc0JvZHkucG9zaXRpb24sIHJlbHBvcyk7CgogICAgICAgIGNoYXNzaXNCb2R5LmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHdoZWVsLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZCwgdmVsKTsgLy8gSGFjayB0byBnZXQgdGhlIHJvdGF0aW9uIGluIHRoZSBjb3JyZWN0IGRpcmVjdGlvbgoKICAgICAgICBsZXQgbSA9IDE7CgogICAgICAgIHN3aXRjaCAodGhpcy5pbmRleFVwQXhpcykgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBtID0gLTE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdoZWVsLmlzSW5Db250YWN0KSB7CiAgICAgICAgICB0aGlzLmdldFZlaGljbGVBeGlzV29ybGQodGhpcy5pbmRleEZvcndhcmRBeGlzLCBmd2QpOwogICAgICAgICAgY29uc3QgcHJvaiA9IGZ3ZC5kb3Qod2hlZWwucmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZCk7CiAgICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkLnNjYWxlKHByb2osIGhpdE5vcm1hbFdvcmxkU2NhbGVkV2l0aFByb2opOwogICAgICAgICAgZndkLnZzdWIoaGl0Tm9ybWFsV29ybGRTY2FsZWRXaXRoUHJvaiwgZndkKTsKICAgICAgICAgIGNvbnN0IHByb2oyID0gZndkLmRvdCh2ZWwpOwogICAgICAgICAgd2hlZWwuZGVsdGFSb3RhdGlvbiA9IG0gKiBwcm9qMiAqIHRpbWVTdGVwIC8gd2hlZWwucmFkaXVzOwogICAgICAgIH0KCiAgICAgICAgaWYgKCh3aGVlbC5zbGlkaW5nIHx8ICF3aGVlbC5pc0luQ29udGFjdCkgJiYgd2hlZWwuZW5naW5lRm9yY2UgIT09IDAgJiYgd2hlZWwudXNlQ3VzdG9tU2xpZGluZ1JvdGF0aW9uYWxTcGVlZCkgewogICAgICAgICAgLy8gQXBwbHkgY3VzdG9tIHJvdGF0aW9uIHdoZW4gYWNjZWxlcmF0aW5nIGFuZCBzbGlkaW5nCiAgICAgICAgICB3aGVlbC5kZWx0YVJvdGF0aW9uID0gKHdoZWVsLmVuZ2luZUZvcmNlID4gMCA/IDEgOiAtMSkgKiB3aGVlbC5jdXN0b21TbGlkaW5nUm90YXRpb25hbFNwZWVkICogdGltZVN0ZXA7CiAgICAgICAgfSAvLyBMb2NrIHdoZWVscwoKCiAgICAgICAgaWYgKE1hdGguYWJzKHdoZWVsLmJyYWtlKSA+IE1hdGguYWJzKHdoZWVsLmVuZ2luZUZvcmNlKSkgewogICAgICAgICAgd2hlZWwuZGVsdGFSb3RhdGlvbiA9IDA7CiAgICAgICAgfQoKICAgICAgICB3aGVlbC5yb3RhdGlvbiArPSB3aGVlbC5kZWx0YVJvdGF0aW9uOyAvLyBVc2UgdGhlIG9sZCB2YWx1ZQoKICAgICAgICB3aGVlbC5kZWx0YVJvdGF0aW9uICo9IDAuOTk7IC8vIGRhbXBpbmcgb2Ygcm90YXRpb24gd2hlbiBub3QgaW4gY29udGFjdAogICAgICB9CiAgICB9CgogICAgdXBkYXRlU3VzcGVuc2lvbihkZWx0YVRpbWUpIHsKICAgICAgY29uc3QgY2hhc3Npc0JvZHkgPSB0aGlzLmNoYXNzaXNCb2R5OwogICAgICBjb25zdCBjaGFzc2lzTWFzcyA9IGNoYXNzaXNCb2R5Lm1hc3M7CiAgICAgIGNvbnN0IHdoZWVsSW5mb3MgPSB0aGlzLndoZWVsSW5mb3M7CiAgICAgIGNvbnN0IG51bVdoZWVscyA9IHdoZWVsSW5mb3MubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgd19pdCA9IDA7IHdfaXQgPCBudW1XaGVlbHM7IHdfaXQrKykgewogICAgICAgIGNvbnN0IHdoZWVsID0gd2hlZWxJbmZvc1t3X2l0XTsKCiAgICAgICAgaWYgKHdoZWVsLmlzSW5Db250YWN0KSB7CiAgICAgICAgICBsZXQgZm9yY2U7IC8vIFNwcmluZwoKICAgICAgICAgIGNvbnN0IHN1c3BfbGVuZ3RoID0gd2hlZWwuc3VzcGVuc2lvblJlc3RMZW5ndGg7CiAgICAgICAgICBjb25zdCBjdXJyZW50X2xlbmd0aCA9IHdoZWVsLnN1c3BlbnNpb25MZW5ndGg7CiAgICAgICAgICBjb25zdCBsZW5ndGhfZGlmZiA9IHN1c3BfbGVuZ3RoIC0gY3VycmVudF9sZW5ndGg7CiAgICAgICAgICBmb3JjZSA9IHdoZWVsLnN1c3BlbnNpb25TdGlmZm5lc3MgKiBsZW5ndGhfZGlmZiAqIHdoZWVsLmNsaXBwZWRJbnZDb250YWN0RG90U3VzcGVuc2lvbjsgLy8gRGFtcGVyCgogICAgICAgICAgY29uc3QgcHJvamVjdGVkX3JlbF92ZWwgPSB3aGVlbC5zdXNwZW5zaW9uUmVsYXRpdmVWZWxvY2l0eTsKICAgICAgICAgIGxldCBzdXNwX2RhbXBpbmc7CgogICAgICAgICAgaWYgKHByb2plY3RlZF9yZWxfdmVsIDwgMCkgewogICAgICAgICAgICBzdXNwX2RhbXBpbmcgPSB3aGVlbC5kYW1waW5nQ29tcHJlc3Npb247CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdXNwX2RhbXBpbmcgPSB3aGVlbC5kYW1waW5nUmVsYXhhdGlvbjsKICAgICAgICAgIH0KCiAgICAgICAgICBmb3JjZSAtPSBzdXNwX2RhbXBpbmcgKiBwcm9qZWN0ZWRfcmVsX3ZlbDsKICAgICAgICAgIHdoZWVsLnN1c3BlbnNpb25Gb3JjZSA9IGZvcmNlICogY2hhc3Npc01hc3M7CgogICAgICAgICAgaWYgKHdoZWVsLnN1c3BlbnNpb25Gb3JjZSA8IDApIHsKICAgICAgICAgICAgd2hlZWwuc3VzcGVuc2lvbkZvcmNlID0gMDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2hlZWwuc3VzcGVuc2lvbkZvcmNlID0gMDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlIHRoZSB2ZWhpY2xlIGluY2x1ZGluZyBpdHMgY29uc3RyYWludHMgZnJvbSB0aGUgd29ybGQuCiAgICAgKi8KCgogICAgcmVtb3ZlRnJvbVdvcmxkKHdvcmxkKSB7CiAgICAgIHRoaXMuY29uc3RyYWludHM7CiAgICAgIHdvcmxkLnJlbW92ZUJvZHkodGhpcy5jaGFzc2lzQm9keSk7CiAgICAgIHdvcmxkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3ByZVN0ZXAnLCB0aGlzLnByZVN0ZXBDYWxsYmFjayk7CiAgICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgfQoKICAgIGNhc3RSYXkod2hlZWwpIHsKICAgICAgY29uc3QgcmF5dmVjdG9yID0gY2FzdFJheV9yYXl2ZWN0b3I7CiAgICAgIGNvbnN0IHRhcmdldCA9IGNhc3RSYXlfdGFyZ2V0OwogICAgICB0aGlzLnVwZGF0ZVdoZWVsVHJhbnNmb3JtV29ybGQod2hlZWwpOwogICAgICBjb25zdCBjaGFzc2lzQm9keSA9IHRoaXMuY2hhc3Npc0JvZHk7CiAgICAgIGxldCBkZXB0aCA9IC0xOwogICAgICBjb25zdCByYXlsZW4gPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aCArIHdoZWVsLnJhZGl1czsKICAgICAgd2hlZWwuZGlyZWN0aW9uV29ybGQuc2NhbGUocmF5bGVuLCByYXl2ZWN0b3IpOwogICAgICBjb25zdCBzb3VyY2UgPSB3aGVlbC5jaGFzc2lzQ29ubmVjdGlvblBvaW50V29ybGQ7CiAgICAgIHNvdXJjZS52YWRkKHJheXZlY3RvciwgdGFyZ2V0KTsKICAgICAgY29uc3QgcmF5Y2FzdFJlc3VsdCA9IHdoZWVsLnJheWNhc3RSZXN1bHQ7CiAgICAgIHJheWNhc3RSZXN1bHQucmVzZXQoKTsgLy8gVHVybiBvZmYgcmF5IGNvbGxpc2lvbiB3aXRoIHRoZSBjaGFzc2lzIHRlbXBvcmFyaWx5CgogICAgICBjb25zdCBvbGRTdGF0ZSA9IGNoYXNzaXNCb2R5LmNvbGxpc2lvblJlc3BvbnNlOwogICAgICBjaGFzc2lzQm9keS5jb2xsaXNpb25SZXNwb25zZSA9IGZhbHNlOyAvLyBDYXN0IHJheSBhZ2FpbnN0IHdvcmxkCgogICAgICB0aGlzLndvcmxkLnJheVRlc3Qoc291cmNlLCB0YXJnZXQsIHJheWNhc3RSZXN1bHQpOwogICAgICBjaGFzc2lzQm9keS5jb2xsaXNpb25SZXNwb25zZSA9IG9sZFN0YXRlOwogICAgICBjb25zdCBvYmplY3QgPSByYXljYXN0UmVzdWx0LmJvZHk7CiAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuZ3JvdW5kT2JqZWN0ID0gMDsKCiAgICAgIGlmIChvYmplY3QpIHsKICAgICAgICBkZXB0aCA9IHJheWNhc3RSZXN1bHQuZGlzdGFuY2U7CiAgICAgICAgd2hlZWwucmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZCA9IHJheWNhc3RSZXN1bHQuaGl0Tm9ybWFsV29ybGQ7CiAgICAgICAgd2hlZWwuaXNJbkNvbnRhY3QgPSB0cnVlOwogICAgICAgIGNvbnN0IGhpdERpc3RhbmNlID0gcmF5Y2FzdFJlc3VsdC5kaXN0YW5jZTsKICAgICAgICB3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoID0gaGl0RGlzdGFuY2UgLSB3aGVlbC5yYWRpdXM7IC8vIGNsYW1wIG9uIG1heCBzdXNwZW5zaW9uIHRyYXZlbAoKICAgICAgICBjb25zdCBtaW5TdXNwZW5zaW9uTGVuZ3RoID0gd2hlZWwuc3VzcGVuc2lvblJlc3RMZW5ndGggLSB3aGVlbC5tYXhTdXNwZW5zaW9uVHJhdmVsOwogICAgICAgIGNvbnN0IG1heFN1c3BlbnNpb25MZW5ndGggPSB3aGVlbC5zdXNwZW5zaW9uUmVzdExlbmd0aCArIHdoZWVsLm1heFN1c3BlbnNpb25UcmF2ZWw7CgogICAgICAgIGlmICh3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoIDwgbWluU3VzcGVuc2lvbkxlbmd0aCkgewogICAgICAgICAgd2hlZWwuc3VzcGVuc2lvbkxlbmd0aCA9IG1pblN1c3BlbnNpb25MZW5ndGg7CiAgICAgICAgfQoKICAgICAgICBpZiAod2hlZWwuc3VzcGVuc2lvbkxlbmd0aCA+IG1heFN1c3BlbnNpb25MZW5ndGgpIHsKICAgICAgICAgIHdoZWVsLnN1c3BlbnNpb25MZW5ndGggPSBtYXhTdXNwZW5zaW9uTGVuZ3RoOwogICAgICAgICAgd2hlZWwucmF5Y2FzdFJlc3VsdC5yZXNldCgpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgZGVub21pbmF0b3IgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkLmRvdCh3aGVlbC5kaXJlY3Rpb25Xb3JsZCk7CiAgICAgICAgY29uc3QgY2hhc3Npc192ZWxvY2l0eV9hdF9jb250YWN0UG9pbnQgPSBuZXcgVmVjMygpOwogICAgICAgIGNoYXNzaXNCb2R5LmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZCwgY2hhc3Npc192ZWxvY2l0eV9hdF9jb250YWN0UG9pbnQpOwogICAgICAgIGNvbnN0IHByb2pWZWwgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkLmRvdChjaGFzc2lzX3ZlbG9jaXR5X2F0X2NvbnRhY3RQb2ludCk7CgogICAgICAgIGlmIChkZW5vbWluYXRvciA+PSAtMC4xKSB7CiAgICAgICAgICB3aGVlbC5zdXNwZW5zaW9uUmVsYXRpdmVWZWxvY2l0eSA9IDA7CiAgICAgICAgICB3aGVlbC5jbGlwcGVkSW52Q29udGFjdERvdFN1c3BlbnNpb24gPSAxIC8gMC4xOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBpbnYgPSAtMSAvIGRlbm9taW5hdG9yOwogICAgICAgICAgd2hlZWwuc3VzcGVuc2lvblJlbGF0aXZlVmVsb2NpdHkgPSBwcm9qVmVsICogaW52OwogICAgICAgICAgd2hlZWwuY2xpcHBlZEludkNvbnRhY3REb3RTdXNwZW5zaW9uID0gaW52OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvL3B1dCB3aGVlbCBpbmZvIGFzIGluIHJlc3QgcG9zaXRpb24KICAgICAgICB3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoID0gd2hlZWwuc3VzcGVuc2lvblJlc3RMZW5ndGggKyAwICogd2hlZWwubWF4U3VzcGVuc2lvblRyYXZlbDsKICAgICAgICB3aGVlbC5zdXNwZW5zaW9uUmVsYXRpdmVWZWxvY2l0eSA9IDAuMDsKICAgICAgICB3aGVlbC5kaXJlY3Rpb25Xb3JsZC5zY2FsZSgtMSwgd2hlZWwucmF5Y2FzdFJlc3VsdC5oaXROb3JtYWxXb3JsZCk7CiAgICAgICAgd2hlZWwuY2xpcHBlZEludkNvbnRhY3REb3RTdXNwZW5zaW9uID0gMS4wOwogICAgICB9CgogICAgICByZXR1cm4gZGVwdGg7CiAgICB9CgogICAgdXBkYXRlV2hlZWxUcmFuc2Zvcm1Xb3JsZCh3aGVlbCkgewogICAgICB3aGVlbC5pc0luQ29udGFjdCA9IGZhbHNlOwogICAgICBjb25zdCBjaGFzc2lzQm9keSA9IHRoaXMuY2hhc3Npc0JvZHk7CiAgICAgIGNoYXNzaXNCb2R5LnBvaW50VG9Xb3JsZEZyYW1lKHdoZWVsLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbCwgd2hlZWwuY2hhc3Npc0Nvbm5lY3Rpb25Qb2ludFdvcmxkKTsKICAgICAgY2hhc3Npc0JvZHkudmVjdG9yVG9Xb3JsZEZyYW1lKHdoZWVsLmRpcmVjdGlvbkxvY2FsLCB3aGVlbC5kaXJlY3Rpb25Xb3JsZCk7CiAgICAgIGNoYXNzaXNCb2R5LnZlY3RvclRvV29ybGRGcmFtZSh3aGVlbC5heGxlTG9jYWwsIHdoZWVsLmF4bGVXb3JsZCk7CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSBvbmUgb2YgdGhlIHdoZWVsIHRyYW5zZm9ybS4KICAgICAqIE5vdGUgd2hlbiByZW5kZXJpbmcgd2hlZWxzOiBkdXJpbmcgZWFjaCBzdGVwLCB3aGVlbCB0cmFuc2Zvcm1zIGFyZSB1cGRhdGVkIEJFRk9SRSB0aGUgY2hhc3NpczsgaWUuIHRoZWlyIHBvc2l0aW9uIGJlY29tZXMgaW52YWxpZCBhZnRlciB0aGUgc3RlcC4gVGh1cyB3aGVuIHlvdSByZW5kZXIgd2hlZWxzLCB5b3UgbXVzdCB1cGRhdGUgd2hlZWwgdHJhbnNmb3JtcyBiZWZvcmUgcmVuZGVyaW5nIHRoZW0uIFNlZSByYXljYXN0VmVoaWNsZSBkZW1vIGZvciBhbiBleGFtcGxlLgogICAgICogQHBhcmFtIHdoZWVsSW5kZXggVGhlIHdoZWVsIGluZGV4IHRvIHVwZGF0ZS4KICAgICAqLwoKCiAgICB1cGRhdGVXaGVlbFRyYW5zZm9ybSh3aGVlbEluZGV4KSB7CiAgICAgIGNvbnN0IHVwID0gdG1wVmVjNDsKICAgICAgY29uc3QgcmlnaHQgPSB0bXBWZWM1OwogICAgICBjb25zdCBmd2QgPSB0bXBWZWM2OwogICAgICBjb25zdCB3aGVlbCA9IHRoaXMud2hlZWxJbmZvc1t3aGVlbEluZGV4XTsKICAgICAgdGhpcy51cGRhdGVXaGVlbFRyYW5zZm9ybVdvcmxkKHdoZWVsKTsKICAgICAgd2hlZWwuZGlyZWN0aW9uTG9jYWwuc2NhbGUoLTEsIHVwKTsKICAgICAgcmlnaHQuY29weSh3aGVlbC5heGxlTG9jYWwpOwogICAgICB1cC5jcm9zcyhyaWdodCwgZndkKTsKICAgICAgZndkLm5vcm1hbGl6ZSgpOwogICAgICByaWdodC5ub3JtYWxpemUoKTsgLy8gUm90YXRlIGFyb3VuZCBzdGVlcmluZyBvdmVyIHRoZSB3aGVlbEF4bGUKCiAgICAgIGNvbnN0IHN0ZWVyaW5nID0gd2hlZWwuc3RlZXJpbmc7CiAgICAgIGNvbnN0IHN0ZWVyaW5nT3JuID0gbmV3IFF1YXRlcm5pb24oKTsKICAgICAgc3RlZXJpbmdPcm4uc2V0RnJvbUF4aXNBbmdsZSh1cCwgc3RlZXJpbmcpOwogICAgICBjb25zdCByb3RhdGluZ09ybiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgICAgIHJvdGF0aW5nT3JuLnNldEZyb21BeGlzQW5nbGUocmlnaHQsIHdoZWVsLnJvdGF0aW9uKTsgLy8gV29ybGQgcm90YXRpb24gb2YgdGhlIHdoZWVsCgogICAgICBjb25zdCBxID0gd2hlZWwud29ybGRUcmFuc2Zvcm0ucXVhdGVybmlvbjsKICAgICAgdGhpcy5jaGFzc2lzQm9keS5xdWF0ZXJuaW9uLm11bHQoc3RlZXJpbmdPcm4sIHEpOwogICAgICBxLm11bHQocm90YXRpbmdPcm4sIHEpOwogICAgICBxLm5vcm1hbGl6ZSgpOyAvLyB3b3JsZCBwb3NpdGlvbiBvZiB0aGUgd2hlZWwKCiAgICAgIGNvbnN0IHAgPSB3aGVlbC53b3JsZFRyYW5zZm9ybS5wb3NpdGlvbjsKICAgICAgcC5jb3B5KHdoZWVsLmRpcmVjdGlvbldvcmxkKTsKICAgICAgcC5zY2FsZSh3aGVlbC5zdXNwZW5zaW9uTGVuZ3RoLCBwKTsKICAgICAgcC52YWRkKHdoZWVsLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRXb3JsZCwgcCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgd29ybGQgdHJhbnNmb3JtIG9mIG9uZSBvZiB0aGUgd2hlZWxzCiAgICAgKi8KCgogICAgZ2V0V2hlZWxUcmFuc2Zvcm1Xb3JsZCh3aGVlbEluZGV4KSB7CiAgICAgIHJldHVybiB0aGlzLndoZWVsSW5mb3Nbd2hlZWxJbmRleF0ud29ybGRUcmFuc2Zvcm07CiAgICB9CgogICAgdXBkYXRlRnJpY3Rpb24odGltZVN0ZXApIHsKICAgICAgY29uc3Qgc3VyZk5vcm1hbFdTX3NjYWxlZF9wcm9qID0gdXBkYXRlRnJpY3Rpb25fc3VyZk5vcm1hbFdTX3NjYWxlZF9wcm9qOyAvL2NhbGN1bGF0ZSB0aGUgaW1wdWxzZSwgc28gdGhhdCB0aGUgd2hlZWxzIGRvbid0IG1vdmUgc2lkZXdhcmRzCgogICAgICBjb25zdCB3aGVlbEluZm9zID0gdGhpcy53aGVlbEluZm9zOwogICAgICBjb25zdCBudW1XaGVlbHMgPSB3aGVlbEluZm9zLmxlbmd0aDsKICAgICAgY29uc3QgY2hhc3Npc0JvZHkgPSB0aGlzLmNoYXNzaXNCb2R5OwogICAgICBjb25zdCBmb3J3YXJkV1MgPSB1cGRhdGVGcmljdGlvbl9mb3J3YXJkV1M7CiAgICAgIGNvbnN0IGF4bGUgPSB1cGRhdGVGcmljdGlvbl9heGxlOwogICAgICB0aGlzLm51bVdoZWVsc09uR3JvdW5kID0gMDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICBjb25zdCB3aGVlbCA9IHdoZWVsSW5mb3NbaV07CiAgICAgICAgY29uc3QgZ3JvdW5kT2JqZWN0ID0gd2hlZWwucmF5Y2FzdFJlc3VsdC5ib2R5OwoKICAgICAgICBpZiAoZ3JvdW5kT2JqZWN0KSB7CiAgICAgICAgICB0aGlzLm51bVdoZWVsc09uR3JvdW5kKys7CiAgICAgICAgfQoKICAgICAgICB3aGVlbC5zaWRlSW1wdWxzZSA9IDA7CiAgICAgICAgd2hlZWwuZm9yd2FyZEltcHVsc2UgPSAwOwoKICAgICAgICBpZiAoIWZvcndhcmRXU1tpXSkgewogICAgICAgICAgZm9yd2FyZFdTW2ldID0gbmV3IFZlYzMoKTsKICAgICAgICB9CgogICAgICAgIGlmICghYXhsZVtpXSkgewogICAgICAgICAgYXhsZVtpXSA9IG5ldyBWZWMzKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdoZWVsczsgaSsrKSB7CiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW2ldOwogICAgICAgIGNvbnN0IGdyb3VuZE9iamVjdCA9IHdoZWVsLnJheWNhc3RSZXN1bHQuYm9keTsKCiAgICAgICAgaWYgKGdyb3VuZE9iamVjdCkgewogICAgICAgICAgY29uc3QgYXhsZWkgPSBheGxlW2ldOwogICAgICAgICAgY29uc3Qgd2hlZWxUcmFucyA9IHRoaXMuZ2V0V2hlZWxUcmFuc2Zvcm1Xb3JsZChpKTsgLy8gR2V0IHdvcmxkIGF4bGUKCiAgICAgICAgICB3aGVlbFRyYW5zLnZlY3RvclRvV29ybGRGcmFtZShkaXJlY3Rpb25zW3RoaXMuaW5kZXhSaWdodEF4aXNdLCBheGxlaSk7CiAgICAgICAgICBjb25zdCBzdXJmTm9ybWFsV1MgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdE5vcm1hbFdvcmxkOwogICAgICAgICAgY29uc3QgcHJvaiA9IGF4bGVpLmRvdChzdXJmTm9ybWFsV1MpOwogICAgICAgICAgc3VyZk5vcm1hbFdTLnNjYWxlKHByb2osIHN1cmZOb3JtYWxXU19zY2FsZWRfcHJvaik7CiAgICAgICAgICBheGxlaS52c3ViKHN1cmZOb3JtYWxXU19zY2FsZWRfcHJvaiwgYXhsZWkpOwogICAgICAgICAgYXhsZWkubm9ybWFsaXplKCk7CiAgICAgICAgICBzdXJmTm9ybWFsV1MuY3Jvc3MoYXhsZWksIGZvcndhcmRXU1tpXSk7CiAgICAgICAgICBmb3J3YXJkV1NbaV0ubm9ybWFsaXplKCk7CiAgICAgICAgICB3aGVlbC5zaWRlSW1wdWxzZSA9IHJlc29sdmVTaW5nbGVCaWxhdGVyYWwoY2hhc3Npc0JvZHksIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZCwgZ3JvdW5kT2JqZWN0LCB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdFBvaW50V29ybGQsIGF4bGVpKTsKICAgICAgICAgIHdoZWVsLnNpZGVJbXB1bHNlICo9IHNpZGVGcmljdGlvblN0aWZmbmVzczI7CiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCBzaWRlRmFjdG9yID0gMTsKICAgICAgY29uc3QgZndkRmFjdG9yID0gMC41OwogICAgICB0aGlzLnNsaWRpbmcgPSBmYWxzZTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbnVtV2hlZWxzOyBpKyspIHsKICAgICAgICBjb25zdCB3aGVlbCA9IHdoZWVsSW5mb3NbaV07CiAgICAgICAgY29uc3QgZ3JvdW5kT2JqZWN0ID0gd2hlZWwucmF5Y2FzdFJlc3VsdC5ib2R5OwogICAgICAgIGxldCByb2xsaW5nRnJpY3Rpb24gPSAwOwogICAgICAgIHdoZWVsLnNsaXBJbmZvID0gMTsKCiAgICAgICAgaWYgKGdyb3VuZE9iamVjdCkgewogICAgICAgICAgY29uc3QgZGVmYXVsdFJvbGxpbmdGcmljdGlvbkltcHVsc2UgPSAwOwogICAgICAgICAgY29uc3QgbWF4SW1wdWxzZSA9IHdoZWVsLmJyYWtlID8gd2hlZWwuYnJha2UgOiBkZWZhdWx0Um9sbGluZ0ZyaWN0aW9uSW1wdWxzZTsgLy8gYnRXaGVlbENvbnRhY3RQb2ludCBjb250YWN0UHQoY2hhc3Npc0JvZHksZ3JvdW5kT2JqZWN0LHdoZWVsSW5mcmF5Y2FzdEluZm8uaGl0UG9pbnRXb3JsZCxmb3J3YXJkV1Nbd2hlZWxdLG1heEltcHVsc2UpOwogICAgICAgICAgLy8gcm9sbGluZ0ZyaWN0aW9uID0gY2FsY1JvbGxpbmdGcmljdGlvbihjb250YWN0UHQpOwoKICAgICAgICAgIHJvbGxpbmdGcmljdGlvbiA9IGNhbGNSb2xsaW5nRnJpY3Rpb24oY2hhc3Npc0JvZHksIGdyb3VuZE9iamVjdCwgd2hlZWwucmF5Y2FzdFJlc3VsdC5oaXRQb2ludFdvcmxkLCBmb3J3YXJkV1NbaV0sIG1heEltcHVsc2UpOwogICAgICAgICAgcm9sbGluZ0ZyaWN0aW9uICs9IHdoZWVsLmVuZ2luZUZvcmNlICogdGltZVN0ZXA7IC8vIHJvbGxpbmdGcmljdGlvbiA9IDA7CgogICAgICAgICAgY29uc3QgZmFjdG9yID0gbWF4SW1wdWxzZSAvIHJvbGxpbmdGcmljdGlvbjsKICAgICAgICAgIHdoZWVsLnNsaXBJbmZvICo9IGZhY3RvcjsKICAgICAgICB9IC8vc3dpdGNoIGJldHdlZW4gYWN0aXZlIHJvbGxpbmcgKHRocm90dGxlKSwgYnJha2luZyBhbmQgbm9uLWFjdGl2ZSByb2xsaW5nIGZyaWN0aW9uIChudGhyb3R0bGUvYnJlYWspCgoKICAgICAgICB3aGVlbC5mb3J3YXJkSW1wdWxzZSA9IDA7CiAgICAgICAgd2hlZWwuc2tpZEluZm8gPSAxOwoKICAgICAgICBpZiAoZ3JvdW5kT2JqZWN0KSB7CiAgICAgICAgICB3aGVlbC5za2lkSW5mbyA9IDE7CiAgICAgICAgICBjb25zdCBtYXhpbXAgPSB3aGVlbC5zdXNwZW5zaW9uRm9yY2UgKiB0aW1lU3RlcCAqIHdoZWVsLmZyaWN0aW9uU2xpcDsKICAgICAgICAgIGNvbnN0IG1heGltcFNpZGUgPSBtYXhpbXA7CiAgICAgICAgICBjb25zdCBtYXhpbXBTcXVhcmVkID0gbWF4aW1wICogbWF4aW1wU2lkZTsKICAgICAgICAgIHdoZWVsLmZvcndhcmRJbXB1bHNlID0gcm9sbGluZ0ZyaWN0aW9uOyAvL3doZWVsSW5mby5lbmdpbmVGb3JjZSogdGltZVN0ZXA7CgogICAgICAgICAgY29uc3QgeCA9IHdoZWVsLmZvcndhcmRJbXB1bHNlICogZndkRmFjdG9yIC8gd2hlZWwuZm9yd2FyZEFjY2VsZXJhdGlvbjsKICAgICAgICAgIGNvbnN0IHkgPSB3aGVlbC5zaWRlSW1wdWxzZSAqIHNpZGVGYWN0b3IgLyB3aGVlbC5zaWRlQWNjZWxlcmF0aW9uOwogICAgICAgICAgY29uc3QgaW1wdWxzZVNxdWFyZWQgPSB4ICogeCArIHkgKiB5OwogICAgICAgICAgd2hlZWwuc2xpZGluZyA9IGZhbHNlOwoKICAgICAgICAgIGlmIChpbXB1bHNlU3F1YXJlZCA+IG1heGltcFNxdWFyZWQpIHsKICAgICAgICAgICAgdGhpcy5zbGlkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgd2hlZWwuc2xpZGluZyA9IHRydWU7CiAgICAgICAgICAgIGNvbnN0IGZhY3RvciA9IG1heGltcCAvIE1hdGguc3FydChpbXB1bHNlU3F1YXJlZCk7CiAgICAgICAgICAgIHdoZWVsLnNraWRJbmZvICo9IGZhY3RvcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnNsaWRpbmcpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdoZWVsczsgaSsrKSB7CiAgICAgICAgICBjb25zdCB3aGVlbCA9IHdoZWVsSW5mb3NbaV07CgogICAgICAgICAgaWYgKHdoZWVsLnNpZGVJbXB1bHNlICE9PSAwKSB7CiAgICAgICAgICAgIGlmICh3aGVlbC5za2lkSW5mbyA8IDEpIHsKICAgICAgICAgICAgICB3aGVlbC5mb3J3YXJkSW1wdWxzZSAqPSB3aGVlbC5za2lkSW5mbzsKICAgICAgICAgICAgICB3aGVlbC5zaWRlSW1wdWxzZSAqPSB3aGVlbC5za2lkSW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSAvLyBhcHBseSB0aGUgaW1wdWxzZXMKCgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bVdoZWVsczsgaSsrKSB7CiAgICAgICAgY29uc3Qgd2hlZWwgPSB3aGVlbEluZm9zW2ldOwogICAgICAgIGNvbnN0IHJlbF9wb3MgPSBuZXcgVmVjMygpOwogICAgICAgIHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZC52c3ViKGNoYXNzaXNCb2R5LnBvc2l0aW9uLCByZWxfcG9zKTsgLy8gY2Fubm9ucyBhcHBseWltcHVsc2UgaXMgdXNpbmcgd29ybGQgY29vcmQgZm9yIHRoZSBwb3NpdGlvbgogICAgICAgIC8vcmVsX3Bvcy5jb3B5KHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZCk7CgogICAgICAgIGlmICh3aGVlbC5mb3J3YXJkSW1wdWxzZSAhPT0gMCkgewogICAgICAgICAgY29uc3QgaW1wdWxzZSA9IG5ldyBWZWMzKCk7CiAgICAgICAgICBmb3J3YXJkV1NbaV0uc2NhbGUod2hlZWwuZm9yd2FyZEltcHVsc2UsIGltcHVsc2UpOwogICAgICAgICAgY2hhc3Npc0JvZHkuYXBwbHlJbXB1bHNlKGltcHVsc2UsIHJlbF9wb3MpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdoZWVsLnNpZGVJbXB1bHNlICE9PSAwKSB7CiAgICAgICAgICBjb25zdCBncm91bmRPYmplY3QgPSB3aGVlbC5yYXljYXN0UmVzdWx0LmJvZHk7CiAgICAgICAgICBjb25zdCByZWxfcG9zMiA9IG5ldyBWZWMzKCk7CiAgICAgICAgICB3aGVlbC5yYXljYXN0UmVzdWx0LmhpdFBvaW50V29ybGQudnN1Yihncm91bmRPYmplY3QucG9zaXRpb24sIHJlbF9wb3MyKTsgLy9yZWxfcG9zMi5jb3B5KHdoZWVsLnJheWNhc3RSZXN1bHQuaGl0UG9pbnRXb3JsZCk7CgogICAgICAgICAgY29uc3Qgc2lkZUltcCA9IG5ldyBWZWMzKCk7CiAgICAgICAgICBheGxlW2ldLnNjYWxlKHdoZWVsLnNpZGVJbXB1bHNlLCBzaWRlSW1wKTsgLy8gU2NhbGUgdGhlIHJlbGF0aXZlIHBvc2l0aW9uIGluIHRoZSB1cCBkaXJlY3Rpb24gd2l0aCByb2xsSW5mbHVlbmNlLgogICAgICAgICAgLy8gSWYgcm9sbEluZmx1ZW5jZSBpcyAxLCB0aGUgaW1wdWxzZSB3aWxsIGJlIGFwcGxpZWQgb24gdGhlIGhpdFBvaW50IChlYXN5IHRvIHJvbGwgb3ZlciksIGlmIGl0IGlzIHplcm8gaXQgd2lsbCBiZSBhcHBsaWVkIGluIHRoZSBzYW1lIHBsYW5lIGFzIHRoZSBjZW50ZXIgb2YgbWFzcyAobm90IGVhc3kgdG8gcm9sbCBvdmVyKS4KCiAgICAgICAgICBjaGFzc2lzQm9keS52ZWN0b3JUb0xvY2FsRnJhbWUocmVsX3BvcywgcmVsX3Bvcyk7CiAgICAgICAgICByZWxfcG9zWyd4eXonW3RoaXMuaW5kZXhVcEF4aXNdXSAqPSB3aGVlbC5yb2xsSW5mbHVlbmNlOwogICAgICAgICAgY2hhc3Npc0JvZHkudmVjdG9yVG9Xb3JsZEZyYW1lKHJlbF9wb3MsIHJlbF9wb3MpOwogICAgICAgICAgY2hhc3Npc0JvZHkuYXBwbHlJbXB1bHNlKHNpZGVJbXAsIHJlbF9wb3MpOyAvL2FwcGx5IGZyaWN0aW9uIGltcHVsc2Ugb24gdGhlIGdyb3VuZAoKICAgICAgICAgIHNpZGVJbXAuc2NhbGUoLTEsIHNpZGVJbXApOwogICAgICAgICAgZ3JvdW5kT2JqZWN0LmFwcGx5SW1wdWxzZShzaWRlSW1wLCByZWxfcG9zMik7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogIH0KCiAgY29uc3QgdG1wVmVjNCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjNSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wVmVjNiA9IG5ldyBWZWMzKCk7CiAgbmV3IFJheSgpOwogIGNvbnN0IGNhc3RSYXlfcmF5dmVjdG9yID0gbmV3IFZlYzMoKTsKICBjb25zdCBjYXN0UmF5X3RhcmdldCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZGlyZWN0aW9ucyA9IFtuZXcgVmVjMygxLCAwLCAwKSwgbmV3IFZlYzMoMCwgMSwgMCksIG5ldyBWZWMzKDAsIDAsIDEpXTsKICBjb25zdCB1cGRhdGVGcmljdGlvbl9zdXJmTm9ybWFsV1Nfc2NhbGVkX3Byb2ogPSBuZXcgVmVjMygpOwogIGNvbnN0IHVwZGF0ZUZyaWN0aW9uX2F4bGUgPSBbXTsKICBjb25zdCB1cGRhdGVGcmljdGlvbl9mb3J3YXJkV1MgPSBbXTsKICBjb25zdCBzaWRlRnJpY3Rpb25TdGlmZm5lc3MyID0gMTsKICBjb25zdCBjYWxjUm9sbGluZ0ZyaWN0aW9uX3ZlbDEgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsMiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY2FsY1JvbGxpbmdGcmljdGlvbl92ZWwgPSBuZXcgVmVjMygpOwoKICBmdW5jdGlvbiBjYWxjUm9sbGluZ0ZyaWN0aW9uKGJvZHkwLCBib2R5MSwgZnJpY3Rpb25Qb3NXb3JsZCwgZnJpY3Rpb25EaXJlY3Rpb25Xb3JsZCwgbWF4SW1wdWxzZSkgewogICAgbGV0IGoxID0gMDsKICAgIGNvbnN0IGNvbnRhY3RQb3NXb3JsZCA9IGZyaWN0aW9uUG9zV29ybGQ7IC8vIGNvbnN0IHJlbF9wb3MxID0gbmV3IFZlYzMoKTsKICAgIC8vIGNvbnN0IHJlbF9wb3MyID0gbmV3IFZlYzMoKTsKCiAgICBjb25zdCB2ZWwxID0gY2FsY1JvbGxpbmdGcmljdGlvbl92ZWwxOwogICAgY29uc3QgdmVsMiA9IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsMjsKICAgIGNvbnN0IHZlbCA9IGNhbGNSb2xsaW5nRnJpY3Rpb25fdmVsOyAvLyBjb250YWN0UG9zV29ybGQudnN1Yihib2R5MC5wb3NpdGlvbiwgcmVsX3BvczEpOwogICAgLy8gY29udGFjdFBvc1dvcmxkLnZzdWIoYm9keTEucG9zaXRpb24sIHJlbF9wb3MyKTsKCiAgICBib2R5MC5nZXRWZWxvY2l0eUF0V29ybGRQb2ludChjb250YWN0UG9zV29ybGQsIHZlbDEpOwogICAgYm9keTEuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQoY29udGFjdFBvc1dvcmxkLCB2ZWwyKTsKICAgIHZlbDEudnN1Yih2ZWwyLCB2ZWwpOwogICAgY29uc3QgdnJlbCA9IGZyaWN0aW9uRGlyZWN0aW9uV29ybGQuZG90KHZlbCk7CiAgICBjb25zdCBkZW5vbTAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yKGJvZHkwLCBmcmljdGlvblBvc1dvcmxkLCBmcmljdGlvbkRpcmVjdGlvbldvcmxkKTsKICAgIGNvbnN0IGRlbm9tMSA9IGNvbXB1dGVJbXB1bHNlRGVub21pbmF0b3IoYm9keTEsIGZyaWN0aW9uUG9zV29ybGQsIGZyaWN0aW9uRGlyZWN0aW9uV29ybGQpOwogICAgY29uc3QgcmVsYXhhdGlvbiA9IDE7CiAgICBjb25zdCBqYWNEaWFnQUJJbnYgPSByZWxheGF0aW9uIC8gKGRlbm9tMCArIGRlbm9tMSk7IC8vIGNhbGN1bGF0ZSBqIHRoYXQgbW92ZXMgdXMgdG8gemVybyByZWxhdGl2ZSB2ZWxvY2l0eQoKICAgIGoxID0gLXZyZWwgKiBqYWNEaWFnQUJJbnY7CgogICAgaWYgKG1heEltcHVsc2UgPCBqMSkgewogICAgICBqMSA9IG1heEltcHVsc2U7CiAgICB9CgogICAgaWYgKGoxIDwgLW1heEltcHVsc2UpIHsKICAgICAgajEgPSAtbWF4SW1wdWxzZTsKICAgIH0KCiAgICByZXR1cm4gajE7CiAgfQoKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3IwID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX2MwID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3ZlYyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl9tID0gbmV3IFZlYzMoKTsKCiAgZnVuY3Rpb24gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcihib2R5LCBwb3MsIG5vcm1hbCkgewogICAgY29uc3QgcjAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX3IwOwogICAgY29uc3QgYzAgPSBjb21wdXRlSW1wdWxzZURlbm9taW5hdG9yX2MwOwogICAgY29uc3QgdmVjID0gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl92ZWM7CiAgICBjb25zdCBtID0gY29tcHV0ZUltcHVsc2VEZW5vbWluYXRvcl9tOwogICAgcG9zLnZzdWIoYm9keS5wb3NpdGlvbiwgcjApOwogICAgcjAuY3Jvc3Mobm9ybWFsLCBjMCk7CiAgICBib2R5LmludkluZXJ0aWFXb3JsZC52bXVsdChjMCwgbSk7CiAgICBtLmNyb3NzKHIwLCB2ZWMpOwogICAgcmV0dXJuIGJvZHkuaW52TWFzcyArIG5vcm1hbC5kb3QodmVjKTsKICB9CgogIGNvbnN0IHJlc29sdmVTaW5nbGVCaWxhdGVyYWxfdmVsMSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcmVzb2x2ZVNpbmdsZUJpbGF0ZXJhbF92ZWwyID0gbmV3IFZlYzMoKTsKICBjb25zdCByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbCA9IG5ldyBWZWMzKCk7IC8vIGJpbGF0ZXJhbCBjb25zdHJhaW50IGJldHdlZW4gdHdvIGR5bmFtaWMgb2JqZWN0cwoKICBmdW5jdGlvbiByZXNvbHZlU2luZ2xlQmlsYXRlcmFsKGJvZHkxLCBwb3MxLCBib2R5MiwgcG9zMiwgbm9ybWFsKSB7CiAgICBjb25zdCBub3JtYWxMZW5TcXIgPSBub3JtYWwubGVuZ3RoU3F1YXJlZCgpOwoKICAgIGlmIChub3JtYWxMZW5TcXIgPiAxLjEpIHsKICAgICAgcmV0dXJuIDA7IC8vIG5vIGltcHVsc2UKICAgIH0gLy8gY29uc3QgcmVsX3BvczEgPSBuZXcgVmVjMygpOwogICAgLy8gY29uc3QgcmVsX3BvczIgPSBuZXcgVmVjMygpOwogICAgLy8gcG9zMS52c3ViKGJvZHkxLnBvc2l0aW9uLCByZWxfcG9zMSk7CiAgICAvLyBwb3MyLnZzdWIoYm9keTIucG9zaXRpb24sIHJlbF9wb3MyKTsKCgogICAgY29uc3QgdmVsMSA9IHJlc29sdmVTaW5nbGVCaWxhdGVyYWxfdmVsMTsKICAgIGNvbnN0IHZlbDIgPSByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbDI7CiAgICBjb25zdCB2ZWwgPSByZXNvbHZlU2luZ2xlQmlsYXRlcmFsX3ZlbDsKICAgIGJvZHkxLmdldFZlbG9jaXR5QXRXb3JsZFBvaW50KHBvczEsIHZlbDEpOwogICAgYm9keTIuZ2V0VmVsb2NpdHlBdFdvcmxkUG9pbnQocG9zMiwgdmVsMik7CiAgICB2ZWwxLnZzdWIodmVsMiwgdmVsKTsKICAgIGNvbnN0IHJlbF92ZWwgPSBub3JtYWwuZG90KHZlbCk7CiAgICBjb25zdCBjb250YWN0RGFtcGluZyA9IDAuMjsKICAgIGNvbnN0IG1hc3NUZXJtID0gMSAvIChib2R5MS5pbnZNYXNzICsgYm9keTIuaW52TWFzcyk7CiAgICBjb25zdCBpbXB1bHNlID0gLWNvbnRhY3REYW1waW5nICogcmVsX3ZlbCAqIG1hc3NUZXJtOwogICAgcmV0dXJuIGltcHVsc2U7CiAgfQogIC8qKgogICAqIFNwaGVyaWNhbCBzaGFwZQogICAqIEBleGFtcGxlCiAgICogICAgIGNvbnN0IHJhZGl1cyA9IDEKICAgKiAgICAgY29uc3Qgc3BoZXJlU2hhcGUgPSBuZXcgQ0FOTk9OLlNwaGVyZShyYWRpdXMpCiAgICogICAgIGNvbnN0IHNwaGVyZUJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoeyBtYXNzOiAxLCBzaGFwZTogc3BoZXJlU2hhcGUgfSkKICAgKiAgICAgd29ybGQuYWRkQm9keShzcGhlcmVCb2R5KQogICAqLwoKCiAgY2xhc3MgU3BoZXJlIGV4dGVuZHMgU2hhcGUgewogICAgLyoqCiAgICAgKiBUaGUgcmFkaXVzIG9mIHRoZSBzcGhlcmUuCiAgICAgKi8KCiAgICAvKioKICAgICAqCiAgICAgKiBAcGFyYW0gcmFkaXVzIFRoZSByYWRpdXMgb2YgdGhlIHNwaGVyZSwgYSBub24tbmVnYXRpdmUgbnVtYmVyLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihyYWRpdXMpIHsKICAgICAgc3VwZXIoewogICAgICAgIHR5cGU6IFNoYXBlLnR5cGVzLlNQSEVSRQogICAgICB9KTsKICAgICAgdGhpcy5yYWRpdXMgPSB2b2lkIDA7CiAgICAgIHRoaXMucmFkaXVzID0gcmFkaXVzICE9PSB1bmRlZmluZWQgPyByYWRpdXMgOiAxLjA7CgogICAgICBpZiAodGhpcy5yYWRpdXMgPCAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgc3BoZXJlIHJhZGl1cyBjYW5ub3QgYmUgbmVnYXRpdmUuJyk7CiAgICAgIH0KCiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsKICAgIH0KICAgIC8qKiBjYWxjdWxhdGVMb2NhbEluZXJ0aWEgKi8KCgogICAgY2FsY3VsYXRlTG9jYWxJbmVydGlhKG1hc3MsIHRhcmdldCkgewogICAgICBpZiAodGFyZ2V0ID09PSB2b2lkIDApIHsKICAgICAgICB0YXJnZXQgPSBuZXcgVmVjMygpOwogICAgICB9CgogICAgICBjb25zdCBJID0gMi4wICogbWFzcyAqIHRoaXMucmFkaXVzICogdGhpcy5yYWRpdXMgLyA1LjA7CiAgICAgIHRhcmdldC54ID0gSTsKICAgICAgdGFyZ2V0LnkgPSBJOwogICAgICB0YXJnZXQueiA9IEk7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CiAgICAvKiogdm9sdW1lICovCgoKICAgIHZvbHVtZSgpIHsKICAgICAgcmV0dXJuIDQuMCAqIE1hdGguUEkgKiBNYXRoLnBvdyh0aGlzLnJhZGl1cywgMykgLyAzLjA7CiAgICB9CgogICAgdXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKSB7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSB0aGlzLnJhZGl1czsKICAgIH0KCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICBjb25zdCByID0gdGhpcy5yYWRpdXM7CiAgICAgIGNvbnN0IGF4ZXMgPSBbJ3gnLCAneScsICd6J107CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGF4ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBheCA9IGF4ZXNbaV07CiAgICAgICAgbWluW2F4XSA9IHBvc1theF0gLSByOwogICAgICAgIG1heFtheF0gPSBwb3NbYXhdICsgcjsKICAgICAgfQogICAgfQoKICB9CgogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKCiAgbmV3IFZlYzMoKTsgLy8gVGVtcCB2ZWN0b3JzIGZvciBjYWxjdWxhdGlvbgoKICBuZXcgVmVjMygpOyAvLyBSZWxhdGl2ZSB2ZWxvY2l0eQoKICBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgbmV3IFZlYzMoKTsKICBuZXcgVmVjMygpOwogIG5ldyBWZWMzKCk7CiAgLyoqCiAgICogQ3lsaW5kZXIgY2xhc3MuCiAgICogQGV4YW1wbGUKICAgKiAgICAgY29uc3QgcmFkaXVzVG9wID0gMC41CiAgICogICAgIGNvbnN0IHJhZGl1c0JvdHRvbSA9IDAuNQogICAqICAgICBjb25zdCBoZWlnaHQgPSAyCiAgICogICAgIGNvbnN0IG51bVNlZ21lbnRzID0gMTIKICAgKiAgICAgY29uc3QgY3lsaW5kZXJTaGFwZSA9IG5ldyBDQU5OT04uQ3lsaW5kZXIocmFkaXVzVG9wLCByYWRpdXNCb3R0b20sIGhlaWdodCwgbnVtU2VnbWVudHMpCiAgICogICAgIGNvbnN0IGN5bGluZGVyQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDEsIHNoYXBlOiBjeWxpbmRlclNoYXBlIH0pCiAgICogICAgIHdvcmxkLmFkZEJvZHkoY3lsaW5kZXJCb2R5KQogICAqLwoKICBjbGFzcyBDeWxpbmRlciBleHRlbmRzIENvbnZleFBvbHloZWRyb24gewogICAgLyoqIFRoZSByYWRpdXMgb2YgdGhlIHRvcCBvZiB0aGUgQ3lsaW5kZXIuICovCgogICAgLyoqIFRoZSByYWRpdXMgb2YgdGhlIGJvdHRvbSBvZiB0aGUgQ3lsaW5kZXIuICovCgogICAgLyoqIFRoZSBoZWlnaHQgb2YgdGhlIEN5bGluZGVyLiAqLwoKICAgIC8qKiBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzIHRvIGJ1aWxkIHRoZSBjeWxpbmRlciBvdXQgb2YuICovCgogICAgLyoqCiAgICAgKiBAcGFyYW0gcmFkaXVzVG9wIFRoZSByYWRpdXMgb2YgdGhlIHRvcCBvZiB0aGUgQ3lsaW5kZXIuCiAgICAgKiBAcGFyYW0gcmFkaXVzQm90dG9tIFRoZSByYWRpdXMgb2YgdGhlIGJvdHRvbSBvZiB0aGUgQ3lsaW5kZXIuCiAgICAgKiBAcGFyYW0gaGVpZ2h0IFRoZSBoZWlnaHQgb2YgdGhlIEN5bGluZGVyLgogICAgICogQHBhcmFtIG51bVNlZ21lbnRzIFRoZSBudW1iZXIgb2Ygc2VnbWVudHMgdG8gYnVpbGQgdGhlIGN5bGluZGVyIG91dCBvZi4KICAgICAqLwogICAgY29uc3RydWN0b3IocmFkaXVzVG9wLCByYWRpdXNCb3R0b20sIGhlaWdodCwgbnVtU2VnbWVudHMpIHsKICAgICAgaWYgKHJhZGl1c1RvcCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmFkaXVzVG9wID0gMTsKICAgICAgfQoKICAgICAgaWYgKHJhZGl1c0JvdHRvbSA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmFkaXVzQm90dG9tID0gMTsKICAgICAgfQoKICAgICAgaWYgKGhlaWdodCA9PT0gdm9pZCAwKSB7CiAgICAgICAgaGVpZ2h0ID0gMTsKICAgICAgfQoKICAgICAgaWYgKG51bVNlZ21lbnRzID09PSB2b2lkIDApIHsKICAgICAgICBudW1TZWdtZW50cyA9IDg7CiAgICAgIH0KCiAgICAgIGlmIChyYWRpdXNUb3AgPCAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgY3lsaW5kZXIgcmFkaXVzVG9wIGNhbm5vdCBiZSBuZWdhdGl2ZS4nKTsKICAgICAgfQoKICAgICAgaWYgKHJhZGl1c0JvdHRvbSA8IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBjeWxpbmRlciByYWRpdXNCb3R0b20gY2Fubm90IGJlIG5lZ2F0aXZlLicpOwogICAgICB9CgogICAgICBjb25zdCBOID0gbnVtU2VnbWVudHM7CiAgICAgIGNvbnN0IHZlcnRpY2VzID0gW107CiAgICAgIGNvbnN0IGF4ZXMgPSBbXTsKICAgICAgY29uc3QgZmFjZXMgPSBbXTsKICAgICAgY29uc3QgYm90dG9tZmFjZSA9IFtdOwogICAgICBjb25zdCB0b3BmYWNlID0gW107CiAgICAgIGNvbnN0IGNvcyA9IE1hdGguY29zOwogICAgICBjb25zdCBzaW4gPSBNYXRoLnNpbjsgLy8gRmlyc3QgYm90dG9tIHBvaW50CgogICAgICB2ZXJ0aWNlcy5wdXNoKG5ldyBWZWMzKC1yYWRpdXNCb3R0b20gKiBzaW4oMCksIC1oZWlnaHQgKiAwLjUsIHJhZGl1c0JvdHRvbSAqIGNvcygwKSkpOwogICAgICBib3R0b21mYWNlLnB1c2goMCk7IC8vIEZpcnN0IHRvcCBwb2ludAoKICAgICAgdmVydGljZXMucHVzaChuZXcgVmVjMygtcmFkaXVzVG9wICogc2luKDApLCBoZWlnaHQgKiAwLjUsIHJhZGl1c1RvcCAqIGNvcygwKSkpOwogICAgICB0b3BmYWNlLnB1c2goMSk7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE47IGkrKykgewogICAgICAgIGNvbnN0IHRoZXRhID0gMiAqIE1hdGguUEkgLyBOICogKGkgKyAxKTsKICAgICAgICBjb25zdCB0aGV0YU4gPSAyICogTWF0aC5QSSAvIE4gKiAoaSArIDAuNSk7CgogICAgICAgIGlmIChpIDwgTiAtIDEpIHsKICAgICAgICAgIC8vIEJvdHRvbQogICAgICAgICAgdmVydGljZXMucHVzaChuZXcgVmVjMygtcmFkaXVzQm90dG9tICogc2luKHRoZXRhKSwgLWhlaWdodCAqIDAuNSwgcmFkaXVzQm90dG9tICogY29zKHRoZXRhKSkpOwogICAgICAgICAgYm90dG9tZmFjZS5wdXNoKDIgKiBpICsgMik7IC8vIFRvcAoKICAgICAgICAgIHZlcnRpY2VzLnB1c2gobmV3IFZlYzMoLXJhZGl1c1RvcCAqIHNpbih0aGV0YSksIGhlaWdodCAqIDAuNSwgcmFkaXVzVG9wICogY29zKHRoZXRhKSkpOwogICAgICAgICAgdG9wZmFjZS5wdXNoKDIgKiBpICsgMyk7IC8vIEZhY2UKCiAgICAgICAgICBmYWNlcy5wdXNoKFsyICogaSwgMiAqIGkgKyAxLCAyICogaSArIDMsIDIgKiBpICsgMl0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmYWNlcy5wdXNoKFsyICogaSwgMiAqIGkgKyAxLCAxLCAwXSk7IC8vIENvbm5lY3QKICAgICAgICB9IC8vIEF4aXM6IHdlIGNhbiBjdXQgb2ZmIGhhbGYgb2YgdGhlbSBpZiB3ZSBoYXZlIGV2ZW4gbnVtYmVyIG9mIHNlZ21lbnRzCgoKICAgICAgICBpZiAoTiAlIDIgPT09IDEgfHwgaSA8IE4gLyAyKSB7CiAgICAgICAgICBheGVzLnB1c2gobmV3IFZlYzMoLXNpbih0aGV0YU4pLCAwLCBjb3ModGhldGFOKSkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZmFjZXMucHVzaChib3R0b21mYWNlKTsKICAgICAgYXhlcy5wdXNoKG5ldyBWZWMzKDAsIDEsIDApKTsgLy8gUmVvcmRlciB0b3AgZmFjZQoKICAgICAgY29uc3QgdGVtcCA9IFtdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3BmYWNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGVtcC5wdXNoKHRvcGZhY2VbdG9wZmFjZS5sZW5ndGggLSBpIC0gMV0pOwogICAgICB9CgogICAgICBmYWNlcy5wdXNoKHRlbXApOwogICAgICBzdXBlcih7CiAgICAgICAgdmVydGljZXMsCiAgICAgICAgZmFjZXMsCiAgICAgICAgYXhlcwogICAgICB9KTsKICAgICAgdGhpcy5yYWRpdXNUb3AgPSB2b2lkIDA7CiAgICAgIHRoaXMucmFkaXVzQm90dG9tID0gdm9pZCAwOwogICAgICB0aGlzLmhlaWdodCA9IHZvaWQgMDsKICAgICAgdGhpcy5udW1TZWdtZW50cyA9IHZvaWQgMDsKICAgICAgdGhpcy50eXBlID0gU2hhcGUudHlwZXMuQ1lMSU5ERVI7CiAgICAgIHRoaXMucmFkaXVzVG9wID0gcmFkaXVzVG9wOwogICAgICB0aGlzLnJhZGl1c0JvdHRvbSA9IHJhZGl1c0JvdHRvbTsKICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgIHRoaXMubnVtU2VnbWVudHMgPSBudW1TZWdtZW50czsKICAgIH0KCiAgfQogIC8qKgogICAqIFBhcnRpY2xlIHNoYXBlLgogICAqIEBleGFtcGxlCiAgICogICAgIGNvbnN0IHBhcnRpY2xlU2hhcGUgPSBuZXcgQ0FOTk9OLlBhcnRpY2xlKCkKICAgKiAgICAgY29uc3QgcGFydGljbGVCb2R5ID0gbmV3IENBTk5PTi5Cb2R5KHsgbWFzczogMSwgc2hhcGU6IHBhcnRpY2xlU2hhcGUgfSkKICAgKiAgICAgd29ybGQuYWRkQm9keShwYXJ0aWNsZUJvZHkpCiAgICovCgoKICBjbGFzcyBQYXJ0aWNsZSBleHRlbmRzIFNoYXBlIHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICBzdXBlcih7CiAgICAgICAgdHlwZTogU2hhcGUudHlwZXMuUEFSVElDTEUKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYQogICAgICovCgoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgdGFyZ2V0LnNldCgwLCAwLCAwKTsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiAwOwogICAgfQoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICB0aGlzLmJvdW5kaW5nU3BoZXJlUmFkaXVzID0gMDsKICAgIH0KCiAgICBjYWxjdWxhdGVXb3JsZEFBQkIocG9zLCBxdWF0LCBtaW4sIG1heCkgewogICAgICAvLyBHZXQgZWFjaCBheGlzIG1heAogICAgICBtaW4uY29weShwb3MpOwogICAgICBtYXguY29weShwb3MpOwogICAgfQoKICB9CiAgLyoqCiAgICogQSBwbGFuZSwgZmFjaW5nIGluIHRoZSBaIGRpcmVjdGlvbi4gVGhlIHBsYW5lIGhhcyBpdHMgc3VyZmFjZSBhdCB6PTAgYW5kIGV2ZXJ5dGhpbmcgYmVsb3cgej0wIGlzIGFzc3VtZWQgdG8gYmUgc29saWQgcGxhbmUuIFRvIG1ha2UgdGhlIHBsYW5lIGZhY2UgaW4gc29tZSBvdGhlciBkaXJlY3Rpb24gdGhhbiB6LCB5b3UgbXVzdCBwdXQgaXQgaW5zaWRlIGEgQm9keSBhbmQgcm90YXRlIHRoYXQgYm9keS4gU2VlIHRoZSBkZW1vcy4KICAgKiBAZXhhbXBsZQogICAqICAgICBjb25zdCBwbGFuZVNoYXBlID0gbmV3IENBTk5PTi5QbGFuZSgpCiAgICogICAgIGNvbnN0IHBsYW5lQm9keSA9IG5ldyBDQU5OT04uQm9keSh7IG1hc3M6IDAsIHNoYXBlOiAgcGxhbmVTaGFwZSB9KQogICAqICAgICBwbGFuZUJvZHkucXVhdGVybmlvbi5zZXRGcm9tRXVsZXIoLU1hdGguUEkgLyAyLCAwLCAwKSAvLyBtYWtlIGl0IGZhY2UgdXAKICAgKiAgICAgd29ybGQuYWRkQm9keShwbGFuZUJvZHkpCiAgICovCgoKICBjbGFzcyBQbGFuZSBleHRlbmRzIFNoYXBlIHsKICAgIC8qKiB3b3JsZE5vcm1hbCAqLwoKICAgIC8qKiB3b3JsZE5vcm1hbE5lZWRzVXBkYXRlICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoewogICAgICAgIHR5cGU6IFNoYXBlLnR5cGVzLlBMQU5FCiAgICAgIH0pOyAvLyBXb3JsZCBvcmllbnRlZCBub3JtYWwKCiAgICAgIHRoaXMud29ybGROb3JtYWwgPSB2b2lkIDA7CiAgICAgIHRoaXMud29ybGROb3JtYWxOZWVkc1VwZGF0ZSA9IHZvaWQgMDsKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IHZvaWQgMDsKICAgICAgdGhpcy53b3JsZE5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMud29ybGROb3JtYWxOZWVkc1VwZGF0ZSA9IHRydWU7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgfQogICAgLyoqIGNvbXB1dGVXb3JsZE5vcm1hbCAqLwoKCiAgICBjb21wdXRlV29ybGROb3JtYWwocXVhdCkgewogICAgICBjb25zdCBuID0gdGhpcy53b3JsZE5vcm1hbDsKICAgICAgbi5zZXQoMCwgMCwgMSk7CiAgICAgIHF1YXQudm11bHQobiwgbik7CiAgICAgIHRoaXMud29ybGROb3JtYWxOZWVkc1VwZGF0ZSA9IGZhbHNlOwogICAgfQoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgaWYgKHRhcmdldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGFyZ2V0ID0gbmV3IFZlYzMoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgICB2b2x1bWUoKSB7CiAgICAgIHJldHVybiAoLy8gVGhlIHBsYW5lIGlzIGluZmluaXRlLi4uCiAgICAgICAgTnVtYmVyLk1BWF9WQUxVRQogICAgICApOwogICAgfQoKICAgIGNhbGN1bGF0ZVdvcmxkQUFCQihwb3MsIHF1YXQsIG1pbiwgbWF4KSB7CiAgICAgIC8vIFRoZSBwbGFuZSBBQUJCIGlzIGluZmluaXRlLCBleGNlcHQgaWYgdGhlIG5vcm1hbCBpcyBwb2ludGluZyBhbG9uZyBhbnkgYXhpcwogICAgICB0ZW1wTm9ybWFsLnNldCgwLCAwLCAxKTsgLy8gRGVmYXVsdCBwbGFuZSBub3JtYWwgaXMgegoKICAgICAgcXVhdC52bXVsdCh0ZW1wTm9ybWFsLCB0ZW1wTm9ybWFsKTsKICAgICAgY29uc3QgbWF4VmFsID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgbWluLnNldCgtbWF4VmFsLCAtbWF4VmFsLCAtbWF4VmFsKTsKICAgICAgbWF4LnNldChtYXhWYWwsIG1heFZhbCwgbWF4VmFsKTsKCiAgICAgIGlmICh0ZW1wTm9ybWFsLnggPT09IDEpIHsKICAgICAgICBtYXgueCA9IHBvcy54OwogICAgICB9IGVsc2UgaWYgKHRlbXBOb3JtYWwueCA9PT0gLTEpIHsKICAgICAgICBtaW4ueCA9IHBvcy54OwogICAgICB9CgogICAgICBpZiAodGVtcE5vcm1hbC55ID09PSAxKSB7CiAgICAgICAgbWF4LnkgPSBwb3MueTsKICAgICAgfSBlbHNlIGlmICh0ZW1wTm9ybWFsLnkgPT09IC0xKSB7CiAgICAgICAgbWluLnkgPSBwb3MueTsKICAgICAgfQoKICAgICAgaWYgKHRlbXBOb3JtYWwueiA9PT0gMSkgewogICAgICAgIG1heC56ID0gcG9zLno7CiAgICAgIH0gZWxzZSBpZiAodGVtcE5vcm1hbC56ID09PSAtMSkgewogICAgICAgIG1pbi56ID0gcG9zLno7CiAgICAgIH0KICAgIH0KCiAgICB1cGRhdGVCb3VuZGluZ1NwaGVyZVJhZGl1cygpIHsKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IE51bWJlci5NQVhfVkFMVUU7CiAgICB9CgogIH0KCiAgY29uc3QgdGVtcE5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgLyoqCiAgICogSGVpZ2h0ZmllbGQgc2hhcGUgY2xhc3MuIEhlaWdodCBkYXRhIGlzIGdpdmVuIGFzIGFuIGFycmF5LiBUaGVzZSBkYXRhIHBvaW50cyBhcmUgc3ByZWFkIG91dCBldmVubHkgd2l0aCBhIGdpdmVuIGRpc3RhbmNlLgogICAqIEB0b2RvIFNob3VsZCBiZSBwb3NzaWJsZSB0byB1c2UgYWxvbmcgYWxsIGF4ZXMsIG5vdCBqdXN0IHkKICAgKiBAdG9kbyBzaG91bGQgYmUgcG9zc2libGUgdG8gc2NhbGUgYWxvbmcgYWxsIGF4ZXMKICAgKiBAdG9kbyBSZWZhY3RvciBlbGVtZW50U2l6ZSB0byBlbGVtZW50U2l6ZVggYW5kIGVsZW1lbnRTaXplWQogICAqCiAgICogQGV4YW1wbGUKICAgKiAgICAgLy8gR2VuZXJhdGUgc29tZSBoZWlnaHQgZGF0YSAoeS12YWx1ZXMpLgogICAqICAgICBjb25zdCBkYXRhID0gW10KICAgKiAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDAwOyBpKyspIHsKICAgKiAgICAgICAgIGNvbnN0IHkgPSAwLjUgKiBNYXRoLmNvcygwLjIgKiBpKQogICAqICAgICAgICAgZGF0YS5wdXNoKHkpCiAgICogICAgIH0KICAgKgogICAqICAgICAvLyBDcmVhdGUgdGhlIGhlaWdodGZpZWxkIHNoYXBlCiAgICogICAgIGNvbnN0IGhlaWdodGZpZWxkU2hhcGUgPSBuZXcgQ0FOTk9OLkhlaWdodGZpZWxkKGRhdGEsIHsKICAgKiAgICAgICAgIGVsZW1lbnRTaXplOiAxIC8vIERpc3RhbmNlIGJldHdlZW4gdGhlIGRhdGEgcG9pbnRzIGluIFggYW5kIFkgZGlyZWN0aW9ucwogICAqICAgICB9KQogICAqICAgICBjb25zdCBoZWlnaHRmaWVsZEJvZHkgPSBuZXcgQ0FOTk9OLkJvZHkoeyBzaGFwZTogaGVpZ2h0ZmllbGRTaGFwZSB9KQogICAqICAgICB3b3JsZC5hZGRCb2R5KGhlaWdodGZpZWxkQm9keSkKICAgKi8KCiAgY2xhc3MgSGVpZ2h0ZmllbGQgZXh0ZW5kcyBTaGFwZSB7CiAgICAvKioKICAgICAqIEFuIGFycmF5IG9mIG51bWJlcnMsIG9yIGhlaWdodCB2YWx1ZXMsIHRoYXQgYXJlIHNwcmVhZCBvdXQgYWxvbmcgdGhlIHggYXhpcy4KICAgICAqLwoKICAgIC8qKgogICAgICogTWF4IHZhbHVlIG9mIHRoZSBkYXRhIHBvaW50cyBpbiB0aGUgZGF0YSBhcnJheS4KICAgICAqLwoKICAgIC8qKgogICAgICogTWluaW11bSB2YWx1ZSBvZiB0aGUgZGF0YSBwb2ludHMgaW4gdGhlIGRhdGEgYXJyYXkuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFdvcmxkIHNwYWNpbmcgYmV0d2VlbiB0aGUgZGF0YSBwb2ludHMgaW4gWCBhbmQgWSBkaXJlY3Rpb24uCiAgICAgKiBAdG9kbyBlbGVtZW50U2l6ZVggYW5kIFkKICAgICAqIEBkZWZhdWx0IDEKICAgICAqLwoKICAgIC8qKgogICAgICogQGRlZmF1bHQgdHJ1ZQogICAgICovCgogICAgLyoqCiAgICAgKiBAcGFyYW0gZGF0YSBBbiBhcnJheSBvZiBudW1iZXJzLCBvciBoZWlnaHQgdmFsdWVzLCB0aGF0IGFyZSBzcHJlYWQgb3V0IGFsb25nIHRoZSB4IGF4aXMuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGRhdGEsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IFV0aWxzLmRlZmF1bHRzKG9wdGlvbnMsIHsKICAgICAgICBtYXhWYWx1ZTogbnVsbCwKICAgICAgICBtaW5WYWx1ZTogbnVsbCwKICAgICAgICBlbGVtZW50U2l6ZTogMQogICAgICB9KTsKICAgICAgc3VwZXIoewogICAgICAgIHR5cGU6IFNoYXBlLnR5cGVzLkhFSUdIVEZJRUxECiAgICAgIH0pOwogICAgICB0aGlzLmRhdGEgPSB2b2lkIDA7CiAgICAgIHRoaXMubWF4VmFsdWUgPSB2b2lkIDA7CiAgICAgIHRoaXMubWluVmFsdWUgPSB2b2lkIDA7CiAgICAgIHRoaXMuZWxlbWVudFNpemUgPSB2b2lkIDA7CiAgICAgIHRoaXMuY2FjaGVFbmFibGVkID0gdm9pZCAwOwogICAgICB0aGlzLnBpbGxhckNvbnZleCA9IHZvaWQgMDsKICAgICAgdGhpcy5waWxsYXJPZmZzZXQgPSB2b2lkIDA7CiAgICAgIHRoaXMuX2NhY2hlZFBpbGxhcnMgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CiAgICAgIHRoaXMubWF4VmFsdWUgPSBvcHRpb25zLm1heFZhbHVlOwogICAgICB0aGlzLm1pblZhbHVlID0gb3B0aW9ucy5taW5WYWx1ZTsKICAgICAgdGhpcy5lbGVtZW50U2l6ZSA9IG9wdGlvbnMuZWxlbWVudFNpemU7CgogICAgICBpZiAob3B0aW9ucy5taW5WYWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHRoaXMudXBkYXRlTWluVmFsdWUoKTsKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMubWF4VmFsdWUgPT09IG51bGwpIHsKICAgICAgICB0aGlzLnVwZGF0ZU1heFZhbHVlKCk7CiAgICAgIH0KCiAgICAgIHRoaXMuY2FjaGVFbmFibGVkID0gdHJ1ZTsKICAgICAgdGhpcy5waWxsYXJDb252ZXggPSBuZXcgQ29udmV4UG9seWhlZHJvbigpOwogICAgICB0aGlzLnBpbGxhck9mZnNldCA9IG5ldyBWZWMzKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsgLy8gImlfal9pc1VwcGVyIiA9PiB7IGNvbnZleDogLi4uLCBvZmZzZXQ6IC4uLiB9CiAgICAgIC8vIGZvciBleGFtcGxlOgogICAgICAvLyBfY2FjaGVkUGlsbGFyc1siMF8yXzEiXQoKICAgICAgdGhpcy5fY2FjaGVkUGlsbGFycyA9IHt9OwogICAgfQogICAgLyoqCiAgICAgKiBDYWxsIHdoZW5ldmVyIHlvdSBjaGFuZ2UgdGhlIGRhdGEgYXJyYXkuCiAgICAgKi8KCgogICAgdXBkYXRlKCkgewogICAgICB0aGlzLl9jYWNoZWRQaWxsYXJzID0ge307CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSB0aGUgYG1pblZhbHVlYCBwcm9wZXJ0eQogICAgICovCgoKICAgIHVwZGF0ZU1pblZhbHVlKCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBsZXQgbWluVmFsdWUgPSBkYXRhWzBdWzBdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gZGF0YVtpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgdiA9IGRhdGFbaV1bal07CgogICAgICAgICAgaWYgKHYgPCBtaW5WYWx1ZSkgewogICAgICAgICAgICBtaW5WYWx1ZSA9IHY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLm1pblZhbHVlID0gbWluVmFsdWU7CiAgICB9CiAgICAvKioKICAgICAqIFVwZGF0ZSB0aGUgYG1heFZhbHVlYCBwcm9wZXJ0eQogICAgICovCgoKICAgIHVwZGF0ZU1heFZhbHVlKCkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBsZXQgbWF4VmFsdWUgPSBkYXRhWzBdWzBdOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gZGF0YVtpXS5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgdiA9IGRhdGFbaV1bal07CgogICAgICAgICAgaWYgKHYgPiBtYXhWYWx1ZSkgewogICAgICAgICAgICBtYXhWYWx1ZSA9IHY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLm1heFZhbHVlID0gbWF4VmFsdWU7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgaGVpZ2h0IHZhbHVlIGF0IGFuIGluZGV4LiBEb24ndCBmb3JnZXQgdG8gdXBkYXRlIG1heFZhbHVlIGFuZCBtaW5WYWx1ZSBhZnRlciB5b3UncmUgZG9uZS4KICAgICAqLwoKCiAgICBzZXRIZWlnaHRWYWx1ZUF0SW5kZXgoeGksIHlpLCB2YWx1ZSkgewogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBkYXRhW3hpXVt5aV0gPSB2YWx1ZTsgLy8gSW52YWxpZGF0ZSBjYWNoZQoKICAgICAgdGhpcy5jbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZmFsc2UpOwoKICAgICAgaWYgKHhpID4gMCkgewogICAgICAgIHRoaXMuY2xlYXJDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSAtIDEsIHlpLCB0cnVlKTsKICAgICAgICB0aGlzLmNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGkgLSAxLCB5aSwgZmFsc2UpOwogICAgICB9CgogICAgICBpZiAoeWkgPiAwKSB7CiAgICAgICAgdGhpcy5jbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSAtIDEsIHRydWUpOwogICAgICAgIHRoaXMuY2xlYXJDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSwgeWkgLSAxLCBmYWxzZSk7CiAgICAgIH0KCiAgICAgIGlmICh5aSA+IDAgJiYgeGkgPiAwKSB7CiAgICAgICAgdGhpcy5jbGVhckNhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpIC0gMSwgeWkgLSAxLCB0cnVlKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgbWF4L21pbiBpbiBhIHJlY3RhbmdsZSBpbiB0aGUgbWF0cml4IGRhdGEKICAgICAqIEBwYXJhbSByZXN1bHQgQW4gYXJyYXkgdG8gc3RvcmUgdGhlIHJlc3VsdHMgaW4uCiAgICAgKiBAcmV0dXJuIFRoZSByZXN1bHQgYXJyYXksIGlmIGl0IHdhcyBwYXNzZWQgaW4uIE1pbmltdW0gd2lsbCBiZSBhdCBwb3NpdGlvbiAwIGFuZCBtYXggYXQgMS4KICAgICAqLwoKCiAgICBnZXRSZWN0TWluTWF4KGlNaW5YLCBpTWluWSwgaU1heFgsIGlNYXhZLCByZXN1bHQpIHsKICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVzdWx0ID0gW107CiAgICAgIH0KCiAgICAgIC8vIEdldCBtYXggYW5kIG1pbiBvZiB0aGUgZGF0YQogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOyAvLyBTZXQgZmlyc3QgdmFsdWUKCiAgICAgIGxldCBtYXggPSB0aGlzLm1pblZhbHVlOwoKICAgICAgZm9yIChsZXQgaSA9IGlNaW5YOyBpIDw9IGlNYXhYOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gaU1pblk7IGogPD0gaU1heFk7IGorKykgewogICAgICAgICAgY29uc3QgaGVpZ2h0ID0gZGF0YVtpXVtqXTsKCiAgICAgICAgICBpZiAoaGVpZ2h0ID4gbWF4KSB7CiAgICAgICAgICAgIG1heCA9IGhlaWdodDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlc3VsdFswXSA9IHRoaXMubWluVmFsdWU7CiAgICAgIHJlc3VsdFsxXSA9IG1heDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBpbmRleCBvZiBhIGxvY2FsIHBvc2l0aW9uIG9uIHRoZSBoZWlnaHRmaWVsZC4gVGhlIGluZGV4ZXMgaW5kaWNhdGUgdGhlIHJlY3RhbmdsZXMsIHNvIGlmIHlvdXIgdGVycmFpbiBpcyBtYWRlIG9mIE4geCBOIGhlaWdodCBkYXRhIHBvaW50cywgeW91IHdpbGwgaGF2ZSByZWN0YW5nbGUgaW5kZXhlcyByYW5naW5nIGZyb20gMCB0byBOLTEuCiAgICAgKiBAcGFyYW0gcmVzdWx0IFR3by1lbGVtZW50IGFycmF5CiAgICAgKiBAcGFyYW0gY2xhbXAgSWYgdGhlIHBvc2l0aW9uIHNob3VsZCBiZSBjbGFtcGVkIHRvIHRoZSBoZWlnaHRmaWVsZCBlZGdlLgogICAgICovCgoKICAgIGdldEluZGV4T2ZQb3NpdGlvbih4LCB5LCByZXN1bHQsIGNsYW1wKSB7CiAgICAgIC8vIEdldCB0aGUgaW5kZXggb2YgdGhlIGRhdGEgcG9pbnRzIHRvIHRlc3QgYWdhaW5zdAogICAgICBjb25zdCB3ID0gdGhpcy5lbGVtZW50U2l6ZTsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgbGV0IHhpID0gTWF0aC5mbG9vcih4IC8gdyk7CiAgICAgIGxldCB5aSA9IE1hdGguZmxvb3IoeSAvIHcpOwogICAgICByZXN1bHRbMF0gPSB4aTsKICAgICAgcmVzdWx0WzFdID0geWk7CgogICAgICBpZiAoY2xhbXApIHsKICAgICAgICAvLyBDbGFtcCBpbmRleCB0byBlZGdlcwogICAgICAgIGlmICh4aSA8IDApIHsKICAgICAgICAgIHhpID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh5aSA8IDApIHsKICAgICAgICAgIHlpID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh4aSA+PSBkYXRhLmxlbmd0aCAtIDEpIHsKICAgICAgICAgIHhpID0gZGF0YS5sZW5ndGggLSAxOwogICAgICAgIH0KCiAgICAgICAgaWYgKHlpID49IGRhdGFbMF0ubGVuZ3RoIC0gMSkgewogICAgICAgICAgeWkgPSBkYXRhWzBdLmxlbmd0aCAtIDE7CiAgICAgICAgfQogICAgICB9IC8vIEJhaWwgb3V0IGlmIHdlIGFyZSBvdXQgb2YgdGhlIHRlcnJhaW4KCgogICAgICBpZiAoeGkgPCAwIHx8IHlpIDwgMCB8fCB4aSA+PSBkYXRhLmxlbmd0aCAtIDEgfHwgeWkgPj0gZGF0YVswXS5sZW5ndGggLSAxKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBnZXRUcmlhbmdsZUF0KHgsIHksIGVkZ2VDbGFtcCwgYSwgYiwgYykgewogICAgICBjb25zdCBpZHggPSBnZXRIZWlnaHRBdF9pZHg7CiAgICAgIHRoaXMuZ2V0SW5kZXhPZlBvc2l0aW9uKHgsIHksIGlkeCwgZWRnZUNsYW1wKTsKICAgICAgbGV0IHhpID0gaWR4WzBdOwogICAgICBsZXQgeWkgPSBpZHhbMV07CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CgogICAgICBpZiAoZWRnZUNsYW1wKSB7CiAgICAgICAgeGkgPSBNYXRoLm1pbihkYXRhLmxlbmd0aCAtIDIsIE1hdGgubWF4KDAsIHhpKSk7CiAgICAgICAgeWkgPSBNYXRoLm1pbihkYXRhWzBdLmxlbmd0aCAtIDIsIE1hdGgubWF4KDAsIHlpKSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IGVsZW1lbnRTaXplID0gdGhpcy5lbGVtZW50U2l6ZTsKICAgICAgY29uc3QgbG93ZXJEaXN0MiA9ICh4IC8gZWxlbWVudFNpemUgLSB4aSkgKiogMiArICh5IC8gZWxlbWVudFNpemUgLSB5aSkgKiogMjsKICAgICAgY29uc3QgdXBwZXJEaXN0MiA9ICh4IC8gZWxlbWVudFNpemUgLSAoeGkgKyAxKSkgKiogMiArICh5IC8gZWxlbWVudFNpemUgLSAoeWkgKyAxKSkgKiogMjsKICAgICAgY29uc3QgdXBwZXIgPSBsb3dlckRpc3QyID4gdXBwZXJEaXN0MjsKICAgICAgdGhpcy5nZXRUcmlhbmdsZSh4aSwgeWksIHVwcGVyLCBhLCBiLCBjKTsKICAgICAgcmV0dXJuIHVwcGVyOwogICAgfQoKICAgIGdldE5vcm1hbEF0KHgsIHksIGVkZ2VDbGFtcCwgcmVzdWx0KSB7CiAgICAgIGNvbnN0IGEgPSBnZXROb3JtYWxBdF9hOwogICAgICBjb25zdCBiID0gZ2V0Tm9ybWFsQXRfYjsKICAgICAgY29uc3QgYyA9IGdldE5vcm1hbEF0X2M7CiAgICAgIGNvbnN0IGUwID0gZ2V0Tm9ybWFsQXRfZTA7CiAgICAgIGNvbnN0IGUxID0gZ2V0Tm9ybWFsQXRfZTE7CiAgICAgIHRoaXMuZ2V0VHJpYW5nbGVBdCh4LCB5LCBlZGdlQ2xhbXAsIGEsIGIsIGMpOwogICAgICBiLnZzdWIoYSwgZTApOwogICAgICBjLnZzdWIoYSwgZTEpOwogICAgICBlMC5jcm9zcyhlMSwgcmVzdWx0KTsKICAgICAgcmVzdWx0Lm5vcm1hbGl6ZSgpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYW4gQUFCQiBvZiBhIHNxdWFyZSBpbiB0aGUgaGVpZ2h0ZmllbGQKICAgICAqIEBwYXJhbSB4aQogICAgICogQHBhcmFtIHlpCiAgICAgKiBAcGFyYW0gcmVzdWx0CiAgICAgKi8KCgogICAgZ2V0QWFiYkF0SW5kZXgoeGksIHlpLCBfcmVmKSB7CiAgICAgIGxldCB7CiAgICAgICAgbG93ZXJCb3VuZCwKICAgICAgICB1cHBlckJvdW5kCiAgICAgIH0gPSBfcmVmOwogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBjb25zdCBlbGVtZW50U2l6ZSA9IHRoaXMuZWxlbWVudFNpemU7CiAgICAgIGxvd2VyQm91bmQuc2V0KHhpICogZWxlbWVudFNpemUsIHlpICogZWxlbWVudFNpemUsIGRhdGFbeGldW3lpXSk7CiAgICAgIHVwcGVyQm91bmQuc2V0KCh4aSArIDEpICogZWxlbWVudFNpemUsICh5aSArIDEpICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aSArIDFdKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBoZWlnaHQgaW4gdGhlIGhlaWdodGZpZWxkIGF0IGEgZ2l2ZW4gcG9zaXRpb24KICAgICAqLwoKCiAgICBnZXRIZWlnaHRBdCh4LCB5LCBlZGdlQ2xhbXApIHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgY29uc3QgYSA9IGdldEhlaWdodEF0X2E7CiAgICAgIGNvbnN0IGIgPSBnZXRIZWlnaHRBdF9iOwogICAgICBjb25zdCBjID0gZ2V0SGVpZ2h0QXRfYzsKICAgICAgY29uc3QgaWR4ID0gZ2V0SGVpZ2h0QXRfaWR4OwogICAgICB0aGlzLmdldEluZGV4T2ZQb3NpdGlvbih4LCB5LCBpZHgsIGVkZ2VDbGFtcCk7CiAgICAgIGxldCB4aSA9IGlkeFswXTsKICAgICAgbGV0IHlpID0gaWR4WzFdOwoKICAgICAgaWYgKGVkZ2VDbGFtcCkgewogICAgICAgIHhpID0gTWF0aC5taW4oZGF0YS5sZW5ndGggLSAyLCBNYXRoLm1heCgwLCB4aSkpOwogICAgICAgIHlpID0gTWF0aC5taW4oZGF0YVswXS5sZW5ndGggLSAyLCBNYXRoLm1heCgwLCB5aSkpOwogICAgICB9CgogICAgICBjb25zdCB1cHBlciA9IHRoaXMuZ2V0VHJpYW5nbGVBdCh4LCB5LCBlZGdlQ2xhbXAsIGEsIGIsIGMpOwogICAgICBiYXJ5Y2VudHJpY1dlaWdodHMoeCwgeSwgYS54LCBhLnksIGIueCwgYi55LCBjLngsIGMueSwgZ2V0SGVpZ2h0QXRfd2VpZ2h0cyk7CiAgICAgIGNvbnN0IHcgPSBnZXRIZWlnaHRBdF93ZWlnaHRzOwoKICAgICAgaWYgKHVwcGVyKSB7CiAgICAgICAgLy8gVG9wIHRyaWFuZ2xlIHZlcnRzCiAgICAgICAgcmV0dXJuIGRhdGFbeGkgKyAxXVt5aSArIDFdICogdy54ICsgZGF0YVt4aV1beWkgKyAxXSAqIHcueSArIGRhdGFbeGkgKyAxXVt5aV0gKiB3Lno7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVG9wIHRyaWFuZ2xlIHZlcnRzCiAgICAgICAgcmV0dXJuIGRhdGFbeGldW3lpXSAqIHcueCArIGRhdGFbeGkgKyAxXVt5aV0gKiB3LnkgKyBkYXRhW3hpXVt5aSArIDFdICogdy56OwogICAgICB9CiAgICB9CgogICAgZ2V0Q2FjaGVDb252ZXhUcmlhbmdsZVBpbGxhcktleSh4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUpIHsKICAgICAgcmV0dXJuIHhpICsgIl8iICsgeWkgKyAiXyIgKyAoZ2V0VXBwZXJUcmlhbmdsZSA/IDEgOiAwKTsKICAgIH0KCiAgICBnZXRDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUpIHsKICAgICAgcmV0dXJuIHRoaXMuX2NhY2hlZFBpbGxhcnNbdGhpcy5nZXRDYWNoZUNvbnZleFRyaWFuZ2xlUGlsbGFyS2V5KHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSldOwogICAgfQoKICAgIHNldENhY2hlZENvbnZleFRyaWFuZ2xlUGlsbGFyKHhpLCB5aSwgZ2V0VXBwZXJUcmlhbmdsZSwgY29udmV4LCBvZmZzZXQpIHsKICAgICAgdGhpcy5fY2FjaGVkUGlsbGFyc1t0aGlzLmdldENhY2hlQ29udmV4VHJpYW5nbGVQaWxsYXJLZXkoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKV0gPSB7CiAgICAgICAgY29udmV4LAogICAgICAgIG9mZnNldAogICAgICB9OwogICAgfQoKICAgIGNsZWFyQ2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKSB7CiAgICAgIGRlbGV0ZSB0aGlzLl9jYWNoZWRQaWxsYXJzW3RoaXMuZ2V0Q2FjaGVDb252ZXhUcmlhbmdsZVBpbGxhcktleSh4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUpXTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGEgdHJpYW5nbGUgZnJvbSB0aGUgaGVpZ2h0ZmllbGQKICAgICAqLwoKCiAgICBnZXRUcmlhbmdsZSh4aSwgeWksIHVwcGVyLCBhLCBiLCBjKSB7CiAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGE7CiAgICAgIGNvbnN0IGVsZW1lbnRTaXplID0gdGhpcy5lbGVtZW50U2l6ZTsKCiAgICAgIGlmICh1cHBlcikgewogICAgICAgIC8vIFRvcCB0cmlhbmdsZSB2ZXJ0cwogICAgICAgIGEuc2V0KCh4aSArIDEpICogZWxlbWVudFNpemUsICh5aSArIDEpICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aSArIDFdKTsKICAgICAgICBiLnNldCh4aSAqIGVsZW1lbnRTaXplLCAoeWkgKyAxKSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpXVt5aSArIDFdKTsKICAgICAgICBjLnNldCgoeGkgKyAxKSAqIGVsZW1lbnRTaXplLCB5aSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpICsgMV1beWldKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUb3AgdHJpYW5nbGUgdmVydHMKICAgICAgICBhLnNldCh4aSAqIGVsZW1lbnRTaXplLCB5aSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpXVt5aV0pOwogICAgICAgIGIuc2V0KCh4aSArIDEpICogZWxlbWVudFNpemUsIHlpICogZWxlbWVudFNpemUsIGRhdGFbeGkgKyAxXVt5aV0pOwogICAgICAgIGMuc2V0KHhpICogZWxlbWVudFNpemUsICh5aSArIDEpICogZWxlbWVudFNpemUsIGRhdGFbeGldW3lpICsgMV0pOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhIHRyaWFuZ2xlIGluIHRoZSB0ZXJyYWluIGluIHRoZSBmb3JtIG9mIGEgdHJpYW5ndWxhciBjb252ZXggc2hhcGUuCiAgICAgKi8KCgogICAgZ2V0Q29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKSB7CiAgICAgIGxldCByZXN1bHQgPSB0aGlzLnBpbGxhckNvbnZleDsKICAgICAgbGV0IG9mZnNldFJlc3VsdCA9IHRoaXMucGlsbGFyT2Zmc2V0OwoKICAgICAgaWYgKHRoaXMuY2FjaGVFbmFibGVkKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0Q2FjaGVkQ29udmV4VHJpYW5nbGVQaWxsYXIoeGksIHlpLCBnZXRVcHBlclRyaWFuZ2xlKTsKCiAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgIHRoaXMucGlsbGFyQ29udmV4ID0gZGF0YS5jb252ZXg7CiAgICAgICAgICB0aGlzLnBpbGxhck9mZnNldCA9IGRhdGEub2Zmc2V0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgcmVzdWx0ID0gbmV3IENvbnZleFBvbHloZWRyb24oKTsKICAgICAgICBvZmZzZXRSZXN1bHQgPSBuZXcgVmVjMygpOwogICAgICAgIHRoaXMucGlsbGFyQ29udmV4ID0gcmVzdWx0OwogICAgICAgIHRoaXMucGlsbGFyT2Zmc2V0ID0gb2Zmc2V0UmVzdWx0OwogICAgICB9CgogICAgICBjb25zdCBkYXRhID0gdGhpcy5kYXRhOwogICAgICBjb25zdCBlbGVtZW50U2l6ZSA9IHRoaXMuZWxlbWVudFNpemU7CiAgICAgIGNvbnN0IGZhY2VzID0gcmVzdWx0LmZhY2VzOyAvLyBSZXVzZSB2ZXJ0cyBpZiBwb3NzaWJsZQoKICAgICAgcmVzdWx0LnZlcnRpY2VzLmxlbmd0aCA9IDY7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDY7IGkrKykgewogICAgICAgIGlmICghcmVzdWx0LnZlcnRpY2VzW2ldKSB7CiAgICAgICAgICByZXN1bHQudmVydGljZXNbaV0gPSBuZXcgVmVjMygpOwogICAgICAgIH0KICAgICAgfSAvLyBSZXVzZSBmYWNlcyBpZiBwb3NzaWJsZQoKCiAgICAgIGZhY2VzLmxlbmd0aCA9IDU7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykgewogICAgICAgIGlmICghZmFjZXNbaV0pIHsKICAgICAgICAgIGZhY2VzW2ldID0gW107CiAgICAgICAgfQogICAgICB9CgogICAgICBjb25zdCB2ZXJ0cyA9IHJlc3VsdC52ZXJ0aWNlczsKICAgICAgY29uc3QgaCA9IChNYXRoLm1pbihkYXRhW3hpXVt5aV0sIGRhdGFbeGkgKyAxXVt5aV0sIGRhdGFbeGldW3lpICsgMV0sIGRhdGFbeGkgKyAxXVt5aSArIDFdKSAtIHRoaXMubWluVmFsdWUpIC8gMiArIHRoaXMubWluVmFsdWU7CgogICAgICBpZiAoIWdldFVwcGVyVHJpYW5nbGUpIHsKICAgICAgICAvLyBDZW50ZXIgb2YgdGhlIHRyaWFuZ2xlIHBpbGxhciAtIGFsbCBwb2x5Z29ucyBhcmUgZ2l2ZW4gcmVsYXRpdmUgdG8gdGhpcyBvbmUKICAgICAgICBvZmZzZXRSZXN1bHQuc2V0KCh4aSArIDAuMjUpICogZWxlbWVudFNpemUsIC8vIHNvcnQgb2YgY2VudGVyIG9mIGEgdHJpYW5nbGUKICAgICAgICAoeWkgKyAwLjI1KSAqIGVsZW1lbnRTaXplLCBoIC8vIHZlcnRpY2FsIGNlbnRlcgogICAgICAgICk7IC8vIFRvcCB0cmlhbmdsZSB2ZXJ0cwoKICAgICAgICB2ZXJ0c1swXS5zZXQoLTAuMjUgKiBlbGVtZW50U2l6ZSwgLTAuMjUgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aV1beWldIC0gaCk7CiAgICAgICAgdmVydHNbMV0uc2V0KDAuNzUgKiBlbGVtZW50U2l6ZSwgLTAuMjUgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aSArIDFdW3lpXSAtIGgpOwogICAgICAgIHZlcnRzWzJdLnNldCgtMC4yNSAqIGVsZW1lbnRTaXplLCAwLjc1ICogZWxlbWVudFNpemUsIGRhdGFbeGldW3lpICsgMV0gLSBoKTsgLy8gYm90dG9tIHRyaWFuZ2xlIHZlcnRzCgogICAgICAgIHZlcnRzWzNdLnNldCgtMC4yNSAqIGVsZW1lbnRTaXplLCAtMC4yNSAqIGVsZW1lbnRTaXplLCAtTWF0aC5hYnMoaCkgLSAxKTsKICAgICAgICB2ZXJ0c1s0XS5zZXQoMC43NSAqIGVsZW1lbnRTaXplLCAtMC4yNSAqIGVsZW1lbnRTaXplLCAtTWF0aC5hYnMoaCkgLSAxKTsKICAgICAgICB2ZXJ0c1s1XS5zZXQoLTAuMjUgKiBlbGVtZW50U2l6ZSwgMC43NSAqIGVsZW1lbnRTaXplLCAtTWF0aC5hYnMoaCkgLSAxKTsgLy8gdG9wIHRyaWFuZ2xlCgogICAgICAgIGZhY2VzWzBdWzBdID0gMDsKICAgICAgICBmYWNlc1swXVsxXSA9IDE7CiAgICAgICAgZmFjZXNbMF1bMl0gPSAyOyAvLyBib3R0b20gdHJpYW5nbGUKCiAgICAgICAgZmFjZXNbMV1bMF0gPSA1OwogICAgICAgIGZhY2VzWzFdWzFdID0gNDsKICAgICAgICBmYWNlc1sxXVsyXSA9IDM7IC8vIC14IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzJdWzBdID0gMDsKICAgICAgICBmYWNlc1syXVsxXSA9IDI7CiAgICAgICAgZmFjZXNbMl1bMl0gPSA1OwogICAgICAgIGZhY2VzWzJdWzNdID0gMzsgLy8gLXkgZmFjaW5nIHF1YWQKCiAgICAgICAgZmFjZXNbM11bMF0gPSAxOwogICAgICAgIGZhY2VzWzNdWzFdID0gMDsKICAgICAgICBmYWNlc1szXVsyXSA9IDM7CiAgICAgICAgZmFjZXNbM11bM10gPSA0OyAvLyAreHkgZmFjaW5nIHF1YWQKCiAgICAgICAgZmFjZXNbNF1bMF0gPSA0OwogICAgICAgIGZhY2VzWzRdWzFdID0gNTsKICAgICAgICBmYWNlc1s0XVsyXSA9IDI7CiAgICAgICAgZmFjZXNbNF1bM10gPSAxOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIENlbnRlciBvZiB0aGUgdHJpYW5nbGUgcGlsbGFyIC0gYWxsIHBvbHlnb25zIGFyZSBnaXZlbiByZWxhdGl2ZSB0byB0aGlzIG9uZQogICAgICAgIG9mZnNldFJlc3VsdC5zZXQoKHhpICsgMC43NSkgKiBlbGVtZW50U2l6ZSwgLy8gc29ydCBvZiBjZW50ZXIgb2YgYSB0cmlhbmdsZQogICAgICAgICh5aSArIDAuNzUpICogZWxlbWVudFNpemUsIGggLy8gdmVydGljYWwgY2VudGVyCiAgICAgICAgKTsgLy8gVG9wIHRyaWFuZ2xlIHZlcnRzCgogICAgICAgIHZlcnRzWzBdLnNldCgwLjI1ICogZWxlbWVudFNpemUsIDAuMjUgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aSArIDFdW3lpICsgMV0gLSBoKTsKICAgICAgICB2ZXJ0c1sxXS5zZXQoLTAuNzUgKiBlbGVtZW50U2l6ZSwgMC4yNSAqIGVsZW1lbnRTaXplLCBkYXRhW3hpXVt5aSArIDFdIC0gaCk7CiAgICAgICAgdmVydHNbMl0uc2V0KDAuMjUgKiBlbGVtZW50U2l6ZSwgLTAuNzUgKiBlbGVtZW50U2l6ZSwgZGF0YVt4aSArIDFdW3lpXSAtIGgpOyAvLyBib3R0b20gdHJpYW5nbGUgdmVydHMKCiAgICAgICAgdmVydHNbM10uc2V0KDAuMjUgKiBlbGVtZW50U2l6ZSwgMC4yNSAqIGVsZW1lbnRTaXplLCAtTWF0aC5hYnMoaCkgLSAxKTsKICAgICAgICB2ZXJ0c1s0XS5zZXQoLTAuNzUgKiBlbGVtZW50U2l6ZSwgMC4yNSAqIGVsZW1lbnRTaXplLCAtTWF0aC5hYnMoaCkgLSAxKTsKICAgICAgICB2ZXJ0c1s1XS5zZXQoMC4yNSAqIGVsZW1lbnRTaXplLCAtMC43NSAqIGVsZW1lbnRTaXplLCAtTWF0aC5hYnMoaCkgLSAxKTsgLy8gVG9wIHRyaWFuZ2xlCgogICAgICAgIGZhY2VzWzBdWzBdID0gMDsKICAgICAgICBmYWNlc1swXVsxXSA9IDE7CiAgICAgICAgZmFjZXNbMF1bMl0gPSAyOyAvLyBib3R0b20gdHJpYW5nbGUKCiAgICAgICAgZmFjZXNbMV1bMF0gPSA1OwogICAgICAgIGZhY2VzWzFdWzFdID0gNDsKICAgICAgICBmYWNlc1sxXVsyXSA9IDM7IC8vICt4IGZhY2luZyBxdWFkCgogICAgICAgIGZhY2VzWzJdWzBdID0gMjsKICAgICAgICBmYWNlc1syXVsxXSA9IDU7CiAgICAgICAgZmFjZXNbMl1bMl0gPSAzOwogICAgICAgIGZhY2VzWzJdWzNdID0gMDsgLy8gK3kgZmFjaW5nIHF1YWQKCiAgICAgICAgZmFjZXNbM11bMF0gPSAzOwogICAgICAgIGZhY2VzWzNdWzFdID0gNDsKICAgICAgICBmYWNlc1szXVsyXSA9IDE7CiAgICAgICAgZmFjZXNbM11bM10gPSAwOyAvLyAteHkgZmFjaW5nIHF1YWQKCiAgICAgICAgZmFjZXNbNF1bMF0gPSAxOwogICAgICAgIGZhY2VzWzRdWzFdID0gNDsKICAgICAgICBmYWNlc1s0XVsyXSA9IDU7CiAgICAgICAgZmFjZXNbNF1bM10gPSAyOwogICAgICB9CgogICAgICByZXN1bHQuY29tcHV0ZU5vcm1hbHMoKTsKICAgICAgcmVzdWx0LmNvbXB1dGVFZGdlcygpOwogICAgICByZXN1bHQudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsKICAgICAgdGhpcy5zZXRDYWNoZWRDb252ZXhUcmlhbmdsZVBpbGxhcih4aSwgeWksIGdldFVwcGVyVHJpYW5nbGUsIHJlc3VsdCwgb2Zmc2V0UmVzdWx0KTsKICAgIH0KCiAgICBjYWxjdWxhdGVMb2NhbEluZXJ0aWEobWFzcywgdGFyZ2V0KSB7CiAgICAgIGlmICh0YXJnZXQgPT09IHZvaWQgMCkgewogICAgICAgIHRhcmdldCA9IG5ldyBWZWMzKCk7CiAgICAgIH0KCiAgICAgIHRhcmdldC5zZXQoMCwgMCwgMCk7CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9CgogICAgdm9sdW1lKCkgewogICAgICByZXR1cm4gKC8vIFRoZSB0ZXJyYWluIGlzIGluZmluaXRlCiAgICAgICAgTnVtYmVyLk1BWF9WQUxVRQogICAgICApOwogICAgfQoKICAgIGNhbGN1bGF0ZVdvcmxkQUFCQihwb3MsIHF1YXQsIG1pbiwgbWF4KSB7CiAgICAgIC8qKiBAVE9ETyBkbyBpdCBwcm9wZXJseSAqLwogICAgICBtaW4uc2V0KC1OdW1iZXIuTUFYX1ZBTFVFLCAtTnVtYmVyLk1BWF9WQUxVRSwgLU51bWJlci5NQVhfVkFMVUUpOwogICAgICBtYXguc2V0KE51bWJlci5NQVhfVkFMVUUsIE51bWJlci5NQVhfVkFMVUUsIE51bWJlci5NQVhfVkFMVUUpOwogICAgfQoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICAvLyBVc2UgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgbWluL21heCB2YWx1ZXMKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgY29uc3QgcyA9IHRoaXMuZWxlbWVudFNpemU7CiAgICAgIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgPSBuZXcgVmVjMyhkYXRhLmxlbmd0aCAqIHMsIGRhdGFbMF0ubGVuZ3RoICogcywgTWF0aC5tYXgoTWF0aC5hYnModGhpcy5tYXhWYWx1ZSksIE1hdGguYWJzKHRoaXMubWluVmFsdWUpKSkubGVuZ3RoKCk7CiAgICB9CiAgICAvKioKICAgICAqIFNldHMgdGhlIGhlaWdodCB2YWx1ZXMgZnJvbSBhbiBpbWFnZS4gQ3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIGluIGJyb3dzZXIuCiAgICAgKi8KCgogICAgc2V0SGVpZ2h0c0Zyb21JbWFnZShpbWFnZSwgc2NhbGUpIHsKICAgICAgY29uc3QgewogICAgICAgIHgsCiAgICAgICAgeiwKICAgICAgICB5CiAgICAgIH0gPSBzY2FsZTsKICAgICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgIGNhbnZhcy53aWR0aCA9IGltYWdlLndpZHRoOwogICAgICBjYW52YXMuaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0OwogICAgICBjb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICAgIGNvbnRleHQuZHJhd0ltYWdlKGltYWdlLCAwLCAwKTsKICAgICAgY29uc3QgaW1hZ2VEYXRhID0gY29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgaW1hZ2Uud2lkdGgsIGltYWdlLmhlaWdodCk7CiAgICAgIGNvbnN0IG1hdHJpeCA9IHRoaXMuZGF0YTsKICAgICAgbWF0cml4Lmxlbmd0aCA9IDA7CiAgICAgIHRoaXMuZWxlbWVudFNpemUgPSBNYXRoLmFicyh4KSAvIGltYWdlRGF0YS53aWR0aDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW1hZ2VEYXRhLmhlaWdodDsgaSsrKSB7CiAgICAgICAgY29uc3Qgcm93ID0gW107CgogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaW1hZ2VEYXRhLndpZHRoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IGEgPSBpbWFnZURhdGEuZGF0YVsoaSAqIGltYWdlRGF0YS5oZWlnaHQgKyBqKSAqIDRdOwogICAgICAgICAgY29uc3QgYiA9IGltYWdlRGF0YS5kYXRhWyhpICogaW1hZ2VEYXRhLmhlaWdodCArIGopICogNCArIDFdOwogICAgICAgICAgY29uc3QgYyA9IGltYWdlRGF0YS5kYXRhWyhpICogaW1hZ2VEYXRhLmhlaWdodCArIGopICogNCArIDJdOwogICAgICAgICAgY29uc3QgaGVpZ2h0ID0gKGEgKyBiICsgYykgLyA0IC8gMjU1ICogejsKCiAgICAgICAgICBpZiAoeCA8IDApIHsKICAgICAgICAgICAgcm93LnB1c2goaGVpZ2h0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvdy51bnNoaWZ0KGhlaWdodCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoeSA8IDApIHsKICAgICAgICAgIG1hdHJpeC51bnNoaWZ0KHJvdyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hdHJpeC5wdXNoKHJvdyk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnVwZGF0ZU1heFZhbHVlKCk7CiAgICAgIHRoaXMudXBkYXRlTWluVmFsdWUoKTsKICAgICAgdGhpcy51cGRhdGUoKTsKICAgIH0KCiAgfQoKICBjb25zdCBnZXRIZWlnaHRBdF9pZHggPSBbXTsKICBjb25zdCBnZXRIZWlnaHRBdF93ZWlnaHRzID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9hID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9iID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRIZWlnaHRBdF9jID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9hID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9iID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9jID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXROb3JtYWxBdF9lMCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgZ2V0Tm9ybWFsQXRfZTEgPSBuZXcgVmVjMygpOyAvLyBmcm9tIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0JhcnljZW50cmljX2Nvb3JkaW5hdGVfc3lzdGVtCgogIGZ1bmN0aW9uIGJhcnljZW50cmljV2VpZ2h0cyh4LCB5LCBheCwgYXksIGJ4LCBieSwgY3gsIGN5LCByZXN1bHQpIHsKICAgIHJlc3VsdC54ID0gKChieSAtIGN5KSAqICh4IC0gY3gpICsgKGN4IC0gYngpICogKHkgLSBjeSkpIC8gKChieSAtIGN5KSAqIChheCAtIGN4KSArIChjeCAtIGJ4KSAqIChheSAtIGN5KSk7CiAgICByZXN1bHQueSA9ICgoY3kgLSBheSkgKiAoeCAtIGN4KSArIChheCAtIGN4KSAqICh5IC0gY3kpKSAvICgoYnkgLSBjeSkgKiAoYXggLSBjeCkgKyAoY3ggLSBieCkgKiAoYXkgLSBjeSkpOwogICAgcmVzdWx0LnogPSAxIC0gcmVzdWx0LnggLSByZXN1bHQueTsKICB9CiAgLyoqCiAgICogT2N0cmVlTm9kZQogICAqLwoKCiAgY2xhc3MgT2N0cmVlTm9kZSB7CiAgICAvKiogVGhlIHJvb3Qgbm9kZSAqLwoKICAgIC8qKiBCb3VuZGFyeSBvZiB0aGlzIG5vZGUgKi8KCiAgICAvKiogQ29udGFpbmVkIGRhdGEgYXQgdGhlIGN1cnJlbnQgbm9kZSBsZXZlbCAqLwoKICAgIC8qKiBDaGlsZHJlbiB0byB0aGlzIG5vZGUgKi8KICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgdGhpcy5yb290ID0gdm9pZCAwOwogICAgICB0aGlzLmFhYmIgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGF0YSA9IHZvaWQgMDsKICAgICAgdGhpcy5jaGlsZHJlbiA9IHZvaWQgMDsKICAgICAgdGhpcy5yb290ID0gb3B0aW9ucy5yb290IHx8IG51bGw7CiAgICAgIHRoaXMuYWFiYiA9IG9wdGlvbnMuYWFiYiA/IG9wdGlvbnMuYWFiYi5jbG9uZSgpIDogbmV3IEFBQkIoKTsKICAgICAgdGhpcy5kYXRhID0gW107CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBbXTsKICAgIH0KICAgIC8qKgogICAgICogcmVzZXQKICAgICAqLwoKCiAgICByZXNldCgpIHsKICAgICAgdGhpcy5jaGlsZHJlbi5sZW5ndGggPSB0aGlzLmRhdGEubGVuZ3RoID0gMDsKICAgIH0KICAgIC8qKgogICAgICogSW5zZXJ0IGRhdGEgaW50byB0aGlzIG5vZGUKICAgICAqIEByZXR1cm4gVHJ1ZSBpZiBzdWNjZXNzZnVsLCBvdGhlcndpc2UgZmFsc2UKICAgICAqLwoKCiAgICBpbnNlcnQoYWFiYiwgZWxlbWVudERhdGEsIGxldmVsKSB7CiAgICAgIGlmIChsZXZlbCA9PT0gdm9pZCAwKSB7CiAgICAgICAgbGV2ZWwgPSAwOwogICAgICB9CgogICAgICBjb25zdCBub2RlRGF0YSA9IHRoaXMuZGF0YTsgLy8gSWdub3JlIG9iamVjdHMgdGhhdCBkbyBub3QgYmVsb25nIGluIHRoaXMgbm9kZQoKICAgICAgaWYgKCF0aGlzLmFhYmIuY29udGFpbnMoYWFiYikpIHsKICAgICAgICByZXR1cm4gZmFsc2U7IC8vIG9iamVjdCBjYW5ub3QgYmUgYWRkZWQKICAgICAgfQoKICAgICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuOwogICAgICBjb25zdCBtYXhEZXB0aCA9IHRoaXMubWF4RGVwdGggfHwgdGhpcy5yb290Lm1heERlcHRoOwoKICAgICAgaWYgKGxldmVsIDwgbWF4RGVwdGgpIHsKICAgICAgICAvLyBTdWJkaXZpZGUgaWYgdGhlcmUgYXJlIG5vIGNoaWxkcmVuIHlldAogICAgICAgIGxldCBzdWJkaXZpZGVkID0gZmFsc2U7CgogICAgICAgIGlmICghY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICB0aGlzLnN1YmRpdmlkZSgpOwogICAgICAgICAgc3ViZGl2aWRlZCA9IHRydWU7CiAgICAgICAgfSAvLyBhZGQgdG8gd2hpY2hldmVyIG5vZGUgd2lsbCBhY2NlcHQgaXQKCgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSA4OyBpKyspIHsKICAgICAgICAgIGlmIChjaGlsZHJlbltpXS5pbnNlcnQoYWFiYiwgZWxlbWVudERhdGEsIGxldmVsICsgMSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoc3ViZGl2aWRlZCkgewogICAgICAgICAgLy8gTm8gY2hpbGRyZW4gYWNjZXB0ZWQhIE1pZ2h0IGFzIHdlbGwganVzdCByZW1vdmUgZW0gc2luY2UgdGhleSBjb250YWluIG5vbmUKICAgICAgICAgIGNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICB9IC8vIFRvbyBkZWVwLCBvciBjaGlsZHJlbiBkaWRudCB3YW50IGl0LiBhZGQgaXQgaW4gY3VycmVudCBub2RlCgoKICAgICAgbm9kZURhdGEucHVzaChlbGVtZW50RGF0YSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLyoqCiAgICAgKiBDcmVhdGUgOCBlcXVhbGx5IHNpemVkIGNoaWxkcmVuIG5vZGVzIGFuZCBwdXQgdGhlbSBpbiB0aGUgYGNoaWxkcmVuYCBhcnJheS4KICAgICAqLwoKCiAgICBzdWJkaXZpZGUoKSB7CiAgICAgIGNvbnN0IGFhYmIgPSB0aGlzLmFhYmI7CiAgICAgIGNvbnN0IGwgPSBhYWJiLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSBhYWJiLnVwcGVyQm91bmQ7CiAgICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKICAgICAgY2hpbGRyZW4ucHVzaChuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMCwgMCwgMCkKICAgICAgICB9KQogICAgICB9KSwgbmV3IE9jdHJlZU5vZGUoewogICAgICAgIGFhYmI6IG5ldyBBQUJCKHsKICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKDEsIDAsIDApCiAgICAgICAgfSkKICAgICAgfSksIG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygxLCAxLCAwKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMSwgMSwgMSkKICAgICAgICB9KQogICAgICB9KSwgbmV3IE9jdHJlZU5vZGUoewogICAgICAgIGFhYmI6IG5ldyBBQUJCKHsKICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKDAsIDEsIDEpCiAgICAgICAgfSkKICAgICAgfSksIG5ldyBPY3RyZWVOb2RlKHsKICAgICAgICBhYWJiOiBuZXcgQUFCQih7CiAgICAgICAgICBsb3dlckJvdW5kOiBuZXcgVmVjMygwLCAwLCAxKQogICAgICAgIH0pCiAgICAgIH0pLCBuZXcgT2N0cmVlTm9kZSh7CiAgICAgICAgYWFiYjogbmV3IEFBQkIoewogICAgICAgICAgbG93ZXJCb3VuZDogbmV3IFZlYzMoMSwgMCwgMSkKICAgICAgICB9KQogICAgICB9KSwgbmV3IE9jdHJlZU5vZGUoewogICAgICAgIGFhYmI6IG5ldyBBQUJCKHsKICAgICAgICAgIGxvd2VyQm91bmQ6IG5ldyBWZWMzKDAsIDEsIDApCiAgICAgICAgfSkKICAgICAgfSkpOwogICAgICB1LnZzdWIobCwgaGFsZkRpYWdvbmFsKTsKICAgICAgaGFsZkRpYWdvbmFsLnNjYWxlKDAuNSwgaGFsZkRpYWdvbmFsKTsKICAgICAgY29uc3Qgcm9vdCA9IHRoaXMucm9vdCB8fCB0aGlzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IDg7IGkrKykgewogICAgICAgIGNvbnN0IGNoaWxkID0gY2hpbGRyZW5baV07IC8vIFNldCBjdXJyZW50IG5vZGUgYXMgcm9vdAoKICAgICAgICBjaGlsZC5yb290ID0gcm9vdDsgLy8gQ29tcHV0ZSBib3VuZHMKCiAgICAgICAgY29uc3QgbG93ZXJCb3VuZCA9IGNoaWxkLmFhYmIubG93ZXJCb3VuZDsKICAgICAgICBsb3dlckJvdW5kLnggKj0gaGFsZkRpYWdvbmFsLng7CiAgICAgICAgbG93ZXJCb3VuZC55ICo9IGhhbGZEaWFnb25hbC55OwogICAgICAgIGxvd2VyQm91bmQueiAqPSBoYWxmRGlhZ29uYWwuejsKICAgICAgICBsb3dlckJvdW5kLnZhZGQobCwgbG93ZXJCb3VuZCk7IC8vIFVwcGVyIGJvdW5kIGlzIGFsd2F5cyBsb3dlciBib3VuZCArIGhhbGZEaWFnb25hbAoKICAgICAgICBsb3dlckJvdW5kLnZhZGQoaGFsZkRpYWdvbmFsLCBjaGlsZC5hYWJiLnVwcGVyQm91bmQpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbGwgZGF0YSwgcG90ZW50aWFsbHkgd2l0aGluIGFuIEFBQkIKICAgICAqIEByZXR1cm4gVGhlICJyZXN1bHQiIG9iamVjdAogICAgICovCgoKICAgIGFhYmJRdWVyeShhYWJiLCByZXN1bHQpIHsKICAgICAgdGhpcy5kYXRhOyAvLyBhYm9ydCBpZiB0aGUgcmFuZ2UgZG9lcyBub3QgaW50ZXJzZWN0IHRoaXMgbm9kZQogICAgICAvLyBpZiAoIXRoaXMuYWFiYi5vdmVybGFwcyhhYWJiKSl7CiAgICAgIC8vICAgICByZXR1cm4gcmVzdWx0OwogICAgICAvLyB9CiAgICAgIC8vIEFkZCBvYmplY3RzIGF0IHRoaXMgbGV2ZWwKICAgICAgLy8gQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkocmVzdWx0LCBub2RlRGF0YSk7CiAgICAgIC8vIEFkZCBjaGlsZCBkYXRhCiAgICAgIC8vIEB0b2RvIHVud3JhcCByZWN1cnNpb24gaW50byBhIHF1ZXVlIC8gbG9vcCwgdGhhdCdzIGZhc3RlciBpbiBKUwoKICAgICAgdGhpcy5jaGlsZHJlbjsgLy8gZm9yIChsZXQgaSA9IDAsIE4gPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgIC8vICAgICBjaGlsZHJlbltpXS5hYWJiUXVlcnkoYWFiYiwgcmVzdWx0KTsKICAgICAgLy8gfQoKICAgICAgY29uc3QgcXVldWUgPSBbdGhpc107CgogICAgICB3aGlsZSAocXVldWUubGVuZ3RoKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHF1ZXVlLnBvcCgpOwoKICAgICAgICBpZiAobm9kZS5hYWJiLm92ZXJsYXBzKGFhYmIpKSB7CiAgICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShyZXN1bHQsIG5vZGUuZGF0YSk7CiAgICAgICAgfQoKICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShxdWV1ZSwgbm9kZS5jaGlsZHJlbik7CiAgICAgIH0KCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICAvKioKICAgICAqIEdldCBhbGwgZGF0YSwgcG90ZW50aWFsbHkgaW50ZXJzZWN0ZWQgYnkgYSByYXkuCiAgICAgKiBAcmV0dXJuIFRoZSAicmVzdWx0IiBvYmplY3QKICAgICAqLwoKCiAgICByYXlRdWVyeShyYXksIHRyZWVUcmFuc2Zvcm0sIHJlc3VsdCkgewogICAgICAvLyBVc2UgYWFiYiBxdWVyeSBmb3Igbm93LgoKICAgICAgLyoqIEB0b2RvIGltcGxlbWVudCByZWFsIHJheSBxdWVyeSB3aGljaCBuZWVkcyBsZXNzIGxvb2t1cHMgKi8KICAgICAgcmF5LmdldEFBQkIodG1wQUFCQik7CiAgICAgIHRtcEFBQkIudG9Mb2NhbEZyYW1lKHRyZWVUcmFuc2Zvcm0sIHRtcEFBQkIpOwogICAgICB0aGlzLmFhYmJRdWVyeSh0bXBBQUJCLCByZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgLyoqCiAgICAgKiByZW1vdmVFbXB0eU5vZGVzCiAgICAgKi8KCgogICAgcmVtb3ZlRW1wdHlOb2RlcygpIHsKICAgICAgZm9yIChsZXQgaSA9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB0aGlzLmNoaWxkcmVuW2ldLnJlbW92ZUVtcHR5Tm9kZXMoKTsKCiAgICAgICAgaWYgKCF0aGlzLmNoaWxkcmVuW2ldLmNoaWxkcmVuLmxlbmd0aCAmJiAhdGhpcy5jaGlsZHJlbltpXS5kYXRhLmxlbmd0aCkgewogICAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaSwgMSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogIH0KICAvKioKICAgKiBPY3RyZWUKICAgKi8KCgogIGNsYXNzIE9jdHJlZSBleHRlbmRzIE9jdHJlZU5vZGUgewogICAgLyoqCiAgICAgKiBNYXhpbXVtIHN1YmRpdmlzaW9uIGRlcHRoCiAgICAgKiBAZGVmYXVsdCA4CiAgICAgKi8KCiAgICAvKioKICAgICAqIEBwYXJhbSBhYWJiIFRoZSB0b3RhbCBBQUJCIG9mIHRoZSB0cmVlCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKGFhYmIsIG9wdGlvbnMpIHsKICAgICAgaWYgKG9wdGlvbnMgPT09IHZvaWQgMCkgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQoKICAgICAgc3VwZXIoewogICAgICAgIHJvb3Q6IG51bGwsCiAgICAgICAgYWFiYgogICAgICB9KTsKICAgICAgdGhpcy5tYXhEZXB0aCA9IHZvaWQgMDsKICAgICAgdGhpcy5tYXhEZXB0aCA9IHR5cGVvZiBvcHRpb25zLm1heERlcHRoICE9PSAndW5kZWZpbmVkJyA/IG9wdGlvbnMubWF4RGVwdGggOiA4OwogICAgfQoKICB9CgogIGNvbnN0IGhhbGZEaWFnb25hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdG1wQUFCQiA9IG5ldyBBQUJCKCk7CiAgLyoqCiAgICogVHJpbWVzaC4KICAgKiBAZXhhbXBsZQogICAqICAgICAvLyBIb3cgdG8gbWFrZSBhIG1lc2ggd2l0aCBhIHNpbmdsZSB0cmlhbmdsZQogICAqICAgICBjb25zdCB2ZXJ0aWNlcyA9IFsKICAgKiAgICAgICAgIDAsIDAsIDAsIC8vIHZlcnRleCAwCiAgICogICAgICAgICAxLCAwLCAwLCAvLyB2ZXJ0ZXggMQogICAqICAgICAgICAgMCwgMSwgMCAgLy8gdmVydGV4IDIKICAgKiAgICAgXQogICAqICAgICBjb25zdCBpbmRpY2VzID0gWwogICAqICAgICAgICAgMCwgMSwgMiAgLy8gdHJpYW5nbGUgMAogICAqICAgICBdCiAgICogICAgIGNvbnN0IHRyaW1lc2hTaGFwZSA9IG5ldyBDQU5OT04uVHJpbWVzaCh2ZXJ0aWNlcywgaW5kaWNlcykKICAgKi8KCiAgY2xhc3MgVHJpbWVzaCBleHRlbmRzIFNoYXBlIHsKICAgIC8qKgogICAgICogdmVydGljZXMKICAgICAqLwoKICAgIC8qKgogICAgICogQXJyYXkgb2YgaW50ZWdlcnMsIGluZGljYXRpbmcgd2hpY2ggdmVydGljZXMgZWFjaCB0cmlhbmdsZSBjb25zaXN0cyBvZi4gVGhlIGxlbmd0aCBvZiB0aGlzIGFycmF5IGlzIHRodXMgMyB0aW1lcyB0aGUgbnVtYmVyIG9mIHRyaWFuZ2xlcy4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIG5vcm1hbHMgZGF0YS4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGxvY2FsIEFBQkIgb2YgdGhlIG1lc2guCiAgICAgKi8KCiAgICAvKioKICAgICAqIFJlZmVyZW5jZXMgdG8gdmVydGV4IHBhaXJzLCBtYWtpbmcgdXAgYWxsIHVuaXF1ZSBlZGdlcyBpbiB0aGUgdHJpbWVzaC4KICAgICAqLwoKICAgIC8qKgogICAgICogTG9jYWwgc2NhbGluZyBvZiB0aGUgbWVzaC4gVXNlIC5zZXRTY2FsZSgpIHRvIHNldCBpdC4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGluZGV4ZWQgdHJpYW5nbGVzLiBVc2UgLnVwZGF0ZVRyZWUoKSB0byB1cGRhdGUgaXQuCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKHZlcnRpY2VzLCBpbmRpY2VzKSB7CiAgICAgIHN1cGVyKHsKICAgICAgICB0eXBlOiBTaGFwZS50eXBlcy5UUklNRVNICiAgICAgIH0pOwogICAgICB0aGlzLnZlcnRpY2VzID0gdm9pZCAwOwogICAgICB0aGlzLmluZGljZXMgPSB2b2lkIDA7CiAgICAgIHRoaXMubm9ybWFscyA9IHZvaWQgMDsKICAgICAgdGhpcy5hYWJiID0gdm9pZCAwOwogICAgICB0aGlzLmVkZ2VzID0gdm9pZCAwOwogICAgICB0aGlzLnNjYWxlID0gdm9pZCAwOwogICAgICB0aGlzLnRyZWUgPSB2b2lkIDA7CiAgICAgIHRoaXMudmVydGljZXMgPSBuZXcgRmxvYXQzMkFycmF5KHZlcnRpY2VzKTsKICAgICAgdGhpcy5pbmRpY2VzID0gbmV3IEludDE2QXJyYXkoaW5kaWNlcyk7CiAgICAgIHRoaXMubm9ybWFscyA9IG5ldyBGbG9hdDMyQXJyYXkoaW5kaWNlcy5sZW5ndGgpOwogICAgICB0aGlzLmFhYmIgPSBuZXcgQUFCQigpOwogICAgICB0aGlzLmVkZ2VzID0gbnVsbDsKICAgICAgdGhpcy5zY2FsZSA9IG5ldyBWZWMzKDEsIDEsIDEpOwogICAgICB0aGlzLnRyZWUgPSBuZXcgT2N0cmVlKCk7CiAgICAgIHRoaXMudXBkYXRlRWRnZXMoKTsKICAgICAgdGhpcy51cGRhdGVOb3JtYWxzKCk7CiAgICAgIHRoaXMudXBkYXRlQUFCQigpOwogICAgICB0aGlzLnVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCk7CiAgICAgIHRoaXMudXBkYXRlVHJlZSgpOwogICAgfQogICAgLyoqCiAgICAgKiB1cGRhdGVUcmVlCiAgICAgKi8KCgogICAgdXBkYXRlVHJlZSgpIHsKICAgICAgY29uc3QgdHJlZSA9IHRoaXMudHJlZTsKICAgICAgdHJlZS5yZXNldCgpOwogICAgICB0cmVlLmFhYmIuY29weSh0aGlzLmFhYmIpOwogICAgICBjb25zdCBzY2FsZSA9IHRoaXMuc2NhbGU7IC8vIFRoZSBsb2NhbCBtZXNoIEFBQkIgaXMgc2NhbGVkLCBidXQgdGhlIG9jdHJlZSBBQUJCIHNob3VsZCBiZSB1bnNjYWxlZAoKICAgICAgdHJlZS5hYWJiLmxvd2VyQm91bmQueCAqPSAxIC8gc2NhbGUueDsKICAgICAgdHJlZS5hYWJiLmxvd2VyQm91bmQueSAqPSAxIC8gc2NhbGUueTsKICAgICAgdHJlZS5hYWJiLmxvd2VyQm91bmQueiAqPSAxIC8gc2NhbGUuejsKICAgICAgdHJlZS5hYWJiLnVwcGVyQm91bmQueCAqPSAxIC8gc2NhbGUueDsKICAgICAgdHJlZS5hYWJiLnVwcGVyQm91bmQueSAqPSAxIC8gc2NhbGUueTsKICAgICAgdHJlZS5hYWJiLnVwcGVyQm91bmQueiAqPSAxIC8gc2NhbGUuejsgLy8gSW5zZXJ0IGFsbCB0cmlhbmdsZXMKCiAgICAgIGNvbnN0IHRyaWFuZ2xlQUFCQiA9IG5ldyBBQUJCKCk7CiAgICAgIGNvbnN0IGEgPSBuZXcgVmVjMygpOwogICAgICBjb25zdCBiID0gbmV3IFZlYzMoKTsKICAgICAgY29uc3QgYyA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IHBvaW50cyA9IFthLCBiLCBjXTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pbmRpY2VzLmxlbmd0aCAvIDM7IGkrKykgewogICAgICAgIC8vdGhpcy5nZXRUcmlhbmdsZVZlcnRpY2VzKGksIGEsIGIsIGMpOwogICAgICAgIC8vIEdldCB1bnNjYWxlZCB0cmlhbmdsZSB2ZXJ0cwogICAgICAgIGNvbnN0IGkzID0gaSAqIDM7CgogICAgICAgIHRoaXMuX2dldFVuc2NhbGVkVmVydGV4KHRoaXMuaW5kaWNlc1tpM10sIGEpOwoKICAgICAgICB0aGlzLl9nZXRVbnNjYWxlZFZlcnRleCh0aGlzLmluZGljZXNbaTMgKyAxXSwgYik7CgogICAgICAgIHRoaXMuX2dldFVuc2NhbGVkVmVydGV4KHRoaXMuaW5kaWNlc1tpMyArIDJdLCBjKTsKCiAgICAgICAgdHJpYW5nbGVBQUJCLnNldEZyb21Qb2ludHMocG9pbnRzKTsKICAgICAgICB0cmVlLmluc2VydCh0cmlhbmdsZUFBQkIsIGkpOwogICAgICB9CgogICAgICB0cmVlLnJlbW92ZUVtcHR5Tm9kZXMoKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRyaWFuZ2xlcyBpbiBhIGxvY2FsIEFBQkIgZnJvbSB0aGUgdHJpbWVzaC4KICAgICAqIEBwYXJhbSByZXN1bHQgQW4gYXJyYXkgb2YgaW50ZWdlcnMsIHJlZmVyZW5jaW5nIHRoZSBxdWVyaWVkIHRyaWFuZ2xlcy4KICAgICAqLwoKCiAgICBnZXRUcmlhbmdsZXNJbkFBQkIoYWFiYiwgcmVzdWx0KSB7CiAgICAgIHVuc2NhbGVkQUFCQi5jb3B5KGFhYmIpOyAvLyBTY2FsZSBpdCB0byBsb2NhbAoKICAgICAgY29uc3Qgc2NhbGUgPSB0aGlzLnNjYWxlOwogICAgICBjb25zdCBpc3ggPSBzY2FsZS54OwogICAgICBjb25zdCBpc3kgPSBzY2FsZS55OwogICAgICBjb25zdCBpc3ogPSBzY2FsZS56OwogICAgICBjb25zdCBsID0gdW5zY2FsZWRBQUJCLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSB1bnNjYWxlZEFBQkIudXBwZXJCb3VuZDsKICAgICAgbC54IC89IGlzeDsKICAgICAgbC55IC89IGlzeTsKICAgICAgbC56IC89IGlzejsKICAgICAgdS54IC89IGlzeDsKICAgICAgdS55IC89IGlzeTsKICAgICAgdS56IC89IGlzejsKICAgICAgcmV0dXJuIHRoaXMudHJlZS5hYWJiUXVlcnkodW5zY2FsZWRBQUJCLCByZXN1bHQpOwogICAgfQogICAgLyoqCiAgICAgKiBzZXRTY2FsZQogICAgICovCgoKICAgIHNldFNjYWxlKHNjYWxlKSB7CiAgICAgIGNvbnN0IHdhc1VuaWZvcm0gPSB0aGlzLnNjYWxlLnggPT09IHRoaXMuc2NhbGUueSAmJiB0aGlzLnNjYWxlLnkgPT09IHRoaXMuc2NhbGUuejsKICAgICAgY29uc3QgaXNVbmlmb3JtID0gc2NhbGUueCA9PT0gc2NhbGUueSAmJiBzY2FsZS55ID09PSBzY2FsZS56OwoKICAgICAgaWYgKCEod2FzVW5pZm9ybSAmJiBpc1VuaWZvcm0pKSB7CiAgICAgICAgLy8gTm9uLXVuaWZvcm0gc2NhbGluZy4gTmVlZCB0byB1cGRhdGUgbm9ybWFscy4KICAgICAgICB0aGlzLnVwZGF0ZU5vcm1hbHMoKTsKICAgICAgfQoKICAgICAgdGhpcy5zY2FsZS5jb3B5KHNjYWxlKTsKICAgICAgdGhpcy51cGRhdGVBQUJCKCk7CiAgICAgIHRoaXMudXBkYXRlQm91bmRpbmdTcGhlcmVSYWRpdXMoKTsKICAgIH0KICAgIC8qKgogICAgICogQ29tcHV0ZSB0aGUgbm9ybWFscyBvZiB0aGUgZmFjZXMuIFdpbGwgc2F2ZSBpbiB0aGUgYC5ub3JtYWxzYCBhcnJheS4KICAgICAqLwoKCiAgICB1cGRhdGVOb3JtYWxzKCkgewogICAgICBjb25zdCBuID0gY29tcHV0ZU5vcm1hbHNfbjsgLy8gR2VuZXJhdGUgbm9ybWFscwoKICAgICAgY29uc3Qgbm9ybWFscyA9IHRoaXMubm9ybWFsczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pbmRpY2VzLmxlbmd0aCAvIDM7IGkrKykgewogICAgICAgIGNvbnN0IGkzID0gaSAqIDM7CiAgICAgICAgY29uc3QgYSA9IHRoaXMuaW5kaWNlc1tpM107CiAgICAgICAgY29uc3QgYiA9IHRoaXMuaW5kaWNlc1tpMyArIDFdOwogICAgICAgIGNvbnN0IGMgPSB0aGlzLmluZGljZXNbaTMgKyAyXTsKICAgICAgICB0aGlzLmdldFZlcnRleChhLCB2YSk7CiAgICAgICAgdGhpcy5nZXRWZXJ0ZXgoYiwgdmIpOwogICAgICAgIHRoaXMuZ2V0VmVydGV4KGMsIHZjKTsKICAgICAgICBUcmltZXNoLmNvbXB1dGVOb3JtYWwodmIsIHZhLCB2Yywgbik7CiAgICAgICAgbm9ybWFsc1tpM10gPSBuLng7CiAgICAgICAgbm9ybWFsc1tpMyArIDFdID0gbi55OwogICAgICAgIG5vcm1hbHNbaTMgKyAyXSA9IG4uejsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBVcGRhdGUgdGhlIGAuZWRnZXNgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlRWRnZXMoKSB7CiAgICAgIGNvbnN0IGVkZ2VzID0ge307CgogICAgICBjb25zdCBhZGQgPSAoYSwgYikgPT4gewogICAgICAgIGNvbnN0IGtleSA9IGEgPCBiID8gYSArICJfIiArIGIgOiBiICsgIl8iICsgYTsKICAgICAgICBlZGdlc1trZXldID0gdHJ1ZTsKICAgICAgfTsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5pbmRpY2VzLmxlbmd0aCAvIDM7IGkrKykgewogICAgICAgIGNvbnN0IGkzID0gaSAqIDM7CiAgICAgICAgY29uc3QgYSA9IHRoaXMuaW5kaWNlc1tpM107CiAgICAgICAgY29uc3QgYiA9IHRoaXMuaW5kaWNlc1tpMyArIDFdOwogICAgICAgIGNvbnN0IGMgPSB0aGlzLmluZGljZXNbaTMgKyAyXTsKICAgICAgICBhZGQoYSwgYik7CiAgICAgICAgYWRkKGIsIGMpOwogICAgICAgIGFkZChjLCBhKTsKICAgICAgfQoKICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGVkZ2VzKTsKICAgICAgdGhpcy5lZGdlcyA9IG5ldyBJbnQxNkFycmF5KGtleXMubGVuZ3RoICogMik7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpbmRpY2VzID0ga2V5c1tpXS5zcGxpdCgnXycpOwogICAgICAgIHRoaXMuZWRnZXNbMiAqIGldID0gcGFyc2VJbnQoaW5kaWNlc1swXSwgMTApOwogICAgICAgIHRoaXMuZWRnZXNbMiAqIGkgKyAxXSA9IHBhcnNlSW50KGluZGljZXNbMV0sIDEwKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYW4gZWRnZSB2ZXJ0ZXgKICAgICAqIEBwYXJhbSBmaXJzdE9yU2Vjb25kIDAgb3IgMSwgZGVwZW5kaW5nIG9uIHdoaWNoIG9uZSBvZiB0aGUgdmVydGljZXMgeW91IG5lZWQuCiAgICAgKiBAcGFyYW0gdmVydGV4U3RvcmUgV2hlcmUgdG8gc3RvcmUgdGhlIHJlc3VsdAogICAgICovCgoKICAgIGdldEVkZ2VWZXJ0ZXgoZWRnZUluZGV4LCBmaXJzdE9yU2Vjb25kLCB2ZXJ0ZXhTdG9yZSkgewogICAgICBjb25zdCB2ZXJ0ZXhJbmRleCA9IHRoaXMuZWRnZXNbZWRnZUluZGV4ICogMiArIChmaXJzdE9yU2Vjb25kID8gMSA6IDApXTsKICAgICAgdGhpcy5nZXRWZXJ0ZXgodmVydGV4SW5kZXgsIHZlcnRleFN0b3JlKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGEgdmVjdG9yIGFsb25nIGFuIGVkZ2UuCiAgICAgKi8KCgogICAgZ2V0RWRnZVZlY3RvcihlZGdlSW5kZXgsIHZlY3RvclN0b3JlKSB7CiAgICAgIGNvbnN0IHZhID0gZ2V0RWRnZVZlY3Rvcl92YTsKICAgICAgY29uc3QgdmIgPSBnZXRFZGdlVmVjdG9yX3ZiOwogICAgICB0aGlzLmdldEVkZ2VWZXJ0ZXgoZWRnZUluZGV4LCAwLCB2YSk7CiAgICAgIHRoaXMuZ2V0RWRnZVZlcnRleChlZGdlSW5kZXgsIDEsIHZiKTsKICAgICAgdmIudnN1Yih2YSwgdmVjdG9yU3RvcmUpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgZmFjZSBub3JtYWwgZ2l2ZW4gMyB2ZXJ0aWNlcwogICAgICovCgoKICAgIHN0YXRpYyBjb21wdXRlTm9ybWFsKHZhLCB2YiwgdmMsIHRhcmdldCkgewogICAgICB2Yi52c3ViKHZhLCBhYik7CiAgICAgIHZjLnZzdWIodmIsIGNiKTsKICAgICAgY2IuY3Jvc3MoYWIsIHRhcmdldCk7CgogICAgICBpZiAoIXRhcmdldC5pc1plcm8oKSkgewogICAgICAgIHRhcmdldC5ub3JtYWxpemUoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdmVydGV4IGkuCiAgICAgKiBAcmV0dXJuIFRoZSAib3V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgZ2V0VmVydGV4KGksIG91dCkgewogICAgICBjb25zdCBzY2FsZSA9IHRoaXMuc2NhbGU7CgogICAgICB0aGlzLl9nZXRVbnNjYWxlZFZlcnRleChpLCBvdXQpOwoKICAgICAgb3V0LnggKj0gc2NhbGUueDsKICAgICAgb3V0LnkgKj0gc2NhbGUueTsKICAgICAgb3V0LnogKj0gc2NhbGUuejsKICAgICAgcmV0dXJuIG91dDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHJhdyB2ZXJ0ZXggaQogICAgICogQHJldHVybiBUaGUgIm91dCIgdmVjdG9yIG9iamVjdAogICAgICovCgoKICAgIF9nZXRVbnNjYWxlZFZlcnRleChpLCBvdXQpIHsKICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgY29uc3QgdmVydGljZXMgPSB0aGlzLnZlcnRpY2VzOwogICAgICByZXR1cm4gb3V0LnNldCh2ZXJ0aWNlc1tpM10sIHZlcnRpY2VzW2kzICsgMV0sIHZlcnRpY2VzW2kzICsgMl0pOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYSB2ZXJ0ZXggZnJvbSB0aGUgdHJpbWVzaCx0cmFuc2Zvcm1lZCBieSB0aGUgZ2l2ZW4gcG9zaXRpb24gYW5kIHF1YXRlcm5pb24uCiAgICAgKiBAcmV0dXJuIFRoZSAib3V0IiB2ZWN0b3Igb2JqZWN0CiAgICAgKi8KCgogICAgZ2V0V29ybGRWZXJ0ZXgoaSwgcG9zLCBxdWF0LCBvdXQpIHsKICAgICAgdGhpcy5nZXRWZXJ0ZXgoaSwgb3V0KTsKICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHBvcywgcXVhdCwgb3V0LCBvdXQpOwogICAgICByZXR1cm4gb3V0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHRocmVlIHZlcnRpY2VzIGZvciB0cmlhbmdsZSBpLgogICAgICovCgoKICAgIGdldFRyaWFuZ2xlVmVydGljZXMoaSwgYSwgYiwgYykgewogICAgICBjb25zdCBpMyA9IGkgKiAzOwogICAgICB0aGlzLmdldFZlcnRleCh0aGlzLmluZGljZXNbaTNdLCBhKTsKICAgICAgdGhpcy5nZXRWZXJ0ZXgodGhpcy5pbmRpY2VzW2kzICsgMV0sIGIpOwogICAgICB0aGlzLmdldFZlcnRleCh0aGlzLmluZGljZXNbaTMgKyAyXSwgYyk7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGUgdGhlIG5vcm1hbCBvZiB0cmlhbmdsZSBpLgogICAgICogQHJldHVybiBUaGUgInRhcmdldCIgdmVjdG9yIG9iamVjdAogICAgICovCgoKICAgIGdldE5vcm1hbChpLCB0YXJnZXQpIHsKICAgICAgY29uc3QgaTMgPSBpICogMzsKICAgICAgcmV0dXJuIHRhcmdldC5zZXQodGhpcy5ub3JtYWxzW2kzXSwgdGhpcy5ub3JtYWxzW2kzICsgMV0sIHRoaXMubm9ybWFsc1tpMyArIDJdKTsKICAgIH0KICAgIC8qKgogICAgICogQHJldHVybiBUaGUgInRhcmdldCIgdmVjdG9yIG9iamVjdAogICAgICovCgoKICAgIGNhbGN1bGF0ZUxvY2FsSW5lcnRpYShtYXNzLCB0YXJnZXQpIHsKICAgICAgLy8gQXBwcm94aW1hdGUgd2l0aCBib3ggaW5lcnRpYQogICAgICAvLyBFeGFjdCBpbmVydGlhIGNhbGN1bGF0aW9uIGlzIG92ZXJraWxsLCBidXQgc2VlIGh0dHA6Ly9nZW9tZXRyaWN0b29scy5jb20vRG9jdW1lbnRhdGlvbi9Qb2x5aGVkcmFsTWFzc1Byb3BlcnRpZXMucGRmIGZvciB0aGUgY29ycmVjdCB3YXkgdG8gZG8gaXQKICAgICAgdGhpcy5jb21wdXRlTG9jYWxBQUJCKGNsaV9hYWJiKTsKICAgICAgY29uc3QgeCA9IGNsaV9hYWJiLnVwcGVyQm91bmQueCAtIGNsaV9hYWJiLmxvd2VyQm91bmQueDsKICAgICAgY29uc3QgeSA9IGNsaV9hYWJiLnVwcGVyQm91bmQueSAtIGNsaV9hYWJiLmxvd2VyQm91bmQueTsKICAgICAgY29uc3QgeiA9IGNsaV9hYWJiLnVwcGVyQm91bmQueiAtIGNsaV9hYWJiLmxvd2VyQm91bmQuejsKICAgICAgcmV0dXJuIHRhcmdldC5zZXQoMS4wIC8gMTIuMCAqIG1hc3MgKiAoMiAqIHkgKiAyICogeSArIDIgKiB6ICogMiAqIHopLCAxLjAgLyAxMi4wICogbWFzcyAqICgyICogeCAqIDIgKiB4ICsgMiAqIHogKiAyICogeiksIDEuMCAvIDEyLjAgKiBtYXNzICogKDIgKiB5ICogMiAqIHkgKyAyICogeCAqIDIgKiB4KSk7CiAgICB9CiAgICAvKioKICAgICAqIENvbXB1dGUgdGhlIGxvY2FsIEFBQkIgZm9yIHRoZSB0cmltZXNoCiAgICAgKi8KCgogICAgY29tcHV0ZUxvY2FsQUFCQihhYWJiKSB7CiAgICAgIGNvbnN0IGwgPSBhYWJiLmxvd2VyQm91bmQ7CiAgICAgIGNvbnN0IHUgPSBhYWJiLnVwcGVyQm91bmQ7CiAgICAgIGNvbnN0IG4gPSB0aGlzLnZlcnRpY2VzLmxlbmd0aDsKICAgICAgdGhpcy52ZXJ0aWNlczsKICAgICAgY29uc3QgdiA9IGNvbXB1dGVMb2NhbEFBQkJfd29ybGRWZXJ0OwogICAgICB0aGlzLmdldFZlcnRleCgwLCB2KTsKICAgICAgbC5jb3B5KHYpOwogICAgICB1LmNvcHkodik7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gbjsgaSsrKSB7CiAgICAgICAgdGhpcy5nZXRWZXJ0ZXgoaSwgdik7CgogICAgICAgIGlmICh2LnggPCBsLngpIHsKICAgICAgICAgIGwueCA9IHYueDsKICAgICAgICB9IGVsc2UgaWYgKHYueCA+IHUueCkgewogICAgICAgICAgdS54ID0gdi54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHYueSA8IGwueSkgewogICAgICAgICAgbC55ID0gdi55OwogICAgICAgIH0gZWxzZSBpZiAodi55ID4gdS55KSB7CiAgICAgICAgICB1LnkgPSB2Lnk7CiAgICAgICAgfQoKICAgICAgICBpZiAodi56IDwgbC56KSB7CiAgICAgICAgICBsLnogPSB2Lno7CiAgICAgICAgfSBlbHNlIGlmICh2LnogPiB1LnopIHsKICAgICAgICAgIHUueiA9IHYuejsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogVXBkYXRlIHRoZSBgLmFhYmJgIHByb3BlcnR5CiAgICAgKi8KCgogICAgdXBkYXRlQUFCQigpIHsKICAgICAgdGhpcy5jb21wdXRlTG9jYWxBQUJCKHRoaXMuYWFiYik7CiAgICB9CiAgICAvKioKICAgICAqIFdpbGwgdXBkYXRlIHRoZSBgLmJvdW5kaW5nU3BoZXJlUmFkaXVzYCBwcm9wZXJ0eQogICAgICovCgoKICAgIHVwZGF0ZUJvdW5kaW5nU3BoZXJlUmFkaXVzKCkgewogICAgICAvLyBBc3N1bWUgcG9pbnRzIGFyZSBkaXN0cmlidXRlZCB3aXRoIGxvY2FsICgwLDAsMCkgYXMgY2VudGVyCiAgICAgIGxldCBtYXgyID0gMDsKICAgICAgY29uc3QgdmVydGljZXMgPSB0aGlzLnZlcnRpY2VzOwogICAgICBjb25zdCB2ID0gbmV3IFZlYzMoKTsKCiAgICAgIGZvciAobGV0IGkgPSAwLCBOID0gdmVydGljZXMubGVuZ3RoIC8gMzsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgdGhpcy5nZXRWZXJ0ZXgoaSwgdik7CiAgICAgICAgY29uc3Qgbm9ybTIgPSB2Lmxlbmd0aFNxdWFyZWQoKTsKCiAgICAgICAgaWYgKG5vcm0yID4gbWF4MikgewogICAgICAgICAgbWF4MiA9IG5vcm0yOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5ib3VuZGluZ1NwaGVyZVJhZGl1cyA9IE1hdGguc3FydChtYXgyKTsKICAgIH0KICAgIC8qKgogICAgICogY2FsY3VsYXRlV29ybGRBQUJCCiAgICAgKi8KCgogICAgY2FsY3VsYXRlV29ybGRBQUJCKHBvcywgcXVhdCwgbWluLCBtYXgpIHsKICAgICAgLyoKICAgICAgICAgIGNvbnN0IG4gPSB0aGlzLnZlcnRpY2VzLmxlbmd0aCAvIDMsCiAgICAgICAgICAgICAgdmVydHMgPSB0aGlzLnZlcnRpY2VzOwogICAgICAgICAgY29uc3QgbWlueCxtaW55LG1pbnosbWF4eCxtYXh5LG1heHo7CiAgICAgICAgICAgY29uc3QgdiA9IHRlbXBXb3JsZFZlcnRleDsKICAgICAgICAgIGZvcihsZXQgaT0wOyBpPG47IGkrKyl7CiAgICAgICAgICAgICAgdGhpcy5nZXRWZXJ0ZXgoaSwgdik7CiAgICAgICAgICAgICAgcXVhdC52bXVsdCh2LCB2KTsKICAgICAgICAgICAgICBwb3MudmFkZCh2LCB2KTsKICAgICAgICAgICAgICBpZiAodi54IDwgbWlueCB8fCBtaW54PT09dW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgbWlueCA9IHYueDsKICAgICAgICAgICAgICB9IGVsc2UgaWYodi54ID4gbWF4eCB8fCBtYXh4PT09dW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgbWF4eCA9IHYueDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgIGlmICh2LnkgPCBtaW55IHx8IG1pbnk9PT11bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBtaW55ID0gdi55OwogICAgICAgICAgICAgIH0gZWxzZSBpZih2LnkgPiBtYXh5IHx8IG1heHk9PT11bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBtYXh5ID0gdi55OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgaWYgKHYueiA8IG1pbnogfHwgbWluej09PXVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIG1pbnogPSB2Lno7CiAgICAgICAgICAgICAgfSBlbHNlIGlmKHYueiA+IG1heHogfHwgbWF4ej09PXVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIG1heHogPSB2Lno7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbWluLnNldChtaW54LG1pbnksbWlueik7CiAgICAgICAgICBtYXguc2V0KG1heHgsbWF4eSxtYXh6KTsKICAgICAgICAgICovCiAgICAgIC8vIEZhc3RlciBhcHByb3hpbWF0aW9uIHVzaW5nIGxvY2FsIEFBQkIKICAgICAgY29uc3QgZnJhbWUgPSBjYWxjdWxhdGVXb3JsZEFBQkJfZnJhbWU7CiAgICAgIGNvbnN0IHJlc3VsdCA9IGNhbGN1bGF0ZVdvcmxkQUFCQl9hYWJiOwogICAgICBmcmFtZS5wb3NpdGlvbiA9IHBvczsKICAgICAgZnJhbWUucXVhdGVybmlvbiA9IHF1YXQ7CiAgICAgIHRoaXMuYWFiYi50b1dvcmxkRnJhbWUoZnJhbWUsIHJlc3VsdCk7CiAgICAgIG1pbi5jb3B5KHJlc3VsdC5sb3dlckJvdW5kKTsKICAgICAgbWF4LmNvcHkocmVzdWx0LnVwcGVyQm91bmQpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgYXBwcm94aW1hdGUgdm9sdW1lCiAgICAgKi8KCgogICAgdm9sdW1lKCkgewogICAgICByZXR1cm4gNC4wICogTWF0aC5QSSAqIHRoaXMuYm91bmRpbmdTcGhlcmVSYWRpdXMgLyAzLjA7CiAgICB9CiAgICAvKioKICAgICAqIENyZWF0ZSBhIFRyaW1lc2ggaW5zdGFuY2UsIHNoYXBlZCBhcyBhIHRvcnVzLgogICAgICovCgoKICAgIHN0YXRpYyBjcmVhdGVUb3J1cyhyYWRpdXMsIHR1YmUsIHJhZGlhbFNlZ21lbnRzLCB0dWJ1bGFyU2VnbWVudHMsIGFyYykgewogICAgICBpZiAocmFkaXVzID09PSB2b2lkIDApIHsKICAgICAgICByYWRpdXMgPSAxOwogICAgICB9CgogICAgICBpZiAodHViZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdHViZSA9IDAuNTsKICAgICAgfQoKICAgICAgaWYgKHJhZGlhbFNlZ21lbnRzID09PSB2b2lkIDApIHsKICAgICAgICByYWRpYWxTZWdtZW50cyA9IDg7CiAgICAgIH0KCiAgICAgIGlmICh0dWJ1bGFyU2VnbWVudHMgPT09IHZvaWQgMCkgewogICAgICAgIHR1YnVsYXJTZWdtZW50cyA9IDY7CiAgICAgIH0KCiAgICAgIGlmIChhcmMgPT09IHZvaWQgMCkgewogICAgICAgIGFyYyA9IE1hdGguUEkgKiAyOwogICAgICB9CgogICAgICBjb25zdCB2ZXJ0aWNlcyA9IFtdOwogICAgICBjb25zdCBpbmRpY2VzID0gW107CgogICAgICBmb3IgKGxldCBqID0gMDsgaiA8PSByYWRpYWxTZWdtZW50czsgaisrKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gdHVidWxhclNlZ21lbnRzOyBpKyspIHsKICAgICAgICAgIGNvbnN0IHUgPSBpIC8gdHVidWxhclNlZ21lbnRzICogYXJjOwogICAgICAgICAgY29uc3QgdiA9IGogLyByYWRpYWxTZWdtZW50cyAqIE1hdGguUEkgKiAyOwogICAgICAgICAgY29uc3QgeCA9IChyYWRpdXMgKyB0dWJlICogTWF0aC5jb3ModikpICogTWF0aC5jb3ModSk7CiAgICAgICAgICBjb25zdCB5ID0gKHJhZGl1cyArIHR1YmUgKiBNYXRoLmNvcyh2KSkgKiBNYXRoLnNpbih1KTsKICAgICAgICAgIGNvbnN0IHogPSB0dWJlICogTWF0aC5zaW4odik7CiAgICAgICAgICB2ZXJ0aWNlcy5wdXNoKHgsIHksIHopOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChsZXQgaiA9IDE7IGogPD0gcmFkaWFsU2VnbWVudHM7IGorKykgewogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IHR1YnVsYXJTZWdtZW50czsgaSsrKSB7CiAgICAgICAgICBjb25zdCBhID0gKHR1YnVsYXJTZWdtZW50cyArIDEpICogaiArIGkgLSAxOwogICAgICAgICAgY29uc3QgYiA9ICh0dWJ1bGFyU2VnbWVudHMgKyAxKSAqIChqIC0gMSkgKyBpIC0gMTsKICAgICAgICAgIGNvbnN0IGMgPSAodHVidWxhclNlZ21lbnRzICsgMSkgKiAoaiAtIDEpICsgaTsKICAgICAgICAgIGNvbnN0IGQgPSAodHVidWxhclNlZ21lbnRzICsgMSkgKiBqICsgaTsKICAgICAgICAgIGluZGljZXMucHVzaChhLCBiLCBkKTsKICAgICAgICAgIGluZGljZXMucHVzaChiLCBjLCBkKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBuZXcgVHJpbWVzaCh2ZXJ0aWNlcywgaW5kaWNlcyk7CiAgICB9CgogIH0KCiAgY29uc3QgY29tcHV0ZU5vcm1hbHNfbiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdW5zY2FsZWRBQUJCID0gbmV3IEFBQkIoKTsKICBjb25zdCBnZXRFZGdlVmVjdG9yX3ZhID0gbmV3IFZlYzMoKTsKICBjb25zdCBnZXRFZGdlVmVjdG9yX3ZiID0gbmV3IFZlYzMoKTsKICBjb25zdCBjYiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYWIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHZhID0gbmV3IFZlYzMoKTsKICBjb25zdCB2YiA9IG5ldyBWZWMzKCk7CiAgY29uc3QgdmMgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNsaV9hYWJiID0gbmV3IEFBQkIoKTsKICBjb25zdCBjb21wdXRlTG9jYWxBQUJCX3dvcmxkVmVydCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgY2FsY3VsYXRlV29ybGRBQUJCX2ZyYW1lID0gbmV3IFRyYW5zZm9ybSgpOwogIGNvbnN0IGNhbGN1bGF0ZVdvcmxkQUFCQl9hYWJiID0gbmV3IEFBQkIoKTsKICAvKioKICAgKiBDb25zdHJhaW50IGVxdWF0aW9uIHNvbHZlciBiYXNlIGNsYXNzLgogICAqLwoKICBjbGFzcyBTb2x2ZXIgewogICAgLyoqCiAgICAgKiBBbGwgZXF1YXRpb25zIHRvIGJlIHNvbHZlZAogICAgICovCgogICAgLyoqCiAgICAgKiBAdG9kbyByZW1vdmUgdXNlbGVzcyBjb25zdHJ1Y3RvcgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5lcXVhdGlvbnMgPSB2b2lkIDA7CiAgICAgIHRoaXMuZXF1YXRpb25zID0gW107CiAgICB9CiAgICAvKioKICAgICAqIFNob3VsZCBiZSBpbXBsZW1lbnRlZCBpbiBzdWJjbGFzc2VzIQogICAgICogQHRvZG8gdXNlIGFic3RyYWN0CiAgICAgKiBAcmV0dXJuIG51bWJlciBvZiBpdGVyYXRpb25zIHBlcmZvcm1lZAogICAgICovCgoKICAgIHNvbHZlKGR0LCB3b3JsZCkgewogICAgICByZXR1cm4gKC8vIFNob3VsZCByZXR1cm4gdGhlIG51bWJlciBvZiBpdGVyYXRpb25zIGRvbmUhCiAgICAgICAgMAogICAgICApOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYW4gZXF1YXRpb24KICAgICAqLwoKCiAgICBhZGRFcXVhdGlvbihlcSkgewogICAgICBpZiAoZXEuZW5hYmxlZCAmJiAhZXEuYmkuaXNUcmlnZ2VyICYmICFlcS5iai5pc1RyaWdnZXIpIHsKICAgICAgICB0aGlzLmVxdWF0aW9ucy5wdXNoKGVxKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmUgYW4gZXF1YXRpb24KICAgICAqLwoKCiAgICByZW1vdmVFcXVhdGlvbihlcSkgewogICAgICBjb25zdCBlcXMgPSB0aGlzLmVxdWF0aW9uczsKICAgICAgY29uc3QgaSA9IGVxcy5pbmRleE9mKGVxKTsKCiAgICAgIGlmIChpICE9PSAtMSkgewogICAgICAgIGVxcy5zcGxpY2UoaSwgMSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQWRkIGFsbCBlcXVhdGlvbnMKICAgICAqLwoKCiAgICByZW1vdmVBbGxFcXVhdGlvbnMoKSB7CiAgICAgIHRoaXMuZXF1YXRpb25zLmxlbmd0aCA9IDA7CiAgICB9CgogIH0KICAvKioKICAgKiBDb25zdHJhaW50IGVxdWF0aW9uIEdhdXNzLVNlaWRlbCBzb2x2ZXIuCiAgICogQHRvZG8gVGhlIHNwb29rIHBhcmFtZXRlcnMgc2hvdWxkIGJlIHNwZWNpZmllZCBmb3IgZWFjaCBjb25zdHJhaW50LCBub3QgZ2xvYmFsbHkuCiAgICogQHNlZSBodHRwczovL3d3dzguY3MudW11LnNlL2t1cnNlci81RFYwNTgvVlQwOS9sZWN0dXJlcy9zcG9va25vdGVzLnBkZgogICAqLwoKCiAgY2xhc3MgR1NTb2x2ZXIgZXh0ZW5kcyBTb2x2ZXIgewogICAgLyoqCiAgICAgKiBUaGUgbnVtYmVyIG9mIHNvbHZlciBpdGVyYXRpb25zIGRldGVybWluZXMgcXVhbGl0eSBvZiB0aGUgY29uc3RyYWludHMgaW4gdGhlIHdvcmxkLgogICAgICogVGhlIG1vcmUgaXRlcmF0aW9ucywgdGhlIG1vcmUgY29ycmVjdCBzaW11bGF0aW9uLiBNb3JlIGl0ZXJhdGlvbnMgbmVlZCBtb3JlIGNvbXB1dGF0aW9ucyB0aG91Z2guIElmIHlvdSBoYXZlIGEgbGFyZ2UgZ3Jhdml0eSBmb3JjZSBpbiB5b3VyIHdvcmxkLCB5b3Ugd2lsbCBuZWVkIG1vcmUgaXRlcmF0aW9ucy4KICAgICAqLwoKICAgIC8qKgogICAgICogV2hlbiB0b2xlcmFuY2UgaXMgcmVhY2hlZCwgdGhlIHN5c3RlbSBpcyBhc3N1bWVkIHRvIGJlIGNvbnZlcmdlZC4KICAgICAqLwoKICAgIC8qKgogICAgICogQHRvZG8gcmVtb3ZlIHVzZWxlc3MgY29uc3RydWN0b3IKICAgICAqLwogICAgY29uc3RydWN0b3IoKSB7CiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMuaXRlcmF0aW9ucyA9IHZvaWQgMDsKICAgICAgdGhpcy50b2xlcmFuY2UgPSB2b2lkIDA7CiAgICAgIHRoaXMuaXRlcmF0aW9ucyA9IDEwOwogICAgICB0aGlzLnRvbGVyYW5jZSA9IDFlLTc7CiAgICB9CiAgICAvKioKICAgICAqIFNvbHZlCiAgICAgKiBAcmV0dXJuIG51bWJlciBvZiBpdGVyYXRpb25zIHBlcmZvcm1lZAogICAgICovCgoKICAgIHNvbHZlKGR0LCB3b3JsZCkgewogICAgICBsZXQgaXRlciA9IDA7CiAgICAgIGNvbnN0IG1heEl0ZXIgPSB0aGlzLml0ZXJhdGlvbnM7CiAgICAgIGNvbnN0IHRvbFNxdWFyZWQgPSB0aGlzLnRvbGVyYW5jZSAqIHRoaXMudG9sZXJhbmNlOwogICAgICBjb25zdCBlcXVhdGlvbnMgPSB0aGlzLmVxdWF0aW9uczsKICAgICAgY29uc3QgTmVxID0gZXF1YXRpb25zLmxlbmd0aDsKICAgICAgY29uc3QgYm9kaWVzID0gd29ybGQuYm9kaWVzOwogICAgICBjb25zdCBOYm9kaWVzID0gYm9kaWVzLmxlbmd0aDsKICAgICAgY29uc3QgaCA9IGR0OwogICAgICBsZXQgQjsKICAgICAgbGV0IGludkM7CiAgICAgIGxldCBkZWx0YWxhbWJkYTsKICAgICAgbGV0IGRlbHRhbGFtYmRhVG90OwogICAgICBsZXQgR1dsYW1iZGE7CiAgICAgIGxldCBsYW1iZGFqOyAvLyBVcGRhdGUgc29sdmUgbWFzcwoKICAgICAgaWYgKE5lcSAhPT0gMCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBOYm9kaWVzOyBpKyspIHsKICAgICAgICAgIGJvZGllc1tpXS51cGRhdGVTb2x2ZU1hc3NQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICB9IC8vIFRoaW5ncyB0aGF0IGRvIG5vdCBjaGFuZ2UgZHVyaW5nIGl0ZXJhdGlvbiBjYW4gYmUgY29tcHV0ZWQgb25jZQoKCiAgICAgIGNvbnN0IGludkNzID0gR1NTb2x2ZXJfc29sdmVfaW52Q3M7CiAgICAgIGNvbnN0IEJzID0gR1NTb2x2ZXJfc29sdmVfQnM7CiAgICAgIGNvbnN0IGxhbWJkYSA9IEdTU29sdmVyX3NvbHZlX2xhbWJkYTsKICAgICAgaW52Q3MubGVuZ3RoID0gTmVxOwogICAgICBCcy5sZW5ndGggPSBOZXE7CiAgICAgIGxhbWJkYS5sZW5ndGggPSBOZXE7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmVxOyBpKyspIHsKICAgICAgICBjb25zdCBjID0gZXF1YXRpb25zW2ldOwogICAgICAgIGxhbWJkYVtpXSA9IDAuMDsKICAgICAgICBCc1tpXSA9IGMuY29tcHV0ZUIoaCk7CiAgICAgICAgaW52Q3NbaV0gPSAxLjAgLyBjLmNvbXB1dGVDKCk7CiAgICAgIH0KCiAgICAgIGlmIChOZXEgIT09IDApIHsKICAgICAgICAvLyBSZXNldCB2bGFtYmRhCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5ib2RpZXM7IGkrKykgewogICAgICAgICAgY29uc3QgYiA9IGJvZGllc1tpXTsKICAgICAgICAgIGNvbnN0IHZsYW1iZGEgPSBiLnZsYW1iZGE7CiAgICAgICAgICBjb25zdCB3bGFtYmRhID0gYi53bGFtYmRhOwogICAgICAgICAgdmxhbWJkYS5zZXQoMCwgMCwgMCk7CiAgICAgICAgICB3bGFtYmRhLnNldCgwLCAwLCAwKTsKICAgICAgICB9IC8vIEl0ZXJhdGUgb3ZlciBlcXVhdGlvbnMKCgogICAgICAgIGZvciAoaXRlciA9IDA7IGl0ZXIgIT09IG1heEl0ZXI7IGl0ZXIrKykgewogICAgICAgICAgLy8gQWNjdW11bGF0ZSB0aGUgdG90YWwgZXJyb3IgZm9yIGVhY2ggaXRlcmF0aW9uLgogICAgICAgICAgZGVsdGFsYW1iZGFUb3QgPSAwLjA7CgogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IE5lcTsgaisrKSB7CiAgICAgICAgICAgIGNvbnN0IGMgPSBlcXVhdGlvbnNbal07IC8vIENvbXB1dGUgaXRlcmF0aW9uCgogICAgICAgICAgICBCID0gQnNbal07CiAgICAgICAgICAgIGludkMgPSBpbnZDc1tqXTsKICAgICAgICAgICAgbGFtYmRhaiA9IGxhbWJkYVtqXTsKICAgICAgICAgICAgR1dsYW1iZGEgPSBjLmNvbXB1dGVHV2xhbWJkYSgpOwogICAgICAgICAgICBkZWx0YWxhbWJkYSA9IGludkMgKiAoQiAtIEdXbGFtYmRhIC0gYy5lcHMgKiBsYW1iZGFqKTsgLy8gQ2xhbXAgaWYgd2UgYXJlIG5vdCB3aXRoaW4gdGhlIG1pbi9tYXggaW50ZXJ2YWwKCiAgICAgICAgICAgIGlmIChsYW1iZGFqICsgZGVsdGFsYW1iZGEgPCBjLm1pbkZvcmNlKSB7CiAgICAgICAgICAgICAgZGVsdGFsYW1iZGEgPSBjLm1pbkZvcmNlIC0gbGFtYmRhajsKICAgICAgICAgICAgfSBlbHNlIGlmIChsYW1iZGFqICsgZGVsdGFsYW1iZGEgPiBjLm1heEZvcmNlKSB7CiAgICAgICAgICAgICAgZGVsdGFsYW1iZGEgPSBjLm1heEZvcmNlIC0gbGFtYmRhajsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGFtYmRhW2pdICs9IGRlbHRhbGFtYmRhOwogICAgICAgICAgICBkZWx0YWxhbWJkYVRvdCArPSBkZWx0YWxhbWJkYSA+IDAuMCA/IGRlbHRhbGFtYmRhIDogLWRlbHRhbGFtYmRhOyAvLyBhYnMoZGVsdGFsYW1iZGEpCgogICAgICAgICAgICBjLmFkZFRvV2xhbWJkYShkZWx0YWxhbWJkYSk7CiAgICAgICAgICB9IC8vIElmIHRoZSB0b3RhbCBlcnJvciBpcyBzbWFsbCBlbm91Z2ggLSBzdG9wIGl0ZXJhdGUKCgogICAgICAgICAgaWYgKGRlbHRhbGFtYmRhVG90ICogZGVsdGFsYW1iZGFUb3QgPCB0b2xTcXVhcmVkKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gLy8gQWRkIHJlc3VsdCB0byB2ZWxvY2l0eQoKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5ib2RpZXM7IGkrKykgewogICAgICAgICAgY29uc3QgYiA9IGJvZGllc1tpXTsKICAgICAgICAgIGNvbnN0IHYgPSBiLnZlbG9jaXR5OwogICAgICAgICAgY29uc3QgdyA9IGIuYW5ndWxhclZlbG9jaXR5OwogICAgICAgICAgYi52bGFtYmRhLnZtdWwoYi5saW5lYXJGYWN0b3IsIGIudmxhbWJkYSk7CiAgICAgICAgICB2LnZhZGQoYi52bGFtYmRhLCB2KTsKICAgICAgICAgIGIud2xhbWJkYS52bXVsKGIuYW5ndWxhckZhY3RvciwgYi53bGFtYmRhKTsKICAgICAgICAgIHcudmFkZChiLndsYW1iZGEsIHcpOwogICAgICAgIH0gLy8gU2V0IHRoZSBgLm11bHRpcGxpZXJgIHByb3BlcnR5IG9mIGVhY2ggZXF1YXRpb24KCgogICAgICAgIGxldCBsID0gZXF1YXRpb25zLmxlbmd0aDsKICAgICAgICBjb25zdCBpbnZEdCA9IDEgLyBoOwoKICAgICAgICB3aGlsZSAobC0tKSB7CiAgICAgICAgICBlcXVhdGlvbnNbbF0ubXVsdGlwbGllciA9IGxhbWJkYVtsXSAqIGludkR0OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGl0ZXI7CiAgICB9CgogIH0gLy8gSnVzdCB0ZW1wb3JhcnkgbnVtYmVyIGhvbGRlcnMgdGhhdCB3ZSB3YW50IHRvIHJldXNlIGVhY2ggaXRlcmF0aW9uLgoKCiAgY29uc3QgR1NTb2x2ZXJfc29sdmVfbGFtYmRhID0gW107CiAgY29uc3QgR1NTb2x2ZXJfc29sdmVfaW52Q3MgPSBbXTsKICBjb25zdCBHU1NvbHZlcl9zb2x2ZV9CcyA9IFtdOwogIC8qKgogICAqIFNwbGl0cyB0aGUgZXF1YXRpb25zIGludG8gaXNsYW5kcyBhbmQgc29sdmVzIHRoZW0gaW5kZXBlbmRlbnRseS4gQ2FuIGltcHJvdmUgcGVyZm9ybWFuY2UuCiAgICovCgogIGNsYXNzIFNwbGl0U29sdmVyIGV4dGVuZHMgU29sdmVyIHsKICAgIC8qKgogICAgICogVGhlIG51bWJlciBvZiBzb2x2ZXIgaXRlcmF0aW9ucyBkZXRlcm1pbmVzIHF1YWxpdHkgb2YgdGhlIGNvbnN0cmFpbnRzIGluIHRoZSB3b3JsZC4gVGhlIG1vcmUgaXRlcmF0aW9ucywgdGhlIG1vcmUgY29ycmVjdCBzaW11bGF0aW9uLiBNb3JlIGl0ZXJhdGlvbnMgbmVlZCBtb3JlIGNvbXB1dGF0aW9ucyB0aG91Z2guIElmIHlvdSBoYXZlIGEgbGFyZ2UgZ3Jhdml0eSBmb3JjZSBpbiB5b3VyIHdvcmxkLCB5b3Ugd2lsbCBuZWVkIG1vcmUgaXRlcmF0aW9ucy4KICAgICAqLwoKICAgIC8qKgogICAgICogV2hlbiB0b2xlcmFuY2UgaXMgcmVhY2hlZCwgdGhlIHN5c3RlbSBpcyBhc3N1bWVkIHRvIGJlIGNvbnZlcmdlZC4KICAgICAqLwoKICAgIC8qKiBzdWJzb2x2ZXIgKi8KICAgIGNvbnN0cnVjdG9yKHN1YnNvbHZlcikgewogICAgICBzdXBlcigpOwogICAgICB0aGlzLml0ZXJhdGlvbnMgPSB2b2lkIDA7CiAgICAgIHRoaXMudG9sZXJhbmNlID0gdm9pZCAwOwogICAgICB0aGlzLnN1YnNvbHZlciA9IHZvaWQgMDsKICAgICAgdGhpcy5ub2RlcyA9IHZvaWQgMDsKICAgICAgdGhpcy5ub2RlUG9vbCA9IHZvaWQgMDsKICAgICAgdGhpcy5pdGVyYXRpb25zID0gMTA7CiAgICAgIHRoaXMudG9sZXJhbmNlID0gMWUtNzsKICAgICAgdGhpcy5zdWJzb2x2ZXIgPSBzdWJzb2x2ZXI7CiAgICAgIHRoaXMubm9kZXMgPSBbXTsKICAgICAgdGhpcy5ub2RlUG9vbCA9IFtdOyAvLyBDcmVhdGUgbmVlZGVkIG5vZGVzLCByZXVzZSBpZiBwb3NzaWJsZQoKICAgICAgd2hpbGUgKHRoaXMubm9kZVBvb2wubGVuZ3RoIDwgMTI4KSB7CiAgICAgICAgdGhpcy5ub2RlUG9vbC5wdXNoKHRoaXMuY3JlYXRlTm9kZSgpKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBjcmVhdGVOb2RlCiAgICAgKi8KCgogICAgY3JlYXRlTm9kZSgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBib2R5OiBudWxsLAogICAgICAgIGNoaWxkcmVuOiBbXSwKICAgICAgICBlcXM6IFtdLAogICAgICAgIHZpc2l0ZWQ6IGZhbHNlCiAgICAgIH07CiAgICB9CiAgICAvKioKICAgICAqIFNvbHZlIHRoZSBzdWJzeXN0ZW1zCiAgICAgKiBAcmV0dXJuIG51bWJlciBvZiBpdGVyYXRpb25zIHBlcmZvcm1lZAogICAgICovCgoKICAgIHNvbHZlKGR0LCB3b3JsZCkgewogICAgICBjb25zdCBub2RlcyA9IFNwbGl0U29sdmVyX3NvbHZlX25vZGVzOwogICAgICBjb25zdCBub2RlUG9vbCA9IHRoaXMubm9kZVBvb2w7CiAgICAgIGNvbnN0IGJvZGllcyA9IHdvcmxkLmJvZGllczsKICAgICAgY29uc3QgZXF1YXRpb25zID0gdGhpcy5lcXVhdGlvbnM7CiAgICAgIGNvbnN0IE5lcSA9IGVxdWF0aW9ucy5sZW5ndGg7CiAgICAgIGNvbnN0IE5ib2RpZXMgPSBib2RpZXMubGVuZ3RoOwogICAgICBjb25zdCBzdWJzb2x2ZXIgPSB0aGlzLnN1YnNvbHZlcjsgLy8gQ3JlYXRlIG5lZWRlZCBub2RlcywgcmV1c2UgaWYgcG9zc2libGUKCiAgICAgIHdoaWxlIChub2RlUG9vbC5sZW5ndGggPCBOYm9kaWVzKSB7CiAgICAgICAgbm9kZVBvb2wucHVzaCh0aGlzLmNyZWF0ZU5vZGUoKSk7CiAgICAgIH0KCiAgICAgIG5vZGVzLmxlbmd0aCA9IE5ib2RpZXM7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE5ib2RpZXM7IGkrKykgewogICAgICAgIG5vZGVzW2ldID0gbm9kZVBvb2xbaV07CiAgICAgIH0gLy8gUmVzZXQgbm9kZSB2YWx1ZXMKCgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTmJvZGllczsgaSsrKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IG5vZGVzW2ldOwogICAgICAgIG5vZGUuYm9keSA9IGJvZGllc1tpXTsKICAgICAgICBub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICAgICAgbm9kZS5lcXMubGVuZ3RoID0gMDsKICAgICAgICBub2RlLnZpc2l0ZWQgPSBmYWxzZTsKICAgICAgfQoKICAgICAgZm9yIChsZXQgayA9IDA7IGsgIT09IE5lcTsgaysrKSB7CiAgICAgICAgY29uc3QgZXEgPSBlcXVhdGlvbnNba107CiAgICAgICAgY29uc3QgaSA9IGJvZGllcy5pbmRleE9mKGVxLmJpKTsKICAgICAgICBjb25zdCBqID0gYm9kaWVzLmluZGV4T2YoZXEuYmopOwogICAgICAgIGNvbnN0IG5pID0gbm9kZXNbaV07CiAgICAgICAgY29uc3QgbmogPSBub2Rlc1tqXTsKICAgICAgICBuaS5jaGlsZHJlbi5wdXNoKG5qKTsKICAgICAgICBuaS5lcXMucHVzaChlcSk7CiAgICAgICAgbmouY2hpbGRyZW4ucHVzaChuaSk7CiAgICAgICAgbmouZXFzLnB1c2goZXEpOwogICAgICB9CgogICAgICBsZXQgY2hpbGQ7CiAgICAgIGxldCBuID0gMDsKICAgICAgbGV0IGVxcyA9IFNwbGl0U29sdmVyX3NvbHZlX2VxczsKICAgICAgc3Vic29sdmVyLnRvbGVyYW5jZSA9IHRoaXMudG9sZXJhbmNlOwogICAgICBzdWJzb2x2ZXIuaXRlcmF0aW9ucyA9IHRoaXMuaXRlcmF0aW9uczsKICAgICAgY29uc3QgZHVtbXlXb3JsZCA9IFNwbGl0U29sdmVyX3NvbHZlX2R1bW15V29ybGQ7CgogICAgICB3aGlsZSAoY2hpbGQgPSBnZXRVbnZpc2l0ZWROb2RlKG5vZGVzKSkgewogICAgICAgIGVxcy5sZW5ndGggPSAwOwogICAgICAgIGR1bW15V29ybGQuYm9kaWVzLmxlbmd0aCA9IDA7CiAgICAgICAgYmZzKGNoaWxkLCB2aXNpdEZ1bmMsIGR1bW15V29ybGQuYm9kaWVzLCBlcXMpOwogICAgICAgIGNvbnN0IE5lcXMgPSBlcXMubGVuZ3RoOwogICAgICAgIGVxcyA9IGVxcy5zb3J0KHNvcnRCeUlkKTsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5lcXM7IGkrKykgewogICAgICAgICAgc3Vic29sdmVyLmFkZEVxdWF0aW9uKGVxc1tpXSk7CiAgICAgICAgfQoKICAgICAgICBzdWJzb2x2ZXIuc29sdmUoZHQsIGR1bW15V29ybGQpOwogICAgICAgIHN1YnNvbHZlci5yZW1vdmVBbGxFcXVhdGlvbnMoKTsKICAgICAgICBuKys7CiAgICAgIH0KCiAgICAgIHJldHVybiBuOwogICAgfQoKICB9IC8vIFJldHVybnMgdGhlIG51bWJlciBvZiBzdWJzeXN0ZW1zCgoKICBjb25zdCBTcGxpdFNvbHZlcl9zb2x2ZV9ub2RlcyA9IFtdOyAvLyBBbGwgYWxsb2NhdGVkIG5vZGUgb2JqZWN0cwoKICBjb25zdCBTcGxpdFNvbHZlcl9zb2x2ZV9lcXMgPSBbXTsgLy8gVGVtcCBhcnJheQoKICBjb25zdCBTcGxpdFNvbHZlcl9zb2x2ZV9kdW1teVdvcmxkID0gewogICAgYm9kaWVzOiBbXQogIH07IC8vIFRlbXAgb2JqZWN0CgogIGNvbnN0IFNUQVRJQyA9IEJvZHkuU1RBVElDOwoKICBmdW5jdGlvbiBnZXRVbnZpc2l0ZWROb2RlKG5vZGVzKSB7CiAgICBjb25zdCBObm9kZXMgPSBub2Rlcy5sZW5ndGg7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5ub2RlczsgaSsrKSB7CiAgICAgIGNvbnN0IG5vZGUgPSBub2Rlc1tpXTsKCiAgICAgIGlmICghbm9kZS52aXNpdGVkICYmICEobm9kZS5ib2R5LnR5cGUgJiBTVEFUSUMpKSB7CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBjb25zdCBxdWV1ZSA9IFtdOwoKICBmdW5jdGlvbiBiZnMocm9vdCwgdmlzaXRGdW5jLCBiZHMsIGVxcykgewogICAgcXVldWUucHVzaChyb290KTsKICAgIHJvb3QudmlzaXRlZCA9IHRydWU7CiAgICB2aXNpdEZ1bmMocm9vdCwgYmRzLCBlcXMpOwoKICAgIHdoaWxlIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgY29uc3Qgbm9kZSA9IHF1ZXVlLnBvcCgpOyAvLyBMb29wIG92ZXIgdW52aXNpdGVkIGNoaWxkIG5vZGVzCgogICAgICBsZXQgY2hpbGQ7CgogICAgICB3aGlsZSAoY2hpbGQgPSBnZXRVbnZpc2l0ZWROb2RlKG5vZGUuY2hpbGRyZW4pKSB7CiAgICAgICAgY2hpbGQudmlzaXRlZCA9IHRydWU7CiAgICAgICAgdmlzaXRGdW5jKGNoaWxkLCBiZHMsIGVxcyk7CiAgICAgICAgcXVldWUucHVzaChjaGlsZCk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHZpc2l0RnVuYyhub2RlLCBiZHMsIGVxcykgewogICAgYmRzLnB1c2gobm9kZS5ib2R5KTsKICAgIGNvbnN0IE5lcXMgPSBub2RlLmVxcy5sZW5ndGg7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5lcXM7IGkrKykgewogICAgICBjb25zdCBlcSA9IG5vZGUuZXFzW2ldOwoKICAgICAgaWYgKCFlcXMuaW5jbHVkZXMoZXEpKSB7CiAgICAgICAgZXFzLnB1c2goZXEpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzb3J0QnlJZChhLCBiKSB7CiAgICByZXR1cm4gYi5pZCAtIGEuaWQ7CiAgfQogIC8qKgogICAqIEZvciBwb29saW5nIG9iamVjdHMgdGhhdCBjYW4gYmUgcmV1c2VkLgogICAqLwoKCiAgY2xhc3MgUG9vbCB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5vYmplY3RzID0gW107CiAgICAgIHRoaXMudHlwZSA9IE9iamVjdDsKICAgIH0KICAgIC8qKgogICAgICogUmVsZWFzZSBhbiBvYmplY3QgYWZ0ZXIgdXNlCiAgICAgKi8KCgogICAgcmVsZWFzZSgpIHsKICAgICAgY29uc3QgTmFyZ3MgPSBhcmd1bWVudHMubGVuZ3RoOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE5hcmdzOyBpKyspIHsKICAgICAgICB0aGlzLm9iamVjdHMucHVzaChpIDwgMCB8fCBhcmd1bWVudHMubGVuZ3RoIDw9IGkgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbaV0pOwogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGFuIG9iamVjdAogICAgICovCgoKICAgIGdldCgpIHsKICAgICAgaWYgKHRoaXMub2JqZWN0cy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3RPYmplY3QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5vYmplY3RzLnBvcCgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIENvbnN0cnVjdCBhbiBvYmplY3QuIFNob3VsZCBiZSBpbXBsZW1lbnRlZCBpbiBlYWNoIHN1YmNsYXNzLgogICAgICovCgoKICAgIGNvbnN0cnVjdE9iamVjdCgpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdjb25zdHJ1Y3RPYmplY3QoKSBub3QgaW1wbGVtZW50ZWQgaW4gdGhpcyBQb29sIHN1YmNsYXNzIHlldCEnKTsKICAgIH0KICAgIC8qKgogICAgICogQHJldHVybiBTZWxmLCBmb3IgY2hhaW5pbmcKICAgICAqLwoKCiAgICByZXNpemUoc2l6ZSkgewogICAgICBjb25zdCBvYmplY3RzID0gdGhpcy5vYmplY3RzOwoKICAgICAgd2hpbGUgKG9iamVjdHMubGVuZ3RoID4gc2l6ZSkgewogICAgICAgIG9iamVjdHMucG9wKCk7CiAgICAgIH0KCiAgICAgIHdoaWxlIChvYmplY3RzLmxlbmd0aCA8IHNpemUpIHsKICAgICAgICBvYmplY3RzLnB1c2godGhpcy5jb25zdHJ1Y3RPYmplY3QoKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9CiAgLyoqCiAgICogVmVjM1Bvb2wKICAgKi8KCgogIGNsYXNzIFZlYzNQb29sIGV4dGVuZHMgUG9vbCB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgICAgdGhpcy50eXBlID0gVmVjMzsKICAgIH0KICAgIC8qKgogICAgICogQ29uc3RydWN0IGEgdmVjdG9yCiAgICAgKi8KCgogICAgY29uc3RydWN0T2JqZWN0KCkgewogICAgICByZXR1cm4gbmV3IFZlYzMoKTsKICAgIH0KCiAgfQoKICBsZXQgX0NPTExJU0lPTl9UWVBFUyRzcGhlLCBfQ09MTElTSU9OX1RZUEVTJHNwaGUyLCBfQ09MTElTSU9OX1RZUEVTJGJveEIsIF9DT0xMSVNJT05fVFlQRVMkc3BoZTMsIF9DT0xMSVNJT05fVFlQRVMkcGxhbiwgX0NPTExJU0lPTl9UWVBFUyRjb252LCBfQ09MTElTSU9OX1RZUEVTJHNwaGU0LCBfQ09MTElTSU9OX1RZUEVTJHBsYW4yLCBfQ09MTElTSU9OX1RZUEVTJGJveEMsIF9DT0xMSVNJT05fVFlQRVMkc3BoZTUsIF9DT0xMSVNJT05fVFlQRVMkYm94SCwgX0NPTExJU0lPTl9UWVBFUyRjb252MiwgX0NPTExJU0lPTl9UWVBFUyRzcGhlNiwgX0NPTExJU0lPTl9UWVBFUyRwbGFuMywgX0NPTExJU0lPTl9UWVBFUyRib3hQLCBfQ09MTElTSU9OX1RZUEVTJGNvbnYzLCBfQ09MTElTSU9OX1RZUEVTJGN5bGksIF9DT0xMSVNJT05fVFlQRVMkc3BoZTcsIF9DT0xMSVNJT05fVFlQRVMkcGxhbjQsIF9DT0xMSVNJT05fVFlQRVMkYm94QzIsIF9DT0xMSVNJT05fVFlQRVMkY29udjQsIF9DT0xMSVNJT05fVFlQRVMkaGVpZywgX0NPTExJU0lPTl9UWVBFUyRwYXJ0LCBfQ09MTElTSU9OX1RZUEVTJHNwaGU4LCBfQ09MTElTSU9OX1RZUEVTJHBsYW41OyAvLyBOYW1pbmcgcnVsZTogYmFzZWQgb2YgdGhlIG9yZGVyIGluIFNIQVBFX1RZUEVTLAogIC8vIHRoZSBmaXJzdCBwYXJ0IG9mIHRoZSBtZXRob2QgaXMgZm9ybWVkIGJ5IHRoZQogIC8vIHNoYXBlIHR5cGUgdGhhdCBjb21lcyBiZWZvcmUsIGluIHRoZSBzZWNvbmQgcGFydAogIC8vIHRoZXJlIGlzIHRoZSBzaGFwZSB0eXBlIHRoYXQgY29tZXMgYWZ0ZXIgaW4gdGhlIFNIQVBFX1RZUEVTIGxpc3QKCgogIGNvbnN0IENPTExJU0lPTl9UWVBFUyA9IHsKICAgIHNwaGVyZVNwaGVyZTogU2hhcGUudHlwZXMuU1BIRVJFLAogICAgc3BoZXJlUGxhbmU6IFNoYXBlLnR5cGVzLlNQSEVSRSB8IFNoYXBlLnR5cGVzLlBMQU5FLAogICAgYm94Qm94OiBTaGFwZS50eXBlcy5CT1ggfCBTaGFwZS50eXBlcy5CT1gsCiAgICBzcGhlcmVCb3g6IFNoYXBlLnR5cGVzLlNQSEVSRSB8IFNoYXBlLnR5cGVzLkJPWCwKICAgIHBsYW5lQm94OiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLkJPWCwKICAgIGNvbnZleENvbnZleDogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiwKICAgIHNwaGVyZUNvbnZleDogU2hhcGUudHlwZXMuU1BIRVJFIHwgU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiwKICAgIHBsYW5lQ29udmV4OiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBib3hDb252ZXg6IFNoYXBlLnR5cGVzLkJPWCB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBzcGhlcmVIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuU1BIRVJFIHwgU2hhcGUudHlwZXMuSEVJR0hURklFTEQsCiAgICBib3hIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuQk9YIHwgU2hhcGUudHlwZXMuSEVJR0hURklFTEQsCiAgICBjb252ZXhIZWlnaHRmaWVsZDogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiB8IFNoYXBlLnR5cGVzLkhFSUdIVEZJRUxELAogICAgc3BoZXJlUGFydGljbGU6IFNoYXBlLnR5cGVzLlBBUlRJQ0xFIHwgU2hhcGUudHlwZXMuU1BIRVJFLAogICAgcGxhbmVQYXJ0aWNsZTogU2hhcGUudHlwZXMuUExBTkUgfCBTaGFwZS50eXBlcy5QQVJUSUNMRSwKICAgIGJveFBhcnRpY2xlOiBTaGFwZS50eXBlcy5CT1ggfCBTaGFwZS50eXBlcy5QQVJUSUNMRSwKICAgIGNvbnZleFBhcnRpY2xlOiBTaGFwZS50eXBlcy5QQVJUSUNMRSB8IFNoYXBlLnR5cGVzLkNPTlZFWFBPTFlIRURST04sCiAgICBjeWxpbmRlckN5bGluZGVyOiBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHNwaGVyZUN5bGluZGVyOiBTaGFwZS50eXBlcy5TUEhFUkUgfCBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHBsYW5lQ3lsaW5kZXI6IFNoYXBlLnR5cGVzLlBMQU5FIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBib3hDeWxpbmRlcjogU2hhcGUudHlwZXMuQk9YIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBjb252ZXhDeWxpbmRlcjogU2hhcGUudHlwZXMuQ09OVkVYUE9MWUhFRFJPTiB8IFNoYXBlLnR5cGVzLkNZTElOREVSLAogICAgaGVpZ2h0ZmllbGRDeWxpbmRlcjogU2hhcGUudHlwZXMuSEVJR0hURklFTEQgfCBTaGFwZS50eXBlcy5DWUxJTkRFUiwKICAgIHBhcnRpY2xlQ3lsaW5kZXI6IFNoYXBlLnR5cGVzLlBBUlRJQ0xFIHwgU2hhcGUudHlwZXMuQ1lMSU5ERVIsCiAgICBzcGhlcmVUcmltZXNoOiBTaGFwZS50eXBlcy5TUEhFUkUgfCBTaGFwZS50eXBlcy5UUklNRVNILAogICAgcGxhbmVUcmltZXNoOiBTaGFwZS50eXBlcy5QTEFORSB8IFNoYXBlLnR5cGVzLlRSSU1FU0gKICB9OwogIF9DT0xMSVNJT05fVFlQRVMkc3BoZSA9IENPTExJU0lPTl9UWVBFUy5zcGhlcmVTcGhlcmU7CiAgX0NPTExJU0lPTl9UWVBFUyRzcGhlMiA9IENPTExJU0lPTl9UWVBFUy5zcGhlcmVQbGFuZTsKICBfQ09MTElTSU9OX1RZUEVTJGJveEIgPSBDT0xMSVNJT05fVFlQRVMuYm94Qm94OwogIF9DT0xMSVNJT05fVFlQRVMkc3BoZTMgPSBDT0xMSVNJT05fVFlQRVMuc3BoZXJlQm94OwogIF9DT0xMSVNJT05fVFlQRVMkcGxhbiA9IENPTExJU0lPTl9UWVBFUy5wbGFuZUJveDsKICBfQ09MTElTSU9OX1RZUEVTJGNvbnYgPSBDT0xMSVNJT05fVFlQRVMuY29udmV4Q29udmV4OwogIF9DT0xMSVNJT05fVFlQRVMkc3BoZTQgPSBDT0xMSVNJT05fVFlQRVMuc3BoZXJlQ29udmV4OwogIF9DT0xMSVNJT05fVFlQRVMkcGxhbjIgPSBDT0xMSVNJT05fVFlQRVMucGxhbmVDb252ZXg7CiAgX0NPTExJU0lPTl9UWVBFUyRib3hDID0gQ09MTElTSU9OX1RZUEVTLmJveENvbnZleDsKICBfQ09MTElTSU9OX1RZUEVTJHNwaGU1ID0gQ09MTElTSU9OX1RZUEVTLnNwaGVyZUhlaWdodGZpZWxkOwogIF9DT0xMSVNJT05fVFlQRVMkYm94SCA9IENPTExJU0lPTl9UWVBFUy5ib3hIZWlnaHRmaWVsZDsKICBfQ09MTElTSU9OX1RZUEVTJGNvbnYyID0gQ09MTElTSU9OX1RZUEVTLmNvbnZleEhlaWdodGZpZWxkOwogIF9DT0xMSVNJT05fVFlQRVMkc3BoZTYgPSBDT0xMSVNJT05fVFlQRVMuc3BoZXJlUGFydGljbGU7CiAgX0NPTExJU0lPTl9UWVBFUyRwbGFuMyA9IENPTExJU0lPTl9UWVBFUy5wbGFuZVBhcnRpY2xlOwogIF9DT0xMSVNJT05fVFlQRVMkYm94UCA9IENPTExJU0lPTl9UWVBFUy5ib3hQYXJ0aWNsZTsKICBfQ09MTElTSU9OX1RZUEVTJGNvbnYzID0gQ09MTElTSU9OX1RZUEVTLmNvbnZleFBhcnRpY2xlOwogIF9DT0xMSVNJT05fVFlQRVMkY3lsaSA9IENPTExJU0lPTl9UWVBFUy5jeWxpbmRlckN5bGluZGVyOwogIF9DT0xMSVNJT05fVFlQRVMkc3BoZTcgPSBDT0xMSVNJT05fVFlQRVMuc3BoZXJlQ3lsaW5kZXI7CiAgX0NPTExJU0lPTl9UWVBFUyRwbGFuNCA9IENPTExJU0lPTl9UWVBFUy5wbGFuZUN5bGluZGVyOwogIF9DT0xMSVNJT05fVFlQRVMkYm94QzIgPSBDT0xMSVNJT05fVFlQRVMuYm94Q3lsaW5kZXI7CiAgX0NPTExJU0lPTl9UWVBFUyRjb252NCA9IENPTExJU0lPTl9UWVBFUy5jb252ZXhDeWxpbmRlcjsKICBfQ09MTElTSU9OX1RZUEVTJGhlaWcgPSBDT0xMSVNJT05fVFlQRVMuaGVpZ2h0ZmllbGRDeWxpbmRlcjsKICBfQ09MTElTSU9OX1RZUEVTJHBhcnQgPSBDT0xMSVNJT05fVFlQRVMucGFydGljbGVDeWxpbmRlcjsKICBfQ09MTElTSU9OX1RZUEVTJHNwaGU4ID0gQ09MTElTSU9OX1RZUEVTLnNwaGVyZVRyaW1lc2g7CiAgX0NPTExJU0lPTl9UWVBFUyRwbGFuNSA9IENPTExJU0lPTl9UWVBFUy5wbGFuZVRyaW1lc2g7CiAgLyoqCiAgICogSGVscGVyIGNsYXNzIGZvciB0aGUgV29ybGQuIEdlbmVyYXRlcyBDb250YWN0RXF1YXRpb25zLgogICAqIEB0b2RvIFNwaGVyZS1Db252ZXhQb2x5aGVkcm9uIGNvbnRhY3RzCiAgICogQHRvZG8gQ29udGFjdCByZWR1Y3Rpb24KICAgKiBAdG9kbyBzaG91bGQgbW92ZSBtZXRob2RzIHRvIHByb3RvdHlwZQogICAqLwoKICBjbGFzcyBOYXJyb3dwaGFzZSB7CiAgICAvKioKICAgICAqIEludGVybmFsIHN0b3JhZ2Ugb2YgcG9vbGVkIGNvbnRhY3QgcG9pbnRzLgogICAgICovCgogICAgLyoqCiAgICAgKiBQb29sZWQgdmVjdG9ycy4KICAgICAqLwogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJHNwaGVdKCkgewogICAgICByZXR1cm4gdGhpcy5zcGhlcmVTcGhlcmU7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJHNwaGUyXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlUGxhbmU7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJGJveEJdKCkgewogICAgICByZXR1cm4gdGhpcy5ib3hCb3g7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJHNwaGUzXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlQm94OwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRwbGFuXSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGxhbmVCb3g7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJGNvbnZdKCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhDb252ZXg7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJHNwaGU0XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlQ29udmV4OwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRwbGFuMl0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lQ29udmV4OwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRib3hDXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm94Q29udmV4OwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRzcGhlNV0oKSB7CiAgICAgIHJldHVybiB0aGlzLnNwaGVyZUhlaWdodGZpZWxkOwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRib3hIXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm94SGVpZ2h0ZmllbGQ7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJGNvbnYyXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4SGVpZ2h0ZmllbGQ7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJHNwaGU2XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlUGFydGljbGU7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJHBsYW4zXSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGxhbmVQYXJ0aWNsZTsKICAgIH0KCiAgICBnZXQgW19DT0xMSVNJT05fVFlQRVMkYm94UF0oKSB7CiAgICAgIHJldHVybiB0aGlzLmJveFBhcnRpY2xlOwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRjb252M10oKSB7CiAgICAgIHJldHVybiB0aGlzLmNvbnZleFBhcnRpY2xlOwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRjeWxpXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4Q29udmV4OwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRzcGhlN10oKSB7CiAgICAgIHJldHVybiB0aGlzLnNwaGVyZUNvbnZleDsKICAgIH0KCiAgICBnZXQgW19DT0xMSVNJT05fVFlQRVMkcGxhbjRdKCkgewogICAgICByZXR1cm4gdGhpcy5wbGFuZUNvbnZleDsKICAgIH0KCiAgICBnZXQgW19DT0xMSVNJT05fVFlQRVMkYm94QzJdKCkgewogICAgICByZXR1cm4gdGhpcy5ib3hDb252ZXg7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJGNvbnY0XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4Q29udmV4OwogICAgfQoKICAgIGdldCBbX0NPTExJU0lPTl9UWVBFUyRoZWlnXSgpIHsKICAgICAgcmV0dXJuIHRoaXMuaGVpZ2h0ZmllbGRDeWxpbmRlcjsKICAgIH0KCiAgICBnZXQgW19DT0xMSVNJT05fVFlQRVMkcGFydF0oKSB7CiAgICAgIHJldHVybiB0aGlzLnBhcnRpY2xlQ3lsaW5kZXI7CiAgICB9CgogICAgZ2V0IFtfQ09MTElTSU9OX1RZUEVTJHNwaGU4XSgpIHsKICAgICAgcmV0dXJuIHRoaXMuc3BoZXJlVHJpbWVzaDsKICAgIH0KCiAgICBnZXQgW19DT0xMSVNJT05fVFlQRVMkcGxhbjVdKCkgewogICAgICByZXR1cm4gdGhpcy5wbGFuZVRyaW1lc2g7CiAgICB9IC8vIGdldCBbQ09MTElTSU9OX1RZUEVTLmNvbnZleFRyaW1lc2hdKCkgewogICAgLy8gICByZXR1cm4gdGhpcy5jb252ZXhUcmltZXNoCiAgICAvLyB9CgoKICAgIGNvbnN0cnVjdG9yKHdvcmxkKSB7CiAgICAgIHRoaXMuY29udGFjdFBvaW50UG9vbCA9IHZvaWQgMDsKICAgICAgdGhpcy5mcmljdGlvbkVxdWF0aW9uUG9vbCA9IHZvaWQgMDsKICAgICAgdGhpcy5yZXN1bHQgPSB2b2lkIDA7CiAgICAgIHRoaXMuZnJpY3Rpb25SZXN1bHQgPSB2b2lkIDA7CiAgICAgIHRoaXMudjNwb29sID0gdm9pZCAwOwogICAgICB0aGlzLndvcmxkID0gdm9pZCAwOwogICAgICB0aGlzLmN1cnJlbnRDb250YWN0TWF0ZXJpYWwgPSB2b2lkIDA7CiAgICAgIHRoaXMuZW5hYmxlRnJpY3Rpb25SZWR1Y3Rpb24gPSB2b2lkIDA7CiAgICAgIHRoaXMuY29udGFjdFBvaW50UG9vbCA9IFtdOwogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25Qb29sID0gW107CiAgICAgIHRoaXMucmVzdWx0ID0gW107CiAgICAgIHRoaXMuZnJpY3Rpb25SZXN1bHQgPSBbXTsKICAgICAgdGhpcy52M3Bvb2wgPSBuZXcgVmVjM1Bvb2woKTsKICAgICAgdGhpcy53b3JsZCA9IHdvcmxkOwogICAgICB0aGlzLmN1cnJlbnRDb250YWN0TWF0ZXJpYWwgPSB3b3JsZC5kZWZhdWx0Q29udGFjdE1hdGVyaWFsOwogICAgICB0aGlzLmVuYWJsZUZyaWN0aW9uUmVkdWN0aW9uID0gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIE1ha2UgYSBjb250YWN0IG9iamVjdCwgYnkgdXNpbmcgdGhlIGludGVybmFsIHBvb2wgb3IgY3JlYXRpbmcgYSBuZXcgb25lLgogICAgICovCgoKICAgIGNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgb3ZlcnJpZGVTaGFwZUEsIG92ZXJyaWRlU2hhcGVCKSB7CiAgICAgIGxldCBjOwoKICAgICAgaWYgKHRoaXMuY29udGFjdFBvaW50UG9vbC5sZW5ndGgpIHsKICAgICAgICBjID0gdGhpcy5jb250YWN0UG9pbnRQb29sLnBvcCgpOwogICAgICAgIGMuYmkgPSBiaTsKICAgICAgICBjLmJqID0gYmo7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYyA9IG5ldyBDb250YWN0RXF1YXRpb24oYmksIGJqKTsKICAgICAgfQoKICAgICAgYy5lbmFibGVkID0gYmkuY29sbGlzaW9uUmVzcG9uc2UgJiYgYmouY29sbGlzaW9uUmVzcG9uc2UgJiYgc2kuY29sbGlzaW9uUmVzcG9uc2UgJiYgc2ouY29sbGlzaW9uUmVzcG9uc2U7CiAgICAgIGNvbnN0IGNtID0gdGhpcy5jdXJyZW50Q29udGFjdE1hdGVyaWFsOwogICAgICBjLnJlc3RpdHV0aW9uID0gY20ucmVzdGl0dXRpb247CiAgICAgIGMuc2V0U3Bvb2tQYXJhbXMoY20uY29udGFjdEVxdWF0aW9uU3RpZmZuZXNzLCBjbS5jb250YWN0RXF1YXRpb25SZWxheGF0aW9uLCB0aGlzLndvcmxkLmR0KTsKICAgICAgY29uc3QgbWF0QSA9IHNpLm1hdGVyaWFsIHx8IGJpLm1hdGVyaWFsOwogICAgICBjb25zdCBtYXRCID0gc2oubWF0ZXJpYWwgfHwgYmoubWF0ZXJpYWw7CgogICAgICBpZiAobWF0QSAmJiBtYXRCICYmIG1hdEEucmVzdGl0dXRpb24gPj0gMCAmJiBtYXRCLnJlc3RpdHV0aW9uID49IDApIHsKICAgICAgICBjLnJlc3RpdHV0aW9uID0gbWF0QS5yZXN0aXR1dGlvbiAqIG1hdEIucmVzdGl0dXRpb247CiAgICAgIH0KCiAgICAgIGMuc2kgPSBvdmVycmlkZVNoYXBlQSB8fCBzaTsKICAgICAgYy5zaiA9IG92ZXJyaWRlU2hhcGVCIHx8IHNqOwogICAgICByZXR1cm4gYzsKICAgIH0KCiAgICBjcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KGNvbnRhY3RFcXVhdGlvbiwgb3V0QXJyYXkpIHsKICAgICAgY29uc3QgYm9keUEgPSBjb250YWN0RXF1YXRpb24uYmk7CiAgICAgIGNvbnN0IGJvZHlCID0gY29udGFjdEVxdWF0aW9uLmJqOwogICAgICBjb25zdCBzaGFwZUEgPSBjb250YWN0RXF1YXRpb24uc2k7CiAgICAgIGNvbnN0IHNoYXBlQiA9IGNvbnRhY3RFcXVhdGlvbi5zajsKICAgICAgY29uc3Qgd29ybGQgPSB0aGlzLndvcmxkOwogICAgICBjb25zdCBjbSA9IHRoaXMuY3VycmVudENvbnRhY3RNYXRlcmlhbDsgLy8gSWYgZnJpY3Rpb24gb3IgcmVzdGl0dXRpb24gd2VyZSBzcGVjaWZpZWQgaW4gdGhlIG1hdGVyaWFsLCB1c2UgdGhlbQoKICAgICAgbGV0IGZyaWN0aW9uID0gY20uZnJpY3Rpb247CiAgICAgIGNvbnN0IG1hdEEgPSBzaGFwZUEubWF0ZXJpYWwgfHwgYm9keUEubWF0ZXJpYWw7CiAgICAgIGNvbnN0IG1hdEIgPSBzaGFwZUIubWF0ZXJpYWwgfHwgYm9keUIubWF0ZXJpYWw7CgogICAgICBpZiAobWF0QSAmJiBtYXRCICYmIG1hdEEuZnJpY3Rpb24gPj0gMCAmJiBtYXRCLmZyaWN0aW9uID49IDApIHsKICAgICAgICBmcmljdGlvbiA9IG1hdEEuZnJpY3Rpb24gKiBtYXRCLmZyaWN0aW9uOwogICAgICB9CgogICAgICBpZiAoZnJpY3Rpb24gPiAwKSB7CiAgICAgICAgLy8gQ3JlYXRlIDIgdGFuZ2VudCBlcXVhdGlvbnMKICAgICAgICBjb25zdCBtdWcgPSBmcmljdGlvbiAqIHdvcmxkLmdyYXZpdHkubGVuZ3RoKCk7CiAgICAgICAgbGV0IHJlZHVjZWRNYXNzID0gYm9keUEuaW52TWFzcyArIGJvZHlCLmludk1hc3M7CgogICAgICAgIGlmIChyZWR1Y2VkTWFzcyA+IDApIHsKICAgICAgICAgIHJlZHVjZWRNYXNzID0gMSAvIHJlZHVjZWRNYXNzOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgcG9vbCA9IHRoaXMuZnJpY3Rpb25FcXVhdGlvblBvb2w7CiAgICAgICAgY29uc3QgYzEgPSBwb29sLmxlbmd0aCA/IHBvb2wucG9wKCkgOiBuZXcgRnJpY3Rpb25FcXVhdGlvbihib2R5QSwgYm9keUIsIG11ZyAqIHJlZHVjZWRNYXNzKTsKICAgICAgICBjb25zdCBjMiA9IHBvb2wubGVuZ3RoID8gcG9vbC5wb3AoKSA6IG5ldyBGcmljdGlvbkVxdWF0aW9uKGJvZHlBLCBib2R5QiwgbXVnICogcmVkdWNlZE1hc3MpOwogICAgICAgIGMxLmJpID0gYzIuYmkgPSBib2R5QTsKICAgICAgICBjMS5iaiA9IGMyLmJqID0gYm9keUI7CiAgICAgICAgYzEubWluRm9yY2UgPSBjMi5taW5Gb3JjZSA9IC1tdWcgKiByZWR1Y2VkTWFzczsKICAgICAgICBjMS5tYXhGb3JjZSA9IGMyLm1heEZvcmNlID0gbXVnICogcmVkdWNlZE1hc3M7IC8vIENvcHkgb3ZlciB0aGUgcmVsYXRpdmUgdmVjdG9ycwoKICAgICAgICBjMS5yaS5jb3B5KGNvbnRhY3RFcXVhdGlvbi5yaSk7CiAgICAgICAgYzEucmouY29weShjb250YWN0RXF1YXRpb24ucmopOwogICAgICAgIGMyLnJpLmNvcHkoY29udGFjdEVxdWF0aW9uLnJpKTsKICAgICAgICBjMi5yai5jb3B5KGNvbnRhY3RFcXVhdGlvbi5yaik7IC8vIENvbnN0cnVjdCB0YW5nZW50cwoKICAgICAgICBjb250YWN0RXF1YXRpb24ubmkudGFuZ2VudHMoYzEudCwgYzIudCk7IC8vIFNldCBzcG9vayBwYXJhbXMKCiAgICAgICAgYzEuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIHdvcmxkLmR0KTsKICAgICAgICBjMi5zZXRTcG9va1BhcmFtcyhjbS5mcmljdGlvbkVxdWF0aW9uU3RpZmZuZXNzLCBjbS5mcmljdGlvbkVxdWF0aW9uUmVsYXhhdGlvbiwgd29ybGQuZHQpOwogICAgICAgIGMxLmVuYWJsZWQgPSBjMi5lbmFibGVkID0gY29udGFjdEVxdWF0aW9uLmVuYWJsZWQ7CiAgICAgICAgb3V0QXJyYXkucHVzaChjMSwgYzIpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICAvKioKICAgICAqIFRha2UgdGhlIGF2ZXJhZ2UgTiBsYXRlc3QgY29udGFjdCBwb2ludCBvbiB0aGUgcGxhbmUuCiAgICAgKi8KCgogICAgY3JlYXRlRnJpY3Rpb25Gcm9tQXZlcmFnZShudW1Db250YWN0cykgewogICAgICAvLyBUaGUgbGFzdCBjb250YWN0RXF1YXRpb24KICAgICAgbGV0IGMgPSB0aGlzLnJlc3VsdFt0aGlzLnJlc3VsdC5sZW5ndGggLSAxXTsgLy8gQ3JlYXRlIHRoZSByZXN1bHQ6IHR3byAiYXZlcmFnZSIgZnJpY3Rpb24gZXF1YXRpb25zCgogICAgICBpZiAoIXRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChjLCB0aGlzLmZyaWN0aW9uUmVzdWx0KSB8fCBudW1Db250YWN0cyA9PT0gMSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc3QgZjEgPSB0aGlzLmZyaWN0aW9uUmVzdWx0W3RoaXMuZnJpY3Rpb25SZXN1bHQubGVuZ3RoIC0gMl07CiAgICAgIGNvbnN0IGYyID0gdGhpcy5mcmljdGlvblJlc3VsdFt0aGlzLmZyaWN0aW9uUmVzdWx0Lmxlbmd0aCAtIDFdOwogICAgICBhdmVyYWdlTm9ybWFsLnNldFplcm8oKTsKICAgICAgYXZlcmFnZUNvbnRhY3RQb2ludEEuc2V0WmVybygpOwogICAgICBhdmVyYWdlQ29udGFjdFBvaW50Qi5zZXRaZXJvKCk7CiAgICAgIGNvbnN0IGJvZHlBID0gYy5iaTsKICAgICAgYy5iajsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpICE9PSBudW1Db250YWN0czsgaSsrKSB7CiAgICAgICAgYyA9IHRoaXMucmVzdWx0W3RoaXMucmVzdWx0Lmxlbmd0aCAtIDEgLSBpXTsKCiAgICAgICAgaWYgKGMuYmkgIT09IGJvZHlBKSB7CiAgICAgICAgICBhdmVyYWdlTm9ybWFsLnZhZGQoYy5uaSwgYXZlcmFnZU5vcm1hbCk7CiAgICAgICAgICBhdmVyYWdlQ29udGFjdFBvaW50QS52YWRkKGMucmksIGF2ZXJhZ2VDb250YWN0UG9pbnRBKTsKICAgICAgICAgIGF2ZXJhZ2VDb250YWN0UG9pbnRCLnZhZGQoYy5yaiwgYXZlcmFnZUNvbnRhY3RQb2ludEIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhdmVyYWdlTm9ybWFsLnZzdWIoYy5uaSwgYXZlcmFnZU5vcm1hbCk7CiAgICAgICAgICBhdmVyYWdlQ29udGFjdFBvaW50QS52YWRkKGMucmosIGF2ZXJhZ2VDb250YWN0UG9pbnRBKTsKICAgICAgICAgIGF2ZXJhZ2VDb250YWN0UG9pbnRCLnZhZGQoYy5yaSwgYXZlcmFnZUNvbnRhY3RQb2ludEIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgY29uc3QgaW52TnVtQ29udGFjdHMgPSAxIC8gbnVtQ29udGFjdHM7CiAgICAgIGF2ZXJhZ2VDb250YWN0UG9pbnRBLnNjYWxlKGludk51bUNvbnRhY3RzLCBmMS5yaSk7CiAgICAgIGF2ZXJhZ2VDb250YWN0UG9pbnRCLnNjYWxlKGludk51bUNvbnRhY3RzLCBmMS5yaik7CiAgICAgIGYyLnJpLmNvcHkoZjEucmkpOyAvLyBTaG91bGQgYmUgdGhlIHNhbWUKCiAgICAgIGYyLnJqLmNvcHkoZjEucmopOwogICAgICBhdmVyYWdlTm9ybWFsLm5vcm1hbGl6ZSgpOwogICAgICBhdmVyYWdlTm9ybWFsLnRhbmdlbnRzKGYxLnQsIGYyLnQpOyAvLyByZXR1cm4gZXE7CiAgICB9CiAgICAvKioKICAgICAqIEdlbmVyYXRlIGFsbCBjb250YWN0cyBiZXR3ZWVuIGEgbGlzdCBvZiBib2R5IHBhaXJzCiAgICAgKiBAcGFyYW0gcDEgQXJyYXkgb2YgYm9keSBpbmRpY2VzCiAgICAgKiBAcGFyYW0gcDIgQXJyYXkgb2YgYm9keSBpbmRpY2VzCiAgICAgKiBAcGFyYW0gcmVzdWx0IEFycmF5IHRvIHN0b3JlIGdlbmVyYXRlZCBjb250YWN0cwogICAgICogQHBhcmFtIG9sZGNvbnRhY3RzIE9wdGlvbmFsLiBBcnJheSBvZiByZXVzYWJsZSBjb250YWN0IG9iamVjdHMKICAgICAqLwoKCiAgICBnZXRDb250YWN0cyhwMSwgcDIsIHdvcmxkLCByZXN1bHQsIG9sZGNvbnRhY3RzLCBmcmljdGlvblJlc3VsdCwgZnJpY3Rpb25Qb29sKSB7CiAgICAgIC8vIFNhdmUgb2xkIGNvbnRhY3Qgb2JqZWN0cwogICAgICB0aGlzLmNvbnRhY3RQb2ludFBvb2wgPSBvbGRjb250YWN0czsKICAgICAgdGhpcy5mcmljdGlvbkVxdWF0aW9uUG9vbCA9IGZyaWN0aW9uUG9vbDsKICAgICAgdGhpcy5yZXN1bHQgPSByZXN1bHQ7CiAgICAgIHRoaXMuZnJpY3Rpb25SZXN1bHQgPSBmcmljdGlvblJlc3VsdDsKICAgICAgY29uc3QgcWkgPSB0bXBRdWF0MTsKICAgICAgY29uc3QgcWogPSB0bXBRdWF0MjsKICAgICAgY29uc3QgeGkgPSB0bXBWZWMxOwogICAgICBjb25zdCB4aiA9IHRtcFZlYzI7CgogICAgICBmb3IgKGxldCBrID0gMCwgTiA9IHAxLmxlbmd0aDsgayAhPT0gTjsgaysrKSB7CiAgICAgICAgLy8gR2V0IGN1cnJlbnQgY29sbGlzaW9uIGJvZGllcwogICAgICAgIGNvbnN0IGJpID0gcDFba107CiAgICAgICAgY29uc3QgYmogPSBwMltrXTsgLy8gR2V0IGNvbnRhY3QgbWF0ZXJpYWwKCiAgICAgICAgbGV0IGJvZHlDb250YWN0TWF0ZXJpYWwgPSBudWxsOwoKICAgICAgICBpZiAoYmkubWF0ZXJpYWwgJiYgYmoubWF0ZXJpYWwpIHsKICAgICAgICAgIGJvZHlDb250YWN0TWF0ZXJpYWwgPSB3b3JsZC5nZXRDb250YWN0TWF0ZXJpYWwoYmkubWF0ZXJpYWwsIGJqLm1hdGVyaWFsKSB8fCBudWxsOwogICAgICAgIH0KCiAgICAgICAgY29uc3QganVzdFRlc3QgPSBiaS50eXBlICYgQm9keS5LSU5FTUFUSUMgJiYgYmoudHlwZSAmIEJvZHkuU1RBVElDIHx8IGJpLnR5cGUgJiBCb2R5LlNUQVRJQyAmJiBiai50eXBlICYgQm9keS5LSU5FTUFUSUMgfHwgYmkudHlwZSAmIEJvZHkuS0lORU1BVElDICYmIGJqLnR5cGUgJiBCb2R5LktJTkVNQVRJQzsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiaS5zaGFwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGJpLnF1YXRlcm5pb24ubXVsdChiaS5zaGFwZU9yaWVudGF0aW9uc1tpXSwgcWkpOwogICAgICAgICAgYmkucXVhdGVybmlvbi52bXVsdChiaS5zaGFwZU9mZnNldHNbaV0sIHhpKTsKICAgICAgICAgIHhpLnZhZGQoYmkucG9zaXRpb24sIHhpKTsKICAgICAgICAgIGNvbnN0IHNpID0gYmkuc2hhcGVzW2ldOwoKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgYmouc2hhcGVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIC8vIENvbXB1dGUgd29ybGQgdHJhbnNmb3JtIG9mIHNoYXBlcwogICAgICAgICAgICBiai5xdWF0ZXJuaW9uLm11bHQoYmouc2hhcGVPcmllbnRhdGlvbnNbal0sIHFqKTsKICAgICAgICAgICAgYmoucXVhdGVybmlvbi52bXVsdChiai5zaGFwZU9mZnNldHNbal0sIHhqKTsKICAgICAgICAgICAgeGoudmFkZChiai5wb3NpdGlvbiwgeGopOwogICAgICAgICAgICBjb25zdCBzaiA9IGJqLnNoYXBlc1tqXTsKCiAgICAgICAgICAgIGlmICghKHNpLmNvbGxpc2lvbkZpbHRlck1hc2sgJiBzai5jb2xsaXNpb25GaWx0ZXJHcm91cCAmJiBzai5jb2xsaXNpb25GaWx0ZXJNYXNrICYgc2kuY29sbGlzaW9uRmlsdGVyR3JvdXApKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh4aS5kaXN0YW5jZVRvKHhqKSA+IHNpLmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgc2ouYm91bmRpbmdTcGhlcmVSYWRpdXMpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSAvLyBHZXQgY29sbGlzaW9uIG1hdGVyaWFsCgoKICAgICAgICAgICAgbGV0IHNoYXBlQ29udGFjdE1hdGVyaWFsID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChzaS5tYXRlcmlhbCAmJiBzai5tYXRlcmlhbCkgewogICAgICAgICAgICAgIHNoYXBlQ29udGFjdE1hdGVyaWFsID0gd29ybGQuZ2V0Q29udGFjdE1hdGVyaWFsKHNpLm1hdGVyaWFsLCBzai5tYXRlcmlhbCkgfHwgbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5jdXJyZW50Q29udGFjdE1hdGVyaWFsID0gc2hhcGVDb250YWN0TWF0ZXJpYWwgfHwgYm9keUNvbnRhY3RNYXRlcmlhbCB8fCB3b3JsZC5kZWZhdWx0Q29udGFjdE1hdGVyaWFsOyAvLyBHZXQgY29udGFjdHMKCiAgICAgICAgICAgIGNvbnN0IHJlc29sdmVySW5kZXggPSBzaS50eXBlIHwgc2oudHlwZTsKICAgICAgICAgICAgY29uc3QgcmVzb2x2ZXIgPSB0aGlzW3Jlc29sdmVySW5kZXhdOwoKICAgICAgICAgICAgaWYgKHJlc29sdmVyKSB7CiAgICAgICAgICAgICAgbGV0IHJldHZhbCA9IGZhbHNlOyAvLyBUTyBETzogaW52ZXN0aWdhdGUgd2h5IHNwaGVyZVBhcnRpY2xlIGFuZCBjb252ZXhQYXJ0aWNsZQogICAgICAgICAgICAgIC8vIHJlc29sdmVycyBleHBlY3Qgc2kgYW5kIHNqIHNoYXBlcyB0byBiZSBpbiByZXZlcnNlIG9yZGVyCiAgICAgICAgICAgICAgLy8gKGkuZS4gbGFyZ2VyIGludGVnZXIgdmFsdWUgdHlwZSBmaXJzdCBpbnN0ZWFkIG9mIHNtYWxsZXIgZmlyc3QpCgogICAgICAgICAgICAgIGlmIChzaS50eXBlIDwgc2oudHlwZSkgewogICAgICAgICAgICAgICAgcmV0dmFsID0gcmVzb2x2ZXIuY2FsbCh0aGlzLCBzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHNpLCBzaiwganVzdFRlc3QpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR2YWwgPSByZXNvbHZlci5jYWxsKHRoaXMsIHNqLCBzaSwgeGosIHhpLCBxaiwgcWksIGJqLCBiaSwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAocmV0dmFsICYmIGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgICAvLyBSZWdpc3RlciBvdmVybGFwCiAgICAgICAgICAgICAgICB3b3JsZC5zaGFwZU92ZXJsYXBLZWVwZXIuc2V0KHNpLmlkLCBzai5pZCk7CiAgICAgICAgICAgICAgICB3b3JsZC5ib2R5T3ZlcmxhcEtlZXBlci5zZXQoYmkuaWQsIGJqLmlkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzcGhlcmVTcGhlcmUoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgcmV0dXJuIHhpLmRpc3RhbmNlU3F1YXJlZCh4aikgPCAoc2kucmFkaXVzICsgc2oucmFkaXVzKSAqKiAyOwogICAgICB9IC8vIFdlIHdpbGwgaGF2ZSBvbmx5IG9uZSBjb250YWN0IGluIHRoaXMgY2FzZQoKCiAgICAgIGNvbnN0IGNvbnRhY3RFcSA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7IC8vIENvbnRhY3Qgbm9ybWFsCgogICAgICB4ai52c3ViKHhpLCBjb250YWN0RXEubmkpOwogICAgICBjb250YWN0RXEubmkubm9ybWFsaXplKCk7IC8vIENvbnRhY3QgcG9pbnQgbG9jYXRpb25zCgogICAgICBjb250YWN0RXEucmkuY29weShjb250YWN0RXEubmkpOwogICAgICBjb250YWN0RXEucmouY29weShjb250YWN0RXEubmkpOwogICAgICBjb250YWN0RXEucmkuc2NhbGUoc2kucmFkaXVzLCBjb250YWN0RXEucmkpOwogICAgICBjb250YWN0RXEucmouc2NhbGUoLXNqLnJhZGl1cywgY29udGFjdEVxLnJqKTsKICAgICAgY29udGFjdEVxLnJpLnZhZGQoeGksIGNvbnRhY3RFcS5yaSk7CiAgICAgIGNvbnRhY3RFcS5yaS52c3ViKGJpLnBvc2l0aW9uLCBjb250YWN0RXEucmkpOwogICAgICBjb250YWN0RXEucmoudmFkZCh4aiwgY29udGFjdEVxLnJqKTsKICAgICAgY29udGFjdEVxLnJqLnZzdWIoYmoucG9zaXRpb24sIGNvbnRhY3RFcS5yaik7CiAgICAgIHRoaXMucmVzdWx0LnB1c2goY29udGFjdEVxKTsKICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KGNvbnRhY3RFcSwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICB9CgogICAgc3BoZXJlUGxhbmUoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgLy8gV2Ugd2lsbCBoYXZlIG9uZSBjb250YWN0IGluIHRoaXMgY2FzZQogICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsgLy8gQ29udGFjdCBub3JtYWwKCiAgICAgIHIubmkuc2V0KDAsIDAsIDEpOwogICAgICBxai52bXVsdChyLm5pLCByLm5pKTsKICAgICAgci5uaS5uZWdhdGUoci5uaSk7IC8vIGJvZHkgaSBpcyB0aGUgc3BoZXJlLCBmbGlwIG5vcm1hbAoKICAgICAgci5uaS5ub3JtYWxpemUoKTsgLy8gTmVlZGVkPwogICAgICAvLyBWZWN0b3IgZnJvbSBzcGhlcmUgY2VudGVyIHRvIGNvbnRhY3QgcG9pbnQKCiAgICAgIHIubmkuc2NhbGUoc2kucmFkaXVzLCByLnJpKTsgLy8gUHJvamVjdCBkb3duIHNwaGVyZSBvbiBwbGFuZQoKICAgICAgeGkudnN1Yih4aiwgcG9pbnRfb25fcGxhbmVfdG9fc3BoZXJlKTsKICAgICAgci5uaS5zY2FsZShyLm5pLmRvdChwb2ludF9vbl9wbGFuZV90b19zcGhlcmUpLCBwbGFuZV90b19zcGhlcmVfb3J0aG8pOwogICAgICBwb2ludF9vbl9wbGFuZV90b19zcGhlcmUudnN1YihwbGFuZV90b19zcGhlcmVfb3J0aG8sIHIucmopOyAvLyBUaGUgc3BoZXJlIHBvc2l0aW9uIHByb2plY3RlZCB0byBwbGFuZQoKICAgICAgaWYgKC1wb2ludF9vbl9wbGFuZV90b19zcGhlcmUuZG90KHIubmkpIDw9IHNpLnJhZGl1cykgewogICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSAvLyBNYWtlIGl0IHJlbGF0aXZlIHRvIHRoZSBib2R5CgoKICAgICAgICBjb25zdCByaSA9IHIucmk7CiAgICAgICAgY29uc3QgcmogPSByLnJqOwogICAgICAgIHJpLnZhZGQoeGksIHJpKTsKICAgICAgICByaS52c3ViKGJpLnBvc2l0aW9uLCByaSk7CiAgICAgICAgcmoudmFkZCh4aiwgcmopOwogICAgICAgIHJqLnZzdWIoYmoucG9zaXRpb24sIHJqKTsKICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgfQogICAgfQoKICAgIGJveEJveChzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICBzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24ubWF0ZXJpYWwgPSBzaS5tYXRlcmlhbDsKICAgICAgc2ouY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2oubWF0ZXJpYWw7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNpLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICBzai5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uY29sbGlzaW9uUmVzcG9uc2UgPSBzai5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4Q29udmV4KHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbiwgc2ouY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCBzaSwgc2osIGp1c3RUZXN0KTsKICAgIH0KCiAgICBzcGhlcmVCb3goc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgY29uc3QgdjNwb29sID0gdGhpcy52M3Bvb2w7IC8vIHdlIHJlZmVyIHRvIHRoZSBib3ggYXMgYm9keSBqCgogICAgICBjb25zdCBzaWRlcyA9IHNwaGVyZUJveF9zaWRlczsKICAgICAgeGkudnN1Yih4aiwgYm94X3RvX3NwaGVyZSk7CiAgICAgIHNqLmdldFNpZGVOb3JtYWxzKHNpZGVzLCBxaik7CiAgICAgIGNvbnN0IFIgPSBzaS5yYWRpdXM7CiAgICAgIGxldCBmb3VuZCA9IGZhbHNlOyAvLyBTdG9yZSB0aGUgcmVzdWx0aW5nIHNpZGUgcGVuZXRyYXRpb24gaW5mbwoKICAgICAgY29uc3Qgc2lkZV9ucyA9IHNwaGVyZUJveF9zaWRlX25zOwogICAgICBjb25zdCBzaWRlX25zMSA9IHNwaGVyZUJveF9zaWRlX25zMTsKICAgICAgY29uc3Qgc2lkZV9uczIgPSBzcGhlcmVCb3hfc2lkZV9uczI7CiAgICAgIGxldCBzaWRlX2ggPSBudWxsOwogICAgICBsZXQgc2lkZV9wZW5ldHJhdGlvbnMgPSAwOwogICAgICBsZXQgc2lkZV9kb3QxID0gMDsKICAgICAgbGV0IHNpZGVfZG90MiA9IDA7CiAgICAgIGxldCBzaWRlX2Rpc3RhbmNlID0gbnVsbDsKCiAgICAgIGZvciAobGV0IGlkeCA9IDAsIG5zaWRlcyA9IHNpZGVzLmxlbmd0aDsgaWR4ICE9PSBuc2lkZXMgJiYgZm91bmQgPT09IGZhbHNlOyBpZHgrKykgewogICAgICAgIC8vIEdldCB0aGUgcGxhbmUgc2lkZSBub3JtYWwgKG5zKQogICAgICAgIGNvbnN0IG5zID0gc3BoZXJlQm94X25zOwogICAgICAgIG5zLmNvcHkoc2lkZXNbaWR4XSk7CiAgICAgICAgY29uc3QgaCA9IG5zLmxlbmd0aCgpOwogICAgICAgIG5zLm5vcm1hbGl6ZSgpOyAvLyBUaGUgbm9ybWFsL2Rpc3RhbmNlIGRvdCBwcm9kdWN0IHRlbGxzIHdoaWNoIHNpZGUgb2YgdGhlIHBsYW5lIHdlIGFyZQoKICAgICAgICBjb25zdCBkb3QgPSBib3hfdG9fc3BoZXJlLmRvdChucyk7CgogICAgICAgIGlmIChkb3QgPCBoICsgUiAmJiBkb3QgPiAwKSB7CiAgICAgICAgICAvLyBJbnRlcnNlY3RzIHBsYW5lLiBOb3cgY2hlY2sgdGhlIG90aGVyIHR3byBkaW1lbnNpb25zCiAgICAgICAgICBjb25zdCBuczEgPSBzcGhlcmVCb3hfbnMxOwogICAgICAgICAgY29uc3QgbnMyID0gc3BoZXJlQm94X25zMjsKICAgICAgICAgIG5zMS5jb3B5KHNpZGVzWyhpZHggKyAxKSAlIDNdKTsKICAgICAgICAgIG5zMi5jb3B5KHNpZGVzWyhpZHggKyAyKSAlIDNdKTsKICAgICAgICAgIGNvbnN0IGgxID0gbnMxLmxlbmd0aCgpOwogICAgICAgICAgY29uc3QgaDIgPSBuczIubGVuZ3RoKCk7CiAgICAgICAgICBuczEubm9ybWFsaXplKCk7CiAgICAgICAgICBuczIubm9ybWFsaXplKCk7CiAgICAgICAgICBjb25zdCBkb3QxID0gYm94X3RvX3NwaGVyZS5kb3QobnMxKTsKICAgICAgICAgIGNvbnN0IGRvdDIgPSBib3hfdG9fc3BoZXJlLmRvdChuczIpOwoKICAgICAgICAgIGlmIChkb3QxIDwgaDEgJiYgZG90MSA+IC1oMSAmJiBkb3QyIDwgaDIgJiYgZG90MiA+IC1oMikgewogICAgICAgICAgICBjb25zdCBkaXN0ID0gTWF0aC5hYnMoZG90IC0gaCAtIFIpOwoKICAgICAgICAgICAgaWYgKHNpZGVfZGlzdGFuY2UgPT09IG51bGwgfHwgZGlzdCA8IHNpZGVfZGlzdGFuY2UpIHsKICAgICAgICAgICAgICBzaWRlX2Rpc3RhbmNlID0gZGlzdDsKICAgICAgICAgICAgICBzaWRlX2RvdDEgPSBkb3QxOwogICAgICAgICAgICAgIHNpZGVfZG90MiA9IGRvdDI7CiAgICAgICAgICAgICAgc2lkZV9oID0gaDsKICAgICAgICAgICAgICBzaWRlX25zLmNvcHkobnMpOwogICAgICAgICAgICAgIHNpZGVfbnMxLmNvcHkobnMxKTsKICAgICAgICAgICAgICBzaWRlX25zMi5jb3B5KG5zMik7CiAgICAgICAgICAgICAgc2lkZV9wZW5ldHJhdGlvbnMrKzsKCiAgICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChzaWRlX3BlbmV0cmF0aW9ucykgewogICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICBzaWRlX25zLnNjYWxlKC1SLCByLnJpKTsgLy8gU3BoZXJlIHIKCiAgICAgICAgci5uaS5jb3B5KHNpZGVfbnMpOwogICAgICAgIHIubmkubmVnYXRlKHIubmkpOyAvLyBOb3JtYWwgc2hvdWxkIGJlIG91dCBvZiBzcGhlcmUKCiAgICAgICAgc2lkZV9ucy5zY2FsZShzaWRlX2gsIHNpZGVfbnMpOwogICAgICAgIHNpZGVfbnMxLnNjYWxlKHNpZGVfZG90MSwgc2lkZV9uczEpOwogICAgICAgIHNpZGVfbnMudmFkZChzaWRlX25zMSwgc2lkZV9ucyk7CiAgICAgICAgc2lkZV9uczIuc2NhbGUoc2lkZV9kb3QyLCBzaWRlX25zMik7CiAgICAgICAgc2lkZV9ucy52YWRkKHNpZGVfbnMyLCByLnJqKTsgLy8gTWFrZSByZWxhdGl2ZSB0byBib2RpZXMKCiAgICAgICAgci5yaS52YWRkKHhpLCByLnJpKTsKICAgICAgICByLnJpLnZzdWIoYmkucG9zaXRpb24sIHIucmkpOwogICAgICAgIHIucmoudmFkZCh4aiwgci5yaik7CiAgICAgICAgci5yai52c3ViKGJqLnBvc2l0aW9uLCByLnJqKTsKICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgfSAvLyBDaGVjayBjb3JuZXJzCgoKICAgICAgbGV0IHJqID0gdjNwb29sLmdldCgpOwogICAgICBjb25zdCBzcGhlcmVfdG9fY29ybmVyID0gc3BoZXJlQm94X3NwaGVyZV90b19jb3JuZXI7CgogICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gMiAmJiAhZm91bmQ7IGorKykgewogICAgICAgIGZvciAobGV0IGsgPSAwOyBrICE9PSAyICYmICFmb3VuZDsgaysrKSB7CiAgICAgICAgICBmb3IgKGxldCBsID0gMDsgbCAhPT0gMiAmJiAhZm91bmQ7IGwrKykgewogICAgICAgICAgICByai5zZXQoMCwgMCwgMCk7CgogICAgICAgICAgICBpZiAoaikgewogICAgICAgICAgICAgIHJqLnZhZGQoc2lkZXNbMF0sIHJqKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByai52c3ViKHNpZGVzWzBdLCByaik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChrKSB7CiAgICAgICAgICAgICAgcmoudmFkZChzaWRlc1sxXSwgcmopOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJqLnZzdWIoc2lkZXNbMV0sIHJqKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGwpIHsKICAgICAgICAgICAgICByai52YWRkKHNpZGVzWzJdLCByaik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmoudnN1YihzaWRlc1syXSwgcmopOwogICAgICAgICAgICB9IC8vIFdvcmxkIHBvc2l0aW9uIG9mIGNvcm5lcgoKCiAgICAgICAgICAgIHhqLnZhZGQocmosIHNwaGVyZV90b19jb3JuZXIpOwogICAgICAgICAgICBzcGhlcmVfdG9fY29ybmVyLnZzdWIoeGksIHNwaGVyZV90b19jb3JuZXIpOwoKICAgICAgICAgICAgaWYgKHNwaGVyZV90b19jb3JuZXIubGVuZ3RoU3F1YXJlZCgpIDwgUiAqIFIpIHsKICAgICAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgICAgIHIucmkuY29weShzcGhlcmVfdG9fY29ybmVyKTsKICAgICAgICAgICAgICByLnJpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgIHIubmkuY29weShyLnJpKTsKICAgICAgICAgICAgICByLnJpLnNjYWxlKFIsIHIucmkpOwogICAgICAgICAgICAgIHIucmouY29weShyaik7IC8vIE1ha2UgcmVsYXRpdmUgdG8gYm9kaWVzCgogICAgICAgICAgICAgIHIucmkudmFkZCh4aSwgci5yaSk7CiAgICAgICAgICAgICAgci5yaS52c3ViKGJpLnBvc2l0aW9uLCByLnJpKTsKICAgICAgICAgICAgICByLnJqLnZhZGQoeGosIHIucmopOwogICAgICAgICAgICAgIHIucmoudnN1Yihiai5wb3NpdGlvbiwgci5yaik7CiAgICAgICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHYzcG9vbC5yZWxlYXNlKHJqKTsKICAgICAgcmogPSBudWxsOyAvLyBDaGVjayBlZGdlcwoKICAgICAgY29uc3QgZWRnZVRhbmdlbnQgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IGVkZ2VDZW50ZXIgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgIGNvbnN0IHIgPSB2M3Bvb2wuZ2V0KCk7IC8vIHIgPSBlZGdlIGNlbnRlciB0byBzcGhlcmUgY2VudGVyCgogICAgICBjb25zdCBvcnRob2dvbmFsID0gdjNwb29sLmdldCgpOwogICAgICBjb25zdCBkaXN0ID0gdjNwb29sLmdldCgpOwogICAgICBjb25zdCBOc2lkZXMgPSBzaWRlcy5sZW5ndGg7CgogICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gTnNpZGVzICYmICFmb3VuZDsgaisrKSB7CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgIT09IE5zaWRlcyAmJiAhZm91bmQ7IGsrKykgewogICAgICAgICAgaWYgKGogJSAzICE9PSBrICUgMykgewogICAgICAgICAgICAvLyBHZXQgZWRnZSB0YW5nZW50CiAgICAgICAgICAgIHNpZGVzW2tdLmNyb3NzKHNpZGVzW2pdLCBlZGdlVGFuZ2VudCk7CiAgICAgICAgICAgIGVkZ2VUYW5nZW50Lm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBzaWRlc1tqXS52YWRkKHNpZGVzW2tdLCBlZGdlQ2VudGVyKTsKICAgICAgICAgICAgci5jb3B5KHhpKTsKICAgICAgICAgICAgci52c3ViKGVkZ2VDZW50ZXIsIHIpOwogICAgICAgICAgICByLnZzdWIoeGosIHIpOwogICAgICAgICAgICBjb25zdCBvcnRob25vcm0gPSByLmRvdChlZGdlVGFuZ2VudCk7IC8vIGRpc3RhbmNlIGZyb20gZWRnZSBjZW50ZXIgdG8gc3BoZXJlIGNlbnRlciBpbiB0aGUgdGFuZ2VudCBkaXJlY3Rpb24KCiAgICAgICAgICAgIGVkZ2VUYW5nZW50LnNjYWxlKG9ydGhvbm9ybSwgb3J0aG9nb25hbCk7IC8vIFZlY3RvciBmcm9tIGVkZ2UgY2VudGVyIHRvIHNwaGVyZSBjZW50ZXIgaW4gdGhlIHRhbmdlbnQgZGlyZWN0aW9uCiAgICAgICAgICAgIC8vIEZpbmQgdGhlIHRoaXJkIHNpZGUgb3J0aG9nb25hbCB0byB0aGlzIG9uZQoKICAgICAgICAgICAgbGV0IGwgPSAwOwoKICAgICAgICAgICAgd2hpbGUgKGwgPT09IGogJSAzIHx8IGwgPT09IGsgJSAzKSB7CiAgICAgICAgICAgICAgbCsrOwogICAgICAgICAgICB9IC8vIHZlYyBmcm9tIGVkZ2UgY2VudGVyIHRvIHNwaGVyZSBwcm9qZWN0ZWQgdG8gdGhlIHBsYW5lIG9ydGhvZ29uYWwgdG8gdGhlIGVkZ2UgdGFuZ2VudAoKCiAgICAgICAgICAgIGRpc3QuY29weSh4aSk7CiAgICAgICAgICAgIGRpc3QudnN1YihvcnRob2dvbmFsLCBkaXN0KTsKICAgICAgICAgICAgZGlzdC52c3ViKGVkZ2VDZW50ZXIsIGRpc3QpOwogICAgICAgICAgICBkaXN0LnZzdWIoeGosIGRpc3QpOyAvLyBEaXN0YW5jZXMgaW4gdGFuZ2VudCBkaXJlY3Rpb24gYW5kIGRpc3RhbmNlIGluIHRoZSBwbGFuZSBvcnRob2dvbmFsIHRvIGl0CgogICAgICAgICAgICBjb25zdCB0ZGlzdCA9IE1hdGguYWJzKG9ydGhvbm9ybSk7CiAgICAgICAgICAgIGNvbnN0IG5kaXN0ID0gZGlzdC5sZW5ndGgoKTsKCiAgICAgICAgICAgIGlmICh0ZGlzdCA8IHNpZGVzW2xdLmxlbmd0aCgpICYmIG5kaXN0IDwgUikgewogICAgICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgY29uc3QgcmVzID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICAgICAgICBlZGdlQ2VudGVyLnZhZGQob3J0aG9nb25hbCwgcmVzLnJqKTsgLy8gYm94IHJqCgogICAgICAgICAgICAgIHJlcy5yai5jb3B5KHJlcy5yaik7CiAgICAgICAgICAgICAgZGlzdC5uZWdhdGUocmVzLm5pKTsKICAgICAgICAgICAgICByZXMubmkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgcmVzLnJpLmNvcHkocmVzLnJqKTsKICAgICAgICAgICAgICByZXMucmkudmFkZCh4aiwgcmVzLnJpKTsKICAgICAgICAgICAgICByZXMucmkudnN1Yih4aSwgcmVzLnJpKTsKICAgICAgICAgICAgICByZXMucmkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgcmVzLnJpLnNjYWxlKFIsIHJlcy5yaSk7IC8vIE1ha2UgcmVsYXRpdmUgdG8gYm9kaWVzCgogICAgICAgICAgICAgIHJlcy5yaS52YWRkKHhpLCByZXMucmkpOwogICAgICAgICAgICAgIHJlcy5yaS52c3ViKGJpLnBvc2l0aW9uLCByZXMucmkpOwogICAgICAgICAgICAgIHJlcy5yai52YWRkKHhqLCByZXMucmopOwogICAgICAgICAgICAgIHJlcy5yai52c3ViKGJqLnBvc2l0aW9uLCByZXMucmopOwogICAgICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocmVzKTsKICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QocmVzLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgdjNwb29sLnJlbGVhc2UoZWRnZVRhbmdlbnQsIGVkZ2VDZW50ZXIsIHIsIG9ydGhvZ29uYWwsIGRpc3QpOwogICAgfQoKICAgIHBsYW5lQm94KHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIHNqLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5tYXRlcmlhbCA9IHNqLm1hdGVyaWFsOwogICAgICBzai5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uY29sbGlzaW9uUmVzcG9uc2UgPSBzai5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgc2ouY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLmlkID0gc2ouaWQ7CiAgICAgIHJldHVybiB0aGlzLnBsYW5lQ29udmV4KHNpLCBzai5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24sIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHNpLCBzaiwganVzdFRlc3QpOwogICAgfQoKICAgIGNvbnZleENvbnZleChzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHJzaSwgcnNqLCBqdXN0VGVzdCwgZmFjZUxpc3RBLCBmYWNlTGlzdEIpIHsKICAgICAgY29uc3Qgc2VwQXhpcyA9IGNvbnZleENvbnZleF9zZXBBeGlzOwoKICAgICAgaWYgKHhpLmRpc3RhbmNlVG8oeGopID4gc2kuYm91bmRpbmdTcGhlcmVSYWRpdXMgKyBzai5ib3VuZGluZ1NwaGVyZVJhZGl1cykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHNpLmZpbmRTZXBhcmF0aW5nQXhpcyhzaiwgeGksIHFpLCB4aiwgcWosIHNlcEF4aXMsIGZhY2VMaXN0QSwgZmFjZUxpc3RCKSkgewogICAgICAgIGNvbnN0IHJlcyA9IFtdOwogICAgICAgIGNvbnN0IHEgPSBjb252ZXhDb252ZXhfcTsKICAgICAgICBzaS5jbGlwQWdhaW5zdEh1bGwoeGksIHFpLCBzaiwgeGosIHFqLCBzZXBBeGlzLCAtMTAwLCAxMDAsIHJlcyk7CiAgICAgICAgbGV0IG51bUNvbnRhY3RzID0gMDsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogIT09IHJlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgY29uc3QgcmkgPSByLnJpOwogICAgICAgICAgY29uc3QgcmogPSByLnJqOwogICAgICAgICAgc2VwQXhpcy5uZWdhdGUoci5uaSk7CiAgICAgICAgICByZXNbal0ubm9ybWFsLm5lZ2F0ZShxKTsKICAgICAgICAgIHEuc2NhbGUocmVzW2pdLmRlcHRoLCBxKTsKICAgICAgICAgIHJlc1tqXS5wb2ludC52YWRkKHEsIHJpKTsKICAgICAgICAgIHJqLmNvcHkocmVzW2pdLnBvaW50KTsgLy8gQ29udGFjdCBwb2ludHMgYXJlIGluIHdvcmxkIGNvb3JkaW5hdGVzLiBUcmFuc2Zvcm0gYmFjayB0byByZWxhdGl2ZQoKICAgICAgICAgIHJpLnZzdWIoeGksIHJpKTsKICAgICAgICAgIHJqLnZzdWIoeGosIHJqKTsgLy8gTWFrZSByZWxhdGl2ZSB0byBib2RpZXMKCiAgICAgICAgICByaS52YWRkKHhpLCByaSk7CiAgICAgICAgICByaS52c3ViKGJpLnBvc2l0aW9uLCByaSk7CiAgICAgICAgICByai52YWRkKHhqLCByaik7CiAgICAgICAgICByai52c3ViKGJqLnBvc2l0aW9uLCByaik7CiAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgbnVtQ29udGFjdHMrKzsKCiAgICAgICAgICBpZiAoIXRoaXMuZW5hYmxlRnJpY3Rpb25SZWR1Y3Rpb24pIHsKICAgICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlRnJpY3Rpb25SZWR1Y3Rpb24gJiYgbnVtQ29udGFjdHMpIHsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25Gcm9tQXZlcmFnZShudW1Db250YWN0cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgc3BoZXJlQ29udmV4KHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGNvbnN0IHYzcG9vbCA9IHRoaXMudjNwb29sOwogICAgICB4aS52c3ViKHhqLCBjb252ZXhfdG9fc3BoZXJlKTsKICAgICAgY29uc3Qgbm9ybWFscyA9IHNqLmZhY2VOb3JtYWxzOwogICAgICBjb25zdCBmYWNlcyA9IHNqLmZhY2VzOwogICAgICBjb25zdCB2ZXJ0cyA9IHNqLnZlcnRpY2VzOwogICAgICBjb25zdCBSID0gc2kucmFkaXVzOyAvLyAgICAgcmV0dXJuOwogICAgICAvLyB9CgogICAgICBsZXQgZm91bmQgPSBmYWxzZTsgLy8gQ2hlY2sgY29ybmVycwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IHZlcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgdiA9IHZlcnRzW2ldOyAvLyBXb3JsZCBwb3NpdGlvbiBvZiBjb3JuZXIKCiAgICAgICAgY29uc3Qgd29ybGRDb3JuZXIgPSBzcGhlcmVDb252ZXhfd29ybGRDb3JuZXI7CiAgICAgICAgcWoudm11bHQodiwgd29ybGRDb3JuZXIpOwogICAgICAgIHhqLnZhZGQod29ybGRDb3JuZXIsIHdvcmxkQ29ybmVyKTsKICAgICAgICBjb25zdCBzcGhlcmVfdG9fY29ybmVyID0gc3BoZXJlQ29udmV4X3NwaGVyZVRvQ29ybmVyOwogICAgICAgIHdvcmxkQ29ybmVyLnZzdWIoeGksIHNwaGVyZV90b19jb3JuZXIpOwoKICAgICAgICBpZiAoc3BoZXJlX3RvX2Nvcm5lci5sZW5ndGhTcXVhcmVkKCkgPCBSICogUikgewogICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgci5yaS5jb3B5KHNwaGVyZV90b19jb3JuZXIpOwogICAgICAgICAgci5yaS5ub3JtYWxpemUoKTsKICAgICAgICAgIHIubmkuY29weShyLnJpKTsKICAgICAgICAgIHIucmkuc2NhbGUoUiwgci5yaSk7CiAgICAgICAgICB3b3JsZENvcm5lci52c3ViKHhqLCByLnJqKTsgLy8gU2hvdWxkIGJlIHJlbGF0aXZlIHRvIHRoZSBib2R5LgoKICAgICAgICAgIHIucmkudmFkZCh4aSwgci5yaSk7CiAgICAgICAgICByLnJpLnZzdWIoYmkucG9zaXRpb24sIHIucmkpOyAvLyBTaG91bGQgYmUgcmVsYXRpdmUgdG8gdGhlIGJvZHkuCgogICAgICAgICAgci5yai52YWRkKHhqLCByLnJqKTsKICAgICAgICAgIHIucmoudnN1Yihiai5wb3NpdGlvbiwgci5yaik7CiAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSAvLyBDaGVjayBzaWRlIChwbGFuZSkgaW50ZXJzZWN0aW9ucwoKCiAgICAgIGZvciAobGV0IGkgPSAwLCBuZmFjZXMgPSBmYWNlcy5sZW5ndGg7IGkgIT09IG5mYWNlcyAmJiBmb3VuZCA9PT0gZmFsc2U7IGkrKykgewogICAgICAgIGNvbnN0IG5vcm1hbCA9IG5vcm1hbHNbaV07CiAgICAgICAgY29uc3QgZmFjZSA9IGZhY2VzW2ldOyAvLyBHZXQgd29ybGQtdHJhbnNmb3JtZWQgbm9ybWFsIG9mIHRoZSBmYWNlCgogICAgICAgIGNvbnN0IHdvcmxkTm9ybWFsID0gc3BoZXJlQ29udmV4X3dvcmxkTm9ybWFsOwogICAgICAgIHFqLnZtdWx0KG5vcm1hbCwgd29ybGROb3JtYWwpOyAvLyBHZXQgYSB3b3JsZCB2ZXJ0ZXggZnJvbSB0aGUgZmFjZQoKICAgICAgICBjb25zdCB3b3JsZFBvaW50ID0gc3BoZXJlQ29udmV4X3dvcmxkUG9pbnQ7CiAgICAgICAgcWoudm11bHQodmVydHNbZmFjZVswXV0sIHdvcmxkUG9pbnQpOwogICAgICAgIHdvcmxkUG9pbnQudmFkZCh4aiwgd29ybGRQb2ludCk7IC8vIEdldCBhIHBvaW50IG9uIHRoZSBzcGhlcmUsIGNsb3Nlc3QgdG8gdGhlIGZhY2Ugbm9ybWFsCgogICAgICAgIGNvbnN0IHdvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZSA9IHNwaGVyZUNvbnZleF93b3JsZFNwaGVyZVBvaW50Q2xvc2VzdFRvUGxhbmU7CiAgICAgICAgd29ybGROb3JtYWwuc2NhbGUoLVIsIHdvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZSk7CiAgICAgICAgeGkudmFkZCh3b3JsZFNwaGVyZVBvaW50Q2xvc2VzdFRvUGxhbmUsIHdvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZSk7IC8vIFZlY3RvciBmcm9tIGEgZmFjZSBwb2ludCB0byB0aGUgY2xvc2VzdCBwb2ludCBvbiB0aGUgc3BoZXJlCgogICAgICAgIGNvbnN0IHBlbmV0cmF0aW9uVmVjID0gc3BoZXJlQ29udmV4X3BlbmV0cmF0aW9uVmVjOwogICAgICAgIHdvcmxkU3BoZXJlUG9pbnRDbG9zZXN0VG9QbGFuZS52c3ViKHdvcmxkUG9pbnQsIHBlbmV0cmF0aW9uVmVjKTsgLy8gVGhlIHBlbmV0cmF0aW9uLiBOZWdhdGl2ZSB2YWx1ZSBtZWFucyBvdmVybGFwLgoKICAgICAgICBjb25zdCBwZW5ldHJhdGlvbiA9IHBlbmV0cmF0aW9uVmVjLmRvdCh3b3JsZE5vcm1hbCk7CiAgICAgICAgY29uc3Qgd29ybGRQb2ludFRvU3BoZXJlID0gc3BoZXJlQ29udmV4X3NwaGVyZVRvV29ybGRQb2ludDsKICAgICAgICB4aS52c3ViKHdvcmxkUG9pbnQsIHdvcmxkUG9pbnRUb1NwaGVyZSk7CgogICAgICAgIGlmIChwZW5ldHJhdGlvbiA8IDAgJiYgd29ybGRQb2ludFRvU3BoZXJlLmRvdCh3b3JsZE5vcm1hbCkgPiAwKSB7CiAgICAgICAgICAvLyBJbnRlcnNlY3RzIHBsYW5lLiBOb3cgY2hlY2sgaWYgdGhlIHNwaGVyZSBpcyBpbnNpZGUgdGhlIGZhY2UgcG9seWdvbgogICAgICAgICAgY29uc3QgZmFjZVZlcnRzID0gW107IC8vIEZhY2UgdmVydGljZXMsIGluIHdvcmxkIGNvb3JkcwoKICAgICAgICAgIGZvciAobGV0IGogPSAwLCBOdmVydHMgPSBmYWNlLmxlbmd0aDsgaiAhPT0gTnZlcnRzOyBqKyspIHsKICAgICAgICAgICAgY29uc3Qgd29ybGRWZXJ0ZXggPSB2M3Bvb2wuZ2V0KCk7CiAgICAgICAgICAgIHFqLnZtdWx0KHZlcnRzW2ZhY2Vbal1dLCB3b3JsZFZlcnRleCk7CiAgICAgICAgICAgIHhqLnZhZGQod29ybGRWZXJ0ZXgsIHdvcmxkVmVydGV4KTsKICAgICAgICAgICAgZmFjZVZlcnRzLnB1c2god29ybGRWZXJ0ZXgpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChwb2ludEluUG9seWdvbihmYWNlVmVydHMsIHdvcmxkTm9ybWFsLCB4aSkpIHsKICAgICAgICAgICAgLy8gSXMgdGhlIHNwaGVyZSBjZW50ZXIgaW4gdGhlIGZhY2UgcG9seWdvbj8KICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICAgIHdvcmxkTm9ybWFsLnNjYWxlKC1SLCByLnJpKTsgLy8gQ29udGFjdCBvZmZzZXQsIGZyb20gc3BoZXJlIGNlbnRlciB0byBjb250YWN0CgogICAgICAgICAgICB3b3JsZE5vcm1hbC5uZWdhdGUoci5uaSk7IC8vIE5vcm1hbCBwb2ludGluZyBvdXQgb2Ygc3BoZXJlCgogICAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvblZlYzIgPSB2M3Bvb2wuZ2V0KCk7CiAgICAgICAgICAgIHdvcmxkTm9ybWFsLnNjYWxlKC1wZW5ldHJhdGlvbiwgcGVuZXRyYXRpb25WZWMyKTsKICAgICAgICAgICAgY29uc3QgcGVuZXRyYXRpb25TcGhlcmVQb2ludCA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgd29ybGROb3JtYWwuc2NhbGUoLVIsIHBlbmV0cmF0aW9uU3BoZXJlUG9pbnQpOyAvL3hpLnZzdWIoeGopLnZhZGQocGVuZXRyYXRpb25TcGhlcmVQb2ludCkudmFkZChwZW5ldHJhdGlvblZlYzIgLCByLnJqKTsKCiAgICAgICAgICAgIHhpLnZzdWIoeGosIHIucmopOwogICAgICAgICAgICByLnJqLnZhZGQocGVuZXRyYXRpb25TcGhlcmVQb2ludCwgci5yaik7CiAgICAgICAgICAgIHIucmoudmFkZChwZW5ldHJhdGlvblZlYzIsIHIucmopOyAvLyBTaG91bGQgYmUgcmVsYXRpdmUgdG8gdGhlIGJvZHkuCgogICAgICAgICAgICByLnJqLnZhZGQoeGosIHIucmopOwogICAgICAgICAgICByLnJqLnZzdWIoYmoucG9zaXRpb24sIHIucmopOyAvLyBTaG91bGQgYmUgcmVsYXRpdmUgdG8gdGhlIGJvZHkuCgogICAgICAgICAgICByLnJpLnZhZGQoeGksIHIucmkpOwogICAgICAgICAgICByLnJpLnZzdWIoYmkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgICB2M3Bvb2wucmVsZWFzZShwZW5ldHJhdGlvblZlYzIpOwogICAgICAgICAgICB2M3Bvb2wucmVsZWFzZShwZW5ldHJhdGlvblNwaGVyZVBvaW50KTsKICAgICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOyAvLyBSZWxlYXNlIHdvcmxkIHZlcnRpY2VzCgogICAgICAgICAgICBmb3IgKGxldCBqID0gMCwgTmZhY2V2ZXJ0cyA9IGZhY2VWZXJ0cy5sZW5ndGg7IGogIT09IE5mYWNldmVydHM7IGorKykgewogICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKGZhY2VWZXJ0c1tqXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybjsgLy8gV2Ugb25seSBleHBlY3QgKm9uZSogZmFjZSBjb250YWN0CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBFZGdlPwogICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiAhPT0gZmFjZS5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgIC8vIEdldCB0d28gd29ybGQgdHJhbnNmb3JtZWQgdmVydGljZXMKICAgICAgICAgICAgICBjb25zdCB2MSA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgICBjb25zdCB2MiA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgICBxai52bXVsdCh2ZXJ0c1tmYWNlWyhqICsgMSkgJSBmYWNlLmxlbmd0aF1dLCB2MSk7CiAgICAgICAgICAgICAgcWoudm11bHQodmVydHNbZmFjZVsoaiArIDIpICUgZmFjZS5sZW5ndGhdXSwgdjIpOwogICAgICAgICAgICAgIHhqLnZhZGQodjEsIHYxKTsKICAgICAgICAgICAgICB4ai52YWRkKHYyLCB2Mik7IC8vIENvbnN0cnVjdCBlZGdlIHZlY3RvcgoKICAgICAgICAgICAgICBjb25zdCBlZGdlID0gc3BoZXJlQ29udmV4X2VkZ2U7CiAgICAgICAgICAgICAgdjIudnN1Yih2MSwgZWRnZSk7IC8vIENvbnN0cnVjdCB0aGUgc2FtZSB2ZWN0b3IsIGJ1dCBub3JtYWxpemVkCgogICAgICAgICAgICAgIGNvbnN0IGVkZ2VVbml0ID0gc3BoZXJlQ29udmV4X2VkZ2VVbml0OwogICAgICAgICAgICAgIGVkZ2UudW5pdChlZGdlVW5pdCk7IC8vIHAgaXMgeGkgcHJvamVjdGVkIG9udG8gdGhlIGVkZ2UKCiAgICAgICAgICAgICAgY29uc3QgcCA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgICBjb25zdCB2MV90b194aSA9IHYzcG9vbC5nZXQoKTsKICAgICAgICAgICAgICB4aS52c3ViKHYxLCB2MV90b194aSk7CiAgICAgICAgICAgICAgY29uc3QgZG90ID0gdjFfdG9feGkuZG90KGVkZ2VVbml0KTsKICAgICAgICAgICAgICBlZGdlVW5pdC5zY2FsZShkb3QsIHApOwogICAgICAgICAgICAgIHAudmFkZCh2MSwgcCk7IC8vIENvbXB1dGUgYSB2ZWN0b3IgZnJvbSBwIHRvIHRoZSBjZW50ZXIgb2YgdGhlIHNwaGVyZQoKICAgICAgICAgICAgICBjb25zdCB4aV90b19wID0gdjNwb29sLmdldCgpOwogICAgICAgICAgICAgIHAudnN1Yih4aSwgeGlfdG9fcCk7IC8vIENvbGxpc2lvbiBpZiB0aGUgZWRnZS1zcGhlcmUgZGlzdGFuY2UgaXMgbGVzcyB0aGFuIHRoZSByYWRpdXMKICAgICAgICAgICAgICAvLyBBTkQgaWYgcCBpcyBpbiBiZXR3ZWVuIHYxIGFuZCB2MgoKICAgICAgICAgICAgICBpZiAoZG90ID4gMCAmJiBkb3QgKiBkb3QgPCBlZGdlLmxlbmd0aFNxdWFyZWQoKSAmJiB4aV90b19wLmxlbmd0aFNxdWFyZWQoKSA8IFIgKiBSKSB7CiAgICAgICAgICAgICAgICAvLyBDb2xsaXNpb24gaWYgdGhlIGVkZ2Utc3BoZXJlIGRpc3RhbmNlIGlzIGxlc3MgdGhhbiB0aGUgcmFkaXVzCiAgICAgICAgICAgICAgICAvLyBFZGdlIGNvbnRhY3QhCiAgICAgICAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgICAgICAgICBwLnZzdWIoeGosIHIucmopOwogICAgICAgICAgICAgICAgcC52c3ViKHhpLCByLm5pKTsKICAgICAgICAgICAgICAgIHIubmkubm9ybWFsaXplKCk7CiAgICAgICAgICAgICAgICByLm5pLnNjYWxlKFIsIHIucmkpOyAvLyBTaG91bGQgYmUgcmVsYXRpdmUgdG8gdGhlIGJvZHkuCgogICAgICAgICAgICAgICAgci5yai52YWRkKHhqLCByLnJqKTsKICAgICAgICAgICAgICAgIHIucmoudnN1Yihiai5wb3NpdGlvbiwgci5yaik7IC8vIFNob3VsZCBiZSByZWxhdGl2ZSB0byB0aGUgYm9keS4KCiAgICAgICAgICAgICAgICByLnJpLnZhZGQoeGksIHIucmkpOwogICAgICAgICAgICAgICAgci5yaS52c3ViKGJpLnBvc2l0aW9uLCByLnJpKTsKICAgICAgICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7IC8vIFJlbGVhc2Ugd29ybGQgdmVydGljZXMKCiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMCwgTmZhY2V2ZXJ0cyA9IGZhY2VWZXJ0cy5sZW5ndGg7IGogIT09IE5mYWNldmVydHM7IGorKykgewogICAgICAgICAgICAgICAgICB2M3Bvb2wucmVsZWFzZShmYWNlVmVydHNbal0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHYxKTsKICAgICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHYyKTsKICAgICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHApOwogICAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UoeGlfdG9fcCk7CiAgICAgICAgICAgICAgICB2M3Bvb2wucmVsZWFzZSh2MV90b194aSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2M3Bvb2wucmVsZWFzZSh2MSk7CiAgICAgICAgICAgICAgdjNwb29sLnJlbGVhc2UodjIpOwogICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHApOwogICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHhpX3RvX3ApOwogICAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKHYxX3RvX3hpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSAvLyBSZWxlYXNlIHdvcmxkIHZlcnRpY2VzCgoKICAgICAgICAgIGZvciAobGV0IGogPSAwLCBOZmFjZXZlcnRzID0gZmFjZVZlcnRzLmxlbmd0aDsgaiAhPT0gTmZhY2V2ZXJ0czsgaisrKSB7CiAgICAgICAgICAgIHYzcG9vbC5yZWxlYXNlKGZhY2VWZXJ0c1tqXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcGxhbmVDb252ZXgocGxhbmVTaGFwZSwgY29udmV4U2hhcGUsIHBsYW5lUG9zaXRpb24sIGNvbnZleFBvc2l0aW9uLCBwbGFuZVF1YXQsIGNvbnZleFF1YXQsIHBsYW5lQm9keSwgY29udmV4Qm9keSwgc2ksIHNqLCBqdXN0VGVzdCkgewogICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBwb2ludHMgYmVoaW5kIHRoZSBwbGFuZS4KICAgICAgY29uc3Qgd29ybGRWZXJ0ZXggPSBwbGFuZUNvbnZleF92OwogICAgICBjb25zdCB3b3JsZE5vcm1hbCA9IHBsYW5lQ29udmV4X25vcm1hbDsKICAgICAgd29ybGROb3JtYWwuc2V0KDAsIDAsIDEpOwogICAgICBwbGFuZVF1YXQudm11bHQod29ybGROb3JtYWwsIHdvcmxkTm9ybWFsKTsgLy8gVHVybiBub3JtYWwgYWNjb3JkaW5nIHRvIHBsYW5lIG9yaWVudGF0aW9uCgogICAgICBsZXQgbnVtQ29udGFjdHMgPSAwOwogICAgICBjb25zdCByZWxwb3MgPSBwbGFuZUNvbnZleF9yZWxwb3M7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gY29udmV4U2hhcGUudmVydGljZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAvLyBHZXQgd29ybGQgY29udmV4IHZlcnRleAogICAgICAgIHdvcmxkVmVydGV4LmNvcHkoY29udmV4U2hhcGUudmVydGljZXNbaV0pOwogICAgICAgIGNvbnZleFF1YXQudm11bHQod29ybGRWZXJ0ZXgsIHdvcmxkVmVydGV4KTsKICAgICAgICBjb252ZXhQb3NpdGlvbi52YWRkKHdvcmxkVmVydGV4LCB3b3JsZFZlcnRleCk7CiAgICAgICAgd29ybGRWZXJ0ZXgudnN1YihwbGFuZVBvc2l0aW9uLCByZWxwb3MpOwogICAgICAgIGNvbnN0IGRvdCA9IHdvcmxkTm9ybWFsLmRvdChyZWxwb3MpOwoKICAgICAgICBpZiAoZG90IDw9IDAuMCkgewogICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihwbGFuZUJvZHksIGNvbnZleEJvZHksIHBsYW5lU2hhcGUsIGNvbnZleFNoYXBlLCBzaSwgc2opOyAvLyBHZXQgdmVydGV4IHBvc2l0aW9uIHByb2plY3RlZCBvbiBwbGFuZQoKICAgICAgICAgIGNvbnN0IHByb2plY3RlZCA9IHBsYW5lQ29udmV4X3Byb2plY3RlZDsKICAgICAgICAgIHdvcmxkTm9ybWFsLnNjYWxlKHdvcmxkTm9ybWFsLmRvdChyZWxwb3MpLCBwcm9qZWN0ZWQpOwogICAgICAgICAgd29ybGRWZXJ0ZXgudnN1Yihwcm9qZWN0ZWQsIHByb2plY3RlZCk7CiAgICAgICAgICBwcm9qZWN0ZWQudnN1YihwbGFuZVBvc2l0aW9uLCByLnJpKTsgLy8gRnJvbSBwbGFuZSB0byB2ZXJ0ZXggcHJvamVjdGVkIG9uIHBsYW5lCgogICAgICAgICAgci5uaS5jb3B5KHdvcmxkTm9ybWFsKTsgLy8gQ29udGFjdCBub3JtYWwgaXMgdGhlIHBsYW5lIG5vcm1hbCBvdXQgZnJvbSBwbGFuZQogICAgICAgICAgLy8gcmogaXMgbm93IGp1c3QgdGhlIHZlY3RvciBmcm9tIHRoZSBjb252ZXggY2VudGVyIHRvIHRoZSB2ZXJ0ZXgKCiAgICAgICAgICB3b3JsZFZlcnRleC52c3ViKGNvbnZleFBvc2l0aW9uLCByLnJqKTsgLy8gTWFrZSBpdCByZWxhdGl2ZSB0byB0aGUgYm9keQoKICAgICAgICAgIHIucmkudmFkZChwbGFuZVBvc2l0aW9uLCByLnJpKTsKICAgICAgICAgIHIucmkudnN1YihwbGFuZUJvZHkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgci5yai52YWRkKGNvbnZleFBvc2l0aW9uLCByLnJqKTsKICAgICAgICAgIHIucmoudnN1Yihjb252ZXhCb2R5LnBvc2l0aW9uLCByLnJqKTsKICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICBudW1Db250YWN0cysrOwoKICAgICAgICAgIGlmICghdGhpcy5lbmFibGVGcmljdGlvblJlZHVjdGlvbikgewogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5lbmFibGVGcmljdGlvblJlZHVjdGlvbiAmJiBudW1Db250YWN0cykgewogICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25Gcm9tQXZlcmFnZShudW1Db250YWN0cyk7CiAgICAgIH0KICAgIH0KCiAgICBib3hDb252ZXgoc2ksIHNqLCB4aSwgeGosIHFpLCBxaiwgYmksIGJqLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLm1hdGVyaWFsID0gc2kubWF0ZXJpYWw7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5jb2xsaXNpb25SZXNwb25zZSA9IHNpLmNvbGxpc2lvblJlc3BvbnNlOwogICAgICByZXR1cm4gdGhpcy5jb252ZXhDb252ZXgoc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgc3BoZXJlSGVpZ2h0ZmllbGQoc3BoZXJlU2hhcGUsIGhmU2hhcGUsIHNwaGVyZVBvcywgaGZQb3MsIHNwaGVyZVF1YXQsIGhmUXVhdCwgc3BoZXJlQm9keSwgaGZCb2R5LCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgY29uc3QgZGF0YSA9IGhmU2hhcGUuZGF0YTsKICAgICAgY29uc3QgcmFkaXVzID0gc3BoZXJlU2hhcGUucmFkaXVzOwogICAgICBjb25zdCB3ID0gaGZTaGFwZS5lbGVtZW50U2l6ZTsKICAgICAgY29uc3Qgd29ybGRQaWxsYXJPZmZzZXQgPSBzcGhlcmVIZWlnaHRmaWVsZF90bXAyOyAvLyBHZXQgc3BoZXJlIHBvc2l0aW9uIHRvIGhlaWdodGZpZWxkIGxvY2FsIQoKICAgICAgY29uc3QgbG9jYWxTcGhlcmVQb3MgPSBzcGhlcmVIZWlnaHRmaWVsZF90bXAxOwogICAgICBUcmFuc2Zvcm0ucG9pbnRUb0xvY2FsRnJhbWUoaGZQb3MsIGhmUXVhdCwgc3BoZXJlUG9zLCBsb2NhbFNwaGVyZVBvcyk7IC8vIEdldCB0aGUgaW5kZXggb2YgdGhlIGRhdGEgcG9pbnRzIHRvIHRlc3QgYWdhaW5zdAoKICAgICAgbGV0IGlNaW5YID0gTWF0aC5mbG9vcigobG9jYWxTcGhlcmVQb3MueCAtIHJhZGl1cykgLyB3KSAtIDE7CiAgICAgIGxldCBpTWF4WCA9IE1hdGguY2VpbCgobG9jYWxTcGhlcmVQb3MueCArIHJhZGl1cykgLyB3KSArIDE7CiAgICAgIGxldCBpTWluWSA9IE1hdGguZmxvb3IoKGxvY2FsU3BoZXJlUG9zLnkgLSByYWRpdXMpIC8gdykgLSAxOwogICAgICBsZXQgaU1heFkgPSBNYXRoLmNlaWwoKGxvY2FsU3BoZXJlUG9zLnkgKyByYWRpdXMpIC8gdykgKyAxOyAvLyBCYWlsIG91dCBpZiB3ZSBhcmUgb3V0IG9mIHRoZSB0ZXJyYWluCgogICAgICBpZiAoaU1heFggPCAwIHx8IGlNYXhZIDwgMCB8fCBpTWluWCA+IGRhdGEubGVuZ3RoIHx8IGlNaW5ZID4gZGF0YVswXS5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gQ2xhbXAgaW5kZXggdG8gZWRnZXMKCgogICAgICBpZiAoaU1pblggPCAwKSB7CiAgICAgICAgaU1pblggPSAwOwogICAgICB9CgogICAgICBpZiAoaU1heFggPCAwKSB7CiAgICAgICAgaU1heFggPSAwOwogICAgICB9CgogICAgICBpZiAoaU1pblkgPCAwKSB7CiAgICAgICAgaU1pblkgPSAwOwogICAgICB9CgogICAgICBpZiAoaU1heFkgPCAwKSB7CiAgICAgICAgaU1heFkgPSAwOwogICAgICB9CgogICAgICBpZiAoaU1pblggPj0gZGF0YS5sZW5ndGgpIHsKICAgICAgICBpTWluWCA9IGRhdGEubGVuZ3RoIC0gMTsKICAgICAgfQoKICAgICAgaWYgKGlNYXhYID49IGRhdGEubGVuZ3RoKSB7CiAgICAgICAgaU1heFggPSBkYXRhLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WSA+PSBkYXRhWzBdLmxlbmd0aCkgewogICAgICAgIGlNYXhZID0gZGF0YVswXS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBpZiAoaU1pblkgPj0gZGF0YVswXS5sZW5ndGgpIHsKICAgICAgICBpTWluWSA9IGRhdGFbMF0ubGVuZ3RoIC0gMTsKICAgICAgfQoKICAgICAgY29uc3QgbWluTWF4ID0gW107CiAgICAgIGhmU2hhcGUuZ2V0UmVjdE1pbk1heChpTWluWCwgaU1pblksIGlNYXhYLCBpTWF4WSwgbWluTWF4KTsKICAgICAgY29uc3QgbWluID0gbWluTWF4WzBdOwogICAgICBjb25zdCBtYXggPSBtaW5NYXhbMV07IC8vIEJhaWwgb3V0IGlmIHdlIGNhbid0IHRvdWNoIHRoZSBib3VuZGluZyBoZWlnaHQgYm94CgogICAgICBpZiAobG9jYWxTcGhlcmVQb3MueiAtIHJhZGl1cyA+IG1heCB8fCBsb2NhbFNwaGVyZVBvcy56ICsgcmFkaXVzIDwgbWluKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJlc3VsdDsKCiAgICAgIGZvciAobGV0IGkgPSBpTWluWDsgaSA8IGlNYXhYOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gaU1pblk7IGogPCBpTWF4WTsgaisrKSB7CiAgICAgICAgICBjb25zdCBudW1Db250YWN0c0JlZm9yZSA9IHJlc3VsdC5sZW5ndGg7CiAgICAgICAgICBsZXQgaW50ZXJzZWN0aW5nID0gZmFsc2U7IC8vIExvd2VyIHRyaWFuZ2xlCgogICAgICAgICAgaGZTaGFwZS5nZXRDb252ZXhUcmlhbmdsZVBpbGxhcihpLCBqLCBmYWxzZSk7CiAgICAgICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUoaGZQb3MsIGhmUXVhdCwgaGZTaGFwZS5waWxsYXJPZmZzZXQsIHdvcmxkUGlsbGFyT2Zmc2V0KTsKCiAgICAgICAgICBpZiAoc3BoZXJlUG9zLmRpc3RhbmNlVG8od29ybGRQaWxsYXJPZmZzZXQpIDwgaGZTaGFwZS5waWxsYXJDb252ZXguYm91bmRpbmdTcGhlcmVSYWRpdXMgKyBzcGhlcmVTaGFwZS5ib3VuZGluZ1NwaGVyZVJhZGl1cykgewogICAgICAgICAgICBpbnRlcnNlY3RpbmcgPSB0aGlzLnNwaGVyZUNvbnZleChzcGhlcmVTaGFwZSwgaGZTaGFwZS5waWxsYXJDb252ZXgsIHNwaGVyZVBvcywgd29ybGRQaWxsYXJPZmZzZXQsIHNwaGVyZVF1YXQsIGhmUXVhdCwgc3BoZXJlQm9keSwgaGZCb2R5LCBzcGhlcmVTaGFwZSwgaGZTaGFwZSwganVzdFRlc3QpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChqdXN0VGVzdCAmJiBpbnRlcnNlY3RpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IC8vIFVwcGVyIHRyaWFuZ2xlCgoKICAgICAgICAgIGhmU2hhcGUuZ2V0Q29udmV4VHJpYW5nbGVQaWxsYXIoaSwgaiwgdHJ1ZSk7CiAgICAgICAgICBUcmFuc2Zvcm0ucG9pbnRUb1dvcmxkRnJhbWUoaGZQb3MsIGhmUXVhdCwgaGZTaGFwZS5waWxsYXJPZmZzZXQsIHdvcmxkUGlsbGFyT2Zmc2V0KTsKCiAgICAgICAgICBpZiAoc3BoZXJlUG9zLmRpc3RhbmNlVG8od29ybGRQaWxsYXJPZmZzZXQpIDwgaGZTaGFwZS5waWxsYXJDb252ZXguYm91bmRpbmdTcGhlcmVSYWRpdXMgKyBzcGhlcmVTaGFwZS5ib3VuZGluZ1NwaGVyZVJhZGl1cykgewogICAgICAgICAgICBpbnRlcnNlY3RpbmcgPSB0aGlzLnNwaGVyZUNvbnZleChzcGhlcmVTaGFwZSwgaGZTaGFwZS5waWxsYXJDb252ZXgsIHNwaGVyZVBvcywgd29ybGRQaWxsYXJPZmZzZXQsIHNwaGVyZVF1YXQsIGhmUXVhdCwgc3BoZXJlQm9keSwgaGZCb2R5LCBzcGhlcmVTaGFwZSwgaGZTaGFwZSwganVzdFRlc3QpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChqdXN0VGVzdCAmJiBpbnRlcnNlY3RpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgbnVtQ29udGFjdHMgPSByZXN1bHQubGVuZ3RoIC0gbnVtQ29udGFjdHNCZWZvcmU7CgogICAgICAgICAgaWYgKG51bUNvbnRhY3RzID4gMikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICAvKgogICAgICAgICAgICAvLyBTa2lwIGFsbCBidXQgMQogICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IG51bUNvbnRhY3RzIC0gMTsgaysrKSB7CiAgICAgICAgICAgICAgICByZXN1bHQucG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICovCgogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGJveEhlaWdodGZpZWxkKHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5tYXRlcmlhbCA9IHNpLm1hdGVyaWFsOwogICAgICBzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uY29sbGlzaW9uUmVzcG9uc2UgPSBzaS5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4SGVpZ2h0ZmllbGQoc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgY29udmV4SGVpZ2h0ZmllbGQoY29udmV4U2hhcGUsIGhmU2hhcGUsIGNvbnZleFBvcywgaGZQb3MsIGNvbnZleFF1YXQsIGhmUXVhdCwgY29udmV4Qm9keSwgaGZCb2R5LCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgY29uc3QgZGF0YSA9IGhmU2hhcGUuZGF0YTsKICAgICAgY29uc3QgdyA9IGhmU2hhcGUuZWxlbWVudFNpemU7CiAgICAgIGNvbnN0IHJhZGl1cyA9IGNvbnZleFNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzOwogICAgICBjb25zdCB3b3JsZFBpbGxhck9mZnNldCA9IGNvbnZleEhlaWdodGZpZWxkX3RtcDI7CiAgICAgIGNvbnN0IGZhY2VMaXN0ID0gY29udmV4SGVpZ2h0ZmllbGRfZmFjZUxpc3Q7IC8vIEdldCBzcGhlcmUgcG9zaXRpb24gdG8gaGVpZ2h0ZmllbGQgbG9jYWwhCgogICAgICBjb25zdCBsb2NhbENvbnZleFBvcyA9IGNvbnZleEhlaWdodGZpZWxkX3RtcDE7CiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZShoZlBvcywgaGZRdWF0LCBjb252ZXhQb3MsIGxvY2FsQ29udmV4UG9zKTsgLy8gR2V0IHRoZSBpbmRleCBvZiB0aGUgZGF0YSBwb2ludHMgdG8gdGVzdCBhZ2FpbnN0CgogICAgICBsZXQgaU1pblggPSBNYXRoLmZsb29yKChsb2NhbENvbnZleFBvcy54IC0gcmFkaXVzKSAvIHcpIC0gMTsKICAgICAgbGV0IGlNYXhYID0gTWF0aC5jZWlsKChsb2NhbENvbnZleFBvcy54ICsgcmFkaXVzKSAvIHcpICsgMTsKICAgICAgbGV0IGlNaW5ZID0gTWF0aC5mbG9vcigobG9jYWxDb252ZXhQb3MueSAtIHJhZGl1cykgLyB3KSAtIDE7CiAgICAgIGxldCBpTWF4WSA9IE1hdGguY2VpbCgobG9jYWxDb252ZXhQb3MueSArIHJhZGl1cykgLyB3KSArIDE7IC8vIEJhaWwgb3V0IGlmIHdlIGFyZSBvdXQgb2YgdGhlIHRlcnJhaW4KCiAgICAgIGlmIChpTWF4WCA8IDAgfHwgaU1heFkgPCAwIHx8IGlNaW5YID4gZGF0YS5sZW5ndGggfHwgaU1pblkgPiBkYXRhWzBdLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBDbGFtcCBpbmRleCB0byBlZGdlcwoKCiAgICAgIGlmIChpTWluWCA8IDApIHsKICAgICAgICBpTWluWCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WCA8IDApIHsKICAgICAgICBpTWF4WCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWSA8IDApIHsKICAgICAgICBpTWluWSA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWF4WSA8IDApIHsKICAgICAgICBpTWF4WSA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWCA+PSBkYXRhLmxlbmd0aCkgewogICAgICAgIGlNaW5YID0gZGF0YS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBpZiAoaU1heFggPj0gZGF0YS5sZW5ndGgpIHsKICAgICAgICBpTWF4WCA9IGRhdGEubGVuZ3RoIC0gMTsKICAgICAgfQoKICAgICAgaWYgKGlNYXhZID49IGRhdGFbMF0ubGVuZ3RoKSB7CiAgICAgICAgaU1heFkgPSBkYXRhWzBdLmxlbmd0aCAtIDE7CiAgICAgIH0KCiAgICAgIGlmIChpTWluWSA+PSBkYXRhWzBdLmxlbmd0aCkgewogICAgICAgIGlNaW5ZID0gZGF0YVswXS5sZW5ndGggLSAxOwogICAgICB9CgogICAgICBjb25zdCBtaW5NYXggPSBbXTsKICAgICAgaGZTaGFwZS5nZXRSZWN0TWluTWF4KGlNaW5YLCBpTWluWSwgaU1heFgsIGlNYXhZLCBtaW5NYXgpOwogICAgICBjb25zdCBtaW4gPSBtaW5NYXhbMF07CiAgICAgIGNvbnN0IG1heCA9IG1pbk1heFsxXTsgLy8gQmFpbCBvdXQgaWYgd2UncmUgY2FudCB0b3VjaCB0aGUgYm91bmRpbmcgaGVpZ2h0IGJveAoKICAgICAgaWYgKGxvY2FsQ29udmV4UG9zLnogLSByYWRpdXMgPiBtYXggfHwgbG9jYWxDb252ZXhQb3MueiArIHJhZGl1cyA8IG1pbikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZm9yIChsZXQgaSA9IGlNaW5YOyBpIDwgaU1heFg7IGkrKykgewogICAgICAgIGZvciAobGV0IGogPSBpTWluWTsgaiA8IGlNYXhZOyBqKyspIHsKICAgICAgICAgIGxldCBpbnRlcnNlY3RpbmcgPSBmYWxzZTsgLy8gTG93ZXIgdHJpYW5nbGUKCiAgICAgICAgICBoZlNoYXBlLmdldENvbnZleFRyaWFuZ2xlUGlsbGFyKGksIGosIGZhbHNlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShoZlBvcywgaGZRdWF0LCBoZlNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIGlmIChjb252ZXhQb3MuZGlzdGFuY2VUbyh3b3JsZFBpbGxhck9mZnNldCkgPCBoZlNoYXBlLnBpbGxhckNvbnZleC5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIGNvbnZleFNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgIGludGVyc2VjdGluZyA9IHRoaXMuY29udmV4Q29udmV4KGNvbnZleFNoYXBlLCBoZlNoYXBlLnBpbGxhckNvbnZleCwgY29udmV4UG9zLCB3b3JsZFBpbGxhck9mZnNldCwgY29udmV4UXVhdCwgaGZRdWF0LCBjb252ZXhCb2R5LCBoZkJvZHksIG51bGwsIG51bGwsIGp1c3RUZXN0LCBmYWNlTGlzdCwgbnVsbCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGp1c3RUZXN0ICYmIGludGVyc2VjdGluZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0gLy8gVXBwZXIgdHJpYW5nbGUKCgogICAgICAgICAgaGZTaGFwZS5nZXRDb252ZXhUcmlhbmdsZVBpbGxhcihpLCBqLCB0cnVlKTsKICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZShoZlBvcywgaGZRdWF0LCBoZlNoYXBlLnBpbGxhck9mZnNldCwgd29ybGRQaWxsYXJPZmZzZXQpOwoKICAgICAgICAgIGlmIChjb252ZXhQb3MuZGlzdGFuY2VUbyh3b3JsZFBpbGxhck9mZnNldCkgPCBoZlNoYXBlLnBpbGxhckNvbnZleC5ib3VuZGluZ1NwaGVyZVJhZGl1cyArIGNvbnZleFNoYXBlLmJvdW5kaW5nU3BoZXJlUmFkaXVzKSB7CiAgICAgICAgICAgIGludGVyc2VjdGluZyA9IHRoaXMuY29udmV4Q29udmV4KGNvbnZleFNoYXBlLCBoZlNoYXBlLnBpbGxhckNvbnZleCwgY29udmV4UG9zLCB3b3JsZFBpbGxhck9mZnNldCwgY29udmV4UXVhdCwgaGZRdWF0LCBjb252ZXhCb2R5LCBoZkJvZHksIG51bGwsIG51bGwsIGp1c3RUZXN0LCBmYWNlTGlzdCwgbnVsbCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGp1c3RUZXN0ICYmIGludGVyc2VjdGluZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzcGhlcmVQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICAvLyBUaGUgbm9ybWFsIGlzIHRoZSB1bml0IHZlY3RvciBmcm9tIHNwaGVyZSBjZW50ZXIgdG8gcGFydGljbGUgY2VudGVyCiAgICAgIGNvbnN0IG5vcm1hbCA9IHBhcnRpY2xlU3BoZXJlX25vcm1hbDsKICAgICAgbm9ybWFsLnNldCgwLCAwLCAxKTsKICAgICAgeGkudnN1Yih4aiwgbm9ybWFsKTsKICAgICAgY29uc3QgbGVuZ3RoU3F1YXJlZCA9IG5vcm1hbC5sZW5ndGhTcXVhcmVkKCk7CgogICAgICBpZiAobGVuZ3RoU3F1YXJlZCA8PSBzai5yYWRpdXMgKiBzai5yYWRpdXMpIHsKICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgciA9IHRoaXMuY3JlYXRlQ29udGFjdEVxdWF0aW9uKGJpLCBiaiwgc2ksIHNqLCByc2ksIHJzaik7CiAgICAgICAgbm9ybWFsLm5vcm1hbGl6ZSgpOwogICAgICAgIHIucmouY29weShub3JtYWwpOwogICAgICAgIHIucmouc2NhbGUoc2oucmFkaXVzLCByLnJqKTsKICAgICAgICByLm5pLmNvcHkobm9ybWFsKTsgLy8gQ29udGFjdCBub3JtYWwKCiAgICAgICAgci5uaS5uZWdhdGUoci5uaSk7CiAgICAgICAgci5yaS5zZXQoMCwgMCwgMCk7IC8vIENlbnRlciBvZiBwYXJ0aWNsZQoKICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgfQogICAgfQoKICAgIHBsYW5lUGFydGljbGUoc2osIHNpLCB4aiwgeGksIHFqLCBxaSwgYmosIGJpLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgY29uc3Qgbm9ybWFsID0gcGFydGljbGVQbGFuZV9ub3JtYWw7CiAgICAgIG5vcm1hbC5zZXQoMCwgMCwgMSk7CiAgICAgIGJqLnF1YXRlcm5pb24udm11bHQobm9ybWFsLCBub3JtYWwpOyAvLyBUdXJuIG5vcm1hbCBhY2NvcmRpbmcgdG8gcGxhbmUgb3JpZW50YXRpb24KCiAgICAgIGNvbnN0IHJlbHBvcyA9IHBhcnRpY2xlUGxhbmVfcmVscG9zOwogICAgICB4aS52c3ViKGJqLnBvc2l0aW9uLCByZWxwb3MpOwogICAgICBjb25zdCBkb3QgPSBub3JtYWwuZG90KHJlbHBvcyk7CgogICAgICBpZiAoZG90IDw9IDAuMCkgewogICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oYmksIGJqLCBzaSwgc2osIHJzaSwgcnNqKTsKICAgICAgICByLm5pLmNvcHkobm9ybWFsKTsgLy8gQ29udGFjdCBub3JtYWwgaXMgdGhlIHBsYW5lIG5vcm1hbAoKICAgICAgICByLm5pLm5lZ2F0ZShyLm5pKTsKICAgICAgICByLnJpLnNldCgwLCAwLCAwKTsgLy8gQ2VudGVyIG9mIHBhcnRpY2xlCiAgICAgICAgLy8gR2V0IHBhcnRpY2xlIHBvc2l0aW9uIHByb2plY3RlZCBvbiBwbGFuZQoKICAgICAgICBjb25zdCBwcm9qZWN0ZWQgPSBwYXJ0aWNsZVBsYW5lX3Byb2plY3RlZDsKICAgICAgICBub3JtYWwuc2NhbGUobm9ybWFsLmRvdCh4aSksIHByb2plY3RlZCk7CiAgICAgICAgeGkudnN1Yihwcm9qZWN0ZWQsIHByb2plY3RlZCk7IC8vcHJvamVjdGVkLnZhZGQoYmoucG9zaXRpb24scHJvamVjdGVkKTsKICAgICAgICAvLyByaiBpcyBub3cgdGhlIHByb2plY3RlZCB3b3JsZCBwb3NpdGlvbiBtaW51cyBwbGFuZSBwb3NpdGlvbgoKICAgICAgICByLnJqLmNvcHkocHJvamVjdGVkKTsKICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgfQogICAgfQoKICAgIGJveFBhcnRpY2xlKHNpLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIHNpLmNvbnZleFBvbHloZWRyb25SZXByZXNlbnRhdGlvbi5tYXRlcmlhbCA9IHNpLm1hdGVyaWFsOwogICAgICBzaS5jb252ZXhQb2x5aGVkcm9uUmVwcmVzZW50YXRpb24uY29sbGlzaW9uUmVzcG9uc2UgPSBzaS5jb2xsaXNpb25SZXNwb25zZTsKICAgICAgcmV0dXJuIHRoaXMuY29udmV4UGFydGljbGUoc2kuY29udmV4UG9seWhlZHJvblJlcHJlc2VudGF0aW9uLCBzaiwgeGksIHhqLCBxaSwgcWosIGJpLCBiaiwgc2ksIHNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgY29udmV4UGFydGljbGUoc2osIHNpLCB4aiwgeGksIHFqLCBxaSwgYmosIGJpLCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgbGV0IHBlbmV0cmF0ZWRGYWNlSW5kZXggPSAtMTsKICAgICAgY29uc3QgcGVuZXRyYXRlZEZhY2VOb3JtYWwgPSBjb252ZXhQYXJ0aWNsZV9wZW5ldHJhdGVkRmFjZU5vcm1hbDsKICAgICAgY29uc3Qgd29ybGRQZW5ldHJhdGlvblZlYyA9IGNvbnZleFBhcnRpY2xlX3dvcmxkUGVuZXRyYXRpb25WZWM7CiAgICAgIGxldCBtaW5QZW5ldHJhdGlvbiA9IG51bGw7CiAgICAgIGNvbnN0IGxvY2FsID0gY29udmV4UGFydGljbGVfbG9jYWw7CiAgICAgIGxvY2FsLmNvcHkoeGkpOwogICAgICBsb2NhbC52c3ViKHhqLCBsb2NhbCk7IC8vIENvbnZlcnQgcG9zaXRpb24gdG8gcmVsYXRpdmUgdGhlIGNvbnZleCBvcmlnaW4KCiAgICAgIHFqLmNvbmp1Z2F0ZShjcWopOwogICAgICBjcWoudm11bHQobG9jYWwsIGxvY2FsKTsKCiAgICAgIGlmIChzai5wb2ludElzSW5zaWRlKGxvY2FsKSkgewogICAgICAgIGlmIChzai53b3JsZFZlcnRpY2VzTmVlZHNVcGRhdGUpIHsKICAgICAgICAgIHNqLmNvbXB1dGVXb3JsZFZlcnRpY2VzKHhqLCBxaik7CiAgICAgICAgfQoKICAgICAgICBpZiAoc2oud29ybGRGYWNlTm9ybWFsc05lZWRzVXBkYXRlKSB7CiAgICAgICAgICBzai5jb21wdXRlV29ybGRGYWNlTm9ybWFscyhxaik7CiAgICAgICAgfSAvLyBGb3IgZWFjaCB3b3JsZCBwb2x5Z29uIGluIHRoZSBwb2x5aGVkcmEKCgogICAgICAgIGZvciAobGV0IGkgPSAwLCBuZmFjZXMgPSBzai5mYWNlcy5sZW5ndGg7IGkgIT09IG5mYWNlczsgaSsrKSB7CiAgICAgICAgICAvLyBDb25zdHJ1Y3Qgd29ybGQgZmFjZSB2ZXJ0aWNlcwogICAgICAgICAgY29uc3QgdmVydHMgPSBbc2oud29ybGRWZXJ0aWNlc1tzai5mYWNlc1tpXVswXV1dOwogICAgICAgICAgY29uc3Qgbm9ybWFsID0gc2oud29ybGRGYWNlTm9ybWFsc1tpXTsgLy8gQ2hlY2sgaG93IG11Y2ggdGhlIHBhcnRpY2xlIHBlbmV0cmF0ZXMgdGhlIHBvbHlnb24gcGxhbmUuCgogICAgICAgICAgeGkudnN1Yih2ZXJ0c1swXSwgY29udmV4UGFydGljbGVfdmVydGV4VG9QYXJ0aWNsZSk7CiAgICAgICAgICBjb25zdCBwZW5ldHJhdGlvbiA9IC1ub3JtYWwuZG90KGNvbnZleFBhcnRpY2xlX3ZlcnRleFRvUGFydGljbGUpOwoKICAgICAgICAgIGlmIChtaW5QZW5ldHJhdGlvbiA9PT0gbnVsbCB8fCBNYXRoLmFicyhwZW5ldHJhdGlvbikgPCBNYXRoLmFicyhtaW5QZW5ldHJhdGlvbikpIHsKICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1pblBlbmV0cmF0aW9uID0gcGVuZXRyYXRpb247CiAgICAgICAgICAgIHBlbmV0cmF0ZWRGYWNlSW5kZXggPSBpOwogICAgICAgICAgICBwZW5ldHJhdGVkRmFjZU5vcm1hbC5jb3B5KG5vcm1hbCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAocGVuZXRyYXRlZEZhY2VJbmRleCAhPT0gLTEpIHsKICAgICAgICAgIC8vIFNldHVwIGNvbnRhY3QKICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSwgYmosIHNpLCBzaiwgcnNpLCByc2opOwogICAgICAgICAgcGVuZXRyYXRlZEZhY2VOb3JtYWwuc2NhbGUobWluUGVuZXRyYXRpb24sIHdvcmxkUGVuZXRyYXRpb25WZWMpOyAvLyByaiBpcyB0aGUgcGFydGljbGUgcG9zaXRpb24gcHJvamVjdGVkIHRvIHRoZSBmYWNlCgogICAgICAgICAgd29ybGRQZW5ldHJhdGlvblZlYy52YWRkKHhpLCB3b3JsZFBlbmV0cmF0aW9uVmVjKTsKICAgICAgICAgIHdvcmxkUGVuZXRyYXRpb25WZWMudnN1Yih4aiwgd29ybGRQZW5ldHJhdGlvblZlYyk7CiAgICAgICAgICByLnJqLmNvcHkod29ybGRQZW5ldHJhdGlvblZlYyk7IC8vY29uc3QgcHJvamVjdGVkVG9GYWNlID0geGkudnN1Yih4aikudmFkZCh3b3JsZFBlbmV0cmF0aW9uVmVjKTsKICAgICAgICAgIC8vcHJvamVjdGVkVG9GYWNlLmNvcHkoci5yaik7CiAgICAgICAgICAvL3FqLnZtdWx0KHIucmosci5yaik7CgogICAgICAgICAgcGVuZXRyYXRlZEZhY2VOb3JtYWwubmVnYXRlKHIubmkpOyAvLyBDb250YWN0IG5vcm1hbAoKICAgICAgICAgIHIucmkuc2V0KDAsIDAsIDApOyAvLyBDZW50ZXIgb2YgcGFydGljbGUKCiAgICAgICAgICBjb25zdCByaSA9IHIucmk7CiAgICAgICAgICBjb25zdCByaiA9IHIucmo7IC8vIE1ha2UgcmVsYXRpdmUgdG8gYm9kaWVzCgogICAgICAgICAgcmkudmFkZCh4aSwgcmkpOwogICAgICAgICAgcmkudnN1YihiaS5wb3NpdGlvbiwgcmkpOwogICAgICAgICAgcmoudmFkZCh4aiwgcmopOwogICAgICAgICAgcmoudnN1Yihiai5wb3NpdGlvbiwgcmopOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS53YXJuKCdQb2ludCBmb3VuZCBpbnNpZGUgY29udmV4LCBidXQgZGlkIG5vdCBmaW5kIHBlbmV0cmF0aW5nIGZhY2UhJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaGVpZ2h0ZmllbGRDeWxpbmRlcihoZlNoYXBlLCBjb252ZXhTaGFwZSwgaGZQb3MsIGNvbnZleFBvcywgaGZRdWF0LCBjb252ZXhRdWF0LCBoZkJvZHksIGNvbnZleEJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhIZWlnaHRmaWVsZChjb252ZXhTaGFwZSwgaGZTaGFwZSwgY29udmV4UG9zLCBoZlBvcywgY29udmV4UXVhdCwgaGZRdWF0LCBjb252ZXhCb2R5LCBoZkJvZHksIHJzaSwgcnNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgcGFydGljbGVDeWxpbmRlcihzaSwgc2osIHhpLCB4aiwgcWksIHFqLCBiaSwgYmosIHJzaSwgcnNqLCBqdXN0VGVzdCkgewogICAgICByZXR1cm4gdGhpcy5jb252ZXhQYXJ0aWNsZShzaiwgc2ksIHhqLCB4aSwgcWosIHFpLCBiaiwgYmksIHJzaSwgcnNqLCBqdXN0VGVzdCk7CiAgICB9CgogICAgc3BoZXJlVHJpbWVzaChzcGhlcmVTaGFwZSwgdHJpbWVzaFNoYXBlLCBzcGhlcmVQb3MsIHRyaW1lc2hQb3MsIHNwaGVyZVF1YXQsIHRyaW1lc2hRdWF0LCBzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgcnNpLCByc2osIGp1c3RUZXN0KSB7CiAgICAgIGNvbnN0IGVkZ2VWZXJ0ZXhBID0gc3BoZXJlVHJpbWVzaF9lZGdlVmVydGV4QTsKICAgICAgY29uc3QgZWRnZVZlcnRleEIgPSBzcGhlcmVUcmltZXNoX2VkZ2VWZXJ0ZXhCOwogICAgICBjb25zdCBlZGdlVmVjdG9yID0gc3BoZXJlVHJpbWVzaF9lZGdlVmVjdG9yOwogICAgICBjb25zdCBlZGdlVmVjdG9yVW5pdCA9IHNwaGVyZVRyaW1lc2hfZWRnZVZlY3RvclVuaXQ7CiAgICAgIGNvbnN0IGxvY2FsU3BoZXJlUG9zID0gc3BoZXJlVHJpbWVzaF9sb2NhbFNwaGVyZVBvczsKICAgICAgY29uc3QgdG1wID0gc3BoZXJlVHJpbWVzaF90bXA7CiAgICAgIGNvbnN0IGxvY2FsU3BoZXJlQUFCQiA9IHNwaGVyZVRyaW1lc2hfbG9jYWxTcGhlcmVBQUJCOwogICAgICBjb25zdCB2MiA9IHNwaGVyZVRyaW1lc2hfdjI7CiAgICAgIGNvbnN0IHJlbHBvcyA9IHNwaGVyZVRyaW1lc2hfcmVscG9zOwogICAgICBjb25zdCB0cmlhbmdsZXMgPSBzcGhlcmVUcmltZXNoX3RyaWFuZ2xlczsgLy8gQ29udmVydCBzcGhlcmUgcG9zaXRpb24gdG8gbG9jYWwgaW4gdGhlIHRyaW1lc2gKCiAgICAgIFRyYW5zZm9ybS5wb2ludFRvTG9jYWxGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgc3BoZXJlUG9zLCBsb2NhbFNwaGVyZVBvcyk7IC8vIEdldCB0aGUgYWFiYiBvZiB0aGUgc3BoZXJlIGxvY2FsbHkgaW4gdGhlIHRyaW1lc2gKCiAgICAgIGNvbnN0IHNwaGVyZVJhZGl1cyA9IHNwaGVyZVNoYXBlLnJhZGl1czsKICAgICAgbG9jYWxTcGhlcmVBQUJCLmxvd2VyQm91bmQuc2V0KGxvY2FsU3BoZXJlUG9zLnggLSBzcGhlcmVSYWRpdXMsIGxvY2FsU3BoZXJlUG9zLnkgLSBzcGhlcmVSYWRpdXMsIGxvY2FsU3BoZXJlUG9zLnogLSBzcGhlcmVSYWRpdXMpOwogICAgICBsb2NhbFNwaGVyZUFBQkIudXBwZXJCb3VuZC5zZXQobG9jYWxTcGhlcmVQb3MueCArIHNwaGVyZVJhZGl1cywgbG9jYWxTcGhlcmVQb3MueSArIHNwaGVyZVJhZGl1cywgbG9jYWxTcGhlcmVQb3MueiArIHNwaGVyZVJhZGl1cyk7CiAgICAgIHRyaW1lc2hTaGFwZS5nZXRUcmlhbmdsZXNJbkFBQkIobG9jYWxTcGhlcmVBQUJCLCB0cmlhbmdsZXMpOyAvL2ZvciAobGV0IGkgPSAwOyBpIDwgdHJpbWVzaFNoYXBlLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB0cmlhbmdsZXMucHVzaChpKTsgLy8gQWxsCiAgICAgIC8vIFZlcnRpY2VzCgogICAgICBjb25zdCB2ID0gc3BoZXJlVHJpbWVzaF92OwogICAgICBjb25zdCByYWRpdXNTcXVhcmVkID0gc3BoZXJlU2hhcGUucmFkaXVzICogc3BoZXJlU2hhcGUucmFkaXVzOwoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmlhbmdsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDM7IGorKykgewogICAgICAgICAgdHJpbWVzaFNoYXBlLmdldFZlcnRleCh0cmltZXNoU2hhcGUuaW5kaWNlc1t0cmlhbmdsZXNbaV0gKiAzICsgal0sIHYpOyAvLyBDaGVjayB2ZXJ0ZXggb3ZlcmxhcCBpbiBzcGhlcmUKCiAgICAgICAgICB2LnZzdWIobG9jYWxTcGhlcmVQb3MsIHJlbHBvcyk7CgogICAgICAgICAgaWYgKHJlbHBvcy5sZW5ndGhTcXVhcmVkKCkgPD0gcmFkaXVzU3F1YXJlZCkgewogICAgICAgICAgICAvLyBTYWZlIHVwCiAgICAgICAgICAgIHYyLmNvcHkodik7CiAgICAgICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgdjIsIHYpOwogICAgICAgICAgICB2LnZzdWIoc3BoZXJlUG9zLCByZWxwb3MpOwoKICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24oc3BoZXJlQm9keSwgdHJpbWVzaEJvZHksIHNwaGVyZVNoYXBlLCB0cmltZXNoU2hhcGUsIHJzaSwgcnNqKTsKICAgICAgICAgICAgci5uaS5jb3B5KHJlbHBvcyk7CiAgICAgICAgICAgIHIubmkubm9ybWFsaXplKCk7IC8vIHJpIGlzIHRoZSB2ZWN0b3IgZnJvbSBzcGhlcmUgY2VudGVyIHRvIHRoZSBzcGhlcmUgc3VyZmFjZQoKICAgICAgICAgICAgci5yaS5jb3B5KHIubmkpOwogICAgICAgICAgICByLnJpLnNjYWxlKHNwaGVyZVNoYXBlLnJhZGl1cywgci5yaSk7CiAgICAgICAgICAgIHIucmkudmFkZChzcGhlcmVQb3MsIHIucmkpOwogICAgICAgICAgICByLnJpLnZzdWIoc3BoZXJlQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgIHIucmouY29weSh2KTsKICAgICAgICAgICAgci5yai52c3ViKHRyaW1lc2hCb2R5LnBvc2l0aW9uLCByLnJqKTsgLy8gU3RvcmUgcmVzdWx0CgogICAgICAgICAgICB0aGlzLnJlc3VsdC5wdXNoKHIpOwogICAgICAgICAgICB0aGlzLmNyZWF0ZUZyaWN0aW9uRXF1YXRpb25zRnJvbUNvbnRhY3QociwgdGhpcy5mcmljdGlvblJlc3VsdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIENoZWNrIGFsbCBlZGdlcwoKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdHJpYW5nbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAzOyBqKyspIHsKICAgICAgICAgIHRyaW1lc2hTaGFwZS5nZXRWZXJ0ZXgodHJpbWVzaFNoYXBlLmluZGljZXNbdHJpYW5nbGVzW2ldICogMyArIGpdLCBlZGdlVmVydGV4QSk7CiAgICAgICAgICB0cmltZXNoU2hhcGUuZ2V0VmVydGV4KHRyaW1lc2hTaGFwZS5pbmRpY2VzW3RyaWFuZ2xlc1tpXSAqIDMgKyAoaiArIDEpICUgM10sIGVkZ2VWZXJ0ZXhCKTsKICAgICAgICAgIGVkZ2VWZXJ0ZXhCLnZzdWIoZWRnZVZlcnRleEEsIGVkZ2VWZWN0b3IpOyAvLyBQcm9qZWN0IHNwaGVyZSBwb3NpdGlvbiB0byB0aGUgZWRnZQoKICAgICAgICAgIGxvY2FsU3BoZXJlUG9zLnZzdWIoZWRnZVZlcnRleEIsIHRtcCk7CiAgICAgICAgICBjb25zdCBwb3NpdGlvbkFsb25nRWRnZUIgPSB0bXAuZG90KGVkZ2VWZWN0b3IpOwogICAgICAgICAgbG9jYWxTcGhlcmVQb3MudnN1YihlZGdlVmVydGV4QSwgdG1wKTsKICAgICAgICAgIGxldCBwb3NpdGlvbkFsb25nRWRnZUEgPSB0bXAuZG90KGVkZ2VWZWN0b3IpOwoKICAgICAgICAgIGlmIChwb3NpdGlvbkFsb25nRWRnZUEgPiAwICYmIHBvc2l0aW9uQWxvbmdFZGdlQiA8IDApIHsKICAgICAgICAgICAgLy8gTm93IGNoZWNrIHRoZSBvcnRob2dvbmFsIGRpc3RhbmNlIGZyb20gZWRnZSB0byBzcGhlcmUgY2VudGVyCiAgICAgICAgICAgIGxvY2FsU3BoZXJlUG9zLnZzdWIoZWRnZVZlcnRleEEsIHRtcCk7CiAgICAgICAgICAgIGVkZ2VWZWN0b3JVbml0LmNvcHkoZWRnZVZlY3Rvcik7CiAgICAgICAgICAgIGVkZ2VWZWN0b3JVbml0Lm5vcm1hbGl6ZSgpOwogICAgICAgICAgICBwb3NpdGlvbkFsb25nRWRnZUEgPSB0bXAuZG90KGVkZ2VWZWN0b3JVbml0KTsKICAgICAgICAgICAgZWRnZVZlY3RvclVuaXQuc2NhbGUocG9zaXRpb25BbG9uZ0VkZ2VBLCB0bXApOwogICAgICAgICAgICB0bXAudmFkZChlZGdlVmVydGV4QSwgdG1wKTsgLy8gdG1wIGlzIG5vdyB0aGUgc3BoZXJlIGNlbnRlciBwb3NpdGlvbiBwcm9qZWN0ZWQgdG8gdGhlIGVkZ2UsIGRlZmluZWQgbG9jYWxseSBpbiB0aGUgdHJpbWVzaCBmcmFtZQoKICAgICAgICAgICAgY29uc3QgZGlzdCA9IHRtcC5kaXN0YW5jZVRvKGxvY2FsU3BoZXJlUG9zKTsKCiAgICAgICAgICAgIGlmIChkaXN0IDwgc3BoZXJlU2hhcGUucmFkaXVzKSB7CiAgICAgICAgICAgICAgaWYgKGp1c3RUZXN0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgc3BoZXJlU2hhcGUsIHRyaW1lc2hTaGFwZSwgcnNpLCByc2opOwogICAgICAgICAgICAgIHRtcC52c3ViKGxvY2FsU3BoZXJlUG9zLCByLm5pKTsKICAgICAgICAgICAgICByLm5pLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICAgIHIubmkuc2NhbGUoc3BoZXJlU2hhcGUucmFkaXVzLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZhZGQoc3BoZXJlUG9zLCByLnJpKTsKICAgICAgICAgICAgICByLnJpLnZzdWIoc3BoZXJlQm9keS5wb3NpdGlvbiwgci5yaSk7CiAgICAgICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHRyaW1lc2hQb3MsIHRyaW1lc2hRdWF0LCB0bXAsIHRtcCk7CiAgICAgICAgICAgICAgdG1wLnZzdWIodHJpbWVzaEJvZHkucG9zaXRpb24sIHIucmopOwogICAgICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIubmksIHIubmkpOwogICAgICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIucmksIHIucmkpOwogICAgICAgICAgICAgIHRoaXMucmVzdWx0LnB1c2gocik7CiAgICAgICAgICAgICAgdGhpcy5jcmVhdGVGcmljdGlvbkVxdWF0aW9uc0Zyb21Db250YWN0KHIsIHRoaXMuZnJpY3Rpb25SZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IC8vIFRyaWFuZ2xlIGZhY2VzCgoKICAgICAgY29uc3QgdmEgPSBzcGhlcmVUcmltZXNoX3ZhOwogICAgICBjb25zdCB2YiA9IHNwaGVyZVRyaW1lc2hfdmI7CiAgICAgIGNvbnN0IHZjID0gc3BoZXJlVHJpbWVzaF92YzsKICAgICAgY29uc3Qgbm9ybWFsID0gc3BoZXJlVHJpbWVzaF9ub3JtYWw7CgogICAgICBmb3IgKGxldCBpID0gMCwgTiA9IHRyaWFuZ2xlcy5sZW5ndGg7IGkgIT09IE47IGkrKykgewogICAgICAgIHRyaW1lc2hTaGFwZS5nZXRUcmlhbmdsZVZlcnRpY2VzKHRyaWFuZ2xlc1tpXSwgdmEsIHZiLCB2Yyk7CiAgICAgICAgdHJpbWVzaFNoYXBlLmdldE5vcm1hbCh0cmlhbmdsZXNbaV0sIG5vcm1hbCk7CiAgICAgICAgbG9jYWxTcGhlcmVQb3MudnN1Yih2YSwgdG1wKTsKICAgICAgICBsZXQgZGlzdCA9IHRtcC5kb3Qobm9ybWFsKTsKICAgICAgICBub3JtYWwuc2NhbGUoZGlzdCwgdG1wKTsKICAgICAgICBsb2NhbFNwaGVyZVBvcy52c3ViKHRtcCwgdG1wKTsgLy8gdG1wIGlzIG5vdyB0aGUgc3BoZXJlIHBvc2l0aW9uIHByb2plY3RlZCB0byB0aGUgdHJpYW5nbGUgcGxhbmUKCiAgICAgICAgZGlzdCA9IHRtcC5kaXN0YW5jZVRvKGxvY2FsU3BoZXJlUG9zKTsKCiAgICAgICAgaWYgKFJheS5wb2ludEluVHJpYW5nbGUodG1wLCB2YSwgdmIsIHZjKSAmJiBkaXN0IDwgc3BoZXJlU2hhcGUucmFkaXVzKSB7CiAgICAgICAgICBpZiAoanVzdFRlc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgbGV0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihzcGhlcmVCb2R5LCB0cmltZXNoQm9keSwgc3BoZXJlU2hhcGUsIHRyaW1lc2hTaGFwZSwgcnNpLCByc2opOwogICAgICAgICAgdG1wLnZzdWIobG9jYWxTcGhlcmVQb3MsIHIubmkpOwogICAgICAgICAgci5uaS5ub3JtYWxpemUoKTsKICAgICAgICAgIHIubmkuc2NhbGUoc3BoZXJlU2hhcGUucmFkaXVzLCByLnJpKTsKICAgICAgICAgIHIucmkudmFkZChzcGhlcmVQb3MsIHIucmkpOwogICAgICAgICAgci5yaS52c3ViKHNwaGVyZUJvZHkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgVHJhbnNmb3JtLnBvaW50VG9Xb3JsZEZyYW1lKHRyaW1lc2hQb3MsIHRyaW1lc2hRdWF0LCB0bXAsIHRtcCk7CiAgICAgICAgICB0bXAudnN1Yih0cmltZXNoQm9keS5wb3NpdGlvbiwgci5yaik7CiAgICAgICAgICBUcmFuc2Zvcm0udmVjdG9yVG9Xb3JsZEZyYW1lKHRyaW1lc2hRdWF0LCByLm5pLCByLm5pKTsKICAgICAgICAgIFRyYW5zZm9ybS52ZWN0b3JUb1dvcmxkRnJhbWUodHJpbWVzaFF1YXQsIHIucmksIHIucmkpOwogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRyaWFuZ2xlcy5sZW5ndGggPSAwOwogICAgfQoKICAgIHBsYW5lVHJpbWVzaChwbGFuZVNoYXBlLCB0cmltZXNoU2hhcGUsIHBsYW5lUG9zLCB0cmltZXNoUG9zLCBwbGFuZVF1YXQsIHRyaW1lc2hRdWF0LCBwbGFuZUJvZHksIHRyaW1lc2hCb2R5LCByc2ksIHJzaiwganVzdFRlc3QpIHsKICAgICAgLy8gTWFrZSBjb250YWN0cyEKICAgICAgY29uc3QgdiA9IG5ldyBWZWMzKCk7CiAgICAgIGNvbnN0IG5vcm1hbCA9IHBsYW5lVHJpbWVzaF9ub3JtYWw7CiAgICAgIG5vcm1hbC5zZXQoMCwgMCwgMSk7CiAgICAgIHBsYW5lUXVhdC52bXVsdChub3JtYWwsIG5vcm1hbCk7IC8vIFR1cm4gbm9ybWFsIGFjY29yZGluZyB0byBwbGFuZQoKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmltZXNoU2hhcGUudmVydGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAgICAgLy8gR2V0IHdvcmxkIHZlcnRleCBmcm9tIHRyaW1lc2gKICAgICAgICB0cmltZXNoU2hhcGUuZ2V0VmVydGV4KGksIHYpOyAvLyBTYWZlIHVwCgogICAgICAgIGNvbnN0IHYyID0gbmV3IFZlYzMoKTsKICAgICAgICB2Mi5jb3B5KHYpOwogICAgICAgIFRyYW5zZm9ybS5wb2ludFRvV29ybGRGcmFtZSh0cmltZXNoUG9zLCB0cmltZXNoUXVhdCwgdjIsIHYpOyAvLyBDaGVjayBwbGFuZSBzaWRlCgogICAgICAgIGNvbnN0IHJlbHBvcyA9IHBsYW5lVHJpbWVzaF9yZWxwb3M7CiAgICAgICAgdi52c3ViKHBsYW5lUG9zLCByZWxwb3MpOwogICAgICAgIGNvbnN0IGRvdCA9IG5vcm1hbC5kb3QocmVscG9zKTsKCiAgICAgICAgaWYgKGRvdCA8PSAwLjApIHsKICAgICAgICAgIGlmIChqdXN0VGVzdCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVDb250YWN0RXF1YXRpb24ocGxhbmVCb2R5LCB0cmltZXNoQm9keSwgcGxhbmVTaGFwZSwgdHJpbWVzaFNoYXBlLCByc2ksIHJzaik7CiAgICAgICAgICByLm5pLmNvcHkobm9ybWFsKTsgLy8gQ29udGFjdCBub3JtYWwgaXMgdGhlIHBsYW5lIG5vcm1hbAogICAgICAgICAgLy8gR2V0IHZlcnRleCBwb3NpdGlvbiBwcm9qZWN0ZWQgb24gcGxhbmUKCiAgICAgICAgICBjb25zdCBwcm9qZWN0ZWQgPSBwbGFuZVRyaW1lc2hfcHJvamVjdGVkOwogICAgICAgICAgbm9ybWFsLnNjYWxlKHJlbHBvcy5kb3Qobm9ybWFsKSwgcHJvamVjdGVkKTsKICAgICAgICAgIHYudnN1Yihwcm9qZWN0ZWQsIHByb2plY3RlZCk7IC8vIHJpIGlzIHRoZSBwcm9qZWN0ZWQgd29ybGQgcG9zaXRpb24gbWludXMgcGxhbmUgcG9zaXRpb24KCiAgICAgICAgICByLnJpLmNvcHkocHJvamVjdGVkKTsKICAgICAgICAgIHIucmkudnN1YihwbGFuZUJvZHkucG9zaXRpb24sIHIucmkpOwogICAgICAgICAgci5yai5jb3B5KHYpOwogICAgICAgICAgci5yai52c3ViKHRyaW1lc2hCb2R5LnBvc2l0aW9uLCByLnJqKTsgLy8gU3RvcmUgcmVzdWx0CgogICAgICAgICAgdGhpcy5yZXN1bHQucHVzaChyKTsKICAgICAgICAgIHRoaXMuY3JlYXRlRnJpY3Rpb25FcXVhdGlvbnNGcm9tQ29udGFjdChyLCB0aGlzLmZyaWN0aW9uUmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gLy8gY29udmV4VHJpbWVzaCgKICAgIC8vICAgc2k6IENvbnZleFBvbHloZWRyb24sIHNqOiBUcmltZXNoLCB4aTogVmVjMywgeGo6IFZlYzMsIHFpOiBRdWF0ZXJuaW9uLCBxajogUXVhdGVybmlvbiwKICAgIC8vICAgYmk6IEJvZHksIGJqOiBCb2R5LCByc2k/OiBTaGFwZSB8IG51bGwsIHJzaj86IFNoYXBlIHwgbnVsbCwKICAgIC8vICAgZmFjZUxpc3RBPzogbnVtYmVyW10gfCBudWxsLCBmYWNlTGlzdEI/OiBudW1iZXJbXSB8IG51bGwsCiAgICAvLyApIHsKICAgIC8vICAgY29uc3Qgc2VwQXhpcyA9IGNvbnZleENvbnZleF9zZXBBeGlzOwogICAgLy8gICBpZih4aS5kaXN0YW5jZVRvKHhqKSA+IHNpLmJvdW5kaW5nU3BoZXJlUmFkaXVzICsgc2ouYm91bmRpbmdTcGhlcmVSYWRpdXMpewogICAgLy8gICAgICAgcmV0dXJuOwogICAgLy8gICB9CiAgICAvLyAgIC8vIENvbnN0cnVjdCBhIHRlbXAgaHVsbCBmb3IgZWFjaCB0cmlhbmdsZQogICAgLy8gICBjb25zdCBodWxsQiA9IG5ldyBDb252ZXhQb2x5aGVkcm9uKCk7CiAgICAvLyAgIGh1bGxCLmZhY2VzID0gW1swLDEsMl1dOwogICAgLy8gICBjb25zdCB2YSA9IG5ldyBWZWMzKCk7CiAgICAvLyAgIGNvbnN0IHZiID0gbmV3IFZlYzMoKTsKICAgIC8vICAgY29uc3QgdmMgPSBuZXcgVmVjMygpOwogICAgLy8gICBodWxsQi52ZXJ0aWNlcyA9IFsKICAgIC8vICAgICAgIHZhLAogICAgLy8gICAgICAgdmIsCiAgICAvLyAgICAgICB2YwogICAgLy8gICBdOwogICAgLy8gICBmb3IgKGxldCBpID0gMDsgaSA8IHNqLmluZGljZXMubGVuZ3RoIC8gMzsgaSsrKSB7CiAgICAvLyAgICAgICBjb25zdCB0cmlhbmdsZU5vcm1hbCA9IG5ldyBWZWMzKCk7CiAgICAvLyAgICAgICBzai5nZXROb3JtYWwoaSwgdHJpYW5nbGVOb3JtYWwpOwogICAgLy8gICAgICAgaHVsbEIuZmFjZU5vcm1hbHMgPSBbdHJpYW5nbGVOb3JtYWxdOwogICAgLy8gICAgICAgc2ouZ2V0VHJpYW5nbGVWZXJ0aWNlcyhpLCB2YSwgdmIsIHZjKTsKICAgIC8vICAgICAgIGxldCBkID0gc2kudGVzdFNlcEF4aXModHJpYW5nbGVOb3JtYWwsIGh1bGxCLCB4aSwgcWksIHhqLCBxaik7CiAgICAvLyAgICAgICBpZighZCl7CiAgICAvLyAgICAgICAgICAgdHJpYW5nbGVOb3JtYWwuc2NhbGUoLTEsIHRyaWFuZ2xlTm9ybWFsKTsKICAgIC8vICAgICAgICAgICBkID0gc2kudGVzdFNlcEF4aXModHJpYW5nbGVOb3JtYWwsIGh1bGxCLCB4aSwgcWksIHhqLCBxaik7CiAgICAvLyAgICAgICAgICAgaWYoIWQpewogICAgLy8gICAgICAgICAgICAgICBjb250aW51ZTsKICAgIC8vICAgICAgICAgICB9CiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgICBjb25zdCByZXM6IENvbnZleFBvbHloZWRyb25Db250YWN0UG9pbnRbXSA9IFtdOwogICAgLy8gICAgICAgY29uc3QgcSA9IGNvbnZleENvbnZleF9xOwogICAgLy8gICAgICAgc2kuY2xpcEFnYWluc3RIdWxsKHhpLHFpLGh1bGxCLHhqLHFqLHRyaWFuZ2xlTm9ybWFsLC0xMDAsMTAwLHJlcyk7CiAgICAvLyAgICAgICBmb3IobGV0IGogPSAwOyBqICE9PSByZXMubGVuZ3RoOyBqKyspewogICAgLy8gICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNyZWF0ZUNvbnRhY3RFcXVhdGlvbihiaSxiaixzaSxzaixyc2kscnNqKSwKICAgIC8vICAgICAgICAgICAgICAgcmkgPSByLnJpLAogICAgLy8gICAgICAgICAgICAgICByaiA9IHIucmo7CiAgICAvLyAgICAgICAgICAgci5uaS5jb3B5KHRyaWFuZ2xlTm9ybWFsKTsKICAgIC8vICAgICAgICAgICByLm5pLm5lZ2F0ZShyLm5pKTsKICAgIC8vICAgICAgICAgICByZXNbal0ubm9ybWFsLm5lZ2F0ZShxKTsKICAgIC8vICAgICAgICAgICBxLm11bHQocmVzW2pdLmRlcHRoLCBxKTsKICAgIC8vICAgICAgICAgICByZXNbal0ucG9pbnQudmFkZChxLCByaSk7CiAgICAvLyAgICAgICAgICAgcmouY29weShyZXNbal0ucG9pbnQpOwogICAgLy8gICAgICAgICAgIC8vIENvbnRhY3QgcG9pbnRzIGFyZSBpbiB3b3JsZCBjb29yZGluYXRlcy4gVHJhbnNmb3JtIGJhY2sgdG8gcmVsYXRpdmUKICAgIC8vICAgICAgICAgICByaS52c3ViKHhpLHJpKTsKICAgIC8vICAgICAgICAgICByai52c3ViKHhqLHJqKTsKICAgIC8vICAgICAgICAgICAvLyBNYWtlIHJlbGF0aXZlIHRvIGJvZGllcwogICAgLy8gICAgICAgICAgIHJpLnZhZGQoeGksIHJpKTsKICAgIC8vICAgICAgICAgICByaS52c3ViKGJpLnBvc2l0aW9uLCByaSk7CiAgICAvLyAgICAgICAgICAgcmoudmFkZCh4aiwgcmopOwogICAgLy8gICAgICAgICAgIHJqLnZzdWIoYmoucG9zaXRpb24sIHJqKTsKICAgIC8vICAgICAgICAgICByZXN1bHQucHVzaChyKTsKICAgIC8vICAgICAgIH0KICAgIC8vICAgfQogICAgLy8gfQoKCiAgfQoKICBjb25zdCBhdmVyYWdlTm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBhdmVyYWdlQ29udGFjdFBvaW50QSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgYXZlcmFnZUNvbnRhY3RQb2ludEIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFZlYzIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHRtcFF1YXQxID0gbmV3IFF1YXRlcm5pb24oKTsKICBjb25zdCB0bXBRdWF0MiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgY29uc3QgcGxhbmVUcmltZXNoX25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVUcmltZXNoX3JlbHBvcyA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVUcmltZXNoX3Byb2plY3RlZCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9ub3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfcmVscG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX3YgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdjIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfZWRnZVZlcnRleEEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfZWRnZVZlcnRleEIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfZWRnZVZlY3RvciA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9lZGdlVmVjdG9yVW5pdCA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF9sb2NhbFNwaGVyZVBvcyA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlVHJpbWVzaF90bXAgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdmEgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdmIgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfdmMgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZVRyaW1lc2hfbG9jYWxTcGhlcmVBQUJCID0gbmV3IEFBQkIoKTsKICBjb25zdCBzcGhlcmVUcmltZXNoX3RyaWFuZ2xlcyA9IFtdOwogIGNvbnN0IHBvaW50X29uX3BsYW5lX3RvX3NwaGVyZSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVfdG9fc3BoZXJlX29ydGhvID0gbmV3IFZlYzMoKTsgLy8gU2VlIGh0dHA6Ly9idWxsZXRwaHlzaWNzLmNvbS9CdWxsZXQvQnVsbGV0RnVsbC9TcGhlcmVUcmlhbmdsZURldGVjdG9yXzhjcHBfc291cmNlLmh0bWwKCiAgY29uc3QgcG9pbnRJblBvbHlnb25fZWRnZSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcG9pbnRJblBvbHlnb25fZWRnZV94X25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcG9pbnRJblBvbHlnb25fdnRwID0gbmV3IFZlYzMoKTsKCiAgZnVuY3Rpb24gcG9pbnRJblBvbHlnb24odmVydHMsIG5vcm1hbCwgcCkgewogICAgbGV0IHBvc2l0aXZlUmVzdWx0ID0gbnVsbDsKICAgIGNvbnN0IE4gPSB2ZXJ0cy5sZW5ndGg7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICBjb25zdCB2ID0gdmVydHNbaV07IC8vIEdldCBlZGdlIHRvIHRoZSBuZXh0IHZlcnRleAoKICAgICAgY29uc3QgZWRnZSA9IHBvaW50SW5Qb2x5Z29uX2VkZ2U7CiAgICAgIHZlcnRzWyhpICsgMSkgJSBOXS52c3ViKHYsIGVkZ2UpOyAvLyBHZXQgY3Jvc3MgcHJvZHVjdCBiZXR3ZWVuIHBvbHlnb24gbm9ybWFsIGFuZCB0aGUgZWRnZQoKICAgICAgY29uc3QgZWRnZV94X25vcm1hbCA9IHBvaW50SW5Qb2x5Z29uX2VkZ2VfeF9ub3JtYWw7IC8vY29uc3QgZWRnZV94X25vcm1hbCA9IG5ldyBWZWMzKCk7CgogICAgICBlZGdlLmNyb3NzKG5vcm1hbCwgZWRnZV94X25vcm1hbCk7IC8vIEdldCB2ZWN0b3IgYmV0d2VlbiBwb2ludCBhbmQgY3VycmVudCB2ZXJ0ZXgKCiAgICAgIGNvbnN0IHZlcnRleF90b19wID0gcG9pbnRJblBvbHlnb25fdnRwOwogICAgICBwLnZzdWIodiwgdmVydGV4X3RvX3ApOyAvLyBUaGlzIGRvdCBwcm9kdWN0IGRldGVybWluZXMgd2hpY2ggc2lkZSBvZiB0aGUgZWRnZSB0aGUgcG9pbnQgaXMKCiAgICAgIGNvbnN0IHIgPSBlZGdlX3hfbm9ybWFsLmRvdCh2ZXJ0ZXhfdG9fcCk7IC8vIElmIGFsbCBzdWNoIGRvdCBwcm9kdWN0cyBoYXZlIHNhbWUgc2lnbiwgd2UgYXJlIGluc2lkZSB0aGUgcG9seWdvbi4KCiAgICAgIGlmIChwb3NpdGl2ZVJlc3VsdCA9PT0gbnVsbCB8fCByID4gMCAmJiBwb3NpdGl2ZVJlc3VsdCA9PT0gdHJ1ZSB8fCByIDw9IDAgJiYgcG9zaXRpdmVSZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgaWYgKHBvc2l0aXZlUmVzdWx0ID09PSBudWxsKSB7CiAgICAgICAgICBwb3NpdGl2ZVJlc3VsdCA9IHIgPiAwOwogICAgICAgIH0KCiAgICAgICAgY29udGludWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBFbmNvdW50ZXJlZCBzb21lIG90aGVyIHNpZ24uIEV4aXQuCiAgICAgIH0KICAgIH0gLy8gSWYgd2UgZ290IGhlcmUsIGFsbCBkb3QgcHJvZHVjdHMgd2VyZSBvZiB0aGUgc2FtZSBzaWduLgoKCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGNvbnN0IGJveF90b19zcGhlcmUgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUJveF9ucyA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQm94X25zMSA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQm94X25zMiA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQm94X3NpZGVzID0gW25ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCksIG5ldyBWZWMzKCldOwogIGNvbnN0IHNwaGVyZUJveF9zcGhlcmVfdG9fY29ybmVyID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfc2lkZV9ucyA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQm94X3NpZGVfbnMxID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVCb3hfc2lkZV9uczIgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleF90b19zcGhlcmUgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF9lZGdlID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVDb252ZXhfZWRnZVVuaXQgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF9zcGhlcmVUb0Nvcm5lciA9IG5ldyBWZWMzKCk7CiAgY29uc3Qgc3BoZXJlQ29udmV4X3dvcmxkQ29ybmVyID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVDb252ZXhfd29ybGROb3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF93b3JsZFBvaW50ID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVDb252ZXhfd29ybGRTcGhlcmVQb2ludENsb3Nlc3RUb1BsYW5lID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVDb252ZXhfcGVuZXRyYXRpb25WZWMgPSBuZXcgVmVjMygpOwogIGNvbnN0IHNwaGVyZUNvbnZleF9zcGhlcmVUb1dvcmxkUG9pbnQgPSBuZXcgVmVjMygpOwogIGNvbnN0IHBsYW5lQ29udmV4X3YgPSBuZXcgVmVjMygpOwogIGNvbnN0IHBsYW5lQ29udmV4X25vcm1hbCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGxhbmVDb252ZXhfcmVscG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBwbGFuZUNvbnZleF9wcm9qZWN0ZWQgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleENvbnZleF9zZXBBeGlzID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhDb252ZXhfcSA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGFydGljbGVQbGFuZV9ub3JtYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IHBhcnRpY2xlUGxhbmVfcmVscG9zID0gbmV3IFZlYzMoKTsKICBjb25zdCBwYXJ0aWNsZVBsYW5lX3Byb2plY3RlZCA9IG5ldyBWZWMzKCk7CiAgY29uc3QgcGFydGljbGVTcGhlcmVfbm9ybWFsID0gbmV3IFZlYzMoKTsgLy8gV0lQCgogIGNvbnN0IGNxaiA9IG5ldyBRdWF0ZXJuaW9uKCk7CiAgY29uc3QgY29udmV4UGFydGljbGVfbG9jYWwgPSBuZXcgVmVjMygpOwogIGNvbnN0IGNvbnZleFBhcnRpY2xlX3BlbmV0cmF0ZWRGYWNlTm9ybWFsID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhQYXJ0aWNsZV92ZXJ0ZXhUb1BhcnRpY2xlID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhQYXJ0aWNsZV93b3JsZFBlbmV0cmF0aW9uVmVjID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhIZWlnaHRmaWVsZF90bXAxID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhIZWlnaHRmaWVsZF90bXAyID0gbmV3IFZlYzMoKTsKICBjb25zdCBjb252ZXhIZWlnaHRmaWVsZF9mYWNlTGlzdCA9IFswXTsKICBjb25zdCBzcGhlcmVIZWlnaHRmaWVsZF90bXAxID0gbmV3IFZlYzMoKTsKICBjb25zdCBzcGhlcmVIZWlnaHRmaWVsZF90bXAyID0gbmV3IFZlYzMoKTsKCiAgY2xhc3MgT3ZlcmxhcEtlZXBlciB7CiAgICAvKioKICAgICAqIEB0b2RvIFJlbW92ZSB1c2VsZXNzIGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIGNvbnN0cnVjdG9yKCkgewogICAgICB0aGlzLmN1cnJlbnQgPSB2b2lkIDA7CiAgICAgIHRoaXMucHJldmlvdXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuY3VycmVudCA9IFtdOwogICAgICB0aGlzLnByZXZpb3VzID0gW107CiAgICB9CiAgICAvKioKICAgICAqIGdldEtleQogICAgICovCgoKICAgIGdldEtleShpLCBqKSB7CiAgICAgIGlmIChqIDwgaSkgewogICAgICAgIGNvbnN0IHRlbXAgPSBqOwogICAgICAgIGogPSBpOwogICAgICAgIGkgPSB0ZW1wOwogICAgICB9CgogICAgICByZXR1cm4gaSA8PCAxNiB8IGo7CiAgICB9CiAgICAvKioKICAgICAqIHNldAogICAgICovCgoKICAgIHNldChpLCBqKSB7CiAgICAgIC8vIEluc2VydGlvbiBzb3J0LiBUaGlzIHdheSB0aGUgZGlmZiB3aWxsIGhhdmUgbGluZWFyIGNvbXBsZXhpdHkuCiAgICAgIGNvbnN0IGtleSA9IHRoaXMuZ2V0S2V5KGksIGopOwogICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5jdXJyZW50OwogICAgICBsZXQgaW5kZXggPSAwOwoKICAgICAgd2hpbGUgKGtleSA+IGN1cnJlbnRbaW5kZXhdKSB7CiAgICAgICAgaW5kZXgrKzsKICAgICAgfQoKICAgICAgaWYgKGtleSA9PT0gY3VycmVudFtpbmRleF0pIHsKICAgICAgICByZXR1cm47IC8vIFBhaXIgd2FzIGFscmVhZHkgYWRkZWQKICAgICAgfQoKICAgICAgZm9yIChsZXQgaiA9IGN1cnJlbnQubGVuZ3RoIC0gMTsgaiA+PSBpbmRleDsgai0tKSB7CiAgICAgICAgY3VycmVudFtqICsgMV0gPSBjdXJyZW50W2pdOwogICAgICB9CgogICAgICBjdXJyZW50W2luZGV4XSA9IGtleTsKICAgIH0KICAgIC8qKgogICAgICogdGljawogICAgICovCgoKICAgIHRpY2soKSB7CiAgICAgIGNvbnN0IHRtcCA9IHRoaXMuY3VycmVudDsKICAgICAgdGhpcy5jdXJyZW50ID0gdGhpcy5wcmV2aW91czsKICAgICAgdGhpcy5wcmV2aW91cyA9IHRtcDsKICAgICAgdGhpcy5jdXJyZW50Lmxlbmd0aCA9IDA7CiAgICB9CiAgICAvKioKICAgICAqIGdldERpZmYKICAgICAqLwoKCiAgICBnZXREaWZmKGFkZGl0aW9ucywgcmVtb3ZhbHMpIHsKICAgICAgY29uc3QgYSA9IHRoaXMuY3VycmVudDsKICAgICAgY29uc3QgYiA9IHRoaXMucHJldmlvdXM7CiAgICAgIGNvbnN0IGFsID0gYS5sZW5ndGg7CiAgICAgIGNvbnN0IGJsID0gYi5sZW5ndGg7CiAgICAgIGxldCBqID0gMDsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWw7IGkrKykgewogICAgICAgIGxldCBmb3VuZCA9IGZhbHNlOwogICAgICAgIGNvbnN0IGtleUEgPSBhW2ldOwoKICAgICAgICB3aGlsZSAoa2V5QSA+IGJbal0pIHsKICAgICAgICAgIGorKzsKICAgICAgICB9CgogICAgICAgIGZvdW5kID0ga2V5QSA9PT0gYltqXTsKCiAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgdW5wYWNrQW5kUHVzaChhZGRpdGlvbnMsIGtleUEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaiA9IDA7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJsOyBpKyspIHsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBjb25zdCBrZXlCID0gYltpXTsKCiAgICAgICAgd2hpbGUgKGtleUIgPiBhW2pdKSB7CiAgICAgICAgICBqKys7CiAgICAgICAgfQoKICAgICAgICBmb3VuZCA9IGFbal0gPT09IGtleUI7CgogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIHVucGFja0FuZFB1c2gocmVtb3ZhbHMsIGtleUIpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICB9CgogIGZ1bmN0aW9uIHVucGFja0FuZFB1c2goYXJyYXksIGtleSkgewogICAgYXJyYXkucHVzaCgoa2V5ICYgMHhmZmZmMDAwMCkgPj4gMTYsIGtleSAmIDB4MDAwMGZmZmYpOwogIH0KICAvKioKICAgKiBUdXBsZURpY3Rpb25hcnkKICAgKi8KCgogIGNsYXNzIFR1cGxlRGljdGlvbmFyeSB7CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5kYXRhID0gewogICAgICAgIGtleXM6IFtdCiAgICAgIH07CiAgICB9CiAgICAvKiogZ2V0ICovCgoKICAgIGdldChpLCBqKSB7CiAgICAgIGlmIChpID4gaikgewogICAgICAgIC8vIHN3YXAKICAgICAgICBjb25zdCB0ZW1wID0gajsKICAgICAgICBqID0gaTsKICAgICAgICBpID0gdGVtcDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuZGF0YVtpICsgIi0iICsgal07CiAgICB9CiAgICAvKiogc2V0ICovCgoKICAgIHNldChpLCBqLCB2YWx1ZSkgewogICAgICBpZiAoaSA+IGopIHsKICAgICAgICBjb25zdCB0ZW1wID0gajsKICAgICAgICBqID0gaTsKICAgICAgICBpID0gdGVtcDsKICAgICAgfQoKICAgICAgY29uc3Qga2V5ID0gaSArICItIiArIGo7IC8vIENoZWNrIGlmIGtleSBhbHJlYWR5IGV4aXN0cwoKICAgICAgaWYgKCF0aGlzLmdldChpLCBqKSkgewogICAgICAgIHRoaXMuZGF0YS5rZXlzLnB1c2goa2V5KTsKICAgICAgfQoKICAgICAgdGhpcy5kYXRhW2tleV0gPSB2YWx1ZTsKICAgIH0KICAgIC8qKiByZXNldCAqLwoKCiAgICByZXNldCgpIHsKICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgY29uc3Qga2V5cyA9IGRhdGEua2V5czsKCiAgICAgIHdoaWxlIChrZXlzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBrZXkgPSBrZXlzLnBvcCgpOwogICAgICAgIGRlbGV0ZSBkYXRhW2tleV07CiAgICAgIH0KICAgIH0KCiAgfQogIC8qKgogICAqIFRoZSBwaHlzaWNzIHdvcmxkCiAgICovCgoKICBjbGFzcyBXb3JsZCBleHRlbmRzIEV2ZW50VGFyZ2V0IHsKICAgIC8qKgogICAgICogQ3VycmVudGx5IC8gbGFzdCB1c2VkIHRpbWVzdGVwLiBJcyBzZXQgdG8gLTEgaWYgbm90IGF2YWlsYWJsZS4gVGhpcyB2YWx1ZSBpcyB1cGRhdGVkIGJlZm9yZSBlYWNoIGludGVybmFsIHN0ZXAsIHdoaWNoIG1lYW5zIHRoYXQgaXQgaXMgImZyZXNoIiBpbnNpZGUgZXZlbnQgY2FsbGJhY2tzLgogICAgICovCgogICAgLyoqCiAgICAgKiBNYWtlcyBib2RpZXMgZ28gdG8gc2xlZXAgd2hlbiB0aGV5J3ZlIGJlZW4gaW5hY3RpdmUuCiAgICAgKiBAZGVmYXVsdCBmYWxzZQogICAgICovCgogICAgLyoqCiAgICAgKiBBbGwgdGhlIGN1cnJlbnQgY29udGFjdHMgKGluc3RhbmNlcyBvZiBDb250YWN0RXF1YXRpb24pIGluIHRoZSB3b3JsZC4KICAgICAqLwoKICAgIC8qKgogICAgICogSG93IG9mdGVuIHRvIG5vcm1hbGl6ZSBxdWF0ZXJuaW9ucy4gU2V0IHRvIDAgZm9yIGV2ZXJ5IHN0ZXAsIDEgZm9yIGV2ZXJ5IHNlY29uZCBldGMuLiBBIGxhcmdlciB2YWx1ZSBpbmNyZWFzZXMgcGVyZm9ybWFuY2UuIElmIGJvZGllcyB0ZW5kIHRvIGV4cGxvZGUsIHNldCB0byBhIHNtYWxsZXIgdmFsdWUgKHplcm8gdG8gYmUgc3VyZSBub3RoaW5nIGNhbiBnbyB3cm9uZykuCiAgICAgKiBAZGVmYXVsdCAwCiAgICAgKi8KCiAgICAvKioKICAgICAqIFNldCB0byB0cnVlIHRvIHVzZSBmYXN0IHF1YXRlcm5pb24gbm9ybWFsaXphdGlvbi4gSXQgaXMgb2Z0ZW4gZW5vdWdoIGFjY3VyYXRlIHRvIHVzZS4KICAgICAqIElmIGJvZGllcyB0ZW5kIHRvIGV4cGxvZGUsIHNldCB0byBmYWxzZS4KICAgICAqIEBkZWZhdWx0IGZhbHNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSB3YWxsLWNsb2NrIHRpbWUgc2luY2Ugc2ltdWxhdGlvbiBzdGFydC4KICAgICAqLwoKICAgIC8qKgogICAgICogTnVtYmVyIG9mIHRpbWVzdGVwcyB0YWtlbiBzaW5jZSBzdGFydC4KICAgICAqLwoKICAgIC8qKgogICAgICogRGVmYXVsdCBhbmQgbGFzdCB0aW1lc3RlcCBzaXplcy4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIGdyYXZpdHkgb2YgdGhlIHdvcmxkLgogICAgICovCgogICAgLyoqCiAgICAgKiBUaGUgYnJvYWRwaGFzZSBhbGdvcml0aG0gdG8gdXNlLgogICAgICogQGRlZmF1bHQgTmFpdmVCcm9hZHBoYXNlCiAgICAgKi8KCiAgICAvKioKICAgICAqIEFsbCBib2RpZXMgaW4gdGhpcyB3b3JsZAogICAgICovCgogICAgLyoqCiAgICAgKiBUcnVlIGlmIGFueSBib2RpZXMgYXJlIG5vdCBzbGVlcGluZywgZmFsc2UgaWYgZXZlcnkgYm9keSBpcyBzbGVlcGluZy4KICAgICAqLwoKICAgIC8qKgogICAgICogVGhlIHNvbHZlciBhbGdvcml0aG0gdG8gdXNlLgogICAgICogQGRlZmF1bHQgR1NTb2x2ZXIKICAgICAqLwoKICAgIC8qKgogICAgICogY29sbGlzaW9uTWF0cml4CiAgICAgKi8KCiAgICAvKioKICAgICAqIENvbGxpc2lvbk1hdHJpeCBmcm9tIHRoZSBwcmV2aW91cyBzdGVwLgogICAgICovCgogICAgLyoqCiAgICAgKiBBbGwgYWRkZWQgbWF0ZXJpYWxzLgogICAgICogQGRlcHJlY2F0ZWQKICAgICAqIEB0b2RvIFJlbW92ZQogICAgICovCgogICAgLyoqCiAgICAgKiBBbGwgYWRkZWQgY29udGFjdG1hdGVyaWFscy4KICAgICAqLwoKICAgIC8qKgogICAgICogVXNlZCB0byBsb29rIHVwIGEgQ29udGFjdE1hdGVyaWFsIGdpdmVuIHR3byBpbnN0YW5jZXMgb2YgTWF0ZXJpYWwuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoZSBkZWZhdWx0IG1hdGVyaWFsIG9mIHRoZSBib2RpZXMuCiAgICAgKi8KCiAgICAvKioKICAgICAqIFRoaXMgY29udGFjdCBtYXRlcmlhbCBpcyB1c2VkIGlmIG5vIHN1aXRhYmxlIGNvbnRhY3RtYXRlcmlhbCBpcyBmb3VuZCBmb3IgYSBjb250YWN0LgogICAgICovCgogICAgLyoqCiAgICAgKiBUaW1lIGFjY3VtdWxhdG9yIGZvciBpbnRlcnBvbGF0aW9uLgogICAgICogQHNlZSBodHRwczovL2dhZmZlcm9uZ2FtZXMuY29tL2dhbWUtcGh5c2ljcy9maXgteW91ci10aW1lc3RlcC8KICAgICAqLwoKICAgIC8qKgogICAgICogRGlzcGF0Y2hlZCBhZnRlciBhIGJvZHkgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIHdvcmxkLgogICAgICovCgogICAgLyoqCiAgICAgKiBEaXNwYXRjaGVkIGFmdGVyIGEgYm9keSBoYXMgYmVlbiByZW1vdmVkIGZyb20gdGhlIHdvcmxkLgogICAgICovCiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIHN1cGVyKCk7CiAgICAgIHRoaXMuZHQgPSB2b2lkIDA7CiAgICAgIHRoaXMuYWxsb3dTbGVlcCA9IHZvaWQgMDsKICAgICAgdGhpcy5jb250YWN0cyA9IHZvaWQgMDsKICAgICAgdGhpcy5mcmljdGlvbkVxdWF0aW9ucyA9IHZvaWQgMDsKICAgICAgdGhpcy5xdWF0Tm9ybWFsaXplU2tpcCA9IHZvaWQgMDsKICAgICAgdGhpcy5xdWF0Tm9ybWFsaXplRmFzdCA9IHZvaWQgMDsKICAgICAgdGhpcy50aW1lID0gdm9pZCAwOwogICAgICB0aGlzLnN0ZXBudW1iZXIgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGVmYXVsdF9kdCA9IHZvaWQgMDsKICAgICAgdGhpcy5uZXh0SWQgPSB2b2lkIDA7CiAgICAgIHRoaXMuZ3Jhdml0eSA9IHZvaWQgMDsKICAgICAgdGhpcy5icm9hZHBoYXNlID0gdm9pZCAwOwogICAgICB0aGlzLmJvZGllcyA9IHZvaWQgMDsKICAgICAgdGhpcy5oYXNBY3RpdmVCb2RpZXMgPSB2b2lkIDA7CiAgICAgIHRoaXMuc29sdmVyID0gdm9pZCAwOwogICAgICB0aGlzLmNvbnN0cmFpbnRzID0gdm9pZCAwOwogICAgICB0aGlzLm5hcnJvd3BoYXNlID0gdm9pZCAwOwogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeCA9IHZvaWQgMDsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXhQcmV2aW91cyA9IHZvaWQgMDsKICAgICAgdGhpcy5ib2R5T3ZlcmxhcEtlZXBlciA9IHZvaWQgMDsKICAgICAgdGhpcy5zaGFwZU92ZXJsYXBLZWVwZXIgPSB2b2lkIDA7CiAgICAgIHRoaXMubWF0ZXJpYWxzID0gdm9pZCAwOwogICAgICB0aGlzLmNvbnRhY3RtYXRlcmlhbHMgPSB2b2lkIDA7CiAgICAgIHRoaXMuY29udGFjdE1hdGVyaWFsVGFibGUgPSB2b2lkIDA7CiAgICAgIHRoaXMuZGVmYXVsdE1hdGVyaWFsID0gdm9pZCAwOwogICAgICB0aGlzLmRlZmF1bHRDb250YWN0TWF0ZXJpYWwgPSB2b2lkIDA7CiAgICAgIHRoaXMuZG9Qcm9maWxpbmcgPSB2b2lkIDA7CiAgICAgIHRoaXMucHJvZmlsZSA9IHZvaWQgMDsKICAgICAgdGhpcy5hY2N1bXVsYXRvciA9IHZvaWQgMDsKICAgICAgdGhpcy5zdWJzeXN0ZW1zID0gdm9pZCAwOwogICAgICB0aGlzLmFkZEJvZHlFdmVudCA9IHZvaWQgMDsKICAgICAgdGhpcy5yZW1vdmVCb2R5RXZlbnQgPSB2b2lkIDA7CiAgICAgIHRoaXMuaWRUb0JvZHlNYXAgPSB2b2lkIDA7CiAgICAgIHRoaXMuZHQgPSAtMTsKICAgICAgdGhpcy5hbGxvd1NsZWVwID0gISFvcHRpb25zLmFsbG93U2xlZXA7CiAgICAgIHRoaXMuY29udGFjdHMgPSBbXTsKICAgICAgdGhpcy5mcmljdGlvbkVxdWF0aW9ucyA9IFtdOwogICAgICB0aGlzLnF1YXROb3JtYWxpemVTa2lwID0gb3B0aW9ucy5xdWF0Tm9ybWFsaXplU2tpcCAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5xdWF0Tm9ybWFsaXplU2tpcCA6IDA7CiAgICAgIHRoaXMucXVhdE5vcm1hbGl6ZUZhc3QgPSBvcHRpb25zLnF1YXROb3JtYWxpemVGYXN0ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLnF1YXROb3JtYWxpemVGYXN0IDogZmFsc2U7CiAgICAgIHRoaXMudGltZSA9IDAuMDsKICAgICAgdGhpcy5zdGVwbnVtYmVyID0gMDsKICAgICAgdGhpcy5kZWZhdWx0X2R0ID0gMSAvIDYwOwogICAgICB0aGlzLm5leHRJZCA9IDA7CiAgICAgIHRoaXMuZ3Jhdml0eSA9IG5ldyBWZWMzKCk7CgogICAgICBpZiAob3B0aW9ucy5ncmF2aXR5KSB7CiAgICAgICAgdGhpcy5ncmF2aXR5LmNvcHkob3B0aW9ucy5ncmF2aXR5KTsKICAgICAgfQoKICAgICAgdGhpcy5icm9hZHBoYXNlID0gb3B0aW9ucy5icm9hZHBoYXNlICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmJyb2FkcGhhc2UgOiBuZXcgTmFpdmVCcm9hZHBoYXNlKCk7CiAgICAgIHRoaXMuYm9kaWVzID0gW107CiAgICAgIHRoaXMuaGFzQWN0aXZlQm9kaWVzID0gZmFsc2U7CiAgICAgIHRoaXMuc29sdmVyID0gb3B0aW9ucy5zb2x2ZXIgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc29sdmVyIDogbmV3IEdTU29sdmVyKCk7CiAgICAgIHRoaXMuY29uc3RyYWludHMgPSBbXTsKICAgICAgdGhpcy5uYXJyb3dwaGFzZSA9IG5ldyBOYXJyb3dwaGFzZSh0aGlzKTsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXggPSBuZXcgQXJyYXlDb2xsaXNpb25NYXRyaXgoKTsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXhQcmV2aW91cyA9IG5ldyBBcnJheUNvbGxpc2lvbk1hdHJpeCgpOwogICAgICB0aGlzLmJvZHlPdmVybGFwS2VlcGVyID0gbmV3IE92ZXJsYXBLZWVwZXIoKTsKICAgICAgdGhpcy5zaGFwZU92ZXJsYXBLZWVwZXIgPSBuZXcgT3ZlcmxhcEtlZXBlcigpOwogICAgICB0aGlzLm1hdGVyaWFscyA9IFtdOwogICAgICB0aGlzLmNvbnRhY3RtYXRlcmlhbHMgPSBbXTsKICAgICAgdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZSA9IG5ldyBUdXBsZURpY3Rpb25hcnkoKTsKICAgICAgdGhpcy5kZWZhdWx0TWF0ZXJpYWwgPSBuZXcgTWF0ZXJpYWwoJ2RlZmF1bHQnKTsKICAgICAgdGhpcy5kZWZhdWx0Q29udGFjdE1hdGVyaWFsID0gbmV3IENvbnRhY3RNYXRlcmlhbCh0aGlzLmRlZmF1bHRNYXRlcmlhbCwgdGhpcy5kZWZhdWx0TWF0ZXJpYWwsIHsKICAgICAgICBmcmljdGlvbjogMC4zLAogICAgICAgIHJlc3RpdHV0aW9uOiAwLjAKICAgICAgfSk7CiAgICAgIHRoaXMuZG9Qcm9maWxpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5wcm9maWxlID0gewogICAgICAgIHNvbHZlOiAwLAogICAgICAgIG1ha2VDb250YWN0Q29uc3RyYWludHM6IDAsCiAgICAgICAgYnJvYWRwaGFzZTogMCwKICAgICAgICBpbnRlZ3JhdGU6IDAsCiAgICAgICAgbmFycm93cGhhc2U6IDAKICAgICAgfTsKICAgICAgdGhpcy5hY2N1bXVsYXRvciA9IDA7CiAgICAgIHRoaXMuc3Vic3lzdGVtcyA9IFtdOwogICAgICB0aGlzLmFkZEJvZHlFdmVudCA9IHsKICAgICAgICB0eXBlOiAnYWRkQm9keScsCiAgICAgICAgYm9keTogbnVsbAogICAgICB9OwogICAgICB0aGlzLnJlbW92ZUJvZHlFdmVudCA9IHsKICAgICAgICB0eXBlOiAncmVtb3ZlQm9keScsCiAgICAgICAgYm9keTogbnVsbAogICAgICB9OwogICAgICB0aGlzLmlkVG9Cb2R5TWFwID0ge307CiAgICAgIHRoaXMuYnJvYWRwaGFzZS5zZXRXb3JsZCh0aGlzKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjb250YWN0IG1hdGVyaWFsIGJldHdlZW4gbWF0ZXJpYWxzIG0xIGFuZCBtMgogICAgICogQHJldHVybiBUaGUgY29udGFjdCBtYXRlcmlhbCBpZiBpdCB3YXMgZm91bmQuCiAgICAgKi8KCgogICAgZ2V0Q29udGFjdE1hdGVyaWFsKG0xLCBtMikgewogICAgICByZXR1cm4gdGhpcy5jb250YWN0TWF0ZXJpYWxUYWJsZS5nZXQobTEuaWQsIG0yLmlkKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IG51bWJlciBvZiBvYmplY3RzIGluIHRoZSB3b3JsZC4KICAgICAqIEBkZXByZWNhdGVkCiAgICAgKi8KCgogICAgbnVtT2JqZWN0cygpIHsKICAgICAgcmV0dXJuIHRoaXMuYm9kaWVzLmxlbmd0aDsKICAgIH0KICAgIC8qKgogICAgICogU3RvcmUgb2xkIGNvbGxpc2lvbiBzdGF0ZSBpbmZvCiAgICAgKi8KCgogICAgY29sbGlzaW9uTWF0cml4VGljaygpIHsKICAgICAgY29uc3QgdGVtcCA9IHRoaXMuY29sbGlzaW9uTWF0cml4UHJldmlvdXM7CiAgICAgIHRoaXMuY29sbGlzaW9uTWF0cml4UHJldmlvdXMgPSB0aGlzLmNvbGxpc2lvbk1hdHJpeDsKICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXggPSB0ZW1wOwogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5yZXNldCgpOwogICAgICB0aGlzLmJvZHlPdmVybGFwS2VlcGVyLnRpY2soKTsKICAgICAgdGhpcy5zaGFwZU92ZXJsYXBLZWVwZXIudGljaygpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSBjb25zdHJhaW50IHRvIHRoZSBzaW11bGF0aW9uLgogICAgICovCgoKICAgIGFkZENvbnN0cmFpbnQoYykgewogICAgICB0aGlzLmNvbnN0cmFpbnRzLnB1c2goYyk7CiAgICB9CiAgICAvKioKICAgICAqIFJlbW92ZXMgYSBjb25zdHJhaW50CiAgICAgKi8KCgogICAgcmVtb3ZlQ29uc3RyYWludChjKSB7CiAgICAgIGNvbnN0IGlkeCA9IHRoaXMuY29uc3RyYWludHMuaW5kZXhPZihjKTsKCiAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgdGhpcy5jb25zdHJhaW50cy5zcGxpY2UoaWR4LCAxKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSYXljYXN0IHRlc3QKICAgICAqIEBkZXByZWNhdGVkIFVzZSAucmF5Y2FzdEFsbCwgLnJheWNhc3RDbG9zZXN0IG9yIC5yYXljYXN0QW55IGluc3RlYWQuCiAgICAgKi8KCgogICAgcmF5VGVzdChmcm9tLCB0bywgcmVzdWx0KSB7CiAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBSYXljYXN0UmVzdWx0KSB7CiAgICAgICAgLy8gRG8gcmF5Y2FzdENsb3Nlc3QKICAgICAgICB0aGlzLnJheWNhc3RDbG9zZXN0KGZyb20sIHRvLCB7CiAgICAgICAgICBza2lwQmFja2ZhY2VzOiB0cnVlCiAgICAgICAgfSwgcmVzdWx0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBEbyByYXljYXN0QWxsCiAgICAgICAgdGhpcy5yYXljYXN0QWxsKGZyb20sIHRvLCB7CiAgICAgICAgICBza2lwQmFja2ZhY2VzOiB0cnVlCiAgICAgICAgfSwgcmVzdWx0KTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSYXkgY2FzdCBhZ2FpbnN0IGFsbCBib2RpZXMuIFRoZSBwcm92aWRlZCBjYWxsYmFjayB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoIGhpdCB3aXRoIGEgUmF5Y2FzdFJlc3VsdCBhcyBzaW5nbGUgYXJndW1lbnQuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgYW55IGJvZHkgd2FzIGhpdC4KICAgICAqLwoKCiAgICByYXljYXN0QWxsKGZyb20sIHRvLCBvcHRpb25zLCBjYWxsYmFjaykgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zLm1vZGUgPSBSYXkuQUxMOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIHRtcFJheS5pbnRlcnNlY3RXb3JsZCh0aGlzLCBvcHRpb25zKTsKICAgIH0KICAgIC8qKgogICAgICogUmF5IGNhc3QsIGFuZCBzdG9wIGF0IHRoZSBmaXJzdCByZXN1bHQuIE5vdGUgdGhhdCB0aGUgb3JkZXIgaXMgcmFuZG9tIC0gYnV0IHRoZSBtZXRob2QgaXMgZmFzdC4KICAgICAqIEByZXR1cm4gVHJ1ZSBpZiBhbnkgYm9keSB3YXMgaGl0LgogICAgICovCgoKICAgIHJheWNhc3RBbnkoZnJvbSwgdG8sIG9wdGlvbnMsIHJlc3VsdCkgewogICAgICBpZiAob3B0aW9ucyA9PT0gdm9pZCAwKSB7CiAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICB9CgogICAgICBvcHRpb25zLm1vZGUgPSBSYXkuQU5ZOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMucmVzdWx0ID0gcmVzdWx0OwogICAgICByZXR1cm4gdG1wUmF5LmludGVyc2VjdFdvcmxkKHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBSYXkgY2FzdCwgYW5kIHJldHVybiBpbmZvcm1hdGlvbiBvZiB0aGUgY2xvc2VzdCBoaXQuCiAgICAgKiBAcmV0dXJuIFRydWUgaWYgYW55IGJvZHkgd2FzIGhpdC4KICAgICAqLwoKCiAgICByYXljYXN0Q2xvc2VzdChmcm9tLCB0bywgb3B0aW9ucywgcmVzdWx0KSB7CiAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KCiAgICAgIG9wdGlvbnMubW9kZSA9IFJheS5DTE9TRVNUOwogICAgICBvcHRpb25zLmZyb20gPSBmcm9tOwogICAgICBvcHRpb25zLnRvID0gdG87CiAgICAgIG9wdGlvbnMucmVzdWx0ID0gcmVzdWx0OwogICAgICByZXR1cm4gdG1wUmF5LmludGVyc2VjdFdvcmxkKHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGQgYSByaWdpZCBib2R5IHRvIHRoZSBzaW11bGF0aW9uLgogICAgICogQHRvZG8gSWYgdGhlIHNpbXVsYXRpb24gaGFzIG5vdCB5ZXQgc3RhcnRlZCwgd2h5IHJlY3JldGUgYW5kIGNvcHkgYXJyYXlzIGZvciBlYWNoIGJvZHk/IEFjY3VtdWxhdGUgaW4gZHluYW1pYyBhcnJheXMgaW4gdGhpcyBjYXNlLgogICAgICogQHRvZG8gQWRkaW5nIGFuIGFycmF5IG9mIGJvZGllcyBzaG91bGQgYmUgcG9zc2libGUuIFRoaXMgd291bGQgc2F2ZSBzb21lIGxvb3BzIHRvbwogICAgICovCgoKICAgIGFkZEJvZHkoYm9keSkgewogICAgICBpZiAodGhpcy5ib2RpZXMuaW5jbHVkZXMoYm9keSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGJvZHkuaW5kZXggPSB0aGlzLmJvZGllcy5sZW5ndGg7CiAgICAgIHRoaXMuYm9kaWVzLnB1c2goYm9keSk7CiAgICAgIGJvZHkud29ybGQgPSB0aGlzOwogICAgICBib2R5LmluaXRQb3NpdGlvbi5jb3B5KGJvZHkucG9zaXRpb24pOwogICAgICBib2R5LmluaXRWZWxvY2l0eS5jb3B5KGJvZHkudmVsb2NpdHkpOwogICAgICBib2R5LnRpbWVMYXN0U2xlZXB5ID0gdGhpcy50aW1lOwoKICAgICAgaWYgKGJvZHkgaW5zdGFuY2VvZiBCb2R5KSB7CiAgICAgICAgYm9keS5pbml0QW5ndWxhclZlbG9jaXR5LmNvcHkoYm9keS5hbmd1bGFyVmVsb2NpdHkpOwogICAgICAgIGJvZHkuaW5pdFF1YXRlcm5pb24uY29weShib2R5LnF1YXRlcm5pb24pOwogICAgICB9CgogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5zZXROdW1PYmplY3RzKHRoaXMuYm9kaWVzLmxlbmd0aCk7CiAgICAgIHRoaXMuYWRkQm9keUV2ZW50LmJvZHkgPSBib2R5OwogICAgICB0aGlzLmlkVG9Cb2R5TWFwW2JvZHkuaWRdID0gYm9keTsKICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KHRoaXMuYWRkQm9keUV2ZW50KTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlIGEgcmlnaWQgYm9keSBmcm9tIHRoZSBzaW11bGF0aW9uLgogICAgICovCgoKICAgIHJlbW92ZUJvZHkoYm9keSkgewogICAgICBib2R5LndvcmxkID0gbnVsbDsKICAgICAgY29uc3QgbiA9IHRoaXMuYm9kaWVzLmxlbmd0aCAtIDE7CiAgICAgIGNvbnN0IGJvZGllcyA9IHRoaXMuYm9kaWVzOwogICAgICBjb25zdCBpZHggPSBib2RpZXMuaW5kZXhPZihib2R5KTsKCiAgICAgIGlmIChpZHggIT09IC0xKSB7CiAgICAgICAgYm9kaWVzLnNwbGljZShpZHgsIDEpOyAvLyBUb2RvOiBzaG91bGQgdXNlIGEgZ2FyYmFnZSBmcmVlIG1ldGhvZAogICAgICAgIC8vIFJlY29tcHV0ZSBpbmRleAoKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBib2RpZXNbaV0uaW5kZXggPSBpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb2xsaXNpb25NYXRyaXguc2V0TnVtT2JqZWN0cyhuKTsKICAgICAgICB0aGlzLnJlbW92ZUJvZHlFdmVudC5ib2R5ID0gYm9keTsKICAgICAgICBkZWxldGUgdGhpcy5pZFRvQm9keU1hcFtib2R5LmlkXTsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQodGhpcy5yZW1vdmVCb2R5RXZlbnQpOwogICAgICB9CiAgICB9CgogICAgZ2V0Qm9keUJ5SWQoaWQpIHsKICAgICAgcmV0dXJuIHRoaXMuaWRUb0JvZHlNYXBbaWRdOwogICAgfQogICAgLyoqCiAgICAgKiBAdG9kbyBNYWtlIGEgZmFzdGVyIG1hcAogICAgICovCgoKICAgIGdldFNoYXBlQnlJZChpZCkgewogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmJvZGllczsKCiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYm9kaWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qgc2hhcGVzID0gYm9kaWVzW2ldLnNoYXBlczsKCiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzaGFwZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGNvbnN0IHNoYXBlID0gc2hhcGVzW2pdOwoKICAgICAgICAgIGlmIChzaGFwZS5pZCA9PT0gaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNoYXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgYSBtYXRlcmlhbCB0byB0aGUgV29ybGQuCiAgICAgKiBAZGVwcmVjYXRlZAogICAgICogQHRvZG8gUmVtb3ZlCiAgICAgKi8KCgogICAgYWRkTWF0ZXJpYWwobSkgewogICAgICB0aGlzLm1hdGVyaWFscy5wdXNoKG0pOwogICAgfQogICAgLyoqCiAgICAgKiBBZGRzIGEgY29udGFjdCBtYXRlcmlhbCB0byB0aGUgV29ybGQKICAgICAqLwoKCiAgICBhZGRDb250YWN0TWF0ZXJpYWwoY21hdCkgewogICAgICAvLyBBZGQgY29udGFjdCBtYXRlcmlhbAogICAgICB0aGlzLmNvbnRhY3RtYXRlcmlhbHMucHVzaChjbWF0KTsgLy8gQWRkIGN1cnJlbnQgY29udGFjdCBtYXRlcmlhbCB0byB0aGUgbWF0ZXJpYWwgdGFibGUKCiAgICAgIHRoaXMuY29udGFjdE1hdGVyaWFsVGFibGUuc2V0KGNtYXQubWF0ZXJpYWxzWzBdLmlkLCBjbWF0Lm1hdGVyaWFsc1sxXS5pZCwgY21hdCk7CiAgICB9CiAgICAvKioKICAgICAqIFN0ZXAgdGhlIHBoeXNpY3Mgd29ybGQgZm9yd2FyZCBpbiB0aW1lLgogICAgICoKICAgICAqIFRoZXJlIGFyZSB0d28gbW9kZXMuIFRoZSBzaW1wbGUgbW9kZSBpcyBmaXhlZCB0aW1lc3RlcHBpbmcgd2l0aG91dCBpbnRlcnBvbGF0aW9uLiBJbiB0aGlzIGNhc2UgeW91IG9ubHkgdXNlIHRoZSBmaXJzdCBhcmd1bWVudC4gVGhlIHNlY29uZCBjYXNlIHVzZXMgaW50ZXJwb2xhdGlvbi4gSW4gdGhhdCB5b3UgYWxzbyBwcm92aWRlIHRoZSB0aW1lIHNpbmNlIHRoZSBmdW5jdGlvbiB3YXMgbGFzdCB1c2VkLCBhcyB3ZWxsIGFzIHRoZSBtYXhpbXVtIGZpeGVkIHRpbWVzdGVwcyB0byB0YWtlLgogICAgICoKICAgICAqIEBwYXJhbSBkdCBUaGUgZml4ZWQgdGltZSBzdGVwIHNpemUgdG8gdXNlLgogICAgICogQHBhcmFtIHRpbWVTaW5jZUxhc3RDYWxsZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgZnVuY3Rpb24gd2FzIGxhc3QgY2FsbGVkLgogICAgICogQHBhcmFtIG1heFN1YlN0ZXBzIE1heGltdW0gbnVtYmVyIG9mIGZpeGVkIHN0ZXBzIHRvIHRha2UgcGVyIGZ1bmN0aW9uIGNhbGwuCiAgICAgKiBAc2VlIGh0dHBzOi8vd2ViLmFyY2hpdmUub3JnL3dlYi8yMDE4MDQyNjE1NDUzMS9odHRwOi8vYnVsbGV0cGh5c2ljcy5vcmcvbWVkaWF3aWtpLTEuNS44L2luZGV4LnBocC9TdGVwcGluZ19UaGVfV29ybGQjV2hhdF9kb190aGVfcGFyYW1ldGVyc190b19idER5bmFtaWNzV29ybGQ6OnN0ZXBTaW11bGF0aW9uX21lYW4uM0YKICAgICAqIEBleGFtcGxlCiAgICAgKiAgICAgLy8gZml4ZWQgdGltZXN0ZXBwaW5nIHdpdGhvdXQgaW50ZXJwb2xhdGlvbgogICAgICogICAgIHdvcmxkLnN0ZXAoMSAvIDYwKQogICAgICovCgoKICAgIHN0ZXAoZHQsIHRpbWVTaW5jZUxhc3RDYWxsZWQsIG1heFN1YlN0ZXBzKSB7CiAgICAgIGlmIChtYXhTdWJTdGVwcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgbWF4U3ViU3RlcHMgPSAxMDsKICAgICAgfQoKICAgICAgaWYgKHRpbWVTaW5jZUxhc3RDYWxsZWQgPT09IHVuZGVmaW5lZCkgewogICAgICAgIC8vIEZpeGVkLCBzaW1wbGUgc3RlcHBpbmcKICAgICAgICB0aGlzLmludGVybmFsU3RlcChkdCk7IC8vIEluY3JlbWVudCB0aW1lCgogICAgICAgIHRoaXMudGltZSArPSBkdDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmFjY3VtdWxhdG9yICs9IHRpbWVTaW5jZUxhc3RDYWxsZWQ7CiAgICAgICAgY29uc3QgdDAgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgICBsZXQgc3Vic3RlcHMgPSAwOwoKICAgICAgICB3aGlsZSAodGhpcy5hY2N1bXVsYXRvciA+PSBkdCAmJiBzdWJzdGVwcyA8IG1heFN1YlN0ZXBzKSB7CiAgICAgICAgICAvLyBEbyBmaXhlZCBzdGVwcyB0byBjYXRjaCB1cAogICAgICAgICAgdGhpcy5pbnRlcm5hbFN0ZXAoZHQpOwogICAgICAgICAgdGhpcy5hY2N1bXVsYXRvciAtPSBkdDsKICAgICAgICAgIHN1YnN0ZXBzKys7CgogICAgICAgICAgaWYgKHBlcmZvcm1hbmNlLm5vdygpIC0gdDAgPiBkdCAqIDEwMDApIHsKICAgICAgICAgICAgLy8gVGhlIGZyYW1lcmF0ZSBpcyBub3QgaW50ZXJhY3RpdmUgYW55bW9yZS4KICAgICAgICAgICAgLy8gV2UgYXJlIGJlbG93IHRoZSB0YXJnZXQgZnJhbWVyYXRlLgogICAgICAgICAgICAvLyBCZXR0ZXIgYmFpbCBvdXQuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gLy8gUmVtb3ZlIHRoZSBleGNlc3MgYWNjdW11bGF0b3IsIHNpbmNlIHdlIG1heSBub3QKICAgICAgICAvLyBoYXZlIGhhZCBlbm91Z2ggc3Vic3RlcHMgYXZhaWxhYmxlIHRvIGNhdGNoIHVwCgoKICAgICAgICB0aGlzLmFjY3VtdWxhdG9yID0gdGhpcy5hY2N1bXVsYXRvciAlIGR0OwogICAgICAgIGNvbnN0IHQgPSB0aGlzLmFjY3VtdWxhdG9yIC8gZHQ7CgogICAgICAgIGZvciAobGV0IGogPSAwOyBqICE9PSB0aGlzLmJvZGllcy5sZW5ndGg7IGorKykgewogICAgICAgICAgY29uc3QgYiA9IHRoaXMuYm9kaWVzW2pdOwogICAgICAgICAgYi5wcmV2aW91c1Bvc2l0aW9uLmxlcnAoYi5wb3NpdGlvbiwgdCwgYi5pbnRlcnBvbGF0ZWRQb3NpdGlvbik7CiAgICAgICAgICBiLnByZXZpb3VzUXVhdGVybmlvbi5zbGVycChiLnF1YXRlcm5pb24sIHQsIGIuaW50ZXJwb2xhdGVkUXVhdGVybmlvbik7CiAgICAgICAgICBiLnByZXZpb3VzUXVhdGVybmlvbi5ub3JtYWxpemUoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMudGltZSArPSB0aW1lU2luY2VMYXN0Q2FsbGVkOwogICAgICB9CiAgICB9CgogICAgaW50ZXJuYWxTdGVwKGR0KSB7CiAgICAgIHRoaXMuZHQgPSBkdDsKICAgICAgY29uc3QgY29udGFjdHMgPSB0aGlzLmNvbnRhY3RzOwogICAgICBjb25zdCBwMSA9IFdvcmxkX3N0ZXBfcDE7CiAgICAgIGNvbnN0IHAyID0gV29ybGRfc3RlcF9wMjsKICAgICAgY29uc3QgTiA9IHRoaXMubnVtT2JqZWN0cygpOwogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmJvZGllczsKICAgICAgY29uc3Qgc29sdmVyID0gdGhpcy5zb2x2ZXI7CiAgICAgIGNvbnN0IGdyYXZpdHkgPSB0aGlzLmdyYXZpdHk7CiAgICAgIGNvbnN0IGRvUHJvZmlsaW5nID0gdGhpcy5kb1Byb2ZpbGluZzsKICAgICAgY29uc3QgcHJvZmlsZSA9IHRoaXMucHJvZmlsZTsKICAgICAgY29uc3QgRFlOQU1JQyA9IEJvZHkuRFlOQU1JQzsKICAgICAgbGV0IHByb2ZpbGluZ1N0YXJ0ID0gLUluZmluaXR5OwogICAgICBjb25zdCBjb25zdHJhaW50cyA9IHRoaXMuY29uc3RyYWludHM7CiAgICAgIGNvbnN0IGZyaWN0aW9uRXF1YXRpb25Qb29sID0gV29ybGRfc3RlcF9mcmljdGlvbkVxdWF0aW9uUG9vbDsKICAgICAgZ3Jhdml0eS5sZW5ndGgoKTsKICAgICAgY29uc3QgZ3ggPSBncmF2aXR5Lng7CiAgICAgIGNvbnN0IGd5ID0gZ3Jhdml0eS55OwogICAgICBjb25zdCBneiA9IGdyYXZpdHkuejsKICAgICAgbGV0IGkgPSAwOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsaW5nU3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgICAgfSAvLyBBZGQgZ3Jhdml0eSB0byBhbGwgb2JqZWN0cwoKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGJpID0gYm9kaWVzW2ldOwoKICAgICAgICBpZiAoYmkudHlwZSA9PT0gRFlOQU1JQykgewogICAgICAgICAgLy8gT25seSBmb3IgZHluYW1pYyBib2RpZXMKICAgICAgICAgIGNvbnN0IGYgPSBiaS5mb3JjZTsKICAgICAgICAgIGNvbnN0IG0gPSBiaS5tYXNzOwogICAgICAgICAgZi54ICs9IG0gKiBneDsKICAgICAgICAgIGYueSArPSBtICogZ3k7CiAgICAgICAgICBmLnogKz0gbSAqIGd6OwogICAgICAgIH0KICAgICAgfSAvLyBVcGRhdGUgc3Vic3lzdGVtcwoKCiAgICAgIGZvciAobGV0IGkgPSAwLCBOc3Vic3lzdGVtcyA9IHRoaXMuc3Vic3lzdGVtcy5sZW5ndGg7IGkgIT09IE5zdWJzeXN0ZW1zOyBpKyspIHsKICAgICAgICB0aGlzLnN1YnN5c3RlbXNbaV0udXBkYXRlKCk7CiAgICAgIH0gLy8gQ29sbGlzaW9uIGRldGVjdGlvbgoKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGluZ1N0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KCiAgICAgIHAxLmxlbmd0aCA9IDA7IC8vIENsZWFuIHVwIHBhaXIgYXJyYXlzIGZyb20gbGFzdCBzdGVwCgogICAgICBwMi5sZW5ndGggPSAwOwogICAgICB0aGlzLmJyb2FkcGhhc2UuY29sbGlzaW9uUGFpcnModGhpcywgcDEsIHAyKTsKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGUuYnJvYWRwaGFzZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gcHJvZmlsaW5nU3RhcnQ7CiAgICAgIH0gLy8gUmVtb3ZlIGNvbnN0cmFpbmVkIHBhaXJzIHdpdGggY29sbGlkZUNvbm5lY3RlZCA9PSBmYWxzZQoKCiAgICAgIGxldCBOY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5sZW5ndGg7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOY29uc3RyYWludHM7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBjb25zdHJhaW50c1tpXTsKCiAgICAgICAgaWYgKCFjLmNvbGxpZGVDb25uZWN0ZWQpIHsKICAgICAgICAgIGZvciAobGV0IGogPSBwMS5sZW5ndGggLSAxOyBqID49IDA7IGogLT0gMSkgewogICAgICAgICAgICBpZiAoYy5ib2R5QSA9PT0gcDFbal0gJiYgYy5ib2R5QiA9PT0gcDJbal0gfHwgYy5ib2R5QiA9PT0gcDFbal0gJiYgYy5ib2R5QSA9PT0gcDJbal0pIHsKICAgICAgICAgICAgICBwMS5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgICAgcDIuc3BsaWNlKGosIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeFRpY2soKTsgLy8gR2VuZXJhdGUgY29udGFjdHMKCiAgICAgIGlmIChkb1Byb2ZpbGluZykgewogICAgICAgIHByb2ZpbGluZ1N0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICAgIH0KCiAgICAgIGNvbnN0IG9sZGNvbnRhY3RzID0gV29ybGRfc3RlcF9vbGRDb250YWN0czsKICAgICAgY29uc3QgTm9sZENvbnRhY3RzID0gY29udGFjdHMubGVuZ3RoOwoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTm9sZENvbnRhY3RzOyBpKyspIHsKICAgICAgICBvbGRjb250YWN0cy5wdXNoKGNvbnRhY3RzW2ldKTsKICAgICAgfQoKICAgICAgY29udGFjdHMubGVuZ3RoID0gMDsgLy8gVHJhbnNmZXIgRnJpY3Rpb25FcXVhdGlvbiBmcm9tIGN1cnJlbnQgbGlzdCB0byB0aGUgcG9vbCBmb3IgcmV1c2UKCiAgICAgIGNvbnN0IE5vbGRGcmljdGlvbkVxdWF0aW9ucyA9IHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMubGVuZ3RoOwoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTm9sZEZyaWN0aW9uRXF1YXRpb25zOyBpKyspIHsKICAgICAgICBmcmljdGlvbkVxdWF0aW9uUG9vbC5wdXNoKHRoaXMuZnJpY3Rpb25FcXVhdGlvbnNbaV0pOwogICAgICB9CgogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25zLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubmFycm93cGhhc2UuZ2V0Q29udGFjdHMocDEsIHAyLCB0aGlzLCBjb250YWN0cywgb2xkY29udGFjdHMsIC8vIFRvIGJlIHJldXNlZAogICAgICB0aGlzLmZyaWN0aW9uRXF1YXRpb25zLCBmcmljdGlvbkVxdWF0aW9uUG9vbCk7CgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxlLm5hcnJvd3BoYXNlID0gcGVyZm9ybWFuY2Uubm93KCkgLSBwcm9maWxpbmdTdGFydDsKICAgICAgfSAvLyBMb29wIG92ZXIgYWxsIGNvbGxpc2lvbnMKCgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IC8vIEFkZCBhbGwgZnJpY3Rpb24gZXFzCgoKICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMuZnJpY3Rpb25FcXVhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBzb2x2ZXIuYWRkRXF1YXRpb24odGhpcy5mcmljdGlvbkVxdWF0aW9uc1tpXSk7CiAgICAgIH0KCiAgICAgIGNvbnN0IG5jb250YWN0cyA9IGNvbnRhY3RzLmxlbmd0aDsKCiAgICAgIGZvciAobGV0IGsgPSAwOyBrICE9PSBuY29udGFjdHM7IGsrKykgewogICAgICAgIC8vIEN1cnJlbnQgY29udGFjdAogICAgICAgIGNvbnN0IGMgPSBjb250YWN0c1trXTsgLy8gR2V0IGN1cnJlbnQgY29sbGlzaW9uIGluZGVjZXMKCiAgICAgICAgY29uc3QgYmkgPSBjLmJpOwogICAgICAgIGNvbnN0IGJqID0gYy5iajsKICAgICAgICBjb25zdCBzaSA9IGMuc2k7CiAgICAgICAgY29uc3Qgc2ogPSBjLnNqOyAvLyBHZXQgY29sbGlzaW9uIHByb3BlcnRpZXMKCiAgICAgICAgbGV0IGNtOwoKICAgICAgICBpZiAoYmkubWF0ZXJpYWwgJiYgYmoubWF0ZXJpYWwpIHsKICAgICAgICAgIGNtID0gdGhpcy5nZXRDb250YWN0TWF0ZXJpYWwoYmkubWF0ZXJpYWwsIGJqLm1hdGVyaWFsKSB8fCB0aGlzLmRlZmF1bHRDb250YWN0TWF0ZXJpYWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNtID0gdGhpcy5kZWZhdWx0Q29udGFjdE1hdGVyaWFsOwogICAgICAgIH0gLy8gYy5lbmFibGVkID0gYmkuY29sbGlzaW9uUmVzcG9uc2UgJiYgYmouY29sbGlzaW9uUmVzcG9uc2UgJiYgc2kuY29sbGlzaW9uUmVzcG9uc2UgJiYgc2ouY29sbGlzaW9uUmVzcG9uc2U7CgoKICAgICAgICBjbS5mcmljdGlvbjsgLy8gYy5yZXN0aXR1dGlvbiA9IGNtLnJlc3RpdHV0aW9uOwogICAgICAgIC8vIElmIGZyaWN0aW9uIG9yIHJlc3RpdHV0aW9uIHdlcmUgc3BlY2lmaWVkIGluIHRoZSBtYXRlcmlhbCwgdXNlIHRoZW0KCiAgICAgICAgaWYgKGJpLm1hdGVyaWFsICYmIGJqLm1hdGVyaWFsKSB7CiAgICAgICAgICBpZiAoYmkubWF0ZXJpYWwuZnJpY3Rpb24gPj0gMCAmJiBiai5tYXRlcmlhbC5mcmljdGlvbiA+PSAwKSB7CiAgICAgICAgICAgIGJpLm1hdGVyaWFsLmZyaWN0aW9uICogYmoubWF0ZXJpYWwuZnJpY3Rpb247CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGJpLm1hdGVyaWFsLnJlc3RpdHV0aW9uID49IDAgJiYgYmoubWF0ZXJpYWwucmVzdGl0dXRpb24gPj0gMCkgewogICAgICAgICAgICBjLnJlc3RpdHV0aW9uID0gYmkubWF0ZXJpYWwucmVzdGl0dXRpb24gKiBiai5tYXRlcmlhbC5yZXN0aXR1dGlvbjsKICAgICAgICAgIH0KICAgICAgICB9IC8vIGMuc2V0U3Bvb2tQYXJhbXMoCiAgICAgICAgLy8gICAgICAgICAgIGNtLmNvbnRhY3RFcXVhdGlvblN0aWZmbmVzcywKICAgICAgICAvLyAgICAgICAgICAgY20uY29udGFjdEVxdWF0aW9uUmVsYXhhdGlvbiwKICAgICAgICAvLyAgICAgICAgICAgZHQKICAgICAgICAvLyAgICAgICApOwoKCiAgICAgICAgc29sdmVyLmFkZEVxdWF0aW9uKGMpOyAvLyAvLyBBZGQgZnJpY3Rpb24gY29uc3RyYWludCBlcXVhdGlvbgogICAgICAgIC8vIGlmKG11ID4gMCl7CiAgICAgICAgLy8gCS8vIENyZWF0ZSAyIHRhbmdlbnQgZXF1YXRpb25zCiAgICAgICAgLy8gCWNvbnN0IG11ZyA9IG11ICogZ25vcm07CiAgICAgICAgLy8gCWNvbnN0IHJlZHVjZWRNYXNzID0gKGJpLmludk1hc3MgKyBiai5pbnZNYXNzKTsKICAgICAgICAvLyAJaWYocmVkdWNlZE1hc3MgPiAwKXsKICAgICAgICAvLyAJCXJlZHVjZWRNYXNzID0gMS9yZWR1Y2VkTWFzczsKICAgICAgICAvLyAJfQogICAgICAgIC8vIAljb25zdCBwb29sID0gZnJpY3Rpb25FcXVhdGlvblBvb2w7CiAgICAgICAgLy8gCWNvbnN0IGMxID0gcG9vbC5sZW5ndGggPyBwb29sLnBvcCgpIDogbmV3IEZyaWN0aW9uRXF1YXRpb24oYmksYmosbXVnKnJlZHVjZWRNYXNzKTsKICAgICAgICAvLyAJY29uc3QgYzIgPSBwb29sLmxlbmd0aCA/IHBvb2wucG9wKCkgOiBuZXcgRnJpY3Rpb25FcXVhdGlvbihiaSxiaixtdWcqcmVkdWNlZE1hc3MpOwogICAgICAgIC8vIAl0aGlzLmZyaWN0aW9uRXF1YXRpb25zLnB1c2goYzEsIGMyKTsKICAgICAgICAvLyAJYzEuYmkgPSBjMi5iaSA9IGJpOwogICAgICAgIC8vIAljMS5iaiA9IGMyLmJqID0gYmo7CiAgICAgICAgLy8gCWMxLm1pbkZvcmNlID0gYzIubWluRm9yY2UgPSAtbXVnKnJlZHVjZWRNYXNzOwogICAgICAgIC8vIAljMS5tYXhGb3JjZSA9IGMyLm1heEZvcmNlID0gbXVnKnJlZHVjZWRNYXNzOwogICAgICAgIC8vIAkvLyBDb3B5IG92ZXIgdGhlIHJlbGF0aXZlIHZlY3RvcnMKICAgICAgICAvLyAJYzEucmkuY29weShjLnJpKTsKICAgICAgICAvLyAJYzEucmouY29weShjLnJqKTsKICAgICAgICAvLyAJYzIucmkuY29weShjLnJpKTsKICAgICAgICAvLyAJYzIucmouY29weShjLnJqKTsKICAgICAgICAvLyAJLy8gQ29uc3RydWN0IHRhbmdlbnRzCiAgICAgICAgLy8gCWMubmkudGFuZ2VudHMoYzEudCwgYzIudCk7CiAgICAgICAgLy8gICAgICAgICAgIC8vIFNldCBzcG9vayBwYXJhbXMKICAgICAgICAvLyAgICAgICAgICAgYzEuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIGR0KTsKICAgICAgICAvLyAgICAgICAgICAgYzIuc2V0U3Bvb2tQYXJhbXMoY20uZnJpY3Rpb25FcXVhdGlvblN0aWZmbmVzcywgY20uZnJpY3Rpb25FcXVhdGlvblJlbGF4YXRpb24sIGR0KTsKICAgICAgICAvLyAgICAgICAgICAgYzEuZW5hYmxlZCA9IGMyLmVuYWJsZWQgPSBjLmVuYWJsZWQ7CiAgICAgICAgLy8gCS8vIEFkZCBlcXVhdGlvbnMgdG8gc29sdmVyCiAgICAgICAgLy8gCXNvbHZlci5hZGRFcXVhdGlvbihjMSk7CiAgICAgICAgLy8gCXNvbHZlci5hZGRFcXVhdGlvbihjMik7CiAgICAgICAgLy8gfQoKICAgICAgICBpZiAoYmkuYWxsb3dTbGVlcCAmJiBiaS50eXBlID09PSBCb2R5LkRZTkFNSUMgJiYgYmkuc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORyAmJiBiai5zbGVlcFN0YXRlID09PSBCb2R5LkFXQUtFICYmIGJqLnR5cGUgIT09IEJvZHkuU1RBVElDKSB7CiAgICAgICAgICBjb25zdCBzcGVlZFNxdWFyZWRCID0gYmoudmVsb2NpdHkubGVuZ3RoU3F1YXJlZCgpICsgYmouYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKTsKICAgICAgICAgIGNvbnN0IHNwZWVkTGltaXRTcXVhcmVkQiA9IGJqLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICAgIGlmIChzcGVlZFNxdWFyZWRCID49IHNwZWVkTGltaXRTcXVhcmVkQiAqIDIpIHsKICAgICAgICAgICAgYmkud2FrZVVwQWZ0ZXJOYXJyb3dwaGFzZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYmouYWxsb3dTbGVlcCAmJiBiai50eXBlID09PSBCb2R5LkRZTkFNSUMgJiYgYmouc2xlZXBTdGF0ZSA9PT0gQm9keS5TTEVFUElORyAmJiBiaS5zbGVlcFN0YXRlID09PSBCb2R5LkFXQUtFICYmIGJpLnR5cGUgIT09IEJvZHkuU1RBVElDKSB7CiAgICAgICAgICBjb25zdCBzcGVlZFNxdWFyZWRBID0gYmkudmVsb2NpdHkubGVuZ3RoU3F1YXJlZCgpICsgYmkuYW5ndWxhclZlbG9jaXR5Lmxlbmd0aFNxdWFyZWQoKTsKICAgICAgICAgIGNvbnN0IHNwZWVkTGltaXRTcXVhcmVkQSA9IGJpLnNsZWVwU3BlZWRMaW1pdCAqKiAyOwoKICAgICAgICAgIGlmIChzcGVlZFNxdWFyZWRBID49IHNwZWVkTGltaXRTcXVhcmVkQSAqIDIpIHsKICAgICAgICAgICAgYmoud2FrZVVwQWZ0ZXJOYXJyb3dwaGFzZSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSAvLyBOb3cgd2Uga25vdyB0aGF0IGkgYW5kIGogYXJlIGluIGNvbnRhY3QuIFNldCBjb2xsaXNpb24gbWF0cml4IHN0YXRlCgoKICAgICAgICB0aGlzLmNvbGxpc2lvbk1hdHJpeC5zZXQoYmksIGJqLCB0cnVlKTsKCiAgICAgICAgaWYgKCF0aGlzLmNvbGxpc2lvbk1hdHJpeFByZXZpb3VzLmdldChiaSwgYmopKSB7CiAgICAgICAgICAvLyBGaXJzdCBjb250YWN0IQogICAgICAgICAgLy8gV2UgcmV1c2UgdGhlIGNvbGxpZGVFdmVudCBvYmplY3QsIG90aGVyd2lzZSB3ZSB3aWxsIGVuZCB1cCBjcmVhdGluZyBuZXcgb2JqZWN0cyBmb3IgZWFjaCBuZXcgY29udGFjdCwgZXZlbiBpZiB0aGVyZSdzIG5vIGV2ZW50IGxpc3RlbmVyIGF0dGFjaGVkLgogICAgICAgICAgV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQuYm9keSA9IGJqOwogICAgICAgICAgV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQuY29udGFjdCA9IGM7CiAgICAgICAgICBiaS5kaXNwYXRjaEV2ZW50KFdvcmxkX3N0ZXBfY29sbGlkZUV2ZW50KTsKICAgICAgICAgIFdvcmxkX3N0ZXBfY29sbGlkZUV2ZW50LmJvZHkgPSBiaTsKICAgICAgICAgIGJqLmRpc3BhdGNoRXZlbnQoV29ybGRfc3RlcF9jb2xsaWRlRXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5ib2R5T3ZlcmxhcEtlZXBlci5zZXQoYmkuaWQsIGJqLmlkKTsKICAgICAgICB0aGlzLnNoYXBlT3ZlcmxhcEtlZXBlci5zZXQoc2kuaWQsIHNqLmlkKTsKICAgICAgfQoKICAgICAgdGhpcy5lbWl0Q29udGFjdEV2ZW50cygpOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5tYWtlQ29udGFjdENvbnN0cmFpbnRzID0gcGVyZm9ybWFuY2Uubm93KCkgLSBwcm9maWxpbmdTdGFydDsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9IC8vIFdha2UgdXAgYm9kaWVzCgoKICAgICAgZm9yIChpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYmkgPSBib2RpZXNbaV07CgogICAgICAgIGlmIChiaS53YWtlVXBBZnRlck5hcnJvd3BoYXNlKSB7CiAgICAgICAgICBiaS53YWtlVXAoKTsKICAgICAgICAgIGJpLndha2VVcEFmdGVyTmFycm93cGhhc2UgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0gLy8gQWRkIHVzZXItYWRkZWQgY29uc3RyYWludHMKCgogICAgICBOY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5sZW5ndGg7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOY29uc3RyYWludHM7IGkrKykgewogICAgICAgIGNvbnN0IGMgPSBjb25zdHJhaW50c1tpXTsKICAgICAgICBjLnVwZGF0ZSgpOwoKICAgICAgICBmb3IgKGxldCBqID0gMCwgTmVxID0gYy5lcXVhdGlvbnMubGVuZ3RoOyBqICE9PSBOZXE7IGorKykgewogICAgICAgICAgY29uc3QgZXEgPSBjLmVxdWF0aW9uc1tqXTsKICAgICAgICAgIHNvbHZlci5hZGRFcXVhdGlvbihlcSk7CiAgICAgICAgfQogICAgICB9IC8vIFNvbHZlIHRoZSBjb25zdHJhaW5lZCBzeXN0ZW0KCgogICAgICBzb2x2ZXIuc29sdmUoZHQsIHRoaXMpOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5zb2x2ZSA9IHBlcmZvcm1hbmNlLm5vdygpIC0gcHJvZmlsaW5nU3RhcnQ7CiAgICAgIH0gLy8gUmVtb3ZlIGFsbCBjb250YWN0cyBmcm9tIHNvbHZlcgoKCiAgICAgIHNvbHZlci5yZW1vdmVBbGxFcXVhdGlvbnMoKTsgLy8gQXBwbHkgZGFtcGluZywgc2VlIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9idWxsZXQvaXNzdWVzL2RldGFpbD9pZD03NCBmb3IgZGV0YWlscwoKICAgICAgY29uc3QgcG93ID0gTWF0aC5wb3c7CgogICAgICBmb3IgKGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICBjb25zdCBiaSA9IGJvZGllc1tpXTsKCiAgICAgICAgaWYgKGJpLnR5cGUgJiBEWU5BTUlDKSB7CiAgICAgICAgICAvLyBPbmx5IGZvciBkeW5hbWljIGJvZGllcwogICAgICAgICAgY29uc3QgbGQgPSBwb3coMS4wIC0gYmkubGluZWFyRGFtcGluZywgZHQpOwogICAgICAgICAgY29uc3QgdiA9IGJpLnZlbG9jaXR5OwogICAgICAgICAgdi5zY2FsZShsZCwgdik7CiAgICAgICAgICBjb25zdCBhdiA9IGJpLmFuZ3VsYXJWZWxvY2l0eTsKCiAgICAgICAgICBpZiAoYXYpIHsKICAgICAgICAgICAgY29uc3QgYWQgPSBwb3coMS4wIC0gYmkuYW5ndWxhckRhbXBpbmcsIGR0KTsKICAgICAgICAgICAgYXYuc2NhbGUoYWQsIGF2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChXb3JsZF9zdGVwX3ByZVN0ZXBFdmVudCk7IC8vIEludm9rZSBwcmUtc3RlcCBjYWxsYmFja3MKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGJpID0gYm9kaWVzW2ldOwoKICAgICAgICBpZiAoYmkucHJlU3RlcCkgewogICAgICAgICAgYmkucHJlU3RlcC5jYWxsKGJpKTsKICAgICAgICB9CiAgICAgIH0gLy8gTGVhcCBmcm9nCiAgICAgIC8vIHZuZXcgPSB2ICsgaCpmL20KICAgICAgLy8geG5ldyA9IHggKyBoKnZuZXcKCgogICAgICBpZiAoZG9Qcm9maWxpbmcpIHsKICAgICAgICBwcm9maWxpbmdTdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgICB9CgogICAgICBjb25zdCBzdGVwbnVtYmVyID0gdGhpcy5zdGVwbnVtYmVyOwogICAgICBjb25zdCBxdWF0Tm9ybWFsaXplID0gc3RlcG51bWJlciAlICh0aGlzLnF1YXROb3JtYWxpemVTa2lwICsgMSkgPT09IDA7CiAgICAgIGNvbnN0IHF1YXROb3JtYWxpemVGYXN0ID0gdGhpcy5xdWF0Tm9ybWFsaXplRmFzdDsKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGJvZGllc1tpXS5pbnRlZ3JhdGUoZHQsIHF1YXROb3JtYWxpemUsIHF1YXROb3JtYWxpemVGYXN0KTsKICAgICAgfQoKICAgICAgdGhpcy5jbGVhckZvcmNlcygpOwogICAgICB0aGlzLmJyb2FkcGhhc2UuZGlydHkgPSB0cnVlOwoKICAgICAgaWYgKGRvUHJvZmlsaW5nKSB7CiAgICAgICAgcHJvZmlsZS5pbnRlZ3JhdGUgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHByb2ZpbGluZ1N0YXJ0OwogICAgICB9IC8vIFVwZGF0ZSBzdGVwIG51bWJlcgoKCiAgICAgIHRoaXMuc3RlcG51bWJlciArPSAxOwogICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoV29ybGRfc3RlcF9wb3N0U3RlcEV2ZW50KTsgLy8gSW52b2tlIHBvc3Qtc3RlcCBjYWxsYmFja3MKCiAgICAgIGZvciAoaSA9IDA7IGkgIT09IE47IGkrKykgewogICAgICAgIGNvbnN0IGJpID0gYm9kaWVzW2ldOwogICAgICAgIGNvbnN0IHBvc3RTdGVwID0gYmkucG9zdFN0ZXA7CgogICAgICAgIGlmIChwb3N0U3RlcCkgewogICAgICAgICAgcG9zdFN0ZXAuY2FsbChiaSk7CiAgICAgICAgfQogICAgICB9IC8vIFNsZWVwaW5nIHVwZGF0ZQoKCiAgICAgIGxldCBoYXNBY3RpdmVCb2RpZXMgPSB0cnVlOwoKICAgICAgaWYgKHRoaXMuYWxsb3dTbGVlcCkgewogICAgICAgIGhhc0FjdGl2ZUJvZGllcyA9IGZhbHNlOwoKICAgICAgICBmb3IgKGkgPSAwOyBpICE9PSBOOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGJpID0gYm9kaWVzW2ldOwogICAgICAgICAgYmkuc2xlZXBUaWNrKHRoaXMudGltZSk7CgogICAgICAgICAgaWYgKGJpLnNsZWVwU3RhdGUgIT09IEJvZHkuU0xFRVBJTkcpIHsKICAgICAgICAgICAgaGFzQWN0aXZlQm9kaWVzID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMuaGFzQWN0aXZlQm9kaWVzID0gaGFzQWN0aXZlQm9kaWVzOwogICAgfQoKICAgIGVtaXRDb250YWN0RXZlbnRzKCkgewogICAgICBjb25zdCBoYXNCZWdpbkNvbnRhY3QgPSB0aGlzLmhhc0FueUV2ZW50TGlzdGVuZXIoJ2JlZ2luQ29udGFjdCcpOwogICAgICBjb25zdCBoYXNFbmRDb250YWN0ID0gdGhpcy5oYXNBbnlFdmVudExpc3RlbmVyKCdlbmRDb250YWN0Jyk7CgogICAgICBpZiAoaGFzQmVnaW5Db250YWN0IHx8IGhhc0VuZENvbnRhY3QpIHsKICAgICAgICB0aGlzLmJvZHlPdmVybGFwS2VlcGVyLmdldERpZmYoYWRkaXRpb25zLCByZW1vdmFscyk7CiAgICAgIH0KCiAgICAgIGlmIChoYXNCZWdpbkNvbnRhY3QpIHsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IGFkZGl0aW9ucy5sZW5ndGg7IGkgPCBsOyBpICs9IDIpIHsKICAgICAgICAgIGJlZ2luQ29udGFjdEV2ZW50LmJvZHlBID0gdGhpcy5nZXRCb2R5QnlJZChhZGRpdGlvbnNbaV0pOwogICAgICAgICAgYmVnaW5Db250YWN0RXZlbnQuYm9keUIgPSB0aGlzLmdldEJvZHlCeUlkKGFkZGl0aW9uc1tpICsgMV0pOwogICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGJlZ2luQ29udGFjdEV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGJlZ2luQ29udGFjdEV2ZW50LmJvZHlBID0gYmVnaW5Db250YWN0RXZlbnQuYm9keUIgPSBudWxsOwogICAgICB9CgogICAgICBpZiAoaGFzRW5kQ29udGFjdCkgewogICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gcmVtb3ZhbHMubGVuZ3RoOyBpIDwgbDsgaSArPSAyKSB7CiAgICAgICAgICBlbmRDb250YWN0RXZlbnQuYm9keUEgPSB0aGlzLmdldEJvZHlCeUlkKHJlbW92YWxzW2ldKTsKICAgICAgICAgIGVuZENvbnRhY3RFdmVudC5ib2R5QiA9IHRoaXMuZ2V0Qm9keUJ5SWQocmVtb3ZhbHNbaSArIDFdKTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChlbmRDb250YWN0RXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgZW5kQ29udGFjdEV2ZW50LmJvZHlBID0gZW5kQ29udGFjdEV2ZW50LmJvZHlCID0gbnVsbDsKICAgICAgfQoKICAgICAgYWRkaXRpb25zLmxlbmd0aCA9IHJlbW92YWxzLmxlbmd0aCA9IDA7CiAgICAgIGNvbnN0IGhhc0JlZ2luU2hhcGVDb250YWN0ID0gdGhpcy5oYXNBbnlFdmVudExpc3RlbmVyKCdiZWdpblNoYXBlQ29udGFjdCcpOwogICAgICBjb25zdCBoYXNFbmRTaGFwZUNvbnRhY3QgPSB0aGlzLmhhc0FueUV2ZW50TGlzdGVuZXIoJ2VuZFNoYXBlQ29udGFjdCcpOwoKICAgICAgaWYgKGhhc0JlZ2luU2hhcGVDb250YWN0IHx8IGhhc0VuZFNoYXBlQ29udGFjdCkgewogICAgICAgIHRoaXMuc2hhcGVPdmVybGFwS2VlcGVyLmdldERpZmYoYWRkaXRpb25zLCByZW1vdmFscyk7CiAgICAgIH0KCiAgICAgIGlmIChoYXNCZWdpblNoYXBlQ29udGFjdCkgewogICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gYWRkaXRpb25zLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgICAgICAgY29uc3Qgc2hhcGVBID0gdGhpcy5nZXRTaGFwZUJ5SWQoYWRkaXRpb25zW2ldKTsKICAgICAgICAgIGNvbnN0IHNoYXBlQiA9IHRoaXMuZ2V0U2hhcGVCeUlkKGFkZGl0aW9uc1tpICsgMV0pOwogICAgICAgICAgYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5zaGFwZUEgPSBzaGFwZUE7CiAgICAgICAgICBiZWdpblNoYXBlQ29udGFjdEV2ZW50LnNoYXBlQiA9IHNoYXBlQjsKICAgICAgICAgIGlmIChzaGFwZUEpIGJlZ2luU2hhcGVDb250YWN0RXZlbnQuYm9keUEgPSBzaGFwZUEuYm9keTsKICAgICAgICAgIGlmIChzaGFwZUIpIGJlZ2luU2hhcGVDb250YWN0RXZlbnQuYm9keUIgPSBzaGFwZUIuYm9keTsKICAgICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChiZWdpblNoYXBlQ29udGFjdEV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGJlZ2luU2hhcGVDb250YWN0RXZlbnQuYm9keUEgPSBiZWdpblNoYXBlQ29udGFjdEV2ZW50LmJvZHlCID0gYmVnaW5TaGFwZUNvbnRhY3RFdmVudC5zaGFwZUEgPSBiZWdpblNoYXBlQ29udGFjdEV2ZW50LnNoYXBlQiA9IG51bGw7CiAgICAgIH0KCiAgICAgIGlmIChoYXNFbmRTaGFwZUNvbnRhY3QpIHsKICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHJlbW92YWxzLmxlbmd0aDsgaSA8IGw7IGkgKz0gMikgewogICAgICAgICAgY29uc3Qgc2hhcGVBID0gdGhpcy5nZXRTaGFwZUJ5SWQocmVtb3ZhbHNbaV0pOwogICAgICAgICAgY29uc3Qgc2hhcGVCID0gdGhpcy5nZXRTaGFwZUJ5SWQocmVtb3ZhbHNbaSArIDFdKTsKICAgICAgICAgIGVuZFNoYXBlQ29udGFjdEV2ZW50LnNoYXBlQSA9IHNoYXBlQTsKICAgICAgICAgIGVuZFNoYXBlQ29udGFjdEV2ZW50LnNoYXBlQiA9IHNoYXBlQjsKICAgICAgICAgIGlmIChzaGFwZUEpIGVuZFNoYXBlQ29udGFjdEV2ZW50LmJvZHlBID0gc2hhcGVBLmJvZHk7CiAgICAgICAgICBpZiAoc2hhcGVCKSBlbmRTaGFwZUNvbnRhY3RFdmVudC5ib2R5QiA9IHNoYXBlQi5ib2R5OwogICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGVuZFNoYXBlQ29udGFjdEV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGVuZFNoYXBlQ29udGFjdEV2ZW50LmJvZHlBID0gZW5kU2hhcGVDb250YWN0RXZlbnQuYm9keUIgPSBlbmRTaGFwZUNvbnRhY3RFdmVudC5zaGFwZUEgPSBlbmRTaGFwZUNvbnRhY3RFdmVudC5zaGFwZUIgPSBudWxsOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNldHMgYWxsIGJvZHkgZm9yY2VzIGluIHRoZSB3b3JsZCB0byB6ZXJvLgogICAgICovCgoKICAgIGNsZWFyRm9yY2VzKCkgewogICAgICBjb25zdCBib2RpZXMgPSB0aGlzLmJvZGllczsKICAgICAgY29uc3QgTiA9IGJvZGllcy5sZW5ndGg7CgogICAgICBmb3IgKGxldCBpID0gMDsgaSAhPT0gTjsgaSsrKSB7CiAgICAgICAgY29uc3QgYiA9IGJvZGllc1tpXTsKICAgICAgICBiLmZvcmNlOwogICAgICAgIGIudG9ycXVlOwogICAgICAgIGIuZm9yY2Uuc2V0KDAsIDAsIDApOwogICAgICAgIGIudG9ycXVlLnNldCgwLCAwLCAwKTsKICAgICAgfQogICAgfQoKICB9IC8vIFRlbXAgc3R1ZmYKCgogIG5ldyBBQUJCKCk7CiAgY29uc3QgdG1wUmF5ID0gbmV3IFJheSgpOyAvLyBwZXJmb3JtYW5jZS5ub3coKSBmYWxsYmFjayBvbiBEYXRlLm5vdygpCgogIGNvbnN0IHBlcmZvcm1hbmNlID0gZ2xvYmFsVGhpcy5wZXJmb3JtYW5jZSB8fCB7fTsKCiAgaWYgKCFwZXJmb3JtYW5jZS5ub3cpIHsKICAgIGxldCBub3dPZmZzZXQgPSBEYXRlLm5vdygpOwoKICAgIGlmIChwZXJmb3JtYW5jZS50aW1pbmcgJiYgcGVyZm9ybWFuY2UudGltaW5nLm5hdmlnYXRpb25TdGFydCkgewogICAgICBub3dPZmZzZXQgPSBwZXJmb3JtYW5jZS50aW1pbmcubmF2aWdhdGlvblN0YXJ0OwogICAgfQoKICAgIHBlcmZvcm1hbmNlLm5vdyA9ICgpID0+IERhdGUubm93KCkgLSBub3dPZmZzZXQ7CiAgfSAvLyBSZXVzYWJsZSBldmVudCBvYmplY3RzIHRvIHNhdmUgbWVtb3J5LgoKCiAgY29uc3QgV29ybGRfc3RlcF9wb3N0U3RlcEV2ZW50ID0gewogICAgdHlwZTogJ3Bvc3RTdGVwJwogIH07IC8vIERpc3BhdGNoZWQgYmVmb3JlIHRoZSB3b3JsZCBzdGVwcyBmb3J3YXJkIGluIHRpbWUuCgogIGNvbnN0IFdvcmxkX3N0ZXBfcHJlU3RlcEV2ZW50ID0gewogICAgdHlwZTogJ3ByZVN0ZXAnCiAgfTsKICBjb25zdCBXb3JsZF9zdGVwX2NvbGxpZGVFdmVudCA9IHsKICAgIHR5cGU6IEJvZHkuQ09MTElERV9FVkVOVF9OQU1FLAogICAgYm9keTogbnVsbCwKICAgIGNvbnRhY3Q6IG51bGwKICB9OyAvLyBQb29scyBmb3IgdW51c2VkIG9iamVjdHMKCiAgY29uc3QgV29ybGRfc3RlcF9vbGRDb250YWN0cyA9IFtdOwogIGNvbnN0IFdvcmxkX3N0ZXBfZnJpY3Rpb25FcXVhdGlvblBvb2wgPSBbXTsgLy8gUmV1c2FibGUgYXJyYXlzIGZvciBjb2xsaXNpb24gcGFpcnMKCiAgY29uc3QgV29ybGRfc3RlcF9wMSA9IFtdOwogIGNvbnN0IFdvcmxkX3N0ZXBfcDIgPSBbXTsgLy8gU3R1ZmYgZm9yIGVtaXRDb250YWN0RXZlbnRzCgogIGNvbnN0IGFkZGl0aW9ucyA9IFtdOwogIGNvbnN0IHJlbW92YWxzID0gW107CiAgY29uc3QgYmVnaW5Db250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnYmVnaW5Db250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwKICB9OwogIGNvbnN0IGVuZENvbnRhY3RFdmVudCA9IHsKICAgIHR5cGU6ICdlbmRDb250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwKICB9OwogIGNvbnN0IGJlZ2luU2hhcGVDb250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnYmVnaW5TaGFwZUNvbnRhY3QnLAogICAgYm9keUE6IG51bGwsCiAgICBib2R5QjogbnVsbCwKICAgIHNoYXBlQTogbnVsbCwKICAgIHNoYXBlQjogbnVsbAogIH07CiAgY29uc3QgZW5kU2hhcGVDb250YWN0RXZlbnQgPSB7CiAgICB0eXBlOiAnZW5kU2hhcGVDb250YWN0JywKICAgIGJvZHlBOiBudWxsLAogICAgYm9keUI6IG51bGwsCiAgICBzaGFwZUE6IG51bGwsCiAgICBzaGFwZUI6IG51bGwKICB9OwoKICAvKioKICAgKiBAdHlwZWRlZiB7IGltcG9ydCgnY2Fubm9uLWVzJykuTWF0ZXJpYWxPcHRpb25zIH0gTWF0ZXJpYWxPcHRpb25zCiAgICovCgogIGNvbnN0IG1ha2VWZWMzID0gX3JlZiA9PiB7CiAgICBsZXQgW3gsIHksIHpdID0gX3JlZjsKICAgIHJldHVybiBuZXcgVmVjMyh4LCB5LCB6KTsKICB9OwoKICBjb25zdCBwcmVwYXJlU3BoZXJlID0gYXJncyA9PiBBcnJheS5pc0FycmF5KGFyZ3MpID8gYXJncyA6IFthcmdzXTsKCiAgY29uc3QgcHJlcGFyZUNvbnZleFBvbHloZWRyb24gPSBfcmVmMiA9PiB7CiAgICBsZXQgW3YsIGZhY2VzLCBuLCBhLCBib3VuZGluZ1NwaGVyZVJhZGl1c10gPSBfcmVmMjsKICAgIHJldHVybiBbewogICAgICBheGVzOiBhID8gYS5tYXAobWFrZVZlYzMpIDogdW5kZWZpbmVkLAogICAgICBib3VuZGluZ1NwaGVyZVJhZGl1cywKICAgICAgZmFjZXMsCiAgICAgIG5vcm1hbHM6IG4gPyBuLm1hcChtYWtlVmVjMykgOiB1bmRlZmluZWQsCiAgICAgIHZlcnRpY2VzOiB2ID8gdi5tYXAobWFrZVZlYzMpIDogdW5kZWZpbmVkCiAgICB9XTsKICB9OwoKICBmdW5jdGlvbiBjcmVhdGVTaGFwZSh0eXBlLCBhcmdzKSB7CiAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgY2FzZSAnQm94JzoKICAgICAgICByZXR1cm4gbmV3IEJveChuZXcgVmVjMyguLi5hcmdzLm1hcCh2ID0+IHYgLyAyKSkpOwogICAgICAvLyBleHRlbnRzID0+IGhhbGZFeHRlbnRzCgogICAgICBjYXNlICdDb252ZXhQb2x5aGVkcm9uJzoKICAgICAgICByZXR1cm4gbmV3IENvbnZleFBvbHloZWRyb24oLi4ucHJlcGFyZUNvbnZleFBvbHloZWRyb24oYXJncykpOwoKICAgICAgY2FzZSAnQ3lsaW5kZXInOgogICAgICAgIHJldHVybiBuZXcgQ3lsaW5kZXIoLi4uYXJncyk7CiAgICAgIC8vIFsgcmFkaXVzVG9wLCByYWRpdXNCb3R0b20sIGhlaWdodCwgbnVtU2VnbWVudHMgXSA9IGFyZ3MKCiAgICAgIGNhc2UgJ0hlaWdodGZpZWxkJzoKICAgICAgICByZXR1cm4gbmV3IEhlaWdodGZpZWxkKC4uLmFyZ3MpOwogICAgICAvLyBbIEFycmF5IGRhdGEsIG9wdGlvbnM6IHttaW5WYWx1ZSwgbWF4VmFsdWUsIGVsZW1lbnRTaXplfSAgXSA9IGFyZ3MKCiAgICAgIGNhc2UgJ1BhcnRpY2xlJzoKICAgICAgICByZXR1cm4gbmV3IFBhcnRpY2xlKCk7CiAgICAgIC8vIG5vIGFyZ3MKCiAgICAgIGNhc2UgJ1BsYW5lJzoKICAgICAgICByZXR1cm4gbmV3IFBsYW5lKCk7CiAgICAgIC8vIG5vIGFyZ3MsIGluZmluaXRlIHggYW5kIHkKCiAgICAgIGNhc2UgJ1NwaGVyZSc6CiAgICAgICAgcmV0dXJuIG5ldyBTcGhlcmUoLi4ucHJlcGFyZVNwaGVyZShhcmdzKSk7CiAgICAgIC8vIHJhZGl1cyA9IGFyZ3MKCiAgICAgIGNhc2UgJ1RyaW1lc2gnOgogICAgICAgIHJldHVybiBuZXcgVHJpbWVzaCguLi5hcmdzKTsKICAgICAgLy8gW3ZlcnRpY2VzLCBpbmRpY2VzXSA9IGFyZ3MKICAgIH0KICB9CiAgLyoqCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKiBAcGFyYW0ge3N0cmluZ30gb3B0aW9ucy51dWlkCiAgICogQHBhcmFtIHtCb2R5UHJvcHN9IG9wdGlvbnMucHJvcHMKICAgKiBAcGFyYW0ge0JvZHlTaGFwZVR5cGV9IG9wdGlvbnMudHlwZQogICAqIEBwYXJhbSB7KG1hdGVyaWFsT3B0aW9uczogTWF0ZXJpYWxPcHRpb25zKSA9PiBNYXRlcmlhbCA9fSBvcHRpb25zLmNyZWF0ZU1hdGVyaWFsCiAgICogQHJldHVybnMge0JvZHl9CiAgICovCgoKICBjb25zdCBwcm9wc1RvQm9keSA9IG9wdGlvbnMgPT4gewogICAgY29uc3QgewogICAgICB1dWlkLAogICAgICBwcm9wcywKICAgICAgdHlwZSwKICAgICAgY3JlYXRlTWF0ZXJpYWwgPSBtYXRlcmlhbE9wdGlvbnMgPT4gbmV3IE1hdGVyaWFsKG1hdGVyaWFsT3B0aW9ucykKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgewogICAgICBhbmd1bGFyRmFjdG9yID0gWzEsIDEsIDFdLAogICAgICBhbmd1bGFyVmVsb2NpdHkgPSBbMCwgMCwgMF0sCiAgICAgIGFyZ3MgPSBbXSwKICAgICAgY29sbGlzaW9uUmVzcG9uc2UsCiAgICAgIGxpbmVhckZhY3RvciA9IFsxLCAxLCAxXSwKICAgICAgbWFzcywKICAgICAgbWF0ZXJpYWwsCiAgICAgIG9uQ29sbGlkZSwKICAgICAgcG9zaXRpb24gPSBbMCwgMCwgMF0sCiAgICAgIHJvdGF0aW9uID0gWzAsIDAsIDBdLAogICAgICBzaGFwZXMsCiAgICAgIHR5cGU6IGJvZHlUeXBlLAogICAgICB2ZWxvY2l0eSA9IFswLCAwLCAwXSwKICAgICAgLi4uZXh0cmEKICAgIH0gPSBwcm9wczsKICAgIGNvbnN0IGJvZHkgPSBuZXcgQm9keSh7IC4uLmV4dHJhLAogICAgICBtYXNzOiBib2R5VHlwZSA9PT0gJ1N0YXRpYycgPyAwIDogbWFzcywKICAgICAgbWF0ZXJpYWw6IG1hdGVyaWFsID8gY3JlYXRlTWF0ZXJpYWwobWF0ZXJpYWwpIDogdW5kZWZpbmVkLAogICAgICB0eXBlOiBib2R5VHlwZSA/IEJvZHlbYm9keVR5cGUudG9VcHBlckNhc2UoKV0gOiB1bmRlZmluZWQKICAgIH0pOwogICAgYm9keS51dWlkID0gdXVpZDsKCiAgICBpZiAoY29sbGlzaW9uUmVzcG9uc2UgIT09IHVuZGVmaW5lZCkgewogICAgICBib2R5LmNvbGxpc2lvblJlc3BvbnNlID0gY29sbGlzaW9uUmVzcG9uc2U7CiAgICB9CgogICAgaWYgKHR5cGUgPT09ICdDb21wb3VuZCcpIHsKICAgICAgc2hhcGVzLmZvckVhY2goX3JlZjMgPT4gewogICAgICAgIGxldCB7CiAgICAgICAgICB0eXBlLAogICAgICAgICAgYXJncywKICAgICAgICAgIHBvc2l0aW9uLAogICAgICAgICAgcm90YXRpb24sCiAgICAgICAgICBtYXRlcmlhbCwKICAgICAgICAgIC4uLmV4dHJhCiAgICAgICAgfSA9IF9yZWYzOwogICAgICAgIGNvbnN0IHNoYXBlQm9keSA9IGJvZHkuYWRkU2hhcGUoY3JlYXRlU2hhcGUodHlwZSwgYXJncyksIHBvc2l0aW9uID8gbmV3IFZlYzMoLi4ucG9zaXRpb24pIDogdW5kZWZpbmVkLCByb3RhdGlvbiA/IG5ldyBRdWF0ZXJuaW9uKCkuc2V0RnJvbUV1bGVyKC4uLnJvdGF0aW9uKSA6IHVuZGVmaW5lZCk7CiAgICAgICAgaWYgKG1hdGVyaWFsKSBzaGFwZUJvZHkubWF0ZXJpYWwgPSBjcmVhdGVNYXRlcmlhbChtYXRlcmlhbCk7CiAgICAgICAgT2JqZWN0LmFzc2lnbihzaGFwZUJvZHksIGV4dHJhKTsKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBib2R5LmFkZFNoYXBlKGNyZWF0ZVNoYXBlKHR5cGUsIGFyZ3MpKTsKICAgIH0KCiAgICBib2R5LnBvc2l0aW9uLnNldChwb3NpdGlvblswXSwgcG9zaXRpb25bMV0sIHBvc2l0aW9uWzJdKTsKICAgIGJvZHkucXVhdGVybmlvbi5zZXRGcm9tRXVsZXIocm90YXRpb25bMF0sIHJvdGF0aW9uWzFdLCByb3RhdGlvblsyXSk7CiAgICBib2R5LnZlbG9jaXR5LnNldCh2ZWxvY2l0eVswXSwgdmVsb2NpdHlbMV0sIHZlbG9jaXR5WzJdKTsKICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5LnNldChhbmd1bGFyVmVsb2NpdHlbMF0sIGFuZ3VsYXJWZWxvY2l0eVsxXSwgYW5ndWxhclZlbG9jaXR5WzJdKTsKICAgIGJvZHkubGluZWFyRmFjdG9yLnNldChsaW5lYXJGYWN0b3JbMF0sIGxpbmVhckZhY3RvclsxXSwgbGluZWFyRmFjdG9yWzJdKTsKICAgIGJvZHkuYW5ndWxhckZhY3Rvci5zZXQoYW5ndWxhckZhY3RvclswXSwgYW5ndWxhckZhY3RvclsxXSwgYW5ndWxhckZhY3RvclsyXSk7CiAgICByZXR1cm4gYm9keTsKICB9OwoKICB2YXIgcHJvcHNUb0JvZHkkMSA9IHByb3BzVG9Cb2R5OwoKICBjb25zdCBhZGRDb250YWN0TWF0ZXJpYWwgPSAod29ybGQsIGNyZWF0ZU1hdGVyaWFsLCBfcmVmLCB1dWlkKSA9PiB7CiAgICBsZXQgW21hdGVyaWFsQSwgbWF0ZXJpYWxCLCBvcHRpb25zXSA9IF9yZWY7CiAgICBjb25zdCBtYXRBID0gY3JlYXRlTWF0ZXJpYWwobWF0ZXJpYWxBKTsKICAgIGNvbnN0IG1hdEIgPSBjcmVhdGVNYXRlcmlhbChtYXRlcmlhbEIpOwogICAgY29uc3QgY29udGFjdE1hdGVyaWFsID0gbmV3IENvbnRhY3RNYXRlcmlhbChtYXRBLCBtYXRCLCBvcHRpb25zKTsKICAgIGNvbnRhY3RNYXRlcmlhbC51dWlkID0gdXVpZDsKICAgIHdvcmxkLmFkZENvbnRhY3RNYXRlcmlhbChjb250YWN0TWF0ZXJpYWwpOwogIH07CiAgY29uc3QgcmVtb3ZlQ29udGFjdE1hdGVyaWFsID0gKHdvcmxkLCBjbVVVSUQpID0+IHsKICAgIGNvbnN0IGluZGV4ID0gd29ybGQuY29udGFjdG1hdGVyaWFscy5maW5kSW5kZXgoX3JlZjIgPT4gewogICAgICBsZXQgewogICAgICAgIHV1aWQKICAgICAgfSA9IF9yZWYyOwogICAgICByZXR1cm4gdXVpZCA9PT0gY21VVUlEOwogICAgfSk7CiAgICBjb25zdCBbewogICAgICBpZDogaQogICAgfSwgewogICAgICBpZDogagogICAgfV0gPSB3b3JsZC5jb250YWN0bWF0ZXJpYWxzW2luZGV4XS5tYXRlcmlhbHM7CiAgICB3b3JsZC5jb250YWN0bWF0ZXJpYWxzLnNwbGljZShpbmRleCwgMSk7CiAgICBkZWxldGUgd29ybGQuY29udGFjdE1hdGVyaWFsVGFibGUuZGF0YVtpIDwgaiA/IGAke2l9LSR7an1gIDogYCR7an0tJHtpfWBdOwogIH07CgogIGxldCBtYXRlcmlhbElkID0gMDsKICBjb25zdCBjcmVhdGVNYXRlcmlhbEZhY3RvcnkgPSBtYXRlcmlhbHMgPT4gZnVuY3Rpb24gKG5hbWVPck9wdGlvbnMpIHsKICAgIGlmIChuYW1lT3JPcHRpb25zID09PSB2b2lkIDApIHsKICAgICAgbmFtZU9yT3B0aW9ucyA9IHt9OwogICAgfQoKICAgIGNvbnN0IG1hdGVyaWFsT3B0aW9ucyA9IHR5cGVvZiBuYW1lT3JPcHRpb25zID09PSAnc3RyaW5nJyA/IHsKICAgICAgbmFtZTogbmFtZU9yT3B0aW9ucwogICAgfSA6IHsKICAgICAgbmFtZTogU3ltYm9sLmZvcihgTWF0ZXJpYWwke21hdGVyaWFsSWQrK31gKSwKICAgICAgLi4ubmFtZU9yT3B0aW9ucwogICAgfTsKICAgIGNvbnN0IHsKICAgICAgbmFtZQogICAgfSA9IG1hdGVyaWFsT3B0aW9uczsKICAgIG1hdGVyaWFsc1tuYW1lXSA9IG1hdGVyaWFsc1tuYW1lXSB8fCBuZXcgTWF0ZXJpYWwobWF0ZXJpYWxPcHRpb25zKTsKICAgIHJldHVybiBtYXRlcmlhbHNbbmFtZV07CiAgfTsKCiAgY29uc3Qgd29ybGQgPSBuZXcgV29ybGQoKTsKICBjb25zdCBzdGF0ZSA9IHsKICAgIGJvZGllczoge30sCiAgICBib2RpZXNOZWVkU3luY2luZzogZmFsc2UsCiAgICBjb25zdHJhaW50czoge30sCiAgICBtYXRlcmlhbHM6IHt9LAogICAgcmF5czoge30sCiAgICBzcHJpbmdJbnN0YW5jZXM6IHt9LAogICAgc3ByaW5nczoge30sCiAgICBzdWJzY3JpcHRpb25zOiB7fSwKICAgIHZlaGljbGVzOiB7fSwKICAgIHdvcmxkCiAgfTsKCiAgZnVuY3Rpb24gc3luY0JvZGllcygpIHsKICAgIHN0YXRlLmJvZGllc05lZWRTeW5jaW5nID0gdHJ1ZTsKICAgIHN0YXRlLmJvZGllcyA9IHN0YXRlLndvcmxkLmJvZGllcy5yZWR1Y2UoKGFjYywgYm9keSkgPT4gKHsgLi4uYWNjLAogICAgICBbYm9keS51dWlkXTogYm9keQogICAgfSksIHt9KTsKICB9CgogIGZ1bmN0aW9uIGVtaXRCZWdpbkNvbnRhY3QoX3JlZikgewogICAgbGV0IHsKICAgICAgYm9keUEsCiAgICAgIGJvZHlCCiAgICB9ID0gX3JlZjsKICAgIGlmICghYm9keUEgfHwgIWJvZHlCKSByZXR1cm47CiAgICBzZWxmLnBvc3RNZXNzYWdlKHsKICAgICAgYm9keUE6IGJvZHlBLnV1aWQsCiAgICAgIGJvZHlCOiBib2R5Qi51dWlkLAogICAgICBvcDogJ2V2ZW50JywKICAgICAgdHlwZTogJ2NvbGxpZGVCZWdpbicKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZW1pdEVuZENvbnRhY3QoX3JlZjIpIHsKICAgIGxldCB7CiAgICAgIGJvZHlBLAogICAgICBib2R5QgogICAgfSA9IF9yZWYyOwogICAgaWYgKCFib2R5QSB8fCAhYm9keUIpIHJldHVybjsKICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICBib2R5QTogYm9keUEudXVpZCwKICAgICAgYm9keUI6IGJvZHlCLnV1aWQsCiAgICAgIG9wOiAnZXZlbnQnLAogICAgICB0eXBlOiAnY29sbGlkZUVuZCcKICAgIH0pOwogIH0KCiAgY29uc3QgYnJvYWRwaGFzZXMgPSB7CiAgICBOYWl2ZUJyb2FkcGhhc2UsCiAgICBTQVBCcm9hZHBoYXNlCiAgfTsKICBjb25zdCBjcmVhdGVNYXRlcmlhbCA9IGNyZWF0ZU1hdGVyaWFsRmFjdG9yeShzdGF0ZS53b3JsZC5tYXRlcmlhbHMpOwoKICBzZWxmLm9ubWVzc2FnZSA9IF9yZWYzID0+IHsKICAgIGxldCB7CiAgICAgIGRhdGE6IHsKICAgICAgICBvcCwKICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgcHJvcHMsCiAgICAgICAgcXVhdGVybmlvbnMsCiAgICAgICAgdHlwZSwKICAgICAgICB1dWlkCiAgICAgIH0KICAgIH0gPSBfcmVmMzsKCiAgICBzd2l0Y2ggKG9wKSB7CiAgICAgIGNhc2UgJ2luaXQnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgYWxsb3dTbGVlcCwKICAgICAgICAgICAgYXhpc0luZGV4LAogICAgICAgICAgICBicm9hZHBoYXNlLAogICAgICAgICAgICBkZWZhdWx0Q29udGFjdE1hdGVyaWFsLAogICAgICAgICAgICBncmF2aXR5LAogICAgICAgICAgICBpdGVyYXRpb25zLAogICAgICAgICAgICBxdWF0Tm9ybWFsaXplRmFzdCwKICAgICAgICAgICAgcXVhdE5vcm1hbGl6ZVNraXAsCiAgICAgICAgICAgIHNvbHZlciwKICAgICAgICAgICAgdG9sZXJhbmNlCiAgICAgICAgICB9ID0gcHJvcHM7CiAgICAgICAgICBzdGF0ZS53b3JsZC5hbGxvd1NsZWVwID0gYWxsb3dTbGVlcDsKICAgICAgICAgIHN0YXRlLndvcmxkLmdyYXZpdHkuc2V0KGdyYXZpdHlbMF0sIGdyYXZpdHlbMV0sIGdyYXZpdHlbMl0pOwogICAgICAgICAgc3RhdGUud29ybGQucXVhdE5vcm1hbGl6ZUZhc3QgPSBxdWF0Tm9ybWFsaXplRmFzdDsKICAgICAgICAgIHN0YXRlLndvcmxkLnF1YXROb3JtYWxpemVTa2lwID0gcXVhdE5vcm1hbGl6ZVNraXA7CgogICAgICAgICAgaWYgKHNvbHZlciA9PT0gJ1NwbGl0JykgewogICAgICAgICAgICBzdGF0ZS53b3JsZC5zb2x2ZXIgPSBuZXcgU3BsaXRTb2x2ZXIobmV3IEdTU29sdmVyKCkpOwogICAgICAgICAgfQoKICAgICAgICAgIHN0YXRlLndvcmxkLnNvbHZlci50b2xlcmFuY2UgPSB0b2xlcmFuY2U7CiAgICAgICAgICBzdGF0ZS53b3JsZC5zb2x2ZXIuaXRlcmF0aW9ucyA9IGl0ZXJhdGlvbnM7CiAgICAgICAgICBzdGF0ZS53b3JsZC5icm9hZHBoYXNlID0gbmV3IChicm9hZHBoYXNlc1ticm9hZHBoYXNlICsgJ0Jyb2FkcGhhc2UnXSB8fCBOYWl2ZUJyb2FkcGhhc2UpKHN0YXRlLndvcmxkKTsKICAgICAgICAgIHN0YXRlLndvcmxkLmJyb2FkcGhhc2UuYXhpc0luZGV4ID0gYXhpc0luZGV4ID09PSB1bmRlZmluZWQgfHwgYXhpc0luZGV4ID09PSBudWxsID8gMCA6IGF4aXNJbmRleDsKICAgICAgICAgIHN0YXRlLndvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ2JlZ2luQ29udGFjdCcsIGVtaXRCZWdpbkNvbnRhY3QpOwogICAgICAgICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcignZW5kQ29udGFjdCcsIGVtaXRFbmRDb250YWN0KTsKICAgICAgICAgIE9iamVjdC5hc3NpZ24oc3RhdGUud29ybGQuZGVmYXVsdENvbnRhY3RNYXRlcmlhbCwgZGVmYXVsdENvbnRhY3RNYXRlcmlhbCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdzdGVwJzoKICAgICAgICB7CiAgICAgICAgICBzdGF0ZS53b3JsZC5zdGVwKHByb3BzLnN0ZXBTaXplLCBwcm9wcy50aW1lU2luY2VMYXN0Q2FsbGVkLCBwcm9wcy5tYXhTdWJTdGVwcyk7CiAgICAgICAgICBjb25zdCBudW1iZXJPZkJvZGllcyA9IHN0YXRlLndvcmxkLmJvZGllcy5sZW5ndGg7CgogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1iZXJPZkJvZGllczsgaSsrKSB7CiAgICAgICAgICAgIGxldCBiID0gc3RhdGUud29ybGQuYm9kaWVzW2ldLAogICAgICAgICAgICAgICAgcCA9IGIucG9zaXRpb24sCiAgICAgICAgICAgICAgICBxID0gYi5xdWF0ZXJuaW9uOwogICAgICAgICAgICBwb3NpdGlvbnNbMyAqIGkgKyAwXSA9IHAueDsKICAgICAgICAgICAgcG9zaXRpb25zWzMgKiBpICsgMV0gPSBwLnk7CiAgICAgICAgICAgIHBvc2l0aW9uc1szICogaSArIDJdID0gcC56OwogICAgICAgICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDBdID0gcS54OwogICAgICAgICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDFdID0gcS55OwogICAgICAgICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDJdID0gcS56OwogICAgICAgICAgICBxdWF0ZXJuaW9uc1s0ICogaSArIDNdID0gcS53OwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IG9ic2VydmF0aW9ucyA9IFtdOwoKICAgICAgICAgIGZvciAoY29uc3QgaWQgb2YgT2JqZWN0LmtleXMoc3RhdGUuc3Vic2NyaXB0aW9ucykpIHsKICAgICAgICAgICAgbGV0IFt1dWlkLCB0eXBlLCB0YXJnZXQgPSAnYm9kaWVzJ10gPSBzdGF0ZS5zdWJzY3JpcHRpb25zW2lkXTsKICAgICAgICAgICAgbGV0IG9iamVjdCA9IHN0YXRlW3RhcmdldF07CiAgICAgICAgICAgIGlmICghb2JqZWN0IHx8ICFvYmplY3RbdXVpZF0pIGNvbnRpbnVlOwogICAgICAgICAgICBsZXQgdmFsdWUgPSBvYmplY3RbdXVpZF1bdHlwZV07CiAgICAgICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFZlYzMgfHwgdmFsdWUgaW5zdGFuY2VvZiBRdWF0ZXJuaW9uKSB2YWx1ZSA9IHZhbHVlLnRvQXJyYXkoKTsKICAgICAgICAgICAgb2JzZXJ2YXRpb25zLnB1c2goW2lkLCB2YWx1ZSwgdHlwZV0pOwogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB7CiAgICAgICAgICAgIGFjdGl2ZTogc3RhdGUud29ybGQuaGFzQWN0aXZlQm9kaWVzLAogICAgICAgICAgICBvYnNlcnZhdGlvbnMsCiAgICAgICAgICAgIG9wOiAnZnJhbWUnLAogICAgICAgICAgICBwb3NpdGlvbnMsCiAgICAgICAgICAgIHF1YXRlcm5pb25zCiAgICAgICAgICB9OwoKICAgICAgICAgIGlmIChzdGF0ZS5ib2RpZXNOZWVkU3luY2luZykgewogICAgICAgICAgICBtZXNzYWdlLmJvZGllcyA9IHN0YXRlLndvcmxkLmJvZGllcy5tYXAoYm9keSA9PiBib2R5LnV1aWQpOwogICAgICAgICAgICBzdGF0ZS5ib2RpZXNOZWVkU3luY2luZyA9IGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICAgIHNlbGYucG9zdE1lc3NhZ2UobWVzc2FnZSwgW3Bvc2l0aW9ucy5idWZmZXIsIHF1YXRlcm5pb25zLmJ1ZmZlcl0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnYWRkQm9kaWVzJzoKICAgICAgICB7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHV1aWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgYm9keSA9IHByb3BzVG9Cb2R5JDEoewogICAgICAgICAgICAgIGNyZWF0ZU1hdGVyaWFsLAogICAgICAgICAgICAgIHByb3BzOiBwcm9wc1tpXSwKICAgICAgICAgICAgICB0eXBlLAogICAgICAgICAgICAgIHV1aWQ6IHV1aWRbaV0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHN0YXRlLndvcmxkLmFkZEJvZHkoYm9keSk7CiAgICAgICAgICAgIGlmIChwcm9wc1tpXS5vbkNvbGxpZGUpIGJvZHkuYWRkRXZlbnRMaXN0ZW5lcignY29sbGlkZScsIF9yZWY0ID0+IHsKICAgICAgICAgICAgICBsZXQgewogICAgICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgICAgIGJvZHksCiAgICAgICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgICAgICBjb250YWN0CiAgICAgICAgICAgICAgfSA9IF9yZWY0OwogICAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICAgIG5pLAogICAgICAgICAgICAgICAgcmksCiAgICAgICAgICAgICAgICByaiwKICAgICAgICAgICAgICAgIGJpLAogICAgICAgICAgICAgICAgYmosCiAgICAgICAgICAgICAgICBpZAogICAgICAgICAgICAgIH0gPSBjb250YWN0OwogICAgICAgICAgICAgIGNvbnN0IGNvbnRhY3RQb2ludCA9IGJpLnBvc2l0aW9uLnZhZGQocmkpOwogICAgICAgICAgICAgIGNvbnN0IGNvbnRhY3ROb3JtYWwgPSBiaSA9PT0gYm9keSA/IG5pIDogbmkuc2NhbGUoLTEpOwogICAgICAgICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoewogICAgICAgICAgICAgICAgYm9keTogYm9keS51dWlkLAogICAgICAgICAgICAgICAgY29sbGlzaW9uRmlsdGVyczogewogICAgICAgICAgICAgICAgICBib2R5RmlsdGVyR3JvdXA6IGJvZHkuY29sbGlzaW9uRmlsdGVyR3JvdXAsCiAgICAgICAgICAgICAgICAgIGJvZHlGaWx0ZXJNYXNrOiBib2R5LmNvbGxpc2lvbkZpbHRlck1hc2ssCiAgICAgICAgICAgICAgICAgIHRhcmdldEZpbHRlckdyb3VwOiB0YXJnZXQuY29sbGlzaW9uRmlsdGVyR3JvdXAsCiAgICAgICAgICAgICAgICAgIHRhcmdldEZpbHRlck1hc2s6IHRhcmdldC5jb2xsaXNpb25GaWx0ZXJNYXNrCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY29udGFjdDogewogICAgICAgICAgICAgICAgICBiaTogYmkudXVpZCwKICAgICAgICAgICAgICAgICAgYmo6IGJqLnV1aWQsCiAgICAgICAgICAgICAgICAgIC8vIE5vcm1hbCBvZiB0aGUgY29udGFjdCwgcmVsYXRpdmUgdG8gdGhlIGNvbGxpZGluZyBib2R5CiAgICAgICAgICAgICAgICAgIGNvbnRhY3ROb3JtYWw6IGNvbnRhY3ROb3JtYWwudG9BcnJheSgpLAogICAgICAgICAgICAgICAgICAvLyBXb3JsZCBwb3NpdGlvbiBvZiB0aGUgY29udGFjdAogICAgICAgICAgICAgICAgICBjb250YWN0UG9pbnQ6IGNvbnRhY3RQb2ludC50b0FycmF5KCksCiAgICAgICAgICAgICAgICAgIGlkLAogICAgICAgICAgICAgICAgICBpbXBhY3RWZWxvY2l0eTogY29udGFjdC5nZXRJbXBhY3RWZWxvY2l0eUFsb25nTm9ybWFsKCksCiAgICAgICAgICAgICAgICAgIG5pOiBuaS50b0FycmF5KCksCiAgICAgICAgICAgICAgICAgIHJpOiByaS50b0FycmF5KCksCiAgICAgICAgICAgICAgICAgIHJqOiByai50b0FycmF5KCkKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBvcDogJ2V2ZW50JywKICAgICAgICAgICAgICAgIHRhcmdldDogdGFyZ2V0LnV1aWQsCiAgICAgICAgICAgICAgICB0eXBlCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIHN5bmNCb2RpZXMoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ3JlbW92ZUJvZGllcyc6CiAgICAgICAgewogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1dWlkLmxlbmd0aDsgaSsrKSBzdGF0ZS53b3JsZC5yZW1vdmVCb2R5KHN0YXRlLmJvZGllc1t1dWlkW2ldXSk7CgogICAgICAgICAgc3luY0JvZGllcygpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnc3Vic2NyaWJlJzoKICAgICAgICB7CiAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgIGlkLAogICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIHR5cGUKICAgICAgICAgIH0gPSBwcm9wczsKICAgICAgICAgIHN0YXRlLnN1YnNjcmlwdGlvbnNbaWRdID0gW3V1aWQsIHR5cGUsIHRhcmdldF07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICd1bnN1YnNjcmliZSc6CiAgICAgICAgewogICAgICAgICAgZGVsZXRlIHN0YXRlLnN1YnNjcmlwdGlvbnNbcHJvcHNdOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnc2V0UG9zaXRpb24nOgogICAgICAgIHN0YXRlLmJvZGllc1t1dWlkXS5wb3NpdGlvbi5zZXQocHJvcHNbMF0sIHByb3BzWzFdLCBwcm9wc1syXSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRRdWF0ZXJuaW9uJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0ucXVhdGVybmlvbi5zZXQocHJvcHNbMF0sIHByb3BzWzFdLCBwcm9wc1syXSwgcHJvcHNbM10pOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2V0Um90YXRpb24nOgogICAgICAgIHN0YXRlLmJvZGllc1t1dWlkXS5xdWF0ZXJuaW9uLnNldEZyb21FdWxlcihwcm9wc1swXSwgcHJvcHNbMV0sIHByb3BzWzJdKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NldFZlbG9jaXR5JzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0udmVsb2NpdHkuc2V0KHByb3BzWzBdLCBwcm9wc1sxXSwgcHJvcHNbMl0pOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2V0QW5ndWxhclZlbG9jaXR5JzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0uYW5ndWxhclZlbG9jaXR5LnNldChwcm9wc1swXSwgcHJvcHNbMV0sIHByb3BzWzJdKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NldExpbmVhckZhY3Rvcic6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLmxpbmVhckZhY3Rvci5zZXQocHJvcHNbMF0sIHByb3BzWzFdLCBwcm9wc1syXSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRBbmd1bGFyRmFjdG9yJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0uYW5ndWxhckZhY3Rvci5zZXQocHJvcHNbMF0sIHByb3BzWzFdLCBwcm9wc1syXSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRNYXNzJzoKICAgICAgICAvLyBhc3N1bWUgdGhhdCBhbiB1cGRhdGUgZnJvbSB6ZXJvLW1hc3MgaW1wbGllcyBhIG5lZWQgZm9yIGR5bmFtaWNzIG9uIHN0YXRpYyBvYmouCiAgICAgICAgaWYgKHByb3BzICE9PSAwICYmIHN0YXRlLmJvZGllc1t1dWlkXS50eXBlID09PSAwKSBzdGF0ZS5ib2RpZXNbdXVpZF0udHlwZSA9IDE7CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLm1hc3MgPSBwcm9wczsKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0udXBkYXRlTWFzc1Byb3BlcnRpZXMoKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NldE1hdGVyaWFsJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0ubWF0ZXJpYWwgPSBwcm9wcyA/IGNyZWF0ZU1hdGVyaWFsKHByb3BzKSA6IHVuZGVmaW5lZDsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NldExpbmVhckRhbXBpbmcnOgogICAgICAgIHN0YXRlLmJvZGllc1t1dWlkXS5saW5lYXJEYW1waW5nID0gcHJvcHM7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRBbmd1bGFyRGFtcGluZyc6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLmFuZ3VsYXJEYW1waW5nID0gcHJvcHM7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRBbGxvd1NsZWVwJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0uYWxsb3dTbGVlcCA9IHByb3BzOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2V0U2xlZXBTcGVlZExpbWl0JzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0uc2xlZXBTcGVlZExpbWl0ID0gcHJvcHM7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRTbGVlcFRpbWVMaW1pdCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLnNsZWVwVGltZUxpbWl0ID0gcHJvcHM7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRDb2xsaXNpb25GaWx0ZXJHcm91cCc6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLmNvbGxpc2lvbkZpbHRlckdyb3VwID0gcHJvcHM7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRDb2xsaXNpb25GaWx0ZXJNYXNrJzoKICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0uY29sbGlzaW9uRmlsdGVyTWFzayA9IHByb3BzOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2V0Q29sbGlzaW9uUmVzcG9uc2UnOgogICAgICAgIHN0YXRlLmJvZGllc1t1dWlkXS5jb2xsaXNpb25SZXNwb25zZSA9IHByb3BzOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2V0Rml4ZWRSb3RhdGlvbic6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLmZpeGVkUm90YXRpb24gPSBwcm9wczsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NldElzVHJpZ2dlcic6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLmlzVHJpZ2dlciA9IHByb3BzOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2V0R3Jhdml0eSc6CiAgICAgICAgc3RhdGUud29ybGQuZ3Jhdml0eS5zZXQocHJvcHNbMF0sIHByb3BzWzFdLCBwcm9wc1syXSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRUb2xlcmFuY2UnOgogICAgICAgIHN0YXRlLndvcmxkLnNvbHZlci50b2xlcmFuY2UgPSBwcm9wczsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ3NldEl0ZXJhdGlvbnMnOgogICAgICAgIHN0YXRlLndvcmxkLnNvbHZlci5pdGVyYXRpb25zID0gcHJvcHM7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRCcm9hZHBoYXNlJzoKICAgICAgICBzdGF0ZS53b3JsZC5icm9hZHBoYXNlID0gbmV3IChicm9hZHBoYXNlc1twcm9wcyArICdCcm9hZHBoYXNlJ10gfHwgTmFpdmVCcm9hZHBoYXNlKShzdGF0ZS53b3JsZCk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRBeGlzSW5kZXgnOgogICAgICAgIHN0YXRlLndvcmxkLmJyb2FkcGhhc2UuYXhpc0luZGV4ID0gcHJvcHMgPT09IHVuZGVmaW5lZCB8fCBwcm9wcyA9PT0gbnVsbCA/IDAgOiBwcm9wczsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2FwcGx5Rm9yY2UnOgogICAgICAgIHN0YXRlLmJvZGllc1t1dWlkXS5hcHBseUZvcmNlKG5ldyBWZWMzKC4uLnByb3BzWzBdKSwgbmV3IFZlYzMoLi4ucHJvcHNbMV0pKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2FwcGx5SW1wdWxzZSc6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLmFwcGx5SW1wdWxzZShuZXcgVmVjMyguLi5wcm9wc1swXSksIG5ldyBWZWMzKC4uLnByb3BzWzFdKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdhcHBseUxvY2FsRm9yY2UnOgogICAgICAgIHN0YXRlLmJvZGllc1t1dWlkXS5hcHBseUxvY2FsRm9yY2UobmV3IFZlYzMoLi4ucHJvcHNbMF0pLCBuZXcgVmVjMyguLi5wcm9wc1sxXSkpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnYXBwbHlMb2NhbEltcHVsc2UnOgogICAgICAgIHN0YXRlLmJvZGllc1t1dWlkXS5hcHBseUxvY2FsSW1wdWxzZShuZXcgVmVjMyguLi5wcm9wc1swXSksIG5ldyBWZWMzKC4uLnByb3BzWzFdKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdhcHBseVRvcnF1ZSc6CiAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLmFwcGx5VG9ycXVlKG5ldyBWZWMzKC4uLnByb3BzWzBdKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdhZGRDb25zdHJhaW50JzoKICAgICAgICB7CiAgICAgICAgICBjb25zdCBbYm9keUEsIGJvZHlCLCBvcHRuc10gPSBwcm9wczsKICAgICAgICAgIGxldCB7CiAgICAgICAgICAgIHBpdm90QSwKICAgICAgICAgICAgcGl2b3RCLAogICAgICAgICAgICBheGlzQSwKICAgICAgICAgICAgYXhpc0IsCiAgICAgICAgICAgIG1heE11bHRpcGxpZXIsCiAgICAgICAgICAgIC4uLm9wdGlvbnMKICAgICAgICAgIH0gPSBvcHRuczsgLy8gaXMgdGhlcmUgYSBiZXR0ZXIgd2F5IHRvIGVuZm9yY2UgZGVmYXVsdHM/CgogICAgICAgICAgcGl2b3RBID0gQXJyYXkuaXNBcnJheShwaXZvdEEpID8gbmV3IFZlYzMoLi4ucGl2b3RBKSA6IHVuZGVmaW5lZDsKICAgICAgICAgIHBpdm90QiA9IEFycmF5LmlzQXJyYXkocGl2b3RCKSA/IG5ldyBWZWMzKC4uLnBpdm90QikgOiB1bmRlZmluZWQ7CiAgICAgICAgICBheGlzQSA9IEFycmF5LmlzQXJyYXkoYXhpc0EpID8gbmV3IFZlYzMoLi4uYXhpc0EpIDogdW5kZWZpbmVkOwogICAgICAgICAgYXhpc0IgPSBBcnJheS5pc0FycmF5KGF4aXNCKSA/IG5ldyBWZWMzKC4uLmF4aXNCKSA6IHVuZGVmaW5lZDsKICAgICAgICAgIGxldCBjb25zdHJhaW50OwoKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICdQb2ludFRvUG9pbnQnOgogICAgICAgICAgICAgIGNvbnN0cmFpbnQgPSBuZXcgUG9pbnRUb1BvaW50Q29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBwaXZvdEEsIHN0YXRlLmJvZGllc1tib2R5Ql0sIHBpdm90Qiwgb3B0bnMubWF4Rm9yY2UpOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnQ29uZVR3aXN0JzoKICAgICAgICAgICAgICBjb25zdHJhaW50ID0gbmV3IENvbmVUd2lzdENvbnN0cmFpbnQoc3RhdGUuYm9kaWVzW2JvZHlBXSwgc3RhdGUuYm9kaWVzW2JvZHlCXSwgewogICAgICAgICAgICAgICAgYXhpc0EsCiAgICAgICAgICAgICAgICBheGlzQiwKICAgICAgICAgICAgICAgIHBpdm90QSwKICAgICAgICAgICAgICAgIHBpdm90QiwKICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJ0hpbmdlJzoKICAgICAgICAgICAgICBjb25zdHJhaW50ID0gbmV3IEhpbmdlQ29uc3RyYWludChzdGF0ZS5ib2RpZXNbYm9keUFdLCBzdGF0ZS5ib2RpZXNbYm9keUJdLCB7CiAgICAgICAgICAgICAgICBheGlzQSwKICAgICAgICAgICAgICAgIGF4aXNCLAogICAgICAgICAgICAgICAgcGl2b3RBLAogICAgICAgICAgICAgICAgcGl2b3RCLAogICAgICAgICAgICAgICAgLi4ub3B0aW9ucwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnRGlzdGFuY2UnOgogICAgICAgICAgICAgIGNvbnN0cmFpbnQgPSBuZXcgRGlzdGFuY2VDb25zdHJhaW50KHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIG9wdG5zLmRpc3RhbmNlLCBvcHRucy5tYXhGb3JjZSk7CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICdMb2NrJzoKICAgICAgICAgICAgICBjb25zdHJhaW50ID0gbmV3IExvY2tDb25zdHJhaW50KHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIG9wdG5zKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgY29uc3RyYWludCA9IG5ldyBDb25zdHJhaW50KHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIG9wdG5zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBjb25zdHJhaW50LnV1aWQgPSB1dWlkOwogICAgICAgICAgc3RhdGUud29ybGQuYWRkQ29uc3RyYWludChjb25zdHJhaW50KTsKCiAgICAgICAgICBpZiAobWF4TXVsdGlwbGllciAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGNvbnN0IHBvc3RTdGVwQ29uc3RyYWludCA9ICgpID0+IHsKICAgICAgICAgICAgICAvLyBUaGUgbXVsdGlwbGllciBpcyBwcm9wb3J0aW9uYWwgdG8gaG93IG11Y2ggZm9yY2UgaXMgYWRkZWQgdG8gdGhlIGJvZGllcyBieSB0aGUgY29uc3RyYWludC4KICAgICAgICAgICAgICAvLyBJZiB0aGlzIGV4Y2VlZHMgYSBsaW1pdCB0aGUgY29uc3RyYWludCBpcyBkaXNhYmxlZC4KICAgICAgICAgICAgICBjb25zdCBtdWx0aXBsaWVyID0gTWF0aC5hYnMoY29uc3RyYWludC5lcXVhdGlvbnNbMF0ubXVsdGlwbGllcik7CgogICAgICAgICAgICAgIGlmIChtdWx0aXBsaWVyID4gbWF4TXVsdGlwbGllcikgewogICAgICAgICAgICAgICAgY29uc3RyYWludC5kaXNhYmxlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgc3RhdGUuY29uc3RyYWludHNbdXVpZF0gPSBwb3N0U3RlcENvbnN0cmFpbnQ7CiAgICAgICAgICAgIHN0YXRlLndvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ3Bvc3RTdGVwJywgc3RhdGUuY29uc3RyYWludHNbdXVpZF0pOwogICAgICAgICAgfQoKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ3JlbW92ZUNvbnN0cmFpbnQnOgogICAgICAgIHN0YXRlLndvcmxkLmNvbnN0cmFpbnRzLmZpbHRlcihfcmVmNSA9PiB7CiAgICAgICAgICBsZXQgewogICAgICAgICAgICB1dWlkOiB0aGlzSWQKICAgICAgICAgIH0gPSBfcmVmNTsKICAgICAgICAgIHJldHVybiB0aGlzSWQgPT09IHV1aWQ7CiAgICAgICAgfSkubWFwKGMgPT4gc3RhdGUud29ybGQucmVtb3ZlQ29uc3RyYWludChjKSk7CgogICAgICAgIGlmIChzdGF0ZS5jb25zdHJhaW50c1t1dWlkXSkgewogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS5jb25zdHJhaW50c1t1dWlkXSk7CiAgICAgICAgICBkZWxldGUgc3RhdGUuY29uc3RyYWludHNbdXVpZF07CiAgICAgICAgfQoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2VuYWJsZUNvbnN0cmFpbnQnOgogICAgICAgIHN0YXRlLndvcmxkLmNvbnN0cmFpbnRzLmZpbHRlcihfcmVmNiA9PiB7CiAgICAgICAgICBsZXQgewogICAgICAgICAgICB1dWlkOiB0aGlzSWQKICAgICAgICAgIH0gPSBfcmVmNjsKICAgICAgICAgIHJldHVybiB0aGlzSWQgPT09IHV1aWQ7CiAgICAgICAgfSkubWFwKGMgPT4gYy5lbmFibGUoKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdkaXNhYmxlQ29uc3RyYWludCc6CiAgICAgICAgc3RhdGUud29ybGQuY29uc3RyYWludHMuZmlsdGVyKF9yZWY3ID0+IHsKICAgICAgICAgIGxldCB7CiAgICAgICAgICAgIHV1aWQ6IHRoaXNJZAogICAgICAgICAgfSA9IF9yZWY3OwogICAgICAgICAgcmV0dXJuIHRoaXNJZCA9PT0gdXVpZDsKICAgICAgICB9KS5tYXAoYyA9PiBjLmRpc2FibGUoKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdlbmFibGVDb25zdHJhaW50TW90b3InOgogICAgICAgIHN0YXRlLndvcmxkLmNvbnN0cmFpbnRzLmZpbHRlcihfcmVmOCA9PiB7CiAgICAgICAgICBsZXQgewogICAgICAgICAgICB1dWlkOiB0aGlzSWQKICAgICAgICAgIH0gPSBfcmVmODsKICAgICAgICAgIHJldHVybiB0aGlzSWQgPT09IHV1aWQ7CiAgICAgICAgfSkubWFwKGMgPT4gYy5lbmFibGVNb3RvcigpKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2Rpc2FibGVDb25zdHJhaW50TW90b3InOgogICAgICAgIHN0YXRlLndvcmxkLmNvbnN0cmFpbnRzLmZpbHRlcihfcmVmOSA9PiB7CiAgICAgICAgICBsZXQgewogICAgICAgICAgICB1dWlkOiB0aGlzSWQKICAgICAgICAgIH0gPSBfcmVmOTsKICAgICAgICAgIHJldHVybiB0aGlzSWQgPT09IHV1aWQ7CiAgICAgICAgfSkubWFwKGMgPT4gYy5kaXNhYmxlTW90b3IoKSk7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzZXRDb25zdHJhaW50TW90b3JTcGVlZCc6CiAgICAgICAgc3RhdGUud29ybGQuY29uc3RyYWludHMuZmlsdGVyKF9yZWYxMCA9PiB7CiAgICAgICAgICBsZXQgewogICAgICAgICAgICB1dWlkOiB0aGlzSWQKICAgICAgICAgIH0gPSBfcmVmMTA7CiAgICAgICAgICByZXR1cm4gdGhpc0lkID09PSB1dWlkOwogICAgICAgIH0pLm1hcChjID0+IGMuc2V0TW90b3JTcGVlZChwcm9wcykpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAnc2V0Q29uc3RyYWludE1vdG9yTWF4Rm9yY2UnOgogICAgICAgIHN0YXRlLndvcmxkLmNvbnN0cmFpbnRzLmZpbHRlcihfcmVmMTEgPT4gewogICAgICAgICAgbGV0IHsKICAgICAgICAgICAgdXVpZDogdGhpc0lkCiAgICAgICAgICB9ID0gX3JlZjExOwogICAgICAgICAgcmV0dXJuIHRoaXNJZCA9PT0gdXVpZDsKICAgICAgICB9KS5tYXAoYyA9PiBjLnNldE1vdG9yTWF4Rm9yY2UocHJvcHMpKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgJ2FkZFNwcmluZyc6CiAgICAgICAgewogICAgICAgICAgY29uc3QgW2JvZHlBLCBib2R5Qiwgb3B0bnNdID0gcHJvcHM7CiAgICAgICAgICBsZXQgewogICAgICAgICAgICBkYW1waW5nLAogICAgICAgICAgICBsb2NhbEFuY2hvckEsCiAgICAgICAgICAgIGxvY2FsQW5jaG9yQiwKICAgICAgICAgICAgcmVzdExlbmd0aCwKICAgICAgICAgICAgc3RpZmZuZXNzLAogICAgICAgICAgICB3b3JsZEFuY2hvckEsCiAgICAgICAgICAgIHdvcmxkQW5jaG9yQgogICAgICAgICAgfSA9IG9wdG5zOwogICAgICAgICAgd29ybGRBbmNob3JBID0gQXJyYXkuaXNBcnJheSh3b3JsZEFuY2hvckEpID8gbmV3IFZlYzMoLi4ud29ybGRBbmNob3JBKSA6IHVuZGVmaW5lZDsKICAgICAgICAgIHdvcmxkQW5jaG9yQiA9IEFycmF5LmlzQXJyYXkod29ybGRBbmNob3JCKSA/IG5ldyBWZWMzKC4uLndvcmxkQW5jaG9yQikgOiB1bmRlZmluZWQ7CiAgICAgICAgICBsb2NhbEFuY2hvckEgPSBBcnJheS5pc0FycmF5KGxvY2FsQW5jaG9yQSkgPyBuZXcgVmVjMyguLi5sb2NhbEFuY2hvckEpIDogdW5kZWZpbmVkOwogICAgICAgICAgbG9jYWxBbmNob3JCID0gQXJyYXkuaXNBcnJheShsb2NhbEFuY2hvckIpID8gbmV3IFZlYzMoLi4ubG9jYWxBbmNob3JCKSA6IHVuZGVmaW5lZDsKICAgICAgICAgIGxldCBzcHJpbmcgPSBuZXcgU3ByaW5nKHN0YXRlLmJvZGllc1tib2R5QV0sIHN0YXRlLmJvZGllc1tib2R5Ql0sIHsKICAgICAgICAgICAgZGFtcGluZywKICAgICAgICAgICAgbG9jYWxBbmNob3JBLAogICAgICAgICAgICBsb2NhbEFuY2hvckIsCiAgICAgICAgICAgIHJlc3RMZW5ndGgsCiAgICAgICAgICAgIHN0aWZmbmVzcywKICAgICAgICAgICAgd29ybGRBbmNob3JBLAogICAgICAgICAgICB3b3JsZEFuY2hvckIKICAgICAgICAgIH0pOwogICAgICAgICAgc3ByaW5nLnV1aWQgPSB1dWlkOwoKICAgICAgICAgIGxldCBwb3N0U3RlcFNwcmluZyA9ICgpID0+IHNwcmluZy5hcHBseUZvcmNlKCk7CgogICAgICAgICAgc3RhdGUuc3ByaW5nc1t1dWlkXSA9IHBvc3RTdGVwU3ByaW5nOwogICAgICAgICAgc3RhdGUuc3ByaW5nSW5zdGFuY2VzW3V1aWRdID0gc3ByaW5nOyAvLyBDb21wdXRlIHRoZSBmb3JjZSBhZnRlciBlYWNoIHN0ZXAKCiAgICAgICAgICBzdGF0ZS53b3JsZC5hZGRFdmVudExpc3RlbmVyKCdwb3N0U3RlcCcsIHN0YXRlLnNwcmluZ3NbdXVpZF0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnc2V0U3ByaW5nU3RpZmZuZXNzJzoKICAgICAgICB7CiAgICAgICAgICBzdGF0ZS5zcHJpbmdJbnN0YW5jZXNbdXVpZF0uc3RpZmZuZXNzID0gcHJvcHM7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdzZXRTcHJpbmdSZXN0TGVuZ3RoJzoKICAgICAgICB7CiAgICAgICAgICBzdGF0ZS5zcHJpbmdJbnN0YW5jZXNbdXVpZF0ucmVzdExlbmd0aCA9IHByb3BzOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnc2V0U3ByaW5nRGFtcGluZyc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuc3ByaW5nSW5zdGFuY2VzW3V1aWRdLmRhbXBpbmcgPSBwcm9wczsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ3JlbW92ZVNwcmluZyc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS5zcHJpbmdzW3V1aWRdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ2FkZFJheSc6CiAgICAgICAgewogICAgICAgICAgY29uc3QgewogICAgICAgICAgICBmcm9tLAogICAgICAgICAgICB0bywKICAgICAgICAgICAgLi4ub3B0aW9ucwogICAgICAgICAgfSA9IHByb3BzOwogICAgICAgICAgY29uc3QgcmF5ID0gbmV3IFJheShmcm9tID8gbmV3IFZlYzMoLi4uZnJvbSkgOiB1bmRlZmluZWQsIHRvID8gbmV3IFZlYzMoLi4udG8pIDogdW5kZWZpbmVkKTsKICAgICAgICAgIG9wdGlvbnMubW9kZSA9IFJheVtvcHRpb25zLm1vZGUudG9VcHBlckNhc2UoKV07CiAgICAgICAgICBvcHRpb25zLnJlc3VsdCA9IG5ldyBSYXljYXN0UmVzdWx0KCk7CgogICAgICAgICAgc3RhdGUucmF5c1t1dWlkXSA9ICgpID0+IHsKICAgICAgICAgICAgcmF5LmludGVyc2VjdFdvcmxkKHN0YXRlLndvcmxkLCBvcHRpb25zKTsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGJvZHksCiAgICAgICAgICAgICAgc2hhcGUsCiAgICAgICAgICAgICAgcmF5RnJvbVdvcmxkLAogICAgICAgICAgICAgIHJheVRvV29ybGQsCiAgICAgICAgICAgICAgaGl0Tm9ybWFsV29ybGQsCiAgICAgICAgICAgICAgaGl0UG9pbnRXb3JsZCwKICAgICAgICAgICAgICAuLi5yZXN0CiAgICAgICAgICAgIH0gPSBvcHRpb25zLnJlc3VsdDsKICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZSh7CiAgICAgICAgICAgICAgYm9keTogYm9keSA/IGJvZHkudXVpZCA6IG51bGwsCiAgICAgICAgICAgICAgaGl0Tm9ybWFsV29ybGQ6IGhpdE5vcm1hbFdvcmxkLnRvQXJyYXkoKSwKICAgICAgICAgICAgICBoaXRQb2ludFdvcmxkOiBoaXRQb2ludFdvcmxkLnRvQXJyYXkoKSwKICAgICAgICAgICAgICBvcDogJ2V2ZW50JywKICAgICAgICAgICAgICByYXk6IHsKICAgICAgICAgICAgICAgIGNvbGxpc2lvbkZpbHRlckdyb3VwOiByYXkuY29sbGlzaW9uRmlsdGVyR3JvdXAsCiAgICAgICAgICAgICAgICBjb2xsaXNpb25GaWx0ZXJNYXNrOiByYXkuY29sbGlzaW9uRmlsdGVyTWFzaywKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogcmF5LmRpcmVjdGlvbi50b0FycmF5KCksCiAgICAgICAgICAgICAgICBmcm9tLAogICAgICAgICAgICAgICAgdG8sCiAgICAgICAgICAgICAgICB1dWlkCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICByYXlGcm9tV29ybGQ6IHJheUZyb21Xb3JsZC50b0FycmF5KCksCiAgICAgICAgICAgICAgcmF5VG9Xb3JsZDogcmF5VG9Xb3JsZC50b0FycmF5KCksCiAgICAgICAgICAgICAgc2hhcGU6IHNoYXBlID8geyAuLi5zaGFwZSwKICAgICAgICAgICAgICAgIGJvZHk6IGJvZHkudXVpZAogICAgICAgICAgICAgIH0gOiBudWxsLAogICAgICAgICAgICAgIHR5cGU6ICdyYXloaXQnLAogICAgICAgICAgICAgIC4uLnJlc3QKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHN0YXRlLndvcmxkLmFkZEV2ZW50TGlzdGVuZXIoJ3ByZVN0ZXAnLCBzdGF0ZS5yYXlzW3V1aWRdKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ3JlbW92ZVJheSc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHN0YXRlLnJheXNbdXVpZF0pOwogICAgICAgICAgZGVsZXRlIHN0YXRlLnJheXNbdXVpZF07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdhZGRSYXljYXN0VmVoaWNsZSc6CiAgICAgICAgewogICAgICAgICAgY29uc3QgW2NoYXNzaXNCb2R5LCB3aGVlbHMsIHdoZWVsSW5mb3MsIGluZGV4Rm9yd2FyZEF4aXMsIGluZGV4UmlnaHRBeGlzLCBpbmRleFVwQXhpc10gPSBwcm9wczsKICAgICAgICAgIGNvbnN0IHZlaGljbGUgPSBuZXcgUmF5Y2FzdFZlaGljbGUoewogICAgICAgICAgICBjaGFzc2lzQm9keTogc3RhdGUuYm9kaWVzW2NoYXNzaXNCb2R5XSwKICAgICAgICAgICAgaW5kZXhGb3J3YXJkQXhpcywKICAgICAgICAgICAgaW5kZXhSaWdodEF4aXMsCiAgICAgICAgICAgIGluZGV4VXBBeGlzCiAgICAgICAgICB9KTsKICAgICAgICAgIHZlaGljbGUud29ybGQgPSBzdGF0ZS53b3JsZDsKCiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdoZWVsSW5mb3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3Qgd2hlZWxJbmZvID0gd2hlZWxJbmZvc1tpXTsKICAgICAgICAgICAgd2hlZWxJbmZvLmRpcmVjdGlvbkxvY2FsID0gbmV3IFZlYzMoLi4ud2hlZWxJbmZvLmRpcmVjdGlvbkxvY2FsKTsKICAgICAgICAgICAgd2hlZWxJbmZvLmNoYXNzaXNDb25uZWN0aW9uUG9pbnRMb2NhbCA9IG5ldyBWZWMzKC4uLndoZWVsSW5mby5jaGFzc2lzQ29ubmVjdGlvblBvaW50TG9jYWwpOwogICAgICAgICAgICB3aGVlbEluZm8uYXhsZUxvY2FsID0gbmV3IFZlYzMoLi4ud2hlZWxJbmZvLmF4bGVMb2NhbCk7CiAgICAgICAgICAgIHZlaGljbGUuYWRkV2hlZWwod2hlZWxJbmZvKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2ZWhpY2xlLnByZVN0ZXAgPSAoKSA9PiB7CiAgICAgICAgICAgIHN0YXRlLnZlaGljbGVzW3V1aWRdLnVwZGF0ZVZlaGljbGUoc3RhdGUud29ybGQuZHQpOwogICAgICAgICAgfTsKCiAgICAgICAgICB2ZWhpY2xlLnBvc3RTdGVwID0gKCkgPT4gewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHN0YXRlLnZlaGljbGVzW3V1aWRdLndoZWVsSW5mb3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzdGF0ZS52ZWhpY2xlc1t1dWlkXS51cGRhdGVXaGVlbFRyYW5zZm9ybShpKTsKICAgICAgICAgICAgICBjb25zdCB0ID0gc3RhdGUudmVoaWNsZXNbdXVpZF0ud2hlZWxJbmZvc1tpXS53b3JsZFRyYW5zZm9ybTsKICAgICAgICAgICAgICBjb25zdCB3aGVlbEJvZHkgPSBzdGF0ZS5ib2RpZXNbd2hlZWxzW2ldXTsKICAgICAgICAgICAgICB3aGVlbEJvZHkucG9zaXRpb24uY29weSh0LnBvc2l0aW9uKTsKICAgICAgICAgICAgICB3aGVlbEJvZHkucXVhdGVybmlvbi5jb3B5KHQucXVhdGVybmlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgc3RhdGUudmVoaWNsZXNbdXVpZF0gPSB2ZWhpY2xlOwogICAgICAgICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHN0YXRlLnZlaGljbGVzW3V1aWRdLnByZVN0ZXApOwogICAgICAgICAgc3RhdGUud29ybGQuYWRkRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS52ZWhpY2xlc1t1dWlkXS5wb3N0U3RlcCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdyZW1vdmVSYXljYXN0VmVoaWNsZSc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncHJlU3RlcCcsIHN0YXRlLnZlaGljbGVzW3V1aWRdLnByZVN0ZXApOwogICAgICAgICAgc3RhdGUud29ybGQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9zdFN0ZXAnLCBzdGF0ZS52ZWhpY2xlc1t1dWlkXS5wb3N0U3RlcCk7CiAgICAgICAgICBzdGF0ZS52ZWhpY2xlc1t1dWlkXS53b3JsZCA9IG51bGw7CiAgICAgICAgICBkZWxldGUgc3RhdGUudmVoaWNsZXNbdXVpZF07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdzZXRSYXljYXN0VmVoaWNsZVN0ZWVyaW5nVmFsdWUnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IFt2YWx1ZSwgd2hlZWxJbmRleF0gPSBwcm9wczsKICAgICAgICAgIHN0YXRlLnZlaGljbGVzW3V1aWRdLnNldFN0ZWVyaW5nVmFsdWUodmFsdWUsIHdoZWVsSW5kZXgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnYXBwbHlSYXljYXN0VmVoaWNsZUVuZ2luZUZvcmNlJzoKICAgICAgICB7CiAgICAgICAgICBjb25zdCBbdmFsdWUsIHdoZWVsSW5kZXhdID0gcHJvcHM7CiAgICAgICAgICBzdGF0ZS52ZWhpY2xlc1t1dWlkXS5hcHBseUVuZ2luZUZvcmNlKHZhbHVlLCB3aGVlbEluZGV4KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ3NldFJheWNhc3RWZWhpY2xlQnJha2UnOgogICAgICAgIHsKICAgICAgICAgIGNvbnN0IFticmFrZSwgd2hlZWxJbmRleF0gPSBwcm9wczsKICAgICAgICAgIHN0YXRlLnZlaGljbGVzW3V1aWRdLnNldEJyYWtlKGJyYWtlLCB3aGVlbEluZGV4KTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgIGNhc2UgJ2FkZENvbnRhY3RNYXRlcmlhbCc6CiAgICAgICAgewogICAgICAgICAgYWRkQ29udGFjdE1hdGVyaWFsKHN0YXRlLndvcmxkLCBjcmVhdGVNYXRlcmlhbCwgcHJvcHMsIHV1aWQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAncmVtb3ZlQ29udGFjdE1hdGVyaWFsJzoKICAgICAgICB7CiAgICAgICAgICByZW1vdmVDb250YWN0TWF0ZXJpYWwoc3RhdGUud29ybGQsIHV1aWQpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgY2FzZSAnd2FrZVVwJzoKICAgICAgICB7CiAgICAgICAgICBzdGF0ZS5ib2RpZXNbdXVpZF0ud2FrZVVwKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICBjYXNlICdzbGVlcCc6CiAgICAgICAgewogICAgICAgICAgc3RhdGUuYm9kaWVzW3V1aWRdLnNsZWVwKCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9CiAgfTsKCn0pKCk7Cgo=",null,!1),m=([].concat(["allowSleep","angularDamping","collisionFilterGroup","collisionFilterMask","collisionResponse","fixedRotation","isTrigger","linearDamping","mass","material","sleepSpeedLimit","sleepTimeLimit","userData"],["angularFactor","angularVelocity","linearFactor","position","velocity"],["quaternion","sliding"]),(0,d.createContext)({})),h=(0,d.createContext)(null);function W(){}var r=new Z.Vector3,y=new Z.Vector3(1,1,1),p=new Z.Quaternion,V=new Z.Matrix4;function v(g,I,C){return void 0!==g?(V.compose(r.fromArray(I.positions,3*g),p.fromArray(I.quaternions,4*g),C?C.scale:y),C&&(C.matrixAutoUpdate=!1,C.matrix.copy(V)),V):V.identity()}var X=function(g){var I=g.allowSleep,C=void 0!==I&&I,A=g.axisIndex,l=void 0===A?0:A,o=g.broadphase,e=void 0===o?"Naive":o,i=g.children,c=g.defaultContactMaterial,a=void 0===c?{contactEquationStiffness:1e6}:c,t=g.gravity,B=void 0===t?[0,-9.81,0]:t,h=g.isPaused,r=void 0!==h&&h,y=g.iterations,p=void 0===y?5:y,V=g.maxSubSteps,X=void 0===V?10:V,K=g.quatNormalizeFast,Y=void 0!==K&&K,R=g.quatNormalizeSkip,H=void 0===R?0:R,w=g.shouldInvalidate,N=void 0===w||w,F=g.size,S=void 0===F?1e3:F,z=g.solver,k=void 0===z?"GS":z,J=g.stepSize,L=void 0===J?1/60:J,f=g.tolerance,M=void 0===f?.001:f,Q=(0,G.Ky)().invalidate,x=(0,d.useState)((function(){return new u})),U=(0,b.Z)(x,1)[0],T=(0,d.useState)({}),j=(0,b.Z)(T,1)[0],D=(0,d.useState)((function(){return{positions:new Float32Array(3*S),quaternions:new Float32Array(4*S)}})),E=(0,b.Z)(D,1)[0],O=(0,d.useState)({}),P=(0,b.Z)(O,1)[0],q=(0,d.useState)({}),_=(0,b.Z)(q,1)[0],$=(0,d.useRef)({}),gg=0,Ig=(0,d.useCallback)((function(g,I){r||(gg+=I,0!==E.positions.byteLength&&0!==E.quaternions.byteLength&&(U.postMessage((0,n.Z)({op:"step",props:{maxSubSteps:X,stepSize:L,timeSinceLastCalled:gg}},E),[E.positions.buffer,E.quaternions.buffer]),gg=0))}),[r,X,L]);(0,G.xQ)(Ig),(0,d.useLayoutEffect)((function(){U.postMessage({op:"init",props:{allowSleep:C,axisIndex:l,broadphase:e,defaultContactMaterial:a,gravity:B,iterations:p,quatNormalizeFast:Y,quatNormalizeSkip:H,solver:k,tolerance:M}});var g,I=0;return U.onmessage=function(C){var A,l,o,e,i,c;switch(C.data.op){case"frame":if(E.positions=C.data.positions,E.quaternions=C.data.quaternions,C.data.bodies)for(I=0;I<C.data.bodies.length;I++)g=C.data.bodies[I],$.current[g]=C.data.bodies.indexOf(g);if(C.data.observations.forEach((function(g){var I=(0,b.Z)(g,3),C=I[0],A=I[1],l=I[2],o=_[C]||{};(o[l]||W)(A)})),C.data.active){for(var a=0,d=Object.values(j);a<d.length;a++){var G=d[a];if(G instanceof Z.InstancedMesh)for(var s=0;s<G.count;s++){var t=$.current["".concat(G.uuid,"/").concat(s)];void 0!==t&&G.setMatrixAt(s,v(t,E)),G.instanceMatrix.needsUpdate=!0}else v($.current[G.uuid],E,G)}N&&Q()}break;case"event":switch(C.data.type){case"collide":((null==(A=P[C.data.target])?void 0:A.collide)||W)((0,n.Z)((0,n.Z)({},C.data),{},{body:j[C.data.body],contact:(0,n.Z)((0,n.Z)({},C.data.contact),{},{bi:j[C.data.contact.bi],bj:j[C.data.contact.bj]}),target:j[C.data.target]}));break;case"collideBegin":((null==(l=P[C.data.bodyA])?void 0:l.collideBegin)||W)({body:j[C.data.bodyB],op:"event",target:j[C.data.bodyA],type:"collideBegin"}),((null==(o=P[C.data.bodyB])?void 0:o.collideBegin)||W)({body:j[C.data.bodyA],op:"event",target:j[C.data.bodyB],type:"collideBegin"});break;case"collideEnd":((null==(e=P[C.data.bodyA])?void 0:e.collideEnd)||W)({body:j[C.data.bodyB],op:"event",target:j[C.data.bodyA],type:"collideEnd"}),((null==(i=P[C.data.bodyB])?void 0:i.collideEnd)||W)({body:j[C.data.bodyA],op:"event",target:j[C.data.bodyB],type:"collideEnd"});break;case"rayhit":((null==(c=P[C.data.ray.uuid])?void 0:c.rayhit)||W)((0,n.Z)((0,n.Z)({},C.data),{},{body:C.data.body?j[C.data.body]:null}))}}},function(){return U.terminate()}}),[]),function(g){var I=g.axisIndex,C=g.broadphase,A=g.gravity,l=g.iterations,o=g.tolerance,e=g.worker;(0,d.useEffect)((function(){e.postMessage({op:"setAxisIndex",props:I})}),[I]),(0,d.useEffect)((function(){e.postMessage({op:"setBroadphase",props:C})}),[C]),(0,d.useEffect)((function(){e.postMessage({op:"setGravity",props:A})}),[A]),(0,d.useEffect)((function(){e.postMessage({op:"setIterations",props:l})}),[l]),(0,d.useEffect)((function(){e.postMessage({op:"setTolerance",props:o})}),[o])}({axisIndex:l,broadphase:e,gravity:B,iterations:p,tolerance:M,worker:U});var Cg=(0,d.useMemo)((function(){return{bodies:$,buffers:E,events:P,refs:j,subscriptions:_,worker:U}}),[$,E,P,j,_,U]);return(0,s.jsx)(m.Provider,{value:Cg,children:i})},K=function(){function g(I){(0,c.Z)(this,g),void 0===I&&(I=[0,0,0,0,0,0,0,0,0]),this.elements=void 0,this.elements=I}return(0,a.Z)(g,[{key:"identity",value:function(){var g=this.elements;g[0]=1,g[1]=0,g[2]=0,g[3]=0,g[4]=1,g[5]=0,g[6]=0,g[7]=0,g[8]=1}},{key:"setZero",value:function(){var g=this.elements;g[0]=0,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=0,g[6]=0,g[7]=0,g[8]=0}},{key:"setTrace",value:function(g){var I=this.elements;I[0]=g.x,I[4]=g.y,I[8]=g.z}},{key:"getTrace",value:function(g){void 0===g&&(g=new R);var I=this.elements;return g.x=I[0],g.y=I[4],g.z=I[8],g}},{key:"vmult",value:function(g,I){void 0===I&&(I=new R);var C=this.elements,A=g.x,l=g.y,o=g.z;return I.x=C[0]*A+C[1]*l+C[2]*o,I.y=C[3]*A+C[4]*l+C[5]*o,I.z=C[6]*A+C[7]*l+C[8]*o,I}},{key:"smult",value:function(g){for(var I=0;I<this.elements.length;I++)this.elements[I]*=g}},{key:"mmult",value:function(I,C){void 0===C&&(C=new g);var A=this.elements,l=I.elements,o=C.elements,e=A[0],i=A[1],c=A[2],a=A[3],n=A[4],b=A[5],d=A[6],G=A[7],Z=A[8],s=l[0],t=l[1],B=l[2],u=l[3],m=l[4],h=l[5],W=l[6],r=l[7],y=l[8];return o[0]=e*s+i*u+c*W,o[1]=e*t+i*m+c*r,o[2]=e*B+i*h+c*y,o[3]=a*s+n*u+b*W,o[4]=a*t+n*m+b*r,o[5]=a*B+n*h+b*y,o[6]=d*s+G*u+Z*W,o[7]=d*t+G*m+Z*r,o[8]=d*B+G*h+Z*y,C}},{key:"scale",value:function(I,C){void 0===C&&(C=new g);for(var A=this.elements,l=C.elements,o=0;3!==o;o++)l[3*o+0]=I.x*A[3*o+0],l[3*o+1]=I.y*A[3*o+1],l[3*o+2]=I.z*A[3*o+2];return C}},{key:"solve",value:function(g,I){void 0===I&&(I=new R);var C,A,l=[];for(C=0;C<12;C++)l.push(0);for(C=0;C<3;C++)for(A=0;A<3;A++)l[C+4*A]=this.elements[C+3*A];l[3]=g.x,l[7]=g.y,l[11]=g.z;var o,e,i=3,c=i;do{if(0===l[(C=c-i)+4*C])for(A=C+1;A<c;A++)if(0!==l[C+4*A]){o=4;do{l[(e=4-o)+4*C]+=l[e+4*A]}while(--o);break}if(0!==l[C+4*C])for(A=C+1;A<c;A++){var a=l[C+4*A]/l[C+4*C];o=4;do{l[(e=4-o)+4*A]=e<=C?0:l[e+4*A]-l[e+4*C]*a}while(--o)}}while(--i);if(I.z=l[11]/l[10],I.y=(l[7]-l[6]*I.z)/l[5],I.x=(l[3]-l[2]*I.z-l[1]*I.y)/l[0],isNaN(I.x)||isNaN(I.y)||isNaN(I.z)||I.x===1/0||I.y===1/0||I.z===1/0)throw"Could not solve equation! Got x=["+I.toString()+"], b=["+g.toString()+"], A=["+this.toString()+"]";return I}},{key:"e",value:function(g,I,C){if(void 0===C)return this.elements[I+3*g];this.elements[I+3*g]=C}},{key:"copy",value:function(g){for(var I=0;I<g.elements.length;I++)this.elements[I]=g.elements[I];return this}},{key:"toString",value:function(){for(var g="",I=0;I<9;I++)g+=this.elements[I]+",";return g}},{key:"reverse",value:function(I){void 0===I&&(I=new g);var C,A,l=Y;for(C=0;C<3;C++)for(A=0;A<3;A++)l[C+6*A]=this.elements[C+3*A];l[3]=1,l[9]=0,l[15]=0,l[4]=0,l[10]=1,l[16]=0,l[5]=0,l[11]=0,l[17]=1;var o,e,i=3,c=i;do{if(0===l[(C=c-i)+6*C])for(A=C+1;A<c;A++)if(0!==l[C+6*A]){o=6;do{l[(e=6-o)+6*C]+=l[e+6*A]}while(--o);break}if(0!==l[C+6*C])for(A=C+1;A<c;A++){var a=l[C+6*A]/l[C+6*C];o=6;do{l[(e=6-o)+6*A]=e<=C?0:l[e+6*A]-l[e+6*C]*a}while(--o)}}while(--i);C=2;do{A=C-1;do{var n=l[C+6*A]/l[C+6*C];o=6;do{l[(e=6-o)+6*A]=l[e+6*A]-l[e+6*C]*n}while(--o)}while(A--)}while(--C);C=2;do{var b=1/l[C+6*C];o=6;do{l[(e=6-o)+6*C]=l[e+6*C]*b}while(--o)}while(C--);C=2;do{A=2;do{if(e=l[3+A+6*C],isNaN(e)||e===1/0)throw"Could not reverse! A=["+this.toString()+"]";I.e(C,A,e)}while(A--)}while(C--);return I}},{key:"setRotationFromQuaternion",value:function(g){var I=g.x,C=g.y,A=g.z,l=g.w,o=I+I,e=C+C,i=A+A,c=I*o,a=I*e,n=I*i,b=C*e,d=C*i,G=A*i,Z=l*o,s=l*e,t=l*i,B=this.elements;return B[0]=1-(b+G),B[1]=a-t,B[2]=n+s,B[3]=a+t,B[4]=1-(c+G),B[5]=d-Z,B[6]=n-s,B[7]=d+Z,B[8]=1-(c+b),this}},{key:"transpose",value:function(I){void 0===I&&(I=new g);var C,A=this.elements,l=I.elements;return l[0]=A[0],l[4]=A[4],l[8]=A[8],C=A[1],l[1]=A[3],l[3]=C,C=A[2],l[2]=A[6],l[6]=C,C=A[5],l[5]=A[7],l[7]=C,I}}]),g}(),Y=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],R=function(){function g(I,C,A){(0,c.Z)(this,g),void 0===I&&(I=0),void 0===C&&(C=0),void 0===A&&(A=0),this.x=void 0,this.y=void 0,this.z=void 0,this.x=I,this.y=C,this.z=A}return(0,a.Z)(g,[{key:"cross",value:function(I,C){void 0===C&&(C=new g);var A=I.x,l=I.y,o=I.z,e=this.x,i=this.y,c=this.z;return C.x=i*o-c*l,C.y=c*A-e*o,C.z=e*l-i*A,C}},{key:"set",value:function(g,I,C){return this.x=g,this.y=I,this.z=C,this}},{key:"setZero",value:function(){this.x=this.y=this.z=0}},{key:"vadd",value:function(I,C){if(!C)return new g(this.x+I.x,this.y+I.y,this.z+I.z);C.x=I.x+this.x,C.y=I.y+this.y,C.z=I.z+this.z}},{key:"vsub",value:function(I,C){if(!C)return new g(this.x-I.x,this.y-I.y,this.z-I.z);C.x=this.x-I.x,C.y=this.y-I.y,C.z=this.z-I.z}},{key:"crossmat",value:function(){return new K([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}},{key:"normalize",value:function(){var g=this.x,I=this.y,C=this.z,A=Math.sqrt(g*g+I*I+C*C);if(A>0){var l=1/A;this.x*=l,this.y*=l,this.z*=l}else this.x=0,this.y=0,this.z=0;return A}},{key:"unit",value:function(I){void 0===I&&(I=new g);var C=this.x,A=this.y,l=this.z,o=Math.sqrt(C*C+A*A+l*l);return o>0?(o=1/o,I.x=C*o,I.y=A*o,I.z=l*o):(I.x=1,I.y=0,I.z=0),I}},{key:"length",value:function(){var g=this.x,I=this.y,C=this.z;return Math.sqrt(g*g+I*I+C*C)}},{key:"lengthSquared",value:function(){return this.dot(this)}},{key:"distanceTo",value:function(g){var I=this.x,C=this.y,A=this.z,l=g.x,o=g.y,e=g.z;return Math.sqrt((l-I)*(l-I)+(o-C)*(o-C)+(e-A)*(e-A))}},{key:"distanceSquared",value:function(g){var I=this.x,C=this.y,A=this.z,l=g.x,o=g.y,e=g.z;return(l-I)*(l-I)+(o-C)*(o-C)+(e-A)*(e-A)}},{key:"scale",value:function(I,C){void 0===C&&(C=new g);var A=this.x,l=this.y,o=this.z;return C.x=I*A,C.y=I*l,C.z=I*o,C}},{key:"vmul",value:function(I,C){return void 0===C&&(C=new g),C.x=I.x*this.x,C.y=I.y*this.y,C.z=I.z*this.z,C}},{key:"addScaledVector",value:function(I,C,A){return void 0===A&&(A=new g),A.x=this.x+I*C.x,A.y=this.y+I*C.y,A.z=this.z+I*C.z,A}},{key:"dot",value:function(g){return this.x*g.x+this.y*g.y+this.z*g.z}},{key:"isZero",value:function(){return 0===this.x&&0===this.y&&0===this.z}},{key:"negate",value:function(I){return void 0===I&&(I=new g),I.x=-this.x,I.y=-this.y,I.z=-this.z,I}},{key:"tangents",value:function(g,I){var C=this.length();if(C>0){var A=H,l=1/C;A.set(this.x*l,this.y*l,this.z*l);var o=w;Math.abs(A.x)<.9?(o.set(1,0,0),A.cross(o,g)):(o.set(0,1,0),A.cross(o,g)),A.cross(g,I)}else g.set(1,0,0),I.set(0,1,0)}},{key:"toString",value:function(){return this.x+","+this.y+","+this.z}},{key:"toArray",value:function(){return[this.x,this.y,this.z]}},{key:"copy",value:function(g){return this.x=g.x,this.y=g.y,this.z=g.z,this}},{key:"lerp",value:function(g,I,C){var A=this.x,l=this.y,o=this.z;C.x=A+(g.x-A)*I,C.y=l+(g.y-l)*I,C.z=o+(g.z-o)*I}},{key:"almostEquals",value:function(g,I){return void 0===I&&(I=1e-6),!(Math.abs(this.x-g.x)>I||Math.abs(this.y-g.y)>I||Math.abs(this.z-g.z)>I)}},{key:"almostZero",value:function(g){return void 0===g&&(g=1e-6),!(Math.abs(this.x)>g||Math.abs(this.y)>g||Math.abs(this.z)>g)}},{key:"isAntiparallelTo",value:function(g,I){return this.negate(N),N.almostEquals(g,I)}},{key:"clone",value:function(){return new g(this.x,this.y,this.z)}}]),g}();R.ZERO=void 0,R.UNIT_X=void 0,R.UNIT_Y=void 0,R.UNIT_Z=void 0,R.ZERO=new R(0,0,0),R.UNIT_X=new R(1,0,0),R.UNIT_Y=new R(0,1,0),R.UNIT_Z=new R(0,0,1);var H=new R,w=new R,N=new R,F=function(){function g(I){(0,c.Z)(this,g),void 0===I&&(I={}),this.lowerBound=void 0,this.upperBound=void 0,this.lowerBound=new R,this.upperBound=new R,I.lowerBound&&this.lowerBound.copy(I.lowerBound),I.upperBound&&this.upperBound.copy(I.upperBound)}return(0,a.Z)(g,[{key:"setFromPoints",value:function(g,I,C,A){var l=this.lowerBound,o=this.upperBound,e=C;l.copy(g[0]),e&&e.vmult(l,l),o.copy(l);for(var i=1;i<g.length;i++){var c=g[i];e&&(e.vmult(c,S),c=S),c.x>o.x&&(o.x=c.x),c.x<l.x&&(l.x=c.x),c.y>o.y&&(o.y=c.y),c.y<l.y&&(l.y=c.y),c.z>o.z&&(o.z=c.z),c.z<l.z&&(l.z=c.z)}return I&&(I.vadd(l,l),I.vadd(o,o)),A&&(l.x-=A,l.y-=A,l.z-=A,o.x+=A,o.y+=A,o.z+=A),this}},{key:"copy",value:function(g){return this.lowerBound.copy(g.lowerBound),this.upperBound.copy(g.upperBound),this}},{key:"clone",value:function(){return(new g).copy(this)}},{key:"extend",value:function(g){this.lowerBound.x=Math.min(this.lowerBound.x,g.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,g.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,g.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,g.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,g.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,g.upperBound.z)}},{key:"overlaps",value:function(g){var I=this.lowerBound,C=this.upperBound,A=g.lowerBound,l=g.upperBound,o=A.x<=C.x&&C.x<=l.x||I.x<=l.x&&l.x<=C.x,e=A.y<=C.y&&C.y<=l.y||I.y<=l.y&&l.y<=C.y,i=A.z<=C.z&&C.z<=l.z||I.z<=l.z&&l.z<=C.z;return o&&e&&i}},{key:"volume",value:function(){var g=this.lowerBound,I=this.upperBound;return(I.x-g.x)*(I.y-g.y)*(I.z-g.z)}},{key:"contains",value:function(g){var I=this.lowerBound,C=this.upperBound,A=g.lowerBound,l=g.upperBound;return I.x<=A.x&&C.x>=l.x&&I.y<=A.y&&C.y>=l.y&&I.z<=A.z&&C.z>=l.z}},{key:"getCorners",value:function(g,I,C,A,l,o,e,i){var c=this.lowerBound,a=this.upperBound;g.copy(c),I.set(a.x,c.y,c.z),C.set(a.x,a.y,c.z),A.set(c.x,a.y,a.z),l.set(a.x,c.y,a.z),o.set(c.x,a.y,c.z),e.set(c.x,c.y,a.z),i.copy(a)}},{key:"toLocalFrame",value:function(g,I){var C=z,A=C[0],l=C[1],o=C[2],e=C[3],i=C[4],c=C[5],a=C[6],n=C[7];this.getCorners(A,l,o,e,i,c,a,n);for(var b=0;8!==b;b++){var d=C[b];g.pointToLocal(d,d)}return I.setFromPoints(C)}},{key:"toWorldFrame",value:function(g,I){var C=z,A=C[0],l=C[1],o=C[2],e=C[3],i=C[4],c=C[5],a=C[6],n=C[7];this.getCorners(A,l,o,e,i,c,a,n);for(var b=0;8!==b;b++){var d=C[b];g.pointToWorld(d,d)}return I.setFromPoints(C)}},{key:"overlapsRay",value:function(g){var I=g.direction,C=g.from,A=1/I.x,l=1/I.y,o=1/I.z,e=(this.lowerBound.x-C.x)*A,i=(this.upperBound.x-C.x)*A,c=(this.lowerBound.y-C.y)*l,a=(this.upperBound.y-C.y)*l,n=(this.lowerBound.z-C.z)*o,b=(this.upperBound.z-C.z)*o,d=Math.max(Math.max(Math.min(e,i),Math.min(c,a)),Math.min(n,b)),G=Math.min(Math.min(Math.max(e,i),Math.max(c,a)),Math.max(n,b));return!(G<0)&&!(d>G)}}]),g}(),S=new R,z=[new R,new R,new R,new R,new R,new R,new R,new R],k=function(){function g(){(0,c.Z)(this,g),this._listeners=void 0}return(0,a.Z)(g,[{key:"addEventListener",value:function(g,I){void 0===this._listeners&&(this._listeners={});var C=this._listeners;return void 0===C[g]&&(C[g]=[]),C[g].includes(I)||C[g].push(I),this}},{key:"hasEventListener",value:function(g,I){if(void 0===this._listeners)return!1;var C=this._listeners;return!(void 0===C[g]||!C[g].includes(I))}},{key:"hasAnyEventListener",value:function(g){return void 0!==this._listeners&&void 0!==this._listeners[g]}},{key:"removeEventListener",value:function(g,I){if(void 0===this._listeners)return this;var C=this._listeners;if(void 0===C[g])return this;var A=C[g].indexOf(I);return-1!==A&&C[g].splice(A,1),this}},{key:"dispatchEvent",value:function(g){if(void 0===this._listeners)return this;var I=this._listeners[g.type];if(void 0!==I){g.target=this;for(var C=0,A=I.length;C<A;C++)I[C].call(this,g)}return this}}]),g}(),J=function(){function g(I,C,A,l){(0,c.Z)(this,g),void 0===I&&(I=0),void 0===C&&(C=0),void 0===A&&(A=0),void 0===l&&(l=1),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=I,this.y=C,this.z=A,this.w=l}return(0,a.Z)(g,[{key:"set",value:function(g,I,C,A){return this.x=g,this.y=I,this.z=C,this.w=A,this}},{key:"toString",value:function(){return this.x+","+this.y+","+this.z+","+this.w}},{key:"toArray",value:function(){return[this.x,this.y,this.z,this.w]}},{key:"setFromAxisAngle",value:function(g,I){var C=Math.sin(.5*I);return this.x=g.x*C,this.y=g.y*C,this.z=g.z*C,this.w=Math.cos(.5*I),this}},{key:"toAxisAngle",value:function(g){void 0===g&&(g=new R),this.normalize();var I=2*Math.acos(this.w),C=Math.sqrt(1-this.w*this.w);return C<.001?(g.x=this.x,g.y=this.y,g.z=this.z):(g.x=this.x/C,g.y=this.y/C,g.z=this.z/C),[g,I]}},{key:"setFromVectors",value:function(g,I){if(g.isAntiparallelTo(I)){var C=L,A=f;g.tangents(C,A),this.setFromAxisAngle(C,Math.PI)}else{var l=g.cross(I);this.x=l.x,this.y=l.y,this.z=l.z,this.w=Math.sqrt(Math.pow(g.length(),2)*Math.pow(I.length(),2))+g.dot(I),this.normalize()}return this}},{key:"mult",value:function(I,C){void 0===C&&(C=new g);var A=this.x,l=this.y,o=this.z,e=this.w,i=I.x,c=I.y,a=I.z,n=I.w;return C.x=A*n+e*i+l*a-o*c,C.y=l*n+e*c+o*i-A*a,C.z=o*n+e*a+A*c-l*i,C.w=e*n-A*i-l*c-o*a,C}},{key:"inverse",value:function(I){void 0===I&&(I=new g);var C=this.x,A=this.y,l=this.z,o=this.w;this.conjugate(I);var e=1/(C*C+A*A+l*l+o*o);return I.x*=e,I.y*=e,I.z*=e,I.w*=e,I}},{key:"conjugate",value:function(I){return void 0===I&&(I=new g),I.x=-this.x,I.y=-this.y,I.z=-this.z,I.w=this.w,I}},{key:"normalize",value:function(){var g=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===g?(this.x=0,this.y=0,this.z=0,this.w=0):(g=1/g,this.x*=g,this.y*=g,this.z*=g,this.w*=g),this}},{key:"normalizeFast",value:function(){var g=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===g?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=g,this.y*=g,this.z*=g,this.w*=g),this}},{key:"vmult",value:function(g,I){void 0===I&&(I=new R);var C=g.x,A=g.y,l=g.z,o=this.x,e=this.y,i=this.z,c=this.w,a=c*C+e*l-i*A,n=c*A+i*C-o*l,b=c*l+o*A-e*C,d=-o*C-e*A-i*l;return I.x=a*c+d*-o+n*-i-b*-e,I.y=n*c+d*-e+b*-o-a*-i,I.z=b*c+d*-i+a*-e-n*-o,I}},{key:"copy",value:function(g){return this.x=g.x,this.y=g.y,this.z=g.z,this.w=g.w,this}},{key:"toEuler",value:function(g,I){var C,A,l;void 0===I&&(I="YZX");var o=this.x,e=this.y,i=this.z,c=this.w;if("YZX"!==I)throw new Error("Euler order "+I+" not supported yet.");var a=o*e+i*c;if(a>.499&&(C=2*Math.atan2(o,c),A=Math.PI/2,l=0),a<-.499&&(C=-2*Math.atan2(o,c),A=-Math.PI/2,l=0),void 0===C){var n=o*o,b=e*e,d=i*i;C=Math.atan2(2*e*c-2*o*i,1-2*b-2*d),A=Math.asin(2*a),l=Math.atan2(2*o*c-2*e*i,1-2*n-2*d)}g.y=C,g.z=A,g.x=l}},{key:"setFromEuler",value:function(g,I,C,A){void 0===A&&(A="XYZ");var l=Math.cos(g/2),o=Math.cos(I/2),e=Math.cos(C/2),i=Math.sin(g/2),c=Math.sin(I/2),a=Math.sin(C/2);return"XYZ"===A?(this.x=i*o*e+l*c*a,this.y=l*c*e-i*o*a,this.z=l*o*a+i*c*e,this.w=l*o*e-i*c*a):"YXZ"===A?(this.x=i*o*e+l*c*a,this.y=l*c*e-i*o*a,this.z=l*o*a-i*c*e,this.w=l*o*e+i*c*a):"ZXY"===A?(this.x=i*o*e-l*c*a,this.y=l*c*e+i*o*a,this.z=l*o*a+i*c*e,this.w=l*o*e-i*c*a):"ZYX"===A?(this.x=i*o*e-l*c*a,this.y=l*c*e+i*o*a,this.z=l*o*a-i*c*e,this.w=l*o*e+i*c*a):"YZX"===A?(this.x=i*o*e+l*c*a,this.y=l*c*e+i*o*a,this.z=l*o*a-i*c*e,this.w=l*o*e-i*c*a):"XZY"===A&&(this.x=i*o*e-l*c*a,this.y=l*c*e-i*o*a,this.z=l*o*a+i*c*e,this.w=l*o*e+i*c*a),this}},{key:"clone",value:function(){return new g(this.x,this.y,this.z,this.w)}},{key:"slerp",value:function(I,C,A){void 0===A&&(A=new g);var l,o,e,i,c,a=this.x,n=this.y,b=this.z,d=this.w,G=I.x,Z=I.y,s=I.z,t=I.w;return(o=a*G+n*Z+b*s+d*t)<0&&(o=-o,G=-G,Z=-Z,s=-s,t=-t),1-o>1e-6?(l=Math.acos(o),e=Math.sin(l),i=Math.sin((1-C)*l)/e,c=Math.sin(C*l)/e):(i=1-C,c=C),A.x=i*a+c*G,A.y=i*n+c*Z,A.z=i*b+c*s,A.w=i*d+c*t,A}},{key:"integrate",value:function(I,C,A,l){void 0===l&&(l=new g);var o=I.x*A.x,e=I.y*A.y,i=I.z*A.z,c=this.x,a=this.y,n=this.z,b=this.w,d=.5*C;return l.x+=d*(o*b+e*n-i*a),l.y+=d*(e*b+i*c-o*n),l.z+=d*(i*b+o*a-e*c),l.w+=d*(-o*c-e*a-i*n),l}}]),g}(),L=new R,f=new R,M=function(){function g(I){(0,c.Z)(this,g),void 0===I&&(I={}),this.id=void 0,this.type=void 0,this.boundingSphereRadius=void 0,this.collisionResponse=void 0,this.collisionFilterGroup=void 0,this.collisionFilterMask=void 0,this.material=void 0,this.body=void 0,this.id=g.idCounter++,this.type=I.type||0,this.boundingSphereRadius=0,this.collisionResponse=!I.collisionResponse||I.collisionResponse,this.collisionFilterGroup=void 0!==I.collisionFilterGroup?I.collisionFilterGroup:1,this.collisionFilterMask=void 0!==I.collisionFilterMask?I.collisionFilterMask:-1,this.material=I.material?I.material:null,this.body=null}return(0,a.Z)(g,[{key:"updateBoundingSphereRadius",value:function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type}},{key:"volume",value:function(){throw"volume() not implemented for shape type "+this.type}},{key:"calculateLocalInertia",value:function(g,I){throw"calculateLocalInertia() not implemented for shape type "+this.type}},{key:"calculateWorldAABB",value:function(g,I,C,A){throw"calculateWorldAABB() not implemented for shape type "+this.type}}]),g}();M.idCounter=0,M.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};var Q=function(){function g(I){(0,c.Z)(this,g),void 0===I&&(I={}),this.position=void 0,this.quaternion=void 0,this.position=new R,this.quaternion=new J,I.position&&this.position.copy(I.position),I.quaternion&&this.quaternion.copy(I.quaternion)}return(0,a.Z)(g,[{key:"pointToLocal",value:function(I,C){return g.pointToLocalFrame(this.position,this.quaternion,I,C)}},{key:"pointToWorld",value:function(I,C){return g.pointToWorldFrame(this.position,this.quaternion,I,C)}},{key:"vectorToWorldFrame",value:function(g,I){return void 0===I&&(I=new R),this.quaternion.vmult(g,I),I}}],[{key:"pointToLocalFrame",value:function(g,I,C,A){return void 0===A&&(A=new R),C.vsub(g,A),I.conjugate(x),x.vmult(A,A),A}},{key:"pointToWorldFrame",value:function(g,I,C,A){return void 0===A&&(A=new R),I.vmult(C,A),A.vadd(g,A),A}},{key:"vectorToWorldFrame",value:function(g,I,C){return void 0===C&&(C=new R),g.vmult(I,C),C}},{key:"vectorToLocalFrame",value:function(g,I,C,A){return void 0===A&&(A=new R),I.w*=-1,I.vmult(C,A),I.w*=-1,A}}]),g}(),x=new J,U=function(g){(0,e.Z)(C,g);var I=(0,i.Z)(C);function C(g){var A;(0,c.Z)(this,C),void 0===g&&(g={});var l=g,o=l.vertices,e=void 0===o?[]:o,i=l.faces,a=void 0===i?[]:i,n=l.normals,b=void 0===n?[]:n,d=l.axes,G=l.boundingSphereRadius;return(A=I.call(this,{type:M.types.CONVEXPOLYHEDRON})).vertices=void 0,A.faces=void 0,A.faceNormals=void 0,A.worldVertices=void 0,A.worldVerticesNeedsUpdate=void 0,A.worldFaceNormals=void 0,A.worldFaceNormalsNeedsUpdate=void 0,A.uniqueAxes=void 0,A.uniqueEdges=void 0,A.vertices=e,A.faces=a,A.faceNormals=b,0===A.faceNormals.length&&A.computeNormals(),G?A.boundingSphereRadius=G:A.updateBoundingSphereRadius(),A.worldVertices=[],A.worldVerticesNeedsUpdate=!0,A.worldFaceNormals=[],A.worldFaceNormalsNeedsUpdate=!0,A.uniqueAxes=d?d.slice():null,A.uniqueEdges=[],A.computeEdges(),A}return(0,a.Z)(C,[{key:"computeEdges",value:function(){var g=this.faces,I=this.vertices,C=this.uniqueEdges;C.length=0;for(var A=new R,l=0;l!==g.length;l++)for(var o=g[l],e=o.length,i=0;i!==e;i++){var c=(i+1)%e;I[o[i]].vsub(I[o[c]],A),A.normalize();for(var a=!1,n=0;n!==C.length;n++)if(C[n].almostEquals(A)||C[n].almostEquals(A)){a=!0;break}a||C.push(A.clone())}}},{key:"computeNormals",value:function(){this.faceNormals.length=this.faces.length;for(var g=0;g<this.faces.length;g++){for(var I=0;I<this.faces[g].length;I++)if(!this.vertices[this.faces[g][I]])throw new Error("Vertex "+this.faces[g][I]+" not found!");var C=this.faceNormals[g]||new R;this.getFaceNormal(g,C),C.negate(C),this.faceNormals[g]=C;var A=this.vertices[this.faces[g][0]];if(C.dot(A)<0){console.error(".faceNormals["+g+"] = Vec3("+C.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var l=0;l<this.faces[g].length;l++)console.warn(".vertices["+this.faces[g][l]+"] = Vec3("+this.vertices[this.faces[g][l]].toString()+")")}}}},{key:"getFaceNormal",value:function(g,I){var A=this.faces[g],l=this.vertices[A[0]],o=this.vertices[A[1]],e=this.vertices[A[2]];C.computeNormal(l,o,e,I)}},{key:"clipAgainstHull",value:function(g,I,C,A,l,o,e,i,c){for(var a=new R,n=-1,b=-Number.MAX_VALUE,d=0;d<C.faces.length;d++){a.copy(C.faceNormals[d]),l.vmult(a,a);var G=a.dot(o);G>b&&(b=G,n=d)}for(var Z=[],s=0;s<C.faces[n].length;s++){var t=C.vertices[C.faces[n][s]],B=new R;B.copy(t),l.vmult(B,B),A.vadd(B,B),Z.push(B)}n>=0&&this.clipFaceAgainstHull(o,g,I,Z,e,i,c)}},{key:"findSeparatingAxis",value:function(g,I,C,A,l,o,e,i){var c=new R,a=new R,n=new R,b=new R,d=new R,G=new R,Z=Number.MAX_VALUE,s=this;if(s.uniqueAxes)for(var t=0;t!==s.uniqueAxes.length;t++){C.vmult(s.uniqueAxes[t],c);var B=s.testSepAxis(c,g,I,C,A,l);if(!1===B)return!1;B<Z&&(Z=B,o.copy(c))}else for(var u=e?e.length:s.faces.length,m=0;m<u;m++){var h=e?e[m]:m;c.copy(s.faceNormals[h]),C.vmult(c,c);var W=s.testSepAxis(c,g,I,C,A,l);if(!1===W)return!1;W<Z&&(Z=W,o.copy(c))}if(g.uniqueAxes)for(var r=0;r!==g.uniqueAxes.length;r++){l.vmult(g.uniqueAxes[r],a);var y=s.testSepAxis(a,g,I,C,A,l);if(!1===y)return!1;y<Z&&(Z=y,o.copy(a))}else for(var p=i?i.length:g.faces.length,V=0;V<p;V++){var v=i?i[V]:V;a.copy(g.faceNormals[v]),l.vmult(a,a);var X=s.testSepAxis(a,g,I,C,A,l);if(!1===X)return!1;X<Z&&(Z=X,o.copy(a))}for(var K=0;K!==s.uniqueEdges.length;K++){C.vmult(s.uniqueEdges[K],b);for(var Y=0;Y!==g.uniqueEdges.length;Y++)if(l.vmult(g.uniqueEdges[Y],d),b.cross(d,G),!G.almostZero()){G.normalize();var H=s.testSepAxis(G,g,I,C,A,l);if(!1===H)return!1;H<Z&&(Z=H,o.copy(G))}}return A.vsub(I,n),n.dot(o)>0&&o.negate(o),!0}},{key:"testSepAxis",value:function(g,I,A,l,o,e){C.project(this,g,A,l,T),C.project(I,g,o,e,j);var i=T[0],c=T[1],a=j[0],n=j[1];if(i<n||a<c)return!1;var b=i-n,d=a-c;return b<d?b:d}},{key:"calculateLocalInertia",value:function(g,I){var C=new R,A=new R;this.computeLocalAABB(A,C);var l=C.x-A.x,o=C.y-A.y,e=C.z-A.z;I.x=1/12*g*(2*o*2*o+2*e*2*e),I.y=1/12*g*(2*l*2*l+2*e*2*e),I.z=1/12*g*(2*o*2*o+2*l*2*l)}},{key:"getPlaneConstantOfFace",value:function(g){var I=this.faces[g],C=this.faceNormals[g],A=this.vertices[I[0]];return-C.dot(A)}},{key:"clipFaceAgainstHull",value:function(g,I,C,A,l,o,e){for(var i=new R,c=new R,a=new R,n=new R,b=new R,d=new R,G=new R,Z=new R,s=this,t=A,B=[],u=-1,m=Number.MAX_VALUE,h=0;h<s.faces.length;h++){i.copy(s.faceNormals[h]),C.vmult(i,i);var W=i.dot(g);W<m&&(m=W,u=h)}if(!(u<0)){var r=s.faces[u];r.connectedFaces=[];for(var y=0;y<s.faces.length;y++)for(var p=0;p<s.faces[y].length;p++)-1!==r.indexOf(s.faces[y][p])&&y!==u&&-1===r.connectedFaces.indexOf(y)&&r.connectedFaces.push(y);for(var V=r.length,v=0;v<V;v++){var X=s.vertices[r[v]],K=s.vertices[r[(v+1)%V]];X.vsub(K,c),a.copy(c),C.vmult(a,a),I.vadd(a,a),n.copy(this.faceNormals[u]),C.vmult(n,n),I.vadd(n,n),a.cross(n,b),b.negate(b),d.copy(X),C.vmult(d,d),I.vadd(d,d);var Y=r.connectedFaces[v];G.copy(this.faceNormals[Y]);var H=this.getPlaneConstantOfFace(Y);Z.copy(G),C.vmult(Z,Z);var w=H-Z.dot(I);for(this.clipFaceAgainstPlane(t,B,Z,w);t.length;)t.shift();for(;B.length;)t.push(B.shift())}G.copy(this.faceNormals[u]);var N=this.getPlaneConstantOfFace(u);Z.copy(G),C.vmult(Z,Z);for(var F=N-Z.dot(I),S=0;S<t.length;S++){var z=Z.dot(t[S])+F;if(z<=l&&(console.log("clamped: depth="+z+" to minDist="+l),z=l),z<=o){var k=t[S];if(z<=1e-6){var J={point:k,normal:Z,depth:z};e.push(J)}}}}}},{key:"clipFaceAgainstPlane",value:function(g,I,C,A){var l,o,e=g.length;if(e<2)return I;var i=g[g.length-1],c=g[0];l=C.dot(i)+A;for(var a=0;a<e;a++){if(c=g[a],o=C.dot(c)+A,l<0)if(o<0){var n=new R;n.copy(c),I.push(n)}else{var b=new R;i.lerp(c,l/(l-o),b),I.push(b)}else if(o<0){var d=new R;i.lerp(c,l/(l-o),d),I.push(d),I.push(c)}i=c,l=o}return I}},{key:"computeWorldVertices",value:function(g,I){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new R);for(var C=this.vertices,A=this.worldVertices,l=0;l!==this.vertices.length;l++)I.vmult(C[l],A[l]),g.vadd(A[l],A[l]);this.worldVerticesNeedsUpdate=!1}},{key:"computeLocalAABB",value:function(g,I){var C=this.vertices;g.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),I.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var A=0;A<this.vertices.length;A++){var l=C[A];l.x<g.x?g.x=l.x:l.x>I.x&&(I.x=l.x),l.y<g.y?g.y=l.y:l.y>I.y&&(I.y=l.y),l.z<g.z?g.z=l.z:l.z>I.z&&(I.z=l.z)}}},{key:"computeWorldFaceNormals",value:function(g){for(var I=this.faceNormals.length;this.worldFaceNormals.length<I;)this.worldFaceNormals.push(new R);for(var C=this.faceNormals,A=this.worldFaceNormals,l=0;l!==I;l++)g.vmult(C[l],A[l]);this.worldFaceNormalsNeedsUpdate=!1}},{key:"updateBoundingSphereRadius",value:function(){for(var g=0,I=this.vertices,C=0;C!==I.length;C++){var A=I[C].lengthSquared();A>g&&(g=A)}this.boundingSphereRadius=Math.sqrt(g)}},{key:"calculateWorldAABB",value:function(g,I,C,A){for(var l,o,e,i,c,a,n=this.vertices,b=new R,d=0;d<n.length;d++){b.copy(n[d]),I.vmult(b,b),g.vadd(b,b);var G=b;(void 0===l||G.x<l)&&(l=G.x),(void 0===i||G.x>i)&&(i=G.x),(void 0===o||G.y<o)&&(o=G.y),(void 0===c||G.y>c)&&(c=G.y),(void 0===e||G.z<e)&&(e=G.z),(void 0===a||G.z>a)&&(a=G.z)}C.set(l,o,e),A.set(i,c,a)}},{key:"volume",value:function(){return 4*Math.PI*this.boundingSphereRadius/3}},{key:"getAveragePointLocal",value:function(g){void 0===g&&(g=new R);for(var I=this.vertices,C=0;C<I.length;C++)g.vadd(I[C],g);return g.scale(1/I.length,g),g}},{key:"transformAllPoints",value:function(g,I){var C=this.vertices.length,A=this.vertices;if(I){for(var l=0;l<C;l++){var o=A[l];I.vmult(o,o)}for(var e=0;e<this.faceNormals.length;e++){var i=this.faceNormals[e];I.vmult(i,i)}}if(g)for(var c=0;c<C;c++){var a=A[c];a.vadd(g,a)}}},{key:"pointIsInside",value:function(g){var I=this.vertices,C=this.faces,A=this.faceNormals,l=new R;this.getAveragePointLocal(l);for(var o=0;o<this.faces.length;o++){var e=A[o],i=I[C[o][0]],c=new R;g.vsub(i,c);var a=e.dot(c),n=new R;l.vsub(i,n);var b=e.dot(n);if(a<0&&b>0||a>0&&b<0)return!1}return-1}}],[{key:"computeNormal",value:function(g,I,C,A){var l=new R,o=new R;I.vsub(g,o),C.vsub(I,l),l.cross(o,A),A.isZero()||A.normalize()}},{key:"project",value:function(g,I,C,A,l){var o=g.vertices.length,e=D,i=0,c=0,a=E,n=g.vertices;a.setZero(),Q.vectorToLocalFrame(C,A,I,e),Q.pointToLocalFrame(C,A,a,a);var b=a.dot(e);c=i=n[0].dot(e);for(var d=1;d<o;d++){var G=n[d].dot(e);G>i&&(i=G),G<c&&(c=G)}if((c-=b)>(i-=b)){var Z=c;c=i,i=Z}l[0]=i,l[1]=c}}]),C}(M),T=[],j=[],D=new R,E=new R,O=function(g){(0,e.Z)(C,g);var I=(0,i.Z)(C);function C(g){var A;return(0,c.Z)(this,C),(A=I.call(this,{type:M.types.BOX})).halfExtents=void 0,A.convexPolyhedronRepresentation=void 0,A.halfExtents=g,A.convexPolyhedronRepresentation=null,A.updateConvexPolyhedronRepresentation(),A.updateBoundingSphereRadius(),A}return(0,a.Z)(C,[{key:"updateConvexPolyhedronRepresentation",value:function(){var g=this.halfExtents.x,I=this.halfExtents.y,C=this.halfExtents.z,A=R,l=[new A(-g,-I,-C),new A(g,-I,-C),new A(g,I,-C),new A(-g,I,-C),new A(-g,-I,C),new A(g,-I,C),new A(g,I,C),new A(-g,I,C)],o=[new A(0,0,1),new A(0,1,0),new A(1,0,0)],e=new U({vertices:l,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:o});this.convexPolyhedronRepresentation=e,e.material=this.material}},{key:"calculateLocalInertia",value:function(g,I){return void 0===I&&(I=new R),C.calculateInertia(this.halfExtents,g,I),I}},{key:"getSideNormals",value:function(g,I){var C=g,A=this.halfExtents;if(C[0].set(A.x,0,0),C[1].set(0,A.y,0),C[2].set(0,0,A.z),C[3].set(-A.x,0,0),C[4].set(0,-A.y,0),C[5].set(0,0,-A.z),void 0!==I)for(var l=0;l!==C.length;l++)I.vmult(C[l],C[l]);return C}},{key:"volume",value:function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}},{key:"updateBoundingSphereRadius",value:function(){this.boundingSphereRadius=this.halfExtents.length()}},{key:"forEachWorldCorner",value:function(g,I,C){for(var A=this.halfExtents,l=[[A.x,A.y,A.z],[-A.x,A.y,A.z],[-A.x,-A.y,A.z],[-A.x,-A.y,-A.z],[A.x,-A.y,-A.z],[A.x,A.y,-A.z],[-A.x,A.y,-A.z],[A.x,-A.y,A.z]],o=0;o<l.length;o++)P.set(l[o][0],l[o][1],l[o][2]),I.vmult(P,P),g.vadd(P,P),C(P.x,P.y,P.z)}},{key:"calculateWorldAABB",value:function(g,I,C,A){var l=this.halfExtents;q[0].set(l.x,l.y,l.z),q[1].set(-l.x,l.y,l.z),q[2].set(-l.x,-l.y,l.z),q[3].set(-l.x,-l.y,-l.z),q[4].set(l.x,-l.y,-l.z),q[5].set(l.x,l.y,-l.z),q[6].set(-l.x,l.y,-l.z),q[7].set(l.x,-l.y,l.z);var o=q[0];I.vmult(o,o),g.vadd(o,o),A.copy(o),C.copy(o);for(var e=1;e<8;e++){var i=q[e];I.vmult(i,i),g.vadd(i,i);var c=i.x,a=i.y,n=i.z;c>A.x&&(A.x=c),a>A.y&&(A.y=a),n>A.z&&(A.z=n),c<C.x&&(C.x=c),a<C.y&&(C.y=a),n<C.z&&(C.z=n)}}}],[{key:"calculateInertia",value:function(g,I,C){var A=g;C.x=1/12*I*(2*A.y*2*A.y+2*A.z*2*A.z),C.y=1/12*I*(2*A.x*2*A.x+2*A.z*2*A.z),C.z=1/12*I*(2*A.y*2*A.y+2*A.x*2*A.x)}}]),C}(M),P=new R,q=[new R,new R,new R,new R,new R,new R,new R,new R],_=1,$=2,gg=4,Ig=0,Cg=1,Ag=2,lg=function(g){(0,e.Z)(C,g);var I=(0,i.Z)(C);function C(g){var A;(0,c.Z)(this,C),void 0===g&&(g={}),(A=I.call(this)).id=void 0,A.index=void 0,A.world=void 0,A.preStep=void 0,A.postStep=void 0,A.vlambda=void 0,A.collisionFilterGroup=void 0,A.collisionFilterMask=void 0,A.collisionResponse=void 0,A.position=void 0,A.previousPosition=void 0,A.interpolatedPosition=void 0,A.initPosition=void 0,A.velocity=void 0,A.initVelocity=void 0,A.force=void 0,A.mass=void 0,A.invMass=void 0,A.material=void 0,A.linearDamping=void 0,A.type=void 0,A.allowSleep=void 0,A.sleepState=void 0,A.sleepSpeedLimit=void 0,A.sleepTimeLimit=void 0,A.timeLastSleepy=void 0,A.wakeUpAfterNarrowphase=void 0,A.torque=void 0,A.quaternion=void 0,A.initQuaternion=void 0,A.previousQuaternion=void 0,A.interpolatedQuaternion=void 0,A.angularVelocity=void 0,A.initAngularVelocity=void 0,A.shapes=void 0,A.shapeOffsets=void 0,A.shapeOrientations=void 0,A.inertia=void 0,A.invInertia=void 0,A.invInertiaWorld=void 0,A.invMassSolve=void 0,A.invInertiaSolve=void 0,A.invInertiaWorldSolve=void 0,A.fixedRotation=void 0,A.angularDamping=void 0,A.linearFactor=void 0,A.angularFactor=void 0,A.aabb=void 0,A.aabbNeedsUpdate=void 0,A.boundingRadius=void 0,A.wlambda=void 0,A.isTrigger=void 0,A.id=C.idCounter++,A.index=-1,A.world=null,A.preStep=null,A.postStep=null,A.vlambda=new R,A.collisionFilterGroup="number"===typeof g.collisionFilterGroup?g.collisionFilterGroup:1,A.collisionFilterMask="number"===typeof g.collisionFilterMask?g.collisionFilterMask:-1,A.collisionResponse="boolean"!==typeof g.collisionResponse||g.collisionResponse,A.position=new R,A.previousPosition=new R,A.interpolatedPosition=new R,A.initPosition=new R,g.position&&(A.position.copy(g.position),A.previousPosition.copy(g.position),A.interpolatedPosition.copy(g.position),A.initPosition.copy(g.position)),A.velocity=new R,g.velocity&&A.velocity.copy(g.velocity),A.initVelocity=new R,A.force=new R;var l="number"===typeof g.mass?g.mass:0;return A.mass=l,A.invMass=l>0?1/l:0,A.material=g.material||null,A.linearDamping="number"===typeof g.linearDamping?g.linearDamping:.01,A.type=l<=0?C.STATIC:C.DYNAMIC,typeof g.type===typeof C.STATIC&&(A.type=g.type),A.allowSleep="undefined"===typeof g.allowSleep||g.allowSleep,A.sleepState=C.AWAKE,A.sleepSpeedLimit="undefined"!==typeof g.sleepSpeedLimit?g.sleepSpeedLimit:.1,A.sleepTimeLimit="undefined"!==typeof g.sleepTimeLimit?g.sleepTimeLimit:1,A.timeLastSleepy=0,A.wakeUpAfterNarrowphase=!1,A.torque=new R,A.quaternion=new J,A.initQuaternion=new J,A.previousQuaternion=new J,A.interpolatedQuaternion=new J,g.quaternion&&(A.quaternion.copy(g.quaternion),A.initQuaternion.copy(g.quaternion),A.previousQuaternion.copy(g.quaternion),A.interpolatedQuaternion.copy(g.quaternion)),A.angularVelocity=new R,g.angularVelocity&&A.angularVelocity.copy(g.angularVelocity),A.initAngularVelocity=new R,A.shapes=[],A.shapeOffsets=[],A.shapeOrientations=[],A.inertia=new R,A.invInertia=new R,A.invInertiaWorld=new K,A.invMassSolve=0,A.invInertiaSolve=new R,A.invInertiaWorldSolve=new K,A.fixedRotation="undefined"!==typeof g.fixedRotation&&g.fixedRotation,A.angularDamping="undefined"!==typeof g.angularDamping?g.angularDamping:.01,A.linearFactor=new R(1,1,1),g.linearFactor&&A.linearFactor.copy(g.linearFactor),A.angularFactor=new R(1,1,1),g.angularFactor&&A.angularFactor.copy(g.angularFactor),A.aabb=new F,A.aabbNeedsUpdate=!0,A.boundingRadius=0,A.wlambda=new R,A.isTrigger=Boolean(g.isTrigger),g.shape&&A.addShape(g.shape),A.updateMassProperties(),A}return(0,a.Z)(C,[{key:"wakeUp",value:function(){var g=this.sleepState;this.sleepState=C.AWAKE,this.wakeUpAfterNarrowphase=!1,g===C.SLEEPING&&this.dispatchEvent(C.wakeupEvent)}},{key:"sleep",value:function(){this.sleepState=C.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1}},{key:"sleepTick",value:function(g){if(this.allowSleep){var I=this.sleepState,A=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),l=Math.pow(this.sleepSpeedLimit,2);I===C.AWAKE&&A<l?(this.sleepState=C.SLEEPY,this.timeLastSleepy=g,this.dispatchEvent(C.sleepyEvent)):I===C.SLEEPY&&A>l?this.wakeUp():I===C.SLEEPY&&g-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(C.sleepEvent))}}},{key:"updateSolveMassProperties",value:function(){this.sleepState===C.SLEEPING||this.type===C.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}},{key:"pointToLocalFrame",value:function(g,I){return void 0===I&&(I=new R),g.vsub(this.position,I),this.quaternion.conjugate().vmult(I,I),I}},{key:"vectorToLocalFrame",value:function(g,I){return void 0===I&&(I=new R),this.quaternion.conjugate().vmult(g,I),I}},{key:"pointToWorldFrame",value:function(g,I){return void 0===I&&(I=new R),this.quaternion.vmult(g,I),I.vadd(this.position,I),I}},{key:"vectorToWorldFrame",value:function(g,I){return void 0===I&&(I=new R),this.quaternion.vmult(g,I),I}},{key:"addShape",value:function(g,I,C){var A=new R,l=new J;return I&&A.copy(I),C&&l.copy(C),this.shapes.push(g),this.shapeOffsets.push(A),this.shapeOrientations.push(l),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,g.body=this,this}},{key:"removeShape",value:function(g){var I=this.shapes.indexOf(g);return-1===I?(console.warn("Shape does not belong to the body"),this):(this.shapes.splice(I,1),this.shapeOffsets.splice(I,1),this.shapeOrientations.splice(I,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,g.body=null,this)}},{key:"updateBoundingRadius",value:function(){for(var g=this.shapes,I=this.shapeOffsets,C=g.length,A=0,l=0;l!==C;l++){var o=g[l];o.updateBoundingSphereRadius();var e=I[l].length(),i=o.boundingSphereRadius;e+i>A&&(A=e+i)}this.boundingRadius=A}},{key:"updateAABB",value:function(){for(var g=this.shapes,I=this.shapeOffsets,C=this.shapeOrientations,A=g.length,l=og,o=eg,e=this.quaternion,i=this.aabb,c=ig,a=0;a!==A;a++){var n=g[a];e.vmult(I[a],l),l.vadd(this.position,l),e.mult(C[a],o),n.calculateWorldAABB(l,o,c.lowerBound,c.upperBound),0===a?i.copy(c):i.extend(c)}this.aabbNeedsUpdate=!1}},{key:"updateInertiaWorld",value:function(g){var I=this.invInertia;if(I.x!==I.y||I.y!==I.z||g){var C=cg,A=ag;C.setRotationFromQuaternion(this.quaternion),C.transpose(A),C.scale(I,C),C.mmult(A,this.invInertiaWorld)}else;}},{key:"applyForce",value:function(g,I){if(void 0===I&&(I=new R),this.type===C.DYNAMIC){this.sleepState===C.SLEEPING&&this.wakeUp();var A=ng;I.cross(g,A),this.force.vadd(g,this.force),this.torque.vadd(A,this.torque)}}},{key:"applyLocalForce",value:function(g,I){if(void 0===I&&(I=new R),this.type===C.DYNAMIC){var A=bg,l=dg;this.vectorToWorldFrame(g,A),this.vectorToWorldFrame(I,l),this.applyForce(A,l)}}},{key:"applyTorque",value:function(g){this.type===C.DYNAMIC&&(this.sleepState===C.SLEEPING&&this.wakeUp(),this.torque.vadd(g,this.torque))}},{key:"applyImpulse",value:function(g,I){if(void 0===I&&(I=new R),this.type===C.DYNAMIC){this.sleepState===C.SLEEPING&&this.wakeUp();var A=I,l=Gg;l.copy(g),l.scale(this.invMass,l),this.velocity.vadd(l,this.velocity);var o=Zg;A.cross(g,o),this.invInertiaWorld.vmult(o,o),this.angularVelocity.vadd(o,this.angularVelocity)}}},{key:"applyLocalImpulse",value:function(g,I){if(void 0===I&&(I=new R),this.type===C.DYNAMIC){var A=sg,l=tg;this.vectorToWorldFrame(g,A),this.vectorToWorldFrame(I,l),this.applyImpulse(A,l)}}},{key:"updateMassProperties",value:function(){var g=Bg;this.invMass=this.mass>0?1/this.mass:0;var I=this.inertia,C=this.fixedRotation;this.updateAABB(),g.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),O.calculateInertia(g,this.mass,I),this.invInertia.set(I.x>0&&!C?1/I.x:0,I.y>0&&!C?1/I.y:0,I.z>0&&!C?1/I.z:0),this.updateInertiaWorld(!0)}},{key:"getVelocityAtWorldPoint",value:function(g,I){var C=new R;return g.vsub(this.position,C),this.angularVelocity.cross(C,I),this.velocity.vadd(I,I),I}},{key:"integrate",value:function(g,I,A){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===C.DYNAMIC||this.type===C.KINEMATIC)&&this.sleepState!==C.SLEEPING){var l=this.velocity,o=this.angularVelocity,e=this.position,i=this.force,c=this.torque,a=this.quaternion,n=this.invMass,b=this.invInertiaWorld,d=this.linearFactor,G=n*g;l.x+=i.x*G*d.x,l.y+=i.y*G*d.y,l.z+=i.z*G*d.z;var Z=b.elements,s=this.angularFactor,t=c.x*s.x,B=c.y*s.y,u=c.z*s.z;o.x+=g*(Z[0]*t+Z[1]*B+Z[2]*u),o.y+=g*(Z[3]*t+Z[4]*B+Z[5]*u),o.z+=g*(Z[6]*t+Z[7]*B+Z[8]*u),e.x+=l.x*g,e.y+=l.y*g,e.z+=l.z*g,a.integrate(this.angularVelocity,g,this.angularFactor,a),I&&(A?a.normalizeFast():a.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}}]),C}(k);lg.idCounter=0,lg.COLLIDE_EVENT_NAME="collide",lg.DYNAMIC=_,lg.STATIC=$,lg.KINEMATIC=gg,lg.AWAKE=Ig,lg.SLEEPY=Cg,lg.SLEEPING=Ag,lg.wakeupEvent={type:"wakeup"},lg.sleepyEvent={type:"sleepy"},lg.sleepEvent={type:"sleep"};var og=new R,eg=new J,ig=new F,cg=new K,ag=new K,ng=new R,bg=new R,dg=new R,Gg=new R,Zg=new R,sg=new R,tg=new R,Bg=new R;new R,new R;var ug=function(){function g(){(0,c.Z)(this,g),this.rayFromWorld=void 0,this.rayToWorld=void 0,this.hitNormalWorld=void 0,this.hitPointWorld=void 0,this.hasHit=void 0,this.shape=void 0,this.body=void 0,this.hitFaceIndex=void 0,this.distance=void 0,this.shouldStop=void 0,this.rayFromWorld=new R,this.rayToWorld=new R,this.hitNormalWorld=new R,this.hitPointWorld=new R,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}return(0,a.Z)(g,[{key:"reset",value:function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}},{key:"abort",value:function(){this.shouldStop=!0}},{key:"set",value:function(g,I,C,A,l,o,e){this.rayFromWorld.copy(g),this.rayToWorld.copy(I),this.hitNormalWorld.copy(C),this.hitPointWorld.copy(A),this.shape=l,this.body=o,this.distance=e}}]),g}(),mg=1,hg=2,Wg=4,rg=function(g,I,C,A,l,o,e){function i(g,I){(0,c.Z)(this,i),void 0===g&&(g=new R),void 0===I&&(I=new R),this.from=void 0,this.to=void 0,this.direction=void 0,this.precision=void 0,this.checkCollisionResponse=void 0,this.skipBackfaces=void 0,this.collisionFilterMask=void 0,this.collisionFilterGroup=void 0,this.mode=void 0,this.result=void 0,this.hasHit=void 0,this.callback=void 0,this.from=g.clone(),this.to=I.clone(),this.direction=new R,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=i.ANY,this.result=new ug,this.hasHit=!1,this.callback=function(g){}}return(0,a.Z)(i,[{key:g,get:function(){return this._intersectSphere}},{key:I,get:function(){return this._intersectPlane}},{key:C,get:function(){return this._intersectBox}},{key:A,get:function(){return this._intersectConvex}},{key:l,get:function(){return this._intersectConvex}},{key:o,get:function(){return this._intersectHeightfield}},{key:e,get:function(){return this._intersectTrimesh}},{key:"intersectWorld",value:function(g,I){return this.mode=I.mode||i.ANY,this.result=I.result||new ug,this.skipBackfaces=!!I.skipBackfaces,this.collisionFilterMask="undefined"!==typeof I.collisionFilterMask?I.collisionFilterMask:-1,this.collisionFilterGroup="undefined"!==typeof I.collisionFilterGroup?I.collisionFilterGroup:-1,this.checkCollisionResponse="undefined"===typeof I.checkCollisionResponse||I.checkCollisionResponse,I.from&&this.from.copy(I.from),I.to&&this.to.copy(I.to),this.callback=I.callback||function(){},this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(yg),pg.length=0,g.broadphase.aabbQuery(g,yg,pg),this.intersectBodies(pg),this.hasHit}},{key:"intersectBody",value:function(g,I){I&&(this.result=I,this.updateDirection());var C=this.checkCollisionResponse;if((!C||g.collisionResponse)&&0!==(this.collisionFilterGroup&g.collisionFilterMask)&&0!==(g.collisionFilterGroup&this.collisionFilterMask))for(var A=Xg,l=Kg,o=0,e=g.shapes.length;o<e;o++){var i=g.shapes[o];if((!C||i.collisionResponse)&&(g.quaternion.mult(g.shapeOrientations[o],l),g.quaternion.vmult(g.shapeOffsets[o],A),A.vadd(g.position,A),this.intersectShape(i,l,A,g),this.result.shouldStop))break}}},{key:"intersectBodies",value:function(g,I){I&&(this.result=I,this.updateDirection());for(var C=0,A=g.length;!this.result.shouldStop&&C<A;C++)this.intersectBody(g[C])}},{key:"updateDirection",value:function(){this.to.vsub(this.from,this.direction),this.direction.normalize()}},{key:"intersectShape",value:function(g,I,C,A){var l=function(g,I,C){C.vsub(g,Og);var A=Og.dot(I);return I.scale(A,Pg),Pg.vadd(g,Pg),C.distanceTo(Pg)}(this.from,this.direction,C);if(!(l>g.boundingSphereRadius)){var o=this[g.type];o&&o.call(this,g,I,C,A,g)}}},{key:"_intersectBox",value:function(g,I,C,A,l){return this._intersectConvex(g.convexPolyhedronRepresentation,I,C,A,l)}},{key:"_intersectPlane",value:function(g,I,C,A,l){var o=this.from,e=this.to,i=this.direction,c=new R(0,0,1);I.vmult(c,c);var a=new R;o.vsub(C,a);var n=a.dot(c);if(e.vsub(C,a),!(n*a.dot(c)>0)&&!(o.distanceTo(e)<n)){var b=c.dot(i);if(!(Math.abs(b)<this.precision)){var d=new R,G=new R,Z=new R;o.vsub(C,d);var s=-c.dot(d)/b;i.scale(s,G),o.vadd(G,Z),this.reportIntersection(c,Z,l,A,-1)}}}},{key:"getAABB",value:function(g){var I=g.lowerBound,C=g.upperBound,A=this.to,l=this.from;I.x=Math.min(A.x,l.x),I.y=Math.min(A.y,l.y),I.z=Math.min(A.z,l.z),C.x=Math.max(A.x,l.x),C.y=Math.max(A.y,l.y),C.z=Math.max(A.z,l.z)}},{key:"_intersectHeightfield",value:function(g,I,C,A,l){g.data,g.elementSize;var o=Sg;o.from.copy(this.from),o.to.copy(this.to),Q.pointToLocalFrame(C,I,o.from,o.from),Q.pointToLocalFrame(C,I,o.to,o.to),o.updateDirection();var e,i,c,a,n=zg;e=i=0,c=a=g.data.length-1;var b=new F;o.getAABB(b),g.getIndexOfPosition(b.lowerBound.x,b.lowerBound.y,n,!0),e=Math.max(e,n[0]),i=Math.max(i,n[1]),g.getIndexOfPosition(b.upperBound.x,b.upperBound.y,n,!0),c=Math.min(c,n[0]+1),a=Math.min(a,n[1]+1);for(var d=e;d<c;d++)for(var G=i;G<a;G++){if(this.result.shouldStop)return;if(g.getAabbAtIndex(d,G,b),b.overlapsRay(o)){if(g.getConvexTrianglePillar(d,G,!1),Q.pointToWorldFrame(C,I,g.pillarOffset,Fg),this._intersectConvex(g.pillarConvex,I,Fg,A,l,Ng),this.result.shouldStop)return;g.getConvexTrianglePillar(d,G,!0),Q.pointToWorldFrame(C,I,g.pillarOffset,Fg),this._intersectConvex(g.pillarConvex,I,Fg,A,l,Ng)}}}},{key:"_intersectSphere",value:function(g,I,C,A,l){var o=this.from,e=this.to,i=g.radius,c=Math.pow(e.x-o.x,2)+Math.pow(e.y-o.y,2)+Math.pow(e.z-o.z,2),a=2*((e.x-o.x)*(o.x-C.x)+(e.y-o.y)*(o.y-C.y)+(e.z-o.z)*(o.z-C.z)),n=Math.pow(o.x-C.x,2)+Math.pow(o.y-C.y,2)+Math.pow(o.z-C.z,2)-Math.pow(i,2),b=Math.pow(a,2)-4*c*n,d=kg,G=Jg;if(!(b<0))if(0===b)o.lerp(e,b,d),d.vsub(C,G),G.normalize(),this.reportIntersection(G,d,l,A,-1);else{var Z=(-a-Math.sqrt(b))/(2*c),s=(-a+Math.sqrt(b))/(2*c);if(Z>=0&&Z<=1&&(o.lerp(e,Z,d),d.vsub(C,G),G.normalize(),this.reportIntersection(G,d,l,A,-1)),this.result.shouldStop)return;s>=0&&s<=1&&(o.lerp(e,s,d),d.vsub(C,G),G.normalize(),this.reportIntersection(G,d,l,A,-1))}}},{key:"_intersectConvex",value:function(g,I,C,A,l,o){for(var e=Lg,c=fg,a=o&&o.faceList||null,n=g.faces,b=g.vertices,d=g.faceNormals,G=this.direction,Z=this.from,s=this.to,t=Z.distanceTo(s),B=a?a.length:n.length,u=this.result,m=0;!u.shouldStop&&m<B;m++){var h=a?a[m]:m,W=n[h],r=d[h],y=I,p=C;c.copy(b[W[0]]),y.vmult(c,c),c.vadd(p,c),c.vsub(Z,c),y.vmult(r,e);var V=G.dot(e);if(!(Math.abs(V)<this.precision)){var v=e.dot(c)/V;if(!(v<0)){G.scale(v,Yg),Yg.vadd(Z,Yg),Rg.copy(b[W[0]]),y.vmult(Rg,Rg),p.vadd(Rg,Rg);for(var X=1;!u.shouldStop&&X<W.length-1;X++){Hg.copy(b[W[X]]),wg.copy(b[W[X+1]]),y.vmult(Hg,Hg),y.vmult(wg,wg),p.vadd(Hg,Hg),p.vadd(wg,wg);var K=Yg.distanceTo(Z);!i.pointInTriangle(Yg,Rg,Hg,wg)&&!i.pointInTriangle(Yg,Hg,Rg,wg)||K>t||this.reportIntersection(e,Yg,l,A,h)}}}}}},{key:"_intersectTrimesh",value:function(g,I,C,A,l,o){var e=Mg,c=Dg,a=Eg,n=fg,b=Qg,d=xg,G=Ug,Z=jg,s=Tg,t=g.indices;g.vertices;var B=this.from,u=this.to,m=this.direction;a.position.copy(C),a.quaternion.copy(I),Q.vectorToLocalFrame(C,I,m,b),Q.pointToLocalFrame(C,I,B,d),Q.pointToLocalFrame(C,I,u,G),G.x*=g.scale.x,G.y*=g.scale.y,G.z*=g.scale.z,d.x*=g.scale.x,d.y*=g.scale.y,d.z*=g.scale.z,G.vsub(d,b),b.normalize();var h=d.distanceSquared(G);g.tree.rayQuery(this,a,c);for(var W=0,r=c.length;!this.result.shouldStop&&W!==r;W++){var y=c[W];g.getNormal(y,e),g.getVertex(t[3*y],Rg),Rg.vsub(d,n);var p=b.dot(e),V=e.dot(n)/p;if(!(V<0)){b.scale(V,Yg),Yg.vadd(d,Yg),g.getVertex(t[3*y+1],Hg),g.getVertex(t[3*y+2],wg);var v=Yg.distanceSquared(d);!i.pointInTriangle(Yg,Hg,Rg,wg)&&!i.pointInTriangle(Yg,Rg,Hg,wg)||v>h||(Q.vectorToWorldFrame(I,e,s),Q.pointToWorldFrame(C,I,Yg,Z),this.reportIntersection(s,Z,l,A,y))}}c.length=0}},{key:"reportIntersection",value:function(g,I,C,A,l){var o=this.from,e=this.to,c=o.distanceTo(I),a=this.result;if(!(this.skipBackfaces&&g.dot(this.direction)>0))switch(a.hitFaceIndex="undefined"!==typeof l?l:-1,this.mode){case i.ALL:this.hasHit=!0,a.set(o,e,g,I,C,A,c),a.hasHit=!0,this.callback(a);break;case i.CLOSEST:(c<a.distance||!a.hasHit)&&(this.hasHit=!0,a.hasHit=!0,a.set(o,e,g,I,C,A,c));break;case i.ANY:this.hasHit=!0,a.hasHit=!0,a.set(o,e,g,I,C,A,c),a.shouldStop=!0}}}],[{key:"pointInTriangle",value:function(g,I,C,A){A.vsub(I,Og),C.vsub(I,Vg),g.vsub(I,vg);var l,o,e=Og.dot(Og),i=Og.dot(Vg),c=Og.dot(vg),a=Vg.dot(Vg),n=Vg.dot(vg);return(l=a*c-i*n)>=0&&(o=e*n-i*c)>=0&&l+o<e*a-i*i}}]),i}(M.types.SPHERE,M.types.PLANE,M.types.BOX,M.types.CYLINDER,M.types.CONVEXPOLYHEDRON,M.types.HEIGHTFIELD,M.types.TRIMESH);rg.CLOSEST=mg,rg.ANY=hg,rg.ALL=Wg;var yg=new F,pg=[],Vg=new R,vg=new R,Xg=new R,Kg=new J,Yg=new R,Rg=new R,Hg=new R,wg=new R,Ng={faceList:[0]},Fg=new R,Sg=new rg,zg=[],kg=new R,Jg=new R,Lg=new R,fg=new R,Mg=new R,Qg=new R,xg=new R,Ug=new R,Tg=new R,jg=new R;new F;var Dg=[],Eg=new Q,Og=new R,Pg=new R;new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R;var qg=(0,a.Z)((function g(I){(0,c.Z)(this,g),void 0===I&&(I={}),this.name=void 0,this.id=void 0,this.friction=void 0,this.restitution=void 0;var C="";"string"===typeof I&&(C=I,I={}),this.name=C,this.id=g.idCounter++,this.friction="undefined"!==typeof I.friction?I.friction:-1,this.restitution="undefined"!==typeof I.restitution?I.restitution:-1}));qg.idCounter=0,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new rg,new R,new R,new R(1,0,0),new R(0,1,0),new R(0,0,1),new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R;new R,new R,new R,new R,new R,new R,new R,new R,new R;new R,new R,new R,new R,new R,new R,new R,new R,new R,new R;new R,new F,new R,new F,new R,new R,new R,new R,new R,new R,new R,new F,new R,new Q,new F;M.types.SPHERE,M.types.SPHERE,M.types.PLANE,M.types.BOX,M.types.BOX,M.types.SPHERE,M.types.BOX,M.types.PLANE,M.types.BOX,M.types.CONVEXPOLYHEDRON,M.types.SPHERE,M.types.CONVEXPOLYHEDRON,M.types.PLANE,M.types.CONVEXPOLYHEDRON,M.types.BOX,M.types.CONVEXPOLYHEDRON,M.types.SPHERE,M.types.HEIGHTFIELD,M.types.BOX,M.types.HEIGHTFIELD,M.types.CONVEXPOLYHEDRON,M.types.HEIGHTFIELD,M.types.PARTICLE,M.types.SPHERE,M.types.PLANE,M.types.PARTICLE,M.types.BOX,M.types.PARTICLE,M.types.PARTICLE,M.types.CONVEXPOLYHEDRON,M.types.CYLINDER,M.types.SPHERE,M.types.CYLINDER,M.types.PLANE,M.types.CYLINDER,M.types.BOX,M.types.CYLINDER,M.types.CONVEXPOLYHEDRON,M.types.CYLINDER,M.types.HEIGHTFIELD,M.types.CYLINDER,M.types.PARTICLE,M.types.CYLINDER,M.types.SPHERE,M.types.TRIMESH,M.types.PLANE,M.types.TRIMESH,new R,new R,new R,new R,new R,new J,new J,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new F,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new R,new J,new R,new R,new R,new R,new R,new R,new R,new R,new F,new rg;var _g=globalThis.performance||{};if(!_g.now){var $g=Date.now();_g.timing&&_g.timing.navigationStart&&($g=_g.timing.navigationStart),_g.now=function(){return Date.now()-$g}}new Z.Vector3,new Z.Vector3(1,1,1),new Z.Quaternion;var gI=new Z.Object3D;function II(g){var I=(0,d.useRef)(null);return g&&"function"!==typeof g?g:I}function CI(g){return g.charAt(0).toUpperCase()+g.slice(1)}function AI(g,I){var C=void 0===I?"":"/".concat(I);return"function"===typeof g?null:g&&g.current&&"".concat(g.current.uuid).concat(C)}var lI=new Z.Euler,oI=new Z.Quaternion,eI=0;function iI(g,I,C,l,o,e){return void 0===e&&(e="bodies"),function(i){var c=eI++;C[c]=(0,A.Z)({},l,i);var a=AI(g,o);return a&&I.postMessage({op:"subscribe",props:{id:c,target:e,type:l},uuid:a}),function(){delete C[c],I.postMessage({op:"unsubscribe",props:c})}}}function cI(g,I){var C,A;g.userData=I.userData||{},(C=g.position).set.apply(C,(0,o.Z)(I.position||[0,0,0])),(A=g.rotation).set.apply(A,(0,o.Z)(I.rotation||[0,0,0])),g.updateMatrix()}function aI(g,I,C){var A=I.onCollide,l=I.onCollideBegin,o=I.onCollideEnd;g[C]={collide:A,collideBegin:l,collideEnd:o}}function nI(g,I,C,o,e){void 0===e&&(e=[]);var i=II(o),c=(0,d.useContext)(m),a=c.worker,b=c.refs,G=c.events,s=c.subscriptions,B=(0,d.useContext)(h);(0,d.useLayoutEffect)((function(){i.current||(i.current=new Z.Object3D);var A=i.current,o=a,e=A instanceof Z.InstancedMesh?(A.instanceMatrix.setUsage(Z.DynamicDrawUsage),A.count):1,c=A instanceof Z.InstancedMesh?new Array(e).fill(0).map((function(g,I){return"".concat(A.uuid,"/").concat(I)})):[A.uuid],d=A instanceof Z.InstancedMesh?c.map((function(l,o){var e=I(o);return cI(gI,e),A.setMatrixAt(o,gI.matrix),A.instanceMatrix.needsUpdate=!0,b[l]=A,B&&B.add(l,e,g),aI(G,e,l),(0,n.Z)((0,n.Z)({},e),{},{args:C(e.args)})})):c.map((function(l,o){var e=I(o);return cI(A,e),b[l]=A,B&&B.add(l,e,g),aI(G,e,l),(0,n.Z)((0,n.Z)({},e),{},{args:C(e.args)})}));return o.postMessage({op:"addBodies",props:d.map((function(g){var I=g.onCollide,C=(g.onCollideBegin,g.onCollideEnd,(0,l.Z)(g,t));return(0,n.Z)({onCollide:Boolean(I)},C)})),type:g,uuid:c}),function(){c.forEach((function(g){delete b[g],B&&B.remove(g),delete G[g]})),o.postMessage({op:"removeBodies",uuid:c})}}),e);var u=(0,d.useMemo)((function(){var g=function(g,I){var C="set".concat(CI(g));return{set:function(g){var A=AI(i,I);A&&a.postMessage({op:C,props:g,uuid:A})},subscribe:iI(i,a,s,g,I)}},I=function(g){var I="setQuaternion";return{copy:function(C){var A=C.w,l=C.x,o=C.y,e=C.z,c=AI(i,g);c&&a.postMessage({op:I,props:[l,o,e,A],uuid:c})},set:function(C,A,l,o){var e=AI(i,g);e&&a.postMessage({op:I,props:[C,A,l,o],uuid:e})},subscribe:iI(i,a,s,"quaternion",g)}},C=function(g){var I="setRotation";return{copy:function(C){var A=C.x,l=C.y,o=C.z,e=AI(i,g);e&&a.postMessage({op:I,props:[A,l,o],uuid:e})},set:function(C,A,l){var o=AI(i,g);o&&a.postMessage({op:I,props:[C,A,l],uuid:o})},subscribe:function(I){var C=eI++,l="quaternion",o=AI(i,g);return s[C]=(0,A.Z)({},l,function(g){return function(I){return g(lI.setFromQuaternion(oI.fromArray(I)).toArray())}}(I)),o&&a.postMessage({op:"subscribe",props:{id:C,target:"bodies",type:l},uuid:o}),function(){delete s[C],a.postMessage({op:"unsubscribe",props:C})}}}},l=function(g,I){var C="set".concat(CI(g));return{copy:function(g){var A=g.x,l=g.y,o=g.z,e=AI(i,I);e&&a.postMessage({op:C,props:[A,l,o],uuid:e})},set:function(g,A,l){var o=AI(i,I);o&&a.postMessage({op:C,props:[g,A,l],uuid:o})},subscribe:iI(i,a,s,g,I)}};function o(A){return{allowSleep:g("allowSleep",A),angularDamping:g("angularDamping",A),angularFactor:l("angularFactor",A),angularVelocity:l("angularVelocity",A),applyForce:function(g,I){var C=AI(i,A);C&&a.postMessage({op:"applyForce",props:[g,I],uuid:C})},applyImpulse:function(g,I){var C=AI(i,A);C&&a.postMessage({op:"applyImpulse",props:[g,I],uuid:C})},applyLocalForce:function(g,I){var C=AI(i,A);C&&a.postMessage({op:"applyLocalForce",props:[g,I],uuid:C})},applyLocalImpulse:function(g,I){var C=AI(i,A);C&&a.postMessage({op:"applyLocalImpulse",props:[g,I],uuid:C})},applyTorque:function(g){var I=AI(i,A);I&&a.postMessage({op:"applyTorque",props:[g],uuid:I})},collisionFilterGroup:g("collisionFilterGroup",A),collisionFilterMask:g("collisionFilterMask",A),collisionResponse:g("collisionResponse",A),fixedRotation:g("fixedRotation",A),isTrigger:g("isTrigger",A),linearDamping:g("linearDamping",A),linearFactor:l("linearFactor",A),mass:g("mass",A),material:g("material",A),position:l("position",A),quaternion:I(A),rotation:C(A),sleep:function(){var g=AI(i,A);g&&a.postMessage({op:"sleep",uuid:g})},sleepSpeedLimit:g("sleepSpeedLimit",A),sleepTimeLimit:g("sleepTimeLimit",A),userData:g("userData",A),velocity:l("velocity",A),wakeUp:function(){var g=AI(i,A);g&&a.postMessage({op:"wakeUp",uuid:g})}}}var e={};return(0,n.Z)((0,n.Z)({},o(void 0)),{},{at:function(g){return e[g]||(e[g]=o(g))}})}),[]);return[i,u]}function bI(g,I,C){return void 0===I&&(I=null),nI("Plane",g,(function(){return[]}),I,C)}function dI(g,I,C){void 0===I&&(I=null);var A=[1,1,1];return nI("Box",g,(function(g){return void 0===g&&(g=A),g}),I,C)}var GI=function(g){return(0,s.jsx)(d.Suspense,{fallback:null,children:(0,s.jsx)(X,(0,n.Z)({},g))})}},3520:function(g,I,C){"use strict";C.d(I,{z:function(){return B}});var A=C(4925),l=C(7462),o=C(4641),e=C(2791),i=C(3144),c=C(5671),a=C(7326),n=C(136),b=C(9388),d=C(4942),G=C(323),Z=function(g,I){return(g%I+I)%I},s=function(g){(0,n.Z)(C,g);var I=(0,b.Z)(C);function C(g,A){var l;(0,c.Z)(this,C),l=I.call(this),(0,d.Z)((0,a.Z)(l),"object",void 0),(0,d.Z)((0,a.Z)(l),"domElement",void 0),(0,d.Z)((0,a.Z)(l),"enabled",!0),(0,d.Z)((0,a.Z)(l),"target",new G.Vector3),(0,d.Z)((0,a.Z)(l),"minDistance",0),(0,d.Z)((0,a.Z)(l),"maxDistance",1/0),(0,d.Z)((0,a.Z)(l),"minZoom",0),(0,d.Z)((0,a.Z)(l),"maxZoom",1/0),(0,d.Z)((0,a.Z)(l),"minPolarAngle",0),(0,d.Z)((0,a.Z)(l),"maxPolarAngle",Math.PI),(0,d.Z)((0,a.Z)(l),"minAzimuthAngle",-1/0),(0,d.Z)((0,a.Z)(l),"maxAzimuthAngle",1/0),(0,d.Z)((0,a.Z)(l),"enableDamping",!1),(0,d.Z)((0,a.Z)(l),"dampingFactor",.05),(0,d.Z)((0,a.Z)(l),"enableZoom",!0),(0,d.Z)((0,a.Z)(l),"zoomSpeed",1),(0,d.Z)((0,a.Z)(l),"enableRotate",!0),(0,d.Z)((0,a.Z)(l),"rotateSpeed",1),(0,d.Z)((0,a.Z)(l),"enablePan",!0),(0,d.Z)((0,a.Z)(l),"panSpeed",1),(0,d.Z)((0,a.Z)(l),"screenSpacePanning",!0),(0,d.Z)((0,a.Z)(l),"keyPanSpeed",7),(0,d.Z)((0,a.Z)(l),"autoRotate",!1),(0,d.Z)((0,a.Z)(l),"autoRotateSpeed",2),(0,d.Z)((0,a.Z)(l),"reverseOrbit",!1),(0,d.Z)((0,a.Z)(l),"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),(0,d.Z)((0,a.Z)(l),"mouseButtons",{LEFT:G.MOUSE.ROTATE,MIDDLE:G.MOUSE.DOLLY,RIGHT:G.MOUSE.PAN}),(0,d.Z)((0,a.Z)(l),"touches",{ONE:G.TOUCH.ROTATE,TWO:G.TOUCH.DOLLY_PAN}),(0,d.Z)((0,a.Z)(l),"target0",void 0),(0,d.Z)((0,a.Z)(l),"position0",void 0),(0,d.Z)((0,a.Z)(l),"zoom0",void 0),(0,d.Z)((0,a.Z)(l),"_domElementKeyEvents",null),(0,d.Z)((0,a.Z)(l),"getPolarAngle",void 0),(0,d.Z)((0,a.Z)(l),"getAzimuthalAngle",void 0),(0,d.Z)((0,a.Z)(l),"setPolarAngle",void 0),(0,d.Z)((0,a.Z)(l),"setAzimuthalAngle",void 0),(0,d.Z)((0,a.Z)(l),"getDistance",void 0),(0,d.Z)((0,a.Z)(l),"listenToKeyEvents",void 0),(0,d.Z)((0,a.Z)(l),"saveState",void 0),(0,d.Z)((0,a.Z)(l),"reset",void 0),(0,d.Z)((0,a.Z)(l),"update",void 0),(0,d.Z)((0,a.Z)(l),"connect",void 0),(0,d.Z)((0,a.Z)(l),"dispose",void 0),l.object=g,l.domElement=A,l.target0=l.target.clone(),l.position0=l.object.position.clone(),l.zoom0=l.object instanceof G.PerspectiveCamera?l.object.zoom:1,l.getPolarAngle=function(){return B.phi},l.getAzimuthalAngle=function(){return B.theta},l.setPolarAngle=function(g){var I=Z(g,2*Math.PI),C=B.phi;C<0&&(C+=2*Math.PI),I<0&&(I+=2*Math.PI);var A=Math.abs(I-C);2*Math.PI-A<A&&(I<C?I+=2*Math.PI:C+=2*Math.PI),u.phi=I-C,o.update()},l.setAzimuthalAngle=function(g){var I=Z(g,2*Math.PI),C=B.theta;C<0&&(C+=2*Math.PI),I<0&&(I+=2*Math.PI);var A=Math.abs(I-C);2*Math.PI-A<A&&(I<C?I+=2*Math.PI:C+=2*Math.PI),u.theta=I-C,o.update()},l.getDistance=function(){return o.object.position.distanceTo(o.target)},l.listenToKeyEvents=function(g){g.addEventListener("keydown",gg),l._domElementKeyEvents=g},l.saveState=function(){o.target0.copy(o.target),o.position0.copy(o.object.position),o.zoom0=o.object instanceof G.PerspectiveCamera?o.object.zoom:1},l.reset=function(){o.target.copy(o.target0),o.object.position.copy(o.position0),o.object instanceof G.PerspectiveCamera&&(o.object.zoom=o.zoom0,o.object.updateProjectionMatrix()),o.dispatchEvent(e),o.update(),s=b.NONE},l.update=function(){var I=new G.Vector3,C=(new G.Quaternion).setFromUnitVectors(g.up,new G.Vector3(0,1,0)),A=C.clone().invert(),l=new G.Vector3,i=new G.Quaternion,c=2*Math.PI;return function(){var g=o.object.position;I.copy(g).sub(o.target),I.applyQuaternion(C),B.setFromVector3(I),o.autoRotate&&s===b.NONE&&F(2*Math.PI/60/60*o.autoRotateSpeed),o.enableDamping?(B.theta+=u.theta*o.dampingFactor,B.phi+=u.phi*o.dampingFactor):(B.theta+=u.theta,B.phi+=u.phi);var a=o.minAzimuthAngle,n=o.maxAzimuthAngle;return isFinite(a)&&isFinite(n)&&(a<-Math.PI?a+=c:a>Math.PI&&(a-=c),n<-Math.PI?n+=c:n>Math.PI&&(n-=c),B.theta=a<=n?Math.max(a,Math.min(n,B.theta)):B.theta>(a+n)/2?Math.max(a,B.theta):Math.min(n,B.theta)),B.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,B.phi)),B.makeSafe(),B.radius*=m,B.radius=Math.max(o.minDistance,Math.min(o.maxDistance,B.radius)),!0===o.enableDamping?o.target.addScaledVector(h,o.dampingFactor):o.target.add(h),I.setFromSpherical(B),I.applyQuaternion(A),g.copy(o.target).add(I),o.object.lookAt(o.target),!0===o.enableDamping?(u.theta*=1-o.dampingFactor,u.phi*=1-o.dampingFactor,h.multiplyScalar(1-o.dampingFactor)):(u.set(0,0,0),h.set(0,0,0)),m=1,!!(W||l.distanceToSquared(o.object.position)>t||8*(1-i.dot(o.object.quaternion))>t)&&(o.dispatchEvent(e),l.copy(o.object.position),i.copy(o.object.quaternion),W=!1,!0)}}(),l.connect=function(g){g===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),o.domElement=g,o.domElement.style.touchAction="none",o.domElement.addEventListener("contextmenu",Ig),o.domElement.addEventListener("pointerdown",O),o.domElement.addEventListener("pointercancel",_),o.domElement.addEventListener("wheel",$)},l.dispose=function(){var g,I,C,A,l,e;null===(g=o.domElement)||void 0===g||g.removeEventListener("contextmenu",Ig),null===(I=o.domElement)||void 0===I||I.removeEventListener("pointerdown",O),null===(C=o.domElement)||void 0===C||C.removeEventListener("pointercancel",_),null===(A=o.domElement)||void 0===A||A.removeEventListener("wheel",$),null===(l=o.domElement)||void 0===l||l.ownerDocument.removeEventListener("pointermove",P),null===(e=o.domElement)||void 0===e||e.ownerDocument.removeEventListener("pointerup",q),null!==o._domElementKeyEvents&&o._domElementKeyEvents.removeEventListener("keydown",gg)};var o=(0,a.Z)(l),e={type:"change"},i={type:"start"},n={type:"end"},b={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},s=b.NONE,t=1e-6,B=new G.Spherical,u=new G.Spherical,m=1,h=new G.Vector3,W=!1,r=new G.Vector2,y=new G.Vector2,p=new G.Vector2,V=new G.Vector2,v=new G.Vector2,X=new G.Vector2,K=new G.Vector2,Y=new G.Vector2,R=new G.Vector2,H=[],w={};function N(){return Math.pow(.95,o.zoomSpeed)}function F(g){o.reverseOrbit?u.theta+=g:u.theta-=g}function S(g){o.reverseOrbit?u.phi+=g:u.phi-=g}var z=function(){var g=new G.Vector3;return function(I,C){g.setFromMatrixColumn(C,0),g.multiplyScalar(-I),h.add(g)}}(),k=function(){var g=new G.Vector3;return function(I,C){!0===o.screenSpacePanning?g.setFromMatrixColumn(C,1):(g.setFromMatrixColumn(C,0),g.crossVectors(o.object.up,g)),g.multiplyScalar(I),h.add(g)}}(),J=function(){var g=new G.Vector3;return function(I,C){var A=o.domElement;if(A&&o.object instanceof G.PerspectiveCamera&&o.object.isPerspectiveCamera){var l=o.object.position;g.copy(l).sub(o.target);var e=g.length();e*=Math.tan(o.object.fov/2*Math.PI/180),z(2*I*e/A.clientHeight,o.object.matrix),k(2*C*e/A.clientHeight,o.object.matrix)}else A&&o.object instanceof G.OrthographicCamera&&o.object.isOrthographicCamera?(z(I*(o.object.right-o.object.left)/o.object.zoom/A.clientWidth,o.object.matrix),k(C*(o.object.top-o.object.bottom)/o.object.zoom/A.clientHeight,o.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),o.enablePan=!1)}}();function L(g){o.object instanceof G.PerspectiveCamera&&o.object.isPerspectiveCamera?m/=g:o.object instanceof G.OrthographicCamera&&o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom*g)),o.object.updateProjectionMatrix(),W=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function f(g){o.object instanceof G.PerspectiveCamera&&o.object.isPerspectiveCamera?m*=g:o.object instanceof G.OrthographicCamera&&o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom/g)),o.object.updateProjectionMatrix(),W=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function M(g){r.set(g.clientX,g.clientY)}function Q(g){V.set(g.clientX,g.clientY)}function x(){if(1==H.length)r.set(H[0].pageX,H[0].pageY);else{var g=.5*(H[0].pageX+H[1].pageX),I=.5*(H[0].pageY+H[1].pageY);r.set(g,I)}}function U(){if(1==H.length)V.set(H[0].pageX,H[0].pageY);else{var g=.5*(H[0].pageX+H[1].pageX),I=.5*(H[0].pageY+H[1].pageY);V.set(g,I)}}function T(){var g=H[0].pageX-H[1].pageX,I=H[0].pageY-H[1].pageY,C=Math.sqrt(g*g+I*I);K.set(0,C)}function j(g){if(1==H.length)y.set(g.pageX,g.pageY);else{var I=lg(g),C=.5*(g.pageX+I.x),A=.5*(g.pageY+I.y);y.set(C,A)}p.subVectors(y,r).multiplyScalar(o.rotateSpeed);var l=o.domElement;l&&(F(2*Math.PI*p.x/l.clientHeight),S(2*Math.PI*p.y/l.clientHeight)),r.copy(y)}function D(g){if(1==H.length)v.set(g.pageX,g.pageY);else{var I=lg(g),C=.5*(g.pageX+I.x),A=.5*(g.pageY+I.y);v.set(C,A)}X.subVectors(v,V).multiplyScalar(o.panSpeed),J(X.x,X.y),V.copy(v)}function E(g){var I=lg(g),C=g.pageX-I.x,A=g.pageY-I.y,l=Math.sqrt(C*C+A*A);Y.set(0,l),R.set(0,Math.pow(Y.y/K.y,o.zoomSpeed)),L(R.y),K.copy(Y)}function O(g){if(!1!==o.enabled){var I,C;if(0===H.length)null===(I=o.domElement)||void 0===I||I.ownerDocument.addEventListener("pointermove",P),null===(C=o.domElement)||void 0===C||C.ownerDocument.addEventListener("pointerup",q);!function(g){H.push(g)}(g),"touch"===g.pointerType?function(g){switch(Ag(g),H.length){case 1:switch(o.touches.ONE){case G.TOUCH.ROTATE:if(!1===o.enableRotate)return;x(),s=b.TOUCH_ROTATE;break;case G.TOUCH.PAN:if(!1===o.enablePan)return;U(),s=b.TOUCH_PAN;break;default:s=b.NONE}break;case 2:switch(o.touches.TWO){case G.TOUCH.DOLLY_PAN:if(!1===o.enableZoom&&!1===o.enablePan)return;o.enableZoom&&T(),o.enablePan&&U(),s=b.TOUCH_DOLLY_PAN;break;case G.TOUCH.DOLLY_ROTATE:if(!1===o.enableZoom&&!1===o.enableRotate)return;o.enableZoom&&T(),o.enableRotate&&x(),s=b.TOUCH_DOLLY_ROTATE;break;default:s=b.NONE}break;default:s=b.NONE}s!==b.NONE&&o.dispatchEvent(i)}(g):function(g){var I;switch(g.button){case 0:I=o.mouseButtons.LEFT;break;case 1:I=o.mouseButtons.MIDDLE;break;case 2:I=o.mouseButtons.RIGHT;break;default:I=-1}switch(I){case G.MOUSE.DOLLY:if(!1===o.enableZoom)return;!function(g){K.set(g.clientX,g.clientY)}(g),s=b.DOLLY;break;case G.MOUSE.ROTATE:if(g.ctrlKey||g.metaKey||g.shiftKey){if(!1===o.enablePan)return;Q(g),s=b.PAN}else{if(!1===o.enableRotate)return;M(g),s=b.ROTATE}break;case G.MOUSE.PAN:if(g.ctrlKey||g.metaKey||g.shiftKey){if(!1===o.enableRotate)return;M(g),s=b.ROTATE}else{if(!1===o.enablePan)return;Q(g),s=b.PAN}break;default:s=b.NONE}s!==b.NONE&&o.dispatchEvent(i)}(g)}}function P(g){!1!==o.enabled&&("touch"===g.pointerType?function(g){switch(Ag(g),s){case b.TOUCH_ROTATE:if(!1===o.enableRotate)return;j(g),o.update();break;case b.TOUCH_PAN:if(!1===o.enablePan)return;D(g),o.update();break;case b.TOUCH_DOLLY_PAN:if(!1===o.enableZoom&&!1===o.enablePan)return;!function(g){o.enableZoom&&E(g),o.enablePan&&D(g)}(g),o.update();break;case b.TOUCH_DOLLY_ROTATE:if(!1===o.enableZoom&&!1===o.enableRotate)return;!function(g){o.enableZoom&&E(g),o.enableRotate&&j(g)}(g),o.update();break;default:s=b.NONE}}(g):function(g){if(!1===o.enabled)return;switch(s){case b.ROTATE:if(!1===o.enableRotate)return;!function(g){y.set(g.clientX,g.clientY),p.subVectors(y,r).multiplyScalar(o.rotateSpeed);var I=o.domElement;I&&(F(2*Math.PI*p.x/I.clientHeight),S(2*Math.PI*p.y/I.clientHeight)),r.copy(y),o.update()}(g);break;case b.DOLLY:if(!1===o.enableZoom)return;!function(g){Y.set(g.clientX,g.clientY),R.subVectors(Y,K),R.y>0?L(N()):R.y<0&&f(N()),K.copy(Y),o.update()}(g);break;case b.PAN:if(!1===o.enablePan)return;!function(g){v.set(g.clientX,g.clientY),X.subVectors(v,V).multiplyScalar(o.panSpeed),J(X.x,X.y),V.copy(v),o.update()}(g)}}(g))}function q(g){var I,C,A;(Cg(g),0===H.length)&&(null===(I=o.domElement)||void 0===I||I.releasePointerCapture(g.pointerId),null===(C=o.domElement)||void 0===C||C.ownerDocument.removeEventListener("pointermove",P),null===(A=o.domElement)||void 0===A||A.ownerDocument.removeEventListener("pointerup",q));o.dispatchEvent(n),s=b.NONE}function _(g){Cg(g)}function $(g){!1===o.enabled||!1===o.enableZoom||s!==b.NONE&&s!==b.ROTATE||(g.preventDefault(),o.dispatchEvent(i),function(g){g.deltaY<0?f(N()):g.deltaY>0&&L(N()),o.update()}(g),o.dispatchEvent(n))}function gg(g){!1!==o.enabled&&!1!==o.enablePan&&function(g){var I=!1;switch(g.code){case o.keys.UP:J(0,o.keyPanSpeed),I=!0;break;case o.keys.BOTTOM:J(0,-o.keyPanSpeed),I=!0;break;case o.keys.LEFT:J(o.keyPanSpeed,0),I=!0;break;case o.keys.RIGHT:J(-o.keyPanSpeed,0),I=!0}I&&(g.preventDefault(),o.update())}(g)}function Ig(g){!1!==o.enabled&&g.preventDefault()}function Cg(g){delete w[g.pointerId];for(var I=0;I<H.length;I++)if(H[I].pointerId==g.pointerId)return void H.splice(I,1)}function Ag(g){var I=w[g.pointerId];void 0===I&&(I=new G.Vector2,w[g.pointerId]=I),I.set(g.pageX,g.pageY)}function lg(g){var I=g.pointerId===H[0].pointerId?H[1]:H[0];return w[I.pointerId]}return void 0!==A&&l.connect(A),l.update(),l}return(0,i.Z)(C)}(G.EventDispatcher),t=["makeDefault","camera","regress","domElement","enableDamping","onChange","onStart","onEnd"],B=(0,e.forwardRef)((function(g,I){var C=g.makeDefault,i=g.camera,c=g.regress,a=g.domElement,n=g.enableDamping,b=void 0===n||n,d=g.onChange,G=g.onStart,Z=g.onEnd,B=(0,A.Z)(g,t),u=(0,o.Ky)((function(g){return g.invalidate})),m=(0,o.Ky)((function(g){return g.camera})),h=(0,o.Ky)((function(g){return g.gl})),W=(0,o.Ky)((function(g){return g.events})),r=(0,o.Ky)((function(g){return g.set})),y=(0,o.Ky)((function(g){return g.get})),p=(0,o.Ky)((function(g){return g.performance})),V=i||m,v=a||("boolean"!==typeof W.connected?W.connected:h.domElement),X=(0,e.useMemo)((function(){return new s(V)}),[V]);return(0,o.xQ)((function(){X.enabled&&X.update()})),(0,e.useEffect)((function(){var g=function(g){u(),c&&p.regress(),d&&d(g)};return X.connect(v),X.addEventListener("change",g),G&&X.addEventListener("start",G),Z&&X.addEventListener("end",Z),function(){X.removeEventListener("change",g),G&&X.removeEventListener("start",G),Z&&X.removeEventListener("end",Z),X.dispose()}}),[v,d,G,Z,c,X,u]),(0,e.useEffect)((function(){if(C){var g=y().controls;return r({controls:X}),function(){return r({controls:g})}}}),[C,X]),e.createElement("primitive",(0,l.Z)({ref:I,object:X,enableDamping:b},B))}))},2505:function(g,I,C){"use strict";C.d(I,{i:function(){return a}});var A=C(4925),l=C(7462),o=C(2791),e=C(4641),i=C(3599),c=["makeDefault"],a=o.forwardRef((function(g,I){var C=g.makeDefault,a=(0,A.Z)(g,c),n=(0,e.Ky)((function(g){return g.set})),b=(0,e.Ky)((function(g){return g.camera})),d=(0,e.Ky)((function(g){return g.size})),G=o.useRef();return o.useLayoutEffect((function(){G.current&&!a.manual&&G.current.updateProjectionMatrix()}),[d,a]),o.useLayoutEffect((function(){if(C&&G.current){var g=b;return n((function(){return{camera:G.current}})),function(){return n((function(){return{camera:g}}))}}}),[b,G,C,n]),o.createElement("orthographicCamera",(0,l.Z)({left:d.width/-2,right:d.width/2,top:d.height/2,bottom:d.height/-2,ref:(0,i.Z)([G,I])},a))}))},4956:function(g,I,C){"use strict";C.d(I,{V:function(){return W}});var A=C(1413),l=C(9439),o=C(4925),e=C(7462),i=C(2791),c=C(4164),a=C(323),n=C(4641),b=["children","eps","style","className","prepend","center","fullscreen","portal","distanceFactor","sprite","transform","occlude","onOcclude","zIndexRange","calculatePosition","as","wrapperClass","pointerEvents"],d=new a.Vector3,G=new a.Vector3,Z=new a.Vector3;function s(g,I,C){var A=d.setFromMatrixPosition(g.matrixWorld);A.project(I);var l=C.width/2,o=C.height/2;return[A.x*l+l,-A.y*o+o]}var t=function(g){return Math.abs(g)<1e-10?0:g};function B(g,I){for(var C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",A="matrix3d(",l=0;16!==l;l++)A+=t(I[l]*g.elements[l])+(15!==l?",":")");return C+A}var u,m=(u=[1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1],function(g){return B(g,u)}),h=function(g,I){return B(g,[1/(C=I),1/C,1/C,1,-1/C,-1/C,-1/C,-1,1/C,1/C,1/C,1,1,1,1,1],"translate(-50%,-50%)");var C},W=i.forwardRef((function(g,I){var C,B=g.children,u=g.eps,W=void 0===u?.001:u,r=g.style,y=g.className,p=g.prepend,V=g.center,v=g.fullscreen,X=g.portal,K=g.distanceFactor,Y=g.sprite,R=void 0!==Y&&Y,H=g.transform,w=void 0!==H&&H,N=g.occlude,F=g.onOcclude,S=g.zIndexRange,z=void 0===S?[16777271,0]:S,k=g.calculatePosition,J=void 0===k?s:k,L=g.as,f=void 0===L?"div":L,M=g.wrapperClass,Q=g.pointerEvents,x=void 0===Q?"auto":Q,U=(0,o.Z)(g,b),T=(0,n.Ky)((function(g){return g.gl})),j=(0,n.Ky)((function(g){return g.camera})),D=(0,n.Ky)((function(g){return g.scene})),E=(0,n.Ky)((function(g){return g.size})),O=(0,n.Ky)((function(g){return g.raycaster})),P=i.useState((function(){return document.createElement(f)})),q=(0,l.Z)(P,1)[0],_=i.useRef(null),$=i.useRef(0),gg=i.useRef([0,0]),Ig=i.useRef(null),Cg=i.useRef(null),Ag=null!==(C=null==X?void 0:X.current)&&void 0!==C?C:T.domElement.parentNode;i.useEffect((function(){if(_.current){if(D.updateMatrixWorld(),w)q.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{var g=J(_.current,j,E);q.style.cssText="position:absolute;top:0;left:0;transform:translate3d(".concat(g[0],"px,").concat(g[1],"px,0);transform-origin:0 0;")}return Ag&&(p?Ag.prepend(q):Ag.appendChild(q)),function(){Ag&&Ag.removeChild(q),c.unmountComponentAtNode(q)}}}),[Ag,w]),i.useLayoutEffect((function(){M&&(q.className=M)}),[M]);var lg=i.useMemo((function(){return w?{position:"absolute",top:0,left:0,width:E.width,height:E.height,transformStyle:"preserve-3d",pointerEvents:"none"}:(0,A.Z)((0,A.Z)({position:"absolute",transform:V?"translate3d(-50%,-50%,0)":"none"},v&&{top:-E.height/2,left:-E.width/2,width:E.width,height:E.height}),r)}),[r,V,v,E,w]),og=i.useMemo((function(){return{position:"absolute",pointerEvents:x}}),[x]);i.useLayoutEffect((function(){w?c.render(i.createElement("div",{ref:Ig,style:lg},i.createElement("div",{ref:Cg,style:og},i.createElement("div",{ref:I,className:y,style:r,children:B}))),q):c.render(i.createElement("div",{ref:I,style:lg,className:y,children:B}),q)}));var eg=i.useRef(!0);return(0,n.xQ)((function(){if(_.current){j.updateMatrixWorld(),_.current.updateWorldMatrix(!0,!1);var g=w?gg.current:J(_.current,j,E);if(w||Math.abs($.current-j.zoom)>W||Math.abs(gg.current[0]-g[0])>W||Math.abs(gg.current[1]-g[1])>W){var I=function(g,I){var C=d.setFromMatrixPosition(g.matrixWorld),A=G.setFromMatrixPosition(I.matrixWorld),l=C.sub(A),o=I.getWorldDirection(Z);return l.angleTo(o)>Math.PI/2}(_.current,j),C=!1;"boolean"===typeof N?!0===N&&(C=[D]):Array.isArray(N)&&(C=N.map((function(g){return g.current})));var A=eg.current;if(C){var l=function(g,I,C,A){var l=d.setFromMatrixPosition(g.matrixWorld),o=l.clone();o.project(I),C.setFromCamera(o,I);var e=C.intersectObjects(A,!0);if(e.length){var i=e[0].distance;return l.distanceTo(C.ray.origin)<i}return!0}(_.current,j,O,C);eg.current=l&&!I}else eg.current=!I;if(A!==eg.current&&(F?F(!eg.current):q.style.display=eg.current?"block":"none"),q.style.zIndex="".concat(function(g,I,C){if(I instanceof a.PerspectiveCamera||I instanceof a.OrthographicCamera){var A=d.setFromMatrixPosition(g.matrixWorld),l=G.setFromMatrixPosition(I.matrixWorld),o=A.distanceTo(l),e=(C[1]-C[0])/(I.far-I.near),i=C[1]-e*I.far;return Math.round(e*o+i)}}(_.current,j,z)),w){var o=E.width/2,e=E.height/2,i=j.projectionMatrix.elements[5]*e,c=j.isOrthographicCamera,n=j.top,b=j.left,s=j.bottom,B=j.right,u=m(j.matrixWorldInverse),r=c?"scale(".concat(i,")translate(").concat(t(-(B+b)/2),"px,").concat(t((n+s)/2),"px)"):"translateZ(".concat(i,"px)"),y=_.current.matrixWorld;R&&((y=j.matrixWorldInverse.clone().transpose().copyPosition(y).scale(_.current.scale)).elements[3]=y.elements[7]=y.elements[11]=0,y.elements[15]=1),q.style.width=E.width+"px",q.style.height=E.height+"px",q.style.perspective=c?"":"".concat(i,"px"),Ig.current&&Cg.current&&(Ig.current.style.transform="".concat(r).concat(u,"translate(").concat(o,"px,").concat(e,"px)"),Cg.current.style.transform=h(y,1/((K||10)/400)))}else{var p=void 0===K?1:function(g,I){if(I instanceof a.OrthographicCamera)return I.zoom;if(I instanceof a.PerspectiveCamera){var C=d.setFromMatrixPosition(g.matrixWorld),A=G.setFromMatrixPosition(I.matrixWorld),l=I.fov*Math.PI/180,o=C.distanceTo(A);return 1/(2*Math.tan(l/2)*o)}return 1}(_.current,j)*K;q.style.transform="translate3d(".concat(g[0],"px,").concat(g[1],"px,0) scale(").concat(p,")")}gg.current=g,$.current=j.zoom}}})),i.createElement("group",(0,e.Z)({},U,{ref:_}))}))},4641:function(g,I,C){"use strict";C.d(I,{Xz:function(){return ug},xQ:function(){return Wg},U2:function(){return pg},Ky:function(){return hg}});var A=C(5671),l=C(3144),o=C(136),e=C(9388),i=C(4942),c=C(9611),a=C(8814);function n(g,I,C){return n=(0,a.Z)()?Reflect.construct:function(g,I,C){var A=[null];A.push.apply(A,I);var l=new(Function.bind.apply(g,A));return C&&(0,c.Z)(l,C.prototype),l},n.apply(null,arguments)}var b=C(3878),d=C(9199),G=C(181),Z=C(5267);var s=C(9439),t=C(4925),B=C(3433),u=C(1413),m=C(7762),h=C(323),W=C(2791),r=C(2737),y=C(258),p=C.n(y),V=C(5296),v=C(8262),X=C.n(v),K=[];function Y(g,I,C){var A,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],e=(0,m.Z)(I);try{for(e.s();!(A=e.n()).done;){var i=A.value;if(X()(C,i.args)){if(o)return;if(i.error)throw i.error;if(i.response)return i.response;throw i.promise}}}catch(a){e.e(a)}finally{e.f()}var c={args:C,promise:g.apply(void 0,(0,B.Z)(C)).then((function(g){return c.response=null==g||g})).catch((function(g){return c.error=null!=g?g:"unknown error"})).then((function(){l>0&&setTimeout((function(){var g=I.indexOf(c);-1!==g&&I.splice(g,1)}),l)}))};if(I.push(c),!o)throw c.promise}function R(g){for(var I=arguments.length,C=new Array(I>1?I-1:0),A=1;A<I;A++)C[A-1]=arguments[A];if(void 0===C||0===C.length)g.splice(0,g.length);else{var l=g.find((function(g){return X()(C,g.args)}));if(l){var o=g.indexOf(l);-1!==o&&g.splice(o,1)}}}function H(g){for(var I=arguments.length,C=new Array(I>1?I-1:0),A=1;A<I;A++)C[A-1]=arguments[A];return Y(g,K,C,H.lifespan)}H.lifespan=0,H.clear=function(){for(var g=arguments.length,I=new Array(g),C=0;C<g;C++)I[C]=arguments[C];return R.apply(void 0,[K].concat(I))},H.preload=function(g){for(var I=arguments.length,C=new Array(I>1?I-1:0),A=1;A<I;A++)C[A-1]=arguments[A];Y(g,K,C,H.lifespan,!0)},H.peek=function(){for(var g=arguments.length,I=new Array(g),C=0;C<g;C++)I[C]=arguments[C];var A;return null==(A=K.find((function(g){return X()(I,g.args)})))?void 0:A.response};var w=C(3599),N=C(7494),F=C.n(N);function S(g){var I=void 0===g?{debounce:0,scroll:!1,offsetSize:!1}:g,C=I.debounce,o=I.scroll,e=I.polyfill,i=I.offsetSize,c=e||("undefined"===typeof window?(0,l.Z)((function g(){(0,A.Z)(this,g)})):window.ResizeObserver);if(!c)throw new Error("This browser does not support ResizeObserver out of the box. See: https://github.com/react-spring/react-use-measure/#resize-observer-polyfills");var a=(0,W.useState)({left:0,top:0,width:0,height:0,bottom:0,right:0,x:0,y:0}),n=(0,s.Z)(a,2),b=n[0],d=n[1],G=(0,W.useRef)({element:null,scrollContainers:null,resizeObserver:null,lastBounds:b}),Z=C?"number"===typeof C?C:C.scroll:null,t=C?"number"===typeof C?C:C.resize:null,B=(0,W.useRef)(!1);(0,W.useEffect)((function(){return B.current=!0,function(){B.current=!1}}));var u=(0,W.useMemo)((function(){var g=function(){if(G.current.element){var g=G.current.element.getBoundingClientRect(),I={left:g.left,top:g.top,width:g.width,height:g.height,bottom:g.bottom,right:g.right,x:g.x,y:g.y};G.current.element instanceof HTMLElement&&i&&(I.height=G.current.element.offsetHeight,I.width=G.current.element.offsetWidth),Object.freeze(I),B.current&&!J(G.current.lastBounds,I)&&d(G.current.lastBounds=I)}};return[g,t?F()(g,t):g,Z?F()(g,Z):g]}),[d,i,Z,t]),m=(0,s.Z)(u,3),h=m[0],r=m[1],y=m[2];function p(){G.current.scrollContainers&&(G.current.scrollContainers.forEach((function(g){return g.removeEventListener("scroll",y,!0)})),G.current.scrollContainers=null),G.current.resizeObserver&&(G.current.resizeObserver.disconnect(),G.current.resizeObserver=null)}function V(){G.current.element&&(G.current.resizeObserver=new c(y),G.current.resizeObserver.observe(G.current.element),o&&G.current.scrollContainers&&G.current.scrollContainers.forEach((function(g){return g.addEventListener("scroll",y,{capture:!0,passive:!0})})))}var v,X,K;return v=y,X=Boolean(o),(0,W.useEffect)((function(){if(X){var g=v;return window.addEventListener("scroll",g,{capture:!0,passive:!0}),function(){window.removeEventListener("scroll",g,!0)}}}),[v,X]),K=r,(0,W.useEffect)((function(){var g=K;return window.addEventListener("resize",g),function(){window.removeEventListener("resize",g)}}),[K]),(0,W.useEffect)((function(){p(),V()}),[o,y,r]),(0,W.useEffect)((function(){return p}),[]),[function(g){g&&g!==G.current.element&&(p(),G.current.element=g,G.current.scrollContainers=z(g),V())},b,h]}function z(g){var I=[];if(!g||g===document.body)return I;var C=window.getComputedStyle(g);return[C.overflow,C.overflowX,C.overflowY].some((function(g){return"auto"===g||"scroll"===g}))&&I.push(g),[].concat(I,(0,B.Z)(z(g.parentElement)))}var k=["x","y","top","bottom","left","right","width","height"],J=function(g,I){return k.every((function(C){return g[C]===I[C]}))},L=["children","key","ref"],f=["children","key","ref"],M=["args"],Q=["args","children"],x=["args","children"],U=["params"],T=["children","fallback","tabIndex","resize","id","style","className","events"],j=["gl","size","mode","events","onCreated"],D={obj:function(g){return g===Object(g)&&!D.arr(g)&&"function"!==typeof g},fun:function(g){return"function"===typeof g},str:function(g){return"string"===typeof g},num:function(g){return"number"===typeof g},und:function(g){return void 0===g},arr:function(g){return Array.isArray(g)},equ:function(g,I){if(typeof g!==typeof I||!!g!==!!I)return!1;if(D.str(g)||D.num(g)||D.obj(g))return g===I;if(D.arr(g)&&g==I)return!0;var C;for(C in g)if(!(C in I))return!1;for(C in I)if(g[C]!==I[C])return!1;return!D.und(C)||g===I}};function E(g){return(g.eventObject||g.object).uuid+"/"+g.index+g.instanceId}function O(g,I,C,A){var l=C.get(I);l&&(C.delete(I),0===C.size&&(g.delete(A),l.target.releasePointerCapture(A)))}function P(g){var I=new h.Vector3;function C(g){return g.filter((function(g){return["Move","Over","Enter","Out","Leave"].some((function(I){var C;return null==(C=g.__r3f)?void 0:C.handlers["onPointer"+I]}))}))}function A(I){var C=g.getState().internal;Array.from(C.hovered.values()).forEach((function(g){if(!I.length||!I.find((function(I){return I.object===g.object&&I.index===g.index&&I.instanceId===g.instanceId}))){var A=g.eventObject.__r3f,l=null==A?void 0:A.handlers;if(C.hovered.delete(E(g)),null!=A&&A.eventCount){var o=(0,u.Z)((0,u.Z)({},g),{},{intersections:I||[]});null==l.onPointerOut||l.onPointerOut(o),null==l.onPointerLeave||l.onPointerLeave(o)}}}))}function l(g,I){I.forEach((function(I){var C;return null==(C=I.__r3f)||null==C.handlers.onPointerMissed?void 0:C.handlers.onPointerMissed(g)}))}return{handlePointer:function(o){switch(o){case"onPointerLeave":case"onPointerCancel":return function(){return A([])};case"onLostPointerCapture":return function(I){var C=g.getState().internal;"pointerId"in I&&!C.capturedMap.has(I.pointerId)&&(C.capturedMap.delete(I.pointerId),A([]))}}return function(e){var i=g.getState(),c=i.onPointerMissed,a=i.internal;!function(I){var C,A,l,o,e=g.getState(),i=e.raycaster,c=e.mouse,a=e.camera,n=e.size,b=null==i.computeOffsets?void 0:i.computeOffsets(I,e),d=null!=(C=null==b?void 0:b.offsetX)?C:I.offsetX,G=null!=(A=null==b?void 0:b.offsetY)?A:I.offsetY,Z=null!=(l=null==b?void 0:b.width)?l:n.width,s=null!=(o=null==b?void 0:b.height)?o:n.height;c.set(d/Z*2-1,-G/s*2+1),i.setFromCamera(c,a)}(e),a.lastEvent.current=e;var n="onPointerMove"===o,b="onClick"===o||"onContextMenu"===o||"onDoubleClick"===o,d=function(I,C){var A=g.getState().internal;if("pointerId"in C&&A.capturedMap.has(C.pointerId)){var l,o=(0,m.Z)(A.capturedMap.get(C.pointerId).values());try{for(o.s();!(l=o.n()).done;){var e=l.value;I.push(e.intersection)}}catch(i){o.e(i)}finally{o.f()}}return I}(function(I){var C=g.getState(),A=C.raycaster,l=C.internal;if(!A.enabled)return[];var o=new Set,e=[],i=I?I(l.interaction):l.interaction,c=A.intersectObjects(i,!0).filter((function(g){var I=E(g);return!o.has(I)&&(o.add(I),!0)}));A.filter&&(c=A.filter(c,C));var a,n=(0,m.Z)(c);try{for(n.s();!(a=n.n()).done;)for(var b=a.value,d=b.object;d;){var G;null!=(G=d.__r3f)&&G.eventCount&&e.push((0,u.Z)((0,u.Z)({},b),{},{eventObject:d})),d=d.parent}}catch(Z){n.e(Z)}finally{n.f()}return e}(n?C:void 0),e),G=b?function(I){var C=g.getState().internal,A=I.offsetX-C.initialClick[0],l=I.offsetY-C.initialClick[1];return Math.round(Math.sqrt(A*A+l*l))}(e):0;"onPointerDown"===o&&(a.initialClick=[e.offsetX,e.offsetY],a.initialHits=d.map((function(g){return g.eventObject}))),b&&!d.length&&G<=2&&(l(e,a.interaction),c&&c(e)),n&&A(d),function(C,l,o,e){var i=g.getState(),c=i.raycaster,a=i.mouse,n=i.camera,b=i.internal;C.length&&function(){var g,i=I.set(a.x,a.y,0).unproject(n),d={stopped:!1},G=(0,m.Z)(C);try{var Z=function(){var I=g.value,G=function(g){var C,A;return null!=(C=null==(A=b.capturedMap.get(g))?void 0:A.has(I.eventObject))&&C},Z=function(g){var C={intersection:I,target:l.target};b.capturedMap.has(g)?b.capturedMap.get(g).set(I.eventObject,C):b.capturedMap.set(g,new Map([[I.eventObject,C]])),l.target.setPointerCapture(g)},s=function(g){var C=b.capturedMap.get(g);C&&O(b.capturedMap,I.eventObject,C,g)},t={};for(var m in l){var h=l[m];"function"!==typeof h&&(t[m]=h)}var W=(0,u.Z)((0,u.Z)((0,u.Z)({},I),t),{},{spaceX:a.x,spaceY:a.y,intersections:C,stopped:d.stopped,delta:o,unprojectedPoint:i,ray:c.ray,camera:n,stopPropagation:function(){var g="pointerId"in l&&b.capturedMap.get(l.pointerId);if((!g||g.has(I.eventObject))&&(W.stopped=d.stopped=!0,b.hovered.size&&Array.from(b.hovered.values()).find((function(g){return g.eventObject===I.eventObject})))){var o=C.slice(0,C.indexOf(I));A([].concat((0,B.Z)(o),[I]))}},target:{hasPointerCapture:G,setPointerCapture:Z,releasePointerCapture:s},currentTarget:{hasPointerCapture:G,setPointerCapture:Z,releasePointerCapture:s},sourceEvent:l,nativeEvent:l});if(e(W),!0===d.stopped)return"break"};for(G.s();!(g=G.n()).done&&"break"!==Z(););}catch(s){G.e(s)}finally{G.f()}}()}(d,e,G,(function(g){var I=g.eventObject,C=I.__r3f,A=null==C?void 0:C.handlers;if(null!=C&&C.eventCount)if(n){if(A.onPointerOver||A.onPointerEnter||A.onPointerOut||A.onPointerLeave){var i=E(g),c=a.hovered.get(i);c?c.stopped&&g.stopPropagation():(a.hovered.set(i,g),null==A.onPointerOver||A.onPointerOver(g),null==A.onPointerEnter||A.onPointerEnter(g))}null==A.onPointerMove||A.onPointerMove(g)}else{var d=A[o];d?b&&!a.initialHits.includes(I)||(l(e,a.interaction.filter((function(g){return!a.initialHits.includes(g)}))),d(g)):b&&a.initialHits.includes(I)&&l(e,a.interaction.filter((function(g){return!a.initialHits.includes(g)})))}}))}}}}var q=function(g){return g&&!!g.getState},_=function(g,I){var C,A;return{root:q(g)?g:null!=(C=null==(A=g.__r3f)?void 0:A.root)?C:I.__r3f.root,container:q(g)?g.getState().scene:g}},$="__default",gg={},Ig={};function Cg(g,I){return!(!D.arr(g)||!D.equ(g,I))||g===I}function Ag(g,I){var C=g;return(null!=I&&I.primitive||!C.__r3f)&&(C.__r3f=(0,u.Z)({root:null,memoizedProps:{},eventCount:0,handlers:{},objects:[],parent:null},I)),g}var lg=function(g){return g&&g.isOrthographicCamera};function og(g){return Array.isArray(g)?Math.min(Math.max(g[0],window.devicePixelRatio),g[1]):g}var eg,ig=W.createContext(null),cg=function(g,I,C,A){var l=A.gl,o=A.size,e=A.shadows,i=void 0!==e&&e,c=A.linear,a=void 0!==c&&c,n=A.flat,b=void 0!==n&&n,d=A.vr,G=void 0!==d&&d,Z=A.orthographic,s=void 0!==Z&&Z,m=A.frameloop,y=void 0===m?"always":m,p=A.dpr,V=void 0===p?1:p,v=A.performance,X=A.clock,K=void 0===X?new h.Clock:X,Y=A.raycaster,R=A.camera,H=A.onPointerMissed;i&&(l.shadowMap.enabled=!0,"object"===typeof i?Object.assign(l.shadowMap,i):l.shadowMap.type=h.PCFSoftShadowMap),a&&(l.outputEncoding=h.LinearEncoding),b&&(l.toneMapping=h.NoToneMapping),"never"===y&&(K.stop(),K.elapsedTime=0);var w=(0,r.Z)((function(o,e){var i=new h.Raycaster,c=Y||{},n=c.params,d=(0,t.Z)(c,U);g(i,(0,u.Z)((0,u.Z)({enabled:!0},d),{},{params:(0,u.Z)((0,u.Z)({},i.params),n)}));var Z=R instanceof h.Camera,m=Z?R:s?new h.OrthographicCamera(0,0,0,0,.1,1e3):new h.PerspectiveCamera(75,0,.1,1e3);Z||(m.position.z=5,R&&g(m,R),null!=R&&R.rotation||m.lookAt(0,0,0));var r=og(V),p=new h.Vector3,X=new h.Vector3,w=new h.Vector3;function N(){var g=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e().camera,I=arguments.length>1&&void 0!==arguments[1]?arguments[1]:X,C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e().size,A=C.width,l=C.height,o=A/l;I instanceof h.Vector3?w.copy(I):w.set.apply(w,(0,B.Z)(I));var i=g.getWorldPosition(p).distanceTo(w);if(lg(g))return{width:A/g.zoom,height:l/g.zoom,factor:1,distance:i,aspect:o};var c=g.fov*Math.PI/180,a=2*Math.tan(c/2)*i,n=a*(A/l);return{width:n,height:a,factor:A/n,distance:i,aspect:o}}var F=void 0,S=function(g){return o((function(I){return{performance:(0,u.Z)((0,u.Z)({},I.performance),{},{current:g})}}))};return{gl:l,set:o,get:e,invalidate:function(){return I(e())},advance:function(g,I){return C(g,I,e())},linear:a,flat:b,scene:Ag(new h.Scene),camera:m,controls:null,raycaster:i,clock:K,mouse:new h.Vector2,vr:G,frameloop:y,onPointerMissed:H,performance:(0,u.Z)((0,u.Z)({current:1,min:.5,max:1,debounce:200},v),{},{regress:function(){var g=e();F&&clearTimeout(F),g.performance.current!==g.performance.min&&S(g.performance.min),F=setTimeout((function(){return S(e().performance.max)}),g.performance.debounce)}}),size:{width:0,height:0},viewport:{initialDpr:r,dpr:r,width:0,height:0,aspect:0,distance:0,factor:0,getCurrentViewport:N},setSize:function(g,I){var C={width:g,height:I};o((function(g){return{size:C,viewport:(0,u.Z)((0,u.Z)({},g.viewport),N(m,X,C))}}))},setDpr:function(g){return o((function(I){return{viewport:(0,u.Z)((0,u.Z)({},I.viewport),{},{dpr:og(g)})}}))},setFrameloop:function(){var g=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"always";return o((function(){return{frameloop:g}}))},events:{connected:!1},internal:{active:!1,priority:0,frames:0,lastProps:A,lastEvent:W.createRef(),interaction:[],hovered:new Map,subscribers:[],initialClick:[0,0],initialHits:[],capturedMap:new Map,subscribe:function(g){var I=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return o((function(C){var A=C.internal;return{internal:(0,u.Z)((0,u.Z)({},A),{},{priority:A.priority+(I>0?1:0),subscribers:[].concat((0,B.Z)(A.subscribers),[{ref:g,priority:I}]).sort((function(g,I){return g.priority-I.priority}))})}})),function(){o((function(C){var A=C.internal;return{internal:(0,u.Z)((0,u.Z)({},A),{},{priority:A.priority-(I>0?1:0),subscribers:A.subscribers.filter((function(I){return I.ref!==g}))})}}))}}}}})),N=w.getState(),F=N.size,S=N.viewport.dpr;return w.subscribe((function(){var g=w.getState(),I=g.camera,C=g.size,A=g.viewport,o=g.internal;C===F&&A.dpr===S||(I.manual||o.lastProps.camera instanceof h.Camera||(lg(I)?(I.left=C.width/-2,I.right=C.width/2,I.top=C.height/2,I.bottom=C.height/-2):I.aspect=C.width/C.height,I.updateProjectionMatrix(),I.updateMatrixWorld()),l.setPixelRatio(A.dpr),l.setSize(C.width,C.height),F=C,S=A.dpr)})),o&&N.setSize(o.width,o.height),w.subscribe((function(g){return I(g)})),w};var ag=[],ng=[],bg=[];function dg(g,I){for(eg=0;eg<g.length;eg++)g[eg](I)}function Gg(g,I){var C=I.clock.getDelta();for("never"===I.frameloop&&"number"===typeof g&&(C=g-I.clock.elapsedTime,I.clock.oldTime=I.clock.elapsedTime,I.clock.elapsedTime=g),eg=0;eg<I.internal.subscribers.length;eg++)I.internal.subscribers[eg].ref.current(I,C);return!I.internal.priority&&I.gl.render&&I.gl.render(I.scene,I.camera),I.internal.frames=Math.max(0,I.internal.frames-1),"always"===I.frameloop?1:I.internal.frames}function Zg(g){var I=P(g).handlePointer,C={onClick:["click",!1],onContextMenu:["contextmenu",!1],onDoubleClick:["dblclick",!1],onWheel:["wheel",!0],onPointerDown:["pointerdown",!0],onPointerUp:["pointerup",!0],onPointerLeave:["pointerleave",!0],onPointerMove:["pointermove",!0],onPointerCancel:["pointercancel",!0],onLostPointerCapture:["lostpointercapture",!0]};return{connected:!1,handlers:Object.keys(C).reduce((function(g,C){return(0,u.Z)((0,u.Z)({},g),{},(0,i.Z)({},C,I(C)))}),{}),connect:function(I){var A,l=g.getState(),o=l.set,e=l.events;null==e.disconnect||e.disconnect(),o((function(g){return{events:(0,u.Z)((0,u.Z)({},g.events),{},{connected:I})}})),Object.entries(null!=(A=null==e?void 0:e.handlers)?A:[]).forEach((function(g){var A=(0,s.Z)(g,2),l=A[0],o=A[1],e=(0,s.Z)(C[l],2),i=e[0],c=e[1];I.addEventListener(i,o,{passive:c})}))},disconnect:function(){var I,A=g.getState(),l=A.set,o=A.events;o.connected&&(Object.entries(null!=(I=o.handlers)?I:[]).forEach((function(g){var I=(0,s.Z)(g,2),A=I[0],l=I[1];if(o&&o.connected instanceof HTMLElement){var e=(0,s.Z)(C[A],1)[0];o.connected.removeEventListener(e,l)}})),l((function(g){return{events:(0,u.Z)((0,u.Z)({},g.events),{},{connected:!1})}})))}}}var sg="undefined"!==typeof window?W.useLayoutEffect:W.useEffect;function tg(g){var I=g.set;return sg((function(){return I(new Promise((function(){return null}))),function(){return I(!1)}}),[]),null}var Bg=function(g){(0,o.Z)(C,g);var I=(0,e.Z)(C);function C(){var g;(0,A.Z)(this,C);for(var l=arguments.length,o=new Array(l),e=0;e<l;e++)o[e]=arguments[e];return(g=I.call.apply(I,[this].concat(o))).state={error:!1},g}return(0,l.Z)(C,[{key:"componentDidCatch",value:function(g){this.props.set(g)}},{key:"render",value:function(){return this.state.error?null:this.props.children}}]),C}(W.Component);Bg.getDerivedStateFromError=function(){return{error:!0}};var ug=W.forwardRef((function(g,I){var C=g.children,A=g.fallback,l=g.tabIndex,o=g.resize,e=g.id,i=g.style,c=g.className,a=g.events,n=(0,t.Z)(g,T),b=S((0,u.Z)({scroll:!0,debounce:{scroll:50,resize:0}},o)),d=(0,s.Z)(b,2),G=d[0],Z=d[1],B=Z.width,m=Z.height,h=W.useRef(null),r=W.useState(!1),y=(0,s.Z)(r,2),p=y[0],V=y[1],v=W.useState(!1),X=(0,s.Z)(v,2),K=X[0],Y=X[1];if(p)throw p;if(K)throw K;return sg((function(){B>0&&m>0&&function(g,I){var C,A,l,o,e,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},c=i.gl,a=i.size,n=i.mode,b=void 0===n?vg[1]:n,d=i.events,G=i.onCreated,Z=(0,t.Z)(i,j);a||(a={width:null!=(A=null==(l=I.parentElement)?void 0:l.clientWidth)?A:0,height:null!=(o=null==(e=I.parentElement)?void 0:e.clientHeight)?o:0});var s=Vg.get(I),B=null==s?void 0:s.fiber,m=null==s?void 0:s.store,h=null==(C=m)?void 0:C.getState();if(B&&h){void 0===Z.dpr||D.equ(h.viewport.dpr,og(Z.dpr))||h.setDpr(Z.dpr),h.size.width===a.width&&h.size.height===a.height||h.setSize(a.width,a.height),h.frameloop!==Z.frameloop&&h.setFrameloop(Z.frameloop),Z.linear!==h.internal.lastProps.linear&&(Sg(I),B=void 0)}if(!B){var r=Ng(c,I);Z.vr&&(r.xr.enabled=!0,r.setAnimationLoop((function(g){return Yg(g,!0)})));var y=(m=cg(wg,Kg,Yg,(0,u.Z)({gl:r,size:a},Z))).getState();B=Hg.createContainer(m,vg.indexOf(b),!1,null),Vg.set(I,{fiber:B,store:m}),d&&y.set({events:d(m)})}if(m&&B)return Hg.updateContainer(W.createElement(Fg,{store:m,element:g,onCreated:G,target:I}),B,null,(function(){})),m;throw"Error creating root!"}(W.createElement(Bg,{set:Y},W.createElement(W.Suspense,{fallback:W.createElement(tg,{set:V})},C)),h.current,(0,u.Z)((0,u.Z)({},n),{},{size:{width:B,height:m},events:a||Zg}))}),[B,m,C]),sg((function(){var g=h.current;return function(){return Sg(g)}}),[]),W.createElement("div",{ref:G,id:e,className:c,tabIndex:l,style:(0,u.Z)({position:"relative",width:"100%",height:"100%",overflow:"hidden"},i)},W.createElement("canvas",{ref:(0,w.Z)([h,I]),style:{display:"block"}},A))}));function mg(){var g=W.useContext(ig);if(!g)throw"R3F hooks can only be used within the Canvas component!";return g}function hg(){var g=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(g){return g},I=arguments.length>1?arguments[1]:void 0;return mg()(g,I)}function Wg(g){var I=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,C=mg().getState().internal.subscribe,A=W.useRef(g);return W.useLayoutEffect((function(){A.current=g}),[g]),W.useLayoutEffect((function(){return C(A,I)}),[I,C]),null}function rg(g){var I={nodes:{},materials:{}};return g&&g.traverse((function(g){g.name&&(I.nodes[g.name]=g),g.material&&!I.materials[g.material.name]&&(I.materials[g.material.name]=g.material)})),I}function yg(g,I){return function(C){var A=new C;g&&g(A);for(var l=arguments.length,o=new Array(l>1?l-1:0),e=1;e<l;e++)o[e-1]=arguments[e];return Promise.all(o.map((function(g){return new Promise((function(C,l){return A.load(g,(function(g){g.scene&&Object.assign(g,rg(g.scene)),C(g)}),I,(function(I){return l("Could not load ".concat(g,": ").concat(I.message))}))}))})))}}function pg(g,I,C,A){var l=Array.isArray(I)?I:[I],o=H.apply(void 0,[yg(C,A),g].concat((0,B.Z)(l)));return Array.isArray(I)?o:o[0]}pg.preload=function(g,I,C){var A=Array.isArray(I)?I:[I];return H.preload.apply(H,[yg(C),g].concat((0,B.Z)(A)))},pg.clear=function(g,I){var C=Array.isArray(I)?I:[I];return H.clear.apply(H,[g].concat((0,B.Z)(C)))};var Vg=new Map,vg=["legacy","blocking","concurrent"],Xg=function(g){var I,C=!1;function A(l){if(C=!0,I=0,dg(ag,l),g.forEach((function(g){var C=g.store.getState();C.internal.active&&("always"===C.frameloop||C.internal.frames>0)&&(I+=Gg(l,C))})),dg(ng,l),I>0)return requestAnimationFrame(A);dg(bg,l),C=!1}return{loop:A,invalidate:function I(l){if(!l)return g.forEach((function(g){return I(g.store.getState())}));!l.vr&&l.internal.active&&"never"!==l.frameloop&&(l.internal.frames=Math.min(60,l.internal.frames+1),C||(C=!0,requestAnimationFrame(A)))},advance:function(I){var C=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],A=arguments.length>2?arguments[2]:void 0;C&&dg(ag,I),A?Gg(I,A):g.forEach((function(g){return Gg(I,g.store.getState())})),C&&dg(ng,I)}}}(Vg),Kg=Xg.invalidate,Yg=Xg.advance,Rg=function(g){function I(g,I){I.children,I.key,I.ref;var C,A=(0,t.Z)(I,L),l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=(l.children,l.key,l.ref,(0,t.Z)(l,f)),e=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=null!=(C=null==g?void 0:g.__r3f)?C:{},c=Object.entries(A),a=[];if(e)for(var n=Object.keys(o),b=0;b<n.length;b++)A.hasOwnProperty(n[b])||c.unshift([n[b],$+"remove"]);c.forEach((function(I){var C,A=(0,s.Z)(I,2),l=A[0],e=A[1];if((null==(C=g.__r3f)||!C.primitive||"object"!==l)&&!Cg(e,o[l])){if(/^on(Pointer|Click|DoubleClick|ContextMenu|Wheel)/.test(l))return a.push([l,e,!0,[]]);var i=[];l.includes("-")&&(i=l.split("-")),a.push([l,e,!1,i])}}));var d=(0,u.Z)({},A);return i.memoizedProps&&i.memoizedProps.args&&(d.args=i.memoizedProps.args),i.memoizedProps&&i.memoizedProps.attach&&(d.attach=i.memoizedProps.attach),{accumulative:e,memoized:d,changes:a}}function C(g,C){var o,e,i,c,a=null!=(o=null==g?void 0:g.__r3f)?o:{},n=a.root,t=null!=(e=null==n||null==n.getState?void 0:n.getState())?e:{},u=(c=C)&&c.memoized&&c.changes?C:I(g,C),m=u.memoized,W=u.changes,r=a.eventCount;if(g.__r3f&&(g.__r3f.memoizedProps=m),W.forEach((function(I){var C,l,o=(0,s.Z)(I,4),e=o[0],i=o[1],c=o[2],n=o[3],u=g,W=u[e];if(n.length&&(W=n.reduce((function(g,I){return g[I]}),g),!W||!W.set)){var r=n.reverse(),y=(l=r,(0,b.Z)(l)||(0,d.Z)(l)||(0,G.Z)(l)||(0,Z.Z)()),p=y[0];u=y.slice(1).reverse().reduce((function(g,I){return g[I]}),g),e=p}if(i===$+"remove")if(W&&W.constructor)i=new W.constructor(m.args);else if(u.constructor){var V=new u.constructor(u.__r3f.memoizedProps.args);i=V[W],V.dispose&&V.dispose()}else i=0;var v=(null==t||null==(C=t.gl)?void 0:C.outputEncoding)===h.LinearEncoding;if(c)i?a.handlers[e]=i:delete a.handlers[e],a.eventCount=Object.keys(a.handlers).length;else if(W&&W.set&&(W.copy||W instanceof h.Layers)){var X;if(Array.isArray(i))W.fromArray?W.fromArray(i):(X=W).set.apply(X,(0,B.Z)(i));else if(W.copy&&i&&i.constructor&&W.constructor.name===i.constructor.name)W.copy(i);else if(void 0!==i){var K=W instanceof h.Color;!K&&W.setScalar?W.setScalar(i):W instanceof h.Layers&&i instanceof h.Layers?W.mask=i.mask:W.set(i),!v&&K&&W.convertSRGBToLinear()}}else u[e]=i,!v&&u[e]instanceof h.Texture&&(u[e].encoding=h.sRGBEncoding);A(g)})),a.parent&&t.internal&&g.raycast&&r!==a.eventCount){var y=t.internal.interaction.indexOf(g);y>-1&&t.internal.interaction.splice(y,1),a.eventCount&&t.internal.interaction.push(g)}return W.length&&null!=(i=g.__r3f)&&i.parent&&l(g),g}function A(g){var I,C,A=null==(I=g.__r3f)||null==(C=I.root)||null==C.getState?void 0:C.getState();A&&0===A.internal.frames&&A.invalidate()}function l(g){null==g.onUpdate||g.onUpdate(g)}function o(g,I,A,l,o){var e,i=I.args,c=void 0===i?[]:i,a=(0,t.Z)(I,M),b="".concat(g[0].toUpperCase()).concat(g.slice(1));if(!q(A)&&o){A=function g(I){return I.return?g(I.return):I.stateNode&&I.stateNode.containerInfo}(o)}if(!A||!q(A))throw"No valid root for ".concat(b,"!");if("primitive"===g){if(void 0===a.object)throw"Primitives without 'object' are invalid!";e=Ag(a.object,{root:A,primitive:!0})}else{var d=Ig[b]||h[b];if(!d)throw"".concat(b," is not part of the THREE namespace! Did you forget to extend? See: https://github.com/pmndrs/react-three-fiber/blob/master/markdown/api.md#using-3rd-party-objects-declaratively");if(!Array.isArray(c))throw"The args prop must be an array!";e=Ag(n(d,(0,B.Z)(c)),{root:A,memoizedProps:{args:0===c.length?null:c}})}return"attachFns"in a||(b.endsWith("Geometry")?a=(0,u.Z)({attach:"geometry"},a):b.endsWith("Material")&&(a=(0,u.Z)({attach:"material"},a))),C(e,a),e}function e(g,I){var C=!1;if(I){if(I.attachArray)D.arr(g[I.attachArray])||(g[I.attachArray]=[]),g[I.attachArray].push(I);else if(I.attachObject)D.obj(g[I.attachObject[0]])||(g[I.attachObject[0]]={}),g[I.attachObject[0]][I.attachObject[1]]=I;else if(I.attach&&!D.fun(I.attach))g[I.attach]=I;else if(D.arr(I.attachFns)){var o=(0,s.Z)(I.attachFns,1)[0];D.str(o)&&D.fun(g[o])?g[o](I):D.fun(o)&&o(I,g)}else I.isObject3D&&g.isObject3D&&(g.add(I),C=!0);C||g.__r3f.objects.push(I),I.__r3f||Ag(I,{}),I.__r3f.parent=g,l(I),A(I)}}function i(g,I,C){var o=!1;if(I){if(I.attachArray){var i=g[I.attachArray];D.arr(i)||(g[I.attachArray]=[]),i.splice(i.indexOf(C),0,I)}else{if(I.attachObject||I.attach&&!D.fun(I.attach))return e(g,I);if(I.isObject3D&&g.isObject3D){I.parent=g,I.dispatchEvent({type:"added"});var c=g.children.filter((function(g){return g!==I})),a=c.indexOf(C);g.children=[].concat((0,B.Z)(c.slice(0,a)),[I],(0,B.Z)(c.slice(a))),o=!0}}o||g.__r3f.objects.push(I),I.__r3f||Ag(I,{}),I.__r3f.parent=g,l(I),A(I)}}function c(g,I){var C=arguments.length>2&&void 0!==arguments[2]&&arguments[2];g&&(0,B.Z)(g).forEach((function(g){return a(I,g,C)}))}function a(g,I,C){if(I){var l,o;if(I.__r3f&&(I.__r3f.parent=null),null!=(l=g.__r3f)&&l.objects&&(g.__r3f.objects=g.__r3f.objects.filter((function(g){return g!==I}))),I.attachArray)g[I.attachArray]=g[I.attachArray].filter((function(g){return g!==I}));else if(I.attachObject)delete g[I.attachObject[0]][I.attachObject[1]];else if(I.attach&&!D.fun(I.attach)&&g[I.attach]===I)g[I.attach]=null;else if(D.arr(I.attachFns)){var e=(0,s.Z)(I.attachFns,2)[1];D.str(e)&&D.fun(g[e])?g[e](I):D.fun(e)&&e(I,g)}else if(I.isObject3D&&g.isObject3D){var i;g.remove(I),null!=(i=I.__r3f)&&i.root&&function(g,I){var C=g.getState().internal;C.interaction=C.interaction.filter((function(g){return g!==I})),C.initialHits=C.initialHits.filter((function(g){return g!==I})),C.hovered.forEach((function(g,A){g.eventObject!==I&&g.object!==I||C.hovered.delete(A)})),C.capturedMap.forEach((function(g,A){O(C.capturedMap,I,g,A)}))}(I.__r3f.root,I)}var a,n=null==(o=I.__r3f)?void 0:o.primitive,b=void 0===C?null!==I.dispose&&!n:C;if(!n)c(null==(a=I.__r3f)?void 0:a.objects,I,b),c(I.children,I,b);I.__r3f&&(delete I.__r3f.root,delete I.__r3f.objects,delete I.__r3f.handlers,delete I.__r3f.memoizedProps,n||delete I.__r3f),b&&I.dispose&&"Scene"!==I.type&&(0,V.unstable_runWithPriority)(V.unstable_IdlePriority,(function(){try{I.dispose()}catch(g){}})),A(g)}}return{reconciler:p()({now:V.unstable_now,createInstance:o,removeChild:a,appendChild:e,appendInitialChild:e,insertBefore:i,warnsIfNotActing:!0,supportsMutation:!0,isPrimaryRenderer:!1,scheduleTimeout:D.fun(setTimeout)?setTimeout:void 0,cancelTimeout:D.fun(clearTimeout)?clearTimeout:void 0,setTimeout:D.fun(setTimeout)?setTimeout:void 0,clearTimeout:D.fun(clearTimeout)?clearTimeout:void 0,noTimeout:-1,appendChildToContainer:function(g,I){var C=_(g,I),A=C.container,l=C.root;A.__r3f.root=l,e(A,I)},removeChildFromContainer:function(g,I){return a(_(g,I).container,I)},insertInContainerBefore:function(g,I,C){return i(_(g,I).container,I,C)},prepareUpdate:function(g,C,A,l){if(g.__r3f.primitive&&l.object&&l.object!==g)return[!0];var o=l.args,i=void 0===o?[]:o,c=(l.children,(0,t.Z)(l,Q)),a=A.args,n=void 0===a?[]:a,b=(A.children,(0,t.Z)(A,x));if(!Array.isArray(i))throw"The args prop must be an array!";if(i.some((function(g,I){return g!==n[I]})))return[!0];var d=I(g,c,b,!0);if(d.changes.length)return[!1,d];if(g.attach&&"function"!==typeof g.attach){var G=g.__r3f.parent;G&&G[g.attach]!==g&&e(G,g)}return null},commitUpdate:function(g,I,A,l,i,c){var n=(0,s.Z)(I,2),b=n[0],d=n[1];b?function(g,I,C,A){var l,i=null==(l=g.__r3f)?void 0:l.parent;if(i){var c=o(I,C,g.__r3f.root);"primitive"!==I&&g.children&&(g.children.forEach((function(g){return e(c,g)})),g.children=[]),g.__r3f.objects.forEach((function(g){return e(c,g)})),g.__r3f.objects=[],a(i,g),e(i,c),c.raycast&&c.__r3f.eventCount&&c.__r3f.root.getState().internal.interaction.push(c),[A,A.alternate].forEach((function(g){null!==g&&(g.stateNode=c,g.ref&&("function"===typeof g.ref?g.ref(c):g.ref.current=c))}))}}(g,A,i,c):C(g,d)},hideInstance:function(g){g.isObject3D&&(g.visible=!1,A(g))},unhideInstance:function(g,I){(g.isObject3D&&null==I.visible||I.visible)&&(g.visible=!0,A(g))},hideTextInstance:function(){throw new Error("Text is not allowed in the R3F tree.")},getPublicInstance:function(g){return g},getRootHostContext:function(g){return gg},getChildHostContext:function(g){return g},createTextInstance:function(){},finalizeInitialChildren:function(g){var I;return!!(null!=(I=null==g?void 0:g.__r3f)?I:{}).handlers},commitMount:function(g){var I,C=null!=(I=null==g?void 0:g.__r3f)?I:{};g.raycast&&C.handlers&&C.eventCount&&g.__r3f.root.getState().internal.interaction.push(g)},shouldDeprioritizeSubtree:function(){return!1},prepareForCommit:function(){return null},preparePortalMount:function(g){Ag(g)},resetAfterCommit:function(){},shouldSetTextContent:function(){return!1},clearContainer:function(){return!1}}),applyProps:C}}(),Hg=Rg.reconciler,wg=Rg.applyProps,Ng=function(g,I){var C,A="function"===typeof g?g(I):g;if(null!=(C=A)&&C.render)return A;var l=new h.WebGLRenderer((0,u.Z)({powerPreference:"high-performance",canvas:I,antialias:!0,alpha:!0},g));return l.outputEncoding=h.sRGBEncoding,l.toneMapping=h.ACESFilmicToneMapping,g&&wg(l,g),l};function Fg(g){var I=g.store,C=g.element,A=g.onCreated,l=g.target;return W.useEffect((function(){var g=I.getState();g.set((function(g){return{internal:(0,u.Z)((0,u.Z)({},g.internal),{},{active:!0})}})),null==g.events.connect||g.events.connect(l),A&&A(g)}),[]),W.createElement(ig.Provider,{value:I},C)}function Sg(g,I){var C=Vg.get(g),A=null==C?void 0:C.fiber;if(A){var l=null==C?void 0:C.store.getState();l&&(l.internal.active=!1),Hg.updateContainer(null,A,null,(function(){l&&setTimeout((function(){var C,A,o;null==l.events.disconnect||l.events.disconnect(),null==(C=l.gl)||null==(A=C.renderLists)||null==A.dispose||A.dispose(),null==(o=l.gl)||null==o.forceContextLoss||o.forceContextLoss(),function(g){g.dispose&&"Scene"!==g.type&&g.dispose();for(var I in g){var C,A;null==(C=(A=I).dispose)||C.call(A),delete g[I]}}(l),Vg.delete(g),I&&I(g)}),500)}))}}Hg.act;Hg.injectIntoDevTools({bundleType:0,rendererPackageName:"@react-three/fiber",version:"17.0.2"})},7494:function(g){function I(g,I,C){var A,l,o,e,i;function c(){var a=Date.now()-e;a<I&&a>=0?A=setTimeout(c,I-a):(A=null,C||(i=g.apply(o,l),o=l=null))}null==I&&(I=100);var a=function(){o=this,l=arguments,e=Date.now();var a=C&&!A;return A||(A=setTimeout(c,I)),a&&(i=g.apply(o,l),o=l=null),i};return a.clear=function(){A&&(clearTimeout(A),A=null)},a.flush=function(){A&&(i=g.apply(o,l),o=l=null,clearTimeout(A),A=null)},a}I.debounce=I,g.exports=I},8262:function(g){"use strict";g.exports=function g(I,C){if(I===C)return!0;if(I&&C&&"object"==typeof I&&"object"==typeof C){if(I.constructor!==C.constructor)return!1;var A,l,o;if(Array.isArray(I)){if((A=I.length)!=C.length)return!1;for(l=A;0!==l--;)if(!g(I[l],C[l]))return!1;return!0}if(I.constructor===RegExp)return I.source===C.source&&I.flags===C.flags;if(I.valueOf!==Object.prototype.valueOf)return I.valueOf()===C.valueOf();if(I.toString!==Object.prototype.toString)return I.toString()===C.toString();if((A=(o=Object.keys(I)).length)!==Object.keys(C).length)return!1;for(l=A;0!==l--;)if(!Object.prototype.hasOwnProperty.call(C,o[l]))return!1;for(l=A;0!==l--;){var e=o[l];if(!g(I[e],C[e]))return!1}return!0}return I!==I&&C!==C}},3168:function(g,I,C){"use strict";C.d(I,{$:function(){return Z}});var A=C(9439),l=C(4942),o=C(2791),e=C(4909);function i(){if(console&&console.warn){for(var g,I=arguments.length,C=new Array(I),A=0;A<I;A++)C[A]=arguments[A];"string"===typeof C[0]&&(C[0]="react-i18next:: ".concat(C[0])),(g=console).warn.apply(g,C)}}var c={};function a(){for(var g=arguments.length,I=new Array(g),C=0;C<g;C++)I[C]=arguments[C];"string"===typeof I[0]&&c[I[0]]||("string"===typeof I[0]&&(c[I[0]]=new Date),i.apply(void 0,I))}function n(g,I,C){g.loadNamespaces(I,(function(){if(g.isInitialized)C();else{g.on("initialized",(function I(){setTimeout((function(){g.off("initialized",I)}),0),C()}))}}))}function b(g,I){var C=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!I.languages||!I.languages.length)return a("i18n.languages were undefined or empty",I.languages),!0;var A=I.languages[0],l=!!I.options&&I.options.fallbackLng,o=I.languages[I.languages.length-1];if("cimode"===A.toLowerCase())return!0;var e=function(g,C){var A=I.services.backendConnector.state["".concat(g,"|").concat(C)];return-1===A||2===A};return!(C.bindI18n&&C.bindI18n.indexOf("languageChanging")>-1&&I.services.backendConnector.backend&&I.isLanguageChangingTo&&!e(I.isLanguageChangingTo,g))&&(!!I.hasResourceBundle(A,g)||(!I.services.backendConnector.backend||!(!e(A,g)||l&&!e(o,g))))}function d(g,I){var C=Object.keys(g);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(g);I&&(A=A.filter((function(I){return Object.getOwnPropertyDescriptor(g,I).enumerable}))),C.push.apply(C,A)}return C}function G(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{};I%2?d(Object(C),!0).forEach((function(I){(0,l.Z)(g,I,C[I])})):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(C)):d(Object(C)).forEach((function(I){Object.defineProperty(g,I,Object.getOwnPropertyDescriptor(C,I))}))}return g}function Z(g){var I=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},C=I.i18n,l=(0,o.useContext)(e.OO)||{},i=l.i18n,c=l.defaultNS,d=C||i||(0,e.nI)();if(d&&!d.reportNamespaces&&(d.reportNamespaces=new e.zv),!d){a("You will need to pass in an i18next instance by using initReactI18next");var Z=function(g){return Array.isArray(g)?g[g.length-1]:g},s=[Z,{},!1];return s.t=Z,s.i18n={},s.ready=!1,s}d.options.react&&void 0!==d.options.react.wait&&a("It seems you are still using the old wait option, you may migrate to the new useSuspense behaviour.");var t=G(G(G({},(0,e.JP)()),d.options.react),I),B=t.useSuspense,u=g||c||d.options&&d.options.defaultNS;u="string"===typeof u?[u]:u||["translation"],d.reportNamespaces.addUsedNamespaces&&d.reportNamespaces.addUsedNamespaces(u);var m=(d.isInitialized||d.initializedStoreOnce)&&u.every((function(g){return b(g,d,t)}));function h(){return d.getFixedT(null,"fallback"===t.nsMode?u:u[0])}var W=(0,o.useState)(h),r=(0,A.Z)(W,2),y=r[0],p=r[1],V=(0,o.useRef)(!0);(0,o.useEffect)((function(){var g=t.bindI18n,I=t.bindI18nStore;function C(){V.current&&p(h)}return V.current=!0,m||B||n(d,u,(function(){V.current&&p(h)})),g&&d&&d.on(g,C),I&&d&&d.store.on(I,C),function(){V.current=!1,g&&d&&g.split(" ").forEach((function(g){return d.off(g,C)})),I&&d&&I.split(" ").forEach((function(g){return d.store.off(g,C)}))}}),[d,u.join()]);var v=(0,o.useRef)(!0);(0,o.useEffect)((function(){V.current&&!v.current&&p(h),v.current=!1}),[d]);var X=[y,d,m];if(X.t=y,X.i18n=d,X.ready=m,m)return X;if(!m&&!B)return X;throw new Promise((function(g){n(d,u,(function(){g()}))}))}},3599:function(g,I){"use strict";I.Z=function(g){return function(I){g.forEach((function(g){"function"===typeof g?g(I):null!=g&&(g.current=I)}))}}},3721:function(g,I,C){(g=C.nmd(g)).exports=function(I){var A={},l=C(1725),o=C(2791),e=C(5296);function i(g){for(var I="https://reactjs.org/docs/error-decoder.html?invariant="+g,C=1;C<arguments.length;C++)I+="&args[]="+encodeURIComponent(arguments[C]);return"Minified React error #"+g+"; visit "+I+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var c=o.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,a=60103,n=60106,b=60107,d=60108,G=60114,Z=60109,s=60110,t=60112,B=60113,u=60120,m=60115,h=60116,W=60121,r=60129,y=60130,p=60131;if("function"===typeof Symbol&&Symbol.for){var V=Symbol.for;a=V("react.element"),n=V("react.portal"),b=V("react.fragment"),d=V("react.strict_mode"),G=V("react.profiler"),Z=V("react.provider"),s=V("react.context"),t=V("react.forward_ref"),B=V("react.suspense"),u=V("react.suspense_list"),m=V("react.memo"),h=V("react.lazy"),W=V("react.block"),V("react.scope"),r=V("react.debug_trace_mode"),y=V("react.offscreen"),p=V("react.legacy_hidden")}var v="function"===typeof Symbol&&Symbol.iterator;function X(g){return null===g||"object"!==typeof g?null:"function"===typeof(g=v&&g[v]||g["@@iterator"])?g:null}function K(g){if(null==g)return null;if("function"===typeof g)return g.displayName||g.name||null;if("string"===typeof g)return g;switch(g){case b:return"Fragment";case n:return"Portal";case G:return"Profiler";case d:return"StrictMode";case B:return"Suspense";case u:return"SuspenseList"}if("object"===typeof g)switch(g.$$typeof){case s:return(g.displayName||"Context")+".Consumer";case Z:return(g._context.displayName||"Context")+".Provider";case t:var I=g.render;return I=I.displayName||I.name||"",g.displayName||(""!==I?"ForwardRef("+I+")":"ForwardRef");case m:return K(g.type);case W:return K(g._render);case h:I=g._payload,g=g._init;try{return K(g(I))}catch(C){}}return null}function Y(g){var I=g,C=g;if(g.alternate)for(;I.return;)I=I.return;else{g=I;do{0!==(1026&(I=g).flags)&&(C=I.return),g=I.return}while(g)}return 3===I.tag?C:null}function R(g){if(Y(g)!==g)throw Error(i(188))}function H(g){var I=g.alternate;if(!I){if(null===(I=Y(g)))throw Error(i(188));return I!==g?null:g}for(var C=g,A=I;;){var l=C.return;if(null===l)break;var o=l.alternate;if(null===o){if(null!==(A=l.return)){C=A;continue}break}if(l.child===o.child){for(o=l.child;o;){if(o===C)return R(l),g;if(o===A)return R(l),I;o=o.sibling}throw Error(i(188))}if(C.return!==A.return)C=l,A=o;else{for(var e=!1,c=l.child;c;){if(c===C){e=!0,C=l,A=o;break}if(c===A){e=!0,A=l,C=o;break}c=c.sibling}if(!e){for(c=o.child;c;){if(c===C){e=!0,C=o,A=l;break}if(c===A){e=!0,A=o,C=l;break}c=c.sibling}if(!e)throw Error(i(189))}}if(C.alternate!==A)throw Error(i(190))}if(3!==C.tag)throw Error(i(188));return C.stateNode.current===C?g:I}function w(g){if(!(g=H(g)))return null;for(var I=g;;){if(5===I.tag||6===I.tag)return I;if(I.child)I.child.return=I,I=I.child;else{if(I===g)break;for(;!I.sibling;){if(!I.return||I.return===g)return null;I=I.return}I.sibling.return=I.return,I=I.sibling}}return null}function N(g,I){for(var C=g.alternate;null!==I;){if(I===g||I===C)return!0;I=I.return}return!1}var F,S=I.getPublicInstance,z=I.getRootHostContext,k=I.getChildHostContext,J=I.prepareForCommit,L=I.resetAfterCommit,f=I.createInstance,M=I.appendInitialChild,Q=I.finalizeInitialChildren,x=I.prepareUpdate,U=I.shouldSetTextContent,T=I.createTextInstance,j=I.scheduleTimeout,D=I.cancelTimeout,E=I.noTimeout,O=I.isPrimaryRenderer,P=I.supportsMutation,q=I.supportsPersistence,_=I.supportsHydration,$=I.getInstanceFromNode,gg=I.makeOpaqueHydratingObject,Ig=I.makeClientId,Cg=I.beforeActiveInstanceBlur,Ag=I.afterActiveInstanceBlur,lg=I.preparePortalMount,og=I.supportsTestSelectors,eg=I.findFiberRoot,ig=I.getBoundingRect,cg=I.getTextContent,ag=I.isHiddenSubtree,ng=I.matchAccessibilityRole,bg=I.setFocusIfFocusable,dg=I.setupIntersectionObserver,Gg=I.appendChild,Zg=I.appendChildToContainer,sg=I.commitTextUpdate,tg=I.commitMount,Bg=I.commitUpdate,ug=I.insertBefore,mg=I.insertInContainerBefore,hg=I.removeChild,Wg=I.removeChildFromContainer,rg=I.resetTextContent,yg=I.hideInstance,pg=I.hideTextInstance,Vg=I.unhideInstance,vg=I.unhideTextInstance,Xg=I.clearContainer,Kg=I.cloneInstance,Yg=I.createContainerChildSet,Rg=I.appendChildToContainerChildSet,Hg=I.finalizeContainerChildren,wg=I.replaceContainerChildren,Ng=I.cloneHiddenInstance,Fg=I.cloneHiddenTextInstance,Sg=I.canHydrateInstance,zg=I.canHydrateTextInstance,kg=I.isSuspenseInstancePending,Jg=I.isSuspenseInstanceFallback,Lg=I.getNextHydratableSibling,fg=I.getFirstHydratableChild,Mg=I.hydrateInstance,Qg=I.hydrateTextInstance,xg=I.getNextHydratableInstanceAfterSuspenseInstance,Ug=I.commitHydratedContainer,Tg=I.commitHydratedSuspenseInstance;function jg(g){if(void 0===F)try{throw Error()}catch(C){var I=C.stack.trim().match(/\n( *(at )?)/);F=I&&I[1]||""}return"\n"+F+g}var Dg=!1;function Eg(g,I){if(!g||Dg)return"";Dg=!0;var C=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(I)if(I=function(){throw Error()},Object.defineProperty(I.prototype,"props",{set:function(){throw Error()}}),"object"===typeof Reflect&&Reflect.construct){try{Reflect.construct(I,[])}catch(c){var A=c}Reflect.construct(g,[],I)}else{try{I.call()}catch(c){A=c}g.call(I.prototype)}else{try{throw Error()}catch(c){A=c}g()}}catch(c){if(c&&A&&"string"===typeof c.stack){for(var l=c.stack.split("\n"),o=A.stack.split("\n"),e=l.length-1,i=o.length-1;1<=e&&0<=i&&l[e]!==o[i];)i--;for(;1<=e&&0<=i;e--,i--)if(l[e]!==o[i]){if(1!==e||1!==i)do{if(e--,0>--i||l[e]!==o[i])return"\n"+l[e].replace(" at new "," at ")}while(1<=e&&0<=i);break}}}finally{Dg=!1,Error.prepareStackTrace=C}return(g=g?g.displayName||g.name:"")?jg(g):""}var Og=[],Pg=-1;function qg(g){return{current:g}}function _g(g){0>Pg||(g.current=Og[Pg],Og[Pg]=null,Pg--)}function $g(g,I){Pg++,Og[Pg]=g.current,g.current=I}var gI={},II=qg(gI),CI=qg(!1),AI=gI;function lI(g,I){var C=g.type.contextTypes;if(!C)return gI;var A=g.stateNode;if(A&&A.__reactInternalMemoizedUnmaskedChildContext===I)return A.__reactInternalMemoizedMaskedChildContext;var l,o={};for(l in C)o[l]=I[l];return A&&((g=g.stateNode).__reactInternalMemoizedUnmaskedChildContext=I,g.__reactInternalMemoizedMaskedChildContext=o),o}function oI(g){return null!==(g=g.childContextTypes)&&void 0!==g}function eI(){_g(CI),_g(II)}function iI(g,I,C){if(II.current!==gI)throw Error(i(168));$g(II,I),$g(CI,C)}function cI(g,I,C){var A=g.stateNode;if(g=I.childContextTypes,"function"!==typeof A.getChildContext)return C;for(var o in A=A.getChildContext())if(!(o in g))throw Error(i(108,K(I)||"Unknown",o));return l({},C,A)}function aI(g){return g=(g=g.stateNode)&&g.__reactInternalMemoizedMergedChildContext||gI,AI=II.current,$g(II,g),$g(CI,CI.current),!0}function nI(g,I,C){var A=g.stateNode;if(!A)throw Error(i(169));C?(g=cI(g,I,AI),A.__reactInternalMemoizedMergedChildContext=g,_g(CI),_g(II),$g(II,g)):_g(CI),$g(CI,C)}var bI=null,dI=null;(0,e.unstable_now)();var GI=0,ZI=8;function sI(g){if(0!==(1&g))return ZI=15,1;if(0!==(2&g))return ZI=14,2;if(0!==(4&g))return ZI=13,4;var I=24&g;return 0!==I?(ZI=12,I):0!==(32&g)?(ZI=11,32):0!==(I=192&g)?(ZI=10,I):0!==(256&g)?(ZI=9,256):0!==(I=3584&g)?(ZI=8,I):0!==(4096&g)?(ZI=7,4096):0!==(I=4186112&g)?(ZI=6,I):0!==(I=62914560&g)?(ZI=5,I):67108864&g?(ZI=4,67108864):0!==(134217728&g)?(ZI=3,134217728):0!==(I=805306368&g)?(ZI=2,I):0!==(1073741824&g)?(ZI=1,1073741824):(ZI=8,g)}function tI(g,I){var C=g.pendingLanes;if(0===C)return ZI=0;var A=0,l=0,o=g.expiredLanes,e=g.suspendedLanes,i=g.pingedLanes;if(0!==o)A=o,l=ZI=15;else if(0!==(o=134217727&C)){var c=o&~e;0!==c?(A=sI(c),l=ZI):0!==(i&=o)&&(A=sI(i),l=ZI)}else 0!==(o=C&~e)?(A=sI(o),l=ZI):0!==i&&(A=sI(i),l=ZI);if(0===A)return 0;if(A=C&((0>(A=31-rI(A))?0:1<<A)<<1)-1,0!==I&&I!==A&&0===(I&e)){if(sI(I),l<=ZI)return I;ZI=l}if(0!==(I=g.entangledLanes))for(g=g.entanglements,I&=A;0<I;)l=1<<(C=31-rI(I)),A|=g[C],I&=~l;return A}function BI(g){return 0!==(g=-1073741825&g.pendingLanes)?g:1073741824&g?1073741824:0}function uI(g,I){switch(g){case 15:return 1;case 14:return 2;case 12:return 0===(g=mI(24&~I))?uI(10,I):g;case 10:return 0===(g=mI(192&~I))?uI(8,I):g;case 8:return 0===(g=mI(3584&~I))&&(0===(g=mI(4186112&~I))&&(g=512)),g;case 2:return 0===(I=mI(805306368&~I))&&(I=268435456),I}throw Error(i(358,g))}function mI(g){return g&-g}function hI(g){for(var I=[],C=0;31>C;C++)I.push(g);return I}function WI(g,I,C){g.pendingLanes|=I;var A=I-1;g.suspendedLanes&=A,g.pingedLanes&=A,(g=g.eventTimes)[I=31-rI(I)]=C}var rI=Math.clz32?Math.clz32:function(g){return 0===g?32:31-(yI(g)/pI|0)|0},yI=Math.log,pI=Math.LN2;var VI=e.unstable_runWithPriority,vI=e.unstable_scheduleCallback,XI=e.unstable_cancelCallback,KI=e.unstable_shouldYield,YI=e.unstable_requestPaint,RI=e.unstable_now,HI=e.unstable_getCurrentPriorityLevel,wI=e.unstable_ImmediatePriority,NI=e.unstable_UserBlockingPriority,FI=e.unstable_NormalPriority,SI=e.unstable_LowPriority,zI=e.unstable_IdlePriority,kI={},JI=void 0!==YI?YI:function(){},LI=null,fI=null,MI=!1,QI=RI(),xI=1e4>QI?RI:function(){return RI()-QI};function UI(){switch(HI()){case wI:return 99;case NI:return 98;case FI:return 97;case SI:return 96;case zI:return 95;default:throw Error(i(332))}}function TI(g){switch(g){case 99:return wI;case 98:return NI;case 97:return FI;case 96:return SI;case 95:return zI;default:throw Error(i(332))}}function jI(g,I){return g=TI(g),VI(g,I)}function DI(g,I,C){return g=TI(g),vI(g,I,C)}function EI(){if(null!==fI){var g=fI;fI=null,XI(g)}OI()}function OI(){if(!MI&&null!==LI){MI=!0;var g=0;try{var I=LI;jI(99,(function(){for(;g<I.length;g++){var C=I[g];do{C=C(!0)}while(null!==C)}})),LI=null}catch(C){throw null!==LI&&(LI=LI.slice(g+1)),vI(wI,EI),C}finally{MI=!1}}}var PI=c.ReactCurrentBatchConfig;var qI="function"===typeof Object.is?Object.is:function(g,I){return g===I&&(0!==g||1/g===1/I)||g!==g&&I!==I},_I=Object.prototype.hasOwnProperty;function $I(g,I){if(qI(g,I))return!0;if("object"!==typeof g||null===g||"object"!==typeof I||null===I)return!1;var C=Object.keys(g),A=Object.keys(I);if(C.length!==A.length)return!1;for(A=0;A<C.length;A++)if(!_I.call(I,C[A])||!qI(g[C[A]],I[C[A]]))return!1;return!0}function gC(g){switch(g.tag){case 5:return jg(g.type);case 16:return jg("Lazy");case 13:return jg("Suspense");case 19:return jg("SuspenseList");case 0:case 2:case 15:return g=Eg(g.type,!1);case 11:return g=Eg(g.type.render,!1);case 22:return g=Eg(g.type._render,!1);case 1:return g=Eg(g.type,!0);default:return""}}function IC(g,I){if(g&&g.defaultProps){for(var C in I=l({},I),g=g.defaultProps)void 0===I[C]&&(I[C]=g[C]);return I}return I}var CC=qg(null),AC=null,lC=null,oC=null;function eC(){oC=lC=AC=null}function iC(g,I){g=g.type._context,O?($g(CC,g._currentValue),g._currentValue=I):($g(CC,g._currentValue2),g._currentValue2=I)}function cC(g){var I=CC.current;_g(CC),g=g.type._context,O?g._currentValue=I:g._currentValue2=I}function aC(g,I){for(;null!==g;){var C=g.alternate;if((g.childLanes&I)===I){if(null===C||(C.childLanes&I)===I)break;C.childLanes|=I}else g.childLanes|=I,null!==C&&(C.childLanes|=I);g=g.return}}function nC(g,I){AC=g,oC=lC=null,null!==(g=g.dependencies)&&null!==g.firstContext&&(0!==(g.lanes&I)&&(MA=!0),g.firstContext=null)}function bC(g,I){if(oC!==g&&!1!==I&&0!==I)if("number"===typeof I&&1073741823!==I||(oC=g,I=1073741823),I={context:g,observedBits:I,next:null},null===lC){if(null===AC)throw Error(i(308));lC=I,AC.dependencies={lanes:0,firstContext:I,responders:null}}else lC=lC.next=I;return O?g._currentValue:g._currentValue2}var dC=!1;function GC(g){g.updateQueue={baseState:g.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null},effects:null}}function ZC(g,I){g=g.updateQueue,I.updateQueue===g&&(I.updateQueue={baseState:g.baseState,firstBaseUpdate:g.firstBaseUpdate,lastBaseUpdate:g.lastBaseUpdate,shared:g.shared,effects:g.effects})}function sC(g,I){return{eventTime:g,lane:I,tag:0,payload:null,callback:null,next:null}}function tC(g,I){if(null!==(g=g.updateQueue)){var C=(g=g.shared).pending;null===C?I.next=I:(I.next=C.next,C.next=I),g.pending=I}}function BC(g,I){var C=g.updateQueue,A=g.alternate;if(null!==A&&C===(A=A.updateQueue)){var l=null,o=null;if(null!==(C=C.firstBaseUpdate)){do{var e={eventTime:C.eventTime,lane:C.lane,tag:C.tag,payload:C.payload,callback:C.callback,next:null};null===o?l=o=e:o=o.next=e,C=C.next}while(null!==C);null===o?l=o=I:o=o.next=I}else l=o=I;return C={baseState:A.baseState,firstBaseUpdate:l,lastBaseUpdate:o,shared:A.shared,effects:A.effects},void(g.updateQueue=C)}null===(g=C.lastBaseUpdate)?C.firstBaseUpdate=I:g.next=I,C.lastBaseUpdate=I}function uC(g,I,C,A){var o=g.updateQueue;dC=!1;var e=o.firstBaseUpdate,i=o.lastBaseUpdate,c=o.shared.pending;if(null!==c){o.shared.pending=null;var a=c,n=a.next;a.next=null,null===i?e=n:i.next=n,i=a;var b=g.alternate;if(null!==b){var d=(b=b.updateQueue).lastBaseUpdate;d!==i&&(null===d?b.firstBaseUpdate=n:d.next=n,b.lastBaseUpdate=a)}}if(null!==e){for(d=o.baseState,i=0,b=n=a=null;;){c=e.lane;var G=e.eventTime;if((A&c)===c){null!==b&&(b=b.next={eventTime:G,lane:0,tag:e.tag,payload:e.payload,callback:e.callback,next:null});g:{var Z=g,s=e;switch(c=I,G=C,s.tag){case 1:if("function"===typeof(Z=s.payload)){d=Z.call(G,d,c);break g}d=Z;break g;case 3:Z.flags=-4097&Z.flags|64;case 0:if(null===(c="function"===typeof(Z=s.payload)?Z.call(G,d,c):Z)||void 0===c)break g;d=l({},d,c);break g;case 2:dC=!0}}null!==e.callback&&(g.flags|=32,null===(c=o.effects)?o.effects=[e]:c.push(e))}else G={eventTime:G,lane:c,tag:e.tag,payload:e.payload,callback:e.callback,next:null},null===b?(n=b=G,a=d):b=b.next=G,i|=c;if(null===(e=e.next)){if(null===(c=o.shared.pending))break;e=c.next,c.next=null,o.lastBaseUpdate=c,o.shared.pending=null}}null===b&&(a=d),o.baseState=a,o.firstBaseUpdate=n,o.lastBaseUpdate=b,no|=i,g.lanes=i,g.memoizedState=d}}function mC(g,I,C){if(g=I.effects,I.effects=null,null!==g)for(I=0;I<g.length;I++){var A=g[I],l=A.callback;if(null!==l){if(A.callback=null,A=C,"function"!==typeof l)throw Error(i(191,l));l.call(A)}}}var hC=(new o.Component).refs;function WC(g,I,C,A){C=null===(C=C(A,I=g.memoizedState))||void 0===C?I:l({},I,C),g.memoizedState=C,0===g.lanes&&(g.updateQueue.baseState=C)}var rC={isMounted:function(g){return!!(g=g._reactInternals)&&Y(g)===g},enqueueSetState:function(g,I,C){g=g._reactInternals;var A=zo(),l=ko(g),o=sC(A,l);o.payload=I,void 0!==C&&null!==C&&(o.callback=C),tC(g,o),Jo(g,l,A)},enqueueReplaceState:function(g,I,C){g=g._reactInternals;var A=zo(),l=ko(g),o=sC(A,l);o.tag=1,o.payload=I,void 0!==C&&null!==C&&(o.callback=C),tC(g,o),Jo(g,l,A)},enqueueForceUpdate:function(g,I){g=g._reactInternals;var C=zo(),A=ko(g),l=sC(C,A);l.tag=2,void 0!==I&&null!==I&&(l.callback=I),tC(g,l),Jo(g,A,C)}};function yC(g,I,C,A,l,o,e){return"function"===typeof(g=g.stateNode).shouldComponentUpdate?g.shouldComponentUpdate(A,o,e):!I.prototype||!I.prototype.isPureReactComponent||(!$I(C,A)||!$I(l,o))}function pC(g,I,C){var A=!1,l=gI,o=I.contextType;return"object"===typeof o&&null!==o?o=bC(o):(l=oI(I)?AI:II.current,o=(A=null!==(A=I.contextTypes)&&void 0!==A)?lI(g,l):gI),I=new I(C,o),g.memoizedState=null!==I.state&&void 0!==I.state?I.state:null,I.updater=rC,g.stateNode=I,I._reactInternals=g,A&&((g=g.stateNode).__reactInternalMemoizedUnmaskedChildContext=l,g.__reactInternalMemoizedMaskedChildContext=o),I}function VC(g,I,C,A){g=I.state,"function"===typeof I.componentWillReceiveProps&&I.componentWillReceiveProps(C,A),"function"===typeof I.UNSAFE_componentWillReceiveProps&&I.UNSAFE_componentWillReceiveProps(C,A),I.state!==g&&rC.enqueueReplaceState(I,I.state,null)}function vC(g,I,C,A){var l=g.stateNode;l.props=C,l.state=g.memoizedState,l.refs=hC,GC(g);var o=I.contextType;"object"===typeof o&&null!==o?l.context=bC(o):(o=oI(I)?AI:II.current,l.context=lI(g,o)),uC(g,C,l,A),l.state=g.memoizedState,"function"===typeof(o=I.getDerivedStateFromProps)&&(WC(g,I,o,C),l.state=g.memoizedState),"function"===typeof I.getDerivedStateFromProps||"function"===typeof l.getSnapshotBeforeUpdate||"function"!==typeof l.UNSAFE_componentWillMount&&"function"!==typeof l.componentWillMount||(I=l.state,"function"===typeof l.componentWillMount&&l.componentWillMount(),"function"===typeof l.UNSAFE_componentWillMount&&l.UNSAFE_componentWillMount(),I!==l.state&&rC.enqueueReplaceState(l,l.state,null),uC(g,C,l,A),l.state=g.memoizedState),"function"===typeof l.componentDidMount&&(g.flags|=4)}var XC=Array.isArray;function KC(g,I,C){if(null!==(g=C.ref)&&"function"!==typeof g&&"object"!==typeof g){if(C._owner){if(C=C._owner){if(1!==C.tag)throw Error(i(309));var A=C.stateNode}if(!A)throw Error(i(147,g));var l=""+g;return null!==I&&null!==I.ref&&"function"===typeof I.ref&&I.ref._stringRef===l?I.ref:(I=function(g){var I=A.refs;I===hC&&(I=A.refs={}),null===g?delete I[l]:I[l]=g},I._stringRef=l,I)}if("string"!==typeof g)throw Error(i(284));if(!C._owner)throw Error(i(290,g))}return g}function YC(g,I){if("textarea"!==g.type)throw Error(i(31,"[object Object]"===Object.prototype.toString.call(I)?"object with keys {"+Object.keys(I).join(", ")+"}":I))}function RC(g){function I(I,C){if(g){var A=I.lastEffect;null!==A?(A.nextEffect=C,I.lastEffect=C):I.firstEffect=I.lastEffect=C,C.nextEffect=null,C.flags=8}}function C(C,A){if(!g)return null;for(;null!==A;)I(C,A),A=A.sibling;return null}function A(g,I){for(g=new Map;null!==I;)null!==I.key?g.set(I.key,I):g.set(I.index,I),I=I.sibling;return g}function l(g,I){return(g=ye(g,I)).index=0,g.sibling=null,g}function o(I,C,A){return I.index=A,g?null!==(A=I.alternate)?(A=A.index)<C?(I.flags=2,C):A:(I.flags=2,C):C}function e(I){return g&&null===I.alternate&&(I.flags=2),I}function c(g,I,C,A){return null===I||6!==I.tag?((I=Xe(C,g.mode,A)).return=g,I):((I=l(I,C)).return=g,I)}function d(g,I,C,A){return null!==I&&I.elementType===C.type?((A=l(I,C.props)).ref=KC(g,I,C),A.return=g,A):((A=pe(C.type,C.key,C.props,null,g.mode,A)).ref=KC(g,I,C),A.return=g,A)}function G(g,I,C,A){return null===I||4!==I.tag||I.stateNode.containerInfo!==C.containerInfo||I.stateNode.implementation!==C.implementation?((I=Ke(C,g.mode,A)).return=g,I):((I=l(I,C.children||[])).return=g,I)}function Z(g,I,C,A,o){return null===I||7!==I.tag?((I=Ve(C,g.mode,A,o)).return=g,I):((I=l(I,C)).return=g,I)}function s(g,I,C){if("string"===typeof I||"number"===typeof I)return(I=Xe(""+I,g.mode,C)).return=g,I;if("object"===typeof I&&null!==I){switch(I.$$typeof){case a:return(C=pe(I.type,I.key,I.props,null,g.mode,C)).ref=KC(g,null,I),C.return=g,C;case n:return(I=Ke(I,g.mode,C)).return=g,I}if(XC(I)||X(I))return(I=Ve(I,g.mode,C,null)).return=g,I;YC(g,I)}return null}function t(g,I,C,A){var l=null!==I?I.key:null;if("string"===typeof C||"number"===typeof C)return null!==l?null:c(g,I,""+C,A);if("object"===typeof C&&null!==C){switch(C.$$typeof){case a:return C.key===l?C.type===b?Z(g,I,C.props.children,A,l):d(g,I,C,A):null;case n:return C.key===l?G(g,I,C,A):null}if(XC(C)||X(C))return null!==l?null:Z(g,I,C,A,null);YC(g,C)}return null}function B(g,I,C,A,l){if("string"===typeof A||"number"===typeof A)return c(I,g=g.get(C)||null,""+A,l);if("object"===typeof A&&null!==A){switch(A.$$typeof){case a:return g=g.get(null===A.key?C:A.key)||null,A.type===b?Z(I,g,A.props.children,l,A.key):d(I,g,A,l);case n:return G(I,g=g.get(null===A.key?C:A.key)||null,A,l)}if(XC(A)||X(A))return Z(I,g=g.get(C)||null,A,l,null);YC(I,A)}return null}function u(l,e,i,c){for(var a=null,n=null,b=e,d=e=0,G=null;null!==b&&d<i.length;d++){b.index>d?(G=b,b=null):G=b.sibling;var Z=t(l,b,i[d],c);if(null===Z){null===b&&(b=G);break}g&&b&&null===Z.alternate&&I(l,b),e=o(Z,e,d),null===n?a=Z:n.sibling=Z,n=Z,b=G}if(d===i.length)return C(l,b),a;if(null===b){for(;d<i.length;d++)null!==(b=s(l,i[d],c))&&(e=o(b,e,d),null===n?a=b:n.sibling=b,n=b);return a}for(b=A(l,b);d<i.length;d++)null!==(G=B(b,l,d,i[d],c))&&(g&&null!==G.alternate&&b.delete(null===G.key?d:G.key),e=o(G,e,d),null===n?a=G:n.sibling=G,n=G);return g&&b.forEach((function(g){return I(l,g)})),a}function m(l,e,c,a){var n=X(c);if("function"!==typeof n)throw Error(i(150));if(null==(c=n.call(c)))throw Error(i(151));for(var b=n=null,d=e,G=e=0,Z=null,u=c.next();null!==d&&!u.done;G++,u=c.next()){d.index>G?(Z=d,d=null):Z=d.sibling;var m=t(l,d,u.value,a);if(null===m){null===d&&(d=Z);break}g&&d&&null===m.alternate&&I(l,d),e=o(m,e,G),null===b?n=m:b.sibling=m,b=m,d=Z}if(u.done)return C(l,d),n;if(null===d){for(;!u.done;G++,u=c.next())null!==(u=s(l,u.value,a))&&(e=o(u,e,G),null===b?n=u:b.sibling=u,b=u);return n}for(d=A(l,d);!u.done;G++,u=c.next())null!==(u=B(d,l,G,u.value,a))&&(g&&null!==u.alternate&&d.delete(null===u.key?G:u.key),e=o(u,e,G),null===b?n=u:b.sibling=u,b=u);return g&&d.forEach((function(g){return I(l,g)})),n}return function(g,A,o,c){var d="object"===typeof o&&null!==o&&o.type===b&&null===o.key;d&&(o=o.props.children);var G="object"===typeof o&&null!==o;if(G)switch(o.$$typeof){case a:g:{for(G=o.key,d=A;null!==d;){if(d.key===G){if(7===d.tag){if(o.type===b){C(g,d.sibling),(A=l(d,o.props.children)).return=g,g=A;break g}}else if(d.elementType===o.type){C(g,d.sibling),(A=l(d,o.props)).ref=KC(g,d,o),A.return=g,g=A;break g}C(g,d);break}I(g,d),d=d.sibling}o.type===b?((A=Ve(o.props.children,g.mode,c,o.key)).return=g,g=A):((c=pe(o.type,o.key,o.props,null,g.mode,c)).ref=KC(g,A,o),c.return=g,g=c)}return e(g);case n:g:{for(d=o.key;null!==A;){if(A.key===d){if(4===A.tag&&A.stateNode.containerInfo===o.containerInfo&&A.stateNode.implementation===o.implementation){C(g,A.sibling),(A=l(A,o.children||[])).return=g,g=A;break g}C(g,A);break}I(g,A),A=A.sibling}(A=Ke(o,g.mode,c)).return=g,g=A}return e(g)}if("string"===typeof o||"number"===typeof o)return o=""+o,null!==A&&6===A.tag?(C(g,A.sibling),(A=l(A,o)).return=g,g=A):(C(g,A),(A=Xe(o,g.mode,c)).return=g,g=A),e(g);if(XC(o))return u(g,A,o,c);if(X(o))return m(g,A,o,c);if(G&&YC(g,o),"undefined"===typeof o&&!d)switch(g.tag){case 1:case 22:case 0:case 11:case 15:throw Error(i(152,K(g.type)||"Component"))}return C(g,A)}}var HC=RC(!0),wC=RC(!1),NC={},FC=qg(NC),SC=qg(NC),zC=qg(NC);function kC(g){if(g===NC)throw Error(i(174));return g}function JC(g,I){$g(zC,I),$g(SC,g),$g(FC,NC),g=z(I),_g(FC),$g(FC,g)}function LC(){_g(FC),_g(SC),_g(zC)}function fC(g){var I=kC(zC.current),C=kC(FC.current);C!==(I=k(C,g.type,I))&&($g(SC,g),$g(FC,I))}function MC(g){SC.current===g&&(_g(FC),_g(SC))}var QC=qg(0);function xC(g){for(var I=g;null!==I;){if(13===I.tag){var C=I.memoizedState;if(null!==C&&(null===(C=C.dehydrated)||kg(C)||Jg(C)))return I}else if(19===I.tag&&void 0!==I.memoizedProps.revealOrder){if(0!==(64&I.flags))return I}else if(null!==I.child){I.child.return=I,I=I.child;continue}if(I===g)break;for(;null===I.sibling;){if(null===I.return||I.return===g)return null;I=I.return}I.sibling.return=I.return,I=I.sibling}return null}var UC=null,TC=null,jC=!1;function DC(g,I){var C=We(5,null,null,0);C.elementType="DELETED",C.type="DELETED",C.stateNode=I,C.return=g,C.flags=8,null!==g.lastEffect?(g.lastEffect.nextEffect=C,g.lastEffect=C):g.firstEffect=g.lastEffect=C}function EC(g,I){switch(g.tag){case 5:return null!==(I=Sg(I,g.type,g.pendingProps))&&(g.stateNode=I,!0);case 6:return null!==(I=zg(I,g.pendingProps))&&(g.stateNode=I,!0);default:return!1}}function OC(g){if(jC){var I=TC;if(I){var C=I;if(!EC(g,I)){if(!(I=Lg(C))||!EC(g,I))return g.flags=-1025&g.flags|2,jC=!1,void(UC=g);DC(UC,C)}UC=g,TC=fg(I)}else g.flags=-1025&g.flags|2,jC=!1,UC=g}}function PC(g){for(g=g.return;null!==g&&5!==g.tag&&3!==g.tag&&13!==g.tag;)g=g.return;UC=g}function qC(g){if(!_||g!==UC)return!1;if(!jC)return PC(g),jC=!0,!1;var I=g.type;if(5!==g.tag||"head"!==I&&"body"!==I&&!U(I,g.memoizedProps))for(I=TC;I;)DC(g,I),I=Lg(I);if(PC(g),13===g.tag){if(!_)throw Error(i(316));if(!(g=null!==(g=g.memoizedState)?g.dehydrated:null))throw Error(i(317));TC=xg(g)}else TC=UC?Lg(g.stateNode):null;return!0}function _C(){_&&(TC=UC=null,jC=!1)}var $C=[];function gA(){for(var g=0;g<$C.length;g++){var I=$C[g];O?I._workInProgressVersionPrimary=null:I._workInProgressVersionSecondary=null}$C.length=0}var IA=c.ReactCurrentDispatcher,CA=c.ReactCurrentBatchConfig,AA=0,lA=null,oA=null,eA=null,iA=!1,cA=!1;function aA(){throw Error(i(321))}function nA(g,I){if(null===I)return!1;for(var C=0;C<I.length&&C<g.length;C++)if(!qI(g[C],I[C]))return!1;return!0}function bA(g,I,C,A,l,o){if(AA=o,lA=I,I.memoizedState=null,I.updateQueue=null,I.lanes=0,IA.current=null===g||null===g.memoizedState?kA:JA,g=C(A,l),cA){o=0;do{if(cA=!1,!(25>o))throw Error(i(301));o+=1,eA=oA=null,I.updateQueue=null,IA.current=LA,g=C(A,l)}while(cA)}if(IA.current=zA,I=null!==oA&&null!==oA.next,AA=0,eA=oA=lA=null,iA=!1,I)throw Error(i(300));return g}function dA(){var g={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===eA?lA.memoizedState=eA=g:eA=eA.next=g,eA}function GA(){if(null===oA){var g=lA.alternate;g=null!==g?g.memoizedState:null}else g=oA.next;var I=null===eA?lA.memoizedState:eA.next;if(null!==I)eA=I,oA=g;else{if(null===g)throw Error(i(310));g={memoizedState:(oA=g).memoizedState,baseState:oA.baseState,baseQueue:oA.baseQueue,queue:oA.queue,next:null},null===eA?lA.memoizedState=eA=g:eA=eA.next=g}return eA}function ZA(g,I){return"function"===typeof I?I(g):I}function sA(g){var I=GA(),C=I.queue;if(null===C)throw Error(i(311));C.lastRenderedReducer=g;var A=oA,l=A.baseQueue,o=C.pending;if(null!==o){if(null!==l){var e=l.next;l.next=o.next,o.next=e}A.baseQueue=l=o,C.pending=null}if(null!==l){l=l.next,A=A.baseState;var c=e=o=null,a=l;do{var n=a.lane;if((AA&n)===n)null!==c&&(c=c.next={lane:0,action:a.action,eagerReducer:a.eagerReducer,eagerState:a.eagerState,next:null}),A=a.eagerReducer===g?a.eagerState:g(A,a.action);else{var b={lane:n,action:a.action,eagerReducer:a.eagerReducer,eagerState:a.eagerState,next:null};null===c?(e=c=b,o=A):c=c.next=b,lA.lanes|=n,no|=n}a=a.next}while(null!==a&&a!==l);null===c?o=A:c.next=e,qI(A,I.memoizedState)||(MA=!0),I.memoizedState=A,I.baseState=o,I.baseQueue=c,C.lastRenderedState=A}return[I.memoizedState,C.dispatch]}function tA(g){var I=GA(),C=I.queue;if(null===C)throw Error(i(311));C.lastRenderedReducer=g;var A=C.dispatch,l=C.pending,o=I.memoizedState;if(null!==l){C.pending=null;var e=l=l.next;do{o=g(o,e.action),e=e.next}while(e!==l);qI(o,I.memoizedState)||(MA=!0),I.memoizedState=o,null===I.baseQueue&&(I.baseState=o),C.lastRenderedState=o}return[o,A]}function BA(g,I,C){var A=I._getVersion;A=A(I._source);var l=O?I._workInProgressVersionPrimary:I._workInProgressVersionSecondary;if(null!==l?g=l===A:(g=g.mutableReadLanes,(g=(AA&g)===g)&&(O?I._workInProgressVersionPrimary=A:I._workInProgressVersionSecondary=A,$C.push(I))),g)return C(I._source);throw $C.push(I),Error(i(350))}function uA(g,I,C,A){var l=Co;if(null===l)throw Error(i(349));var o=I._getVersion,e=o(I._source),c=IA.current,a=c.useState((function(){return BA(l,I,C)})),n=a[1],b=a[0];a=eA;var d=g.memoizedState,G=d.refs,Z=G.getSnapshot,s=d.source;d=d.subscribe;var t=lA;return g.memoizedState={refs:G,source:I,subscribe:A},c.useEffect((function(){G.getSnapshot=C,G.setSnapshot=n;var g=o(I._source);if(!qI(e,g)){g=C(I._source),qI(b,g)||(n(g),g=ko(t),l.mutableReadLanes|=g&l.pendingLanes),g=l.mutableReadLanes,l.entangledLanes|=g;for(var A=l.entanglements,i=g;0<i;){var c=31-rI(i),a=1<<c;A[c]|=g,i&=~a}}}),[C,I,A]),c.useEffect((function(){return A(I._source,(function(){var g=G.getSnapshot,C=G.setSnapshot;try{C(g(I._source));var A=ko(t);l.mutableReadLanes|=A&l.pendingLanes}catch(o){C((function(){throw o}))}}))}),[I,A]),qI(Z,C)&&qI(s,I)&&qI(d,A)||((g={pending:null,dispatch:null,lastRenderedReducer:ZA,lastRenderedState:b}).dispatch=n=SA.bind(null,lA,g),a.queue=g,a.baseQueue=null,b=BA(l,I,C),a.memoizedState=a.baseState=b),b}function mA(g,I,C){return uA(GA(),g,I,C)}function hA(g){var I=dA();return"function"===typeof g&&(g=g()),I.memoizedState=I.baseState=g,g=(g=I.queue={pending:null,dispatch:null,lastRenderedReducer:ZA,lastRenderedState:g}).dispatch=SA.bind(null,lA,g),[I.memoizedState,g]}function WA(g,I,C,A){return g={tag:g,create:I,destroy:C,deps:A,next:null},null===(I=lA.updateQueue)?(I={lastEffect:null},lA.updateQueue=I,I.lastEffect=g.next=g):null===(C=I.lastEffect)?I.lastEffect=g.next=g:(A=C.next,C.next=g,g.next=A,I.lastEffect=g),g}function rA(g){return g={current:g},dA().memoizedState=g}function yA(){return GA().memoizedState}function pA(g,I,C,A){var l=dA();lA.flags|=g,l.memoizedState=WA(1|I,C,void 0,void 0===A?null:A)}function VA(g,I,C,A){var l=GA();A=void 0===A?null:A;var o=void 0;if(null!==oA){var e=oA.memoizedState;if(o=e.destroy,null!==A&&nA(A,e.deps))return void WA(I,C,o,A)}lA.flags|=g,l.memoizedState=WA(1|I,C,o,A)}function vA(g,I){return pA(516,4,g,I)}function XA(g,I){return VA(516,4,g,I)}function KA(g,I){return VA(4,2,g,I)}function YA(g,I){return"function"===typeof I?(g=g(),I(g),function(){I(null)}):null!==I&&void 0!==I?(g=g(),I.current=g,function(){I.current=null}):void 0}function RA(g,I,C){return C=null!==C&&void 0!==C?C.concat([g]):null,VA(4,2,YA.bind(null,I,g),C)}function HA(){}function wA(g,I){var C=GA();I=void 0===I?null:I;var A=C.memoizedState;return null!==A&&null!==I&&nA(I,A[1])?A[0]:(C.memoizedState=[g,I],g)}function NA(g,I){var C=GA();I=void 0===I?null:I;var A=C.memoizedState;return null!==A&&null!==I&&nA(I,A[1])?A[0]:(g=g(),C.memoizedState=[g,I],g)}function FA(g,I){var C=UI();jI(98>C?98:C,(function(){g(!0)})),jI(97<C?97:C,(function(){var C=CA.transition;CA.transition=1;try{g(!1),I()}finally{CA.transition=C}}))}function SA(g,I,C){var A=zo(),l=ko(g),o={lane:l,action:C,eagerReducer:null,eagerState:null,next:null},e=I.pending;if(null===e?o.next=o:(o.next=e.next,e.next=o),I.pending=o,e=g.alternate,g===lA||null!==e&&e===lA)cA=iA=!0;else{if(0===g.lanes&&(null===e||0===e.lanes)&&null!==(e=I.lastRenderedReducer))try{var i=I.lastRenderedState,c=e(i,C);if(o.eagerReducer=e,o.eagerState=c,qI(c,i))return}catch(a){}Jo(g,l,A)}}var zA={readContext:bC,useCallback:aA,useContext:aA,useEffect:aA,useImperativeHandle:aA,useLayoutEffect:aA,useMemo:aA,useReducer:aA,useRef:aA,useState:aA,useDebugValue:aA,useDeferredValue:aA,useTransition:aA,useMutableSource:aA,useOpaqueIdentifier:aA,unstable_isNewReconciler:!1},kA={readContext:bC,useCallback:function(g,I){return dA().memoizedState=[g,void 0===I?null:I],g},useContext:bC,useEffect:vA,useImperativeHandle:function(g,I,C){return C=null!==C&&void 0!==C?C.concat([g]):null,pA(4,2,YA.bind(null,I,g),C)},useLayoutEffect:function(g,I){return pA(4,2,g,I)},useMemo:function(g,I){var C=dA();return I=void 0===I?null:I,g=g(),C.memoizedState=[g,I],g},useReducer:function(g,I,C){var A=dA();return I=void 0!==C?C(I):I,A.memoizedState=A.baseState=I,g=(g=A.queue={pending:null,dispatch:null,lastRenderedReducer:g,lastRenderedState:I}).dispatch=SA.bind(null,lA,g),[A.memoizedState,g]},useRef:rA,useState:hA,useDebugValue:HA,useDeferredValue:function(g){var I=hA(g),C=I[0],A=I[1];return vA((function(){var I=CA.transition;CA.transition=1;try{A(g)}finally{CA.transition=I}}),[g]),C},useTransition:function(){var g=hA(!1),I=g[0];return rA(g=FA.bind(null,g[1])),[g,I]},useMutableSource:function(g,I,C){var A=dA();return A.memoizedState={refs:{getSnapshot:I,setSnapshot:null},source:g,subscribe:C},uA(A,g,I,C)},useOpaqueIdentifier:function(){if(jC){var g=!1,I=gg((function(){throw g||(g=!0,C(Ig())),Error(i(355))})),C=hA(I)[1];return 0===(2&lA.mode)&&(lA.flags|=516,WA(5,(function(){C(Ig())}),void 0,null)),I}return hA(I=Ig()),I},unstable_isNewReconciler:!1},JA={readContext:bC,useCallback:wA,useContext:bC,useEffect:XA,useImperativeHandle:RA,useLayoutEffect:KA,useMemo:NA,useReducer:sA,useRef:yA,useState:function(){return sA(ZA)},useDebugValue:HA,useDeferredValue:function(g){var I=sA(ZA),C=I[0],A=I[1];return XA((function(){var I=CA.transition;CA.transition=1;try{A(g)}finally{CA.transition=I}}),[g]),C},useTransition:function(){var g=sA(ZA)[0];return[yA().current,g]},useMutableSource:mA,useOpaqueIdentifier:function(){return sA(ZA)[0]},unstable_isNewReconciler:!1},LA={readContext:bC,useCallback:wA,useContext:bC,useEffect:XA,useImperativeHandle:RA,useLayoutEffect:KA,useMemo:NA,useReducer:tA,useRef:yA,useState:function(){return tA(ZA)},useDebugValue:HA,useDeferredValue:function(g){var I=tA(ZA),C=I[0],A=I[1];return XA((function(){var I=CA.transition;CA.transition=1;try{A(g)}finally{CA.transition=I}}),[g]),C},useTransition:function(){var g=tA(ZA)[0];return[yA().current,g]},useMutableSource:mA,useOpaqueIdentifier:function(){return tA(ZA)[0]},unstable_isNewReconciler:!1},fA=c.ReactCurrentOwner,MA=!1;function QA(g,I,C,A){I.child=null===g?wC(I,null,C,A):HC(I,g.child,C,A)}function xA(g,I,C,A,l){C=C.render;var o=I.ref;return nC(I,l),A=bA(g,I,C,A,o,l),null===g||MA?(I.flags|=1,QA(g,I,A,l),I.child):(I.updateQueue=g.updateQueue,I.flags&=-517,g.lanes&=~l,nl(g,I,l))}function UA(g,I,C,A,l,o){if(null===g){var e=C.type;return"function"!==typeof e||re(e)||void 0!==e.defaultProps||null!==C.compare||void 0!==C.defaultProps?((g=pe(C.type,null,A,I,I.mode,o)).ref=I.ref,g.return=I,I.child=g):(I.tag=15,I.type=e,TA(g,I,e,A,l,o))}return e=g.child,0===(l&o)&&(l=e.memoizedProps,(C=null!==(C=C.compare)?C:$I)(l,A)&&g.ref===I.ref)?nl(g,I,o):(I.flags|=1,(g=ye(e,A)).ref=I.ref,g.return=I,I.child=g)}function TA(g,I,C,A,l,o){if(null!==g&&$I(g.memoizedProps,A)&&g.ref===I.ref){if(MA=!1,0===(o&l))return I.lanes=g.lanes,nl(g,I,o);0!==(16384&g.flags)&&(MA=!0)}return EA(g,I,C,A,o)}function jA(g,I,C){var A=I.pendingProps,l=A.children,o=null!==g?g.memoizedState:null;if("hidden"===A.mode||"unstable-defer-without-hiding"===A.mode)if(0===(4&I.mode))I.memoizedState={baseLanes:0},jo(I,C);else{if(0===(1073741824&C))return g=null!==o?o.baseLanes|C:C,I.lanes=I.childLanes=1073741824,I.memoizedState={baseLanes:g},jo(I,g),null;I.memoizedState={baseLanes:0},jo(I,null!==o?o.baseLanes:C)}else null!==o?(A=o.baseLanes|C,I.memoizedState=null):A=C,jo(I,A);return QA(g,I,l,C),I.child}function DA(g,I){var C=I.ref;(null===g&&null!==C||null!==g&&g.ref!==C)&&(I.flags|=128)}function EA(g,I,C,A,l){var o=oI(C)?AI:II.current;return o=lI(I,o),nC(I,l),C=bA(g,I,C,A,o,l),null===g||MA?(I.flags|=1,QA(g,I,C,l),I.child):(I.updateQueue=g.updateQueue,I.flags&=-517,g.lanes&=~l,nl(g,I,l))}function OA(g,I,C,A,l){if(oI(C)){var o=!0;aI(I)}else o=!1;if(nC(I,l),null===I.stateNode)null!==g&&(g.alternate=null,I.alternate=null,I.flags|=2),pC(I,C,A),vC(I,C,A,l),A=!0;else if(null===g){var e=I.stateNode,i=I.memoizedProps;e.props=i;var c=e.context,a=C.contextType;"object"===typeof a&&null!==a?a=bC(a):a=lI(I,a=oI(C)?AI:II.current);var n=C.getDerivedStateFromProps,b="function"===typeof n||"function"===typeof e.getSnapshotBeforeUpdate;b||"function"!==typeof e.UNSAFE_componentWillReceiveProps&&"function"!==typeof e.componentWillReceiveProps||(i!==A||c!==a)&&VC(I,e,A,a),dC=!1;var d=I.memoizedState;e.state=d,uC(I,A,e,l),c=I.memoizedState,i!==A||d!==c||CI.current||dC?("function"===typeof n&&(WC(I,C,n,A),c=I.memoizedState),(i=dC||yC(I,C,i,A,d,c,a))?(b||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||("function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount()),"function"===typeof e.componentDidMount&&(I.flags|=4)):("function"===typeof e.componentDidMount&&(I.flags|=4),I.memoizedProps=A,I.memoizedState=c),e.props=A,e.state=c,e.context=a,A=i):("function"===typeof e.componentDidMount&&(I.flags|=4),A=!1)}else{e=I.stateNode,ZC(g,I),i=I.memoizedProps,a=I.type===I.elementType?i:IC(I.type,i),e.props=a,b=I.pendingProps,d=e.context,"object"===typeof(c=C.contextType)&&null!==c?c=bC(c):c=lI(I,c=oI(C)?AI:II.current);var G=C.getDerivedStateFromProps;(n="function"===typeof G||"function"===typeof e.getSnapshotBeforeUpdate)||"function"!==typeof e.UNSAFE_componentWillReceiveProps&&"function"!==typeof e.componentWillReceiveProps||(i!==b||d!==c)&&VC(I,e,A,c),dC=!1,d=I.memoizedState,e.state=d,uC(I,A,e,l);var Z=I.memoizedState;i!==b||d!==Z||CI.current||dC?("function"===typeof G&&(WC(I,C,G,A),Z=I.memoizedState),(a=dC||yC(I,C,a,A,d,Z,c))?(n||"function"!==typeof e.UNSAFE_componentWillUpdate&&"function"!==typeof e.componentWillUpdate||("function"===typeof e.componentWillUpdate&&e.componentWillUpdate(A,Z,c),"function"===typeof e.UNSAFE_componentWillUpdate&&e.UNSAFE_componentWillUpdate(A,Z,c)),"function"===typeof e.componentDidUpdate&&(I.flags|=4),"function"===typeof e.getSnapshotBeforeUpdate&&(I.flags|=256)):("function"!==typeof e.componentDidUpdate||i===g.memoizedProps&&d===g.memoizedState||(I.flags|=4),"function"!==typeof e.getSnapshotBeforeUpdate||i===g.memoizedProps&&d===g.memoizedState||(I.flags|=256),I.memoizedProps=A,I.memoizedState=Z),e.props=A,e.state=Z,e.context=c,A=a):("function"!==typeof e.componentDidUpdate||i===g.memoizedProps&&d===g.memoizedState||(I.flags|=4),"function"!==typeof e.getSnapshotBeforeUpdate||i===g.memoizedProps&&d===g.memoizedState||(I.flags|=256),A=!1)}return PA(g,I,C,A,o,l)}function PA(g,I,C,A,l,o){DA(g,I);var e=0!==(64&I.flags);if(!A&&!e)return l&&nI(I,C,!1),nl(g,I,o);A=I.stateNode,fA.current=I;var i=e&&"function"!==typeof C.getDerivedStateFromError?null:A.render();return I.flags|=1,null!==g&&e?(I.child=HC(I,g.child,null,o),I.child=HC(I,null,i,o)):QA(g,I,i,o),I.memoizedState=A.state,l&&nI(I,C,!0),I.child}function qA(g){var I=g.stateNode;I.pendingContext?iI(0,I.pendingContext,I.pendingContext!==I.context):I.context&&iI(0,I.context,!1),JC(g,I.containerInfo)}var _A,$A,gl,Il,Cl={dehydrated:null,retryLane:0};function Al(g,I,C){var A,l=I.pendingProps,o=QC.current,e=!1;return(A=0!==(64&I.flags))||(A=(null===g||null!==g.memoizedState)&&0!==(2&o)),A?(e=!0,I.flags&=-65):null!==g&&null===g.memoizedState||void 0===l.fallback||!0===l.unstable_avoidThisFallback||(o|=1),$g(QC,1&o),null===g?(void 0!==l.fallback&&OC(I),g=l.children,o=l.fallback,e?(g=ll(I,g,o,C),I.child.memoizedState={baseLanes:C},I.memoizedState=Cl,g):"number"===typeof l.unstable_expectedLoadTime?(g=ll(I,g,o,C),I.child.memoizedState={baseLanes:C},I.memoizedState=Cl,I.lanes=33554432,g):((C=ve({mode:"visible",children:g},I.mode,C,null)).return=I,I.child=C)):(g.memoizedState,e?(l=el(g,I,l.children,l.fallback,C),e=I.child,o=g.child.memoizedState,e.memoizedState=null===o?{baseLanes:C}:{baseLanes:o.baseLanes|C},e.childLanes=g.childLanes&~C,I.memoizedState=Cl,l):(C=ol(g,I,l.children,C),I.memoizedState=null,C))}function ll(g,I,C,A){var l=g.mode,o=g.child;return I={mode:"hidden",children:I},0===(2&l)&&null!==o?(o.childLanes=0,o.pendingProps=I):o=ve(I,l,0,null),C=Ve(C,l,A,null),o.return=g,C.return=g,o.sibling=C,g.child=o,C}function ol(g,I,C,A){var l=g.child;return g=l.sibling,C=ye(l,{mode:"visible",children:C}),0===(2&I.mode)&&(C.lanes=A),C.return=I,C.sibling=null,null!==g&&(g.nextEffect=null,g.flags=8,I.firstEffect=I.lastEffect=g),I.child=C}function el(g,I,C,A,l){var o=I.mode,e=g.child;g=e.sibling;var i={mode:"hidden",children:C};return 0===(2&o)&&I.child!==e?((C=I.child).childLanes=0,C.pendingProps=i,null!==(e=C.lastEffect)?(I.firstEffect=C.firstEffect,I.lastEffect=e,e.nextEffect=null):I.firstEffect=I.lastEffect=null):C=ye(e,i),null!==g?A=ye(g,A):(A=Ve(A,o,l,null)).flags|=2,A.return=I,C.return=I,C.sibling=A,I.child=C,A}function il(g,I){g.lanes|=I;var C=g.alternate;null!==C&&(C.lanes|=I),aC(g.return,I)}function cl(g,I,C,A,l,o){var e=g.memoizedState;null===e?g.memoizedState={isBackwards:I,rendering:null,renderingStartTime:0,last:A,tail:C,tailMode:l,lastEffect:o}:(e.isBackwards=I,e.rendering=null,e.renderingStartTime=0,e.last=A,e.tail=C,e.tailMode=l,e.lastEffect=o)}function al(g,I,C){var A=I.pendingProps,l=A.revealOrder,o=A.tail;if(QA(g,I,A.children,C),0!==(2&(A=QC.current)))A=1&A|2,I.flags|=64;else{if(null!==g&&0!==(64&g.flags))g:for(g=I.child;null!==g;){if(13===g.tag)null!==g.memoizedState&&il(g,C);else if(19===g.tag)il(g,C);else if(null!==g.child){g.child.return=g,g=g.child;continue}if(g===I)break g;for(;null===g.sibling;){if(null===g.return||g.return===I)break g;g=g.return}g.sibling.return=g.return,g=g.sibling}A&=1}if($g(QC,A),0===(2&I.mode))I.memoizedState=null;else switch(l){case"forwards":for(C=I.child,l=null;null!==C;)null!==(g=C.alternate)&&null===xC(g)&&(l=C),C=C.sibling;null===(C=l)?(l=I.child,I.child=null):(l=C.sibling,C.sibling=null),cl(I,!1,l,C,o,I.lastEffect);break;case"backwards":for(C=null,l=I.child,I.child=null;null!==l;){if(null!==(g=l.alternate)&&null===xC(g)){I.child=l;break}g=l.sibling,l.sibling=C,C=l,l=g}cl(I,!0,C,null,o,I.lastEffect);break;case"together":cl(I,!1,null,null,void 0,I.lastEffect);break;default:I.memoizedState=null}return I.child}function nl(g,I,C){if(null!==g&&(I.dependencies=g.dependencies),no|=I.lanes,0!==(C&I.childLanes)){if(null!==g&&I.child!==g.child)throw Error(i(153));if(null!==I.child){for(C=ye(g=I.child,g.pendingProps),I.child=C,C.return=I;null!==g.sibling;)g=g.sibling,(C=C.sibling=ye(g,g.pendingProps)).return=I;C.sibling=null}return I.child}return null}function bl(g){g.flags|=4}if(P)_A=function(g,I){for(var C=I.child;null!==C;){if(5===C.tag||6===C.tag)M(g,C.stateNode);else if(4!==C.tag&&null!==C.child){C.child.return=C,C=C.child;continue}if(C===I)break;for(;null===C.sibling;){if(null===C.return||C.return===I)return;C=C.return}C.sibling.return=C.return,C=C.sibling}},$A=function(){},gl=function(g,I,C,A,l){if((g=g.memoizedProps)!==A){var o=I.stateNode,e=kC(FC.current);C=x(o,C,g,A,l,e),(I.updateQueue=C)&&bl(I)}},Il=function(g,I,C,A){C!==A&&bl(I)};else if(q){_A=function(g,I,C,A){for(var l=I.child;null!==l;){if(5===l.tag){var o=l.stateNode;C&&A&&(o=Ng(o,l.type,l.memoizedProps,l)),M(g,o)}else if(6===l.tag)o=l.stateNode,C&&A&&(o=Fg(o,l.memoizedProps,l)),M(g,o);else if(4!==l.tag){if(13===l.tag&&0!==(4&l.flags)&&(o=null!==l.memoizedState)){var e=l.child;if(null!==e&&(null!==e.child&&(e.child.return=e,_A(g,e,!0,o)),null!==(o=e.sibling))){o.return=l,l=o;continue}}if(null!==l.child){l.child.return=l,l=l.child;continue}}if(l===I)break;for(;null===l.sibling;){if(null===l.return||l.return===I)return;l=l.return}l.sibling.return=l.return,l=l.sibling}};var dl=function g(I,C,A,l){for(var o=C.child;null!==o;){if(5===o.tag){var e=o.stateNode;A&&l&&(e=Ng(e,o.type,o.memoizedProps,o)),Rg(I,e)}else if(6===o.tag)e=o.stateNode,A&&l&&(e=Fg(e,o.memoizedProps,o)),Rg(I,e);else if(4!==o.tag){if(13===o.tag&&0!==(4&o.flags)&&(e=null!==o.memoizedState)){var i=o.child;if(null!==i&&(null!==i.child&&(i.child.return=i,g(I,i,!0,e)),null!==(e=i.sibling))){e.return=o,o=e;continue}}if(null!==o.child){o.child.return=o,o=o.child;continue}}if(o===C)break;for(;null===o.sibling;){if(null===o.return||o.return===C)return;o=o.return}o.sibling.return=o.return,o=o.sibling}};$A=function(g){var I=g.stateNode;if(null!==g.firstEffect){var C=I.containerInfo,A=Yg(C);dl(A,g,!1,!1),I.pendingChildren=A,bl(g),Hg(C,A)}},gl=function(g,I,C,A,l){var o=g.stateNode,e=g.memoizedProps;if((g=null===I.firstEffect)&&e===A)I.stateNode=o;else{var i=I.stateNode,c=kC(FC.current),a=null;e!==A&&(a=x(i,C,e,A,l,c)),g&&null===a?I.stateNode=o:(o=Kg(o,a,C,e,A,I,g,i),Q(o,C,A,l,c)&&bl(I),I.stateNode=o,g?bl(I):_A(o,I,!1,!1))}},Il=function(g,I,C,A){C!==A?(g=kC(zC.current),C=kC(FC.current),I.stateNode=T(A,g,C,I),bl(I)):I.stateNode=g.stateNode}}else $A=function(){},gl=function(){},Il=function(){};function Gl(g,I){if(!jC)switch(g.tailMode){case"hidden":I=g.tail;for(var C=null;null!==I;)null!==I.alternate&&(C=I),I=I.sibling;null===C?g.tail=null:C.sibling=null;break;case"collapsed":C=g.tail;for(var A=null;null!==C;)null!==C.alternate&&(A=C),C=C.sibling;null===A?I||null===g.tail?g.tail=null:g.tail.sibling=null:A.sibling=null}}function Zl(g,I,C){var A=I.pendingProps;switch(I.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:case 17:return oI(I.type)&&eI(),null;case 3:return LC(),_g(CI),_g(II),gA(),(A=I.stateNode).pendingContext&&(A.context=A.pendingContext,A.pendingContext=null),null!==g&&null!==g.child||(qC(I)?bl(I):A.hydrate||(I.flags|=256)),$A(I),null;case 5:MC(I);var l=kC(zC.current);if(C=I.type,null!==g&&null!=I.stateNode)gl(g,I,C,A,l),g.ref!==I.ref&&(I.flags|=128);else{if(!A){if(null===I.stateNode)throw Error(i(166));return null}if(g=kC(FC.current),qC(I)){if(!_)throw Error(i(175));g=Mg(I.stateNode,I.type,I.memoizedProps,l,g,I),I.updateQueue=g,null!==g&&bl(I)}else{var o=f(C,A,l,g,I);_A(o,I,!1,!1),I.stateNode=o,Q(o,C,A,l,g)&&bl(I)}null!==I.ref&&(I.flags|=128)}return null;case 6:if(g&&null!=I.stateNode)Il(g,I,g.memoizedProps,A);else{if("string"!==typeof A&&null===I.stateNode)throw Error(i(166));if(g=kC(zC.current),l=kC(FC.current),qC(I)){if(!_)throw Error(i(176));Qg(I.stateNode,I.memoizedProps,I)&&bl(I)}else I.stateNode=T(A,g,l,I)}return null;case 13:return _g(QC),A=I.memoizedState,0!==(64&I.flags)?(I.lanes=C,I):(A=null!==A,l=!1,null===g?void 0!==I.memoizedProps.fallback&&qC(I):l=null!==g.memoizedState,A&&!l&&0!==(2&I.mode)&&(null===g&&!0!==I.memoizedProps.unstable_avoidThisFallback||0!==(1&QC.current)?0===io&&(io=3):(0!==io&&3!==io||(io=4),null===Co||0===(134217727&no)&&0===(134217727&bo)||Qo(Co,lo))),q&&A&&(I.flags|=4),P&&(A||l)&&(I.flags|=4),null);case 4:return LC(),$A(I),null===g&&lg(I.stateNode.containerInfo),null;case 10:return cC(I),null;case 19:if(_g(QC),null===(A=I.memoizedState))return null;if(l=0!==(64&I.flags),null===(o=A.rendering))if(l)Gl(A,!1);else{if(0!==io||null!==g&&0!==(64&g.flags))for(g=I.child;null!==g;){if(null!==(o=xC(g))){for(I.flags|=64,Gl(A,!1),null!==(g=o.updateQueue)&&(I.updateQueue=g,I.flags|=4),null===A.lastEffect&&(I.firstEffect=null),I.lastEffect=A.lastEffect,g=C,A=I.child;null!==A;)C=g,(l=A).flags&=2,l.nextEffect=null,l.firstEffect=null,l.lastEffect=null,null===(o=l.alternate)?(l.childLanes=0,l.lanes=C,l.child=null,l.memoizedProps=null,l.memoizedState=null,l.updateQueue=null,l.dependencies=null,l.stateNode=null):(l.childLanes=o.childLanes,l.lanes=o.lanes,l.child=o.child,l.memoizedProps=o.memoizedProps,l.memoizedState=o.memoizedState,l.updateQueue=o.updateQueue,l.type=o.type,C=o.dependencies,l.dependencies=null===C?null:{lanes:C.lanes,firstContext:C.firstContext}),A=A.sibling;return $g(QC,1&QC.current|2),I.child}g=g.sibling}null!==A.tail&&xI()>to&&(I.flags|=64,l=!0,Gl(A,!1),I.lanes=33554432)}else{if(!l)if(null!==(g=xC(o))){if(I.flags|=64,l=!0,null!==(g=g.updateQueue)&&(I.updateQueue=g,I.flags|=4),Gl(A,!0),null===A.tail&&"hidden"===A.tailMode&&!o.alternate&&!jC)return null!==(I=I.lastEffect=A.lastEffect)&&(I.nextEffect=null),null}else 2*xI()-A.renderingStartTime>to&&1073741824!==C&&(I.flags|=64,l=!0,Gl(A,!1),I.lanes=33554432);A.isBackwards?(o.sibling=I.child,I.child=o):(null!==(g=A.last)?g.sibling=o:I.child=o,A.last=o)}return null!==A.tail?(g=A.tail,A.rendering=g,A.tail=g.sibling,A.lastEffect=I.lastEffect,A.renderingStartTime=xI(),g.sibling=null,I=QC.current,$g(QC,l?1&I|2:1&I),g):null;case 23:case 24:return Do(),null!==g&&null!==g.memoizedState!==(null!==I.memoizedState)&&"unstable-defer-without-hiding"!==A.mode&&(I.flags|=4),null}throw Error(i(156,I.tag))}function sl(g){switch(g.tag){case 1:oI(g.type)&&eI();var I=g.flags;return 4096&I?(g.flags=-4097&I|64,g):null;case 3:if(LC(),_g(CI),_g(II),gA(),0!==(64&(I=g.flags)))throw Error(i(285));return g.flags=-4097&I|64,g;case 5:return MC(g),null;case 13:return _g(QC),4096&(I=g.flags)?(g.flags=-4097&I|64,g):null;case 19:return _g(QC),null;case 4:return LC(),null;case 10:return cC(g),null;case 23:case 24:return Do(),null;default:return null}}function tl(g,I){try{var C="",A=I;do{C+=gC(A),A=A.return}while(A);var l=C}catch(o){l="\nError generating stack: "+o.message+"\n"+o.stack}return{value:g,source:I,stack:l}}function Bl(g,I){try{console.error(I.value)}catch(C){setTimeout((function(){throw C}))}}var ul="function"===typeof WeakMap?WeakMap:Map;function ml(g,I,C){(C=sC(-1,C)).tag=3,C.payload={element:null};var A=I.value;return C.callback=function(){ho||(ho=!0,Wo=A),Bl(0,I)},C}function hl(g,I,C){(C=sC(-1,C)).tag=3;var A=g.type.getDerivedStateFromError;if("function"===typeof A){var l=I.value;C.payload=function(){return Bl(0,I),A(l)}}var o=g.stateNode;return null!==o&&"function"===typeof o.componentDidCatch&&(C.callback=function(){"function"!==typeof A&&(null===ro?ro=new Set([this]):ro.add(this),Bl(0,I));var g=I.stack;this.componentDidCatch(I.value,{componentStack:null!==g?g:""})}),C}var Wl="function"===typeof WeakSet?WeakSet:Set;function rl(g){var I=g.ref;if(null!==I)if("function"===typeof I)try{I(null)}catch(C){ne(g,C)}else I.current=null}function yl(g,I){switch(I.tag){case 0:case 11:case 15:case 22:case 5:case 6:case 4:case 17:return;case 1:if(256&I.flags&&null!==g){var C=g.memoizedProps,A=g.memoizedState;I=(g=I.stateNode).getSnapshotBeforeUpdate(I.elementType===I.type?C:IC(I.type,C),A),g.__reactInternalSnapshotBeforeUpdate=I}return;case 3:return void(P&&256&I.flags&&Xg(I.stateNode.containerInfo))}throw Error(i(163))}function pl(g,I){if(null!==(I=null!==(I=I.updateQueue)?I.lastEffect:null)){var C=I=I.next;do{if((C.tag&g)===g){var A=C.destroy;C.destroy=void 0,void 0!==A&&A()}C=C.next}while(C!==I)}}function Vl(g,I,C){switch(C.tag){case 0:case 11:case 15:case 22:if(null!==(I=null!==(I=C.updateQueue)?I.lastEffect:null)){g=I=I.next;do{if(3===(3&g.tag)){var A=g.create;g.destroy=A()}g=g.next}while(g!==I)}if(null!==(I=null!==(I=C.updateQueue)?I.lastEffect:null)){g=I=I.next;do{var l=g;A=l.next,0!==(4&(l=l.tag))&&0!==(1&l)&&(ie(C,g),ee(C,g)),g=A}while(g!==I)}return;case 1:return g=C.stateNode,4&C.flags&&(null===I?g.componentDidMount():(A=C.elementType===C.type?I.memoizedProps:IC(C.type,I.memoizedProps),g.componentDidUpdate(A,I.memoizedState,g.__reactInternalSnapshotBeforeUpdate))),void(null!==(I=C.updateQueue)&&mC(C,I,g));case 3:if(null!==(I=C.updateQueue)){if(g=null,null!==C.child)switch(C.child.tag){case 5:g=S(C.child.stateNode);break;case 1:g=C.child.stateNode}mC(C,I,g)}return;case 5:return g=C.stateNode,void(null===I&&4&C.flags&&tg(g,C.type,C.memoizedProps,C));case 6:case 4:case 12:case 19:case 17:case 20:case 21:case 23:case 24:return;case 13:return void(_&&null===C.memoizedState&&(C=C.alternate,null!==C&&(C=C.memoizedState,null!==C&&(C=C.dehydrated,null!==C&&Tg(C)))))}throw Error(i(163))}function vl(g,I){if(P)for(var C=g;;){if(5===C.tag){var A=C.stateNode;I?yg(A):Vg(C.stateNode,C.memoizedProps)}else if(6===C.tag)A=C.stateNode,I?pg(A):vg(A,C.memoizedProps);else if((23!==C.tag&&24!==C.tag||null===C.memoizedState||C===g)&&null!==C.child){C.child.return=C,C=C.child;continue}if(C===g)break;for(;null===C.sibling;){if(null===C.return||C.return===g)return;C=C.return}C.sibling.return=C.return,C=C.sibling}}function Xl(g,I){if(dI&&"function"===typeof dI.onCommitFiberUnmount)try{dI.onCommitFiberUnmount(bI,I)}catch(o){}switch(I.tag){case 0:case 11:case 14:case 15:case 22:if(null!==(g=I.updateQueue)&&null!==(g=g.lastEffect)){var C=g=g.next;do{var A=C,l=A.destroy;if(A=A.tag,void 0!==l)if(0!==(4&A))ie(I,C);else{A=I;try{l()}catch(o){ne(A,o)}}C=C.next}while(C!==g)}break;case 1:if(rl(I),"function"===typeof(g=I.stateNode).componentWillUnmount)try{g.props=I.memoizedProps,g.state=I.memoizedState,g.componentWillUnmount()}catch(o){ne(I,o)}break;case 5:rl(I);break;case 4:P?Fl(g,I):q&&q&&(I=I.stateNode.containerInfo,g=Yg(I),wg(I,g))}}function Kl(g,I){for(var C=I;;)if(Xl(g,C),null===C.child||P&&4===C.tag){if(C===I)break;for(;null===C.sibling;){if(null===C.return||C.return===I)return;C=C.return}C.sibling.return=C.return,C=C.sibling}else C.child.return=C,C=C.child}function Yl(g){g.alternate=null,g.child=null,g.dependencies=null,g.firstEffect=null,g.lastEffect=null,g.memoizedProps=null,g.memoizedState=null,g.pendingProps=null,g.return=null,g.updateQueue=null}function Rl(g){return 5===g.tag||3===g.tag||4===g.tag}function Hl(g){if(P){g:{for(var I=g.return;null!==I;){if(Rl(I))break g;I=I.return}throw Error(i(160))}var C=I;switch(I=C.stateNode,C.tag){case 5:var A=!1;break;case 3:case 4:I=I.containerInfo,A=!0;break;default:throw Error(i(161))}16&C.flags&&(rg(I),C.flags&=-17);g:I:for(C=g;;){for(;null===C.sibling;){if(null===C.return||Rl(C.return)){C=null;break g}C=C.return}for(C.sibling.return=C.return,C=C.sibling;5!==C.tag&&6!==C.tag&&18!==C.tag;){if(2&C.flags)continue I;if(null===C.child||4===C.tag)continue I;C.child.return=C,C=C.child}if(!(2&C.flags)){C=C.stateNode;break g}}A?wl(g,C,I):Nl(g,C,I)}}function wl(g,I,C){var A=g.tag,l=5===A||6===A;if(l)g=l?g.stateNode:g.stateNode.instance,I?mg(C,g,I):Zg(C,g);else if(4!==A&&null!==(g=g.child))for(wl(g,I,C),g=g.sibling;null!==g;)wl(g,I,C),g=g.sibling}function Nl(g,I,C){var A=g.tag,l=5===A||6===A;if(l)g=l?g.stateNode:g.stateNode.instance,I?ug(C,g,I):Gg(C,g);else if(4!==A&&null!==(g=g.child))for(Nl(g,I,C),g=g.sibling;null!==g;)Nl(g,I,C),g=g.sibling}function Fl(g,I){for(var C,A,l=I,o=!1;;){if(!o){o=l.return;g:for(;;){if(null===o)throw Error(i(160));switch(C=o.stateNode,o.tag){case 5:A=!1;break g;case 3:case 4:C=C.containerInfo,A=!0;break g}o=o.return}o=!0}if(5===l.tag||6===l.tag)Kl(g,l),A?Wg(C,l.stateNode):hg(C,l.stateNode);else if(4===l.tag){if(null!==l.child){C=l.stateNode.containerInfo,A=!0,l.child.return=l,l=l.child;continue}}else if(Xl(g,l),null!==l.child){l.child.return=l,l=l.child;continue}if(l===I)break;for(;null===l.sibling;){if(null===l.return||l.return===I)return;4===(l=l.return).tag&&(o=!1)}l.sibling.return=l.return,l=l.sibling}}function Sl(g,I){if(P){switch(I.tag){case 0:case 11:case 14:case 15:case 22:return void pl(3,I);case 1:case 12:case 17:return;case 5:var C=I.stateNode;if(null!=C){var A=I.memoizedProps;g=null!==g?g.memoizedProps:A;var l=I.type,o=I.updateQueue;I.updateQueue=null,null!==o&&Bg(C,o,l,g,A,I)}return;case 6:if(null===I.stateNode)throw Error(i(162));return C=I.memoizedProps,void sg(I.stateNode,null!==g?g.memoizedProps:C,C);case 3:return void(_&&(I=I.stateNode,I.hydrate&&(I.hydrate=!1,Ug(I.containerInfo))));case 13:return zl(I),void kl(I);case 19:return void kl(I);case 23:case 24:return void vl(I,null!==I.memoizedState)}throw Error(i(163))}switch(I.tag){case 0:case 11:case 14:case 15:case 22:return void pl(3,I);case 12:case 23:case 24:return;case 13:return zl(I),void kl(I);case 19:return void kl(I);case 3:_&&((C=I.stateNode).hydrate&&(C.hydrate=!1,Ug(C.containerInfo)))}g:if(q){switch(I.tag){case 1:case 5:case 6:case 20:break g;case 3:case 4:I=I.stateNode,wg(I.containerInfo,I.pendingChildren);break g}throw Error(i(163))}}function zl(g){null!==g.memoizedState&&(so=xI(),P&&vl(g.child,!0))}function kl(g){var I=g.updateQueue;if(null!==I){g.updateQueue=null;var C=g.stateNode;null===C&&(C=g.stateNode=new Wl),I.forEach((function(I){var A=de.bind(null,g,I);C.has(I)||(C.add(I),I.then(A,A))}))}}function Jl(g,I){return null!==g&&(null===(g=g.memoizedState)||null!==g.dehydrated)&&(null!==(I=I.memoizedState)&&null===I.dehydrated)}var Ll=0,fl=1,Ml=2,Ql=3,xl=4;if("function"===typeof Symbol&&Symbol.for){var Ul=Symbol.for;Ll=Ul("selector.component"),fl=Ul("selector.has_pseudo_class"),Ml=Ul("selector.role"),Ql=Ul("selector.test_id"),xl=Ul("selector.text")}function Tl(g){var I=$(g);if(null!=I){if("string"!==typeof I.memoizedProps["data-testname"])throw Error(i(364));return I}if(null===(g=eg(g)))throw Error(i(362));return g.stateNode.current}function jl(g,I){switch(I.$$typeof){case Ll:if(g.type===I.value)return!0;break;case fl:g:{I=I.value,g=[g,0];for(var C=0;C<g.length;){var A=g[C++],l=g[C++],o=I[l];if(5!==A.tag||!ag(A)){for(;null!=o&&jl(A,o);)o=I[++l];if(l===I.length){I=!0;break g}for(A=A.child;null!==A;)g.push(A,l),A=A.sibling}}I=!1}return I;case Ml:if(5===g.tag&&ng(g.stateNode,I.value))return!0;break;case xl:if((5===g.tag||6===g.tag)&&(null!==(g=cg(g))&&0<=g.indexOf(I.value)))return!0;break;case Ql:if(5===g.tag&&("string"===typeof(g=g.memoizedProps["data-testname"])&&g.toLowerCase()===I.value.toLowerCase()))return!0;break;default:throw Error(i(365,I))}return!1}function Dl(g){switch(g.$$typeof){case Ll:return"<"+(K(g.value)||"Unknown")+">";case fl:return":has("+(Dl(g)||"")+")";case Ml:return'[role="'+g.value+'"]';case xl:return'"'+g.value+'"';case Ql:return'[data-testname="'+g.value+'"]';default:throw Error(i(365,g))}}function El(g,I){var C=[];g=[g,0];for(var A=0;A<g.length;){var l=g[A++],o=g[A++],e=I[o];if(5!==l.tag||!ag(l)){for(;null!=e&&jl(l,e);)e=I[++o];if(o===I.length)C.push(l);else for(l=l.child;null!==l;)g.push(l,o),l=l.sibling}}return C}function Ol(g,I){if(!og)throw Error(i(363));g=El(g=Tl(g),I),I=[],g=Array.from(g);for(var C=0;C<g.length;){var A=g[C++];if(5===A.tag)ag(A)||I.push(A.stateNode);else for(A=A.child;null!==A;)g.push(A),A=A.sibling}return I}var Pl=null;var ql=Math.ceil,_l=c.ReactCurrentDispatcher,$l=c.ReactCurrentOwner,go=c.IsSomeRendererActing,Io=0,Co=null,Ao=null,lo=0,oo=0,eo=qg(0),io=0,co=null,ao=0,no=0,bo=0,Go=0,Zo=null,so=0,to=1/0;function Bo(){to=xI()+500}var uo,mo=null,ho=!1,Wo=null,ro=null,yo=!1,po=null,Vo=90,vo=[],Xo=[],Ko=null,Yo=0,Ro=null,Ho=-1,wo=0,No=0,Fo=null,So=!1;function zo(){return 0!==(48&Io)?xI():-1!==Ho?Ho:Ho=xI()}function ko(g){if(0===(2&(g=g.mode)))return 1;if(0===(4&g))return 99===UI()?1:2;if(0===wo&&(wo=ao),0!==PI.transition){0!==No&&(No=null!==Zo?Zo.pendingLanes:0),g=wo;var I=4186112&~No;return 0===(I&=-I)&&(0===(I=(g=4186112&~g)&-g)&&(I=8192)),I}return g=UI(),0!==(4&Io)&&98===g?g=uI(12,wo):g=uI(g=function(g){switch(g){case 99:return 15;case 98:return 10;case 97:case 96:return 8;case 95:return 2;default:return 0}}(g),wo),g}function Jo(g,I,C){if(50<Yo)throw Yo=0,Ro=null,Error(i(185));if(null===(g=Lo(g,I)))return null;WI(g,I,C),g===Co&&(bo|=I,4===io&&Qo(g,lo));var A=UI();1===I?0!==(8&Io)&&0===(48&Io)?xo(g):(fo(g,C),0===Io&&(Bo(),EI())):(0===(4&Io)||98!==A&&99!==A||(null===Ko?Ko=new Set([g]):Ko.add(g)),fo(g,C)),Zo=g}function Lo(g,I){g.lanes|=I;var C=g.alternate;for(null!==C&&(C.lanes|=I),C=g,g=g.return;null!==g;)g.childLanes|=I,null!==(C=g.alternate)&&(C.childLanes|=I),C=g,g=g.return;return 3===C.tag?C.stateNode:null}function fo(g,I){for(var C=g.callbackNode,A=g.suspendedLanes,l=g.pingedLanes,o=g.expirationTimes,e=g.pendingLanes;0<e;){var c=31-rI(e),a=1<<c,n=o[c];if(-1===n){if(0===(a&A)||0!==(a&l)){n=I,sI(a);var b=ZI;o[c]=10<=b?n+250:6<=b?n+5e3:-1}}else n<=I&&(g.expiredLanes|=a);e&=~a}if(A=tI(g,g===Co?lo:0),I=ZI,0===A)null!==C&&(C!==kI&&XI(C),g.callbackNode=null,g.callbackPriority=0);else{if(null!==C){if(g.callbackPriority===I)return;C!==kI&&XI(C)}15===I?(C=xo.bind(null,g),null===LI?(LI=[C],fI=vI(wI,OI)):LI.push(C),C=kI):14===I?C=DI(99,xo.bind(null,g)):(C=function(g){switch(g){case 15:case 14:return 99;case 13:case 12:case 11:case 10:return 98;case 9:case 8:case 7:case 6:case 4:case 5:return 97;case 3:case 2:case 1:return 95;case 0:return 90;default:throw Error(i(358,g))}}(I),C=DI(C,Mo.bind(null,g))),g.callbackPriority=I,g.callbackNode=C}}function Mo(g){if(Ho=-1,No=wo=0,0!==(48&Io))throw Error(i(327));var I=g.callbackNode;if(oe()&&g.callbackNode!==I)return null;var C=tI(g,g===Co?lo:0);if(0===C)return null;var A=C,l=Io;Io|=16;var o=Po();for(Co===g&&lo===A||(Bo(),Eo(g,A));;)try{$o();break}catch(c){Oo(g,c)}if(eC(),_l.current=o,Io=l,null!==Ao?A=0:(Co=null,lo=0,A=io),0!==(ao&bo))Eo(g,0);else if(0!==A){if(2===A&&(Io|=64,g.hydrate&&(g.hydrate=!1,Xg(g.containerInfo)),0!==(C=BI(g))&&(A=qo(g,C))),1===A)throw I=co,Eo(g,0),Qo(g,C),fo(g,xI()),I;switch(g.finishedWork=g.current.alternate,g.finishedLanes=C,A){case 0:case 1:throw Error(i(345));case 2:case 5:Ce(g);break;case 3:if(Qo(g,C),(62914560&C)===C&&10<(A=so+500-xI())){if(0!==tI(g,0))break;if(((l=g.suspendedLanes)&C)!==C){zo(),g.pingedLanes|=g.suspendedLanes&l;break}g.timeoutHandle=j(Ce.bind(null,g),A);break}Ce(g);break;case 4:if(Qo(g,C),(4186112&C)===C)break;for(A=g.eventTimes,l=-1;0<C;){var e=31-rI(C);o=1<<e,(e=A[e])>l&&(l=e),C&=~o}if(C=l,10<(C=(120>(C=xI()-C)?120:480>C?480:1080>C?1080:1920>C?1920:3e3>C?3e3:4320>C?4320:1960*ql(C/1960))-C)){g.timeoutHandle=j(Ce.bind(null,g),C);break}Ce(g);break;default:throw Error(i(329))}}return fo(g,xI()),g.callbackNode===I?Mo.bind(null,g):null}function Qo(g,I){for(I&=~Go,I&=~bo,g.suspendedLanes|=I,g.pingedLanes&=~I,g=g.expirationTimes;0<I;){var C=31-rI(I),A=1<<C;g[C]=-1,I&=~A}}function xo(g){if(0!==(48&Io))throw Error(i(327));if(oe(),g===Co&&0!==(g.expiredLanes&lo)){var I=lo,C=qo(g,I);0!==(ao&bo)&&(C=qo(g,I=tI(g,I)))}else C=qo(g,I=tI(g,0));if(0!==g.tag&&2===C&&(Io|=64,g.hydrate&&(g.hydrate=!1,Xg(g.containerInfo)),0!==(I=BI(g))&&(C=qo(g,I))),1===C)throw C=co,Eo(g,0),Qo(g,I),fo(g,xI()),C;return g.finishedWork=g.current.alternate,g.finishedLanes=I,Ce(g),fo(g,xI()),null}function Uo(g,I){var C=Io;Io|=1;try{return g(I)}finally{0===(Io=C)&&(Bo(),EI())}}function To(g,I){var C=Io;if(0!==(48&C))return g(I);Io|=1;try{if(g)return jI(99,g.bind(null,I))}finally{Io=C,EI()}}function jo(g,I){$g(eo,oo),oo|=I,ao|=I}function Do(){oo=eo.current,_g(eo)}function Eo(g,I){g.finishedWork=null,g.finishedLanes=0;var C=g.timeoutHandle;if(C!==E&&(g.timeoutHandle=E,D(C)),null!==Ao)for(C=Ao.return;null!==C;){var A=C;switch(A.tag){case 1:null!==(A=A.type.childContextTypes)&&void 0!==A&&eI();break;case 3:LC(),_g(CI),_g(II),gA();break;case 5:MC(A);break;case 4:LC();break;case 13:case 19:_g(QC);break;case 10:cC(A);break;case 23:case 24:Do()}C=C.return}Co=g,Ao=ye(g.current,null),lo=oo=ao=I,io=0,co=null,Go=bo=no=0}function Oo(g,I){for(;;){var C=Ao;try{if(eC(),IA.current=zA,iA){for(var A=lA.memoizedState;null!==A;){var l=A.queue;null!==l&&(l.pending=null),A=A.next}iA=!1}if(AA=0,eA=oA=lA=null,cA=!1,$l.current=null,null===C||null===C.return){io=1,co=I,Ao=null;break}g:{var o=g,e=C.return,i=C,c=I;if(I=lo,i.flags|=2048,i.firstEffect=i.lastEffect=null,null!==c&&"object"===typeof c&&"function"===typeof c.then){var a=c;if(0===(2&i.mode)){var n=i.alternate;n?(i.updateQueue=n.updateQueue,i.memoizedState=n.memoizedState,i.lanes=n.lanes):(i.updateQueue=null,i.memoizedState=null)}var b=0!==(1&QC.current),d=e;do{var G;if(G=13===d.tag){var Z=d.memoizedState;if(null!==Z)G=null!==Z.dehydrated;else{var s=d.memoizedProps;G=void 0!==s.fallback&&(!0!==s.unstable_avoidThisFallback||!b)}}if(G){var t=d.updateQueue;if(null===t){var B=new Set;B.add(a),d.updateQueue=B}else t.add(a);if(0===(2&d.mode)){if(d.flags|=64,i.flags|=16384,i.flags&=-2981,1===i.tag)if(null===i.alternate)i.tag=17;else{var u=sC(-1,1);u.tag=2,tC(i,u)}i.lanes|=1;break g}c=void 0,i=I;var m=o.pingCache;if(null===m?(m=o.pingCache=new ul,c=new Set,m.set(a,c)):void 0===(c=m.get(a))&&(c=new Set,m.set(a,c)),!c.has(i)){c.add(i);var h=be.bind(null,o,a,i);a.then(h,h)}d.flags|=4096,d.lanes=I;break g}d=d.return}while(null!==d);c=Error((K(i.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display.")}5!==io&&(io=2),c=tl(c,i),d=e;do{switch(d.tag){case 3:o=c,d.flags|=4096,I&=-I,d.lanes|=I,BC(d,ml(0,o,I));break g;case 1:o=c;var W=d.type,r=d.stateNode;if(0===(64&d.flags)&&("function"===typeof W.getDerivedStateFromError||null!==r&&"function"===typeof r.componentDidCatch&&(null===ro||!ro.has(r)))){d.flags|=4096,I&=-I,d.lanes|=I,BC(d,hl(d,o,I));break g}}d=d.return}while(null!==d)}Ie(C)}catch(y){I=y,Ao===C&&null!==C&&(Ao=C=C.return);continue}break}}function Po(){var g=_l.current;return _l.current=zA,null===g?zA:g}function qo(g,I){var C=Io;Io|=16;var A=Po();for(Co===g&&lo===I||Eo(g,I);;)try{_o();break}catch(l){Oo(g,l)}if(eC(),Io=C,_l.current=A,null!==Ao)throw Error(i(261));return Co=null,lo=0,io}function _o(){for(;null!==Ao;)ge(Ao)}function $o(){for(;null!==Ao&&!KI();)ge(Ao)}function ge(g){var I=uo(g.alternate,g,oo);g.memoizedProps=g.pendingProps,null===I?Ie(g):Ao=I,$l.current=null}function Ie(g){var I=g;do{var C=I.alternate;if(g=I.return,0===(2048&I.flags)){if(null!==(C=Zl(C,I,oo)))return void(Ao=C);if(24!==(C=I).tag&&23!==C.tag||null===C.memoizedState||0!==(1073741824&oo)||0===(4&C.mode)){for(var A=0,l=C.child;null!==l;)A|=l.lanes|l.childLanes,l=l.sibling;C.childLanes=A}null!==g&&0===(2048&g.flags)&&(null===g.firstEffect&&(g.firstEffect=I.firstEffect),null!==I.lastEffect&&(null!==g.lastEffect&&(g.lastEffect.nextEffect=I.firstEffect),g.lastEffect=I.lastEffect),1<I.flags&&(null!==g.lastEffect?g.lastEffect.nextEffect=I:g.firstEffect=I,g.lastEffect=I))}else{if(null!==(C=sl(I)))return C.flags&=2047,void(Ao=C);null!==g&&(g.firstEffect=g.lastEffect=null,g.flags|=2048)}if(null!==(I=I.sibling))return void(Ao=I);Ao=I=g}while(null!==I);0===io&&(io=5)}function Ce(g){var I=UI();return jI(99,Ae.bind(null,g,I)),null}function Ae(g,I){do{oe()}while(null!==po);if(0!==(48&Io))throw Error(i(327));var C=g.finishedWork;if(null===C)return null;if(g.finishedWork=null,g.finishedLanes=0,C===g.current)throw Error(i(177));g.callbackNode=null;var A=C.lanes|C.childLanes,l=A,o=g.pendingLanes&~l;g.pendingLanes=l,g.suspendedLanes=0,g.pingedLanes=0,g.expiredLanes&=l,g.mutableReadLanes&=l,g.entangledLanes&=l,l=g.entanglements;for(var e=g.eventTimes,c=g.expirationTimes;0<o;){var a=31-rI(o),n=1<<a;l[a]=0,e[a]=-1,c[a]=-1,o&=~n}if(null!==Ko&&0===(24&A)&&Ko.has(g)&&Ko.delete(g),g===Co&&(Ao=Co=null,lo=0),1<C.flags?null!==C.lastEffect?(C.lastEffect.nextEffect=C,A=C.firstEffect):A=C:A=C.firstEffect,null!==A){l=Io,Io|=32,$l.current=null,Fo=J(g.containerInfo),So=!1,mo=A;do{try{le()}catch(u){if(null===mo)throw Error(i(330));ne(mo,u),mo=mo.nextEffect}}while(null!==mo);Fo=null,mo=A;do{try{for(e=g;null!==mo;){var b=mo.flags;if(16&b&&P&&rg(mo.stateNode),128&b){var d=mo.alternate;if(null!==d){var G=d.ref;null!==G&&("function"===typeof G?G(null):G.current=null)}}switch(1038&b){case 2:Hl(mo),mo.flags&=-3;break;case 6:Hl(mo),mo.flags&=-3,Sl(mo.alternate,mo);break;case 1024:mo.flags&=-1025;break;case 1028:mo.flags&=-1025,Sl(mo.alternate,mo);break;case 4:Sl(mo.alternate,mo);break;case 8:c=e,o=mo,P?Fl(c,o):Kl(c,o);var Z=o.alternate;Yl(o),null!==Z&&Yl(Z)}mo=mo.nextEffect}}catch(u){if(null===mo)throw Error(i(330));ne(mo,u),mo=mo.nextEffect}}while(null!==mo);So&&Ag(),L(g.containerInfo),g.current=C,mo=A;do{try{for(b=g;null!==mo;){var s=mo.flags;if(36&s&&Vl(b,mo.alternate,mo),128&s){d=void 0;var t=mo.ref;if(null!==t){var B=mo.stateNode;if(5===mo.tag)d=S(B);else d=B;"function"===typeof t?t(d):t.current=d}}mo=mo.nextEffect}}catch(u){if(null===mo)throw Error(i(330));ne(mo,u),mo=mo.nextEffect}}while(null!==mo);mo=null,JI(),Io=l}else g.current=C;if(yo)yo=!1,po=g,Vo=I;else for(mo=A;null!==mo;)I=mo.nextEffect,mo.nextEffect=null,8&mo.flags&&((s=mo).sibling=null,s.stateNode=null),mo=I;if(0===(A=g.pendingLanes)&&(ro=null),1===A?g===Ro?Yo++:(Yo=0,Ro=g):Yo=0,C=C.stateNode,dI&&"function"===typeof dI.onCommitFiberRoot)try{dI.onCommitFiberRoot(bI,C,void 0,64===(64&C.current.flags))}catch(u){}if(fo(g,xI()),ho)throw ho=!1,g=Wo,Wo=null,g;return 0!==(8&Io)||EI(),null}function le(){for(;null!==mo;){var g=mo.alternate;So||null===Fo||(0!==(8&mo.flags)?N(mo,Fo)&&(So=!0,Cg()):13===mo.tag&&Jl(g,mo)&&N(mo,Fo)&&(So=!0,Cg()));var I=mo.flags;0!==(256&I)&&yl(g,mo),0===(512&I)||yo||(yo=!0,DI(97,(function(){return oe(),null}))),mo=mo.nextEffect}}function oe(){if(90!==Vo){var g=97<Vo?97:Vo;return Vo=90,jI(g,ce)}return!1}function ee(g,I){vo.push(I,g),yo||(yo=!0,DI(97,(function(){return oe(),null})))}function ie(g,I){Xo.push(I,g),yo||(yo=!0,DI(97,(function(){return oe(),null})))}function ce(){if(null===po)return!1;var g=po;if(po=null,0!==(48&Io))throw Error(i(331));var I=Io;Io|=32;var C=Xo;Xo=[];for(var A=0;A<C.length;A+=2){var l=C[A],o=C[A+1],e=l.destroy;if(l.destroy=void 0,"function"===typeof e)try{e()}catch(a){if(null===o)throw Error(i(330));ne(o,a)}}for(C=vo,vo=[],A=0;A<C.length;A+=2){l=C[A],o=C[A+1];try{var c=l.create;l.destroy=c()}catch(a){if(null===o)throw Error(i(330));ne(o,a)}}for(c=g.current.firstEffect;null!==c;)g=c.nextEffect,c.nextEffect=null,8&c.flags&&(c.sibling=null,c.stateNode=null),c=g;return Io=I,EI(),!0}function ae(g,I,C){tC(g,I=ml(0,I=tl(C,I),1)),I=zo(),null!==(g=Lo(g,1))&&(WI(g,1,I),fo(g,I))}function ne(g,I){if(3===g.tag)ae(g,g,I);else for(var C=g.return;null!==C;){if(3===C.tag){ae(C,g,I);break}if(1===C.tag){var A=C.stateNode;if("function"===typeof C.type.getDerivedStateFromError||"function"===typeof A.componentDidCatch&&(null===ro||!ro.has(A))){var l=hl(C,g=tl(I,g),1);if(tC(C,l),l=zo(),null!==(C=Lo(C,1)))WI(C,1,l),fo(C,l);else if("function"===typeof A.componentDidCatch&&(null===ro||!ro.has(A)))try{A.componentDidCatch(I,g)}catch(o){}break}}C=C.return}}function be(g,I,C){var A=g.pingCache;null!==A&&A.delete(I),I=zo(),g.pingedLanes|=g.suspendedLanes&C,Co===g&&(lo&C)===C&&(4===io||3===io&&(62914560&lo)===lo&&500>xI()-so?Eo(g,0):Go|=C),fo(g,I)}function de(g,I){var C=g.stateNode;null!==C&&C.delete(I),0===(I=0)&&(0===(2&(I=g.mode))?I=1:0===(4&I)?I=99===UI()?1:2:(0===wo&&(wo=ao),0===(I=mI(62914560&~wo))&&(I=4194304))),C=zo(),null!==(g=Lo(g,I))&&(WI(g,I,C),fo(g,C))}uo=function(g,I,C){var A=I.lanes;if(null!==g)if(g.memoizedProps!==I.pendingProps||CI.current)MA=!0;else{if(0===(C&A)){switch(MA=!1,I.tag){case 3:qA(I),_C();break;case 5:fC(I);break;case 1:oI(I.type)&&aI(I);break;case 4:JC(I,I.stateNode.containerInfo);break;case 10:iC(I,I.memoizedProps.value);break;case 13:if(null!==I.memoizedState)return 0!==(C&I.child.childLanes)?Al(g,I,C):($g(QC,1&QC.current),null!==(I=nl(g,I,C))?I.sibling:null);$g(QC,1&QC.current);break;case 19:if(A=0!==(C&I.childLanes),0!==(64&g.flags)){if(A)return al(g,I,C);I.flags|=64}var l=I.memoizedState;if(null!==l&&(l.rendering=null,l.tail=null,l.lastEffect=null),$g(QC,QC.current),A)break;return null;case 23:case 24:return I.lanes=0,jA(g,I,C)}return nl(g,I,C)}MA=0!==(16384&g.flags)}else MA=!1;switch(I.lanes=0,I.tag){case 2:if(A=I.type,null!==g&&(g.alternate=null,I.alternate=null,I.flags|=2),g=I.pendingProps,l=lI(I,II.current),nC(I,C),l=bA(null,I,A,g,l,C),I.flags|=1,"object"===typeof l&&null!==l&&"function"===typeof l.render&&void 0===l.$$typeof){if(I.tag=1,I.memoizedState=null,I.updateQueue=null,oI(A)){var o=!0;aI(I)}else o=!1;I.memoizedState=null!==l.state&&void 0!==l.state?l.state:null,GC(I);var e=A.getDerivedStateFromProps;"function"===typeof e&&WC(I,A,e,g),l.updater=rC,I.stateNode=l,l._reactInternals=I,vC(I,A,g,C),I=PA(null,I,A,!0,o,C)}else I.tag=0,QA(null,I,l,C),I=I.child;return I;case 16:l=I.elementType;g:{switch(null!==g&&(g.alternate=null,I.alternate=null,I.flags|=2),g=I.pendingProps,l=(o=l._init)(l._payload),I.type=l,o=I.tag=function(g){if("function"===typeof g)return re(g)?1:0;if(void 0!==g&&null!==g){if((g=g.$$typeof)===t)return 11;if(g===m)return 14}return 2}(l),g=IC(l,g),o){case 0:I=EA(null,I,l,g,C);break g;case 1:I=OA(null,I,l,g,C);break g;case 11:I=xA(null,I,l,g,C);break g;case 14:I=UA(null,I,l,IC(l.type,g),A,C);break g}throw Error(i(306,l,""))}return I;case 0:return A=I.type,l=I.pendingProps,EA(g,I,A,l=I.elementType===A?l:IC(A,l),C);case 1:return A=I.type,l=I.pendingProps,OA(g,I,A,l=I.elementType===A?l:IC(A,l),C);case 3:if(qA(I),A=I.updateQueue,null===g||null===A)throw Error(i(282));if(A=I.pendingProps,l=null!==(l=I.memoizedState)?l.element:null,ZC(g,I),uC(I,A,null,C),(A=I.memoizedState.element)===l)_C(),I=nl(g,I,C);else{if((o=(l=I.stateNode).hydrate)&&(_?(TC=fg(I.stateNode.containerInfo),UC=I,o=jC=!0):o=!1),o){if(_&&null!=(g=l.mutableSourceEagerHydrationData))for(l=0;l<g.length;l+=2)o=g[l],e=g[l+1],O?o._workInProgressVersionPrimary=e:o._workInProgressVersionSecondary=e,$C.push(o);for(C=wC(I,null,A,C),I.child=C;C;)C.flags=-3&C.flags|1024,C=C.sibling}else QA(g,I,A,C),_C();I=I.child}return I;case 5:return fC(I),null===g&&OC(I),A=I.type,l=I.pendingProps,o=null!==g?g.memoizedProps:null,e=l.children,U(A,l)?e=null:null!==o&&U(A,o)&&(I.flags|=16),DA(g,I),QA(g,I,e,C),I.child;case 6:return null===g&&OC(I),null;case 13:return Al(g,I,C);case 4:return JC(I,I.stateNode.containerInfo),A=I.pendingProps,null===g?I.child=HC(I,null,A,C):QA(g,I,A,C),I.child;case 11:return A=I.type,l=I.pendingProps,xA(g,I,A,l=I.elementType===A?l:IC(A,l),C);case 7:return QA(g,I,I.pendingProps,C),I.child;case 8:case 12:return QA(g,I,I.pendingProps.children,C),I.child;case 10:g:{if(A=I.type._context,l=I.pendingProps,e=I.memoizedProps,iC(I,o=l.value),null!==e){var c=e.value;if(0===(o=qI(c,o)?0:0|("function"===typeof A._calculateChangedBits?A._calculateChangedBits(c,o):1073741823))){if(e.children===l.children&&!CI.current){I=nl(g,I,C);break g}}else for(null!==(c=I.child)&&(c.return=I);null!==c;){var a=c.dependencies;if(null!==a){e=c.child;for(var n=a.firstContext;null!==n;){if(n.context===A&&0!==(n.observedBits&o)){1===c.tag&&((n=sC(-1,C&-C)).tag=2,tC(c,n)),c.lanes|=C,null!==(n=c.alternate)&&(n.lanes|=C),aC(c.return,C),a.lanes|=C;break}n=n.next}}else e=10===c.tag&&c.type===I.type?null:c.child;if(null!==e)e.return=c;else for(e=c;null!==e;){if(e===I){e=null;break}if(null!==(c=e.sibling)){c.return=e.return,e=c;break}e=e.return}c=e}}QA(g,I,l.children,C),I=I.child}return I;case 9:return l=I.type,A=(o=I.pendingProps).children,nC(I,C),A=A(l=bC(l,o.unstable_observedBits)),I.flags|=1,QA(g,I,A,C),I.child;case 14:return o=IC(l=I.type,I.pendingProps),UA(g,I,l,o=IC(l.type,o),A,C);case 15:return TA(g,I,I.type,I.pendingProps,A,C);case 17:return A=I.type,l=I.pendingProps,l=I.elementType===A?l:IC(A,l),null!==g&&(g.alternate=null,I.alternate=null,I.flags|=2),I.tag=1,oI(A)?(g=!0,aI(I)):g=!1,nC(I,C),pC(I,A,l),vC(I,A,l,C),PA(null,I,A,!0,g,C);case 19:return al(g,I,C);case 23:case 24:return jA(g,I,C)}throw Error(i(156,I.tag))};var Ge={current:!1},Ze=e.unstable_flushAllWithoutAsserting,se="function"===typeof Ze;function te(){if(void 0!==Ze)return Ze();for(var g=!1;oe();)g=!0;return g}function Be(I){try{te(),function(I){if(null===Pl)try{var C=("require"+Math.random()).slice(0,7);Pl=(g&&g[C]).call(g,"timers").setImmediate}catch(A){Pl=function(g){var I=new MessageChannel;I.port1.onmessage=g,I.port2.postMessage(void 0)}}Pl(I)}((function(){te()?Be(I):I()}))}catch(C){I(C)}}var ue=0,me=!1;function he(g,I,C,A){this.tag=g,this.key=C,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=I,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=A,this.flags=0,this.lastEffect=this.firstEffect=this.nextEffect=null,this.childLanes=this.lanes=0,this.alternate=null}function We(g,I,C,A){return new he(g,I,C,A)}function re(g){return!(!(g=g.prototype)||!g.isReactComponent)}function ye(g,I){var C=g.alternate;return null===C?((C=We(g.tag,I,g.key,g.mode)).elementType=g.elementType,C.type=g.type,C.stateNode=g.stateNode,C.alternate=g,g.alternate=C):(C.pendingProps=I,C.type=g.type,C.flags=0,C.nextEffect=null,C.firstEffect=null,C.lastEffect=null),C.childLanes=g.childLanes,C.lanes=g.lanes,C.child=g.child,C.memoizedProps=g.memoizedProps,C.memoizedState=g.memoizedState,C.updateQueue=g.updateQueue,I=g.dependencies,C.dependencies=null===I?null:{lanes:I.lanes,firstContext:I.firstContext},C.sibling=g.sibling,C.index=g.index,C.ref=g.ref,C}function pe(g,I,C,A,l,o){var e=2;if(A=g,"function"===typeof g)re(g)&&(e=1);else if("string"===typeof g)e=5;else g:switch(g){case b:return Ve(C.children,l,o,I);case r:e=8,l|=16;break;case d:e=8,l|=1;break;case G:return(g=We(12,C,I,8|l)).elementType=G,g.type=G,g.lanes=o,g;case B:return(g=We(13,C,I,l)).type=B,g.elementType=B,g.lanes=o,g;case u:return(g=We(19,C,I,l)).elementType=u,g.lanes=o,g;case y:return ve(C,l,o,I);case p:return(g=We(24,C,I,l)).elementType=p,g.lanes=o,g;default:if("object"===typeof g&&null!==g)switch(g.$$typeof){case Z:e=10;break g;case s:e=9;break g;case t:e=11;break g;case m:e=14;break g;case h:e=16,A=null;break g;case W:e=22;break g}throw Error(i(130,null==g?g:typeof g,""))}return(I=We(e,C,I,l)).elementType=g,I.type=A,I.lanes=o,I}function Ve(g,I,C,A){return(g=We(7,g,A,I)).lanes=C,g}function ve(g,I,C,A){return(g=We(23,g,A,I)).elementType=y,g.lanes=C,g}function Xe(g,I,C){return(g=We(6,g,null,I)).lanes=C,g}function Ke(g,I,C){return(I=We(4,null!==g.children?g.children:[],g.key,I)).lanes=C,I.stateNode={containerInfo:g.containerInfo,pendingChildren:null,implementation:g.implementation},I}function Ye(g,I,C){this.tag=I,this.containerInfo=g,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=E,this.pendingContext=this.context=null,this.hydrate=C,this.callbackNode=null,this.callbackPriority=0,this.eventTimes=hI(0),this.expirationTimes=hI(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=hI(0),_&&(this.mutableSourceEagerHydrationData=null)}function Re(g){var I=g._reactInternals;if(void 0===I){if("function"===typeof g.render)throw Error(i(188));throw Error(i(268,Object.keys(g)))}return null===(g=w(I))?null:g.stateNode}function He(g,I){if(null!==(g=g.memoizedState)&&null!==g.dehydrated){var C=g.retryLane;g.retryLane=0!==C&&C<I?C:I}}function we(g,I){He(g,I),(g=g.alternate)&&He(g,I)}function Ne(g){return null===(g=w(g))?null:g.stateNode}function Fe(){return null}return A.IsThisRendererActing=Ge,A.act=function(g){function I(){ue--,go.current=C,Ge.current=A}!1===me&&(me=!0,console.error("act(...) is not supported in production builds of React, and might not behave as expected.")),ue++;var C=go.current,A=Ge.current;go.current=!0,Ge.current=!0;try{var l=Uo(g)}catch(o){throw I(),o}if(null!==l&&"object"===typeof l&&"function"===typeof l.then)return{then:function(g,A){l.then((function(){1<ue||!0===se&&!0===C?(I(),g()):Be((function(C){I(),C?A(C):g()}))}),(function(g){I(),A(g)}))}};try{1!==ue||!1!==se&&!1!==C||te(),I()}catch(o){throw I(),o}return{then:function(g){g()}}},A.attemptContinuousHydration=function(g){13===g.tag&&(Jo(g,67108864,zo()),we(g,67108864))},A.attemptHydrationAtCurrentPriority=function(g){if(13===g.tag){var I=zo(),C=ko(g);Jo(g,C,I),we(g,C)}},A.attemptSynchronousHydration=function(g){switch(g.tag){case 3:var I=g.stateNode;if(I.hydrate){var C=sI(I.pendingLanes);I.expiredLanes|=C&I.pendingLanes,fo(I,xI()),0===(48&Io)&&(Bo(),EI())}break;case 13:var A=zo();To((function(){return Jo(g,1,A)})),we(g,4)}},A.attemptUserBlockingHydration=function(g){13===g.tag&&(Jo(g,4,zo()),we(g,4))},A.batchedEventUpdates=function(g,I){var C=Io;Io|=2;try{return g(I)}finally{0===(Io=C)&&(Bo(),EI())}},A.batchedUpdates=Uo,A.createComponentSelector=function(g){return{$$typeof:Ll,value:g}},A.createContainer=function(g,I,C){return g=new Ye(g,I,C),I=We(3,null,null,2===I?7:1===I?3:0),g.current=I,I.stateNode=g,GC(I),g},A.createHasPsuedoClassSelector=function(g){return{$$typeof:fl,value:g}},A.createPortal=function(g,I,C){var A=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:n,key:null==A?null:""+A,children:g,containerInfo:I,implementation:C}},A.createRoleSelector=function(g){return{$$typeof:Ml,value:g}},A.createTestNameSelector=function(g){return{$$typeof:Ql,value:g}},A.createTextSelector=function(g){return{$$typeof:xl,value:g}},A.deferredUpdates=function(g){return jI(97,g)},A.discreteUpdates=function(g,I,C,A,l){var o=Io;Io|=4;try{return jI(98,g.bind(null,I,C,A,l))}finally{0===(Io=o)&&(Bo(),EI())}},A.findAllNodes=Ol,A.findBoundingRects=function(g,I){if(!og)throw Error(i(363));I=Ol(g,I),g=[];for(var C=0;C<I.length;C++)g.push(ig(I[C]));for(I=g.length-1;0<I;I--)for(var A=(C=g[I]).x,l=A+C.width,o=C.y,e=o+C.height,c=I-1;0<=c;c--)if(I!==c){var a=g[c],n=a.x,b=n+a.width,d=a.y,G=d+a.height;if(A>=n&&o>=d&&l<=b&&e<=G){g.splice(I,1);break}if(!(A!==n||C.width!==a.width||G<o||d>e)){d>o&&(a.height+=d-o,a.y=o),G<e&&(a.height=e-d),g.splice(I,1);break}if(!(o!==d||C.height!==a.height||b<A||n>l)){n>A&&(a.width+=n-A,a.x=A),b<l&&(a.width=l-n),g.splice(I,1);break}}return g},A.findHostInstance=Re,A.findHostInstanceWithNoPortals=function(g){return null===(g=function(g){if(!(g=H(g)))return null;for(var I=g;;){if(5===I.tag||6===I.tag)return I;if(I.child&&4!==I.tag)I.child.return=I,I=I.child;else{if(I===g)break;for(;!I.sibling;){if(!I.return||I.return===g)return null;I=I.return}I.sibling.return=I.return,I=I.sibling}}return null}(g))?null:20===g.tag?g.stateNode.instance:g.stateNode},A.findHostInstanceWithWarning=function(g){return Re(g)},A.flushControlled=function(g){var I=Io;Io|=1;try{jI(99,g)}finally{0===(Io=I)&&(Bo(),EI())}},A.flushDiscreteUpdates=function(){0===(49&Io)&&(function(){if(null!==Ko){var g=Ko;Ko=null,g.forEach((function(g){g.expiredLanes|=24&g.pendingLanes,fo(g,xI())}))}EI()}(),oe())},A.flushPassiveEffects=oe,A.flushSync=To,A.focusWithin=function(g,I){if(!og)throw Error(i(363));for(I=El(g=Tl(g),I),I=Array.from(I),g=0;g<I.length;){var C=I[g++];if(!ag(C)){if(5===C.tag&&bg(C.stateNode))return!0;for(C=C.child;null!==C;)I.push(C),C=C.sibling}}return!1},A.getCurrentUpdateLanePriority=function(){return GI},A.getFindAllNodesFailureDescription=function(g,I){if(!og)throw Error(i(363));var C=0,A=[];g=[Tl(g),0];for(var l=0;l<g.length;){var o=g[l++],e=g[l++],c=I[e];if((5!==o.tag||!ag(o))&&(jl(o,c)&&(A.push(Dl(c)),++e>C&&(C=e)),e<I.length))for(o=o.child;null!==o;)g.push(o,e),o=o.sibling}if(C<I.length){for(g=[];C<I.length;C++)g.push(Dl(I[C]));return"findAllNodes was able to match part of the selector:\n  "+A.join(" > ")+"\n\nNo matching component was found for:\n  "+g.join(" > ")}return null},A.getPublicRootInstance=function(g){return(g=g.current).child?5===g.child.tag?S(g.child.stateNode):g.child.stateNode:null},A.injectIntoDevTools=function(g){if(g={bundleType:g.bundleType,version:g.version,rendererPackageName:g.rendererPackageName,rendererConfig:g.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:c.ReactCurrentDispatcher,findHostInstanceByFiber:Ne,findFiberByHostInstance:g.findFiberByHostInstance||Fe,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null},"undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)g=!1;else{var I=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!I.isDisabled&&I.supportsFiber)try{bI=I.inject(g),dI=I}catch(C){}g=!0}return g},A.observeVisibleRects=function(g,I,C,A){if(!og)throw Error(i(363));g=Ol(g,I);var l=dg(g,C,A).disconnect;return{disconnect:function(){l()}}},A.registerMutableSourceForHydration=function(g,I){var C=I._getVersion;C=C(I._source),null==g.mutableSourceEagerHydrationData?g.mutableSourceEagerHydrationData=[I,C]:g.mutableSourceEagerHydrationData.push(I,C)},A.runWithPriority=function(g,I){var C=GI;try{return GI=g,I()}finally{GI=C}},A.shouldSuspend=function(){return!1},A.unbatchedUpdates=function(g,I){var C=Io;Io&=-2,Io|=8;try{return g(I)}finally{0===(Io=C)&&(Bo(),EI())}},A.updateContainer=function(g,I,C,A){var l=I.current,o=zo(),e=ko(l);g:if(C){I:{if(Y(C=C._reactInternals)!==C||1!==C.tag)throw Error(i(170));var c=C;do{switch(c.tag){case 3:c=c.stateNode.context;break I;case 1:if(oI(c.type)){c=c.stateNode.__reactInternalMemoizedMergedChildContext;break I}}c=c.return}while(null!==c);throw Error(i(171))}if(1===C.tag){var a=C.type;if(oI(a)){C=cI(C,a,c);break g}}C=c}else C=gI;return null===I.context?I.context=C:I.pendingContext=C,(I=sC(o,e)).payload={element:g},null!==(A=void 0===A?null:A)&&(I.callback=A),tC(l,I),Jo(l,e,o),e},A}},258:function(g,I,C){"use strict";g.exports=C(3721)},1413:function(g,I,C){"use strict";C.d(I,{Z:function(){return o}});var A=C(4942);function l(g,I){var C=Object.keys(g);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(g);I&&(A=A.filter((function(I){return Object.getOwnPropertyDescriptor(g,I).enumerable}))),C.push.apply(C,A)}return C}function o(g){for(var I=1;I<arguments.length;I++){var C=null!=arguments[I]?arguments[I]:{};I%2?l(Object(C),!0).forEach((function(I){(0,A.Z)(g,I,C[I])})):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(C)):l(Object(C)).forEach((function(I){Object.defineProperty(g,I,Object.getOwnPropertyDescriptor(C,I))}))}return g}},4925:function(g,I,C){"use strict";function A(g,I){if(null==g)return{};var C,A,l=function(g,I){if(null==g)return{};var C,A,l={},o=Object.keys(g);for(A=0;A<o.length;A++)C=o[A],I.indexOf(C)>=0||(l[C]=g[C]);return l}(g,I);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(g);for(A=0;A<o.length;A++)C=o[A],I.indexOf(C)>=0||Object.prototype.propertyIsEnumerable.call(g,C)&&(l[C]=g[C])}return l}C.d(I,{Z:function(){return A}})},6145:function(g,I,C){"use strict";C.d(I,{E:function(){return G}});var A=C(9439),l=C(7762),o=C(7326),e=C(1752),i=C(1120),c=C(5671),a=C(3144),n=C(136),b=C(9388),d=C(323),G=function(g){(0,n.Z)(C,g);var I=(0,b.Z)(C);function C(g){var A;return(0,c.Z)(this,C),(A=I.call(this,g)).dracoLoader=null,A.ktx2Loader=null,A.meshoptDecoder=null,A.pluginCallbacks=[],A.register((function(g){return new u(g)})),A.register((function(g){return new p(g)})),A.register((function(g){return new V(g)})),A.register((function(g){return new m(g)})),A.register((function(g){return new h(g)})),A.register((function(g){return new W(g)})),A.register((function(g){return new r(g)})),A.register((function(g){return new y(g)})),A.register((function(g){return new t(g)})),A.register((function(g){return new v(g)})),A}return(0,a.Z)(C,[{key:"load",value:function(g,I,C,A){var l,o=this;l=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:d.LoaderUtils.extractUrlBase(g),this.manager.itemStart(g);var e=function(I){A?A(I):console.error(I),o.manager.itemError(g),o.manager.itemEnd(g)},i=new d.FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(g,(function(C){try{o.parse(C,l,(function(C){I(C),o.manager.itemEnd(g)}),e)}catch(A){e(A)}}),C,e)}},{key:"setDRACOLoader",value:function(g){return this.dracoLoader=g,this}},{key:"setDDSLoader",value:function(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}},{key:"setKTX2Loader",value:function(g){return this.ktx2Loader=g,this}},{key:"setMeshoptDecoder",value:function(g){return this.meshoptDecoder=g,this}},{key:"register",value:function(g){return-1===this.pluginCallbacks.indexOf(g)&&this.pluginCallbacks.push(g),this}},{key:"unregister",value:function(g){return-1!==this.pluginCallbacks.indexOf(g)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(g),1),this}},{key:"parse",value:function(g,I,C,A){var l,o={},e={};if("string"===typeof g)l=g;else if(d.LoaderUtils.decodeText(new Uint8Array(g,0,4))===X){try{o[s.KHR_BINARY_GLTF]=new R(g)}catch(t){return void(A&&A(t))}l=o[s.KHR_BINARY_GLTF].content}else l=d.LoaderUtils.decodeText(new Uint8Array(g));var i=JSON.parse(l);if(void 0===i.asset||i.asset.version[0]<2)A&&A(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var c=new cg(i,{path:I||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(var a=0;a<this.pluginCallbacks.length;a++){var n=this.pluginCallbacks[a](c);e[n.name]=n,o[n.name]=!0}if(i.extensionsUsed)for(var b=0;b<i.extensionsUsed.length;++b){var G=i.extensionsUsed[b],Z=i.extensionsRequired||[];switch(G){case s.KHR_MATERIALS_UNLIT:o[G]=new B;break;case s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[G]=new F;break;case s.KHR_DRACO_MESH_COMPRESSION:o[G]=new H(i,this.dracoLoader);break;case s.KHR_TEXTURE_TRANSFORM:o[G]=new w;break;case s.KHR_MESH_QUANTIZATION:o[G]=new S;break;default:Z.indexOf(G)>=0&&void 0===e[G]&&console.warn('THREE.GLTFLoader: Unknown extension "'+G+'".')}}c.setExtensions(o),c.setPlugins(e),c.parse(C,A)}}},{key:"parseAsync",value:function(g,I){var C=this;return new Promise((function(A,l){C.parse(g,I,A,l)}))}}]),C}(d.Loader);function Z(){var g={};return{get:function(I){return g[I]},add:function(I,C){g[I]=C},remove:function(I){delete g[I]},removeAll:function(){g={}}}}var s={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"},t=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}return(0,a.Z)(g,[{key:"_markDefs",value:function(){for(var g=this.parser,I=this.parser.json.nodes||[],C=0,A=I.length;C<A;C++){var l=I[C];l.extensions&&l.extensions[this.name]&&void 0!==l.extensions[this.name].light&&g._addNodeRef(this.cache,l.extensions[this.name].light)}}},{key:"_loadLight",value:function(g){var I=this.parser,C="light:"+g,A=I.cache.get(C);if(A)return A;var l,o=I.json,e=((o.extensions&&o.extensions[this.name]||{}).lights||[])[g],i=new d.Color(16777215);void 0!==e.color&&i.fromArray(e.color);var c=void 0!==e.range?e.range:0;switch(e.type){case"directional":(l=new d.DirectionalLight(i)).target.position.set(0,0,-1),l.add(l.target);break;case"point":(l=new d.PointLight(i)).distance=c;break;case"spot":(l=new d.SpotLight(i)).distance=c,e.spot=e.spot||{},e.spot.innerConeAngle=void 0!==e.spot.innerConeAngle?e.spot.innerConeAngle:0,e.spot.outerConeAngle=void 0!==e.spot.outerConeAngle?e.spot.outerConeAngle:Math.PI/4,l.angle=e.spot.outerConeAngle,l.penumbra=1-e.spot.innerConeAngle/e.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+e.type)}return l.position.set(0,0,0),l.decay=2,void 0!==e.intensity&&(l.intensity=e.intensity),l.name=I.createUniqueName(e.name||"light_"+g),A=Promise.resolve(l),I.cache.add(C,A),A}},{key:"createNodeAttachment",value:function(g){var I=this,C=this.parser,A=C.json.nodes[g],l=(A.extensions&&A.extensions[this.name]||{}).light;return void 0===l?null:this._loadLight(l).then((function(g){return C._getNodeRef(I.cache,l,g)}))}}]),g}(),B=function(){function g(){(0,c.Z)(this,g),this.name=s.KHR_MATERIALS_UNLIT}return(0,a.Z)(g,[{key:"getMaterialType",value:function(){return d.MeshBasicMaterial}},{key:"extendParams",value:function(g,I,C){var A=[];g.color=new d.Color(1,1,1),g.opacity=1;var l=I.pbrMetallicRoughness;if(l){if(Array.isArray(l.baseColorFactor)){var o=l.baseColorFactor;g.color.fromArray(o),g.opacity=o[3]}void 0!==l.baseColorTexture&&A.push(C.assignTexture(g,"map",l.baseColorTexture))}return Promise.all(A)}}]),g}(),u=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_MATERIALS_CLEARCOAT}return(0,a.Z)(g,[{key:"getMaterialType",value:function(g){var I=this.parser.json.materials[g];return I.extensions&&I.extensions[this.name]?d.MeshPhysicalMaterial:null}},{key:"extendMaterialParams",value:function(g,I){var C=this.parser,A=C.json.materials[g];if(!A.extensions||!A.extensions[this.name])return Promise.resolve();var l=[],o=A.extensions[this.name];if(void 0!==o.clearcoatFactor&&(I.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&l.push(C.assignTexture(I,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(I.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&l.push(C.assignTexture(I,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(l.push(C.assignTexture(I,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){var e=o.clearcoatNormalTexture.scale;I.clearcoatNormalScale=new d.Vector2(e,e)}return Promise.all(l)}}]),g}(),m=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_MATERIALS_SHEEN}return(0,a.Z)(g,[{key:"getMaterialType",value:function(g){var I=this.parser.json.materials[g];return I.extensions&&I.extensions[this.name]?d.MeshPhysicalMaterial:null}},{key:"extendMaterialParams",value:function(g,I){var C=this.parser,A=C.json.materials[g];if(!A.extensions||!A.extensions[this.name])return Promise.resolve();var l=[];I.sheenColor=new d.Color(0,0,0),I.sheenRoughness=0,I.sheen=1;var o=A.extensions[this.name];return void 0!==o.sheenColorFactor&&I.sheenColor.fromArray(o.sheenColorFactor),void 0!==o.sheenRoughnessFactor&&(I.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&l.push(C.assignTexture(I,"sheenColorMap",o.sheenColorTexture)),void 0!==o.sheenRoughnessTexture&&l.push(C.assignTexture(I,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(l)}}]),g}(),h=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_MATERIALS_TRANSMISSION}return(0,a.Z)(g,[{key:"getMaterialType",value:function(g){var I=this.parser.json.materials[g];return I.extensions&&I.extensions[this.name]?d.MeshPhysicalMaterial:null}},{key:"extendMaterialParams",value:function(g,I){var C=this.parser,A=C.json.materials[g];if(!A.extensions||!A.extensions[this.name])return Promise.resolve();var l=[],o=A.extensions[this.name];return void 0!==o.transmissionFactor&&(I.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&l.push(C.assignTexture(I,"transmissionMap",o.transmissionTexture)),Promise.all(l)}}]),g}(),W=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_MATERIALS_VOLUME}return(0,a.Z)(g,[{key:"getMaterialType",value:function(g){var I=this.parser.json.materials[g];return I.extensions&&I.extensions[this.name]?d.MeshPhysicalMaterial:null}},{key:"extendMaterialParams",value:function(g,I){var C=this.parser,A=C.json.materials[g];if(!A.extensions||!A.extensions[this.name])return Promise.resolve();var l=[],o=A.extensions[this.name];I.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&l.push(C.assignTexture(I,"thicknessMap",o.thicknessTexture)),I.attenuationDistance=o.attenuationDistance||0;var e=o.attenuationColor||[1,1,1];return I.attenuationColor=new d.Color(e[0],e[1],e[2]),Promise.all(l)}}]),g}(),r=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_MATERIALS_IOR}return(0,a.Z)(g,[{key:"getMaterialType",value:function(g){var I=this.parser.json.materials[g];return I.extensions&&I.extensions[this.name]?d.MeshPhysicalMaterial:null}},{key:"extendMaterialParams",value:function(g,I){var C=this.parser.json.materials[g];if(!C.extensions||!C.extensions[this.name])return Promise.resolve();var A=C.extensions[this.name];return I.ior=void 0!==A.ior?A.ior:1.5,Promise.resolve()}}]),g}(),y=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_MATERIALS_SPECULAR}return(0,a.Z)(g,[{key:"getMaterialType",value:function(g){var I=this.parser.json.materials[g];return I.extensions&&I.extensions[this.name]?d.MeshPhysicalMaterial:null}},{key:"extendMaterialParams",value:function(g,I){var C=this.parser,A=C.json.materials[g];if(!A.extensions||!A.extensions[this.name])return Promise.resolve();var l=[],o=A.extensions[this.name];I.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&l.push(C.assignTexture(I,"specularIntensityMap",o.specularTexture));var e=o.specularColorFactor||[1,1,1];return I.specularColor=new d.Color(e[0],e[1],e[2]),void 0!==o.specularColorTexture&&l.push(C.assignTexture(I,"specularColorMap",o.specularColorTexture).then((function(g){g.encoding=d.sRGBEncoding}))),Promise.all(l)}}]),g}(),p=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.KHR_TEXTURE_BASISU}return(0,a.Z)(g,[{key:"loadTexture",value:function(g){var I=this.parser,C=I.json,A=C.textures[g];if(!A.extensions||!A.extensions[this.name])return null;var l=A.extensions[this.name],o=C.images[l.source],e=I.options.ktx2Loader;if(!e){if(C.extensionsRequired&&C.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return I.loadTextureImage(g,o,e)}}]),g}(),V=function(){function g(I){(0,c.Z)(this,g),this.parser=I,this.name=s.EXT_TEXTURE_WEBP,this.isSupported=null}return(0,a.Z)(g,[{key:"loadTexture",value:function(g){var I=this.name,C=this.parser,A=C.json,l=A.textures[g];if(!l.extensions||!l.extensions[I])return null;var o=l.extensions[I],e=A.images[o.source],i=C.textureLoader;if(e.uri){var c=C.options.manager.getHandler(e.uri);null!==c&&(i=c)}return this.detectSupport().then((function(l){if(l)return C.loadTextureImage(g,e,i);if(A.extensionsRequired&&A.extensionsRequired.indexOf(I)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return C.loadTexture(g)}))}},{key:"detectSupport",value:function(){return this.isSupported||(this.isSupported=new Promise((function(g){var I=new Image;I.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",I.onload=I.onerror=function(){g(1===I.height)}}))),this.isSupported}}]),g}(),v=function(){function g(I){(0,c.Z)(this,g),this.name=s.EXT_MESHOPT_COMPRESSION,this.parser=I}return(0,a.Z)(g,[{key:"loadBufferView",value:function(g){var I=this.parser.json,C=I.bufferViews[g];if(C.extensions&&C.extensions[this.name]){var A=C.extensions[this.name],l=this.parser.getDependency("buffer",A.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(I.extensionsRequired&&I.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([l,o.ready]).then((function(g){var I=A.byteOffset||0,C=A.byteLength||0,l=A.count,e=A.byteStride,i=new ArrayBuffer(l*e),c=new Uint8Array(g[0],I,C);return o.decodeGltfBuffer(new Uint8Array(i),l,e,c,A.mode,A.filter),i}))}return null}}]),g}(),X="glTF",K=1313821514,Y=5130562,R=(0,a.Z)((function g(I){(0,c.Z)(this,g),this.name=s.KHR_BINARY_GLTF,this.content=null,this.body=null;var C=new DataView(I,0,12);if(this.header={magic:d.LoaderUtils.decodeText(new Uint8Array(I.slice(0,4))),version:C.getUint32(4,!0),length:C.getUint32(8,!0)},this.header.magic!==X)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var A=this.header.length-12,l=new DataView(I,12),o=0;o<A;){var e=l.getUint32(o,!0);o+=4;var i=l.getUint32(o,!0);if(o+=4,i===K){var a=new Uint8Array(I,12+o,e);this.content=d.LoaderUtils.decodeText(a)}else if(i===Y){var n=12+o;this.body=I.slice(n,n+e)}o+=e}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")})),H=function(){function g(I,C){if((0,c.Z)(this,g),!C)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=s.KHR_DRACO_MESH_COMPRESSION,this.json=I,this.dracoLoader=C,this.dracoLoader.preload()}return(0,a.Z)(g,[{key:"decodePrimitive",value:function(g,I){var C=this.json,A=this.dracoLoader,l=g.extensions[this.name].bufferView,o=g.extensions[this.name].attributes,e={},i={},c={};for(var a in o){var n=P[a]||a.toLowerCase();e[n]=o[a]}for(var b in g.attributes){var d=P[b]||b.toLowerCase();if(void 0!==o[b]){var G=C.accessors[g.attributes[b]],Z=j[G.componentType];c[d]=Z,i[d]=!0===G.normalized}}return I.getDependency("bufferView",l).then((function(g){return new Promise((function(I){A.decodeDracoFile(g,(function(g){for(var C in g.attributes){var A=g.attributes[C],l=i[C];void 0!==l&&(A.normalized=l)}I(g)}),e,c)}))}))}}]),g}(),w=function(){function g(){(0,c.Z)(this,g),this.name=s.KHR_TEXTURE_TRANSFORM}return(0,a.Z)(g,[{key:"extendTexture",value:function(g,I){return void 0!==I.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===I.offset&&void 0===I.rotation&&void 0===I.scale||(g=g.clone(),void 0!==I.offset&&g.offset.fromArray(I.offset),void 0!==I.rotation&&(g.rotation=I.rotation),void 0!==I.scale&&g.repeat.fromArray(I.scale),g.needsUpdate=!0),g}}]),g}(),N=function(g){(0,n.Z)(C,g);var I=(0,b.Z)(C);function C(g){var A;(0,c.Z)(this,C),(A=I.call(this)).isGLTFSpecularGlossinessMaterial=!0;var l=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),e=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),i=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),a=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),n=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),b={specular:{value:(new d.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};return A._extraUniforms=b,A.onBeforeCompile=function(g){for(var I in b)g.uniforms[I]=b[I];g.fragmentShader=g.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",l).replace("#include <metalnessmap_pars_fragment>",e).replace("#include <roughnessmap_fragment>",i).replace("#include <metalnessmap_fragment>",a).replace("#include <lights_physical_fragment>",n)},Object.defineProperties((0,o.Z)(A),{specular:{get:function(){return b.specular.value},set:function(g){b.specular.value=g}},specularMap:{get:function(){return b.specularMap.value},set:function(g){b.specularMap.value=g,g?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return b.glossiness.value},set:function(g){b.glossiness.value=g}},glossinessMap:{get:function(){return b.glossinessMap.value},set:function(g){b.glossinessMap.value=g,g?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete A.metalness,delete A.roughness,delete A.metalnessMap,delete A.roughnessMap,A.setValues(g),A}return(0,a.Z)(C,[{key:"copy",value:function(g){return(0,e.Z)((0,i.Z)(C.prototype),"copy",this).call(this,g),this.specularMap=g.specularMap,this.specular.copy(g.specular),this.glossinessMap=g.glossinessMap,this.glossiness=g.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}]),C}(d.MeshStandardMaterial),F=function(){function g(){(0,c.Z)(this,g),this.name=s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}return(0,a.Z)(g,[{key:"getMaterialType",value:function(){return N}},{key:"extendParams",value:function(g,I,C){var A=I.extensions[this.name];g.color=new d.Color(1,1,1),g.opacity=1;var l=[];if(Array.isArray(A.diffuseFactor)){var o=A.diffuseFactor;g.color.fromArray(o),g.opacity=o[3]}if(void 0!==A.diffuseTexture&&l.push(C.assignTexture(g,"map",A.diffuseTexture)),g.emissive=new d.Color(0,0,0),g.glossiness=void 0!==A.glossinessFactor?A.glossinessFactor:1,g.specular=new d.Color(1,1,1),Array.isArray(A.specularFactor)&&g.specular.fromArray(A.specularFactor),void 0!==A.specularGlossinessTexture){var e=A.specularGlossinessTexture;l.push(C.assignTexture(g,"glossinessMap",e)),l.push(C.assignTexture(g,"specularMap",e))}return Promise.all(l)}},{key:"createMaterial",value:function(g){var I=new N(g);return I.fog=!0,I.color=g.color,I.map=void 0===g.map?null:g.map,I.lightMap=null,I.lightMapIntensity=1,I.aoMap=void 0===g.aoMap?null:g.aoMap,I.aoMapIntensity=1,I.emissive=g.emissive,I.emissiveIntensity=1,I.emissiveMap=void 0===g.emissiveMap?null:g.emissiveMap,I.bumpMap=void 0===g.bumpMap?null:g.bumpMap,I.bumpScale=1,I.normalMap=void 0===g.normalMap?null:g.normalMap,I.normalMapType=d.TangentSpaceNormalMap,g.normalScale&&(I.normalScale=g.normalScale),I.displacementMap=null,I.displacementScale=1,I.displacementBias=0,I.specularMap=void 0===g.specularMap?null:g.specularMap,I.specular=g.specular,I.glossinessMap=void 0===g.glossinessMap?null:g.glossinessMap,I.glossiness=g.glossiness,I.alphaMap=null,I.envMap=void 0===g.envMap?null:g.envMap,I.envMapIntensity=1,I.refractionRatio=.98,I}}]),g}(),S=(0,a.Z)((function g(){(0,c.Z)(this,g),this.name=s.KHR_MESH_QUANTIZATION})),z=function(g){(0,n.Z)(C,g);var I=(0,b.Z)(C);function C(g,A,l,o){return(0,c.Z)(this,C),I.call(this,g,A,l,o)}return(0,a.Z)(C,[{key:"copySampleValue_",value:function(g){for(var I=this.resultBuffer,C=this.sampleValues,A=this.valueSize,l=g*A*3+A,o=0;o!==A;o++)I[o]=C[l+o];return I}}]),C}(d.Interpolant);z.prototype.beforeStart_=z.prototype.copySampleValue_,z.prototype.afterEnd_=z.prototype.copySampleValue_,z.prototype.interpolate_=function(g,I,C,A){for(var l=this.resultBuffer,o=this.sampleValues,e=this.valueSize,i=2*e,c=3*e,a=A-I,n=(C-I)/a,b=n*n,d=b*n,G=g*c,Z=G-c,s=-2*d+3*b,t=d-b,B=1-s,u=t-b+n,m=0;m!==e;m++){var h=o[Z+m+e],W=o[Z+m+i]*a,r=o[G+m+e],y=o[G+m]*a;l[m]=B*h+u*W+s*r+t*y}return l};var k=new d.Quaternion,J=function(g){(0,n.Z)(C,g);var I=(0,b.Z)(C);function C(){return(0,c.Z)(this,C),I.apply(this,arguments)}return(0,a.Z)(C,[{key:"interpolate_",value:function(g,I,A,l){var o=(0,e.Z)((0,i.Z)(C.prototype),"interpolate_",this).call(this,g,I,A,l);return k.fromArray(o).normalize().toArray(o),o}}]),C}(z),L=0,f=1,M=2,Q=3,x=4,U=5,T=6,j={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},D={9728:d.NearestFilter,9729:d.LinearFilter,9984:d.NearestMipmapNearestFilter,9985:d.LinearMipmapNearestFilter,9986:d.NearestMipmapLinearFilter,9987:d.LinearMipmapLinearFilter},E={33071:d.ClampToEdgeWrapping,33648:d.MirroredRepeatWrapping,10497:d.RepeatWrapping},O={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},P={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},q={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},_={CUBICSPLINE:void 0,LINEAR:d.InterpolateLinear,STEP:d.InterpolateDiscrete},$="OPAQUE",gg="MASK",Ig="BLEND";function Cg(g,I,C){for(var A in C.extensions)void 0===g[A]&&(I.userData.gltfExtensions=I.userData.gltfExtensions||{},I.userData.gltfExtensions[A]=C.extensions[A])}function Ag(g,I){void 0!==I.extras&&("object"===typeof I.extras?Object.assign(g.userData,I.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+I.extras))}function lg(g,I){if(g.updateMorphTargets(),void 0!==I.weights)for(var C=0,A=I.weights.length;C<A;C++)g.morphTargetInfluences[C]=I.weights[C];if(I.extras&&Array.isArray(I.extras.targetNames)){var l=I.extras.targetNames;if(g.morphTargetInfluences.length===l.length){g.morphTargetDictionary={};for(var o=0,e=l.length;o<e;o++)g.morphTargetDictionary[l[o]]=o}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function og(g){var I=g.extensions&&g.extensions[s.KHR_DRACO_MESH_COMPRESSION];return I?"draco:"+I.bufferView+":"+I.indices+":"+eg(I.attributes):g.indices+":"+eg(g.attributes)+":"+g.mode}function eg(g){for(var I="",C=Object.keys(g).sort(),A=0,l=C.length;A<l;A++)I+=C[A]+":"+g[C[A]]+";";return I}function ig(g){switch(g){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}var cg=function(){function g(){var I=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},C=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,c.Z)(this,g),this.json=I,this.extensions={},this.plugins={},this.options=C,this.cache=new Z,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!==typeof createImageBitmap&&!1===/Firefox|^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.textureLoader=new d.ImageBitmapLoader(this.options.manager):this.textureLoader=new d.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new d.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}return(0,a.Z)(g,[{key:"setExtensions",value:function(g){this.extensions=g}},{key:"setPlugins",value:function(g){this.plugins=g}},{key:"parse",value:function(g,I){var C=this,A=this.json,l=this.extensions;this.cache.removeAll(),this._invokeAll((function(g){return g._markDefs&&g._markDefs()})),Promise.all(this._invokeAll((function(g){return g.beforeRoot&&g.beforeRoot()}))).then((function(){return Promise.all([C.getDependencies("scene"),C.getDependencies("animation"),C.getDependencies("camera")])})).then((function(I){var o={scene:I[0][A.scene||0],scenes:I[0],animations:I[1],cameras:I[2],asset:A.asset,parser:C,userData:{}};Cg(l,o,A),Ag(o,A),Promise.all(C._invokeAll((function(g){return g.afterRoot&&g.afterRoot(o)}))).then((function(){g(o)}))})).catch(I)}},{key:"_markDefs",value:function(){for(var g=this.json.nodes||[],I=this.json.skins||[],C=this.json.meshes||[],A=0,l=I.length;A<l;A++)for(var o=I[A].joints,e=0,i=o.length;e<i;e++)g[o[e]].isBone=!0;for(var c=0,a=g.length;c<a;c++){var n=g[c];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(C[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}},{key:"_addNodeRef",value:function(g,I){void 0!==I&&(void 0===g.refs[I]&&(g.refs[I]=g.uses[I]=0),g.refs[I]++)}},{key:"_getNodeRef",value:function(g,I,C){var o=this;if(g.refs[I]<=1)return C;var e=C.clone();return function g(I,C){var e=o.associations.get(I);null!=e&&o.associations.set(C,e);var i,c=(0,l.Z)(I.children.entries());try{for(c.s();!(i=c.n()).done;){var a=(0,A.Z)(i.value,2),n=a[0];g(a[1],C.children[n])}}catch(b){c.e(b)}finally{c.f()}}(C,e),e.name+="_instance_"+g.uses[I]++,e}},{key:"_invokeOne",value:function(g){var I=Object.values(this.plugins);I.push(this);for(var C=0;C<I.length;C++){var A=g(I[C]);if(A)return A}return null}},{key:"_invokeAll",value:function(g){var I=Object.values(this.plugins);I.unshift(this);for(var C=[],A=0;A<I.length;A++){var l=g(I[A]);l&&C.push(l)}return C}},{key:"getDependency",value:function(g,I){var C=g+":"+I,A=this.cache.get(C);if(!A){switch(g){case"scene":A=this.loadScene(I);break;case"node":A=this.loadNode(I);break;case"mesh":A=this._invokeOne((function(g){return g.loadMesh&&g.loadMesh(I)}));break;case"accessor":A=this.loadAccessor(I);break;case"bufferView":A=this._invokeOne((function(g){return g.loadBufferView&&g.loadBufferView(I)}));break;case"buffer":A=this.loadBuffer(I);break;case"material":A=this._invokeOne((function(g){return g.loadMaterial&&g.loadMaterial(I)}));break;case"texture":A=this._invokeOne((function(g){return g.loadTexture&&g.loadTexture(I)}));break;case"skin":A=this.loadSkin(I);break;case"animation":A=this.loadAnimation(I);break;case"camera":A=this.loadCamera(I);break;default:throw new Error("Unknown type: "+g)}this.cache.add(C,A)}return A}},{key:"getDependencies",value:function(g){var I=this.cache.get(g);if(!I){var C=this,A=this.json[g+("mesh"===g?"es":"s")]||[];I=Promise.all(A.map((function(I,A){return C.getDependency(g,A)}))),this.cache.add(g,I)}return I}},{key:"loadBuffer",value:function(g){var I=this.json.buffers[g],C=this.fileLoader;if(I.type&&"arraybuffer"!==I.type)throw new Error("THREE.GLTFLoader: "+I.type+" buffer type is not supported.");if(void 0===I.uri&&0===g)return Promise.resolve(this.extensions[s.KHR_BINARY_GLTF].body);var A=this.options;return new Promise((function(g,l){C.load(d.LoaderUtils.resolveURL(I.uri,A.path),g,void 0,(function(){l(new Error('THREE.GLTFLoader: Failed to load buffer "'+I.uri+'".'))}))}))}},{key:"loadBufferView",value:function(g){var I=this.json.bufferViews[g];return this.getDependency("buffer",I.buffer).then((function(g){var C=I.byteLength||0,A=I.byteOffset||0;return g.slice(A,A+C)}))}},{key:"loadAccessor",value:function(g){var I=this,C=this.json,A=this.json.accessors[g];if(void 0===A.bufferView&&void 0===A.sparse)return Promise.resolve(null);var l=[];return void 0!==A.bufferView?l.push(this.getDependency("bufferView",A.bufferView)):l.push(null),void 0!==A.sparse&&(l.push(this.getDependency("bufferView",A.sparse.indices.bufferView)),l.push(this.getDependency("bufferView",A.sparse.values.bufferView))),Promise.all(l).then((function(g){var l,o,e=g[0],i=O[A.type],c=j[A.componentType],a=c.BYTES_PER_ELEMENT,n=a*i,b=A.byteOffset||0,G=void 0!==A.bufferView?C.bufferViews[A.bufferView].byteStride:void 0,Z=!0===A.normalized;if(G&&G!==n){var s=Math.floor(b/G),t="InterleavedBuffer:"+A.bufferView+":"+A.componentType+":"+s+":"+A.count,B=I.cache.get(t);B||(l=new c(e,s*G,A.count*G/a),B=new d.InterleavedBuffer(l,G/a),I.cache.add(t,B)),o=new d.InterleavedBufferAttribute(B,i,b%G/a,Z)}else l=null===e?new c(A.count*i):new c(e,b,A.count*i),o=new d.BufferAttribute(l,i,Z);if(void 0!==A.sparse){var u=O.SCALAR,m=j[A.sparse.indices.componentType],h=A.sparse.indices.byteOffset||0,W=A.sparse.values.byteOffset||0,r=new m(g[1],h,A.sparse.count*u),y=new c(g[2],W,A.sparse.count*i);null!==e&&(o=new d.BufferAttribute(o.array.slice(),o.itemSize,o.normalized));for(var p=0,V=r.length;p<V;p++){var v=r[p];if(o.setX(v,y[p*i]),i>=2&&o.setY(v,y[p*i+1]),i>=3&&o.setZ(v,y[p*i+2]),i>=4&&o.setW(v,y[p*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return o}))}},{key:"loadTexture",value:function(g){var I=this.json,C=this.options,A=I.textures[g],l=I.images[A.source],o=this.textureLoader;if(l.uri){var e=C.manager.getHandler(l.uri);null!==e&&(o=e)}return this.loadTextureImage(g,l,o)}},{key:"loadTextureImage",value:function(g,I,C){var A=this,l=this.json,o=this.options,e=l.textures[g],i=(I.uri||I.bufferView)+":"+e.sampler;if(this.textureCache[i])return this.textureCache[i];var c=self.URL||self.webkitURL,a=I.uri||"",n=!1;if(void 0!==I.bufferView)a=A.getDependency("bufferView",I.bufferView).then((function(g){n=!0;var C=new Blob([g],{type:I.mimeType});return a=c.createObjectURL(C)}));else if(void 0===I.uri)throw new Error("THREE.GLTFLoader: Image "+g+" is missing URI and bufferView");var b=Promise.resolve(a).then((function(g){return new Promise((function(I,A){var l=I;!0===C.isImageBitmapLoader&&(l=function(g){var C=new d.Texture(g);C.needsUpdate=!0,I(C)}),C.load(d.LoaderUtils.resolveURL(g,o.path),l,void 0,A)}))})).then((function(I){!0===n&&c.revokeObjectURL(a),I.flipY=!1,e.name&&(I.name=e.name);var C=(l.samplers||{})[e.sampler]||{};return I.magFilter=D[C.magFilter]||d.LinearFilter,I.minFilter=D[C.minFilter]||d.LinearMipmapLinearFilter,I.wrapS=E[C.wrapS]||d.RepeatWrapping,I.wrapT=E[C.wrapT]||d.RepeatWrapping,A.associations.set(I,{textures:g}),I})).catch((function(){return console.error("THREE.GLTFLoader: Couldn't load texture",a),null}));return this.textureCache[i]=b,b}},{key:"assignTexture",value:function(g,I,C){var A=this;return this.getDependency("texture",C.index).then((function(l){if(void 0===C.texCoord||0==C.texCoord||"aoMap"===I&&1==C.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+C.texCoord+" for texture "+I+" not yet supported."),A.extensions[s.KHR_TEXTURE_TRANSFORM]){var o=void 0!==C.extensions?C.extensions[s.KHR_TEXTURE_TRANSFORM]:void 0;if(o){var e=A.associations.get(l);l=A.extensions[s.KHR_TEXTURE_TRANSFORM].extendTexture(l,o),A.associations.set(l,e)}}return g[I]=l,l}))}},{key:"assignFinalMaterial",value:function(g){var I=g.geometry,C=g.material,A=void 0===I.attributes.tangent,l=void 0!==I.attributes.color,o=void 0===I.attributes.normal;if(g.isPoints){var e="PointsMaterial:"+C.uuid,i=this.cache.get(e);i||(i=new d.PointsMaterial,d.Material.prototype.copy.call(i,C),i.color.copy(C.color),i.map=C.map,i.sizeAttenuation=!1,this.cache.add(e,i)),C=i}else if(g.isLine){var c="LineBasicMaterial:"+C.uuid,a=this.cache.get(c);a||(a=new d.LineBasicMaterial,d.Material.prototype.copy.call(a,C),a.color.copy(C.color),this.cache.add(c,a)),C=a}if(A||l||o){var n="ClonedMaterial:"+C.uuid+":";C.isGLTFSpecularGlossinessMaterial&&(n+="specular-glossiness:"),A&&(n+="derivative-tangents:"),l&&(n+="vertex-colors:"),o&&(n+="flat-shading:");var b=this.cache.get(n);b||(b=C.clone(),l&&(b.vertexColors=!0),o&&(b.flatShading=!0),A&&(b.normalScale&&(b.normalScale.y*=-1),b.clearcoatNormalScale&&(b.clearcoatNormalScale.y*=-1)),this.cache.add(n,b),this.associations.set(b,this.associations.get(C))),C=b}C.aoMap&&void 0===I.attributes.uv2&&void 0!==I.attributes.uv&&I.setAttribute("uv2",I.attributes.uv),g.material=C}},{key:"getMaterialType",value:function(){return d.MeshStandardMaterial}},{key:"loadMaterial",value:function(g){var I,C=this,A=this.json,l=this.extensions,o=A.materials[g],e={},i=o.extensions||{},c=[];if(i[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var a=l[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];I=a.getMaterialType(),c.push(a.extendParams(e,o,C))}else if(i[s.KHR_MATERIALS_UNLIT]){var n=l[s.KHR_MATERIALS_UNLIT];I=n.getMaterialType(),c.push(n.extendParams(e,o,C))}else{var b=o.pbrMetallicRoughness||{};if(e.color=new d.Color(1,1,1),e.opacity=1,Array.isArray(b.baseColorFactor)){var G=b.baseColorFactor;e.color.fromArray(G),e.opacity=G[3]}void 0!==b.baseColorTexture&&c.push(C.assignTexture(e,"map",b.baseColorTexture)),e.metalness=void 0!==b.metallicFactor?b.metallicFactor:1,e.roughness=void 0!==b.roughnessFactor?b.roughnessFactor:1,void 0!==b.metallicRoughnessTexture&&(c.push(C.assignTexture(e,"metalnessMap",b.metallicRoughnessTexture)),c.push(C.assignTexture(e,"roughnessMap",b.metallicRoughnessTexture))),I=this._invokeOne((function(I){return I.getMaterialType&&I.getMaterialType(g)})),c.push(Promise.all(this._invokeAll((function(I){return I.extendMaterialParams&&I.extendMaterialParams(g,e)}))))}!0===o.doubleSided&&(e.side=d.DoubleSide);var Z=o.alphaMode||$;if(Z===Ig?(e.transparent=!0,e.depthWrite=!1):(e.transparent=!1,Z===gg&&(e.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&I!==d.MeshBasicMaterial&&(c.push(C.assignTexture(e,"normalMap",o.normalTexture)),e.normalScale=new d.Vector2(1,1),void 0!==o.normalTexture.scale)){var t=o.normalTexture.scale;e.normalScale.set(t,t)}return void 0!==o.occlusionTexture&&I!==d.MeshBasicMaterial&&(c.push(C.assignTexture(e,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(e.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&I!==d.MeshBasicMaterial&&(e.emissive=(new d.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&I!==d.MeshBasicMaterial&&c.push(C.assignTexture(e,"emissiveMap",o.emissiveTexture)),Promise.all(c).then((function(){var A;return A=I===N?l[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(e):new I(e),o.name&&(A.name=o.name),A.map&&(A.map.encoding=d.sRGBEncoding),A.emissiveMap&&(A.emissiveMap.encoding=d.sRGBEncoding),Ag(A,o),C.associations.set(A,{materials:g}),o.extensions&&Cg(l,A,o),A}))}},{key:"createUniqueName",value:function(g){for(var I=d.PropertyBinding.sanitizeNodeName(g||""),C=I,A=1;this.nodeNamesUsed[C];++A)C=I+"_"+A;return this.nodeNamesUsed[C]=!0,C}},{key:"loadGeometries",value:function(g){var I=this,C=this.extensions,A=this.primitiveCache;function l(g){return C[s.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(g,I).then((function(C){return ng(C,g,I)}))}for(var o=[],e=0,i=g.length;e<i;e++){var c=g[e],a=og(c),n=A[a];if(n)o.push(n.promise);else{var b=void 0;b=c.extensions&&c.extensions[s.KHR_DRACO_MESH_COMPRESSION]?l(c):ng(new d.BufferGeometry,c,I),A[a]={primitive:c,promise:b},o.push(b)}}return Promise.all(o)}},{key:"loadMesh",value:function(g){for(var I,C=this,A=this.json,l=this.extensions,o=A.meshes[g],e=o.primitives,i=[],c=0,a=e.length;c<a;c++){var n=void 0===e[c].material?(void 0===(I=this.cache).DefaultMaterial&&(I.DefaultMaterial=new d.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:d.FrontSide})),I.DefaultMaterial):this.getDependency("material",e[c].material);i.push(n)}return i.push(C.loadGeometries(e)),Promise.all(i).then((function(I){for(var A=I.slice(0,I.length-1),i=I[I.length-1],c=[],a=0,n=i.length;a<n;a++){var b=i[a],G=e[a],Z=void 0,s=A[a];if(G.mode===x||G.mode===U||G.mode===T||void 0===G.mode)!0!==(Z=!0===o.isSkinnedMesh?new d.SkinnedMesh(b,s):new d.Mesh(b,s)).isSkinnedMesh||Z.geometry.attributes.skinWeight.normalized||Z.normalizeSkinWeights(),G.mode===U?Z.geometry=bg(Z.geometry,d.TriangleStripDrawMode):G.mode===T&&(Z.geometry=bg(Z.geometry,d.TriangleFanDrawMode));else if(G.mode===f)Z=new d.LineSegments(b,s);else if(G.mode===Q)Z=new d.Line(b,s);else if(G.mode===M)Z=new d.LineLoop(b,s);else{if(G.mode!==L)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+G.mode);Z=new d.Points(b,s)}Object.keys(Z.geometry.morphAttributes).length>0&&lg(Z,o),Z.name=C.createUniqueName(o.name||"mesh_"+g),Ag(Z,o),G.extensions&&Cg(l,Z,G),C.assignFinalMaterial(Z),c.push(Z)}for(var t=0,B=c.length;t<B;t++)C.associations.set(c[t],{meshes:g,primitives:t});if(1===c.length)return c[0];var u=new d.Group;C.associations.set(u,{meshes:g});for(var m=0,h=c.length;m<h;m++)u.add(c[m]);return u}))}},{key:"loadCamera",value:function(g){var I,C=this.json.cameras[g],A=C[C.type];if(A)return"perspective"===C.type?I=new d.PerspectiveCamera(d.MathUtils.radToDeg(A.yfov),A.aspectRatio||1,A.znear||1,A.zfar||2e6):"orthographic"===C.type&&(I=new d.OrthographicCamera(-A.xmag,A.xmag,A.ymag,-A.ymag,A.znear,A.zfar)),C.name&&(I.name=this.createUniqueName(C.name)),Ag(I,C),Promise.resolve(I);console.warn("THREE.GLTFLoader: Missing camera parameters.")}},{key:"loadSkin",value:function(g){var I=this.json.skins[g],C={joints:I.joints};return void 0===I.inverseBindMatrices?Promise.resolve(C):this.getDependency("accessor",I.inverseBindMatrices).then((function(g){return C.inverseBindMatrices=g,C}))}},{key:"loadAnimation",value:function(g){for(var I=this.json.animations[g],C=[],A=[],l=[],o=[],e=[],i=0,c=I.channels.length;i<c;i++){var a=I.channels[i],n=I.samplers[a.sampler],b=a.target,G=void 0!==b.node?b.node:b.id,Z=void 0!==I.parameters?I.parameters[n.input]:n.input,s=void 0!==I.parameters?I.parameters[n.output]:n.output;C.push(this.getDependency("node",G)),A.push(this.getDependency("accessor",Z)),l.push(this.getDependency("accessor",s)),o.push(n),e.push(b)}return Promise.all([Promise.all(C),Promise.all(A),Promise.all(l),Promise.all(o),Promise.all(e)]).then((function(C){for(var A=C[0],l=C[1],o=C[2],e=C[3],i=C[4],c=[],a=function(g,I){var C=A[g],a=l[g],n=o[g],b=e[g],G=i[g];if(void 0===C)return"continue";C.updateMatrix(),C.matrixAutoUpdate=!0;var Z=void 0;switch(q[G.path]){case q.weights:Z=d.NumberKeyframeTrack;break;case q.rotation:Z=d.QuaternionKeyframeTrack;break;default:Z=d.VectorKeyframeTrack}var s=C.name?C.name:C.uuid,t=void 0!==b.interpolation?_[b.interpolation]:d.InterpolateLinear,B=[];q[G.path]===q.weights?C.traverse((function(g){g.morphTargetInfluences&&B.push(g.name?g.name:g.uuid)})):B.push(s);var u=n.array;if(n.normalized){for(var m=ig(u.constructor),h=new Float32Array(u.length),W=0,r=u.length;W<r;W++)h[W]=u[W]*m;u=h}for(var y=0,p=B.length;y<p;y++){var V=new Z(B[y]+"."+q[G.path],a.array,u,t);"CUBICSPLINE"===b.interpolation&&(V.createInterpolant=function(g){return new(this instanceof d.QuaternionKeyframeTrack?J:z)(this.times,this.values,this.getValueSize()/3,g)},V.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(V)}},n=0,b=A.length;n<b;n++)a(n);var G=I.name?I.name:"animation_"+g;return new d.AnimationClip(G,void 0,c)}))}},{key:"createNodeMesh",value:function(g){var I=this.json,C=this,A=I.nodes[g];return void 0===A.mesh?null:C.getDependency("mesh",A.mesh).then((function(g){var I=C._getNodeRef(C.meshCache,A.mesh,g);return void 0!==A.weights&&I.traverse((function(g){if(g.isMesh)for(var I=0,C=A.weights.length;I<C;I++)g.morphTargetInfluences[I]=A.weights[I]})),I}))}},{key:"loadNode",value:function(g){var I=this.json,C=this.extensions,A=this,l=I.nodes[g],o=l.name?A.createUniqueName(l.name):"";return function(){var I=[],C=A._invokeOne((function(I){return I.createNodeMesh&&I.createNodeMesh(g)}));return C&&I.push(C),void 0!==l.camera&&I.push(A.getDependency("camera",l.camera).then((function(g){return A._getNodeRef(A.cameraCache,l.camera,g)}))),A._invokeAll((function(I){return I.createNodeAttachment&&I.createNodeAttachment(g)})).forEach((function(g){I.push(g)})),Promise.all(I)}().then((function(I){var e;if((e=!0===l.isBone?new d.Bone:I.length>1?new d.Group:1===I.length?I[0]:new d.Object3D)!==I[0])for(var i=0,c=I.length;i<c;i++)e.add(I[i]);if(l.name&&(e.userData.name=l.name,e.name=o),Ag(e,l),l.extensions&&Cg(C,e,l),void 0!==l.matrix){var a=new d.Matrix4;a.fromArray(l.matrix),e.applyMatrix4(a)}else void 0!==l.translation&&e.position.fromArray(l.translation),void 0!==l.rotation&&e.quaternion.fromArray(l.rotation),void 0!==l.scale&&e.scale.fromArray(l.scale);return A.associations.has(e)||A.associations.set(e,{}),A.associations.get(e).nodes=g,e}))}},{key:"loadScene",value:function(g){var I=this.json,C=this.extensions,o=this.json.scenes[g],e=this,i=new d.Group;o.name&&(i.name=e.createUniqueName(o.name)),Ag(i,o),o.extensions&&Cg(C,i,o);for(var c=o.nodes||[],a=[],n=0,b=c.length;n<b;n++)a.push(ag(c[n],i,I,e));return Promise.all(a).then((function(){return e.associations=function(g){var I,C=new Map,o=(0,l.Z)(e.associations);try{for(o.s();!(I=o.n()).done;){var i=(0,A.Z)(I.value,2),c=i[0],a=i[1];(c instanceof d.Material||c instanceof d.Texture)&&C.set(c,a)}}catch(n){o.e(n)}finally{o.f()}return g.traverse((function(g){var I=e.associations.get(g);null!=I&&C.set(g,I)})),C}(i),i}))}}]),g}();function ag(g,I,C,A){var l=C.nodes[g];return A.getDependency("node",g).then((function(g){return void 0===l.skin?g:A.getDependency("skin",l.skin).then((function(g){for(var C=[],l=0,o=(I=g).joints.length;l<o;l++)C.push(A.getDependency("node",I.joints[l]));return Promise.all(C)})).then((function(C){return g.traverse((function(g){if(g.isMesh){for(var A=[],l=[],o=0,e=C.length;o<e;o++){var i=C[o];if(i){A.push(i);var c=new d.Matrix4;void 0!==I.inverseBindMatrices&&c.fromArray(I.inverseBindMatrices.array,16*o),l.push(c)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',I.joints[o])}g.bind(new d.Skeleton(A,l),g.matrixWorld)}})),g}));var I})).then((function(g){I.add(g);var o=[];if(l.children)for(var e=l.children,i=0,c=e.length;i<c;i++){var a=e[i];o.push(ag(a,g,C,A))}return Promise.all(o)}))}function ng(g,I,C){var A=I.attributes,l=[];function o(I,A){return C.getDependency("accessor",I).then((function(I){g.setAttribute(A,I)}))}for(var e in A){var i=P[e]||e.toLowerCase();i in g.attributes||l.push(o(A[e],i))}if(void 0!==I.indices&&!g.index){var c=C.getDependency("accessor",I.indices).then((function(I){g.setIndex(I)}));l.push(c)}return Ag(g,I),function(g,I,C){var A=I.attributes,l=new d.Box3;if(void 0!==A.POSITION){var o=C.json.accessors[A.POSITION],e=o.min,i=o.max;if(void 0!==e&&void 0!==i){if(l.set(new d.Vector3(e[0],e[1],e[2]),new d.Vector3(i[0],i[1],i[2])),o.normalized){var c=ig(j[o.componentType]);l.min.multiplyScalar(c),l.max.multiplyScalar(c)}var a=I.targets;if(void 0!==a){for(var n=new d.Vector3,b=new d.Vector3,G=0,Z=a.length;G<Z;G++){var s=a[G];if(void 0!==s.POSITION){var t=C.json.accessors[s.POSITION],B=t.min,u=t.max;if(void 0!==B&&void 0!==u){if(b.setX(Math.max(Math.abs(B[0]),Math.abs(u[0]))),b.setY(Math.max(Math.abs(B[1]),Math.abs(u[1]))),b.setZ(Math.max(Math.abs(B[2]),Math.abs(u[2]))),t.normalized){var m=ig(j[t.componentType]);b.multiplyScalar(m)}n.max(b)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}l.expandByVector(n)}g.boundingBox=l;var h=new d.Sphere;l.getCenter(h.center),h.radius=l.min.distanceTo(l.max)/2,g.boundingSphere=h}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(g,I,C),Promise.all(l).then((function(){return void 0!==I.targets?function(g,I,C){for(var A=!1,l=!1,o=0,e=I.length;o<e;o++){var i=I[o];if(void 0!==i.POSITION&&(A=!0),void 0!==i.NORMAL&&(l=!0),A&&l)break}if(!A&&!l)return Promise.resolve(g);for(var c=[],a=[],n=0,b=I.length;n<b;n++){var d=I[n];if(A){var G=void 0!==d.POSITION?C.getDependency("accessor",d.POSITION):g.attributes.position;c.push(G)}if(l){var Z=void 0!==d.NORMAL?C.getDependency("accessor",d.NORMAL):g.attributes.normal;a.push(Z)}}return Promise.all([Promise.all(c),Promise.all(a)]).then((function(I){var C=I[0],o=I[1];return A&&(g.morphAttributes.position=C),l&&(g.morphAttributes.normal=o),g.morphTargetsRelative=!0,g}))}(g,I.targets,C):g}))}function bg(g,I){var C=g.getIndex();if(null===C){var A=[],l=g.getAttribute("position");if(void 0===l)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),g;for(var o=0;o<l.count;o++)A.push(o);g.setIndex(A),C=g.getIndex()}var e=C.count-2,i=[];if(I===d.TriangleFanDrawMode)for(var c=1;c<=e;c++)i.push(C.getX(0)),i.push(C.getX(c)),i.push(C.getX(c+1));else for(var a=0;a<e;a++)a%2===0?(i.push(C.getX(a)),i.push(C.getX(a+1)),i.push(C.getX(a+2))):(i.push(C.getX(a+2)),i.push(C.getX(a+1)),i.push(C.getX(a)));i.length/3!==e&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var n=g.clone();return n.setIndex(i),n}}}]);
//# sourceMappingURL=797.30de8461.chunk.js.map